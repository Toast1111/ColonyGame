var Ut=Object.defineProperty;var qt=(s,t,i)=>t in s?Ut(s,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[t]=i;var b=(s,t,i)=>qt(s,typeof t!="symbol"?t+"":t,i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function i(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function e(n){if(n.ep)return;n.ep=!0;const l=i(n);fetch(n.href,l)}})();const Y=(s,t)=>Math.random()*(t-s)+s,jt=(s,t)=>Math.floor(Y(s,t)),U=(s,t,i)=>Math.max(t,Math.min(i,s)),F=(s,t)=>{const i=s.x-t.x,e=s.y-t.y;return i*i+e*e},$t=s=>Math.hypot(s.x,s.y),Ht=s=>{const t=$t(s)||1;return{x:s.x/t,y:s.y/t}},Xt=(s,t)=>({x:s.x-t.x,y:s.y-t.y}),y=32,T={w:240*y,h:240*y},z={x:T.w/2,y:T.h/2},D={sky:"#0a0e14",ground:"#0e161f",colonist:"#c7f9cc",enemy:"#ff9aa2",tree:"#6fbf73",rock:"#9aa5b1",ghost:"#6ee7ff",wall:"#9aa5b1",bld:"#93c5fd",turret:"#93c5fd",farm:"#8bd3dd",house:"#e2b714",stock:"#c084fc",tent:"#f59e0b"},Tt={start:.72,end:.07};function vt(s,t,i,e){return Math.abs(s-i)+Math.abs(t-e)}function Vt(){const s=Math.ceil(7680/y),t=Math.ceil(7680/y),i=s*t;return{cols:s,rows:t,solid:new Uint8Array(i),cost:new Float32Array(i).fill(1),minCost:1}}function Jt(s){s.solid.fill(0),s.cost.fill(1),s.minCost=1}function Zt(s,t,i,e,n){const l=Math.floor(t/y),r=Math.floor(i/y),h=Math.floor((t+e)/y),o=Math.floor((i+n)/y);for(let f=r;f<=o;f++)for(let c=l;c<=h;c++)if(c>=0&&f>=0&&c<s.cols&&f<s.rows){const a=f*s.cols+c;s.solid[a]=1}}function Rt(s,t,i,e){const n=Math.floor((t-e)/y),l=Math.floor((i-e)/y),r=Math.floor((t+e)/y),h=Math.floor((i+e)/y);for(let o=l;o<=h;o++)for(let f=n;f<=r;f++)if(f>=0&&o>=0&&f<s.cols&&o<s.rows){const c=f*y+y/2,a=o*y+y/2,d=c-t,p=a-i;if(d*d+p*p<=e*e){const x=o*s.cols+f;s.solid[x]=1}}}function Kt(s,t,i,e,n,l){const r=Math.floor(t/y),h=Math.floor(i/y),o=Math.floor((t+e)/y),f=Math.floor((i+n)/y);for(let c=h;c<=f;c++)for(let a=r;a<=o;a++)if(a>=0&&c>=0&&a<s.cols&&c<s.rows){const d=c*s.cols+a;s.cost[d]=l,l<s.minCost&&(s.minCost=l)}}const Gt=.7,_t={BASIC_PATH:.6,FAST_ROAD:.5,SLOW_PATH:.7,GRASS:1,ROUGH_TERRAIN:1.5};function ht(s,t){return s.cost[t]<=Gt}function Pt(s,t,i){const e=Math.floor(t/y),n=Math.floor(i/y);return e<0||n<0||e>=s.cols||n>=s.rows?!1:ht(s,n*s.cols+e)}function Ct(s,t,i,e,n,l="BASIC_PATH"){const r=_t[l],h=Math.max(.5,Math.min(.7,r));Kt(s,t,i,e,n,h)}function xt(s,t){return{gx:Math.floor(s/y),gy:Math.floor(t/y)}}function te(s,t){for(let i=0;i<t.length;i++){const e=Math.floor(t[i].x/y),n=Math.floor(t[i].y/y);if(e>=0&&n>=0&&e<s.cols&&n<s.rows){const l=n*s.cols+e;ht(s,l)&&(t[i].x=e*y+y/2,t[i].y=n*y+y/2)}}}function ee(s,t,i,e){const n=xt(t.x,t.y),l=xt(i.x,i.y),r=xt(e.x,e.y),h=Math.sign(l.gx-n.gx),o=Math.sign(l.gy-n.gy),f=Math.sign(r.gx-l.gx),c=Math.sign(r.gy-l.gy),a=h!==0&&c!==0||o!==0&&f!==0,d=l.gy*s.cols+l.gx;return a&&d>=0&&d<s.cost.length&&ht(s,d)}function se(s,t,i,e,n){const l=s.cols,r=s.rows,h={x:Math.floor(t/y),y:Math.floor(i/y)},o={x:Math.floor(e/y),y:Math.floor(n/y)},f=(A,R)=>R*l+A;if(h.x===o.x&&h.y===o.y)return[{x:e,y:n}];const c=f(h.x,h.y),a=f(o.x,o.y),d=(A,R)=>A>=0&&R>=0&&A<l&&R<r,p=(A,R)=>{if(!d(A,R))return!1;const O=f(A,R);return O===c||O===a?!0:s.solid[O]===0},x=new Int32Array(l*r).fill(-1),u=new Float32Array(l*r).fill(1/0),m=new Float32Array(l*r).fill(1/0),g=new Uint8Array(l*r),w=[],k=A=>{w.push(A)},M=()=>{let A=-1,R=1/0;for(let S=0;S<w.length;S++){const E=w[S];if(g[E])continue;const P=m[E];P<R&&(R=P,A=S)}return A===-1?-1:w.splice(A,1)[0]},v=Math.max(1e-4,s.minCost);u[c]=0,m[c]=vt(h.x,h.y,o.x,o.y)*v,k(c);const C=[[1,0],[-1,0],[0,1],[0,-1]];for(;w.length;){const A=M();if(A===-1)break;if(g[A])continue;g[A]=1;const R=A%l,O=A/l|0;if(A===a){let S=[],E=A;for(;E!==-1;){const B=E%l,I=E/l|0;S.push({x:B*y+y/2,y:I*y+y/2}),E=x[E]}S.reverse(),S[S.length-1]={x:e,y:n};const P=[];for(let B=0;B<S.length-1;B++){const I=S[B],X=S[B+1];P.push(I);const Z=Math.floor(I.x/y),H=Math.floor(I.y/y),ot=Math.floor(X.x/y),rt=Math.floor(X.y/y),yt=H*l+Z,ct=rt*l+ot,nt=ht(s,yt)&&ht(s,ct);if(!(nt&&(H===rt||Z===ot)))if(nt){const K=X.x-I.x,j=X.y-I.y,st=Math.hypot(K,j),_=Math.floor(st/18);for(let $=1;$<=_;$++){const V=$/(_+1);P.push({x:I.x+K*V,y:I.y+j*V})}}else{const K=X.x-I.x,j=X.y-I.y,st=Math.hypot(K,j),_=Math.floor(st/24);for(let $=1;$<=_;$++){const V=$/(_+1);P.push({x:I.x+K*V,y:I.y+j*V})}}}P.push(S[S.length-1]),S=P;const N=(B,I,X,Z)=>{const H=X-B,ot=Z-I,rt=Math.hypot(H,ot)||1,yt=Math.max(6,y*.33),ct=Math.ceil(rt/yt);let nt=0,dt=0;for(let j=1;j<ct;j++){const st=j/ct,_=B+H*st,$=I+ot*st,V=Math.floor(_/y),gt=Math.floor($/y);if(V<0||gt<0||V>=s.cols||gt>=s.rows)return!1;const St=gt*s.cols+V;if(s.solid[St])return!1;s.cost[St]<=Gt&&nt++,dt++}const At=Pt(s,B,I),K=Pt(s,X,Z);return At&&K&&dt>0?nt/dt>=.6:!0},Q=[];let L=0;for(;L<S.length;){Q.push(S[L]);let B=L+2,I=L+1;for(;B<S.length&&!ee(s,S[L],S[L+1],S[B]);)if(N(S[L].x,S[L].y,S[B].x,S[B].y))I=B,B++;else break;L=I}return S=Q.length>=2?Q:S,te(s,S),S}for(const[S,E]of C){const P=R+S,N=O+E;if(!p(P,N))continue;const Q=N*l+P,L=s.cost[Q]||1,B=u[A]+L;if(B<u[Q]){x[Q]=A,u[Q]=B;const I=vt(P,N,o.x,o.y)*Math.max(1e-4,s.minCost)*.9999;m[Q]=B+I,k(Q)}}}return null}const W={house:{category:"Housing",name:"House",description:"Provides shelter for 2 colonists. Colonists can rest inside to recover fatigue.",key:"1",cost:{wood:20,stone:5},hp:220,size:{w:2,h:2},build:100,color:D.house,popCap:2},farm:{category:"Production",name:"Farm",description:"Grows crops that colonists can harvest for food. Takes 2 days to grow.",key:"2",cost:{wood:15},hp:120,size:{w:2,h:2},build:80,color:D.farm,growTime:1},turret:{category:"Defense",name:"Turret",description:"Automated defense structure. Shoots at enemies within range.",key:"3",cost:{wood:10,stone:20},hp:160,size:{w:1,h:1},build:120,color:D.turret,range:190,fireRate:.6,dps:30},wall:{category:"Defense",name:"Wall",description:"Blocks enemy movement. Essential for creating defensive perimeters.",key:"4",cost:{wood:5,stone:5},hp:150,size:{w:1,h:1},build:40,color:D.wall},stock:{category:"Utility",name:"Stockpile",description:"Increases resource storage capacity by 100. Colonists will store materials here.",key:"5",cost:{wood:10},hp:140,size:{w:2,h:2},build:60,color:D.stock,storageBonus:100},tent:{category:"Utility",name:"Recruit Tent",description:"Attracts new colonists every 60 seconds. Requires 15 food per recruit.",key:"6",cost:{wood:30,food:10},hp:140,size:{w:2,h:2},build:80,color:D.tent},warehouse:{category:"Utility",name:"Warehouse",description:"Large storage facility. Increases resource capacity by 300.",key:"7",cost:{wood:40,stone:20},hp:260,size:{w:3,h:2},build:160,color:D.stock,storageBonus:300},well:{category:"Production",name:"Well",description:"Provides clean water. Colonists can collect water here for food production.",key:"8",cost:{stone:25},hp:160,size:{w:1,h:1},build:80,color:D.farm},infirmary:{category:"Utility",name:"Infirmary",description:"Heals injured colonists within range. Essential for colony survival.",key:"9",cost:{wood:30,stone:20,food:10},hp:200,size:{w:2,h:2},build:140,color:D.bld,healRate:3,healRange:140,popCap:2},path:{category:"Utility",name:"Path",description:"Improves colonist movement speed by 50%. Cheap way to optimize traffic flow.",key:"0",cost:{wood:0},hp:1,size:{w:1,h:1},build:5,color:"#475569",speedBonus:1.5}};function ft(s,t){if(!t)return!0;for(const i of Object.keys(t))if((s[i]||0)<(t[i]||0))return!1;return!0}function mt(s,t){if(t)for(const i of Object.keys(t))s[i]-=t[i]||0}function pt(s,t,i){const e=W[s],n=Math.floor(t/y)*y,l=Math.floor(i/y)*y;return{kind:s,...e,x:n,y:l,w:e.size.w*y,h:e.size.h*y,hp:e.hp,buildLeft:e.build,done:!1,growth:0,ready:!1,cooldown:0}}function ie(s){const t={};for(const i of Object.keys(s)){const e=s[i],n=e.category||"Other";(t[n]||(t[n]=[])).push([i,e])}for(const i of Object.keys(t))t[i].sort((e,n)=>e[1].name.localeCompare(n[1].name));return t}const oe="data:image/png;base64,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",ne="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAwCAYAAABwrHhvAAAAAXNSR0IArs4c6QAAAX5JREFUWIXtlT1ug0AQhcdpkj51hBuLLnfwFbjD0CIfgIoDuKOI78AVcpUg105ad6TJQ+Nhf1hix1I0n4QE7O57s38zRIZhGIZhGIYRoWrz4Zb6D/pH0WSjYdXmw/F0niUkx/0aiElRbbDdrSff6IO2xUEVTQYxDhm4xsm2OWMmW0BE1NV9KT6ZiPh9/7FSQqyGMRHR6+bROQbvKbB4sJz8E8CFOdqqNh/ku+qvAw6bV20+4AaoLZkIoR2m+IdvMX5CaFm4aLK3l+cnOp7O2JaDrzMMxPYd5C3q6t7p5TwDEOjqvhTX0GuujMcJCPOSErdgRN+GCHKLOLRtf8VdzW9DKDuClPoROoTRIL4+V5NAUurHLBOIilmxTrmyf0r9iAaAZOKqC+TIhkvqRwjWonIVfP3JkcK3u/XgCjqKFhSrIdsvgtDm5KkfcxnFMPtAfk+qH1H0IYQYhD0Zkn3nZhG6tOKJiAerXwr6EErD4MyuMnsZxLXEFgdxT3Pj//MNvPQlpMCKHrIAAAAASUVORK5CYII=",le="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAwCAYAAABwrHhvAAAAAXNSR0IArs4c6QAAA/VJREFUWIXtVjFrG0kU/jYEZLa5tQWb5JCRmxCSQpw6FUfATcpA5OJKFWY3xk3wD5AL6wcIN0FZ4cJlCqlImUZNCnc24rjD5OAkEL6cCnmdQhDwsVdE3+TN7KwiX1Ideo3Q7Lz3vve9N98MsLSlLW1p/ydrdSrJTX1ufU8A43h6Y5+FALQ6lWSR6nzPxcFR6UYsLARgZ+vEAWANLoGN4yl8z7XGyCpg4RZkBR/HU7Q6laTaKCb7230r0FankmS1JwUgC2lWcN9zMY6n6NaHTrVRTEyg3E//rwKYB8LGAttDn/3tviOrJcAsSwEw+11tFBUY33PV93KtkDCxyULv149aTFv1BHzLXLDRSBCv330Ak58ejxz21mRBGn3M5GRFAeAwAcDZxRXIQrc+VBX/8vNdtYdBzOq69aGzuvYZx+behgJERk0/BYALP/34A4DPrZAsPHu8BgB49WaE0+ORYyY3e0/Wes2BU64VEsYy2dVmgB+fPLqHaqOYkL4///hHG6ZWp5KQJWlcu5x8IYXtoq+coxQAViErYQAA4HBx4ACdZlqvOdDacnBUUgyYM5E6BWcXV/A9V7VCDhv/s9LNvY2k1xw4L14+0EAQVDy5xunxyLEdRZ6i1Cno1ocOW1G6nwOAYMZOGE+uv3rjMTkZovmeq5LyVwMgJZUV5nM5AMDb3/4CADx/WlCVsHr6SxbICltH89Zuq/bwmwJAmtbzKwqQ77l48fJBBAAHR6WITIiYAQAc7p5bZRZAwPa9ejOCWb0GgJP58M4qmGiepPaaAwWk1akkD++sYj2/AmrAjJXIJt+SGW0IZZJqoxhZJDUEgG59qCU3wQMIDnfPw3wuB99z8frdB5wejzTmUlIsWXjy6J5aO9w9D4FMSY0IeGfrJBzHU82XlceTa1l9KP0y3wNSUqWwcBYYRKhh23bcxvFUVd9rDkIxS/oQ0iySGtG5XCtEs6raGVdzOHuWRVwzFdMEaWUgQ1KjeZI6034JrA1o89K2sDb/SbaopLY6lYRvARl8BrZNMED6baAB+BZJNd8TwJe7g99tL6NMBrIkdX+775iSurN14vAErOdXYB5fmu0GTQGYJ6mswCapkp3S/Zz2lCvXCknWDaoBmCepAIKziyvrhUIWfM9VMQRzgazevEOsLbBJKqCfClk9Wfv970tUG8Wk//6TWivXCpG3dlsWolkKgMFCQCWkHpiSKkAm9JX3hLTNvY3I/GZjILBVC6Ql1QJaAeq//8TTE/aag9CIp/bZALRZtbTLiaNJKvcKECFbtbm3YWPLykzmMZSbbYBkclh6ayYz/rexgAUicGD8z9w/O37m3kz/rGP3X00mWKjKpS3tX9TH+YSAxDb2AAAAAElFTkSuQmCC",ae="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAwCAYAAABwrHhvAAAAAXNSR0IArs4c6QAAA+pJREFUWIXtVrFqG0sUPasujbE3gd3OpFAcgjAYF8GBly6FCz+cIriUEbugL1iBPsCg/QLBChOXIUUMLlykS2GRIizoiYDiwiiVBI4wacxrvK+wzvjO7Kwiv5fqodsIzc6999xz75wZYGELW9jC/k+WdqvZfX1KvxPAaDy5t89cANJuNZunOt9zcXq8cy8W5gKwsXXkALAGl8BG4wl8z7XGKCpg7hYUBR+NJ0i71azdqmTbuydWoGm3mhW1JwegCGlRcN9zMRpPUG/0nXarkplAuZ/+vwQwC4SNBbaHPtu7J46slgCLLAfA7He7VVFgfM9V35u1csbEJgt/nQ21mLbqCbhkLthoJIiPH1Iw+cHhucPemixIo4+ZnKwoABwmABgOLkAW6o2+qvjV6w21h0HM6uqNvrP08AYAEEfrChAZNf0UAC6srj0GcNsKycIffz4FALxPznBweO6Yyc3ek7Uo7jnNWjljLJNdbQb48fnLTbRblYz0fR/8rQ1T2q1mZEka137+uAvLdtFXzlEOAKuQlTAAAHC4OHCATjMtintaW06PdxQD5kzkTsFwcAHfc1Ur5LDxPyuNo/UsinvOu7cVDQRBXV1e4+Dw3LEdRZ6i3CmoN/oOW7H67AYAgik74dXl9S9vPCYnQzTfc1VS/moApKSywqXlWxY+f/oCAHgTvlCVsHr6SxbICltHW370QLWH3xQA0rTi3QHyPRfv3lYSADg93knIhIgZAMDeft8qswACtu99cgazeg0AJ/PJ2iaYaJakRnFPAUm71ezJ2iZWPIAaMGUlscm3ZEYbQpmk3aokFkkNAaDe6GvJTfAAgr39fri0/Bi+5+LjhxQHh+caczkpliw8f6kCYW//NlmBpCYEvLF1FI7GE82XlV9dXsvqQ+lX+B6QkiqFhbPAIEINO7bjNhpPVPVR3AvFLOlDSLNIakLnZq2cTKvqFFzN4fRZlnDNVEwTpJWBAklNZknqVPslsA6gzUvHwtrsJ9m8kpp2qxnfAjL4FGyHYID820AD8F8k1XxPAHd3B7/bXkaFDBRJ6vbuiWNK6sbWkcMTsOLpiaXZbtAcgFmSygpskirZWX12oz3lmrVyVnSDagBmSSqAYDi4sF4oZMH3XBVDMBfI6s07xNoCm6QC+qmQ1ZO1b4MvaLcq2fBrSa01a+Vk+dEDWYhmOQAGCwGVkHpgSqoAmdFX3hPS4mg9Mb/ZGAhs1QJ5SbWAVoCGX0s8PWEU90IjntpnA9Bh1dJ+/ihpksq9AkTIVsXRuo0tKzOFx1ButgGSyWHprZnM+N/BHBaIwIHxv3D/9PiZewv9i47dvzWZYK4qF7awfwAJR/sa22/msgAAAABJRU5ErkJggg==",et=class et{constructor(){b(this,"images",new Map);b(this,"loaded",!1)}static getInstance(){return et.instance||(et.instance=new et),et.instance}async loadAssets(){const i=[{name:"house",path:oe},{name:"wheat_stage_1",path:ne},{name:"wheat_stage_2",path:le},{name:"wheat_stage_3",path:ae}].map(e=>this.loadImage(e.name,e.path));try{await Promise.all(i),this.loaded=!0}catch{console.warn("Some assets failed to load, continuing with fallbacks"),this.loaded=!0}}loadImage(t,i){return new Promise((e,n)=>{const l=new Image;l.onload=()=>{this.images.set(t,l),console.log(`Loaded image: ${t}`),e()},l.onerror=()=>{console.warn(`Failed to load image: ${t} from ${i}`),n(new Error(`Failed to load ${t}`))},l.src=i})}getImage(t){return this.images.get(t)||null}isLoaded(){return this.loaded}};b(et,"instance");let it=et;function he(s,t){s.setTransform(1,0,0,1,0,0),s.fillStyle=D.sky,s.fillRect(0,0,t.width,t.height)}function re(s,t){s.translate(-t.x*t.zoom,-t.y*t.zoom),s.scale(t.zoom,t.zoom)}function ce(s){s.fillStyle=D.ground,s.fillRect(0,0,T.w,T.h),s.globalAlpha=.08,s.strokeStyle="#d6e4ff",s.lineWidth=1,s.beginPath();for(let t=0;t<=T.w;t+=y)s.moveTo(t,0),s.lineTo(t,T.h);for(let t=0;t<=T.h;t+=y)s.moveTo(0,t),s.lineTo(T.w,t);s.stroke(),s.globalAlpha=1}function wt(s,t,i,e,n){s.fillStyle=n,s.beginPath(),s.arc(t,i,e,0,Math.PI*2),s.fill()}function de(s,t,i,e,n,l,r=0){s.fillStyle=l,s.beginPath();for(let h=0;h<n;h++){const o=r+h*2*Math.PI/n,f=t+Math.cos(o)*e,c=i+Math.sin(o)*e;h===0?s.moveTo(f,c):s.lineTo(f,c)}s.closePath(),s.fill()}function Bt(s,t,i,e=10,n=D.colonist){s.save(),s.translate(t,i);const l="#0b0f14",r=e*.32,h=-e*.3;s.fillStyle=n,s.beginPath(),s.arc(0,h,r,0,Math.PI*2),s.fill(),s.strokeStyle=l,s.lineWidth=1,s.beginPath(),s.arc(0,h,r+.5,0,Math.PI*2),s.stroke();const o=e*.55,f=e*.55,c=-e*.05;s.fillStyle=n,s.beginPath(),s.moveTo(-o/2,c-f/2),s.lineTo(o/2,c-f/2),s.lineTo(o/2,c+f/2),s.lineTo(-o/2,c+f/2),s.closePath(),s.fill(),s.strokeStyle=l,s.stroke();const a=e*.18,d=e*.5,p=c+f/2+d*.1;s.fillStyle=n,s.fillRect(-a-.6,p-d,a,d),s.fillRect(.6,p-d,a,d),s.strokeStyle=l,s.strokeRect(-a-.6,p-d,a,d),s.strokeRect(.6,p-d,a,d),s.restore()}function fe(s,t,i,e=12,n="#60a5fa"){s.save(),s.translate(t,i),s.fillStyle=n,s.strokeStyle="#0b0f14",s.lineWidth=1,s.beginPath();const l=e,r=e*1.2;s.moveTo(0,-r*.5),s.lineTo(l*.35,-r*.25),s.lineTo(l*.35,r*.1),s.quadraticCurveTo(0,r*.55,-l*.35,r*.1),s.lineTo(-l*.35,-r*.25),s.closePath(),s.fill(),s.stroke(),s.restore()}function ue(s,t){if(t.kind==="path"){s.fillStyle="#1f2937",s.fillRect(t.x,t.y,t.w,t.h),s.strokeStyle="#0b0f14cc",s.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1);return}if(t.kind==="house"){const i=it.getInstance(),e=i.getImage("house");e&&i.isLoaded()?(s.drawImage(e,t.x,t.y,t.w,t.h),s.strokeStyle="#0b0f14cc",s.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1)):(s.fillStyle=t.color,s.fillRect(t.x,t.y,t.w,t.h),s.strokeStyle="#0b0f14cc",s.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1))}else if(t.kind==="farm"&&t.done){const i=it.getInstance(),e=t.growth||0;let n="wheat_stage_1";e>=.67?n="wheat_stage_3":e>=.33&&(n="wheat_stage_2");const l=i.getImage(n);l&&i.isLoaded()?(s.drawImage(l,t.x,t.y,t.w,t.h),s.strokeStyle="#0b0f14cc",s.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1)):(s.fillStyle=t.color,s.fillRect(t.x,t.y,t.w,t.h),s.strokeStyle="#0b0f14cc",s.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1),e>0&&(s.fillStyle="#4ade80",s.fillRect(t.x+2,t.y+t.h-4,(t.w-4)*Math.min(e,1),2)))}else s.fillStyle=t.color,s.fillRect(t.x,t.y,t.w,t.h),s.strokeStyle="#0b0f14cc",s.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1);if(!t.done){s.fillStyle="#0b1220",s.fillRect(t.x,t.y-6,t.w,4),s.fillStyle="#6ee7ff";const i=1-t.buildLeft/t.build;s.fillRect(t.x,t.y-6,i*t.w,4)}if(t.kind!=="house"&&!(t.kind==="farm"&&t.done)){s.fillStyle="#0b0f14aa",s.font="bold 12px system-ui";const i=t.x+t.w/2,e=t.y+t.h/2;let n="B";t.kind==="hq"?n="HQ":t.kind==="farm"?n="F":t.kind==="turret"?n="T":t.kind==="wall"?n="W":t.kind==="stock"?n="S":t.kind==="tent"?n="R":t.kind==="warehouse"?n="WH":t.kind==="well"?n="WL":t.kind==="infirmary"&&(n="I"),s.textAlign="center",s.textBaseline="middle",s.fillText(n,i,e)}if(t.kind==="turret"&&t.range){const i=t.x+t.w/2,e=t.y+t.h/2;s.globalAlpha=.07,s.fillStyle="#e2f3ff",s.beginPath(),s.arc(i,e,t.range,0,Math.PI*2),s.fill(),s.globalAlpha=1}}function ye(s,t){for(const i of t)s.globalAlpha=.8,s.strokeStyle="#e0f2fe",s.lineWidth=2,s.beginPath(),s.moveTo(i.x,i.y),s.lineTo(i.tx,i.ty),s.stroke(),s.globalAlpha=1}function ge(s,t,i,e){e.uiScale;const n=e.scale(e.isTouch?14:10),l=e.scale(e.isTouch?56:44),r=t.width;s.fillStyle="#0b122088",s.fillRect(0,0,r,l),s.strokeStyle="#1e293b",s.lineWidth=1,s.strokeRect(0,.5,r,l),s.fillStyle="#dbeafe",s.font=e.getScaledFont(e.isTouch?18:16,"600");let h=n;const o=Math.max(e.scale(e.isTouch?170:130),Math.min(e.scale(e.isTouch?260:220),Math.round(t.width*.14)));if(tt(s,h,e.scale(12),`Wood: ${Math.floor(i.res.wood)}`,"#b08968",e),h+=o,tt(s,h,e.scale(12),`Stone: ${Math.floor(i.res.stone)}`,"#9aa5b1",e),h+=Math.max(o,e.scale(e.isTouch?220:180)),tt(s,h,e.scale(12),`Food: ${Math.floor(i.res.food)}`,"#9ae6b4",e),h+=o,i.storage){const m=Math.floor(i.storage.used/i.storage.max*100),g=m>90?"#ef4444":m>70?"#eab308":"#22c55e";tt(s,h,e.scale(12),`Storage: ${Math.floor(i.storage.used)}/${i.storage.max} (${m}%)`,g,e),h+=Math.max(o,e.scale(e.isTouch?260:200))}const f=`Colonists: ${i.colonists}/${i.cap}`;tt(s,h,e.scale(12),f,"#93c5fd",e),h+=Math.max(o,e.scale(e.isTouch?260:210));const c=`Hiding: ${i.hiding}`;tt(s,h,e.scale(12),c,"#60a5fa",e),h+=Math.max(e.scale(e.isTouch?180:140),o*.9|0);const a=`Day ${i.day} — ${i.tDay*24|0}:00 ${i.isNight?"🌙":"☀️"}`;tt(s,h,e.scale(12),a,i.isNight?"#ffd166":"#6ee7ff",e);const d=t.height-e.scale(e.isTouch?86:64),p=Math.max(e.scale(e.isTouch?170:140),Math.min(e.scale(e.isTouch?260:220),(t.width-n*2)/i.hotbar.length));h=n,s.fillStyle="#0b122088",s.fillRect(0,d,t.width,e.scale(e.isTouch?86:64)),s.strokeStyle="#1e293b",s.strokeRect(0,d+.5,t.width,e.scale(e.isTouch?86:64)),s.font=e.getScaledFont(e.isTouch?17:15);for(let m=0;m<i.hotbar.length;m++){const g=i.hotbar[m],w=h+e.scale(2),k=d+e.scale(e.isTouch?14:10),M=p-e.scale(6),v=e.scale(e.isTouch?60:44);xe(s,w,k,M,v,`${m+1}. ${g.name}`,g.cost,g.selected,e),Array.isArray(e.hotbarRects)&&(e.hotbarRects[m]={index:m,x:w,y:k,w:M,h:v}),h+=p}let x=l+e.scale(e.isTouch?12:8);const u=Math.min(e.scale(e.isTouch?520:420),t.width-n*2);for(let m=i.messages.length-1;m>=0;m--){const g=i.messages[m];me(s,r-u-n,x,g.text,u,e),x+=e.scale(e.isTouch?34:26)}}function tt(s,t,i,e,n,l){const r=s.measureText(e).width+l.scale(l.isTouch?28:24),h=l.scale(l.isTouch?32:26);s.fillStyle="#0f172a",s.fillRect(t,i,r,h),s.strokeStyle="#1e293b",s.strokeRect(t+.5,i+.5,r-1,h-1),s.fillStyle=n,s.fillRect(t+l.scale(3),i+l.scale(3),l.scale(l.isTouch?10:8),h-l.scale(6)),s.fillStyle="#dbeafe",s.fillText(e,t+l.scale(l.isTouch?18:16),i+l.scale(l.isTouch?22:18))}function xe(s,t,i,e,n,l,r,h,o){s.fillStyle=h?"#102034":"#0f172a",s.fillRect(t,i,e,n),s.strokeStyle=h?"#4b9fff":"#1e293b",s.strokeRect(t+.5,i+.5,e-1,n-1),s.fillStyle="#dbeafe",s.fillText(l,t+o.scale(10),i+o.scale(o.isTouch?36:28)),s.fillStyle="#9fb3c8",s.fillText(r,t+e-o.scale(o.isTouch?66:56),i+o.scale(o.isTouch?36:28))}function me(s,t,i,e,n,l){const r=l.scale(l.isTouch?30:24);s.fillStyle="#0f172aee",s.fillRect(t,i,n,r),s.strokeStyle="#1e293b",s.strokeRect(t+.5,i+.5,n-1,r-1),s.fillStyle="#dbeafe",s.fillText(e,t+l.scale(10),i+l.scale(l.isTouch?20:16))}function ut(s,t,i,e){for(const n of s.buildings){if(n.kind==="hq"||n.kind==="path"||n.kind==="house"||!n.done)continue;const l=Math.max(n.x,Math.min(t,n.x+n.w)),r=Math.max(n.y,Math.min(i,n.y+n.h)),h=t-l,o=i-r;if(h*h+o*o<=e*e)return!0}return!1}function pe(s,t){t.stuckTimer===void 0&&(t.stuckTimer=0),t.lastPos||(t.lastPos={x:t.x,y:t.y}),t.lastMoveCheck||(t.lastMoveCheck=0);const i=ut(s,t.x,t.y,t.r);t.lastMoveCheck+=1/60;let e=!1;if(t.lastMoveCheck>1&&(Math.hypot(t.x-t.lastPos.x,t.y-t.lastPos.y)<5&&(t.state==="chop"||t.state==="mine"||t.state==="build"||t.state==="harvest")&&(e=!0),t.lastPos={x:t.x,y:t.y},t.lastMoveCheck=0),i||e){if(t.stuckTimer+=1/60,t.stuckTimer>3){const l=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let r=!1;for(const h of[20,40,60,80]){for(const o of l){const f=t.x+Math.cos(o)*h,c=t.y+Math.sin(o)*h,a=Math.max(t.r,Math.min(f,T.w-t.r)),d=Math.max(t.r,Math.min(c,T.h-t.r));if(!ut(s,a,d,t.r)){t.x=a,t.y=d,t.stuckTimer=0,r=!0,console.log(`Rescued stuck colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) using distance ${h}`);break}}if(r)break}if(!r){const h=s.buildings.find(o=>o.kind==="hq");h&&(t.x=h.x+h.w/2+(Math.random()-.5)*40,t.y=h.y-40+(Math.random()-.5)*20,t.stuckTimer=0,console.log("Emergency rescue: teleported stuck colonist to HQ area"))}return!0}}else t.stuckTimer=0;return!1}function we(s,t,i){if(!t.alive)return;if(t.t+=i,t.state||o("seekTask","initial state"),t.stateSince=(t.stateSince||0)+i,pe(s,t)){t.task=null,t.target=null,s.clearPath&&s.clearPath(t),o("seekTask","rescued from stuck");return}const e=t.state==="build"||t.state==="chop"||t.state==="mine"||t.state==="harvest"||t.state==="flee"||t.state==="move",n=e?.25:t.inside?.1:.15;t.hunger=Math.max(0,Math.min(100,(t.hunger||0)+i*n));const l=e?.8:.3;if(t.inside||t.state==="resting"||t.state==="sleep"?t.fatigue=Math.max(0,(t.fatigue||0)-i*8):t.fatigue=Math.min(100,(t.fatigue||0)+i*l),t.fatigueSlow=(t.fatigue||0)>66?.8:(t.fatigue||0)>33?.9:1,(t.hunger||0)>=95){const a=2*i;t.hp=Math.max(0,t.hp-a),Math.random()<.05&&console.log(`Colonist starving: hunger=${(t.hunger||0).toFixed(1)}, hp=${t.hp.toFixed(1)}, damage=${a.toFixed(2)}/frame`)}(t.hunger||0)<30&&!e&&!t.inside&&(t.hp=Math.min(100,t.hp+.8*i));const r=s.buildings.find(a=>a.kind==="infirmary"&&a.done);if(r){const a=r.healRange||140,d=r.healRate||3;(t.x-(r.x+r.w/2))**2+(t.y-(r.y+r.h/2))**2<=a*a&&(t.hp=Math.min(100,t.hp+d*i))}const h=s.enemies.find(a=>F(a,t)<140*140);t.lastHp=t.lastHp??t.hp,t.hp<t.lastHp&&(t.hurt=1.5),t.lastHp=t.hp,t.hurt=Math.max(0,(t.hurt||0)-i);function o(a,d){t.state!==a&&((a==="sleep"||a==="flee"||a==="heal"||a==="goToSleep"||a==="eat"||a==="resting")&&t.task&&(t.task==="chop"||t.task==="mine"||t.task==="build"||t.task==="harvestFarm"||t.task==="harvestWell")&&(t.task==="build"&&t.target&&s.releaseBuildReservation&&s.releaseBuildReservation(t),t.target&&s.assignedTargets&&s.assignedTargets.has(t.target)&&s.assignedTargets.delete(t.target),t.task=null,t.target=null,s.clearPath&&s.clearPath(t)),t.state=a,t.stateSince=0,d&&Math.random()<.1&&console.log(`Colonist state change: ${t.state} → ${a} (${d})`))}const c=t.stateSince>1||t.state==="idle"||t.state==="seekTask"||t.state==="chop"||t.state==="mine"||t.state==="build"||t.state==="harvest"||h;switch(!t.inside&&h&&t.state!=="flee"?o("flee","danger detected"):!t.inside&&!h&&s.isNight()&&t.state!=="sleep"&&t.state!=="flee"&&c?o("sleep","night time"):!t.inside&&(t.hp||0)<35&&t.state!=="flee"&&c?o("heal","low health"):!t.inside&&!h&&!s.isNight()&&(t.fatigue||0)>80&&t.state!=="flee"&&t.state!=="heal"&&t.state!=="goToSleep"&&c?o("goToSleep","fatigue"):!t.inside&&(t.hunger||0)>75&&(s.RES.food||0)>0&&t.state!=="flee"&&t.state!=="eat"&&c?o("eat","hunger"):t.inside&&t.state!=="resting"&&o("resting","entered building"),t.state){case"resting":{t.hideTimer=Math.max(0,(t.hideTimer||0)-i),t.hp=Math.min(100,t.hp+1.2*i),!s.isNight()&&!h&&(t.hurt||0)<=0&&(t.hideTimer||0)<=0&&(s.leaveBuilding(t),t.safeTarget=null,t.safeTimer=0,t.state="seekTask",t.stateSince=0);break}case"heal":{const a=s.buildings.filter(w=>w.kind==="infirmary"&&w.done);if(!a.length){t.state="seekTask",t.stateSince=0;break}let d=a[0],p=F(t,s.centerOf(d));for(let w=1;w<a.length;w++){const k=F(t,s.centerOf(a[w]));k<p&&(p=k,d=a[w])}const x=s.centerOf(d),u=d.healRange||140,m=t.x>=d.x-8&&t.x<=d.x+d.w+8&&t.y>=d.y-8&&t.y<=d.y+d.h+8,g=Math.hypot(t.x-x.x,t.y-x.y);if(m&&s.tryEnterBuilding(t,d)){t.state="resting",t.stateSince=0;break}g<=u*.9?t.hp>=80&&(t.state="seekTask",t.stateSince=0):s.moveAlongPath(t,i,x,u*.9);break}case"eat":{const a=(s.RES.food||0)>0;if(Math.random()<.01&&console.log(`Colonist eating: food=${s.RES.food}, hunger=${t.hunger}, stateSince=${t.stateSince.toFixed(1)}`),!a){t.stateSince>1&&(t.hp=Math.max(0,t.hp-2.5*i)),console.log("NO FOOD AVAILABLE! Colonist will continue tasks or sleep."),t.state=s.isNight()?"sleep":"seekTask",t.stateSince=0;break}const d=s.buildings.filter(u=>(u.kind==="hq"||u.kind==="warehouse"||u.kind==="stock")&&u.done);if(Math.random()<.01&&console.log(`Food buildings found: ${d.length}, buildings: ${d.map(u=>u.kind).join(", ")}`),d.length===0){console.log(`No food buildings found! Available buildings: ${s.buildings.filter(u=>u.done).map(u=>u.kind).join(", ")}`),t.stateSince>1&&(s.RES.food-=1,t.hunger=Math.max(0,(t.hunger||0)-60),t.hp=Math.min(100,t.hp+2.5),t.state="seekTask",t.stateSince=0,console.log(`Colonist ate without building! Food remaining: ${s.RES.food}`));break}let p=null,x=1/0;for(const u of d){const m=s.centerOf(u),g=Math.hypot(t.x-m.x,t.y-m.y);g<x&&(x=g,p=u)}if(p){const u=s.centerOf(p),m=Math.max(p.w,p.h)/2+t.r+15;Math.random()<.01&&console.log(`Eating: distance=${x.toFixed(1)}, reachDist=${m.toFixed(1)}, stateSince=${t.stateSince.toFixed(1)}`),x<=m?t.stateSince>.6&&(console.log(`Colonist successfully ate! Food: ${s.RES.food} → ${s.RES.food-1}, hunger: ${t.hunger} → ${Math.max(0,(t.hunger||0)-60)}`),s.RES.food-=1,t.hunger=Math.max(0,(t.hunger||0)-60),t.hp=Math.min(100,t.hp+2.5),o("seekTask","finished eating")):s.moveAlongPath(t,i,u,m)}break}case"flee":{let a=null,d=null;const p=h?s.findSafeTurret(t,h):null;if(p){const x=p.range||120,u=s.centerOf(p),m=s.buildings.find(g=>g.kind==="house"&&g.done&&s.buildingHasSpace(g)&&F(s.centerOf(g),u)<x*x);m&&(d=m,a=s.centerOf(m))}if(!a){const x=s.buildings.find(u=>u.kind==="hq"&&s.buildingHasSpace(u));x&&(d=x,a=s.centerOf(x))}if(!a&&p&&(a=s.centerOf(p)),a){const x=a.x-t.x,u=a.y-t.y,m=Math.hypot(x,u),g=d?t.x>=d.x-8&&t.x<=d.x+d.w+8&&t.y>=d.y-8&&t.y<=d.y+d.h+8:!1;if(m<=20||g)if(d&&s.tryEnterBuilding(t,d))t.hideTimer=3,t.state="resting",t.stateSince=0;else{const w=s.buildings.filter(k=>k.done&&s.buildingHasSpace(k)&&(k.kind==="house"||k.kind==="hq"));if(w.length){const k=w.sort((v,C)=>F(t,s.centerOf(v))-F(t,s.centerOf(C)))[0],M=s.centerOf(k);d=k,a=M}}else s.moveAlongPath(t,i,a,20)}else{const x=Ht(Xt(t,h));t.x+=x.x*(t.speed+90)*i,t.y+=x.y*(t.speed+90)*i}h||(t.state="seekTask",t.stateSince=0);break}case"sleep":{const a=s.buildings.filter(k=>k.kind==="house"&&k.done&&s.isProtectedByTurret(k)&&s.buildingHasSpace(k));if(!s.isNight()||a.length===0){t.state="seekTask",t.stateSince=0;break}let d=a[0],p=F(t,s.centerOf(d));for(let k=1;k<a.length;k++){const M=F(t,s.centerOf(a[k]));M<p&&(p=M,d=a[k])}let x=s.centerOf(d);const u=x.x-t.x,m=x.y-t.y,g=Math.hypot(u,m),w=t.x>=d.x-8&&t.x<=d.x+d.w+8&&t.y>=d.y-8&&t.y<=d.y+d.h+8;if(g<=20||w)if(s.tryEnterBuilding(t,d))t.hideTimer=0,t.state="resting",t.stateSince=0;else{const k=s.buildings.filter(M=>M.done&&s.buildingHasSpace(M)&&(M.kind==="house"||M.kind==="hq")).sort((M,v)=>F(t,s.centerOf(M))-F(t,s.centerOf(v)))[0];if(k){const M=s.centerOf(k);d=k,x=M}else t.state="seekTask",t.stateSince=0}else s.moveAlongPath(t,i,x,20);break}case"goToSleep":{const a=s.buildings.filter(g=>(g.kind==="house"||g.kind==="infirmary")&&g.done&&s.buildingHasSpace(g));if(a.length===0){t.stateSince>3&&(t.state="seekTask",t.stateSince=0);break}let d=a[0],p=F(t,s.centerOf(d));for(let g=1;g<a.length;g++){const w=F(t,s.centerOf(a[g]));w<p&&(p=w,d=a[g])}const x=s.centerOf(d),u=Math.hypot(x.x-t.x,x.y-t.y),m=t.x>=d.x-8&&t.x<=d.x+d.w+8&&t.y>=d.y-8&&t.y<=d.y+d.h+8;if(u<=20||m)if(s.tryEnterBuilding(t,d))t.hideTimer=0,t.state="resting",t.stateSince=0;else{const g=a.filter(w=>w!==d&&s.buildingHasSpace(w)).sort((w,k)=>F(t,s.centerOf(w))-F(t,s.centerOf(k)))[0];g?(s.centerOf(g),s.clearPath(t)):(t.fatigue||0)<60&&(t.state="seekTask",t.stateSince=0)}else s.moveAlongPath(t,i,x,20);break}case"seekTask":{if(s.isNight()){o("sleep","night time");break}if(!t.task||t.task==="idle"&&Math.random()<.005){const a=t.task;s.pickTask(t),a!==t.task&&Math.random()<.1&&console.log(`Colonist assigned task: ${t.task}, target:`,t.target)}switch(t.task){case"build":o("build","assigned build task");break;case"harvestFarm":o("harvest","assigned farm task");break;case"harvestWell":o("harvest","assigned well task");break;case"chop":o("chop","assigned chop task");break;case"mine":o("mine","assigned mine task");break;case"idle":default:o("idle","no tasks available");break}break}case"idle":{const a=t.target;if(!a){o("seekTask","no target");break}s.moveAlongPath(t,i,a,8)&&(t.task=null,t.target=null,s.clearPath(t),o("seekTask","reached target"));break}case"build":{const a=t.target;if(!a||a.done){s.releaseBuildReservation(t),t.task=null,t.target=null,s.clearPath(t),o("seekTask","building complete");break}const d={x:a.x+a.w/2,y:a.y+a.h/2};if(t.stateSince>15){console.log(`Build task timeout after ${t.stateSince.toFixed(1)}s, abandoning building`),s.releaseBuildReservation(t),t.task=null,t.target=null,s.clearPath(t),o("seekTask","build timeout");break}const p=Math.hypot(t.x-d.x,t.y-d.y);if(t.lastDistToNode||(t.lastDistToNode=p),t.stateSince>3&&Math.abs(p-t.lastDistToNode)<5){if(t.jitterScore=(t.jitterScore||0)+1,t.jitterScore>30){console.log("Build jittering detected, clearing path and retrying"),s.clearPath(t),t.jitterScore=0;const x=(Math.random()-.5)*20;d.x+=x,d.y+=x}}else t.jitterScore=0;if(t.lastDistToNode=p,s.moveAlongPath(t,i,d,12)&&(a.buildLeft-=25*i,a.buildLeft<=0)){if(a.done=!0,a.kind==="farm"&&(a.growth=0,a.ready=!1),ut(s,t.x,t.y,t.r)){const x=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let u=!1;for(const m of x){const g=Math.max(a.w,a.h)/2+t.r+10,w=a.x+a.w/2+Math.cos(m)*g,k=a.y+a.h/2+Math.sin(m)*g,M=Math.max(t.r,Math.min(w,T.w-t.r)),v=Math.max(t.r,Math.min(k,T.h-t.r));if(!ut(s,M,v,t.r)){t.x=M,t.y=v,u=!0,Math.random()<.1&&console.log(`Moved colonist to safety after building completion: (${t.x.toFixed(1)}, ${t.y.toFixed(1)})`);break}}if(!u){const m=s.buildings.find(g=>g.kind==="hq");m&&(t.x=m.x+m.w/2,t.y=m.y-30,console.log("Emergency teleport to HQ area after building completion"))}}s.msg(a.name?a.name+" complete":"Building complete"),s.rebuildNavGrid(),s.clearPath(t),s.releaseBuildReservation(t),t.task=null,t.target=null,t.state="seekTask"}break}case"harvest":{const a=t.target;if(!a){t.task=null,t.target=null,s.clearPath(t),t.state="seekTask";break}if(a.kind==="farm"&&!a.ready){t.task=null,t.target=null,s.clearPath(t),t.state="seekTask";break}const d={x:a.x+a.w/2,y:a.y+a.h/2};if(s.moveAlongPath(t,i,d,12)){if(a.kind==="farm"){a.ready=!1,a.growth=0;const p=s.addResource("food",10);p>0&&s.msg(`Farm harvested (+${p} food)`,"good")}else if(a.kind==="well"){const p=s.addResource("food",5);p>0&&s.msg(`Well collected (+${p} food)`,"good")}t.task=null,t.target=null,s.clearPath(t),t.state="seekTask"}break}case"chop":{const a=t.target;if(!a||a.hp<=0){a&&s.assignedTargets.has(a)&&s.assignedTargets.delete(a),t.task=null,t.target=null,s.clearPath(t),t.state="seekTask";break}const d=a.x-t.x,p=a.y-t.y,x=Math.hypot(d,p),u=(a.r||12)+t.r+4,m=2.5;if(x<=u+m+.1){if(a.hp-=18*i,a.hp<=0){const g=s.addResource("wood",6);s.trees.splice(s.trees.indexOf(a),1),s.assignedTargets.has(a)&&s.assignedTargets.delete(a),g>0&&s.msg(`+${g} wood`,"good"),s.rebuildNavGrid(),t.task=null,t.target=null,s.clearPath(t),t.state="seekTask"}break}else s.moveAlongPath(t,i,a,u+m),t.lastDistToNode||(t.lastDistToNode=x),t.stateSince>5&&Math.abs(x-t.lastDistToNode)<2?(t.jitterScore=(t.jitterScore||0)+1,t.jitterScore>120&&(console.log("Chop task stuck, clearing path and retrying"),s.clearPath(t),t.jitterScore=0)):t.jitterScore=0,t.lastDistToNode=x;t.stateSince&&t.stateSince>20&&(console.log(`Chop task timeout after ${t.stateSince.toFixed(1)}s, abandoning tree`),s.assignedTargets.has(a)&&s.assignedTargets.delete(a),t.task=null,t.target=null,s.clearPath(t),t.state="seekTask");break}case"mine":{const a=t.target;if(!a||a.hp<=0){a&&s.assignedTargets.has(a)&&s.assignedTargets.delete(a),t.task=null,t.target=null,s.clearPath(t),t.state="seekTask";break}const d=a.x-t.x,p=a.y-t.y,x=Math.hypot(d,p),u=(a.r||12)+t.r+4,m=2.5;if(Math.random()<.01&&console.log(`Mining: distance=${x.toFixed(1)}, interact=${u}, colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}), rock at (${a.x.toFixed(1)}, ${a.y.toFixed(1)})`),x<=u+m+.1){if(a.hp-=16*i,a.hp<=0){const g=s.addResource("stone",5);s.rocks.splice(s.rocks.indexOf(a),1),s.assignedTargets.has(a)&&s.assignedTargets.delete(a),g>0&&s.msg(`+${g} stone`,"good"),s.rebuildNavGrid(),t.task=null,t.target=null,s.clearPath(t),t.state="seekTask"}break}else s.moveAlongPath(t,i,a,u+m),Math.random()<.01&&console.log(`Moving toward rock: target=(${a.x.toFixed(1)}, ${a.y.toFixed(1)}), distance=${x.toFixed(1)}`);t.stateSince&&t.stateSince>15&&(console.log(`Colonist stuck mining for ${t.stateSince.toFixed(1)}s, abandoning`),s.assignedTargets.has(a)&&s.assignedTargets.delete(a),t.task=null,t.target=null,s.clearPath(t),t.state="seekTask");break}}for(const a of s.colonists){if(a===t)continue;if((t.state==="mine"||t.state==="chop")&&t.target){const m=(t.target.r||12)+t.r+4;if(Math.hypot(t.x-t.target.x,t.y-t.target.y)<=m+2.5)continue}const d=t.x-a.x,p=t.y-a.y,x=d*d+p*p,u=(t.r+2)*(t.r+2);if(x>0&&x<u*4){const m=Math.sqrt(x)||1,g=(u*2-m)*.5;t.x+=d/m*g*i*6,t.y+=p/m*g*i*6}}}function kt(s,t,i,e){for(const n of s.buildings){if(n.kind==="hq"||n.kind==="path"||n.kind==="house"||!n.done)continue;const l=Math.max(n.x,Math.min(t,n.x+n.w)),r=Math.max(n.y,Math.min(i,n.y+n.h)),h=t-l,o=i-r;if(h*h+o*o<=e*e)return!0}return!1}function ke(s,t,i){const e=s.buildings.find(c=>c.kind==="hq");let n=e,l=F(t,s.centerOf(e));for(const c of s.colonists){const a=F(t,c);a<l&&(l=a,n=c)}const r=n.w?s.centerOf(n):n,h=Ht(Xt(r,t)),o=t.x+h.x*t.speed*i,f=t.y+h.y*t.speed*i;if(!kt(s,o,f,t.r))t.x=o,t.y=f;else{const c=-h.y,a=h.x,d=t.x+c*t.speed*i*.5,p=t.y+a*t.speed*i*.5;if(!kt(s,d,p,t.r))t.x=d,t.y=p;else{const x=t.x-c*t.speed*i*.5,u=t.y-a*t.speed*i*.5;kt(s,x,u,t.r)||(t.x=x,t.y=u)}}if(n.w){const c=n;s.pointInRect(t,c)&&(c.hp-=t.dmg*i),c.hp<=0&&(c.kind==="hq"?s.lose():(s.evictColonistsFrom(c),s.buildings.splice(s.buildings.indexOf(c),1),s.msg((c.name||c.kind)+" destroyed","warn")))}else{const c=n;Math.hypot(t.x-c.x,t.y-c.y)<t.r+8&&(c.hp-=t.dmg*i,c.hp<=0&&(c.alive=!1,s.colonists.splice(s.colonists.indexOf(c),1),s.msg("A colonist has fallen","warn")))}}class Me{constructor(t){b(this,"canvas");b(this,"ctx");b(this,"DPR",1);b(this,"camera",{x:0,y:0,zoom:1});b(this,"uiScale",1);b(this,"baseFontSize",14);b(this,"isTouch",!1);b(this,"RES",{wood:0,stone:0,food:0});b(this,"BASE_STORAGE",200);b(this,"storageFullWarned",!1);b(this,"day",1);b(this,"tDay",0);b(this,"dayLength",180);b(this,"fastForward",1);b(this,"paused",!1);b(this,"prevIsNight",!1);b(this,"colonists",[]);b(this,"enemies",[]);b(this,"trees",[]);b(this,"rocks",[]);b(this,"buildings",[]);b(this,"bullets",[]);b(this,"messages",[]);b(this,"selectedBuild","house");b(this,"hotbar",["house","farm","turret","wall","stock","tent","warehouse","well","infirmary"]);b(this,"showBuildMenu",!1);b(this,"debug",{nav:!1,paths:!0,colonists:!1});b(this,"selColonist",null);b(this,"follow",!1);b(this,"keyState",{});b(this,"once",new Set);b(this,"mouse",{x:0,y:0,wx:0,wy:0,down:!1,rdown:!1});b(this,"lastPaintCell",null);b(this,"eraseDragStart",null);b(this,"menuRects",[]);b(this,"hotbarRects",[]);b(this,"pendingPlacement",null);b(this,"placeUIRects",[]);b(this,"colonistPanelRect",null);b(this,"colonistPanelCloseRect",null);b(this,"handleResize",()=>{const t=document.querySelector("header"),i=t?Math.ceil(t.getBoundingClientRect().height):48,e=window.innerWidth,n=window.innerHeight-i;this.canvas.style.width=e+"px",this.canvas.style.height=n+"px",this.canvas.width=Math.floor(e*this.DPR),this.canvas.height=Math.floor(n*this.DPR),this.calculateUIScale()});b(this,"screenToWorld",(t,i)=>({x:t*this.DPR/this.camera.zoom+this.camera.x,y:i*this.DPR/this.camera.zoom+this.camera.y}));b(this,"respawnTimer",0);b(this,"assignedTargets",new WeakSet);b(this,"buildReservations",new Map);b(this,"insideCounts",new Map);b(this,"last",performance.now());b(this,"frame",t=>{const i=Math.min(.033,(t-this.last)/1e3);this.last=t,this.update(i),this.draw(),requestAnimationFrame(this.frame)});b(this,"grid",Vt());const i=t.getContext("2d");if(!i)throw new Error("no ctx");this.canvas=t,this.ctx=i,this.DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)),this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.bindInput(),this.newGame(),this.rebuildNavGrid(),requestAnimationFrame(this.frame)}getStorageCapacity(){let t=this.BASE_STORAGE;for(const i of this.buildings)i.done&&i.storageBonus&&(t+=i.storageBonus);return t}getPopulationCap(){return(this.buildings.find(t=>t.kind==="hq")?3:0)+this.buildings.filter(t=>t.kind==="house"&&t.done).reduce((t,i)=>t+(i.popCap||0),0)}addResource(t,i){const e=this.RES.wood+this.RES.stone+this.RES.food,n=this.getStorageCapacity(),l=Math.max(0,n-e),r=Math.min(Math.floor(i),l);return r>0&&(this.RES[t]+=r),r===0&&i>0&&!this.storageFullWarned?(this.msg(`Storage full! Cannot store more ${String(t)}`,"warn"),this.storageFullWarned=!0):r>0&&(this.storageFullWarned=!1),r}calculateUIScale(){const e=this.canvas.width/this.DPR,n=this.canvas.height/this.DPR,l=e/1920,r=n/1080;let h=Math.min(l,r);const o="ontouchstart"in window||navigator.maxTouchPoints>0;this.isTouch=o,o?e<600?h=Math.max(h*1.9,1.6):e<=900?h=Math.max(h*1.7,1.5):e<=1200?h=Math.max(h*1.5,1.35):h=Math.max(h*1.25,h):e<1200&&(h*=1.1),h=Math.max(1.1,Math.min(h,3)),this.uiScale=h,console.log(`UI Scale calculated: ${h.toFixed(2)} for ${e}x${n}`)}getScaledFont(t,i="500",e="system-ui,Segoe UI,Roboto"){return`${i} ${Math.round(t*this.uiScale)}px ${e}`}scale(t){return Math.round(t*this.uiScale)}bindInput(){const t=this.canvas;t.addEventListener("mousemove",i=>{const e=t.getBoundingClientRect();this.mouse.x=i.clientX-e.left,this.mouse.y=i.clientY-e.top;const n=this.screenToWorld(this.mouse.x,this.mouse.y);this.mouse.wx=n.x,this.mouse.wy=n.y,this.mouse.down&&(this.selectedBuild==="path"?this.paintPathAtMouse():this.selectedBuild==="wall"&&this.paintWallAtMouse())}),t.addEventListener("mousedown",i=>{if(i.preventDefault(),i.button===0){if(this.mouse.down=!0,this.selColonist){const l=this.mouse.x*this.DPR,r=this.mouse.y*this.DPR;if(this.colonistPanelCloseRect){const h=this.colonistPanelCloseRect;if(l>=h.x&&l<=h.x+h.w&&r>=h.y&&r<=h.y+h.h){this.selColonist=null,this.follow=!1;return}}if(this.colonistPanelRect){const h=this.colonistPanelRect;if(!(l>=h.x&&l<=h.x+h.w&&r>=h.y&&r<=h.y+h.h)){this.selColonist=null,this.follow=!1;return}}}if(this.pendingPlacement){const l=this.mouse.x*this.DPR,r=this.mouse.y*this.DPR;if(this.placeUIRects.length){for(const g of this.placeUIRects)if(l>=g.x&&l<=g.x+g.w&&r>=g.y&&r<=g.y+g.h){g.id==="up"?this.nudgePending(0,-1):g.id==="down"?this.nudgePending(0,1):g.id==="left"?this.nudgePending(-1,0):g.id==="right"?this.nudgePending(1,0):g.id==="ok"?this.confirmPending():g.id==="cancel"&&this.cancelPending();return}}const h=this.pendingPlacement,o=W[h.key],c=((g,w)=>({x:(g-this.camera.x)*this.camera.zoom,y:(w-this.camera.y)*this.camera.zoom}))(h.x,h.y),a=o.size.w*y*this.camera.zoom,d=o.size.h*y*this.camera.zoom;if(l>=c.x&&l<=c.x+a&&r>=c.y&&r<=c.y+d){this.confirmPending();return}const p=Math.floor(this.mouse.wx/y)*y,x=Math.floor(this.mouse.wy/y)*y,u=o.size.w*y,m=o.size.h*y;h.x=U(p,0,T.w-u),h.y=U(x,0,T.h-m);return}const e=this.mouse.x*this.DPR,n=this.mouse.y*this.DPR;for(const l of this.hotbarRects)if(e>=l.x&&e<=l.x+l.w&&n>=l.y&&n<=l.y+l.h){const r=this.hotbar[l.index];r&&(this.selectedBuild=r,this.toast("Selected: "+W[r].name));return}if(this.showBuildMenu){this.handleBuildMenuClick();return}if(this.selectedBuild==="path")this.paintPathAtMouse(!0);else if(this.selectedBuild==="wall")this.paintWallAtMouse(!0);else{const l=this.findColonistAt(this.mouse.wx,this.mouse.wy);l?(this.selColonist=l,this.follow=!0):this.placeAtMouse()}}if(i.button===2){if(this.mouse.rdown=!0,this.showBuildMenu){this.showBuildMenu=!1;return}this.eraseDragStart={x:this.mouse.wx,y:this.mouse.wy}}}),t.addEventListener("mouseup",i=>{if(i.preventDefault(),i.button===0&&(this.mouse.down=!1,this.lastPaintCell=null),i.button===2){if(this.eraseDragStart){const e=Math.min(this.eraseDragStart.x,this.mouse.wx),n=Math.min(this.eraseDragStart.y,this.mouse.wy),l=Math.max(this.eraseDragStart.x,this.mouse.wx),r=Math.max(this.eraseDragStart.y,this.mouse.wy);(l-e)*(r-n)<12*12?this.cancelOrErase():this.eraseInRect({x:e,y:n,w:l-e,h:r-n})}this.mouse.rdown=!1,this.eraseDragStart=null}}),t.addEventListener("contextmenu",i=>i.preventDefault()),t.addEventListener("wheel",i=>{i.preventDefault();const e=i.deltaY<0?1.1:.9;this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*e))}),window.addEventListener("keydown",i=>{const e=i.key.toLowerCase();this.keyState[e]=!0,this.once.has(e)||this.once.add(e),(e===" "||e==="h"||e==="b"||e==="f"||e==="g"||e==="j"||e==="escape"||/^[1-9]$/.test(e)||e==="w"||e==="a"||e==="s"||e==="d"||e==="+"||e==="="||e==="-"||e==="_")&&i.preventDefault()}),window.addEventListener("keyup",i=>{this.keyState[i.key.toLowerCase()]=!1})}handleTapOrClickAtScreen(t,i){this.canvas.getBoundingClientRect(),this.mouse.x=t,this.mouse.y=i;const n=this.screenToWorld(this.mouse.x,this.mouse.y);if(this.mouse.wx=n.x,this.mouse.wy=n.y,this.pendingPlacement){const o=this.mouse.x*this.DPR,f=this.mouse.y*this.DPR;if(this.placeUIRects.length){for(const M of this.placeUIRects)if(o>=M.x&&o<=M.x+M.w&&f>=M.y&&f<=M.y+M.h){M.id==="up"?this.nudgePending(0,-1):M.id==="down"?this.nudgePending(0,1):M.id==="left"?this.nudgePending(-1,0):M.id==="right"?this.nudgePending(1,0):M.id==="ok"?this.confirmPending():M.id==="cancel"&&this.cancelPending();return}}const c=this.pendingPlacement,a=W[c.key],p=((M,v)=>({x:(M-this.camera.x)*this.camera.zoom,y:(v-this.camera.y)*this.camera.zoom}))(c.x,c.y),x=a.size.w*y*this.camera.zoom,u=a.size.h*y*this.camera.zoom;if(o>=p.x&&o<=p.x+x&&f>=p.y&&f<=p.y+u){this.confirmPending();return}const m=Math.floor(this.mouse.wx/y)*y,g=Math.floor(this.mouse.wy/y)*y,w=a.size.w*y,k=a.size.h*y;c.x=U(m,0,T.w-w),c.y=U(g,0,T.h-k);return}if(this.selColonist){const o=this.mouse.x*this.DPR,f=this.mouse.y*this.DPR;if(this.colonistPanelCloseRect){const c=this.colonistPanelCloseRect;if(o>=c.x&&o<=c.x+c.w&&f>=c.y&&f<=c.y+c.h){this.selColonist=null,this.follow=!1;return}}if(this.isTouch&&this.colonistPanelRect){const c=this.colonistPanelRect;if(!(o>=c.x&&o<=c.x+c.w&&f>=c.y&&f<=c.y+c.h)){this.selColonist=null,this.follow=!1;return}}}const l=this.mouse.x*this.DPR,r=this.mouse.y*this.DPR;for(const o of this.hotbarRects)if(l>=o.x&&l<=o.x+o.w&&r>=o.y&&r<=o.y+o.h){const f=this.hotbar[o.index];f&&(this.selectedBuild=f,this.toast("Selected: "+W[f].name));return}if(this.showBuildMenu){this.handleBuildMenuClick();return}if(this.selectedBuild==="path"){this.paintPathAtMouse(!0);return}if(this.selectedBuild==="wall"){this.paintWallAtMouse(!0);return}if(this.isTouch&&this.selectedBuild){this.placeAtMouse();return}const h=this.findColonistAt(this.mouse.wx,this.mouse.wy);if(h){this.selColonist=h,this.follow=!0;return}this.placeAtMouse()}findColonistAt(t,i){for(let e=this.colonists.length-1;e>=0;e--){const n=this.colonists[e];if(!n.alive||n.inside)continue;if((n.x-t)*(n.x-t)+(n.y-i)*(n.y-i)<=(n.r+2)*(n.r+2))return n}return null}msg(t,i="info"){this.messages.push({text:t,t:4,kind:i}),this.toast(t,1600)}toast(t,i=1400){const e=document.getElementById("toast");e&&(e.textContent=t,e.style.opacity="1",clearTimeout(e._t),e._t=setTimeout(()=>e.style.opacity="0",i))}scatter(){for(let t=0;t<220;t++){const i={x:Y(80,T.w-80),y:Y(80,T.h-80)};Math.hypot(i.x-z.x,i.y-z.y)<220||this.trees.push({x:i.x,y:i.y,r:12,hp:40,type:"tree"})}for(let t=0;t<140;t++){const i={x:Y(80,T.w-80),y:Y(80,T.h-80)};Math.hypot(i.x-z.x,i.y-z.y)<200||this.rocks.push({x:i.x,y:i.y,r:12,hp:50,type:"rock"})}this.rebuildNavGrid()}tryRespawn(t){if(this.respawnTimer+=t*this.fastForward,this.respawnTimer>=4){this.respawnTimer=0;const i=e=>{for(let n=0;n<6;n++){const l={x:Y(60,T.w-60),y:Y(60,T.h-60)};if(Math.hypot(l.x-z.x,l.y-z.y)<200)continue;let r=!0;for(const h of this.buildings)if(l.x>h.x-24&&l.x<h.x+h.w+24&&l.y>h.y-24&&l.y<h.y+h.h+24){r=!1;break}if(r){e==="tree"?this.trees.push({x:l.x,y:l.y,r:12,hp:40,type:"tree"}):this.rocks.push({x:l.x,y:l.y,r:12,hp:50,type:"rock"}),this.rebuildNavGrid();break}}};Math.random()<.5&&this.trees.length<260&&i("tree"),Math.random()<.35&&this.rocks.length<180&&i("rock")}}buildHQ(){const t={w:3*y,h:3*y},i={kind:"hq",name:"HQ",x:z.x-t.w/2,y:z.y-t.h/2,w:t.w,h:t.h,hp:600,done:!0,color:D.bld,size:{w:3,h:3},build:0,buildLeft:0};this.buildings.push(i),this.rebuildNavGrid()}newGame(){this.colonists.length=this.enemies.length=this.trees.length=this.rocks.length=this.buildings.length=this.bullets.length=this.messages.length=0,this.buildReservations.clear(),this.insideCounts.clear(),this.RES.wood=50,this.RES.stone=30,this.RES.food=20,this.day=1,this.tDay=0,this.fastForward=1,this.camera.zoom=1,this.camera.x=z.x-this.canvas.width/(2*this.camera.zoom),this.camera.y=z.y-this.canvas.height/(2*this.camera.zoom),this.buildHQ(),this.scatter();for(let t=0;t<3;t++){const i=Y(0,Math.PI*2),e=80+Y(-10,10);this.spawnColonist({x:z.x+Math.cos(i)*e,y:z.y+Math.sin(i)*e})}this.msg("Welcome! Build farms before night, then turrets.")}spawnColonist(t){const i={x:t.x,y:t.y,r:8,hp:100,speed:50,task:null,target:null,carrying:null,hunger:0,alive:!0,color:D.colonist,t:Y(0,1)};return this.colonists.push(i),i}spawnEnemy(){const t=jt(0,4);let i,e;t===0?(i=Y(0,T.w),e=-80):t===1?(i=Y(0,T.w),e=T.h+80):t===2?(i=-80,e=Y(0,T.h)):(i=T.w+80,e=Y(0,T.h));const n={x:i,y:e,r:9,hp:60+this.day*6,speed:48+this.day*2,dmg:8+this.day,target:null,color:D.enemy};return this.enemies.push(n),n}canPlace(t,i,e){const n={x:i,y:e,w:t.size.w*y,h:t.size.h*y};if(n.x<0||n.y<0||n.x+n.w>T.w||n.y+n.h>T.h)return!1;for(const r of this.buildings)if(!(n.x+n.w<=r.x||n.x>=r.x+r.w||n.y+n.h<=r.y||n.y>=r.y+r.h))return!1;const l=(r,h)=>{const o=Math.max(h.x,Math.min(r.x,h.x+h.w)),f=Math.max(h.y,Math.min(r.y,h.y+h.h)),c=r.x-o,a=r.y-f;return c*c+a*a<=r.r*r.r};for(const r of this.trees)if(l(r,n))return!1;for(const r of this.rocks)if(l(r,n))return!1;return!0}placeAtMouse(){if(this.paused)return;const t=this.selectedBuild;if(!(!t||!W[t])){if(this.isTouch){const e=Math.floor(this.mouse.wx/y)*y,n=Math.floor(this.mouse.wy/y)*y;this.pendingPlacement={key:t,x:e,y:n};return}this.tryPlaceNow(t,this.mouse.wx,this.mouse.wy)}}tryPlaceNow(t,i,e){const n=W[t];if(!n)return;const l=pt(t,i,e);if(!this.canPlace(l,l.x,l.y)){this.toast("Can't place here");return}if(!ft(this.RES,n.cost)){this.toast("Not enough resources");return}if(mt(this.RES,n.cost),l.kind!=="path")for(let r=this.buildings.length-1;r>=0;r--){const h=this.buildings[r];h.kind==="path"&&!(l.x+l.w<=h.x||l.x>=h.x+h.w||l.y+l.h<=h.y||l.y>=h.y+h.h)&&this.buildings.splice(r,1)}this.buildings.push(l),this.rebuildNavGrid()}nudgePending(t,i){if(!this.pendingPlacement)return;const e=W[this.pendingPlacement.key],n=this.pendingPlacement.x+t*y,l=this.pendingPlacement.y+i*y,r=e.size.w*y,h=e.size.h*y;this.pendingPlacement.x=U(n,0,T.w-r),this.pendingPlacement.y=U(l,0,T.h-h)}confirmPending(){if(!this.pendingPlacement)return;const{key:t,x:i,y:e}=this.pendingPlacement;this.pendingPlacement=null,this.tryPlaceNow(t,i+1,e+1)}cancelPending(){this.pendingPlacement=null}paintPathAtMouse(t=!1){const i=Math.floor(this.mouse.wx/y),e=Math.floor(this.mouse.wy/y);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===i&&this.lastPaintCell.gy===e)return;const n=(x,u)=>{const m=x*y+1,g=u*y+1,w=pt("path",m,g);!this.buildings.some(M=>M.kind==="path"&&M.x===w.x&&M.y===w.y)&&ft(this.RES,W.path.cost)&&(mt(this.RES,W.path.cost),this.buildings.push(w))};if(this.lastPaintCell==null){n(i,e),this.lastPaintCell={gx:i,gy:e},this.rebuildNavGrid();return}let l=this.lastPaintCell.gx,r=this.lastPaintCell.gy,h=i,o=e;const f=Math.abs(h-l),c=Math.abs(o-r),a=l<h?1:-1,d=r<o?1:-1;let p=f-c;for(;n(l,r),!(l===h&&r===o);){const x=2*p;x>-c&&(p-=c,l+=a),x<f&&(p+=f,r+=d)}this.lastPaintCell={gx:i,gy:e},this.rebuildNavGrid()}paintWallAtMouse(t=!1){const i=Math.floor(this.mouse.wx/y),e=Math.floor(this.mouse.wy/y);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===i&&this.lastPaintCell.gy===e)return;const n=(x,u)=>{const m=x*y+1,g=u*y+1,w=pt("wall",m,g);this.buildings.some(M=>M.kind==="wall"&&M.x===w.x&&M.y===w.y)||ft(this.RES,W.wall.cost)&&this.canPlace(w,w.x,w.y)&&(mt(this.RES,W.wall.cost),this.buildings.push(w))};if(this.lastPaintCell==null){n(i,e),this.lastPaintCell={gx:i,gy:e},this.rebuildNavGrid();return}let l=this.lastPaintCell.gx,r=this.lastPaintCell.gy,h=i,o=e;const f=Math.abs(h-l),c=Math.abs(o-r),a=l<h?1:-1,d=r<o?1:-1;let p=f-c;for(;n(l,r),!(l===h&&r===o);){const x=2*p;x>-c&&(p-=c,l+=a),x<f&&(p+=f,r+=d)}this.lastPaintCell={gx:i,gy:e},this.rebuildNavGrid()}eraseInRect(t){const i=this.buildings.length;for(let n=this.buildings.length-1;n>=0;n--){const l=this.buildings[n];if(l.kind==="hq")continue;!(t.x+t.w<=l.x||t.x>=l.x+l.w||t.y+t.h<=l.y||t.y>=l.y+l.h)&&(this.evictColonistsFrom(l),this.buildings.splice(n,1),this.buildReservations.delete(l),this.insideCounts.delete(l))}const e=i-this.buildings.length;e>0&&(this.msg(`Removed ${e} structure(s)`),this.rebuildNavGrid())}cancelOrErase(){const t={x:this.mouse.wx,y:this.mouse.wy};for(let i=this.buildings.length-1;i>=0;i--){const e=this.buildings[i];if(e.kind!=="hq"&&t.x>=e.x&&t.x<=e.x+e.w&&t.y>=e.y&&t.y<=e.y+e.h){this.evictColonistsFrom(e),this.buildings.splice(i,1),this.msg("Building removed"),this.rebuildNavGrid();return}}this.selectedBuild=null,this.toast("Build canceled")}evictColonistsFrom(t){const i=t.x+t.w/2,e=t.y+t.h/2;for(const n of this.colonists)if(n.inside===t){this.leaveBuilding(n),n.safeTarget=null,n.safeTimer=0;const l=Math.random()*Math.PI*2,r=(t.w/2+10)*Math.cos(l),h=(t.h/2+10)*Math.sin(l);n.x=U(i+r,0,T.w),n.y=U(e+h,0,T.h)}}buildingCapacity(t){return t.kind==="hq"?8:t.kind==="house"?3:1}buildingHasSpace(t){const i=this.buildingCapacity(t);return(this.insideCounts.get(t)||0)<i}tryEnterBuilding(t,i){return!i.done||!this.buildingHasSpace(i)?!1:(this.insideCounts.set(i,(this.insideCounts.get(i)||0)+1),t.inside=i,t.hideTimer=0,!0)}leaveBuilding(t){const i=t.inside;if(i){const e=(this.insideCounts.get(i)||1)-1;e<=0?this.insideCounts.delete(i):this.insideCounts.set(i,e)}t.inside=null,t.hideTimer=0}getMaxCrew(t){const i=t.w/y*(t.h/y);return i<=1?1:i<=4?2:3}releaseBuildReservation(t){if(!t.reservedBuildFor)return;const i=t.reservedBuildFor,e=(this.buildReservations.get(i)||1)-1;e<=0?this.buildReservations.delete(i):this.buildReservations.set(i,e),t.reservedBuildFor=null}clearPath(t){t.path=void 0,t.pathIndex=void 0,t.repath=0}setTask(t,i,e){if(t.target&&t.target.type&&this.assignedTargets.has(t.target)&&this.assignedTargets.delete(t.target),t.reservedBuildFor&&t.reservedBuildFor!==e&&this.releaseBuildReservation(t),t.task=i,t.target=e,this.clearPath(t),e&&e.type&&(e.type==="tree"||e.type==="rock")&&this.assignedTargets.add(e),i==="build"&&e&&e.w!=null&&!t.reservedBuildFor){const n=e,l=this.buildReservations.get(n)||0,r=this.getMaxCrew(n);l<r&&(this.buildReservations.set(n,l+1),t.reservedBuildFor=n)}}pickTask(t){let i=null,e=1/0;for(const h of this.buildings){if(h.done||(this.buildReservations.get(h)||0)>=this.getMaxCrew(h))continue;const f=F({x:t.x,y:t.y},this.centerOf(h));f<e&&(e=f,i=h)}if(i){this.setTask(t,"build",i);return}const n=this.buildings.find(h=>h.kind==="farm"&&h.done&&h.ready);if(n){this.setTask(t,"harvestFarm",n);return}if(Math.random()<.1){const h=this.buildings.find(o=>o.kind==="well"&&o.done);if(h){this.setTask(t,"harvestWell",h);return}}if(this.RES.food<Math.max(4,this.colonists.length*2)){const h=this.nearestCircle({x:t.x,y:t.y},this.trees.filter(o=>!this.assignedTargets.has(o)));if(h){this.setTask(t,"chop",h);return}}const l=this.trees.filter(h=>!this.assignedTargets.has(h)),r=this.rocks.filter(h=>!this.assignedTargets.has(h));if(Math.random()<.05&&console.log(`Task assignment: wood=${this.RES.wood}, stone=${this.RES.stone}, trees=${l.length}, rocks=${r.length}`),this.RES.wood<this.RES.stone){const h=this.nearestCircle({x:t.x,y:t.y},l);if(h){Math.random()<.1&&console.log("Assigning chop task"),this.setTask(t,"chop",h);return}else Math.random()<.1&&console.log("No trees available for chopping")}else{const h=this.nearestCircle({x:t.x,y:t.y},r);if(h){Math.random()<.1&&console.log("Assigning mine task to rock at:",h),this.setTask(t,"mine",h);return}else Math.random()<.1&&console.log("No rocks available for mining")}Math.random()<.1&&console.log("Assigning idle task"),this.setTask(t,"idle",{x:t.x+Y(-80,80),y:t.y+Y(-80,80)})}nearestCircle(t,i){let e=null,n=1e9;for(const l of i){const r=F(t,l);r<n&&(n=r,e=l)}return e}moveAlongPath(t,i,e,n=10){t.repath=(t.repath||0)-i;const l=e&&(!t.pathGoal||Math.hypot(t.pathGoal.x-e.x,t.pathGoal.y-e.y)>24);if(e&&(l||t.repath==null||t.repath<=0||!t.path||t.pathIndex==null)){const x=this.computePath(t.x,t.y,e.x,e.y);if(x&&x.length){if(t.path=x,t.pathIndex=0,t.pathGoal={x:e.x,y:e.y},Math.random()<.1){let u=0;for(const m of x){const g=Math.floor(m.x/y),w=Math.floor(m.y/y);if(g>=0&&w>=0&&g<this.grid.cols&&w<this.grid.rows){const k=w*this.grid.cols+g;this.grid.cost[k]<=.7&&u++}}u>0&&console.log(`Computed path with ${u}/${x.length} low-cost tiles`)}}else Math.random()<.05&&console.log(`Failed to compute path from (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) to (${e.x.toFixed(1)}, ${e.y.toFixed(1)})`);t.repath=5}if(!t.path||t.pathIndex==null||t.pathIndex>=t.path.length)return e?Math.hypot(t.x-e.x,t.y-e.y)<=n:!1;const r=t.path[t.pathIndex],h=r.x-t.x,o=r.y-t.y;let f=Math.hypot(h,o);const c=15,a=6;let d=t.speed*(t.fatigueSlow||1);{const x=Math.floor(t.x/y),u=Math.floor(t.y/y);if(x>=0&&u>=0&&x<this.grid.cols&&u<this.grid.rows){const g=u*this.grid.cols+x;this.grid.cost[g]<=.7&&(d+=25,Math.random()<.01&&console.log(`Colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) on path tile - cost: ${this.grid.cost[g]}, speed: ${d}`))}}const p=d*i;if(f<=Math.max(c,p))return t.x=r.x,t.y=r.y,t.pathIndex++,t.jitterScore=0,t.jitterWindow=0,t.lastDistToNode=void 0,t.lastDistSign=void 0,t.pathIndex>=t.path.length?(t.path=void 0,t.pathIndex=void 0,e?Math.hypot(t.x-e.x,t.y-e.y)<=n:!0):!1;if(t.jitterWindow=(t.jitterWindow||0)+i,t.lastDistToNode!=null){const x=f-t.lastDistToNode,u=x===0?0:x>0?1:-1,m=t.lastDistSign??u;u!==0&&m!==0&&u!==m&&f<c+15?t.jitterScore=(t.jitterScore||0)+1:t.jitterScore=Math.max(0,(t.jitterScore||0)-1),t.lastDistSign=u}if(t.lastDistToNode=f,(t.jitterScore||0)>=8||(t.jitterWindow||0)>3){if(f<c+a)t.pathIndex++;else if(e){const x=this.computePath(t.x,t.y,e.x,e.y);x&&x.length&&(t.path=x,t.pathIndex=0)}if(t.jitterScore=0,t.jitterWindow=0,t.lastDistToNode=void 0,t.lastDistSign=void 0,!t.path||t.pathIndex==null||t.pathIndex>=t.path.length)return!1}return t.x=Math.max(0,Math.min(t.x+h/(f||1)*p,T.w)),t.y=Math.max(0,Math.min(t.y+o/(f||1)*p,T.h)),!1}findSafeTurret(t,i){let e=null,n=1/0;for(const l of this.buildings){if(l.kind!=="turret"||!l.done)continue;const r=this.centerOf(l),h=Math.hypot(t.x-r.x,t.y-r.y),o=Math.hypot(i.x-r.x,i.y-r.y),f=l.range||160,c=o<f?100:0,a=h+c;a<n&&(n=a,e=l)}return e}isProtectedByTurret(t){const i=this.centerOf(t);for(const e of this.buildings){if(e.kind!=="turret"||!e.done)continue;const n=e.range||120,l=this.centerOf(e);if(F(i,l)<n*n)return!0}return!1}centerOf(t){return{x:t.x+t.w/2,y:t.y+t.h/2}}pointInRect(t,i){return t.x>=i.x&&t.x<=i.x+i.w&&t.y>=i.y&&t.y<=i.y+i.h}updateTurret(t,i){if(!("range"in t)||!t.range)return;t.cooldown=Math.max(0,(t.cooldown||0)-i);let e=null,n=1e9;const l=this.centerOf(t);for(const r of this.enemies){const h=F(r,l);h<t.range*t.range&&h<n&&(n=h,e=r)}e&&(t.cooldown||0)<=0&&(e.hp-=t.dps||0,this.bullets.push({x:l.x,y:l.y,tx:e.x,ty:e.y,t:.12}),t.cooldown=t.fireRate||.6)}isNight(){return this.tDay>=Tt.start||this.tDay<=Tt.end}spawnWave(){const t=4+Math.floor(this.day*1.3);for(let i=0;i<t;i++)this.spawnEnemy();this.msg(`Night ${this.day}: Enemies incoming!`,"warn")}nextDay(){this.day++,this.waveSpawnedForDay=!1;let t=0;for(let n=0;n<this.colonists.length;n++)this.RES.food>0?this.RES.food-=1:(t++,this.colonists[n]&&(this.colonists[n].alive=!1));t>0&&(this.colonists=this.colonists.filter(n=>n.alive),this.msg(`${t} colonist(s) starved`,"bad"));for(const n of this.buildings)n.kind==="farm"&&n.done&&(n.growth=(n.growth||0)+.5,(n.growth||0)>=(n.growTime||1)&&(n.ready=!0));const i=this.buildings.find(n=>n.kind==="tent"&&n.done),e=(this.buildings.find(n=>n.kind==="hq")?3:0)+this.buildings.filter(n=>n.kind==="house"&&n.done).reduce((n,l)=>n+(l.popCap||0),0);i&&this.colonists.length<e&&this.RES.food>=15&&(this.RES.food-=15,this.spawnColonist({x:z.x+Y(-20,20),y:z.y+Y(-20,20)}),this.msg("A new colonist joined! (-15 food)","info")),this.day>8&&this.win()}dayTick(t){const i=this.isNight();this.tDay+=t*this.fastForward/this.dayLength,this.tDay>=1&&(this.tDay-=1,this.nextDay());const e=this.isNight();!i&&e&&this.spawnWave(),this.prevIsNight=e;for(let n=this.colonists.length-1;n>=0;n--){const l=this.colonists[n];if(!l.alive){this.colonists.splice(n,1);continue}l.hp<=0&&(l.alive=!1)}}keyPressed(t){return this.once.has(t)?(this.once.delete(t),!0):!1}update(t){if(this.keyPressed(" ")){this.paused=!this.paused;const e=document.getElementById("btnPause");e&&(e.textContent=this.paused?"Resume":"Pause")}if(this.keyPressed("h")){const e=document.getElementById("help");e&&(e.hidden=!e.hidden)}this.keyPressed("b")&&(this.showBuildMenu=!this.showBuildMenu),this.keyPressed("g")&&(this.debug.nav=!this.debug.nav,this.toast(this.debug.nav?"Debug: nav ON":"Debug: nav OFF")),this.keyPressed("j")&&(this.debug.colonists=!this.debug.colonists,this.toast(this.debug.colonists?"Debug: colonists ON":"Debug: colonists OFF")),this.keyPressed("escape")&&(this.showBuildMenu?this.showBuildMenu=!1:(this.selectedBuild=null,this.toast("Build canceled"),this.selColonist=null,this.follow=!1)),this.keyPressed("f")&&(this.fastForward=this.fastForward===1?6:1,this.toast(this.fastForward>1?"Fast-forward ON":"Fast-forward OFF"));const i=360*t/this.camera.zoom;if(this.keyState.w&&(this.camera.y-=i),this.keyState.s&&(this.camera.y+=i),this.keyState.a&&(this.camera.x-=i),this.keyState.d&&(this.camera.x+=i),(this.keyState["+"]||this.keyState["="])&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*1.02))),(this.keyState["-"]||this.keyState._)&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom/1.02))),!this.paused){for(const[e,n]of this.hotbar.entries())this.keyPressed(String(e+1))&&(this.selectedBuild=n,this.toast("Selected: "+W[n].name));if(this.follow&&this.selColonist){const e=this.selColonist,n=this.canvas.width/this.camera.zoom,l=this.canvas.height/this.camera.zoom;this.camera.x=U(e.x-n/2,0,Math.max(0,T.w-n)),this.camera.y=U(e.y-l/2,0,Math.max(0,T.h-l))}this.dayTick(t);for(const e of this.colonists)e.alive&&we(this,e,t*this.fastForward);for(let e=this.enemies.length-1;e>=0;e--){const n=this.enemies[e];ke(this,n,t*this.fastForward),n.hp<=0&&(this.enemies.splice(e,1),Math.random()<.5&&(this.RES.food+=1))}for(const e of this.buildings){if(e.kind==="turret"&&e.done&&this.updateTurret(e,t*this.fastForward),e.healRate&&e.done){const n=e.healRate,l=e.healRange||120,r=this.centerOf(e);for(const h of this.colonists){if(!h.alive)continue;(h.x-r.x)*(h.x-r.x)+(h.y-r.y)*(h.y-r.y)<l*l&&(h.hp=Math.min(100,h.hp+n*t*this.fastForward))}}if(e.kind==="tent"&&e.done&&(e.cooldown=(e.cooldown||0)-t*this.fastForward,e.cooldown<=0&&this.RES.food>=15)){const n=this.getPopulationCap(),l=this.colonists.filter(f=>f.alive).length,r=Math.max(25,l*8),h=15,o=r+h;if(this.colonists.length<n&&this.RES.food>=o){this.RES.food-=15;const f=this.centerOf(e);this.spawnColonist({x:f.x+(Math.random()-.5)*40,y:f.y+(Math.random()-.5)*40}),this.msg("Recruit tent attracted a new colonist! (-15 food)","good"),e.cooldown=60}else this.RES.food<o&&this.RES.food>=15&&Math.random()<.02&&this.msg(`Recruitment halted: need ${o} food (${r} reserves + ${h} cost), have ${this.RES.food}`,"warn")}}this.tryRespawn(t);for(let e=this.bullets.length-1;e>=0;e--){const n=this.bullets[e];n.t-=t,n.t<=0&&this.bullets.splice(e,1)}for(let e=this.messages.length-1;e>=0;e--){const n=this.messages[e];n.t-=t,n.t<=0&&this.messages.splice(e,1)}}}draw(){var h;const{ctx:t}=this;he(t,this.canvas),t.save(),re(t,this.camera),ce(t);for(const o of this.trees)wt(t,o.x,o.y,o.r,D.tree);for(const o of this.rocks)wt(t,o.x,o.y,o.r,D.rock);for(const o of this.buildings)if(ue(t,o),(o.kind==="house"||o.kind==="hq")&&this.buildings.some(c=>c.kind==="turret"&&c.done&&F(this.centerOf(o),this.centerOf(c))<(c.range||120)*(c.range||120))){const c=this.centerOf(o);fe(t,c.x,o.y-8,12,"#60a5fa")}{const o=new Map;for(const f of this.colonists)f.inside&&f.alive&&o.set(f.inside,(o.get(f.inside)||0)+1);t.save();for(const[f,c]of o){if(!c)continue;const a=8,d=Math.min(c,a),p=10,x=4,u=d*(p+x)-x;let m=f.x+f.w/2-u/2+p/2;const g=f.y+f.h+8,w=this.colonists.filter(k=>k.inside===f);for(let k=0;k<d;k++){const M=w[k%w.length],v=M?M.hp:100,C=v>66?"#22c55e":v>33?"#eab308":"#ef4444";Bt(t,m+k*(p+x),g,10,C)}if(c>a){const k=c-a,M=m+d*(p+x)+6;t.fillStyle="#dbeafe",t.font="600 11px system-ui,Segoe UI,Roboto",t.fillText("+"+k,M,g+4)}}t.restore()}for(const o of this.colonists)!o.inside&&o.alive&&wt(t,o.x,o.y,o.r,this.selColonist===o?"#93c5fd":D.colonist);if(this.debug.nav){t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444";for(let o=0;o<this.grid.rows;o++)for(let f=0;f<this.grid.cols;f++)this.grid.solid[o*this.grid.cols+f]&&t.fillRect(f*y,o*y,y,y);t.restore(),t.save(),t.globalAlpha=.12;for(let o=0;o<this.grid.rows;o++)for(let f=0;f<this.grid.cols;f++){const c=o*this.grid.cols+f;if(!this.grid.solid[c]){const a=this.grid.cost[c];a<=.7?t.fillStyle="#22c55e":a<=1?t.fillStyle="#eab308":t.fillStyle="#f97316",t.fillRect(f*y,o*y,y,y)}}t.restore(),t.save(),t.strokeStyle="#22d3ee",t.lineWidth=2;for(const o of this.colonists)if(!(!o.alive||!o.path||!o.path.length)){t.beginPath(),t.moveTo(o.x,o.y);for(let f=o.pathIndex??0;f<o.path.length;f++){const c=o.path[f];t.lineTo(c.x,c.y)}if(t.stroke(),o.pathIndex!=null&&o.pathIndex<o.path.length){const f=o.path[o.pathIndex];t.save(),t.fillStyle="#fbbf24",t.beginPath(),t.arc(f.x,f.y,6,0,Math.PI*2),t.fill(),t.restore()}}t.restore(),t.save(),t.font="11px monospace",t.fillStyle="#ffffff",t.strokeStyle="#000000",t.lineWidth=2;for(const o of this.colonists){if(o.inside||!o.alive)continue;const f=`${o.task||o.state||"idle"}`,c=o.x-20,a=o.y-o.r-8;if(t.strokeText(f,c,a),t.fillText(f,c,a),o.target&&o.target.x!=null){const d=o.target;t.save(),t.strokeStyle="#94a3b8",t.lineWidth=1,t.setLineDash([3,3]),t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(d.x,d.y),t.stroke(),t.setLineDash([]),t.restore()}}t.restore()}if(this.debug.colonists){t.save(),t.font="10px monospace",t.lineWidth=1;for(const o of this.colonists){if(o.inside||!o.alive)continue;const f=o.x-35;let c=o.y-o.r-45;const a=12,d=[`State: ${o.state||"unknown"}`,`Task: ${o.task||"none"}`,`HP: ${Math.floor(o.hp||0)}`,`Pos: ${Math.floor(o.x)},${Math.floor(o.y)}`,`Speed: ${(()=>{let u=o.speed||0;o.fatigueSlow&&(u*=o.fatigueSlow);const m=Math.floor(o.x/y),g=Math.floor(o.y/y);if(m>=0&&g>=0&&m<this.grid.cols&&g<this.grid.rows){const w=g*this.grid.cols+m;this.grid.cost[w]<=.7&&(u+=25)}return u.toFixed(1)})()}`,`Stuck: ${o.stuckTimer?o.stuckTimer.toFixed(1)+"s":"no"}`,`Since: ${o.stateSince?o.stateSince.toFixed(1)+"s":"0s"}`,`PathIdx: ${o.pathIndex??"none"}/${((h=o.path)==null?void 0:h.length)??0}`,`Jitter: ${o.jitterScore??0}`,`Repath: ${o.repath?o.repath.toFixed(1)+"s":"none"}`];if(o.target){const u=o.target;u.x!=null&&(d.push(`Target: ${Math.floor(u.x)},${Math.floor(u.y)}`),u.type&&d.push(`Type: ${u.type}`),u.hp!=null&&d.push(`T.HP: ${Math.floor(u.hp)}`))}const p=140,x=d.length*a+4;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(f-2,c-a+2,p,x),t.strokeStyle="#444",t.strokeRect(f-2,c-a+2,p,x);for(let u=0;u<d.length;u++){const m=d[u];t.fillStyle="#ffffff",t.strokeStyle="#000000",t.lineWidth=2,t.strokeText(m,f,c+u*a),t.fillText(m,f,c+u*a)}if(t.strokeStyle="#ff6b6b",t.lineWidth=1,t.globalAlpha=.3,t.beginPath(),t.arc(o.x,o.y,o.r,0,Math.PI*2),t.stroke(),t.globalAlpha=1,o.target&&o.task&&(o.task==="chop"||o.task==="mine")){const u=o.target;if(u.x!=null&&u.r!=null){const m=u.r+o.r+4+2.5;t.strokeStyle="#22c55e",t.lineWidth=2,t.globalAlpha=.4,t.beginPath(),t.arc(u.x,u.y,m,0,Math.PI*2),t.stroke(),t.globalAlpha=1;const g=Math.hypot(o.x-u.x,o.y-u.y);t.fillStyle=g<=m?"#22c55e":"#ff6b6b",t.font="12px monospace";const w=(o.x+u.x)/2,k=(o.y+u.y)/2;t.strokeText(`${g.toFixed(1)}`,w-15,k),t.fillText(`${g.toFixed(1)}`,w-15,k)}}}t.restore()}for(const o of this.enemies)de(t,o.x,o.y,o.r+2,3,D.enemy,-Math.PI/2);if(ye(t,this.bullets),this.isNight()&&(t.fillStyle="rgba(6,10,18, 0.58)",t.fillRect(0,0,T.w,T.h)),this.selectedBuild&&!this.pendingPlacement){const o=W[this.selectedBuild],f=Math.floor(this.mouse.wx/y)*y,c=Math.floor(this.mouse.wy/y)*y,a=this.canPlace({...o,size:o.size},f,c)&&ft(this.RES,o.cost);t.globalAlpha=.6,t.fillStyle=a?D.ghost:"#ff6b6b88",t.fillRect(f,c,o.size.w*y,o.size.h*y),t.globalAlpha=1}if(this.mouse.rdown&&this.eraseDragStart){const o=Math.min(this.eraseDragStart.x,this.mouse.wx),f=Math.min(this.eraseDragStart.y,this.mouse.wy),c=Math.abs(this.mouse.wx-this.eraseDragStart.x),a=Math.abs(this.mouse.wy-this.eraseDragStart.y);t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444",t.fillRect(o,f,c,a),t.globalAlpha=1,t.strokeStyle="#ef4444",t.setLineDash([6,4]),t.strokeRect(o+.5,f+.5,c-1,a-1),t.setLineDash([]),t.restore()}t.restore();const i=this.getPopulationCap(),e=this.colonists.filter(o=>!!o.inside).length,n=this.RES.wood+this.RES.stone+this.RES.food,l=this.getStorageCapacity(),r=this.hotbar.map(o=>({key:String(o),name:W[o].name,cost:this.costText(W[o].cost||{}),selected:this.selectedBuild===o}));ge(this.ctx,this.canvas,{res:this.RES,colonists:this.colonists.filter(o=>o.alive).length,cap:i,hiding:e,day:this.day,tDay:this.tDay,isNight:this.isNight(),hotbar:r,messages:this.messages,storage:{used:n,max:l}},this),this.selColonist?this.drawColonistProfile(this.selColonist):this.colonistPanelRect=this.colonistPanelCloseRect=null,this.showBuildMenu&&this.drawBuildMenu(),this.pendingPlacement&&this.drawPlacementUI()}costText(t){const i=[];return t.wood&&i.push(`${t.wood}w`),t.stone&&i.push(`${t.stone}s`),t.food&&i.push(`${t.food}f`),i.join(" ")}win(){this.paused=!0,this.msg("You survived! Day 8 reached.","good"),alert("You survived to Day 8 — victory!")}lose(){this.paused=!0,this.msg("HQ destroyed. Colony fell.","bad"),alert("Your HQ was destroyed. Game over.")}rebuildNavGrid(){Jt(this.grid);for(const t of this.buildings)if(t.kind!=="hq"&&t.kind!=="path"&&t.kind!=="house"&&Zt(this.grid,t.x,t.y,t.w,t.h),t.kind==="path"&&Ct(this.grid,t.x,t.y,t.w,t.h,"BASIC_PATH"),t.kind==="house"&&t.done){const i=t.x+t.w/2-y/2,e=t.y+t.h;Ct(this.grid,i,e,y,y,"FAST_ROAD")}for(const t of this.trees)Rt(this.grid,t.x,t.y,t.r);for(const t of this.rocks)Rt(this.grid,t.x,t.y,t.r)}computePath(t,i,e,n){return se(this.grid,t,i,e,n)}cellIndexAt(t,i){const e=Math.floor(t/y),n=Math.floor(i/y);return e<0||n<0||e>=this.grid.cols||n>=this.grid.rows?-1:n*this.grid.cols+e}isBlocked(t,i){const e=this.cellIndexAt(t,i);return e<0?!0:!!this.grid.solid[e]}isWithinInteractionRange(t,i,e,n){const l=t-e.x,r=i-e.y;return Math.hypot(l,r)<=e.r+n}bestApproachToCircle(t,i,e){const l=new Set,r=[],h=Math.max(6,i.r+e-2),o=Math.atan2(i.y-t.y,i.x-t.x),f=[];for(let u=0;u<16;u++){const m=(u%2?1:-1)*Math.ceil(u/2);f.push(m/16*Math.PI*2+o)}for(const u of f){const m=i.x+Math.cos(u)*h,g=i.y+Math.sin(u)*h,w=Math.floor(m/y),k=Math.floor(g/y);if(w<0||k<0||w>=this.grid.cols||k>=this.grid.rows)continue;const M=w*y+y/2,v=k*y+y/2,C=`${w},${k}`;l.has(C)||(l.add(C),!this.isBlocked(M,v)&&r.push({x:M,y:v,gx:w,gy:k}))}if(r.length===0){const u=Math.atan2(t.y-i.y,t.x-i.x),m=i.r+e,g=Math.max(4,y*.33);for(let w=m;w>=Math.max(i.r+2,m-6*y);w-=g){const k=i.x+Math.cos(u)*w,M=i.y+Math.sin(u)*w,v=Math.floor(k/y),C=Math.floor(M/y);if(v<0||C<0||v>=this.grid.cols||C>=this.grid.rows)continue;const A=v*y+y/2,R=C*y+y/2;if(this.isBlocked(A,R))continue;if(this.computePath(t.x,t.y,A,R))return{x:A,y:R}}return{x:i.x+Math.cos(u)*m,y:i.y+Math.sin(u)*m}}let c=null,a=1/0,d=1/0,p=0;const x=8;for(const u of r){if(p>=x)break;const m=this.computePath(t.x,t.y,u.x,u.y);if(!m||m.length===0)continue;p++;let g=0;for(const k of m){const M=this.cellIndexAt(k.x,k.y);if(M<0){g=1/0;break}g+=this.grid.cost[M]||1}if(g===1/0)continue;const w=this.cellIndexAt(u.x,u.y);if(w>=0&&this.grid.cost[w]<=.7&&(g-=.05),m.length<=3&&g<=2)return Math.random()<.02&&console.log(`Early-out: great path found with length ${m.length} and cost ${g.toFixed(3)}`),u;(g<d||g===d&&m.length<a)&&(d=g,a=m.length,c=u)}return c?(Math.random()<.02&&console.log(`Best approach: (${c.x.toFixed(1)}, ${c.y.toFixed(1)}) with path cost ${d.toFixed(3)} and length ${a} (evaluated ${p} candidates)`),c):r[0]}drawColonistProfile(t){const i=this.ctx,e=this.canvas.width,n=this.canvas.height,l=Math.min(this.scale(320),e*.4),r=Math.min(this.scale(200),n*.35),h=this.scale(12),o=e-l-h,f=this.scale(54),c=Math.min(f,n-r-h);i.save(),i.fillStyle="#0b1220cc",i.fillRect(o,c,l,r),i.strokeStyle="#1e293b",i.strokeRect(o+.5,c+.5,l-1,r-1);const a=this.scale(26),d=this.scale(8),p=o+l-d-a,x=c+d;i.fillStyle="#0f172a",i.fillRect(p,x,a,a),i.strokeStyle="#1e293b",i.strokeRect(p+.5,x+.5,a-1,a-1),i.fillStyle="#dbeafe",i.font=this.getScaledFont(16,"700"),i.textAlign="center",i.textBaseline="middle",i.fillText("✕",p+a/2,x+a/2+this.scale(1));const u=this.scale(64),m=o+this.scale(18),g=c+this.scale(26);i.fillStyle="#0f172a",i.fillRect(m,g,u,u),i.strokeStyle="#1e293b",i.strokeRect(m+.5,g+.5,u-1,u-1),i.save(),i.translate(m+u/2,g+u/2+this.scale(4)),i.scale(this.uiScale*2,this.uiScale*2),Bt(i,0,0,10,"#93c5fd"),i.restore(),i.fillStyle="#dbeafe",i.font=this.getScaledFont(14,"600"),i.fillText("Colonist",o+u+this.scale(32),c+this.scale(22)),i.font=this.getScaledFont(13);const w=t.inside?"Resting":t.task?t.task:"Idle",k=Math.max(0,Math.min(100,t.hp|0)),M=Math.max(0,Math.min(100,(t.fatigue||0)|0)),v=Math.max(0,Math.min(100,(t.hunger||0)|0)),C=o+u+this.scale(32);let A=c+this.scale(45);const R=this.scale(24);this.barRow(C,A,"Health",k,"#22c55e"),A+=R,this.barRow(C,A,"Tiredness",M,"#eab308"),A+=R,this.barRow(C,A,"Hunger",v,"#f87171"),A+=R,i.fillStyle="#9fb3c8",i.fillText(`Task: ${w}`,C,A+this.scale(12)),A+=this.scale(18),i.fillText(`Pos: ${t.x|0}, ${t.y|0}`,C,A),A+=this.scale(18),i.fillText(this.follow?"Camera: Following (Esc to stop)":"Camera: Click colonist to follow",C,Math.min(A,c+r-this.scale(8))),this.colonistPanelRect={x:o,y:c,w:l,h:r},this.colonistPanelCloseRect={x:p,y:x,w:a,h:a},i.restore()}barRow(t,i,e,n,l){const r=this.ctx;r.fillStyle="#dbeafe",r.fillText(e,t,i);const h=this.scale(140),o=this.scale(10),f=this.scale(70);r.fillStyle="#0f172a",r.fillRect(t+f,i-this.scale(8),h,o),r.strokeStyle="#1e293b",r.strokeRect(t+f+.5,i-this.scale(8)+.5,h-1,o-1),r.fillStyle=l,r.fillRect(t+f+this.scale(2),i-this.scale(6),Math.max(0,Math.min(h-this.scale(4),n/100*(h-this.scale(4)))),o-this.scale(4))}drawBuildMenu(){const t=this.ctx,i=this.canvas.width,e=this.canvas.height,n=this.isTouch?980:860,l=this.isTouch?720:620,r=this.isTouch?28:40,h=this.isTouch?60:80,o=Math.min(this.scale(n),i-this.scale(r)),f=Math.min(this.scale(l),e-this.scale(h)),c=(i-o)/2,a=(e-f)/2;t.save(),t.fillStyle="#0b1628dd",t.fillRect(c,a,o,f),t.strokeStyle="#1e293b",t.strokeRect(c+.5,a+.5,o-1,f-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(this.isTouch?22:18,"600"),t.fillText("Build Menu (B to close)",c+this.scale(14),a+this.scale(24));const d=ie(W),p=Object.keys(d),x=this.scale(this.isTouch?36:28),u=Math.floor((o-x)/Math.max(1,p.length));this.menuRects=[];let m=null;for(let k=0;k<p.length;k++){const M=c+this.scale(12)+k*u;let v=a+this.scale(50);const C=p[k];t.fillStyle="#93c5fd",t.font=this.getScaledFont(this.isTouch?18:15,"600"),t.fillText(C,M,v),v+=this.scale(this.isTouch?12:8);const A=d[C];for(const[R,O]of A){v+=this.scale(this.isTouch?12:8);const S=this.scale(this.isTouch?78:58),E=u-this.scale(18),P=M,N=v,Q=this.mouse.x*this.DPR,L=this.mouse.y*this.DPR,B=Q>=P&&Q<=P+E&&L>=N&&L<=N+S;t.fillStyle=this.selectedBuild===R?"#102034":B?"#1a1f2e":"#0f172a",t.fillRect(P,N,E,S),t.strokeStyle=this.selectedBuild===R?"#4b9fff":B?"#3b82f6":"#1e293b",t.strokeRect(P+.5,N+.5,E-1,S-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(this.isTouch?18:15,"600"),t.fillText(O.name,P+this.scale(10),N+this.scale(this.isTouch?22:18));const I=this.costText(O.cost||{});t.fillStyle="#9fb3c8",t.font=this.getScaledFont(this.isTouch?14:12);const X=Math.min(this.scale(this.isTouch?120:100),t.measureText(I).width+this.scale(4));if(t.fillText(I,P+E-X,N+this.scale(this.isTouch?22:18)),O.description){t.fillStyle="#94a3b8",t.font=this.getScaledFont(this.isTouch?14:12);const Z=E-this.scale(18);let H=O.description;for(;t.measureText(H).width>Z&&H.length>10;)H=H.substring(0,H.length-4)+"...";t.fillText(H,P+this.scale(10),N+this.scale(this.isTouch?46:36))}if(B&&O.description&&(m={key:R,desc:O.description}),this.menuRects.push({key:R,x:P,y:N,w:E,h:S}),v+=S,v>a+f-this.scale(this.isTouch?90:70))break}}if(m){const k=this.scale(this.isTouch?16:14),M=this.scale(this.isTouch?420:360);t.font=this.getScaledFont(this.isTouch?16:14);const v=this.wrapText(m.desc,M-k*2),C=this.scale(this.isTouch?20:18),A=v.length*C+k*2,R=this.mouse.x*this.DPR,O=this.mouse.y*this.DPR;let S=R+this.scale(20),E=O-A-this.scale(10);S+M>i&&(S=R-M-this.scale(20)),E<0&&(E=O+this.scale(20)),t.fillStyle="#0f1419f0",t.fillRect(S,E,M,A),t.strokeStyle="#374151",t.strokeRect(S+.5,E+.5,M-1,A-1),t.fillStyle="#e5e7eb";for(let P=0;P<v.length;P++)t.fillText(v[P],S+k,E+k+(P+1)*C-this.scale(4))}t.fillStyle="#9fb3c8",t.font=this.getScaledFont(this.isTouch?16:14);const g="Click a building to select • Hover for details • Press B to close",w=t.measureText(g).width;t.fillText(g,(i-w)/2,a+f+this.scale(this.isTouch?30:24)),t.restore()}wrapText(t,i){const e=this.ctx,n=t.split(" "),l=[];let r="";for(const h of n){const o=r+(r?" ":"")+h;e.measureText(o).width<=i?r=o:(r&&l.push(r),r=h)}return r&&l.push(r),l}handleBuildMenuClick(){const t=this.mouse.x*this.DPR,i=this.mouse.y*this.DPR;for(const e of this.menuRects)if(t>=e.x&&t<=e.x+e.w&&i>=e.y&&i<=e.y+e.h){this.selectedBuild=e.key,this.showBuildMenu=!1,this.toast("Selected: "+W[e.key].name);return}this.showBuildMenu=!1}drawPlacementUI(){const t=this.pendingPlacement;if(!t)return;const i=W[t.key],e=this.ctx,n=i.size.w*y,l=i.size.h*y,h=((w,k)=>({x:(w-this.camera.x)*this.camera.zoom,y:(k-this.camera.y)*this.camera.zoom}))(t.x,t.y),o=n*this.camera.zoom,f=l*this.camera.zoom;e.save(),e.globalAlpha=.6,e.fillStyle=D.ghost,e.fillRect(h.x,h.y,o,f),e.globalAlpha=1,e.strokeStyle="#4b9fff",e.setLineDash([4,3]),e.strokeRect(h.x+.5,h.y+.5,o-1,f-1),e.setLineDash([]),e.restore();const c=this.scale(10),a=this.scale(38);let d=h.x+o+c,p=h.y;const x=this.canvas.width;d+a*3>x-this.scale(6)&&(d=Math.max(this.scale(6),h.x-c-a*3));const u=(w,k,M)=>({id:w,x:k,y:M,w:a,h:a}),m=[u("up",d+a,p),u("left",d,p+a),u("right",d+a*2,p+a),u("down",d+a,p+a*2),u("cancel",d,p+a*3+this.scale(4)),u("ok",d+a*2,p+a*3+this.scale(4))];this.placeUIRects=m,e.save(),e.fillStyle="#0f172aee",e.strokeStyle="#1e293b";const g=(w,k)=>{e.fillRect(w.x,w.y,w.w,w.h),e.strokeRect(w.x+.5,w.y+.5,w.w-1,w.h-1),e.fillStyle="#dbeafe",e.font=this.getScaledFont(18,"600"),e.textAlign="center",e.textBaseline="middle",e.fillText(k,w.x+w.w/2,w.y+w.h/2+this.scale(2)),e.fillStyle="#0f172aee"};for(const w of m)w.id==="up"?g(w,"↑"):w.id==="down"?g(w,"↓"):w.id==="left"?g(w,"←"):w.id==="right"?g(w,"→"):w.id==="ok"?g(w,"OK"):w.id==="cancel"&&g(w,"X");e.restore()}}const G=document.getElementById("game"),Mt=document.getElementById("btnPause"),be=document.getElementById("btnHelp"),lt=document.getElementById("btnToggleUI"),at=document.getElementById("btnMenu"),q=document.getElementById("headerDropdown"),It=document.getElementById("hd-new"),Et=document.getElementById("hd-help"),Ft=document.getElementById("hd-build"),Dt=document.getElementById("hd-toggle-mobile"),Ae=document.getElementById("btnNew"),J=document.getElementById("help"),bt=document.getElementById("mobileControls"),Wt=document.getElementById("mc-build"),Yt=document.getElementById("mc-cancel"),Ot=document.getElementById("mc-erase"),Nt=document.getElementById("mc-pause"),Lt=document.getElementById("mc-ff"),zt=document.getElementById("mc-zoom-in"),Qt=document.getElementById("mc-zoom-out");J&&(J.innerHTML=`
    <h2>How to play</h2>
    <div><b>Goal:</b> Gather wood & stone, build farms for food, add houses for pop cap; survive nightly raids with turrets/walls.</div>
  <div><b>Controls:</b> 1..9 quick-build, <b>B</b> build menu, LMB place, RMB cancel/erase; WASD pan; Space pause; H toggle help; +/- zoom; F fast-forward.</div>
  <div><b>UI Modes:</b> 📱 Mobile UI shows touch controls for tap/touch gameplay. 🖥️ Desktop UI is clean with keyboard shortcuts only.</div>
  `);async function Se(){const s=G.getContext("2d");s&&(s.fillStyle="#0a0e14",s.fillRect(0,0,G.width,G.height),s.fillStyle="#dbeafe",s.font="24px system-ui",s.textAlign="center",s.fillText("Loading assets...",G.width/2,G.height/2));try{await it.getInstance().loadAssets(),console.log("Assets loaded successfully"),console.log("House image loaded:",!!it.getInstance().getImage("house"))}catch(o){console.warn("Some assets failed to load:",o)}const t=new Me(G);Mt.onclick=()=>{t.paused=!t.paused,Mt.textContent=t.paused?"Resume":"Pause"},Ae.onclick=()=>{t.newGame()},be.onclick=()=>{J&&(J.hidden=!J.hidden)},Object.assign(window,{game:t,BUILD_TYPES:W});const i="ontouchstart"in window||navigator.maxTouchPoints>0;let e=localStorage.getItem("colonyUI_mobileMode"),n=e!==null?e==="true":i;const l=o=>{n=o,window._mobileUI=o,localStorage.setItem("colonyUI_mobileMode",o.toString()),bt&&(bt.hidden=!o,bt.style.display=o?"flex":"none"),at&&(at.hidden=!o),lt&&(lt.textContent=o?"🖥️":"📱",lt.title=o?"Switch to Desktop UI":"Switch to Mobile UI"),t.toast(o?"Mobile UI: ON":"Desktop UI: ON")};lt&&(lt.onclick=()=>{l(!n)}),l(n),document.addEventListener("keydown",o=>{const f=[" ","h","b","f","g","j","escape","w","a","s","d","+","=","-","_"],c=/^[1-9]$/.test(o.key);(f.includes(o.key.toLowerCase())||c)&&document.activeElement&&document.activeElement!==document.body&&document.activeElement.blur()}),at&&q&&(at.onclick=()=>{q.hidden=!q.hidden},It&&(It.onclick=()=>{q.hidden=!0,t.newGame()}),Et&&(Et.onclick=()=>{q.hidden=!0,J&&(J.hidden=!J.hidden)}),Ft&&(Ft.onclick=()=>{q.hidden=!0,t.showBuildMenu=!t.showBuildMenu}),Dt&&(Dt.onclick=()=>{q.hidden=!0,l(!n)}),document.addEventListener("click",o=>{if(!q)return;const f=o.target;f&&!q.contains(f)&&f!==at&&(q.hidden=!0)})),Wt&&(Wt.onclick=()=>{t.showBuildMenu=!t.showBuildMenu}),Yt&&(Yt.onclick=()=>{t.selectedBuild=null,t.toast("Build canceled")}),Ot&&(Ot.onclick=()=>{window._eraseOnce=!0,t.toast("Erase mode: tap on a building to remove")}),Nt&&(Nt.onclick=()=>{t.paused=!t.paused,Mt.textContent=t.paused?"Resume":"Pause"}),Lt&&(Lt.onclick=()=>{t.fastForward=t.fastForward===1?6:1,t.toast(t.fastForward>1?"Fast-forward ON":"Fast-forward OFF")}),zt&&(zt.onclick=()=>{t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom*1.1))}),Qt&&(Qt.onclick=()=>{t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom/1.1))});let r=null,h=null;G.addEventListener("touchstart",o=>{if(o.preventDefault(),o.touches.length===1)h={x:o.touches[0].clientX,y:o.touches[0].clientY};else if(o.touches.length===2){const f=o.touches[0].clientX-o.touches[1].clientX,c=o.touches[0].clientY-o.touches[1].clientY;r=Math.hypot(f,c)}},{passive:!1}),G.addEventListener("touchmove",o=>{if(o.preventDefault(),o.touches.length===1&&h){const f=o.touches[0].clientX,c=o.touches[0].clientY,a=f-h.x,d=c-h.y;h={x:f,y:c},t.camera.x-=a*(1/t.camera.zoom)*t.DPR,t.camera.y-=d*(1/t.camera.zoom)*t.DPR}else if(o.touches.length===2){const f=o.touches[0].clientX-o.touches[1].clientX,c=o.touches[0].clientY-o.touches[1].clientY,a=Math.hypot(f,c);if(r!=null){const d=a/(r||a);t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom*d))}r=a}},{passive:!1}),G.addEventListener("touchend",o=>{o.preventDefault();const f=window._eraseOnce;if(f&&o.changedTouches.length===1){window._eraseOnce=!1;const c=G.getBoundingClientRect(),a=o.changedTouches[0].clientX-c.left,d=o.changedTouches[0].clientY-c.top,p=t.screenToWorld(a,d);for(let x=t.buildings.length-1;x>=0;x--){const u=t.buildings[x];if(u.kind!=="hq"&&p.x>=u.x&&p.x<=u.x+u.w&&p.y>=u.y&&p.y<=u.y+u.h){t.evictColonistsFrom(u),t.buildings.splice(x,1),t.msg("Building removed"),t.rebuildNavGrid();break}}}if(!f&&o.changedTouches.length===1){const c=G.getBoundingClientRect(),a=o.changedTouches[0].clientX-c.left,d=o.changedTouches[0].clientY-c.top;t.handleTapOrClickAtScreen(a,d)}o.touches.length===0&&(h=null,r=null)},{passive:!1})}Se();
