var Et=Object.defineProperty;var It=(o,t,i)=>t in o?Et(o,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[t]=i;var g=(o,t,i)=>It(o,typeof t!="symbol"?t+"":t,i);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function i(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function e(s){if(s.ep)return;s.ep=!0;const l=i(s);fetch(s.href,l)}})();const F=(o,t)=>Math.random()*(t-o)+o,Ft=(o,t)=>Math.floor(F(o,t)),$=(o,t,i)=>Math.max(t,Math.min(i,o)),W=(o,t)=>{const i=o.x-t.x,e=o.y-t.y;return i*i+e*e},Dt=o=>Math.hypot(o.x,o.y),Pt=o=>{const t=Dt(o)||1;return{x:o.x/t,y:o.y/t}},Rt=(o,t)=>({x:o.x-t.x,y:o.y-t.y}),y=32,p={w:240*y,h:240*y},L={x:p.w/2,y:p.h/2},A={sky:"#0a0e14",ground:"#0e161f",colonist:"#c7f9cc",enemy:"#ff9aa2",tree:"#6fbf73",rock:"#9aa5b1",ghost:"#6ee7ff",wall:"#9aa5b1",bld:"#93c5fd",turret:"#93c5fd",farm:"#8bd3dd",house:"#e2b714",stock:"#c084fc",tent:"#f59e0b"},ft={start:.72,end:.07};function Yt(){const o=Math.ceil(p.w/y),t=Math.ceil(p.h/y);return{cols:o,rows:t,solid:new Uint8Array(o*t),cost:new Float32Array(o*t).fill(1)}}function Wt(o){o.solid.fill(0),o.cost.fill(1)}function Ot(o,t,i,e,s){const l=Math.floor(t/y),a=Math.floor(i/y),n=Math.ceil(e/y),h=Math.ceil(s/y);for(let c=0;c<h;c++)for(let r=0;r<n;r++){const f=l+r,d=a+c;f<0||d<0||f>=o.cols||d>=o.rows||(o.solid[d*o.cols+f]=1)}}function Lt(o,t,i,e,s,l){const a=Math.floor(t/y),n=Math.floor(i/y),h=Math.ceil(e/y),c=Math.ceil(s/y);for(let r=0;r<c;r++)for(let f=0;f<h;f++){const d=a+f,u=n+r;if(d<0||u<0||d>=o.cols||u>=o.rows)continue;const w=u*o.cols+d;o.cost[w]=Math.min(o.cost[w],l)}}function ut(o,t,i,e){return Math.abs(o-i)+Math.abs(t-e)}function zt(o,t,i,e,s){const l=o.cols,a=o.rows,n={x:Math.floor(t/y),y:Math.floor(i/y)},h={x:Math.floor(e/y),y:Math.floor(s/y)},c=(x,P)=>P*l+x;if(n.x===h.x&&n.y===h.y)return[{x:e,y:s}];const r=[],f=new Int32Array(l*a).fill(-1),d=new Int32Array(l*a).fill(1e9),u=new Int32Array(l*a).fill(1e9),w=(x,P)=>{const Y=c(x,P);r.push(Y)},v=()=>{let x=0,P=1e9;for(let S=0;S<r.length;S++){const C=u[r[S]];C<P&&(P=C,x=S)}return r.splice(x,1)[0]},M=(x,P)=>x>=0&&P>=0&&x<l&&P<a,B=c(n.x,n.y),m=c(h.x,h.y),k=(x,P)=>{if(!M(x,P))return!1;const Y=c(x,P);return Y===B||Y===m?!0:o.solid[Y]===0};d[B]=0,u[B]=ut(n.x,n.y,h.x,h.y),w(n.x,n.y);const b=[[1,0],[-1,0],[0,1],[0,-1]];for(;r.length;){const x=v(),P=x%l,Y=x/l|0;if(P===h.x&&Y===h.y){let S=[],C=x;for(;C!==-1;){const R=C%l,O=C/l|0;S.push({x:R*y+y/2,y:O*y+y/2}),C=f[C]}S.reverse(),S[S.length-1]={x:e,y:s};const E=[],I=(R,O,Z,j)=>{const V=Z-R,K=j-O,et=Math.hypot(V,K)||1,Q=Math.max(6,y*.33),ct=Math.ceil(et/Q);for(let st=1;st<ct;st++){const dt=st/ct,At=R+V*dt,Ct=O+K*dt,it=Math.floor(At/y),ot=Math.floor(Ct/y);if(it<0||ot<0||it>=o.cols||ot>=o.rows||o.solid[ot*o.cols+it])return!1}return!0};let T=0;for(;T<S.length;){E.push(S[T]);let R=T+2,O=T+1;for(;R<S.length&&I(S[T].x,S[T].y,S[R].x,S[R].y);)O=R,R++;T=O}return E.length>=2&&(S=E),S}for(const[S,C]of b){const E=P+S,I=Y+C;if(!k(E,I))continue;const T=c(E,I),R=o.cost[T]||1,O=d[x]+R;O<d[T]&&(f[T]=x,d[T]=O,u[T]=O+ut(E,I,h.x,h.y),r.includes(T)||r.push(T))}}return null}const D={house:{category:"Housing",name:"House",description:"Provides shelter for 2 colonists. Colonists can rest inside to recover fatigue.",key:"1",cost:{wood:20,stone:5},hp:220,size:{w:2,h:2},build:100,color:A.house,popCap:2},farm:{category:"Production",name:"Farm",description:"Grows crops that colonists can harvest for food. Takes 2 days to grow.",key:"2",cost:{wood:15},hp:120,size:{w:2,h:2},build:80,color:A.farm,growTime:1},turret:{category:"Defense",name:"Turret",description:"Automated defense structure. Shoots at enemies within range.",key:"3",cost:{wood:10,stone:20},hp:160,size:{w:1,h:1},build:120,color:A.turret,range:190,fireRate:.6,dps:30},wall:{category:"Defense",name:"Wall",description:"Blocks enemy movement. Essential for creating defensive perimeters.",key:"4",cost:{wood:5,stone:5},hp:150,size:{w:1,h:1},build:40,color:A.wall},stock:{category:"Utility",name:"Stockpile",description:"Increases resource storage capacity by 100. Colonists will store materials here.",key:"5",cost:{wood:10},hp:140,size:{w:2,h:2},build:60,color:A.stock,storageBonus:100},tent:{category:"Utility",name:"Recruit Tent",description:"Attracts new colonists every 60 seconds. Requires 15 food per recruit.",key:"6",cost:{wood:30,food:10},hp:140,size:{w:2,h:2},build:80,color:A.tent},warehouse:{category:"Utility",name:"Warehouse",description:"Large storage facility. Increases resource capacity by 300.",key:"7",cost:{wood:40,stone:20},hp:260,size:{w:3,h:2},build:160,color:A.stock,storageBonus:300},well:{category:"Production",name:"Well",description:"Provides clean water. Colonists can collect water here for food production.",key:"8",cost:{stone:25},hp:160,size:{w:1,h:1},build:80,color:A.farm},infirmary:{category:"Utility",name:"Infirmary",description:"Heals injured colonists within range. Essential for colony survival.",key:"9",cost:{wood:30,stone:20,food:10},hp:200,size:{w:2,h:2},build:140,color:A.bld,healRate:3,healRange:140},path:{category:"Utility",name:"Path",description:"Improves colonist movement speed by 50%. Cheap way to optimize traffic flow.",key:"0",cost:{wood:1},hp:1,size:{w:1,h:1},build:5,color:"#475569",speedBonus:1.5}};function _(o,t){if(!t)return!0;for(const i of Object.keys(t))if((o[i]||0)<(t[i]||0))return!1;return!0}function nt(o,t){if(t)for(const i of Object.keys(t))o[i]-=t[i]||0}function lt(o,t,i){const e=D[o],s=Math.floor(t/y)*y,l=Math.floor(i/y)*y;return{kind:o,...e,x:s,y:l,w:e.size.w*y,h:e.size.h*y,hp:e.hp,buildLeft:e.build,done:!1,growth:0,ready:!1,cooldown:0}}function Nt(o){const t={};for(const i of Object.keys(o)){const e=o[i],s=e.category||"Other";(t[s]||(t[s]=[])).push([i,e])}for(const i of Object.keys(t))t[i].sort((e,s)=>e[1].name.localeCompare(s[1].name));return t}const Qt="data:image/png;base64,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",q=class q{constructor(){g(this,"images",new Map);g(this,"loaded",!1)}static getInstance(){return q.instance||(q.instance=new q),q.instance}async loadAssets(){const i=[{name:"house",path:Qt}].map(e=>this.loadImage(e.name,e.path));try{await Promise.all(i),this.loaded=!0}catch{console.warn("Some assets failed to load, continuing with fallbacks"),this.loaded=!0}}loadImage(t,i){return new Promise((e,s)=>{const l=new Image;l.onload=()=>{this.images.set(t,l),console.log(`Loaded image: ${t}`),e()},l.onerror=()=>{console.warn(`Failed to load image: ${t} from ${i}`),s(new Error(`Failed to load ${t}`))},l.src=i})}getImage(t){return this.images.get(t)||null}isLoaded(){return this.loaded}};g(q,"instance");let J=q;function Ht(o,t){o.setTransform(1,0,0,1,0,0),o.fillStyle=A.sky,o.fillRect(0,0,t.width,t.height)}function Xt(o,t){o.translate(-t.x*t.zoom,-t.y*t.zoom),o.scale(t.zoom,t.zoom)}function Gt(o){o.fillStyle=A.ground,o.fillRect(0,0,p.w,p.h),o.globalAlpha=.08,o.strokeStyle="#d6e4ff",o.lineWidth=1,o.beginPath();for(let t=0;t<=p.w;t+=y)o.moveTo(t,0),o.lineTo(t,p.h);for(let t=0;t<=p.h;t+=y)o.moveTo(0,t),o.lineTo(p.w,t);o.stroke(),o.globalAlpha=1}function at(o,t,i,e,s){o.fillStyle=s,o.beginPath(),o.arc(t,i,e,0,Math.PI*2),o.fill()}function qt(o,t,i,e,s,l,a=0){o.fillStyle=l,o.beginPath();for(let n=0;n<s;n++){const h=a+n*2*Math.PI/s,c=t+Math.cos(h)*e,r=i+Math.sin(h)*e;n===0?o.moveTo(c,r):o.lineTo(c,r)}o.closePath(),o.fill()}function yt(o,t,i,e=10,s=A.colonist){o.save(),o.translate(t,i);const l="#0b0f14",a=e*.32,n=-e*.3;o.fillStyle=s,o.beginPath(),o.arc(0,n,a,0,Math.PI*2),o.fill(),o.strokeStyle=l,o.lineWidth=1,o.beginPath(),o.arc(0,n,a+.5,0,Math.PI*2),o.stroke();const h=e*.55,c=e*.55,r=-e*.05;o.fillStyle=s,o.beginPath(),o.moveTo(-h/2,r-c/2),o.lineTo(h/2,r-c/2),o.lineTo(h/2,r+c/2),o.lineTo(-h/2,r+c/2),o.closePath(),o.fill(),o.strokeStyle=l,o.stroke();const f=e*.18,d=e*.5,u=r+c/2+d*.1;o.fillStyle=s,o.fillRect(-f-.6,u-d,f,d),o.fillRect(.6,u-d,f,d),o.strokeStyle=l,o.strokeRect(-f-.6,u-d,f,d),o.strokeRect(.6,u-d,f,d),o.restore()}function Ut(o,t,i,e=12,s="#60a5fa"){o.save(),o.translate(t,i),o.fillStyle=s,o.strokeStyle="#0b0f14",o.lineWidth=1,o.beginPath();const l=e,a=e*1.2;o.moveTo(0,-a*.5),o.lineTo(l*.35,-a*.25),o.lineTo(l*.35,a*.1),o.quadraticCurveTo(0,a*.55,-l*.35,a*.1),o.lineTo(-l*.35,-a*.25),o.closePath(),o.fill(),o.stroke(),o.restore()}function $t(o,t){if(t.kind==="path"){o.fillStyle="#1f2937",o.fillRect(t.x,t.y,t.w,t.h),o.strokeStyle="#0b0f14cc",o.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1);return}if(t.kind==="house"){const i=J.getInstance(),e=i.getImage("house");e&&i.isLoaded()?(o.drawImage(e,t.x,t.y,t.w,t.h),o.strokeStyle="#0b0f14cc",o.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1)):(o.fillStyle=t.color,o.fillRect(t.x,t.y,t.w,t.h),o.strokeStyle="#0b0f14cc",o.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1))}else o.fillStyle=t.color,o.fillRect(t.x,t.y,t.w,t.h),o.strokeStyle="#0b0f14cc",o.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1);if(!t.done){o.fillStyle="#0b1220",o.fillRect(t.x,t.y-6,t.w,4),o.fillStyle="#6ee7ff";const i=1-t.buildLeft/t.build;o.fillRect(t.x,t.y-6,i*t.w,4)}if(t.kind!=="house"){o.fillStyle="#0b0f14aa",o.font="bold 12px system-ui";const i=t.x+t.w/2,e=t.y+t.h/2;let s="B";t.kind==="hq"?s="HQ":t.kind==="farm"?s=t.ready?"F*":"F":t.kind==="turret"?s="T":t.kind==="wall"?s="W":t.kind==="stock"?s="S":t.kind==="tent"?s="R":t.kind==="warehouse"?s="WH":t.kind==="well"?s="WL":t.kind==="infirmary"&&(s="I"),o.textAlign="center",o.textBaseline="middle",o.fillText(s,i,e)}if(t.kind==="turret"&&t.range){const i=t.x+t.w/2,e=t.y+t.h/2;o.globalAlpha=.07,o.fillStyle="#e2f3ff",o.beginPath(),o.arc(i,e,t.range,0,Math.PI*2),o.fill(),o.globalAlpha=1}}function jt(o,t){for(const i of t)o.globalAlpha=.8,o.strokeStyle="#e0f2fe",o.lineWidth=2,o.beginPath(),o.moveTo(i.x,i.y),o.lineTo(i.tx,i.ty),o.stroke(),o.globalAlpha=1}function Vt(o,t,i,e){e.uiScale;const s=e.scale(e.isTouch?14:10),l=e.scale(e.isTouch?56:44),a=t.width;o.fillStyle="#0b122088",o.fillRect(0,0,a,l),o.strokeStyle="#1e293b",o.lineWidth=1,o.strokeRect(0,.5,a,l),o.fillStyle="#dbeafe",o.font=e.getScaledFont(e.isTouch?18:16,"600");let n=s;const h=Math.max(e.scale(e.isTouch?170:130),Math.min(e.scale(e.isTouch?260:220),Math.round(t.width*.14)));if(X(o,n,e.scale(12),`Wood: ${Math.floor(i.res.wood)}`,"#b08968",e),n+=h,X(o,n,e.scale(12),`Stone: ${Math.floor(i.res.stone)}`,"#9aa5b1",e),n+=Math.max(h,e.scale(e.isTouch?220:180)),X(o,n,e.scale(12),`Food: ${Math.floor(i.res.food)}`,"#9ae6b4",e),n+=h,i.storage){const M=Math.floor(i.storage.used/i.storage.max*100),B=M>90?"#ef4444":M>70?"#eab308":"#22c55e";X(o,n,e.scale(12),`Storage: ${Math.floor(i.storage.used)}/${i.storage.max} (${M}%)`,B,e),n+=Math.max(h,e.scale(e.isTouch?260:200))}const c=`Colonists: ${i.colonists}/${i.cap}`;X(o,n,e.scale(12),c,"#93c5fd",e),n+=Math.max(h,e.scale(e.isTouch?260:210));const r=`Hiding: ${i.hiding}`;X(o,n,e.scale(12),r,"#60a5fa",e),n+=Math.max(e.scale(e.isTouch?180:140),h*.9|0);const f=`Day ${i.day} — ${i.tDay*24|0}:00 ${i.isNight?"🌙":"☀️"}`;X(o,n,e.scale(12),f,i.isNight?"#ffd166":"#6ee7ff",e);const d=t.height-e.scale(e.isTouch?86:64),u=Math.max(e.scale(e.isTouch?170:140),Math.min(e.scale(e.isTouch?260:220),(t.width-s*2)/i.hotbar.length));n=s,o.fillStyle="#0b122088",o.fillRect(0,d,t.width,e.scale(e.isTouch?86:64)),o.strokeStyle="#1e293b",o.strokeRect(0,d+.5,t.width,e.scale(e.isTouch?86:64)),o.font=e.getScaledFont(e.isTouch?17:15);for(let M=0;M<i.hotbar.length;M++){const B=i.hotbar[M],m=n+e.scale(2),k=d+e.scale(e.isTouch?14:10),b=u-e.scale(6),x=e.scale(e.isTouch?60:44);Jt(o,m,k,b,x,`${M+1}. ${B.name}`,B.cost,B.selected,e),Array.isArray(e.hotbarRects)&&(e.hotbarRects[M]={index:M,x:m,y:k,w:b,h:x}),n+=u}let w=l+e.scale(e.isTouch?12:8);const v=Math.min(e.scale(e.isTouch?520:420),t.width-s*2);for(let M=i.messages.length-1;M>=0;M--){const B=i.messages[M];Zt(o,a-v-s,w,B.text,v,e),w+=e.scale(e.isTouch?34:26)}}function X(o,t,i,e,s,l){const a=o.measureText(e).width+l.scale(l.isTouch?28:24),n=l.scale(l.isTouch?32:26);o.fillStyle="#0f172a",o.fillRect(t,i,a,n),o.strokeStyle="#1e293b",o.strokeRect(t+.5,i+.5,a-1,n-1),o.fillStyle=s,o.fillRect(t+l.scale(3),i+l.scale(3),l.scale(l.isTouch?10:8),n-l.scale(6)),o.fillStyle="#dbeafe",o.fillText(e,t+l.scale(l.isTouch?18:16),i+l.scale(l.isTouch?22:18))}function Jt(o,t,i,e,s,l,a,n,h){o.fillStyle=n?"#102034":"#0f172a",o.fillRect(t,i,e,s),o.strokeStyle=n?"#4b9fff":"#1e293b",o.strokeRect(t+.5,i+.5,e-1,s-1),o.fillStyle="#dbeafe",o.fillText(l,t+h.scale(10),i+h.scale(h.isTouch?36:28)),o.fillStyle="#9fb3c8",o.fillText(a,t+e-h.scale(h.isTouch?66:56),i+h.scale(h.isTouch?36:28))}function Zt(o,t,i,e,s,l){const a=l.scale(l.isTouch?30:24);o.fillStyle="#0f172aee",o.fillRect(t,i,s,a),o.strokeStyle="#1e293b",o.strokeRect(t+.5,i+.5,s-1,a-1),o.fillStyle="#dbeafe",o.fillText(e,t+l.scale(10),i+l.scale(l.isTouch?20:16))}function U(o,t,i,e){for(const s of o.buildings){if(s.kind==="hq"||s.kind==="path"||s.kind==="house"||!s.done)continue;const l=Math.max(s.x,Math.min(t,s.x+s.w)),a=Math.max(s.y,Math.min(i,s.y+s.h)),n=t-l,h=i-a;if(n*n+h*h<=e*e)return!0}return!1}function Kt(o,t,i){const s=Math.floor(t/24)*24,l=Math.floor(i/24)*24,a=o.buildings.find(n=>n.kind==="path"&&n.done&&n.x===s&&n.y===l);return a&&a.speedBonus?a.speedBonus:1}function tt(o,t,i,e,s,l=1){const a=i-t.x,n=e-t.y,h=Math.hypot(a,n);if(h<5)return!0;const c=Kt(o,t.x,t.y),f=t.speed*l*c*s,d=a/h,u=n/h,w=t.x+d*f,v=t.y+u*f;if(U(o,w,v,t.r)){const M=-u,B=d,m=t.x+M*f*.5,k=t.y+B*f*.5;if(!U(o,m,k,t.r))return t.x=Math.max(0,Math.min(m,p.w)),t.y=Math.max(0,Math.min(k,p.h)),!1;const b=t.x-M*f*.5,x=t.y-B*f*.5;return U(o,b,x,t.r)||(t.x=Math.max(0,Math.min(b,p.w)),t.y=Math.max(0,Math.min(x,p.h))),!1}else return t.x=Math.max(0,Math.min(w,p.w)),t.y=Math.max(0,Math.min(v,p.h)),!1}function _t(o,t){if(t.stuckTimer===void 0&&(t.stuckTimer=0),U(o,t.x,t.y,t.r)){if(t.stuckTimer+=1/60,t.stuckTimer>2){const e=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let s=!1;for(const l of[20,40,60,80]){for(const a of e){const n=t.x+Math.cos(a)*l,h=t.y+Math.sin(a)*l,c=Math.max(t.r,Math.min(n,p.w-t.r)),r=Math.max(t.r,Math.min(h,p.h-t.r));if(!U(o,c,r,t.r)){t.x=c,t.y=r,t.stuckTimer=0,s=!0,console.log(`Rescued stuck colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) using distance ${l}`);break}}if(s)break}if(!s){const l=o.buildings.find(a=>a.kind==="hq");l&&(t.x=l.x+l.w/2+(Math.random()-.5)*40,t.y=l.y-40+(Math.random()-.5)*20,t.stuckTimer=0,console.log("Emergency rescue: teleported stuck colonist to HQ area"))}return!0}}else t.stuckTimer=0;return!1}function te(o,t,i){if(!t.alive)return;if(t.t+=i,t.state||(t.state="seekTask"),t.stateSince=(t.stateSince||0)+i,_t(o,t)){t.task=null,t.target=null,o.clearPath&&o.clearPath(t),t.state="seekTask",t.stateSince=0;return}t.hunger=Math.min(100,(t.hunger||0)+i*1.2),t.inside?t.fatigue=Math.max(0,(t.fatigue||0)-i*12):t.fatigue=Math.min(100,(t.fatigue||0)+i*4);const e=o.enemies.find(s=>W(s,t)<140*140);switch(t.lastHp=t.lastHp??t.hp,t.hp<t.lastHp&&(t.hurt=1.5),t.lastHp=t.hp,t.hurt=Math.max(0,(t.hurt||0)-i),!t.inside&&e&&t.state!=="flee"&&(t.state="flee",t.stateSince=0),!t.inside&&!e&&o.isNight()&&t.state!=="sleep"&&t.state!=="flee"&&(t.state="sleep",t.stateSince=0),t.inside&&t.state!=="resting"&&(t.state="resting",t.stateSince=0),t.state){case"resting":{t.hideTimer=Math.max(0,(t.hideTimer||0)-i),t.hp=Math.min(100,t.hp+4*i),!o.isNight()&&!e&&(t.hurt||0)<=0&&(t.hideTimer||0)<=0&&(o.leaveBuilding(t),t.safeTarget=null,t.safeTimer=0,t.state="seekTask",t.stateSince=0);break}case"flee":{let s=null,l=null;const a=e?o.findSafeTurret(t,e):null;if(a){const n=a.range||120,h=o.centerOf(a),c=o.buildings.find(r=>r.kind==="house"&&r.done&&o.buildingHasSpace(r)&&W(o.centerOf(r),h)<n*n);c&&(l=c,s=o.centerOf(c))}if(!s){const n=o.buildings.find(h=>h.kind==="hq"&&o.buildingHasSpace(h));n&&(l=n,s=o.centerOf(n))}if(!s&&a&&(s=o.centerOf(a)),s){const n=s.x-t.x,h=s.y-t.y,c=Math.hypot(n,h),r=l?t.x>=l.x-8&&t.x<=l.x+l.w+8&&t.y>=l.y-8&&t.y<=l.y+l.h+8:!1;if(c<=20||r)if(l&&o.tryEnterBuilding(t,l))t.hideTimer=3,t.state="resting",t.stateSince=0;else{const f=o.buildings.filter(d=>d.done&&o.buildingHasSpace(d)&&(d.kind==="house"||d.kind==="hq"));if(f.length){const d=f.sort((w,v)=>W(t,o.centerOf(w))-W(t,o.centerOf(v)))[0],u=o.centerOf(d);o.clearPath(t),l=d,s=u}}else tt(o,t,s.x,s.y,i,1.8)}else{const n=Pt(Rt(t,e));t.x+=n.x*(t.speed+90)*i,t.y+=n.y*(t.speed+90)*i}e||(t.state="seekTask",t.stateSince=0);break}case"sleep":{const s=o.buildings.filter(d=>d.kind==="house"&&d.done&&o.isProtectedByTurret(d)&&o.buildingHasSpace(d));if(!o.isNight()||s.length===0){t.state="seekTask",t.stateSince=0;break}let l=s[0],a=W(t,o.centerOf(l));for(let d=1;d<s.length;d++){const u=W(t,o.centerOf(s[d]));u<a&&(a=u,l=s[d])}const n=o.centerOf(l),h=n.x-t.x,c=n.y-t.y,r=Math.hypot(h,c),f=t.x>=l.x-8&&t.x<=l.x+l.w+8&&t.y>=l.y-8&&t.y<=l.y+l.h+8;if(r<=20||f)if(o.tryEnterBuilding(t,l))t.hideTimer=0,t.state="resting",t.stateSince=0;else{const d=o.buildings.filter(u=>u.done&&o.buildingHasSpace(u)&&(u.kind==="house"||u.kind==="hq")).sort((u,w)=>W(t,o.centerOf(u))-W(t,o.centerOf(w)))[0];d?(o.centerOf(d),o.clearPath(t)):(t.state="seekTask",t.stateSince=0)}else tt(o,t,n.x,n.y,i);break}case"seekTask":{if(o.isNight()){t.state="sleep",t.stateSince=0;break}if(!t.task||t.task==="idle"&&Math.random()<.005){const s=t.task;o.pickTask(t),s!==t.task&&Math.random()<.1&&console.log(`Colonist assigned task: ${t.task}, target:`,t.target)}switch(t.task){case"build":t.state="build";break;case"harvestFarm":t.state="harvest";break;case"harvestWell":t.state="harvest";break;case"chop":t.state="chop";break;case"mine":t.state="mine";break;case"idle":default:t.state="idle";break}t.stateSince=0;break}case"idle":{const s=t.target;if(!s){t.state="seekTask";break}o.moveAlongPath(t,i,s,8)&&(t.task=null,t.target=null,o.clearPath(t),t.state="seekTask",t.stateSince=0);break}case"build":{const s=t.target;if(!s||s.done){o.releaseBuildReservation(t),t.task=null,t.target=null,o.clearPath(t),t.state="seekTask";break}const l={x:s.x+s.w/2,y:s.y+s.h/2};if(o.moveAlongPath(t,i,l,12)&&(s.buildLeft-=25*i,s.buildLeft<=0)){if(s.done=!0,s.kind==="farm"&&(s.growth=0,s.ready=!1),U(o,t.x,t.y,t.r)){const a=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let n=!1;for(const h of a){const c=Math.max(s.w,s.h)/2+t.r+10,r=s.x+s.w/2+Math.cos(h)*c,f=s.y+s.h/2+Math.sin(h)*c,d=Math.max(t.r,Math.min(r,p.w-t.r)),u=Math.max(t.r,Math.min(f,p.h-t.r));if(!U(o,d,u,t.r)){t.x=d,t.y=u,n=!0,Math.random()<.1&&console.log(`Moved colonist to safety after building completion: (${t.x.toFixed(1)}, ${t.y.toFixed(1)})`);break}}if(!n){const h=o.buildings.find(c=>c.kind==="hq");h&&(t.x=h.x+h.w/2,t.y=h.y-30,console.log("Emergency teleport to HQ area after building completion"))}}o.msg(s.name?s.name+" complete":"Building complete"),o.rebuildNavGrid(),o.clearPath(t),o.releaseBuildReservation(t),t.task=null,t.target=null,t.state="seekTask"}break}case"harvest":{const s=t.target;if(!s){t.task=null,t.target=null,o.clearPath(t),t.state="seekTask";break}if(s.kind==="farm"&&!s.ready){t.task=null,t.target=null,o.clearPath(t),t.state="seekTask";break}const l={x:s.x+s.w/2,y:s.y+s.h/2};if(o.moveAlongPath(t,i,l,12)){if(s.kind==="farm"){s.ready=!1,s.growth=0;const a=o.addResource("food",10);a>0&&o.msg(`Farm harvested (+${a} food)`,"good")}else if(s.kind==="well"){const a=o.addResource("food",5);a>0&&o.msg(`Well collected (+${a} food)`,"good")}t.task=null,t.target=null,o.clearPath(t),t.state="seekTask"}break}case"chop":{const s=t.target;if(!s||s.hp<=0){s&&o.assignedTargets.has(s)&&o.assignedTargets.delete(s),t.task=null,t.target=null,o.clearPath(t),t.state="seekTask";break}const l=s.x-t.x,a=s.y-t.y,n=Math.hypot(l,a),h=(s.r||12)+t.r+4;if(n<=h+2.5+.1){if(s.hp-=18*i,s.hp<=0){const r=o.addResource("wood",6);o.trees.splice(o.trees.indexOf(s),1),o.assignedTargets.has(s)&&o.assignedTargets.delete(s),r>0&&o.msg(`+${r} wood`,"good"),t.task=null,t.target=null,o.clearPath(t),t.state="seekTask"}break}else tt(o,t,s.x,s.y,i);t.stateSince&&t.stateSince>15&&(o.assignedTargets.has(s)&&o.assignedTargets.delete(s),t.task=null,t.target=null,o.clearPath(t),t.state="seekTask");break}case"mine":{const s=t.target;if(!s||s.hp<=0){s&&o.assignedTargets.has(s)&&o.assignedTargets.delete(s),t.task=null,t.target=null,o.clearPath(t),t.state="seekTask";break}const l=s.x-t.x,a=s.y-t.y,n=Math.hypot(l,a),h=(s.r||12)+t.r+4,c=2.5;if(Math.random()<.01&&console.log(`Mining: distance=${n.toFixed(1)}, interact=${h}, colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}), rock at (${s.x.toFixed(1)}, ${s.y.toFixed(1)})`),n<=h+c+.1){if(s.hp-=16*i,s.hp<=0){const r=o.addResource("stone",5);o.rocks.splice(o.rocks.indexOf(s),1),o.assignedTargets.has(s)&&o.assignedTargets.delete(s),r>0&&o.msg(`+${r} stone`,"good"),t.task=null,t.target=null,o.clearPath(t),t.state="seekTask"}break}else tt(o,t,s.x,s.y,i),Math.random()<.01&&console.log(`Moving toward rock: target=(${s.x.toFixed(1)}, ${s.y.toFixed(1)}), distance=${n.toFixed(1)}`);t.stateSince&&t.stateSince>15&&(console.log(`Colonist stuck mining for ${t.stateSince.toFixed(1)}s, abandoning`),o.assignedTargets.has(s)&&o.assignedTargets.delete(s),t.task=null,t.target=null,o.clearPath(t),t.state="seekTask");break}}for(const s of o.colonists){if(s===t)continue;if((t.state==="mine"||t.state==="chop")&&t.target){const c=(t.target.r||12)+t.r+4;if(Math.hypot(t.x-t.target.x,t.y-t.target.y)<=c+2.5)continue}const l=t.x-s.x,a=t.y-s.y,n=l*l+a*a,h=(t.r+2)*(t.r+2);if(n>0&&n<h*4){const c=Math.sqrt(n)||1,r=(h*2-c)*.5;t.x+=l/c*r*i*6,t.y+=a/c*r*i*6}}}function ht(o,t,i,e){for(const s of o.buildings){if(s.kind==="hq"||s.kind==="path"||s.kind==="house"||!s.done)continue;const l=Math.max(s.x,Math.min(t,s.x+s.w)),a=Math.max(s.y,Math.min(i,s.y+s.h)),n=t-l,h=i-a;if(n*n+h*h<=e*e)return!0}return!1}function ee(o,t,i){const e=o.buildings.find(r=>r.kind==="hq");let s=e,l=W(t,o.centerOf(e));for(const r of o.colonists){const f=W(t,r);f<l&&(l=f,s=r)}const a=s.w?o.centerOf(s):s,n=Pt(Rt(a,t)),h=t.x+n.x*t.speed*i,c=t.y+n.y*t.speed*i;if(!ht(o,h,c,t.r))t.x=h,t.y=c;else{const r=-n.y,f=n.x,d=t.x+r*t.speed*i*.5,u=t.y+f*t.speed*i*.5;if(!ht(o,d,u,t.r))t.x=d,t.y=u;else{const w=t.x-r*t.speed*i*.5,v=t.y-f*t.speed*i*.5;ht(o,w,v,t.r)||(t.x=w,t.y=v)}}if(s.w){const r=s;o.pointInRect(t,r)&&(r.hp-=t.dmg*i),r.hp<=0&&(r.kind==="hq"?o.lose():(o.evictColonistsFrom(r),o.buildings.splice(o.buildings.indexOf(r),1),o.msg((r.name||r.kind)+" destroyed","warn")))}else{const r=s;Math.hypot(t.x-r.x,t.y-r.y)<t.r+8&&(r.hp-=t.dmg*i,r.hp<=0&&(r.alive=!1,o.colonists.splice(o.colonists.indexOf(r),1),o.msg("A colonist has fallen","warn")))}}class se{constructor(t){g(this,"canvas");g(this,"ctx");g(this,"DPR",1);g(this,"camera",{x:0,y:0,zoom:1});g(this,"uiScale",1);g(this,"baseFontSize",14);g(this,"isTouch",!1);g(this,"RES",{wood:0,stone:0,food:0});g(this,"BASE_STORAGE",200);g(this,"storageFullWarned",!1);g(this,"day",1);g(this,"tDay",0);g(this,"dayLength",180);g(this,"fastForward",1);g(this,"paused",!1);g(this,"prevIsNight",!1);g(this,"colonists",[]);g(this,"enemies",[]);g(this,"trees",[]);g(this,"rocks",[]);g(this,"buildings",[]);g(this,"bullets",[]);g(this,"messages",[]);g(this,"selectedBuild","house");g(this,"hotbar",["house","farm","turret","wall","stock","tent","warehouse","well","infirmary"]);g(this,"showBuildMenu",!1);g(this,"debug",{nav:!1,paths:!0});g(this,"selColonist",null);g(this,"follow",!1);g(this,"keyState",{});g(this,"once",new Set);g(this,"mouse",{x:0,y:0,wx:0,wy:0,down:!1,rdown:!1});g(this,"lastPaintCell",null);g(this,"eraseDragStart",null);g(this,"menuRects",[]);g(this,"hotbarRects",[]);g(this,"pendingPlacement",null);g(this,"placeUIRects",[]);g(this,"handleResize",()=>{const t=document.querySelector("header"),i=t?Math.ceil(t.getBoundingClientRect().height):48,e=window.innerWidth,s=window.innerHeight-i;this.canvas.style.width=e+"px",this.canvas.style.height=s+"px",this.canvas.width=Math.floor(e*this.DPR),this.canvas.height=Math.floor(s*this.DPR),this.calculateUIScale()});g(this,"screenToWorld",(t,i)=>({x:t*this.DPR/this.camera.zoom+this.camera.x,y:i*this.DPR/this.camera.zoom+this.camera.y}));g(this,"respawnTimer",0);g(this,"assignedTargets",new WeakSet);g(this,"buildReservations",new Map);g(this,"insideCounts",new Map);g(this,"last",performance.now());g(this,"frame",t=>{const i=Math.min(.033,(t-this.last)/1e3);this.last=t,this.update(i),this.draw(),requestAnimationFrame(this.frame)});g(this,"grid",Yt());const i=t.getContext("2d");if(!i)throw new Error("no ctx");this.canvas=t,this.ctx=i,this.DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)),this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.bindInput(),this.newGame(),this.rebuildNavGrid(),requestAnimationFrame(this.frame)}getStorageCapacity(){let t=this.BASE_STORAGE;for(const i of this.buildings)i.done&&i.storageBonus&&(t+=i.storageBonus);return t}getPopulationCap(){return(this.buildings.find(t=>t.kind==="hq")?3:0)+this.buildings.filter(t=>t.kind==="house"&&t.done).reduce((t,i)=>t+(i.popCap||0),0)}addResource(t,i){const e=this.RES.wood+this.RES.stone+this.RES.food,s=this.getStorageCapacity(),l=Math.max(0,s-e),a=Math.min(Math.floor(i),l);return a>0&&(this.RES[t]+=a),a===0&&i>0&&!this.storageFullWarned?(this.msg(`Storage full! Cannot store more ${String(t)}`,"warn"),this.storageFullWarned=!0):a>0&&(this.storageFullWarned=!1),a}calculateUIScale(){const e=this.canvas.width/this.DPR,s=this.canvas.height/this.DPR,l=e/1920,a=s/1080;let n=Math.min(l,a);const h="ontouchstart"in window||navigator.maxTouchPoints>0;this.isTouch=h,h?e<600?n=Math.max(n*1.9,1.6):e<=900?n=Math.max(n*1.7,1.5):e<=1200?n=Math.max(n*1.5,1.35):n=Math.max(n*1.25,n):e<1200&&(n*=1.1),n=Math.max(1.1,Math.min(n,3)),this.uiScale=n,console.log(`UI Scale calculated: ${n.toFixed(2)} for ${e}x${s}`)}getScaledFont(t,i="500",e="system-ui,Segoe UI,Roboto"){return`${i} ${Math.round(t*this.uiScale)}px ${e}`}scale(t){return Math.round(t*this.uiScale)}bindInput(){const t=this.canvas;t.addEventListener("mousemove",i=>{const e=t.getBoundingClientRect();this.mouse.x=i.clientX-e.left,this.mouse.y=i.clientY-e.top;const s=this.screenToWorld(this.mouse.x,this.mouse.y);this.mouse.wx=s.x,this.mouse.wy=s.y,this.mouse.down&&(this.selectedBuild==="path"?this.paintPathAtMouse():this.selectedBuild==="wall"&&this.paintWallAtMouse())}),t.addEventListener("mousedown",i=>{if(i.preventDefault(),i.button===0){this.mouse.down=!0;const e=this.mouse.x*this.DPR,s=this.mouse.y*this.DPR;for(const l of this.hotbarRects)if(e>=l.x&&e<=l.x+l.w&&s>=l.y&&s<=l.y+l.h){const a=this.hotbar[l.index];a&&(this.selectedBuild=a,this.toast("Selected: "+D[a].name));return}if(this.showBuildMenu){this.handleBuildMenuClick();return}if(this.selectedBuild==="path")this.paintPathAtMouse(!0);else if(this.selectedBuild==="wall")this.paintWallAtMouse(!0);else{const l=this.findColonistAt(this.mouse.wx,this.mouse.wy);l?(this.selColonist=l,this.follow=!0):this.placeAtMouse()}}if(i.button===2){if(this.mouse.rdown=!0,this.showBuildMenu){this.showBuildMenu=!1;return}this.eraseDragStart={x:this.mouse.wx,y:this.mouse.wy}}}),t.addEventListener("mouseup",i=>{if(i.preventDefault(),i.button===0&&(this.mouse.down=!1,this.lastPaintCell=null),i.button===2){if(this.eraseDragStart){const e=Math.min(this.eraseDragStart.x,this.mouse.wx),s=Math.min(this.eraseDragStart.y,this.mouse.wy),l=Math.max(this.eraseDragStart.x,this.mouse.wx),a=Math.max(this.eraseDragStart.y,this.mouse.wy);(l-e)*(a-s)<12*12?this.cancelOrErase():this.eraseInRect({x:e,y:s,w:l-e,h:a-s})}this.mouse.rdown=!1,this.eraseDragStart=null}}),t.addEventListener("contextmenu",i=>i.preventDefault()),t.addEventListener("wheel",i=>{i.preventDefault();const e=i.deltaY<0?1.1:.9;this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*e))}),window.addEventListener("keydown",i=>{const e=i.key.toLowerCase();this.keyState[e]=!0,this.once.has(e)||this.once.add(e)}),window.addEventListener("keyup",i=>{this.keyState[i.key.toLowerCase()]=!1})}handleTapOrClickAtScreen(t,i){this.canvas.getBoundingClientRect(),this.mouse.x=t,this.mouse.y=i;const s=this.screenToWorld(this.mouse.x,this.mouse.y);if(this.mouse.wx=s.x,this.mouse.wy=s.y,this.pendingPlacement&&this.placeUIRects.length){const h=this.mouse.x*this.DPR,c=this.mouse.y*this.DPR;for(const r of this.placeUIRects)if(h>=r.x&&h<=r.x+r.w&&c>=r.y&&c<=r.y+r.h){r.id==="up"?this.nudgePending(0,-1):r.id==="down"?this.nudgePending(0,1):r.id==="left"?this.nudgePending(-1,0):r.id==="right"?this.nudgePending(1,0):r.id==="ok"?this.confirmPending():r.id==="cancel"&&this.cancelPending();return}}const l=this.mouse.x*this.DPR,a=this.mouse.y*this.DPR;for(const h of this.hotbarRects)if(l>=h.x&&l<=h.x+h.w&&a>=h.y&&a<=h.y+h.h){const c=this.hotbar[h.index];c&&(this.selectedBuild=c,this.toast("Selected: "+D[c].name));return}if(this.showBuildMenu){this.handleBuildMenuClick();return}if(this.selectedBuild==="path"){this.paintPathAtMouse(!0);return}if(this.selectedBuild==="wall"){this.paintWallAtMouse(!0);return}if(this.isTouch&&this.selectedBuild){this.placeAtMouse();return}const n=this.findColonistAt(this.mouse.wx,this.mouse.wy);if(n){this.selColonist=n,this.follow=!0;return}this.placeAtMouse()}findColonistAt(t,i){for(let e=this.colonists.length-1;e>=0;e--){const s=this.colonists[e];if(!s.alive||s.inside)continue;if((s.x-t)*(s.x-t)+(s.y-i)*(s.y-i)<=(s.r+2)*(s.r+2))return s}return null}msg(t,i="info"){this.messages.push({text:t,t:4,kind:i}),this.toast(t,1600)}toast(t,i=1400){const e=document.getElementById("toast");e&&(e.textContent=t,e.style.opacity="1",clearTimeout(e._t),e._t=setTimeout(()=>e.style.opacity="0",i))}scatter(){for(let t=0;t<220;t++){const i={x:F(80,p.w-80),y:F(80,p.h-80)};Math.hypot(i.x-L.x,i.y-L.y)<220||this.trees.push({x:i.x,y:i.y,r:12,hp:40,type:"tree"})}for(let t=0;t<140;t++){const i={x:F(80,p.w-80),y:F(80,p.h-80)};Math.hypot(i.x-L.x,i.y-L.y)<200||this.rocks.push({x:i.x,y:i.y,r:12,hp:50,type:"rock"})}}tryRespawn(t){if(this.respawnTimer+=t*this.fastForward,this.respawnTimer>=4){this.respawnTimer=0;const i=e=>{for(let s=0;s<6;s++){const l={x:F(60,p.w-60),y:F(60,p.h-60)};if(Math.hypot(l.x-L.x,l.y-L.y)<200)continue;let a=!0;for(const n of this.buildings)if(l.x>n.x-24&&l.x<n.x+n.w+24&&l.y>n.y-24&&l.y<n.y+n.h+24){a=!1;break}if(a){e==="tree"?this.trees.push({x:l.x,y:l.y,r:12,hp:40,type:"tree"}):this.rocks.push({x:l.x,y:l.y,r:12,hp:50,type:"rock"});break}}};Math.random()<.5&&this.trees.length<260&&i("tree"),Math.random()<.35&&this.rocks.length<180&&i("rock")}}buildHQ(){const t={w:3*y,h:3*y},i={kind:"hq",name:"HQ",x:L.x-t.w/2,y:L.y-t.h/2,w:t.w,h:t.h,hp:600,done:!0,color:A.bld,size:{w:3,h:3},build:0,buildLeft:0};this.buildings.push(i),this.rebuildNavGrid()}newGame(){this.colonists.length=this.enemies.length=this.trees.length=this.rocks.length=this.buildings.length=this.bullets.length=this.messages.length=0,this.buildReservations.clear(),this.insideCounts.clear(),this.RES.wood=50,this.RES.stone=30,this.RES.food=20,this.day=1,this.tDay=0,this.fastForward=1,this.camera.zoom=1,this.camera.x=L.x-this.canvas.width/(2*this.camera.zoom),this.camera.y=L.y-this.canvas.height/(2*this.camera.zoom),this.buildHQ(),this.scatter();for(let t=0;t<3;t++){const i=F(0,Math.PI*2),e=80+F(-10,10);this.spawnColonist({x:L.x+Math.cos(i)*e,y:L.y+Math.sin(i)*e})}this.msg("Welcome! Build farms before night, then turrets.")}spawnColonist(t){const i={x:t.x,y:t.y,r:8,hp:100,speed:50,task:null,target:null,carrying:null,hunger:0,alive:!0,color:A.colonist,t:F(0,1)};return this.colonists.push(i),i}spawnEnemy(){const t=Ft(0,4);let i,e;t===0?(i=F(0,p.w),e=-80):t===1?(i=F(0,p.w),e=p.h+80):t===2?(i=-80,e=F(0,p.h)):(i=p.w+80,e=F(0,p.h));const s={x:i,y:e,r:9,hp:60+this.day*6,speed:48+this.day*2,dmg:8+this.day,target:null,color:A.enemy};return this.enemies.push(s),s}canPlace(t,i,e){const s={x:i,y:e,w:t.size.w*y,h:t.size.h*y};if(s.x<0||s.y<0||s.x+s.w>p.w||s.y+s.h>p.h)return!1;for(const a of this.buildings)if(!(s.x+s.w<=a.x||s.x>=a.x+a.w||s.y+s.h<=a.y||s.y>=a.y+a.h))return!1;const l=(a,n)=>{const h=Math.max(n.x,Math.min(a.x,n.x+n.w)),c=Math.max(n.y,Math.min(a.y,n.y+n.h)),r=a.x-h,f=a.y-c;return r*r+f*f<=a.r*a.r};for(const a of this.trees)if(l(a,s))return!1;for(const a of this.rocks)if(l(a,s))return!1;return!0}placeAtMouse(){if(this.paused)return;const t=this.selectedBuild;if(!(!t||!D[t])){if(this.isTouch){const e=Math.floor(this.mouse.wx/y)*y,s=Math.floor(this.mouse.wy/y)*y;this.pendingPlacement={key:t,x:e,y:s};return}this.tryPlaceNow(t,this.mouse.wx,this.mouse.wy)}}tryPlaceNow(t,i,e){const s=D[t];if(!s)return;const l=lt(t,i,e);if(!this.canPlace(l,l.x,l.y)){this.toast("Can't place here");return}if(!_(this.RES,s.cost)){this.toast("Not enough resources");return}if(nt(this.RES,s.cost),l.kind!=="path")for(let a=this.buildings.length-1;a>=0;a--){const n=this.buildings[a];n.kind==="path"&&!(l.x+l.w<=n.x||l.x>=n.x+n.w||l.y+l.h<=n.y||l.y>=n.y+n.h)&&this.buildings.splice(a,1)}this.buildings.push(l),this.rebuildNavGrid()}nudgePending(t,i){if(!this.pendingPlacement)return;const e=D[this.pendingPlacement.key],s=this.pendingPlacement.x+t*y,l=this.pendingPlacement.y+i*y,a=e.size.w*y,n=e.size.h*y;this.pendingPlacement.x=$(s,0,p.w-a),this.pendingPlacement.y=$(l,0,p.h-n)}confirmPending(){if(!this.pendingPlacement)return;const{key:t,x:i,y:e}=this.pendingPlacement;this.pendingPlacement=null,this.tryPlaceNow(t,i+1,e+1)}cancelPending(){this.pendingPlacement=null}paintPathAtMouse(t=!1){const i=Math.floor(this.mouse.wx/y),e=Math.floor(this.mouse.wy/y);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===i&&this.lastPaintCell.gy===e)return;const s=(w,v)=>{const M=w*y+1,B=v*y+1,m=lt("path",M,B);!this.buildings.some(b=>b.kind==="path"&&b.x===m.x&&b.y===m.y)&&_(this.RES,D.path.cost)&&(nt(this.RES,D.path.cost),this.buildings.push(m))};if(this.lastPaintCell==null){s(i,e),this.lastPaintCell={gx:i,gy:e},this.rebuildNavGrid();return}let l=this.lastPaintCell.gx,a=this.lastPaintCell.gy,n=i,h=e;const c=Math.abs(n-l),r=Math.abs(h-a),f=l<n?1:-1,d=a<h?1:-1;let u=c-r;for(;s(l,a),!(l===n&&a===h);){const w=2*u;w>-r&&(u-=r,l+=f),w<c&&(u+=c,a+=d)}this.lastPaintCell={gx:i,gy:e},this.rebuildNavGrid()}paintWallAtMouse(t=!1){const i=Math.floor(this.mouse.wx/y),e=Math.floor(this.mouse.wy/y);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===i&&this.lastPaintCell.gy===e)return;const s=(w,v)=>{const M=w*y+1,B=v*y+1,m=lt("wall",M,B);this.buildings.some(b=>b.kind==="wall"&&b.x===m.x&&b.y===m.y)||_(this.RES,D.wall.cost)&&this.canPlace(m,m.x,m.y)&&(nt(this.RES,D.wall.cost),this.buildings.push(m))};if(this.lastPaintCell==null){s(i,e),this.lastPaintCell={gx:i,gy:e},this.rebuildNavGrid();return}let l=this.lastPaintCell.gx,a=this.lastPaintCell.gy,n=i,h=e;const c=Math.abs(n-l),r=Math.abs(h-a),f=l<n?1:-1,d=a<h?1:-1;let u=c-r;for(;s(l,a),!(l===n&&a===h);){const w=2*u;w>-r&&(u-=r,l+=f),w<c&&(u+=c,a+=d)}this.lastPaintCell={gx:i,gy:e},this.rebuildNavGrid()}eraseInRect(t){const i=this.buildings.length;for(let s=this.buildings.length-1;s>=0;s--){const l=this.buildings[s];if(l.kind==="hq")continue;!(t.x+t.w<=l.x||t.x>=l.x+l.w||t.y+t.h<=l.y||t.y>=l.y+l.h)&&(this.evictColonistsFrom(l),this.buildings.splice(s,1),this.buildReservations.delete(l),this.insideCounts.delete(l))}const e=i-this.buildings.length;e>0&&(this.msg(`Removed ${e} structure(s)`),this.rebuildNavGrid())}cancelOrErase(){const t={x:this.mouse.wx,y:this.mouse.wy};for(let i=this.buildings.length-1;i>=0;i--){const e=this.buildings[i];if(e.kind!=="hq"&&t.x>=e.x&&t.x<=e.x+e.w&&t.y>=e.y&&t.y<=e.y+e.h){this.evictColonistsFrom(e),this.buildings.splice(i,1),this.msg("Building removed"),this.rebuildNavGrid();return}}this.selectedBuild=null,this.toast("Build canceled")}evictColonistsFrom(t){const i=t.x+t.w/2,e=t.y+t.h/2;for(const s of this.colonists)if(s.inside===t){this.leaveBuilding(s),s.safeTarget=null,s.safeTimer=0;const l=Math.random()*Math.PI*2,a=(t.w/2+10)*Math.cos(l),n=(t.h/2+10)*Math.sin(l);s.x=$(i+a,0,p.w),s.y=$(e+n,0,p.h)}}buildingCapacity(t){return t.kind==="hq"?8:t.kind==="house"?3:1}buildingHasSpace(t){const i=this.buildingCapacity(t);return(this.insideCounts.get(t)||0)<i}tryEnterBuilding(t,i){return!i.done||!this.buildingHasSpace(i)?!1:(this.insideCounts.set(i,(this.insideCounts.get(i)||0)+1),t.inside=i,t.hideTimer=0,!0)}leaveBuilding(t){const i=t.inside;if(i){const e=(this.insideCounts.get(i)||1)-1;e<=0?this.insideCounts.delete(i):this.insideCounts.set(i,e)}t.inside=null,t.hideTimer=0}getMaxCrew(t){const i=t.w/y*(t.h/y);return i<=1?1:i<=4?2:3}releaseBuildReservation(t){if(!t.reservedBuildFor)return;const i=t.reservedBuildFor,e=(this.buildReservations.get(i)||1)-1;e<=0?this.buildReservations.delete(i):this.buildReservations.set(i,e),t.reservedBuildFor=null}clearPath(t){t.path=void 0,t.pathIndex=void 0,t.repath=0}setTask(t,i,e){if(t.target&&t.target.type&&this.assignedTargets.has(t.target)&&this.assignedTargets.delete(t.target),t.reservedBuildFor&&t.reservedBuildFor!==e&&this.releaseBuildReservation(t),t.task=i,t.target=e,this.clearPath(t),e&&e.type&&(e.type==="tree"||e.type==="rock")&&this.assignedTargets.add(e),i==="build"&&e&&e.w!=null&&!t.reservedBuildFor){const s=e,l=this.buildReservations.get(s)||0,a=this.getMaxCrew(s);l<a&&(this.buildReservations.set(s,l+1),t.reservedBuildFor=s)}}pickTask(t){let i=null,e=1/0;for(const n of this.buildings){if(n.done||(this.buildReservations.get(n)||0)>=this.getMaxCrew(n))continue;const c=W({x:t.x,y:t.y},this.centerOf(n));c<e&&(e=c,i=n)}if(i){this.setTask(t,"build",i);return}const s=this.buildings.find(n=>n.kind==="farm"&&n.done&&n.ready);if(s){this.setTask(t,"harvestFarm",s);return}if(Math.random()<.1){const n=this.buildings.find(h=>h.kind==="well"&&h.done);if(n){this.setTask(t,"harvestWell",n);return}}if(this.RES.food<Math.max(4,this.colonists.length*2)){const n=this.nearestCircle({x:t.x,y:t.y},this.trees.filter(h=>!this.assignedTargets.has(h)));if(n){this.setTask(t,"chop",n);return}}const l=this.trees.filter(n=>!this.assignedTargets.has(n)),a=this.rocks.filter(n=>!this.assignedTargets.has(n));if(Math.random()<.05&&console.log(`Task assignment: wood=${this.RES.wood}, stone=${this.RES.stone}, trees=${l.length}, rocks=${a.length}`),this.RES.wood<this.RES.stone){const n=this.nearestCircle({x:t.x,y:t.y},l);if(n){Math.random()<.1&&console.log("Assigning chop task"),this.setTask(t,"chop",n);return}else Math.random()<.1&&console.log("No trees available for chopping")}else{const n=this.nearestCircle({x:t.x,y:t.y},a);if(n){Math.random()<.1&&console.log("Assigning mine task to rock at:",n),this.setTask(t,"mine",n);return}else Math.random()<.1&&console.log("No rocks available for mining")}Math.random()<.1&&console.log("Assigning idle task"),this.setTask(t,"idle",{x:t.x+F(-80,80),y:t.y+F(-80,80)})}nearestCircle(t,i){let e=null,s=1e9;for(const l of i){const a=W(t,l);a<s&&(s=a,e=l)}return e}moveAlongPath(t,i,e,s=10){t.repath=(t.repath||0)-i;const l=e&&(!t.pathGoal||Math.hypot(t.pathGoal.x-e.x,t.pathGoal.y-e.y)>12);if(e&&(l||t.repath==null||t.repath<=0||!t.path||t.pathIndex==null)){const f=this.computePath(t.x,t.y,e.x,e.y);f&&f.length?(t.path=f,t.pathIndex=0,t.pathGoal={x:e.x,y:e.y}):Math.random()<.05&&console.log(`Failed to compute path from (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) to (${e.x.toFixed(1)}, ${e.y.toFixed(1)})`),t.repath=2}if(!t.path||t.pathIndex==null||t.pathIndex>=t.path.length)return e?Math.hypot(t.x-e.x,t.y-e.y)<=s:!1;const a=t.path[t.pathIndex],n=a.x-t.x,h=a.y-t.y,c=Math.hypot(n,h);if(c<10)return t.pathIndex++,t.pathIndex>=t.path.length?(t.path=void 0,t.pathIndex=void 0,e?Math.hypot(t.x-e.x,t.y-e.y)<=s:!0):!1;let r=t.speed;{const f=Math.floor(t.x/y),d=Math.floor(t.y/y);if(f>=0&&d>=0&&f<this.grid.cols&&d<this.grid.rows){const w=d*this.grid.cols+f;this.grid.cost[w]<=.7&&(r*=1.125)}}return t.x+=n/(c||1)*r*i,t.y+=h/(c||1)*r*i,t.x=Math.max(0,Math.min(t.x,p.w)),t.y=Math.max(0,Math.min(t.y,p.h)),!1}findSafeTurret(t,i){let e=null,s=1/0;for(const l of this.buildings){if(l.kind!=="turret"||!l.done)continue;const a=this.centerOf(l),n=Math.hypot(t.x-a.x,t.y-a.y),h=Math.hypot(i.x-a.x,i.y-a.y),c=l.range||160,r=h<c?100:0,f=n+r;f<s&&(s=f,e=l)}return e}isProtectedByTurret(t){const i=this.centerOf(t);for(const e of this.buildings){if(e.kind!=="turret"||!e.done)continue;const s=e.range||120,l=this.centerOf(e);if(W(i,l)<s*s)return!0}return!1}centerOf(t){return{x:t.x+t.w/2,y:t.y+t.h/2}}pointInRect(t,i){return t.x>=i.x&&t.x<=i.x+i.w&&t.y>=i.y&&t.y<=i.y+i.h}updateTurret(t,i){if(!("range"in t)||!t.range)return;t.cooldown=Math.max(0,(t.cooldown||0)-i);let e=null,s=1e9;const l=this.centerOf(t);for(const a of this.enemies){const n=W(a,l);n<t.range*t.range&&n<s&&(s=n,e=a)}e&&(t.cooldown||0)<=0&&(e.hp-=t.dps||0,this.bullets.push({x:l.x,y:l.y,tx:e.x,ty:e.y,t:.12}),t.cooldown=t.fireRate||.6)}isNight(){return this.tDay>=ft.start||this.tDay<=ft.end}spawnWave(){const t=4+Math.floor(this.day*1.3);for(let i=0;i<t;i++)this.spawnEnemy();this.msg(`Night ${this.day}: Enemies incoming!`,"warn")}nextDay(){this.day++,this.waveSpawnedForDay=!1;let t=0;for(let s=0;s<this.colonists.length;s++)this.RES.food>0?this.RES.food-=1:(t++,this.colonists[s]&&(this.colonists[s].alive=!1));t>0&&(this.colonists=this.colonists.filter(s=>s.alive),this.msg(`${t} colonist(s) starved`,"bad"));for(const s of this.buildings)s.kind==="farm"&&s.done&&(s.growth=(s.growth||0)+.5,(s.growth||0)>=(s.growTime||1)&&(s.ready=!0));const i=this.buildings.find(s=>s.kind==="tent"&&s.done),e=(this.buildings.find(s=>s.kind==="hq")?3:0)+this.buildings.filter(s=>s.kind==="house"&&s.done).reduce((s,l)=>s+(l.popCap||0),0);i&&this.colonists.length<e&&this.RES.food>=15&&(this.RES.food-=15,this.spawnColonist({x:L.x+F(-20,20),y:L.y+F(-20,20)}),this.msg("A new colonist joined! (-15 food)","info")),this.day>8&&this.win()}dayTick(t){const i=this.isNight();this.tDay+=t*this.fastForward/this.dayLength,this.tDay>=1&&(this.tDay-=1,this.nextDay());const e=this.isNight();!i&&e&&this.spawnWave(),this.prevIsNight=e}keyPressed(t){return this.once.has(t)?(this.once.delete(t),!0):!1}update(t){if(this.keyPressed(" ")){this.paused=!this.paused;const e=document.getElementById("btnPause");e&&(e.textContent=this.paused?"Resume":"Pause")}if(this.keyPressed("h")){const e=document.getElementById("help");e&&(e.hidden=!e.hidden)}this.keyPressed("b")&&(this.showBuildMenu=!this.showBuildMenu),this.keyPressed("g")&&(this.debug.nav=!this.debug.nav,this.toast(this.debug.nav?"Debug: nav ON":"Debug: nav OFF")),this.keyPressed("escape")&&(this.showBuildMenu?this.showBuildMenu=!1:(this.selectedBuild=null,this.toast("Build canceled"),this.selColonist=null,this.follow=!1)),this.keyPressed("f")&&(this.fastForward=this.fastForward===1?6:1,this.toast(this.fastForward>1?"Fast-forward ON":"Fast-forward OFF"));const i=360*t/this.camera.zoom;if(this.keyState.w&&(this.camera.y-=i),this.keyState.s&&(this.camera.y+=i),this.keyState.a&&(this.camera.x-=i),this.keyState.d&&(this.camera.x+=i),(this.keyState["+"]||this.keyState["="])&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*1.02))),(this.keyState["-"]||this.keyState._)&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom/1.02))),!this.paused){for(const[e,s]of this.hotbar.entries())this.keyPressed(String(e+1))&&(this.selectedBuild=s,this.toast("Selected: "+D[s].name));if(this.follow&&this.selColonist){const e=this.selColonist,s=this.canvas.width/this.camera.zoom,l=this.canvas.height/this.camera.zoom;this.camera.x=$(e.x-s/2,0,Math.max(0,p.w-s)),this.camera.y=$(e.y-l/2,0,Math.max(0,p.h-l))}this.dayTick(t);for(const e of this.colonists)te(this,e,t*this.fastForward);for(let e=this.enemies.length-1;e>=0;e--){const s=this.enemies[e];ee(this,s,t*this.fastForward),s.hp<=0&&(this.enemies.splice(e,1),Math.random()<.5&&(this.RES.food+=1))}for(const e of this.buildings){if(e.kind==="turret"&&e.done&&this.updateTurret(e,t*this.fastForward),e.healRate&&e.done){const s=e.healRate,l=e.healRange||120,a=this.centerOf(e);for(const n of this.colonists)(n.x-a.x)*(n.x-a.x)+(n.y-a.y)*(n.y-a.y)<l*l&&(n.hp=Math.min(100,n.hp+s*t*this.fastForward))}if(e.kind==="tent"&&e.done&&(e.cooldown=(e.cooldown||0)-t*this.fastForward,e.cooldown<=0&&this.RES.food>=15)){const s=this.getPopulationCap();if(this.colonists.length<s){this.RES.food-=15;const l=this.centerOf(e);this.spawnColonist({x:l.x+(Math.random()-.5)*40,y:l.y+(Math.random()-.5)*40}),this.msg("Recruit tent attracted a new colonist! (-15 food)","good"),e.cooldown=60}}}this.tryRespawn(t);for(let e=this.bullets.length-1;e>=0;e--){const s=this.bullets[e];s.t-=t,s.t<=0&&this.bullets.splice(e,1)}for(let e=this.messages.length-1;e>=0;e--){const s=this.messages[e];s.t-=t,s.t<=0&&this.messages.splice(e,1)}}}draw(){const{ctx:t}=this;Ht(t,this.canvas),t.save(),Xt(t,this.camera),Gt(t);for(const n of this.trees)at(t,n.x,n.y,n.r,A.tree);for(const n of this.rocks)at(t,n.x,n.y,n.r,A.rock);for(const n of this.buildings)if($t(t,n),(n.kind==="house"||n.kind==="hq")&&this.buildings.some(c=>c.kind==="turret"&&c.done&&W(this.centerOf(n),this.centerOf(c))<(c.range||120)*(c.range||120))){const c=this.centerOf(n);Ut(t,c.x,n.y-8,12,"#60a5fa")}{const n=new Map;for(const h of this.colonists)h.inside&&n.set(h.inside,(n.get(h.inside)||0)+1);t.save();for(const[h,c]of n){if(!c)continue;const r=8,f=Math.min(c,r),d=10,u=4,w=f*(d+u)-u;let v=h.x+h.w/2-w/2+d/2;const M=h.y+h.h+8,B=this.colonists.filter(m=>m.inside===h);for(let m=0;m<f;m++){const k=B[m%B.length],b=k?k.hp:100,x=b>66?"#22c55e":b>33?"#eab308":"#ef4444";yt(t,v+m*(d+u),M,10,x)}if(c>r){const m=c-r,k=v+f*(d+u)+6;t.fillStyle="#dbeafe",t.font="600 11px system-ui,Segoe UI,Roboto",t.fillText("+"+m,k,M+4)}}t.restore()}for(const n of this.colonists)n.inside||at(t,n.x,n.y,n.r,this.selColonist===n?"#93c5fd":A.colonist);if(this.debug.nav){t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444";for(let n=0;n<this.grid.rows;n++)for(let h=0;h<this.grid.cols;h++)this.grid.solid[n*this.grid.cols+h]&&t.fillRect(h*y,n*y,y,y);t.restore(),t.save(),t.globalAlpha=.12;for(let n=0;n<this.grid.rows;n++)for(let h=0;h<this.grid.cols;h++){const c=n*this.grid.cols+h;if(!this.grid.solid[c]){const r=this.grid.cost[c];r<=.7?t.fillStyle="#22c55e":r<=1?t.fillStyle="#eab308":t.fillStyle="#f97316",t.fillRect(h*y,n*y,y,y)}}t.restore(),t.save(),t.strokeStyle="#22d3ee",t.lineWidth=2;for(const n of this.colonists)if(!(!n.path||!n.path.length)){t.beginPath(),t.moveTo(n.x,n.y);for(let h=n.pathIndex??0;h<n.path.length;h++){const c=n.path[h];t.lineTo(c.x,c.y)}if(t.stroke(),n.pathIndex!=null&&n.pathIndex<n.path.length){const h=n.path[n.pathIndex];t.save(),t.fillStyle="#fbbf24",t.beginPath(),t.arc(h.x,h.y,6,0,Math.PI*2),t.fill(),t.restore()}}t.restore(),t.save(),t.font="11px monospace",t.fillStyle="#ffffff",t.strokeStyle="#000000",t.lineWidth=2;for(const n of this.colonists){if(n.inside)continue;const h=`${n.task||n.state||"idle"}`,c=n.x-20,r=n.y-n.r-8;if(t.strokeText(h,c,r),t.fillText(h,c,r),n.target&&n.target.x!=null){const f=n.target;t.save(),t.strokeStyle="#94a3b8",t.lineWidth=1,t.setLineDash([3,3]),t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(f.x,f.y),t.stroke(),t.setLineDash([]),t.restore()}}t.restore()}for(const n of this.enemies)qt(t,n.x,n.y,n.r+2,3,A.enemy,-Math.PI/2);if(jt(t,this.bullets),this.isNight()&&(t.fillStyle="rgba(6,10,18, 0.58)",t.fillRect(0,0,p.w,p.h)),this.selectedBuild){const n=D[this.selectedBuild],h=Math.floor(this.mouse.wx/y)*y,c=Math.floor(this.mouse.wy/y)*y,r=this.canPlace({...n,size:n.size},h,c)&&_(this.RES,n.cost);t.globalAlpha=.6,t.fillStyle=r?A.ghost:"#ff6b6b88",t.fillRect(h,c,n.size.w*y,n.size.h*y),t.globalAlpha=1}if(this.mouse.rdown&&this.eraseDragStart){const n=Math.min(this.eraseDragStart.x,this.mouse.wx),h=Math.min(this.eraseDragStart.y,this.mouse.wy),c=Math.abs(this.mouse.wx-this.eraseDragStart.x),r=Math.abs(this.mouse.wy-this.eraseDragStart.y);t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444",t.fillRect(n,h,c,r),t.globalAlpha=1,t.strokeStyle="#ef4444",t.setLineDash([6,4]),t.strokeRect(n+.5,h+.5,c-1,r-1),t.setLineDash([]),t.restore()}t.restore();const i=this.getPopulationCap(),e=this.colonists.filter(n=>!!n.inside).length,s=this.RES.wood+this.RES.stone+this.RES.food,l=this.getStorageCapacity(),a=this.hotbar.map(n=>({key:String(n),name:D[n].name,cost:this.costText(D[n].cost||{}),selected:this.selectedBuild===n}));Vt(this.ctx,this.canvas,{res:this.RES,colonists:this.colonists.length,cap:i,hiding:e,day:this.day,tDay:this.tDay,isNight:this.isNight(),hotbar:a,messages:this.messages,storage:{used:s,max:l}},this),this.selColonist&&this.drawColonistProfile(this.selColonist),this.showBuildMenu&&this.drawBuildMenu(),this.pendingPlacement&&this.drawPlacementUI()}costText(t){const i=[];return t.wood&&i.push(`${t.wood}w`),t.stone&&i.push(`${t.stone}s`),t.food&&i.push(`${t.food}f`),i.join(" ")}win(){this.paused=!0,this.msg("You survived! Day 8 reached.","good"),alert("You survived to Day 8 — victory!")}lose(){this.paused=!0,this.msg("HQ destroyed. Colony fell.","bad"),alert("Your HQ was destroyed. Game over.")}rebuildNavGrid(){Wt(this.grid);for(const t of this.buildings)t.kind!=="hq"&&t.kind!=="path"&&t.kind!=="house"&&Ot(this.grid,t.x,t.y,t.w,t.h),t.kind==="path"&&Lt(this.grid,t.x,t.y,t.w,t.h,.6)}computePath(t,i,e,s){return zt(this.grid,t,i,e,s)}cellIndexAt(t,i){const e=Math.floor(t/y),s=Math.floor(i/y);return e<0||s<0||e>=this.grid.cols||s>=this.grid.rows?-1:s*this.grid.cols+e}isBlocked(t,i){const e=this.cellIndexAt(t,i);return e<0?!0:!!this.grid.solid[e]}isBlockedByResources(t,i,e){for(const s of this.trees){if(e&&s===e)continue;const l=t-s.x,a=i-s.y;if(l*l+a*a<=s.r*s.r)return!0}for(const s of this.rocks){if(e&&s===e)continue;const l=t-s.x,a=i-s.y;if(l*l+a*a<=s.r*s.r)return!0}return!1}bestApproachToCircle(t,i,e){let s=null,l=1/0;const a=16;for(let c=0;c<a;c++){const r=c/a*Math.PI*2,f=i.x-Math.cos(r)*(e-6),d=i.y-Math.sin(r)*(e-6);if(this.isBlocked(f,d)||this.isBlockedByResources(f,d,i))continue;const u=(t.x-f)*(t.x-f)+(t.y-d)*(t.y-d);u<l&&(l=u,s={x:f,y:d})}if(s)return Math.random()<.02&&console.log(`Approach point found: (${s.x.toFixed(1)}, ${s.y.toFixed(1)}) for resource at (${i.x.toFixed(1)}, ${i.y.toFixed(1)})`),s;const n=Math.atan2(i.y-t.y,i.x-t.x),h={x:i.x-Math.cos(n)*(e-6),y:i.y-Math.sin(n)*(e-6)};return Math.random()<.02&&console.log(`Using fallback approach point: (${h.x.toFixed(1)}, ${h.y.toFixed(1)}) for resource at (${i.x.toFixed(1)}, ${i.y.toFixed(1)})`),h}drawColonistProfile(t){const i=this.ctx,e=this.canvas.width,s=this.canvas.height,l=Math.min(this.scale(320),e*.4),a=Math.min(this.scale(200),s*.35),n=this.scale(12),h=e-l-n,c=this.scale(54),r=Math.min(c,s-a-n);i.save(),i.fillStyle="#0b1220cc",i.fillRect(h,r,l,a),i.strokeStyle="#1e293b",i.strokeRect(h+.5,r+.5,l-1,a-1);const f=this.scale(64),d=h+this.scale(18),u=r+this.scale(26);i.fillStyle="#0f172a",i.fillRect(d,u,f,f),i.strokeStyle="#1e293b",i.strokeRect(d+.5,u+.5,f-1,f-1),i.save(),i.translate(d+f/2,u+f/2+this.scale(4)),i.scale(this.uiScale*2,this.uiScale*2),yt(i,0,0,10,"#93c5fd"),i.restore(),i.fillStyle="#dbeafe",i.font=this.getScaledFont(14,"600"),i.fillText("Colonist",h+f+this.scale(32),r+this.scale(22)),i.font=this.getScaledFont(13);const w=t.inside?"Resting":t.task?t.task:"Idle",v=Math.max(0,Math.min(100,t.hp|0)),M=Math.max(0,Math.min(100,(t.fatigue||0)|0)),B=Math.max(0,Math.min(100,(t.hunger||0)|0)),m=h+f+this.scale(32);let k=r+this.scale(45);const b=this.scale(24);this.barRow(m,k,"Health",v,"#22c55e"),k+=b,this.barRow(m,k,"Tiredness",M,"#eab308"),k+=b,this.barRow(m,k,"Hunger",B,"#f87171"),k+=b,i.fillStyle="#9fb3c8",i.fillText(`Task: ${w}`,m,k+this.scale(12)),k+=this.scale(18),i.fillText(`Pos: ${t.x|0}, ${t.y|0}`,m,k),k+=this.scale(18),i.fillText(this.follow?"Camera: Following (Esc to stop)":"Camera: Click colonist to follow",m,Math.min(k,r+a-this.scale(8))),i.restore()}barRow(t,i,e,s,l){const a=this.ctx;a.fillStyle="#dbeafe",a.fillText(e,t,i);const n=this.scale(140),h=this.scale(10),c=this.scale(70);a.fillStyle="#0f172a",a.fillRect(t+c,i-this.scale(8),n,h),a.strokeStyle="#1e293b",a.strokeRect(t+c+.5,i-this.scale(8)+.5,n-1,h-1),a.fillStyle=l,a.fillRect(t+c+this.scale(2),i-this.scale(6),Math.max(0,Math.min(n-this.scale(4),s/100*(n-this.scale(4)))),h-this.scale(4))}drawBuildMenu(){const t=this.ctx,i=this.canvas.width,e=this.canvas.height,s=this.isTouch?980:860,l=this.isTouch?720:620,a=this.isTouch?28:40,n=this.isTouch?60:80,h=Math.min(this.scale(s),i-this.scale(a)),c=Math.min(this.scale(l),e-this.scale(n)),r=(i-h)/2,f=(e-c)/2;t.save(),t.fillStyle="#0b1628dd",t.fillRect(r,f,h,c),t.strokeStyle="#1e293b",t.strokeRect(r+.5,f+.5,h-1,c-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(this.isTouch?22:18,"600"),t.fillText("Build Menu (B to close)",r+this.scale(14),f+this.scale(24));const d=Nt(D),u=Object.keys(d),w=this.scale(this.isTouch?36:28),v=Math.floor((h-w)/Math.max(1,u.length));this.menuRects=[];let M=null;for(let k=0;k<u.length;k++){const b=r+this.scale(12)+k*v;let x=f+this.scale(50);const P=u[k];t.fillStyle="#93c5fd",t.font=this.getScaledFont(this.isTouch?18:15,"600"),t.fillText(P,b,x),x+=this.scale(this.isTouch?12:8);const Y=d[P];for(const[S,C]of Y){x+=this.scale(this.isTouch?12:8);const E=this.scale(this.isTouch?78:58),I=v-this.scale(18),T=b,R=x,O=this.mouse.x*this.DPR,Z=this.mouse.y*this.DPR,j=O>=T&&O<=T+I&&Z>=R&&Z<=R+E;t.fillStyle=this.selectedBuild===S?"#102034":j?"#1a1f2e":"#0f172a",t.fillRect(T,R,I,E),t.strokeStyle=this.selectedBuild===S?"#4b9fff":j?"#3b82f6":"#1e293b",t.strokeRect(T+.5,R+.5,I-1,E-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(this.isTouch?18:15,"600"),t.fillText(C.name,T+this.scale(10),R+this.scale(this.isTouch?22:18));const V=this.costText(C.cost||{});t.fillStyle="#9fb3c8",t.font=this.getScaledFont(this.isTouch?14:12);const K=Math.min(this.scale(this.isTouch?120:100),t.measureText(V).width+this.scale(4));if(t.fillText(V,T+I-K,R+this.scale(this.isTouch?22:18)),C.description){t.fillStyle="#94a3b8",t.font=this.getScaledFont(this.isTouch?14:12);const et=I-this.scale(18);let Q=C.description;for(;t.measureText(Q).width>et&&Q.length>10;)Q=Q.substring(0,Q.length-4)+"...";t.fillText(Q,T+this.scale(10),R+this.scale(this.isTouch?46:36))}if(j&&C.description&&(M={key:S,desc:C.description}),this.menuRects.push({key:S,x:T,y:R,w:I,h:E}),x+=E,x>f+c-this.scale(this.isTouch?90:70))break}}if(M){const k=this.scale(this.isTouch?16:14),b=this.scale(this.isTouch?420:360);t.font=this.getScaledFont(this.isTouch?16:14);const x=this.wrapText(M.desc,b-k*2),P=this.scale(this.isTouch?20:18),Y=x.length*P+k*2,S=this.mouse.x*this.DPR,C=this.mouse.y*this.DPR;let E=S+this.scale(20),I=C-Y-this.scale(10);E+b>i&&(E=S-b-this.scale(20)),I<0&&(I=C+this.scale(20)),t.fillStyle="#0f1419f0",t.fillRect(E,I,b,Y),t.strokeStyle="#374151",t.strokeRect(E+.5,I+.5,b-1,Y-1),t.fillStyle="#e5e7eb";for(let T=0;T<x.length;T++)t.fillText(x[T],E+k,I+k+(T+1)*P-this.scale(4))}t.fillStyle="#9fb3c8",t.font=this.getScaledFont(this.isTouch?16:14);const B="Click a building to select • Hover for details • Press B to close",m=t.measureText(B).width;t.fillText(B,(i-m)/2,f+c+this.scale(this.isTouch?30:24)),t.restore()}wrapText(t,i){const e=this.ctx,s=t.split(" "),l=[];let a="";for(const n of s){const h=a+(a?" ":"")+n;e.measureText(h).width<=i?a=h:(a&&l.push(a),a=n)}return a&&l.push(a),l}handleBuildMenuClick(){const t=this.mouse.x*this.DPR,i=this.mouse.y*this.DPR;for(const e of this.menuRects)if(t>=e.x&&t<=e.x+e.w&&i>=e.y&&i<=e.y+e.h){this.selectedBuild=e.key,this.showBuildMenu=!1,this.toast("Selected: "+D[e.key].name);return}this.showBuildMenu=!1}drawPlacementUI(){const t=this.pendingPlacement;if(!t)return;const i=D[t.key],e=this.ctx,s=i.size.w*y,l=i.size.h*y;e.save(),e.globalAlpha=.6,e.fillStyle=A.ghost,e.fillRect(t.x,t.y,s,l),e.globalAlpha=1,e.strokeStyle="#4b9fff",e.setLineDash([4,3]),e.strokeRect(t.x+.5,t.y+.5,s-1,l-1),e.setLineDash([]),e.restore();const a=this.scale(10),n=this.scale(38),h=t.x+s+a,c=t.y,r=(u,w,v)=>({id:u,x:w,y:v,w:n,h:n}),f=[r("up",h+n,c),r("left",h,c+n),r("right",h+n*2,c+n),r("down",h+n,c+n*2),r("cancel",h,c+n*3+this.scale(4)),r("ok",h+n*2,c+n*3+this.scale(4))];this.placeUIRects=f,e.save(),e.fillStyle="#0f172aee",e.strokeStyle="#1e293b";const d=(u,w)=>{e.fillRect(u.x,u.y,u.w,u.h),e.strokeRect(u.x+.5,u.y+.5,u.w-1,u.h-1),e.fillStyle="#dbeafe",e.font=this.getScaledFont(18,"600"),e.textAlign="center",e.textBaseline="middle",e.fillText(w,u.x+u.w/2,u.y+u.h/2+this.scale(2)),e.fillStyle="#0f172aee"};for(const u of f)u.id==="up"?d(u,"↑"):u.id==="down"?d(u,"↓"):u.id==="left"?d(u,"←"):u.id==="right"?d(u,"→"):u.id==="ok"?d(u,"OK"):u.id==="cancel"&&d(u,"X");e.restore()}}const z=document.getElementById("game"),rt=document.getElementById("btnPause"),ie=document.getElementById("btnHelp"),G=document.getElementById("btnMenu"),N=document.getElementById("headerDropdown"),gt=document.getElementById("hd-new"),pt=document.getElementById("hd-help"),wt=document.getElementById("hd-build"),xt=document.getElementById("hd-toggle-mobile"),oe=document.getElementById("btnNew"),H=document.getElementById("help"),mt=document.getElementById("mobileControls"),kt=document.getElementById("mc-build"),Mt=document.getElementById("mc-cancel"),bt=document.getElementById("mc-erase"),Tt=document.getElementById("mc-pause"),St=document.getElementById("mc-ff"),vt=document.getElementById("mc-zoom-in"),Bt=document.getElementById("mc-zoom-out");H&&(H.innerHTML=`
    <h2>How to play</h2>
    <div><b>Goal:</b> Gather wood & stone, build farms for food, add houses for pop cap; survive nightly raids with turrets/walls.</div>
  <div><b>Controls:</b> 1..9 quick-build, <b>B</b> build menu, LMB place, RMB cancel/erase; WASD pan; Space pause; H toggle help; +/- zoom; F fast-forward.</div>
  `);async function ne(){const o=z.getContext("2d");o&&(o.fillStyle="#0a0e14",o.fillRect(0,0,z.width,z.height),o.fillStyle="#dbeafe",o.font="24px system-ui",o.textAlign="center",o.fillText("Loading assets...",z.width/2,z.height/2));try{await J.getInstance().loadAssets(),console.log("Assets loaded successfully"),console.log("House image loaded:",!!J.getInstance().getImage("house"))}catch(l){console.warn("Some assets failed to load:",l)}const t=new se(z);rt.onclick=()=>{t.paused=!t.paused,rt.textContent=t.paused?"Resume":"Pause"},oe.onclick=()=>{t.newGame()},ie.onclick=()=>{H&&(H.hidden=!H.hidden)},Object.assign(window,{game:t,BUILD_TYPES:D});const i="ontouchstart"in window||navigator.maxTouchPoints>0;if(i&&mt){const l=a=>{window._mobileUI=a,mt.hidden=!a,G&&(G.hidden=!a)};l(!0),G&&(G.hidden=!1),G&&N&&(G.onclick=()=>{N.hidden=!N.hidden},gt&&(gt.onclick=()=>{N.hidden=!0,t.newGame()}),pt&&(pt.onclick=()=>{N.hidden=!0,H&&(H.hidden=!H.hidden)}),wt&&(wt.onclick=()=>{N.hidden=!0,t.showBuildMenu=!t.showBuildMenu}),xt&&(xt.onclick=()=>{N.hidden=!0,l(!window._mobileUI),t.toast(window._mobileUI?"Mobile UI: ON":"Mobile UI: OFF")}),document.addEventListener("click",a=>{if(!N)return;const n=a.target;n&&!N.contains(n)&&n!==G&&(N.hidden=!0)})),kt&&(kt.onclick=()=>{t.showBuildMenu=!t.showBuildMenu}),Mt&&(Mt.onclick=()=>{t.selectedBuild=null,t.toast("Build canceled")}),bt&&(bt.onclick=()=>{window._eraseOnce=!0,t.toast("Erase mode: tap on a building to remove")}),Tt&&(Tt.onclick=()=>{t.paused=!t.paused,rt.textContent=t.paused?"Resume":"Pause"}),St&&(St.onclick=()=>{t.fastForward=t.fastForward===1?6:1,t.toast(t.fastForward>1?"Fast-forward ON":"Fast-forward OFF")}),vt&&(vt.onclick=()=>{t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom*1.1))}),Bt&&(Bt.onclick=()=>{t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom/1.1))})}let e=null,s=null;z.addEventListener("touchstart",l=>{if(l.preventDefault(),!!i){if(l.touches.length===1)s={x:l.touches[0].clientX,y:l.touches[0].clientY};else if(l.touches.length===2){const a=l.touches[0].clientX-l.touches[1].clientX,n=l.touches[0].clientY-l.touches[1].clientY;e=Math.hypot(a,n)}}},{passive:!1}),z.addEventListener("touchmove",l=>{if(l.preventDefault(),!!i){if(l.touches.length===1&&s){const a=l.touches[0].clientX,n=l.touches[0].clientY,h=a-s.x,c=n-s.y;s={x:a,y:n},t.camera.x-=h*(1/t.camera.zoom)*t.DPR,t.camera.y-=c*(1/t.camera.zoom)*t.DPR}else if(l.touches.length===2){const a=l.touches[0].clientX-l.touches[1].clientX,n=l.touches[0].clientY-l.touches[1].clientY,h=Math.hypot(a,n);if(e!=null){const c=h/(e||h);t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom*c))}e=h}}},{passive:!1}),z.addEventListener("touchend",l=>{if(l.preventDefault(),!i)return;const a=window._eraseOnce;if(a&&l.changedTouches.length===1){window._eraseOnce=!1;const n=z.getBoundingClientRect(),h=l.changedTouches[0].clientX-n.left,c=l.changedTouches[0].clientY-n.top,r=t.screenToWorld(h,c);for(let f=t.buildings.length-1;f>=0;f--){const d=t.buildings[f];if(d.kind!=="hq"&&r.x>=d.x&&r.x<=d.x+d.w&&r.y>=d.y&&r.y<=d.y+d.h){t.evictColonistsFrom(d),t.buildings.splice(f,1),t.msg("Building removed"),t.rebuildNavGrid();break}}}if(!a&&l.changedTouches.length===1){const n=z.getBoundingClientRect(),h=l.changedTouches[0].clientX-n.left,c=l.changedTouches[0].clientY-n.top;t.handleTapOrClickAtScreen(h,c)}l.touches.length===0&&(s=null,e=null)},{passive:!1})}ne();
