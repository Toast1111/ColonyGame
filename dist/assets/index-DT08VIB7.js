var xt=Object.defineProperty;var wt=(i,t,e)=>t in i?xt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var k=(i,t,e)=>wt(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}})();const Y=(i,t)=>Math.random()*(t-i)+i,mt=(i,t)=>Math.floor(Y(i,t)),N=(i,t,e)=>Math.max(t,Math.min(e,i)),W=(i,t)=>{const e=i.x-t.x,s=i.y-t.y;return e*e+s*s},kt=i=>Math.hypot(i.x,i.y),ut=i=>{const t=kt(i)||1;return{x:i.x/t,y:i.y/t}},yt=(i,t)=>({x:i.x-t.x,y:i.y-t.y}),u=32,M={w:240*u,h:240*u},L={x:M.w/2,y:M.h/2},E={sky:"#0a0e14",ground:"#0e161f",colonist:"#c7f9cc",enemy:"#ff9aa2",tree:"#6fbf73",rock:"#9aa5b1",ghost:"#6ee7ff",wall:"#9aa5b1",bld:"#93c5fd",turret:"#93c5fd",farm:"#8bd3dd",house:"#e2b714",stock:"#c084fc",tent:"#f59e0b"},rt={start:.72,end:.07};function Mt(){const i=Math.ceil(M.w/u),t=Math.ceil(M.h/u);return{cols:i,rows:t,solid:new Uint8Array(i*t),cost:new Float32Array(i*t).fill(1)}}function bt(i){i.solid.fill(0),i.cost.fill(1)}function St(i,t,e,s,o){const a=Math.floor(t/u),h=Math.floor(e/u),n=Math.ceil(s/u),l=Math.ceil(o/u);for(let r=0;r<l;r++)for(let c=0;c<n;c++){const d=a+c,f=h+r;d<0||f<0||d>=i.cols||f>=i.rows||(i.solid[f*i.cols+d]=1)}}function Tt(i,t,e,s,o,a){const h=Math.floor(t/u),n=Math.floor(e/u),l=Math.ceil(s/u),r=Math.ceil(o/u);for(let c=0;c<r;c++)for(let d=0;d<l;d++){const f=h+d,y=n+c;if(f<0||y<0||f>=i.cols||y>=i.rows)continue;const g=y*i.cols+f;i.cost[g]=Math.min(i.cost[g],a)}}function ct(i,t,e,s){return Math.abs(i-e)+Math.abs(t-s)}function vt(i,t,e,s,o){const a=i.cols,h=i.rows,n={x:Math.floor(t/u),y:Math.floor(e/u)},l={x:Math.floor(s/u),y:Math.floor(o/u)},r=(T,R)=>R*a+T;if(n.x===l.x&&n.y===l.y)return[{x:s,y:o}];const c=[],d=new Int32Array(a*h).fill(-1),f=new Int32Array(a*h).fill(1e9),y=new Int32Array(a*h).fill(1e9),g=(T,R)=>{const A=r(T,R);c.push(A)},w=()=>{let T=0,R=1e9;for(let v=0;v<c.length;v++){const I=y[c[v]];I<R&&(R=I,T=v)}return c.splice(T,1)[0]},p=(T,R)=>T>=0&&R>=0&&T<a&&R<h,x=r(n.x,n.y),S=r(l.x,l.y),m=(T,R)=>{if(!p(T,R))return!1;const A=r(T,R);return A===x||A===S?!0:i.solid[A]===0};f[x]=0,y[x]=ct(n.x,n.y,l.x,l.y),g(n.x,n.y);const b=[[1,0],[-1,0],[0,1],[0,-1]];for(;c.length;){const T=w(),R=T%a,A=T/a|0;if(R===l.x&&A===l.y){let v=[],I=T;for(;I!==-1;){const C=I%a,z=I/a|0;v.push({x:C*u+u/2,y:z*u+u/2}),I=d[I]}v.reverse(),v[v.length-1]={x:s,y:o};const D=[],F=(C,z,Z,U)=>{const j=Z-C,K=U-z,_=Math.hypot(j,K)||1,Q=Math.max(6,u*.33),at=Math.ceil(_/Q);for(let tt=1;tt<at;tt++){const ht=tt/at,gt=C+j*ht,pt=z+K*ht,et=Math.floor(gt/u),st=Math.floor(pt/u);if(et<0||st<0||et>=i.cols||st>=i.rows||i.solid[st*i.cols+et])return!1}return!0};let P=0;for(;P<v.length;){D.push(v[P]);let C=P+2,z=P+1;for(;C<v.length&&F(v[P].x,v[P].y,v[C].x,v[C].y);)z=C,C++;P=z}return D.length>=2&&(v=D),v}for(const[v,I]of b){const D=R+v,F=A+I;if(!m(D,F))continue;const P=r(D,F),C=i.cost[P]||1,z=f[T]+C;z<f[P]&&(d[P]=T,f[P]=z,y[P]=z+ct(D,F,l.x,l.y),c.includes(P)||c.push(P))}}return null}const B={house:{category:"Housing",name:"House",description:"Provides shelter for 2 colonists. Colonists can rest inside to recover fatigue.",key:"1",cost:{wood:20,stone:5},hp:220,size:{w:2,h:2},build:100,color:E.house,popCap:2},farm:{category:"Production",name:"Farm",description:"Grows crops that colonists can harvest for food. Takes 2 days to grow.",key:"2",cost:{wood:15},hp:120,size:{w:2,h:2},build:80,color:E.farm,growTime:1},turret:{category:"Defense",name:"Turret",description:"Automated defense structure. Shoots at enemies within range.",key:"3",cost:{wood:10,stone:20},hp:160,size:{w:1,h:1},build:120,color:E.turret,range:190,fireRate:.6,dps:30},wall:{category:"Defense",name:"Wall",description:"Blocks enemy movement. Essential for creating defensive perimeters.",key:"4",cost:{wood:5,stone:5},hp:150,size:{w:1,h:1},build:40,color:E.wall},stock:{category:"Utility",name:"Stockpile",description:"Increases resource storage capacity by 100. Colonists will store materials here.",key:"5",cost:{wood:10},hp:140,size:{w:2,h:2},build:60,color:E.stock,storageBonus:100},tent:{category:"Utility",name:"Recruit Tent",description:"Attracts new colonists every 60 seconds. Requires 15 food per recruit.",key:"6",cost:{wood:30,food:10},hp:140,size:{w:2,h:2},build:80,color:E.tent},warehouse:{category:"Utility",name:"Warehouse",description:"Large storage facility. Increases resource capacity by 300.",key:"7",cost:{wood:40,stone:20},hp:260,size:{w:3,h:2},build:160,color:E.stock,storageBonus:300},well:{category:"Production",name:"Well",description:"Provides clean water. Colonists can collect water here for food production.",key:"8",cost:{stone:25},hp:160,size:{w:1,h:1},build:80,color:E.farm},infirmary:{category:"Utility",name:"Infirmary",description:"Heals injured colonists within range. Essential for colony survival.",key:"9",cost:{wood:30,stone:20,food:10},hp:200,size:{w:2,h:2},build:140,color:E.bld,healRate:3,healRange:140,popCap:2},path:{category:"Utility",name:"Path",description:"Improves colonist movement speed by 50%. Cheap way to optimize traffic flow.",key:"0",cost:{wood:0},hp:1,size:{w:1,h:1},build:5,color:"#475569",speedBonus:1.5}};function q(i,t){if(!t)return!0;for(const e of Object.keys(t))if((i[e]||0)<(t[e]||0))return!1;return!0}function it(i,t){if(t)for(const e of Object.keys(t))i[e]-=t[e]||0}function ot(i,t,e){const s=B[i],o=Math.floor(t/u)*u,a=Math.floor(e/u)*u;return{kind:i,...s,x:o,y:a,w:s.size.w*u,h:s.size.h*u,hp:s.hp,buildLeft:s.build,done:!1,growth:0,ready:!1,cooldown:0}}function Pt(i){const t={};for(const e of Object.keys(i)){const s=i[e],o=s.category||"Other";(t[o]||(t[o]=[])).push([e,s])}for(const e of Object.keys(t))t[e].sort((s,o)=>s[1].name.localeCompare(o[1].name));return t}const Rt="data:image/png;base64,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",X=class X{constructor(){k(this,"images",new Map);k(this,"loaded",!1)}static getInstance(){return X.instance||(X.instance=new X),X.instance}async loadAssets(){const e=[{name:"house",path:Rt}].map(s=>this.loadImage(s.name,s.path));try{await Promise.all(e),this.loaded=!0}catch{console.warn("Some assets failed to load, continuing with fallbacks"),this.loaded=!0}}loadImage(t,e){return new Promise((s,o)=>{const a=new Image;a.onload=()=>{this.images.set(t,a),console.log(`Loaded image: ${t}`),s()},a.onerror=()=>{console.warn(`Failed to load image: ${t} from ${e}`),o(new Error(`Failed to load ${t}`))},a.src=e})}getImage(t){return this.images.get(t)||null}isLoaded(){return this.loaded}};k(X,"instance");let J=X;function At(i,t){i.setTransform(1,0,0,1,0,0),i.fillStyle=E.sky,i.fillRect(0,0,t.width,t.height)}function Ct(i,t){i.translate(-t.x*t.zoom,-t.y*t.zoom),i.scale(t.zoom,t.zoom)}function Bt(i){i.fillStyle=E.ground,i.fillRect(0,0,M.w,M.h),i.globalAlpha=.08,i.strokeStyle="#d6e4ff",i.lineWidth=1,i.beginPath();for(let t=0;t<=M.w;t+=u)i.moveTo(t,0),i.lineTo(t,M.h);for(let t=0;t<=M.h;t+=u)i.moveTo(0,t),i.lineTo(M.w,t);i.stroke(),i.globalAlpha=1}function nt(i,t,e,s,o){i.fillStyle=o,i.beginPath(),i.arc(t,e,s,0,Math.PI*2),i.fill()}function Et(i,t,e,s,o,a,h=0){i.fillStyle=a,i.beginPath();for(let n=0;n<o;n++){const l=h+n*2*Math.PI/o,r=t+Math.cos(l)*s,c=e+Math.sin(l)*s;n===0?i.moveTo(r,c):i.lineTo(r,c)}i.closePath(),i.fill()}function dt(i,t,e,s=10,o=E.colonist){i.save(),i.translate(t,e);const a="#0b0f14",h=s*.32,n=-s*.3;i.fillStyle=o,i.beginPath(),i.arc(0,n,h,0,Math.PI*2),i.fill(),i.strokeStyle=a,i.lineWidth=1,i.beginPath(),i.arc(0,n,h+.5,0,Math.PI*2),i.stroke();const l=s*.55,r=s*.55,c=-s*.05;i.fillStyle=o,i.beginPath(),i.moveTo(-l/2,c-r/2),i.lineTo(l/2,c-r/2),i.lineTo(l/2,c+r/2),i.lineTo(-l/2,c+r/2),i.closePath(),i.fill(),i.strokeStyle=a,i.stroke();const d=s*.18,f=s*.5,y=c+r/2+f*.1;i.fillStyle=o,i.fillRect(-d-.6,y-f,d,f),i.fillRect(.6,y-f,d,f),i.strokeStyle=a,i.strokeRect(-d-.6,y-f,d,f),i.strokeRect(.6,y-f,d,f),i.restore()}function It(i,t,e,s=12,o="#60a5fa"){i.save(),i.translate(t,e),i.fillStyle=o,i.strokeStyle="#0b0f14",i.lineWidth=1,i.beginPath();const a=s,h=s*1.2;i.moveTo(0,-h*.5),i.lineTo(a*.35,-h*.25),i.lineTo(a*.35,h*.1),i.quadraticCurveTo(0,h*.55,-a*.35,h*.1),i.lineTo(-a*.35,-h*.25),i.closePath(),i.fill(),i.stroke(),i.restore()}function Dt(i,t){if(t.kind==="path"){i.fillStyle="#1f2937",i.fillRect(t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1);return}if(t.kind==="house"){const e=J.getInstance(),s=e.getImage("house");s&&e.isLoaded()?(i.drawImage(s,t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1)):(i.fillStyle=t.color,i.fillRect(t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1))}else i.fillStyle=t.color,i.fillRect(t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1);if(!t.done){i.fillStyle="#0b1220",i.fillRect(t.x,t.y-6,t.w,4),i.fillStyle="#6ee7ff";const e=1-t.buildLeft/t.build;i.fillRect(t.x,t.y-6,e*t.w,4)}if(t.kind!=="house"){i.fillStyle="#0b0f14aa",i.font="bold 12px system-ui";const e=t.x+t.w/2,s=t.y+t.h/2;let o="B";t.kind==="hq"?o="HQ":t.kind==="farm"?o=t.ready?"F*":"F":t.kind==="turret"?o="T":t.kind==="wall"?o="W":t.kind==="stock"?o="S":t.kind==="tent"?o="R":t.kind==="warehouse"?o="WH":t.kind==="well"?o="WL":t.kind==="infirmary"&&(o="I"),i.textAlign="center",i.textBaseline="middle",i.fillText(o,e,s)}if(t.kind==="turret"&&t.range){const e=t.x+t.w/2,s=t.y+t.h/2;i.globalAlpha=.07,i.fillStyle="#e2f3ff",i.beginPath(),i.arc(e,s,t.range,0,Math.PI*2),i.fill(),i.globalAlpha=1}}function Ft(i,t){for(const e of t)i.globalAlpha=.8,i.strokeStyle="#e0f2fe",i.lineWidth=2,i.beginPath(),i.moveTo(e.x,e.y),i.lineTo(e.tx,e.ty),i.stroke(),i.globalAlpha=1}function Yt(i,t,e,s){s.uiScale;const o=s.scale(10),a=s.scale(34),h=t.width;i.fillStyle="#0b122088",i.fillRect(0,0,h,a),i.strokeStyle="#1e293b",i.lineWidth=1,i.strokeRect(0,.5,h,a),i.fillStyle="#dbeafe",i.font=s.getScaledFont(14,"600");let n=o;const l=s.scale(140);if(H(i,n,s.scale(8),`Wood: ${Math.floor(e.res.wood)}`,"#b08968",s),n+=l,H(i,n,s.scale(8),`Stone: ${Math.floor(e.res.stone)}`,"#9aa5b1",s),n+=Math.max(l,s.scale(150)),H(i,n,s.scale(8),`Food: ${Math.floor(e.res.food)}`,"#9ae6b4",s),n+=l,e.storage){const p=Math.floor(e.storage.used/e.storage.max*100),x=p>90?"#ef4444":p>70?"#eab308":"#22c55e";H(i,n,s.scale(8),`Storage: ${Math.floor(e.storage.used)}/${e.storage.max} (${p}%)`,x,s),n+=s.scale(180)}const r=`Colonists: ${e.colonists}/${e.cap}`;H(i,n,s.scale(8),r,"#93c5fd",s),n+=Math.max(l,s.scale(190));const c=`Hiding: ${e.hiding}`;H(i,n,s.scale(8),c,"#60a5fa",s),n+=s.scale(120);const d=`Day ${e.day} ‚Äî ${e.tDay*24|0}:00 ${e.isNight?"üåô":"‚òÄÔ∏è"}`;H(i,n,s.scale(8),d,e.isNight?"#ffd166":"#6ee7ff",s);const f=t.height-s.scale(46),y=Math.max(s.scale(120),Math.min(s.scale(180),(t.width-o*2)/e.hotbar.length));n=o,i.fillStyle="#0b122088",i.fillRect(0,f,t.width,s.scale(46)),i.strokeStyle="#1e293b",i.strokeRect(0,f+.5,t.width,s.scale(46)),i.font=s.getScaledFont(13);for(let p=0;p<e.hotbar.length;p++){const x=e.hotbar[p];Wt(i,n+s.scale(2),f+s.scale(6),y-s.scale(6),s.scale(34),`${p+1}. ${x.name}`,x.cost,x.selected,s),n+=y}let g=a+s.scale(6);const w=Math.min(s.scale(360),t.width-o*2);for(let p=e.messages.length-1;p>=0;p--){const x=e.messages[p];zt(i,h-w-o,g,x.text,w,s),g+=s.scale(22)}}function H(i,t,e,s,o,a){const h=i.measureText(s).width+a.scale(18),n=a.scale(20);i.fillStyle="#0f172a",i.fillRect(t,e,h,n),i.strokeStyle="#1e293b",i.strokeRect(t+.5,e+.5,h-1,n-1),i.fillStyle=o,i.fillRect(t+a.scale(2),e+a.scale(2),a.scale(6),n-a.scale(4)),i.fillStyle="#dbeafe",i.fillText(s,t+a.scale(12),e+a.scale(14))}function Wt(i,t,e,s,o,a,h,n,l){i.fillStyle=n?"#102034":"#0f172a",i.fillRect(t,e,s,o),i.strokeStyle=n?"#4b9fff":"#1e293b",i.strokeRect(t+.5,e+.5,s-1,o-1),i.fillStyle="#dbeafe",i.fillText(a,t+l.scale(8),e+l.scale(20)),i.fillStyle="#9fb3c8",i.fillText(h,t+s-l.scale(48),e+l.scale(20))}function zt(i,t,e,s,o,a){const h=a.scale(20);i.fillStyle="#0f172aee",i.fillRect(t,e,o,h),i.strokeStyle="#1e293b",i.strokeRect(t+.5,e+.5,o-1,h-1),i.fillStyle="#dbeafe",i.fillText(s,t+a.scale(8),e+a.scale(14))}function G(i,t,e,s){for(const o of i.buildings){if(o.kind==="hq"||o.kind==="path"||o.kind==="house"||!o.done)continue;const a=Math.max(o.x,Math.min(t,o.x+o.w)),h=Math.max(o.y,Math.min(e,o.y+o.h)),n=t-a,l=e-h;if(n*n+l*l<=s*s)return!0}return!1}function Lt(i,t,e){const o=Math.floor(t/24)*24,a=Math.floor(e/24)*24,h=i.buildings.find(n=>n.kind==="path"&&n.done&&n.x===o&&n.y===a);return h&&h.speedBonus?h.speedBonus:1}function $(i,t,e,s,o,a=1){const h=e-t.x,n=s-t.y,l=Math.hypot(h,n);if(l<5)return!0;const r=Lt(i,t.x,t.y),d=t.speed*a*r*o,f=h/l,y=n/l,g=t.x+f*d,w=t.y+y*d;if(G(i,g,w,t.r)){const p=-y,x=f,S=t.x+p*d*.5,m=t.y+x*d*.5;if(!G(i,S,m,t.r))return t.x=Math.max(0,Math.min(S,M.w)),t.y=Math.max(0,Math.min(m,M.h)),!1;const b=t.x-p*d*.5,T=t.y-x*d*.5;return G(i,b,T,t.r)||(t.x=Math.max(0,Math.min(b,M.w)),t.y=Math.max(0,Math.min(T,M.h))),!1}else return t.x=Math.max(0,Math.min(g,M.w)),t.y=Math.max(0,Math.min(w,M.h)),!1}function Ot(i,t){if(t.stuckTimer===void 0&&(t.stuckTimer=0),G(i,t.x,t.y,t.r)){if(t.stuckTimer+=1/60,t.stuckTimer>2){const s=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let o=!1;for(const a of[20,40,60,80]){for(const h of s){const n=t.x+Math.cos(h)*a,l=t.y+Math.sin(h)*a,r=Math.max(t.r,Math.min(n,M.w-t.r)),c=Math.max(t.r,Math.min(l,M.h-t.r));if(!G(i,r,c,t.r)){t.x=r,t.y=c,t.stuckTimer=0,o=!0,console.log(`Rescued stuck colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) using distance ${a}`);break}}if(o)break}if(!o){const a=i.buildings.find(h=>h.kind==="hq");a&&(t.x=a.x+a.w/2+(Math.random()-.5)*40,t.y=a.y-40+(Math.random()-.5)*20,t.stuckTimer=0,console.log("Emergency rescue: teleported stuck colonist to HQ area"))}return!0}}else t.stuckTimer=0;return!1}function Nt(i,t,e){if(!t.alive)return;if(t.t+=e,t.state||(t.state="seekTask"),t.stateSince=(t.stateSince||0)+e,Ot(i,t)){t.task=null,t.target=null,i.clearPath&&i.clearPath(t),t.state="seekTask",t.stateSince=0;return}const s=t.state==="build"||t.state==="chop"||t.state==="mine"||t.state==="harvest"||t.state==="flee"||t.state==="move",o=s?1.6:t.inside?.6:1;t.hunger=Math.max(0,Math.min(100,(t.hunger||0)+e*o));const a=s?5:2;t.inside||t.state==="resting"||t.state==="sleep"?t.fatigue=Math.max(0,(t.fatigue||0)-e*14):t.fatigue=Math.min(100,(t.fatigue||0)+e*a),t.fatigueSlow=(t.fatigue||0)>66?.8:(t.fatigue||0)>33?.9:1,(t.hunger||0)>=95&&(t.hp=Math.max(0,t.hp-4*e)),(t.hunger||0)<30&&!s&&!t.inside&&(t.hp=Math.min(100,t.hp+.8*e));const h=i.buildings.find(l=>l.kind==="infirmary"&&l.done);if(h){const l=h.healRange||140,r=h.healRate||3;(t.x-(h.x+h.w/2))**2+(t.y-(h.y+h.h/2))**2<=l*l&&(t.hp=Math.min(100,t.hp+r*e))}const n=i.enemies.find(l=>W(l,t)<140*140);switch(t.lastHp=t.lastHp??t.hp,t.hp<t.lastHp&&(t.hurt=1.5),t.lastHp=t.hp,t.hurt=Math.max(0,(t.hurt||0)-e),!t.inside&&n&&t.state!=="flee"&&(t.state="flee",t.stateSince=0),!t.inside&&!n&&i.isNight()&&t.state!=="sleep"&&t.state!=="flee"&&(t.state="sleep",t.stateSince=0),!t.inside&&(t.hp||0)<35&&t.state!=="flee"&&(t.state="heal",t.stateSince=0),!t.inside&&(t.hunger||0)>80&&(i.RES.food||0)>0&&t.state!=="flee"&&(t.state="eat",t.stateSince=0),t.inside&&t.state!=="resting"&&(t.state="resting",t.stateSince=0),t.state){case"resting":{t.hideTimer=Math.max(0,(t.hideTimer||0)-e),t.hp=Math.min(100,t.hp+1.2*e),!i.isNight()&&!n&&(t.hurt||0)<=0&&(t.hideTimer||0)<=0&&(i.leaveBuilding(t),t.safeTarget=null,t.safeTimer=0,t.state="seekTask",t.stateSince=0);break}case"heal":{const l=i.buildings.filter(w=>w.kind==="infirmary"&&w.done);if(!l.length){t.state="seekTask",t.stateSince=0;break}let r=l[0],c=W(t,i.centerOf(r));for(let w=1;w<l.length;w++){const p=W(t,i.centerOf(l[w]));p<c&&(c=p,r=l[w])}const d=i.centerOf(r),f=r.healRange||140,y=t.x>=r.x-8&&t.x<=r.x+r.w+8&&t.y>=r.y-8&&t.y<=r.y+r.h+8,g=Math.hypot(t.x-d.x,t.y-d.y);if(y&&i.tryEnterBuilding(t,r)){t.state="resting",t.stateSince=0;break}g<=f*.9?t.hp>=80&&(t.state="seekTask",t.stateSince=0):$(i,t,d.x,d.y,e,1);break}case"eat":{const l=(i.RES.food||0)>0;l&&t.stateSince>.6?(i.RES.food-=1,t.hunger=Math.max(0,(t.hunger||0)-40),t.hp=Math.min(100,t.hp+2.5),t.state="seekTask",t.stateSince=0):l||(t.state=i.isNight()?"sleep":"seekTask",t.stateSince=0);break}case"flee":{let l=null,r=null;const c=i.buildings.filter(d=>(d.kind==="house"||d.kind==="hq")&&d.done&&i.buildingHasSpace(d));if(c.length){const d=c.sort((f,y)=>W(t,i.centerOf(f))-W(t,i.centerOf(y)))[0];r=d,l=i.centerOf(d)}else{const d=n?i.findSafeTurret(t,n):null;d&&(l=i.centerOf(d))}if(l){const d=l.x-t.x,f=l.y-t.y,y=Math.hypot(d,f),g=r?t.x>=r.x-8&&t.x<=r.x+r.w+8&&t.y>=r.y-8&&t.y<=r.y+r.h+8:!1;if(y<=20||g)if(r&&i.tryEnterBuilding(t,r))t.hideTimer=3,t.state="resting",t.stateSince=0;else{const w=i.buildings.filter(p=>p.done&&i.buildingHasSpace(p)&&(p.kind==="house"||p.kind==="hq"));if(w.length){const p=w.sort((S,m)=>W(t,i.centerOf(S))-W(t,i.centerOf(m)))[0],x=i.centerOf(p);i.clearPath(t),r=p,l=x}}else $(i,t,l.x,l.y,e,1.8)}else{const d=ut(yt(t,n));t.x+=d.x*(t.speed+90)*e,t.y+=d.y*(t.speed+90)*e}n||(t.state="seekTask",t.stateSince=0);break}case"sleep":{if(!i.isNight()){t.state="seekTask",t.stateSince=0;break}const l=i.buildings.filter(p=>(p.kind==="house"||p.kind==="hq")&&p.done&&i.buildingHasSpace(p));if(!l.length){t.state="seekTask",t.stateSince=0;break}let r=l[0],c=W(t,i.centerOf(r));for(let p=1;p<l.length;p++){const x=W(t,i.centerOf(l[p]));x<c&&(c=x,r=l[p])}const d=i.centerOf(r),f=d.x-t.x,y=d.y-t.y,g=Math.hypot(f,y),w=t.x>=r.x-8&&t.x<=r.x+r.w+8&&t.y>=r.y-8&&t.y<=r.y+r.h+8;if(g<=20||w)if(i.tryEnterBuilding(t,r))t.hideTimer=0,t.state="resting",t.stateSince=0;else{const p=i.buildings.filter(x=>x.done&&i.buildingHasSpace(x)&&(x.kind==="house"||x.kind==="hq")).sort((x,S)=>W(t,i.centerOf(x))-W(t,i.centerOf(S)))[0];p?(i.centerOf(p),i.clearPath(t)):(t.state="seekTask",t.stateSince=0)}else $(i,t,d.x,d.y,e);break}case"seekTask":{if(i.isNight()){t.state="sleep",t.stateSince=0;break}if(!t.task||t.task==="idle"&&Math.random()<.005){const l=t.task;i.pickTask(t),l!==t.task&&Math.random()<.1&&console.log(`Colonist assigned task: ${t.task}, target:`,t.target)}switch(t.task){case"build":t.state="build";break;case"harvestFarm":t.state="harvest";break;case"harvestWell":t.state="harvest";break;case"chop":t.state="chop";break;case"mine":t.state="mine";break;case"idle":default:t.state="idle";break}t.stateSince=0;break}case"idle":{const l=t.target;if(!l){t.state="seekTask";break}i.moveAlongPath(t,e,l,8)&&(t.task=null,t.target=null,i.clearPath(t),t.state="seekTask",t.stateSince=0);break}case"build":{const l=t.target;if(!l||l.done){i.releaseBuildReservation(t),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const r={x:l.x+l.w/2,y:l.y+l.h/2};if(i.moveAlongPath(t,e,r,12)&&(l.buildLeft-=25*e,l.buildLeft<=0)){if(l.done=!0,l.kind==="farm"&&(l.growth=0,l.ready=!1),G(i,t.x,t.y,t.r)){const c=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let d=!1;for(const f of c){const y=Math.max(l.w,l.h)/2+t.r+10,g=l.x+l.w/2+Math.cos(f)*y,w=l.y+l.h/2+Math.sin(f)*y,p=Math.max(t.r,Math.min(g,M.w-t.r)),x=Math.max(t.r,Math.min(w,M.h-t.r));if(!G(i,p,x,t.r)){t.x=p,t.y=x,d=!0,Math.random()<.1&&console.log(`Moved colonist to safety after building completion: (${t.x.toFixed(1)}, ${t.y.toFixed(1)})`);break}}if(!d){const f=i.buildings.find(y=>y.kind==="hq");f&&(t.x=f.x+f.w/2,t.y=f.y-30,console.log("Emergency teleport to HQ area after building completion"))}}i.msg(l.name?l.name+" complete":"Building complete"),i.rebuildNavGrid(),i.clearPath(t),i.releaseBuildReservation(t),t.task=null,t.target=null,t.state="seekTask"}break}case"harvest":{const l=t.target;if(!l){t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}if(l.kind==="farm"&&!l.ready){t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const r={x:l.x+l.w/2,y:l.y+l.h/2};if(i.moveAlongPath(t,e,r,12)){if(l.kind==="farm"){l.ready=!1,l.growth=0;const c=i.addResource("food",10);c>0&&i.msg(`Farm harvested (+${c} food)`,"good")}else if(l.kind==="well"){const c=i.addResource("food",5);c>0&&i.msg(`Well collected (+${c} food)`,"good")}t.task=null,t.target=null,i.clearPath(t),t.state="seekTask"}break}case"chop":{const l=t.target;if(!l||l.hp<=0){l&&i.assignedTargets.has(l)&&i.assignedTargets.delete(l),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const r=l.x-t.x,c=l.y-t.y,d=Math.hypot(r,c),f=(l.r||12)+t.r+4;if(d<=f+2.5+.1){if(l.hp-=18*e,l.hp<=0){const g=i.addResource("wood",6);i.trees.splice(i.trees.indexOf(l),1),i.assignedTargets.has(l)&&i.assignedTargets.delete(l),g>0&&i.msg(`+${g} wood`,"good"),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask"}break}else $(i,t,l.x,l.y,e);t.stateSince&&t.stateSince>15&&(i.assignedTargets.has(l)&&i.assignedTargets.delete(l),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask");break}case"mine":{const l=t.target;if(!l||l.hp<=0){l&&i.assignedTargets.has(l)&&i.assignedTargets.delete(l),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const r=l.x-t.x,c=l.y-t.y,d=Math.hypot(r,c),f=(l.r||12)+t.r+4,y=2.5;if(Math.random()<.01&&console.log(`Mining: distance=${d.toFixed(1)}, interact=${f}, colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}), rock at (${l.x.toFixed(1)}, ${l.y.toFixed(1)})`),d<=f+y+.1){if(l.hp-=16*e,l.hp<=0){const g=i.addResource("stone",5);i.rocks.splice(i.rocks.indexOf(l),1),i.assignedTargets.has(l)&&i.assignedTargets.delete(l),g>0&&i.msg(`+${g} stone`,"good"),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask"}break}else $(i,t,l.x,l.y,e),Math.random()<.01&&console.log(`Moving toward rock: target=(${l.x.toFixed(1)}, ${l.y.toFixed(1)}), distance=${d.toFixed(1)}`);t.stateSince&&t.stateSince>15&&(console.log(`Colonist stuck mining for ${t.stateSince.toFixed(1)}s, abandoning`),i.assignedTargets.has(l)&&i.assignedTargets.delete(l),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask");break}}for(const l of i.colonists){if(l===t)continue;if((t.state==="mine"||t.state==="chop")&&t.target){const y=(t.target.r||12)+t.r+4;if(Math.hypot(t.x-t.target.x,t.y-t.target.y)<=y+2.5)continue}const r=t.x-l.x,c=t.y-l.y,d=r*r+c*c,f=(t.r+2)*(t.r+2);if(d>0&&d<f*4){const y=Math.sqrt(d)||1,g=(f*2-y)*.5;t.x+=r/y*g*e*6,t.y+=c/y*g*e*6}}}function lt(i,t,e,s){for(const o of i.buildings){if(o.kind==="hq"||o.kind==="path"||o.kind==="house"||!o.done)continue;const a=Math.max(o.x,Math.min(t,o.x+o.w)),h=Math.max(o.y,Math.min(e,o.y+o.h)),n=t-a,l=e-h;if(n*n+l*l<=s*s)return!0}return!1}function Qt(i,t,e){const s=i.buildings.find(c=>c.kind==="hq");let o=s,a=W(t,i.centerOf(s));for(const c of i.colonists){const d=W(t,c);d<a&&(a=d,o=c)}const h=o.w?i.centerOf(o):o,n=ut(yt(h,t)),l=t.x+n.x*t.speed*e,r=t.y+n.y*t.speed*e;if(!lt(i,l,r,t.r))t.x=l,t.y=r;else{const c=-n.y,d=n.x,f=t.x+c*t.speed*e*.5,y=t.y+d*t.speed*e*.5;if(!lt(i,f,y,t.r))t.x=f,t.y=y;else{const g=t.x-c*t.speed*e*.5,w=t.y-d*t.speed*e*.5;lt(i,g,w,t.r)||(t.x=g,t.y=w)}}if(o.w){const c=o;i.pointInRect(t,c)&&(c.hp-=t.dmg*e),c.hp<=0&&(c.kind==="hq"?i.lose():(i.evictColonistsFrom(c),i.buildings.splice(i.buildings.indexOf(c),1),i.msg((c.name||c.kind)+" destroyed","warn")))}else{const c=o;Math.hypot(t.x-c.x,t.y-c.y)<t.r+8&&(c.hp-=t.dmg*e,c.hp<=0&&(c.alive=!1,i.colonists.splice(i.colonists.indexOf(c),1),i.msg("A colonist has fallen","warn")))}}class Ht{constructor(t){k(this,"canvas");k(this,"ctx");k(this,"DPR",1);k(this,"camera",{x:0,y:0,zoom:1});k(this,"uiScale",1);k(this,"baseFontSize",14);k(this,"isTouch",!1);k(this,"RES",{wood:0,stone:0,food:0});k(this,"BASE_STORAGE",200);k(this,"storageFullWarned",!1);k(this,"day",1);k(this,"tDay",0);k(this,"dayLength",180);k(this,"fastForward",1);k(this,"paused",!1);k(this,"prevIsNight",!1);k(this,"colonists",[]);k(this,"enemies",[]);k(this,"trees",[]);k(this,"rocks",[]);k(this,"buildings",[]);k(this,"bullets",[]);k(this,"messages",[]);k(this,"selectedBuild","house");k(this,"hotbar",["house","farm","turret","wall","stock","tent","warehouse","well","infirmary"]);k(this,"showBuildMenu",!1);k(this,"debug",{nav:!1,paths:!0});k(this,"selColonist",null);k(this,"follow",!1);k(this,"keyState",{});k(this,"once",new Set);k(this,"mouse",{x:0,y:0,wx:0,wy:0,down:!1,rdown:!1});k(this,"lastPaintCell",null);k(this,"eraseDragStart",null);k(this,"menuRects",[]);k(this,"hotbarRects",[]);k(this,"pendingPlacement",null);k(this,"placeUIRects",[]);k(this,"colonistPanelRect",null);k(this,"colonistPanelCloseRect",null);k(this,"handleResize",()=>{const t=document.querySelector("header"),e=t?Math.ceil(t.getBoundingClientRect().height):48,s=window.innerWidth,o=window.innerHeight-e;this.canvas.style.width=s+"px",this.canvas.style.height=o+"px",this.canvas.width=Math.floor(s*this.DPR),this.canvas.height=Math.floor(o*this.DPR),this.calculateUIScale()});k(this,"screenToWorld",(t,e)=>({x:t*this.DPR/this.camera.zoom+this.camera.x,y:e*this.DPR/this.camera.zoom+this.camera.y}));k(this,"respawnTimer",0);k(this,"assignedTargets",new WeakSet);k(this,"buildReservations",new Map);k(this,"insideCounts",new Map);k(this,"last",performance.now());k(this,"frame",t=>{const e=Math.min(.033,(t-this.last)/1e3);this.last=t,this.update(e),this.draw(),requestAnimationFrame(this.frame)});k(this,"grid",Mt());const e=t.getContext("2d");if(!e)throw new Error("no ctx");this.canvas=t,this.ctx=e,this.DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)),this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.bindInput(),this.newGame(),this.rebuildNavGrid(),requestAnimationFrame(this.frame)}getStorageCapacity(){let t=this.BASE_STORAGE;for(const e of this.buildings)e.done&&e.storageBonus&&(t+=e.storageBonus);return t}getPopulationCap(){return(this.buildings.find(t=>t.kind==="hq")?3:0)+this.buildings.filter(t=>t.kind==="house"&&t.done).reduce((t,e)=>t+(e.popCap||0),0)}addResource(t,e){const s=this.RES.wood+this.RES.stone+this.RES.food,o=this.getStorageCapacity(),a=Math.max(0,o-s),h=Math.min(Math.floor(e),a);return h>0&&(this.RES[t]+=h),h===0&&e>0&&!this.storageFullWarned?(this.msg(`Storage full! Cannot store more ${String(t)}`,"warn"),this.storageFullWarned=!0):h>0&&(this.storageFullWarned=!1),h}calculateUIScale(){const s=this.canvas.width/this.DPR,o=this.canvas.height/this.DPR,a=s/1920,h=o/1080;let n=Math.min(a,h);const l="ontouchstart"in window||navigator.maxTouchPoints>0;this.isTouch=l,l?s<600?n=Math.max(n*1.9,1.6):s<=900?n=Math.max(n*1.7,1.5):s<=1200?n=Math.max(n*1.5,1.35):n=Math.max(n*1.25,n):s<1200&&(n*=1.1),n=Math.max(1.1,Math.min(n,3)),this.uiScale=n,console.log(`UI Scale calculated: ${n.toFixed(2)} for ${s}x${o}`)}getScaledFont(t,e="500",s="system-ui,Segoe UI,Roboto"){return`${e} ${Math.round(t*this.uiScale)}px ${s}`}scale(t){return Math.round(t*this.uiScale)}bindInput(){const t=this.canvas;t.addEventListener("mousemove",e=>{const s=t.getBoundingClientRect();this.mouse.x=e.clientX-s.left,this.mouse.y=e.clientY-s.top;const o=this.screenToWorld(this.mouse.x,this.mouse.y);this.mouse.wx=o.x,this.mouse.wy=o.y,this.mouse.down&&(this.selectedBuild==="path"?this.paintPathAtMouse():this.selectedBuild==="wall"&&this.paintWallAtMouse())}),t.addEventListener("mousedown",e=>{if(e.preventDefault(),e.button===0){if(this.mouse.down=!0,this.selColonist){const a=this.mouse.x*this.DPR,h=this.mouse.y*this.DPR;if(this.colonistPanelCloseRect){const n=this.colonistPanelCloseRect;if(a>=n.x&&a<=n.x+n.w&&h>=n.y&&h<=n.y+n.h){this.selColonist=null,this.follow=!1;return}}if(this.colonistPanelRect){const n=this.colonistPanelRect;if(!(a>=n.x&&a<=n.x+n.w&&h>=n.y&&h<=n.y+n.h)){this.selColonist=null,this.follow=!1;return}}}if(this.pendingPlacement){const a=this.mouse.x*this.DPR,h=this.mouse.y*this.DPR;if(this.placeUIRects.length){for(const x of this.placeUIRects)if(a>=x.x&&a<=x.x+x.w&&h>=x.y&&h<=x.y+x.h){x.id==="up"?this.nudgePending(0,-1):x.id==="down"?this.nudgePending(0,1):x.id==="left"?this.nudgePending(-1,0):x.id==="right"?this.nudgePending(1,0):x.id==="ok"?this.confirmPending():x.id==="cancel"&&this.cancelPending();return}}const n=this.pendingPlacement,l=B[n.key],c=((x,S)=>({x:(x-this.camera.x)*this.camera.zoom,y:(S-this.camera.y)*this.camera.zoom}))(n.x,n.y),d=l.size.w*u*this.camera.zoom,f=l.size.h*u*this.camera.zoom;if(a>=c.x&&a<=c.x+d&&h>=c.y&&h<=c.y+f){this.confirmPending();return}const y=Math.floor(this.mouse.wx/u)*u,g=Math.floor(this.mouse.wy/u)*u,w=l.size.w*u,p=l.size.h*u;n.x=N(y,0,M.w-w),n.y=N(g,0,M.h-p);return}const s=this.mouse.x*this.DPR,o=this.mouse.y*this.DPR;for(const a of this.hotbarRects)if(s>=a.x&&s<=a.x+a.w&&o>=a.y&&o<=a.y+a.h){const h=this.hotbar[a.index];h&&(this.selectedBuild=h,this.toast("Selected: "+B[h].name));return}if(this.showBuildMenu){this.handleBuildMenuClick();return}if(this.selectedBuild==="path")this.paintPathAtMouse(!0);else if(this.selectedBuild==="wall")this.paintWallAtMouse(!0);else{const a=this.findColonistAt(this.mouse.wx,this.mouse.wy);a?(this.selColonist=a,this.follow=!0):this.placeAtMouse()}}if(e.button===2){if(this.mouse.rdown=!0,this.showBuildMenu){this.showBuildMenu=!1;return}this.eraseDragStart={x:this.mouse.wx,y:this.mouse.wy}}}),t.addEventListener("mouseup",e=>{if(e.preventDefault(),e.button===0&&(this.mouse.down=!1,this.lastPaintCell=null),e.button===2){if(this.eraseDragStart){const s=Math.min(this.eraseDragStart.x,this.mouse.wx),o=Math.min(this.eraseDragStart.y,this.mouse.wy),a=Math.max(this.eraseDragStart.x,this.mouse.wx),h=Math.max(this.eraseDragStart.y,this.mouse.wy);(a-s)*(h-o)<12*12?this.cancelOrErase():this.eraseInRect({x:s,y:o,w:a-s,h:h-o})}this.mouse.rdown=!1,this.eraseDragStart=null}}),t.addEventListener("contextmenu",e=>e.preventDefault()),t.addEventListener("wheel",e=>{e.preventDefault();const s=e.deltaY<0?1.1:.9;this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*s))}),window.addEventListener("keydown",e=>{const s=e.key.toLowerCase();this.keyState[s]=!0,this.once.has(s)||this.once.add(s)}),window.addEventListener("keyup",e=>{this.keyState[e.key.toLowerCase()]=!1})}handleTapOrClickAtScreen(t,e){this.canvas.getBoundingClientRect(),this.mouse.x=t,this.mouse.y=e;const o=this.screenToWorld(this.mouse.x,this.mouse.y);if(this.mouse.wx=o.x,this.mouse.wy=o.y,this.pendingPlacement){const l=this.mouse.x*this.DPR,r=this.mouse.y*this.DPR;if(this.placeUIRects.length){for(const b of this.placeUIRects)if(l>=b.x&&l<=b.x+b.w&&r>=b.y&&r<=b.y+b.h){b.id==="up"?this.nudgePending(0,-1):b.id==="down"?this.nudgePending(0,1):b.id==="left"?this.nudgePending(-1,0):b.id==="right"?this.nudgePending(1,0):b.id==="ok"?this.confirmPending():b.id==="cancel"&&this.cancelPending();return}}const c=this.pendingPlacement,d=B[c.key],y=((b,T)=>({x:(b-this.camera.x)*this.camera.zoom,y:(T-this.camera.y)*this.camera.zoom}))(c.x,c.y),g=d.size.w*u*this.camera.zoom,w=d.size.h*u*this.camera.zoom;if(l>=y.x&&l<=y.x+g&&r>=y.y&&r<=y.y+w){this.confirmPending();return}const p=Math.floor(this.mouse.wx/u)*u,x=Math.floor(this.mouse.wy/u)*u,S=d.size.w*u,m=d.size.h*u;c.x=N(p,0,M.w-S),c.y=N(x,0,M.h-m);return}if(this.selColonist){const l=this.mouse.x*this.DPR,r=this.mouse.y*this.DPR;if(this.colonistPanelCloseRect){const c=this.colonistPanelCloseRect;if(l>=c.x&&l<=c.x+c.w&&r>=c.y&&r<=c.y+c.h){this.selColonist=null,this.follow=!1;return}}if(this.isTouch&&this.colonistPanelRect){const c=this.colonistPanelRect;if(!(l>=c.x&&l<=c.x+c.w&&r>=c.y&&r<=c.y+c.h)){this.selColonist=null,this.follow=!1;return}}}const a=this.mouse.x*this.DPR,h=this.mouse.y*this.DPR;for(const l of this.hotbarRects)if(a>=l.x&&a<=l.x+l.w&&h>=l.y&&h<=l.y+l.h){const r=this.hotbar[l.index];r&&(this.selectedBuild=r,this.toast("Selected: "+B[r].name));return}if(this.showBuildMenu){this.handleBuildMenuClick();return}if(this.selectedBuild==="path"){this.paintPathAtMouse(!0);return}if(this.selectedBuild==="wall"){this.paintWallAtMouse(!0);return}if(this.isTouch&&this.selectedBuild){this.placeAtMouse();return}const n=this.findColonistAt(this.mouse.wx,this.mouse.wy);if(n){this.selColonist=n,this.follow=!0;return}this.placeAtMouse()}findColonistAt(t,e){for(let s=this.colonists.length-1;s>=0;s--){const o=this.colonists[s];if(!o.alive||o.inside)continue;if((o.x-t)*(o.x-t)+(o.y-e)*(o.y-e)<=(o.r+2)*(o.r+2))return o}return null}msg(t,e="info"){this.messages.push({text:t,t:4,kind:e}),this.toast(t,1600)}toast(t,e=1400){const s=document.getElementById("toast");s&&(s.textContent=t,s.style.opacity="1",clearTimeout(s._t),s._t=setTimeout(()=>s.style.opacity="0",e))}scatter(){for(let t=0;t<220;t++){const e={x:Y(80,M.w-80),y:Y(80,M.h-80)};Math.hypot(e.x-L.x,e.y-L.y)<220||this.trees.push({x:e.x,y:e.y,r:12,hp:40,type:"tree"})}for(let t=0;t<140;t++){const e={x:Y(80,M.w-80),y:Y(80,M.h-80)};Math.hypot(e.x-L.x,e.y-L.y)<200||this.rocks.push({x:e.x,y:e.y,r:12,hp:50,type:"rock"})}}tryRespawn(t){if(this.respawnTimer+=t*this.fastForward,this.respawnTimer>=4){this.respawnTimer=0;const e=s=>{for(let o=0;o<6;o++){const a={x:Y(60,M.w-60),y:Y(60,M.h-60)};if(Math.hypot(a.x-L.x,a.y-L.y)<200)continue;let h=!0;for(const n of this.buildings)if(a.x>n.x-24&&a.x<n.x+n.w+24&&a.y>n.y-24&&a.y<n.y+n.h+24){h=!1;break}if(h){s==="tree"?this.trees.push({x:a.x,y:a.y,r:12,hp:40,type:"tree"}):this.rocks.push({x:a.x,y:a.y,r:12,hp:50,type:"rock"});break}}};Math.random()<.5&&this.trees.length<260&&e("tree"),Math.random()<.35&&this.rocks.length<180&&e("rock")}}buildHQ(){const t={w:3*u,h:3*u},e={kind:"hq",name:"HQ",x:L.x-t.w/2,y:L.y-t.h/2,w:t.w,h:t.h,hp:600,done:!0,color:E.bld,size:{w:3,h:3},build:0,buildLeft:0};this.buildings.push(e),this.rebuildNavGrid()}newGame(){this.colonists.length=this.enemies.length=this.trees.length=this.rocks.length=this.buildings.length=this.bullets.length=this.messages.length=0,this.buildReservations.clear(),this.insideCounts.clear(),this.RES.wood=50,this.RES.stone=30,this.RES.food=20,this.day=1,this.tDay=0,this.fastForward=1,this.camera.zoom=1,this.camera.x=L.x-this.canvas.width/(2*this.camera.zoom),this.camera.y=L.y-this.canvas.height/(2*this.camera.zoom),this.buildHQ(),this.scatter();for(let t=0;t<3;t++){const e=Y(0,Math.PI*2),s=80+Y(-10,10);this.spawnColonist({x:L.x+Math.cos(e)*s,y:L.y+Math.sin(e)*s})}this.msg("Welcome! Build farms before night, then turrets.")}spawnColonist(t){const e={x:t.x,y:t.y,r:8,hp:100,speed:50,task:null,target:null,carrying:null,hunger:0,alive:!0,color:E.colonist,t:Y(0,1)};return this.colonists.push(e),e}spawnEnemy(){const t=mt(0,4);let e,s;t===0?(e=Y(0,M.w),s=-80):t===1?(e=Y(0,M.w),s=M.h+80):t===2?(e=-80,s=Y(0,M.h)):(e=M.w+80,s=Y(0,M.h));const o={x:e,y:s,r:9,hp:60+this.day*6,speed:48+this.day*2,dmg:8+this.day,target:null,color:E.enemy};return this.enemies.push(o),o}canPlace(t,e,s){const o={x:e,y:s,w:t.size.w*u,h:t.size.h*u};if(o.x<0||o.y<0||o.x+o.w>M.w||o.y+o.h>M.h)return!1;for(const h of this.buildings)if(!(o.x+o.w<=h.x||o.x>=h.x+h.w||o.y+o.h<=h.y||o.y>=h.y+h.h))return!1;const a=(h,n)=>{const l=Math.max(n.x,Math.min(h.x,n.x+n.w)),r=Math.max(n.y,Math.min(h.y,n.y+n.h)),c=h.x-l,d=h.y-r;return c*c+d*d<=h.r*h.r};for(const h of this.trees)if(a(h,o))return!1;for(const h of this.rocks)if(a(h,o))return!1;return!0}placeAtMouse(){if(this.paused)return;const t=this.selectedBuild;if(!(!t||!B[t])){if(this.isTouch){const s=Math.floor(this.mouse.wx/u)*u,o=Math.floor(this.mouse.wy/u)*u;this.pendingPlacement={key:t,x:s,y:o};return}this.tryPlaceNow(t,this.mouse.wx,this.mouse.wy)}}tryPlaceNow(t,e,s){const o=B[t];if(!o)return;const a=ot(t,e,s);if(!this.canPlace(a,a.x,a.y)){this.toast("Can't place here");return}if(!q(this.RES,o.cost)){this.toast("Not enough resources");return}if(it(this.RES,o.cost),a.kind!=="path")for(let h=this.buildings.length-1;h>=0;h--){const n=this.buildings[h];n.kind==="path"&&!(a.x+a.w<=n.x||a.x>=n.x+n.w||a.y+a.h<=n.y||a.y>=n.y+n.h)&&this.buildings.splice(h,1)}this.buildings.push(a),this.rebuildNavGrid()}nudgePending(t,e){if(!this.pendingPlacement)return;const s=B[this.pendingPlacement.key],o=this.pendingPlacement.x+t*u,a=this.pendingPlacement.y+e*u,h=s.size.w*u,n=s.size.h*u;this.pendingPlacement.x=N(o,0,M.w-h),this.pendingPlacement.y=N(a,0,M.h-n)}confirmPending(){if(!this.pendingPlacement)return;const{key:t,x:e,y:s}=this.pendingPlacement,o=B[t];if(!(this.canPlace({...o,size:o.size},e,s)&&q(this.RES,o.cost))){this.toast("Can't place here");return}this.pendingPlacement=null,this.tryPlaceNow(t,e,s)}cancelPending(){this.pendingPlacement=null}paintPathAtMouse(t=!1){const e=Math.floor(this.mouse.wx/u),s=Math.floor(this.mouse.wy/u);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===e&&this.lastPaintCell.gy===s)return;const o=(g,w)=>{const p=g*u+1,x=w*u+1,S=ot("path",p,x);!this.buildings.some(b=>b.kind==="path"&&b.x===S.x&&b.y===S.y)&&q(this.RES,B.path.cost)&&(it(this.RES,B.path.cost),this.buildings.push(S))};if(this.lastPaintCell==null){o(e,s),this.lastPaintCell={gx:e,gy:s},this.rebuildNavGrid();return}let a=this.lastPaintCell.gx,h=this.lastPaintCell.gy,n=e,l=s;const r=Math.abs(n-a),c=Math.abs(l-h),d=a<n?1:-1,f=h<l?1:-1;let y=r-c;for(;o(a,h),!(a===n&&h===l);){const g=2*y;g>-c&&(y-=c,a+=d),g<r&&(y+=r,h+=f)}this.lastPaintCell={gx:e,gy:s},this.rebuildNavGrid()}paintWallAtMouse(t=!1){const e=Math.floor(this.mouse.wx/u),s=Math.floor(this.mouse.wy/u);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===e&&this.lastPaintCell.gy===s)return;const o=(g,w)=>{const p=g*u+1,x=w*u+1,S=ot("wall",p,x);this.buildings.some(b=>b.kind==="wall"&&b.x===S.x&&b.y===S.y)||q(this.RES,B.wall.cost)&&this.canPlace(S,S.x,S.y)&&(it(this.RES,B.wall.cost),this.buildings.push(S))};if(this.lastPaintCell==null){o(e,s),this.lastPaintCell={gx:e,gy:s},this.rebuildNavGrid();return}let a=this.lastPaintCell.gx,h=this.lastPaintCell.gy,n=e,l=s;const r=Math.abs(n-a),c=Math.abs(l-h),d=a<n?1:-1,f=h<l?1:-1;let y=r-c;for(;o(a,h),!(a===n&&h===l);){const g=2*y;g>-c&&(y-=c,a+=d),g<r&&(y+=r,h+=f)}this.lastPaintCell={gx:e,gy:s},this.rebuildNavGrid()}eraseInRect(t){const e=this.buildings.length;for(let o=this.buildings.length-1;o>=0;o--){const a=this.buildings[o];if(a.kind==="hq")continue;!(t.x+t.w<=a.x||t.x>=a.x+a.w||t.y+t.h<=a.y||t.y>=a.y+a.h)&&(this.evictColonistsFrom(a),this.buildings.splice(o,1),this.buildReservations.delete(a),this.insideCounts.delete(a))}const s=e-this.buildings.length;s>0&&(this.msg(`Removed ${s} structure(s)`),this.rebuildNavGrid())}cancelOrErase(){const t={x:this.mouse.wx,y:this.mouse.wy};for(let e=this.buildings.length-1;e>=0;e--){const s=this.buildings[e];if(s.kind!=="hq"&&t.x>=s.x&&t.x<=s.x+s.w&&t.y>=s.y&&t.y<=s.y+s.h){this.evictColonistsFrom(s),this.buildings.splice(e,1),this.msg("Building removed"),this.rebuildNavGrid();return}}this.selectedBuild=null,this.toast("Build canceled")}evictColonistsFrom(t){const e=t.x+t.w/2,s=t.y+t.h/2;for(const o of this.colonists)if(o.inside===t){this.leaveBuilding(o),o.safeTarget=null,o.safeTimer=0;const a=Math.random()*Math.PI*2,h=(t.w/2+10)*Math.cos(a),n=(t.h/2+10)*Math.sin(a);o.x=N(e+h,0,M.w),o.y=N(s+n,0,M.h)}}buildingCapacity(t){return t.kind==="hq"?8:t.kind==="house"?3:1}buildingHasSpace(t){const e=this.buildingCapacity(t);return(this.insideCounts.get(t)||0)<e}tryEnterBuilding(t,e){return!e.done||!this.buildingHasSpace(e)?!1:(this.insideCounts.set(e,(this.insideCounts.get(e)||0)+1),t.inside=e,t.hideTimer=0,!0)}leaveBuilding(t){const e=t.inside;if(e){const s=(this.insideCounts.get(e)||1)-1;s<=0?this.insideCounts.delete(e):this.insideCounts.set(e,s)}t.inside=null,t.hideTimer=0}getMaxCrew(t){const e=t.w/u*(t.h/u);return e<=1?1:e<=4?2:3}releaseBuildReservation(t){if(!t.reservedBuildFor)return;const e=t.reservedBuildFor,s=(this.buildReservations.get(e)||1)-1;s<=0?this.buildReservations.delete(e):this.buildReservations.set(e,s),t.reservedBuildFor=null}clearPath(t){t.path=void 0,t.pathIndex=void 0,t.repath=0}setTask(t,e,s){if(t.target&&t.target.type&&this.assignedTargets.has(t.target)&&this.assignedTargets.delete(t.target),t.reservedBuildFor&&t.reservedBuildFor!==s&&this.releaseBuildReservation(t),t.task=e,t.target=s,this.clearPath(t),s&&s.type&&(s.type==="tree"||s.type==="rock")&&this.assignedTargets.add(s),e==="build"&&s&&s.w!=null&&!t.reservedBuildFor){const o=s,a=this.buildReservations.get(o)||0,h=this.getMaxCrew(o);a<h&&(this.buildReservations.set(o,a+1),t.reservedBuildFor=o)}}pickTask(t){let e=null,s=1/0;for(const n of this.buildings){if(n.done||(this.buildReservations.get(n)||0)>=this.getMaxCrew(n))continue;const r=W({x:t.x,y:t.y},this.centerOf(n));r<s&&(s=r,e=n)}if(e){this.setTask(t,"build",e);return}const o=this.buildings.find(n=>n.kind==="farm"&&n.done&&n.ready);if(o){this.setTask(t,"harvestFarm",o);return}if(Math.random()<.1){const n=this.buildings.find(l=>l.kind==="well"&&l.done);if(n){this.setTask(t,"harvestWell",n);return}}if(this.RES.food<Math.max(4,this.colonists.length*2)){const n=this.nearestCircle({x:t.x,y:t.y},this.trees.filter(l=>!this.assignedTargets.has(l)));if(n){this.setTask(t,"chop",n);return}}const a=this.trees.filter(n=>!this.assignedTargets.has(n)),h=this.rocks.filter(n=>!this.assignedTargets.has(n));if(Math.random()<.05&&console.log(`Task assignment: wood=${this.RES.wood}, stone=${this.RES.stone}, trees=${a.length}, rocks=${h.length}`),this.RES.wood<this.RES.stone){const n=this.nearestCircle({x:t.x,y:t.y},a);if(n){Math.random()<.1&&console.log("Assigning chop task"),this.setTask(t,"chop",n);return}else Math.random()<.1&&console.log("No trees available for chopping")}else{const n=this.nearestCircle({x:t.x,y:t.y},h);if(n){Math.random()<.1&&console.log("Assigning mine task to rock at:",n),this.setTask(t,"mine",n);return}else Math.random()<.1&&console.log("No rocks available for mining")}Math.random()<.1&&console.log("Assigning idle task"),this.setTask(t,"idle",{x:t.x+Y(-80,80),y:t.y+Y(-80,80)})}nearestCircle(t,e){let s=null,o=1e9;for(const a of e){const h=W(t,a);h<o&&(o=h,s=a)}return s}moveAlongPath(t,e,s,o=10){t.repath=(t.repath||0)-e;const a=s&&(!t.pathGoal||Math.hypot(t.pathGoal.x-s.x,t.pathGoal.y-s.y)>12);if(s&&(a||t.repath==null||t.repath<=0||!t.path||t.pathIndex==null)){const g=this.computePath(t.x,t.y,s.x,s.y);g&&g.length?(t.path=g,t.pathIndex=0,t.pathGoal={x:s.x,y:s.y}):Math.random()<.05&&console.log(`Failed to compute path from (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) to (${s.x.toFixed(1)}, ${s.y.toFixed(1)})`),t.repath=2}if(!t.path||t.pathIndex==null||t.pathIndex>=t.path.length)return s?Math.hypot(t.x-s.x,t.y-s.y)<=o:!1;const h=t.path[t.pathIndex],n=h.x-t.x,l=h.y-t.y;let r=Math.hypot(n,l);const c=10,d=4;let f=t.speed*(t.fatigueSlow||1);{const g=Math.floor(t.x/u),w=Math.floor(t.y/u);if(g>=0&&w>=0&&g<this.grid.cols&&w<this.grid.rows){const x=w*this.grid.cols+g;this.grid.cost[x]<=.7&&(f*=1.125)}}const y=f*e;if(r<=Math.max(c,y))return t.x=h.x,t.y=h.y,t.pathIndex++,t.jitterScore=0,t.jitterWindow=0,t.lastDistToNode=void 0,t.lastDistSign=void 0,t.pathIndex>=t.path.length?(t.path=void 0,t.pathIndex=void 0,s?Math.hypot(t.x-s.x,t.y-s.y)<=o:!0):!1;if(t.jitterWindow=(t.jitterWindow||0)+e,t.lastDistToNode!=null){const g=r-t.lastDistToNode,w=g===0?0:g>0?1:-1,p=t.lastDistSign??w;w!==0&&p!==0&&w!==p&&r<c+10?t.jitterScore=(t.jitterScore||0)+1:t.jitterScore=Math.max(0,(t.jitterScore||0)-1),t.lastDistSign=w}if(t.lastDistToNode=r,(t.jitterScore||0)>=6||(t.jitterWindow||0)>1.5){if(r<c+d)t.pathIndex++;else if(s){const g=this.computePath(t.x,t.y,s.x,s.y);g&&g.length&&(t.path=g,t.pathIndex=0)}if(t.jitterScore=0,t.jitterWindow=0,t.lastDistToNode=void 0,t.lastDistSign=void 0,!t.path||t.pathIndex==null||t.pathIndex>=t.path.length)return!1}return t.x+=n/(r||1)*y,t.y+=l/(r||1)*y,t.x=Math.max(0,Math.min(t.x,M.w)),t.y=Math.max(0,Math.min(t.y,M.h)),!1}findSafeTurret(t,e){let s=null,o=1/0;for(const a of this.buildings){if(a.kind!=="turret"||!a.done)continue;const h=this.centerOf(a),n=Math.hypot(t.x-h.x,t.y-h.y),l=Math.hypot(e.x-h.x,e.y-h.y),r=a.range||160,c=l<r?100:0,d=n+c;d<o&&(o=d,s=a)}return s}isProtectedByTurret(t){const e=this.centerOf(t);for(const s of this.buildings){if(s.kind!=="turret"||!s.done)continue;const o=s.range||120,a=this.centerOf(s);if(W(e,a)<o*o)return!0}return!1}centerOf(t){return{x:t.x+t.w/2,y:t.y+t.h/2}}pointInRect(t,e){return t.x>=e.x&&t.x<=e.x+e.w&&t.y>=e.y&&t.y<=e.y+e.h}updateTurret(t,e){if(!("range"in t)||!t.range)return;t.cooldown=Math.max(0,(t.cooldown||0)-e);let s=null,o=1e9;const a=this.centerOf(t);for(const h of this.enemies){const n=W(h,a);n<t.range*t.range&&n<o&&(o=n,s=h)}s&&(t.cooldown||0)<=0&&(s.hp-=t.dps||0,this.bullets.push({x:a.x,y:a.y,tx:s.x,ty:s.y,t:.12}),t.cooldown=t.fireRate||.6)}isNight(){return this.tDay>=rt.start||this.tDay<=rt.end}spawnWave(){const t=4+Math.floor(this.day*1.3);for(let e=0;e<t;e++)this.spawnEnemy();this.msg(`Night ${this.day}: Enemies incoming!`,"warn")}nextDay(){this.day++,this.waveSpawnedForDay=!1;let t=0;for(let o=0;o<this.colonists.length;o++)this.RES.food>0?this.RES.food-=1:(t++,this.colonists[o]&&(this.colonists[o].alive=!1));t>0&&(this.colonists=this.colonists.filter(o=>o.alive),this.msg(`${t} colonist(s) starved`,"bad"));for(const o of this.buildings)o.kind==="farm"&&o.done&&(o.growth=(o.growth||0)+.5,(o.growth||0)>=(o.growTime||1)&&(o.ready=!0));const e=this.buildings.find(o=>o.kind==="tent"&&o.done),s=(this.buildings.find(o=>o.kind==="hq")?3:0)+this.buildings.filter(o=>o.kind==="house"&&o.done).reduce((o,a)=>o+(a.popCap||0),0);e&&this.colonists.length<s&&this.RES.food>=15&&(this.RES.food-=15,this.spawnColonist({x:L.x+Y(-20,20),y:L.y+Y(-20,20)}),this.msg("A new colonist joined! (-15 food)","info")),this.day>8&&this.win()}dayTick(t){const e=this.isNight();this.tDay+=t*this.fastForward/this.dayLength,this.tDay>=1&&(this.tDay-=1,this.nextDay());const s=this.isNight();!e&&s&&this.spawnWave(),this.prevIsNight=s;for(const o of this.colonists)o.alive&&((o.hunger||0)>90&&o.hp<100&&(o.hp=Math.max(0,o.hp-.6*t)),o.hp<=0&&(o.alive=!1))}keyPressed(t){return this.once.has(t)?(this.once.delete(t),!0):!1}update(t){if(this.keyPressed(" ")){this.paused=!this.paused;const s=document.getElementById("btnPause");s&&(s.textContent=this.paused?"Resume":"Pause")}if(this.keyPressed("h")){const s=document.getElementById("help");s&&(s.hidden=!s.hidden)}this.keyPressed("b")&&(this.showBuildMenu=!this.showBuildMenu),this.keyPressed("g")&&(this.debug.nav=!this.debug.nav,this.toast(this.debug.nav?"Debug: nav ON":"Debug: nav OFF")),this.keyPressed("escape")&&(this.showBuildMenu?this.showBuildMenu=!1:(this.selectedBuild=null,this.toast("Build canceled"),this.selColonist=null,this.follow=!1)),this.keyPressed("f")&&(this.fastForward=this.fastForward===1?6:1,this.toast(this.fastForward>1?"Fast-forward ON":"Fast-forward OFF"));const e=360*t/this.camera.zoom;if(this.keyState.w&&(this.camera.y-=e),this.keyState.s&&(this.camera.y+=e),this.keyState.a&&(this.camera.x-=e),this.keyState.d&&(this.camera.x+=e),(this.keyState["+"]||this.keyState["="])&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*1.02))),(this.keyState["-"]||this.keyState._)&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom/1.02))),!this.paused){for(const[s,o]of this.hotbar.entries())this.keyPressed(String(s+1))&&(this.selectedBuild=o,this.toast("Selected: "+B[o].name));if(this.follow&&this.selColonist){const s=this.selColonist,o=this.canvas.width/this.camera.zoom,a=this.canvas.height/this.camera.zoom;this.camera.x=N(s.x-o/2,0,Math.max(0,M.w-o)),this.camera.y=N(s.y-a/2,0,Math.max(0,M.h-a))}this.dayTick(t);for(const s of this.colonists)Nt(this,s,t*this.fastForward);for(let s=this.enemies.length-1;s>=0;s--){const o=this.enemies[s];Qt(this,o,t*this.fastForward),o.hp<=0&&(this.enemies.splice(s,1),Math.random()<.5&&(this.RES.food+=1))}for(const s of this.buildings){if(s.kind==="turret"&&s.done&&this.updateTurret(s,t*this.fastForward),s.healRate&&s.done){const o=s.healRate,a=s.healRange||120,h=this.centerOf(s);for(const n of this.colonists)(n.x-h.x)*(n.x-h.x)+(n.y-h.y)*(n.y-h.y)<a*a&&(n.hp=Math.min(100,n.hp+o*t*this.fastForward))}if(s.kind==="tent"&&s.done&&(s.cooldown=(s.cooldown||0)-t*this.fastForward,s.cooldown<=0&&this.RES.food>=15)){const o=this.getPopulationCap();if(this.colonists.length<o){this.RES.food-=15;const a=this.centerOf(s);this.spawnColonist({x:a.x+(Math.random()-.5)*40,y:a.y+(Math.random()-.5)*40}),this.msg("Recruit tent attracted a new colonist! (-15 food)","good"),s.cooldown=60}}}this.tryRespawn(t);for(let s=this.bullets.length-1;s>=0;s--){const o=this.bullets[s];o.t-=t,o.t<=0&&this.bullets.splice(s,1)}for(let s=this.messages.length-1;s>=0;s--){const o=this.messages[s];o.t-=t,o.t<=0&&this.messages.splice(s,1)}}}draw(){const{ctx:t}=this;At(t,this.canvas),t.save(),Ct(t,this.camera),Bt(t);for(const n of this.trees)nt(t,n.x,n.y,n.r,E.tree);for(const n of this.rocks)nt(t,n.x,n.y,n.r,E.rock);for(const n of this.buildings)if(Dt(t,n),(n.kind==="house"||n.kind==="hq")&&this.buildings.some(r=>r.kind==="turret"&&r.done&&W(this.centerOf(n),this.centerOf(r))<(r.range||120)*(r.range||120))){const r=this.centerOf(n);It(t,r.x,n.y-8,12,"#60a5fa")}{const n=new Map;for(const l of this.colonists)l.inside&&n.set(l.inside,(n.get(l.inside)||0)+1);t.save();for(const[l,r]of n){if(!r)continue;const c=8,d=Math.min(r,c),f=10,y=4,g=d*(f+y)-y;let w=l.x+l.w/2-g/2+f/2;const p=l.y+l.h+8,x=this.colonists.filter(S=>S.inside===l);for(let S=0;S<d;S++){const m=x[S%x.length],b=m?m.hp:100,T=b>66?"#22c55e":b>33?"#eab308":"#ef4444";dt(t,w+S*(f+y),p,10,T)}if(r>c){const S=r-c,m=w+d*(f+y)+6;t.fillStyle="#dbeafe",t.font="600 11px system-ui,Segoe UI,Roboto",t.fillText("+"+S,m,p+4)}}t.restore()}for(const n of this.colonists)n.inside||nt(t,n.x,n.y,n.r,this.selColonist===n?"#93c5fd":E.colonist);if(this.debug.nav){t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444";for(let n=0;n<this.grid.rows;n++)for(let l=0;l<this.grid.cols;l++)this.grid.solid[n*this.grid.cols+l]&&t.fillRect(l*u,n*u,u,u);t.restore(),t.save(),t.globalAlpha=.12;for(let n=0;n<this.grid.rows;n++)for(let l=0;l<this.grid.cols;l++){const r=n*this.grid.cols+l;if(!this.grid.solid[r]){const c=this.grid.cost[r];c<=.7?t.fillStyle="#22c55e":c<=1?t.fillStyle="#eab308":t.fillStyle="#f97316",t.fillRect(l*u,n*u,u,u)}}t.restore(),t.save(),t.strokeStyle="#22d3ee",t.lineWidth=2;for(const n of this.colonists)if(!(!n.path||!n.path.length)){t.beginPath(),t.moveTo(n.x,n.y);for(let l=n.pathIndex??0;l<n.path.length;l++){const r=n.path[l];t.lineTo(r.x,r.y)}if(t.stroke(),n.pathIndex!=null&&n.pathIndex<n.path.length){const l=n.path[n.pathIndex];t.save(),t.fillStyle="#fbbf24",t.beginPath(),t.arc(l.x,l.y,6,0,Math.PI*2),t.fill(),t.restore()}}t.restore(),t.save(),t.font="11px monospace",t.fillStyle="#ffffff",t.strokeStyle="#000000",t.lineWidth=2;for(const n of this.colonists){if(n.inside)continue;const l=`${n.task||n.state||"idle"}`,r=n.x-20,c=n.y-n.r-8;if(t.strokeText(l,r,c),t.fillText(l,r,c),n.target&&n.target.x!=null){const d=n.target;t.save(),t.strokeStyle="#94a3b8",t.lineWidth=1,t.setLineDash([3,3]),t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(d.x,d.y),t.stroke(),t.setLineDash([]),t.restore()}}t.restore()}for(const n of this.enemies)Et(t,n.x,n.y,n.r+2,3,E.enemy,-Math.PI/2);if(Ft(t,this.bullets),this.isNight()&&(t.fillStyle="rgba(6,10,18, 0.58)",t.fillRect(0,0,M.w,M.h)),this.selectedBuild&&!this.pendingPlacement){const n=B[this.selectedBuild],l=Math.floor(this.mouse.wx/u)*u,r=Math.floor(this.mouse.wy/u)*u,c=this.canPlace({...n,size:n.size},l,r)&&q(this.RES,n.cost);t.globalAlpha=.6,t.fillStyle=c?E.ghost:"#ff6b6b88",t.fillRect(l,r,n.size.w*u,n.size.h*u),t.globalAlpha=1}if(this.mouse.rdown&&this.eraseDragStart){const n=Math.min(this.eraseDragStart.x,this.mouse.wx),l=Math.min(this.eraseDragStart.y,this.mouse.wy),r=Math.abs(this.mouse.wx-this.eraseDragStart.x),c=Math.abs(this.mouse.wy-this.eraseDragStart.y);t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444",t.fillRect(n,l,r,c),t.globalAlpha=1,t.strokeStyle="#ef4444",t.setLineDash([6,4]),t.strokeRect(n+.5,l+.5,r-1,c-1),t.setLineDash([]),t.restore()}t.restore();const e=this.getPopulationCap(),s=this.colonists.filter(n=>!!n.inside).length,o=this.RES.wood+this.RES.stone+this.RES.food,a=this.getStorageCapacity(),h=this.hotbar.map(n=>({key:String(n),name:B[n].name,cost:this.costText(B[n].cost||{}),selected:this.selectedBuild===n}));Yt(this.ctx,this.canvas,{res:this.RES,colonists:this.colonists.length,cap:e,hiding:s,day:this.day,tDay:this.tDay,isNight:this.isNight(),hotbar:h,messages:this.messages,storage:{used:o,max:a}},this),this.selColonist?this.drawColonistProfile(this.selColonist):this.colonistPanelRect=this.colonistPanelCloseRect=null,this.showBuildMenu&&this.drawBuildMenu(),this.pendingPlacement&&this.drawPlacementUI()}costText(t){const e=[];return t.wood&&e.push(`${t.wood}w`),t.stone&&e.push(`${t.stone}s`),t.food&&e.push(`${t.food}f`),e.join(" ")}win(){this.paused=!0,this.msg("You survived! Day 8 reached.","good"),alert("You survived to Day 8 ‚Äî victory!")}lose(){this.paused=!0,this.msg("HQ destroyed. Colony fell.","bad"),alert("Your HQ was destroyed. Game over.")}rebuildNavGrid(){bt(this.grid);for(const t of this.buildings)t.kind!=="hq"&&t.kind!=="path"&&t.kind!=="house"&&St(this.grid,t.x,t.y,t.w,t.h),t.kind==="path"&&Tt(this.grid,t.x,t.y,t.w,t.h,.6)}computePath(t,e,s,o){return vt(this.grid,t,e,s,o)}cellIndexAt(t,e){const s=Math.floor(t/u),o=Math.floor(e/u);return s<0||o<0||s>=this.grid.cols||o>=this.grid.rows?-1:o*this.grid.cols+s}isBlocked(t,e){const s=this.cellIndexAt(t,e);return s<0?!0:!!this.grid.solid[s]}isBlockedByResources(t,e,s){for(const o of this.trees){if(s&&o===s)continue;const a=t-o.x,h=e-o.y;if(a*a+h*h<=o.r*o.r)return!0}for(const o of this.rocks){if(s&&o===s)continue;const a=t-o.x,h=e-o.y;if(a*a+h*h<=o.r*o.r)return!0}return!1}bestApproachToCircle(t,e,s){let o=null,a=1/0;const h=16;for(let r=0;r<h;r++){const c=r/h*Math.PI*2,d=e.x-Math.cos(c)*(s-6),f=e.y-Math.sin(c)*(s-6);if(this.isBlocked(d,f)||this.isBlockedByResources(d,f,e))continue;const y=(t.x-d)*(t.x-d)+(t.y-f)*(t.y-f);y<a&&(a=y,o={x:d,y:f})}if(o)return Math.random()<.02&&console.log(`Approach point found: (${o.x.toFixed(1)}, ${o.y.toFixed(1)}) for resource at (${e.x.toFixed(1)}, ${e.y.toFixed(1)})`),o;const n=Math.atan2(e.y-t.y,e.x-t.x),l={x:e.x-Math.cos(n)*(s-6),y:e.y-Math.sin(n)*(s-6)};return Math.random()<.02&&console.log(`Using fallback approach point: (${l.x.toFixed(1)}, ${l.y.toFixed(1)}) for resource at (${e.x.toFixed(1)}, ${e.y.toFixed(1)})`),l}drawColonistProfile(t){const e=this.ctx,s=this.canvas.width,o=this.canvas.height,a=Math.min(this.scale(320),s*.4),h=Math.min(this.scale(200),o*.35),n=this.scale(12),l=s-a-n,r=this.scale(54),c=Math.min(r,o-h-n);e.save(),e.fillStyle="#0b1220cc",e.fillRect(l,c,a,h),e.strokeStyle="#1e293b",e.strokeRect(l+.5,c+.5,a-1,h-1);const d=this.scale(26),f=this.scale(8),y=l+a-f-d,g=c+f;e.fillStyle="#0f172a",e.fillRect(y,g,d,d),e.strokeStyle="#1e293b",e.strokeRect(y+.5,g+.5,d-1,d-1),e.fillStyle="#dbeafe",e.font=this.getScaledFont(16,"700"),e.textAlign="center",e.textBaseline="middle",e.fillText("‚úï",y+d/2,g+d/2+this.scale(1));const w=this.scale(64),p=l+this.scale(18),x=c+this.scale(26);e.fillStyle="#0f172a",e.fillRect(p,x,w,w),e.strokeStyle="#1e293b",e.strokeRect(p+.5,x+.5,w-1,w-1),e.save(),e.translate(p+w/2,x+w/2+this.scale(4)),e.scale(this.uiScale*2,this.uiScale*2),dt(e,0,0,10,"#93c5fd"),e.restore(),e.fillStyle="#dbeafe",e.font=this.getScaledFont(14,"600"),e.fillText("Colonist",l+w+this.scale(32),c+this.scale(22)),e.font=this.getScaledFont(13);const S=t.inside?"Resting":t.task?t.task:"Idle",m=Math.max(0,Math.min(100,t.hp|0)),b=Math.max(0,Math.min(100,(t.fatigue||0)|0)),T=Math.max(0,Math.min(100,(t.hunger||0)|0)),R=l+w+this.scale(32);let A=c+this.scale(45);const v=this.scale(24);this.barRow(R,A,"Health",m,"#22c55e"),A+=v,this.barRow(R,A,"Tiredness",b,"#eab308"),A+=v,this.barRow(R,A,"Hunger",T,"#f87171"),A+=v,e.fillStyle="#9fb3c8",e.fillText(`Task: ${S}`,R,A+this.scale(12)),A+=this.scale(18),e.fillText(`Pos: ${t.x|0}, ${t.y|0}`,R,A),A+=this.scale(18),e.fillText(this.follow?"Camera: Following (Esc to stop)":"Camera: Click colonist to follow",R,Math.min(A,c+h-this.scale(8))),this.colonistPanelRect={x:l,y:c,w:a,h},this.colonistPanelCloseRect={x:y,y:g,w:d,h:d},e.restore()}barRow(t,e,s,o,a){const h=this.ctx;h.fillStyle="#dbeafe",h.fillText(s,t,e);const n=this.scale(140),l=this.scale(10),r=this.scale(70);h.fillStyle="#0f172a",h.fillRect(t+r,e-this.scale(8),n,l),h.strokeStyle="#1e293b",h.strokeRect(t+r+.5,e-this.scale(8)+.5,n-1,l-1),h.fillStyle=a,h.fillRect(t+r+this.scale(2),e-this.scale(6),Math.max(0,Math.min(n-this.scale(4),o/100*(n-this.scale(4)))),l-this.scale(4))}drawBuildMenu(){const t=this.ctx,e=this.canvas.width,s=this.canvas.height,o=this.isTouch?980:860,a=this.isTouch?720:620,h=this.isTouch?28:40,n=this.isTouch?60:80,l=Math.min(this.scale(o),e-this.scale(h)),r=Math.min(this.scale(a),s-this.scale(n)),c=(e-l)/2,d=(s-r)/2;t.save(),t.fillStyle="#0b1628dd",t.fillRect(c,d,l,r),t.strokeStyle="#1e293b",t.strokeRect(c+.5,d+.5,l-1,r-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(this.isTouch?22:18,"600"),t.fillText("Build Menu (B to close)",c+this.scale(14),d+this.scale(24));const f=Pt(B),y=Object.keys(f),g=this.scale(this.isTouch?36:28),w=Math.floor((l-g)/Math.max(1,y.length));this.menuRects=[];let p=null;for(let m=0;m<y.length;m++){const b=c+this.scale(12)+m*w;let T=d+this.scale(50);const R=y[m];t.fillStyle="#93c5fd",t.font=this.getScaledFont(this.isTouch?18:15,"600"),t.fillText(R,b,T),T+=this.scale(this.isTouch?12:8);const A=f[R];for(const[v,I]of A){T+=this.scale(this.isTouch?12:8);const D=this.scale(this.isTouch?78:58),F=w-this.scale(18),P=b,C=T,z=this.mouse.x*this.DPR,Z=this.mouse.y*this.DPR,U=z>=P&&z<=P+F&&Z>=C&&Z<=C+D;t.fillStyle=this.selectedBuild===v?"#102034":U?"#1a1f2e":"#0f172a",t.fillRect(P,C,F,D),t.strokeStyle=this.selectedBuild===v?"#4b9fff":U?"#3b82f6":"#1e293b",t.strokeRect(P+.5,C+.5,F-1,D-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(this.isTouch?18:15,"600"),t.fillText(I.name,P+this.scale(10),C+this.scale(this.isTouch?22:18));const j=this.costText(I.cost||{});t.fillStyle="#9fb3c8",t.font=this.getScaledFont(this.isTouch?14:12);const K=Math.min(this.scale(this.isTouch?120:100),t.measureText(j).width+this.scale(4));if(t.fillText(j,P+F-K,C+this.scale(this.isTouch?22:18)),I.description){t.fillStyle="#94a3b8",t.font=this.getScaledFont(this.isTouch?14:12);const _=F-this.scale(18);let Q=I.description;for(;t.measureText(Q).width>_&&Q.length>10;)Q=Q.substring(0,Q.length-4)+"...";t.fillText(Q,P+this.scale(10),C+this.scale(this.isTouch?46:36))}if(U&&I.description&&(p={key:v,desc:I.description}),this.menuRects.push({key:v,x:P,y:C,w:F,h:D}),T+=D,T>d+r-this.scale(this.isTouch?90:70))break}}if(p){const m=this.scale(this.isTouch?16:14),b=this.scale(this.isTouch?420:360);t.font=this.getScaledFont(this.isTouch?16:14);const T=this.wrapText(p.desc,b-m*2),R=this.scale(this.isTouch?20:18),A=T.length*R+m*2,v=this.mouse.x*this.DPR,I=this.mouse.y*this.DPR;let D=v+this.scale(20),F=I-A-this.scale(10);D+b>e&&(D=v-b-this.scale(20)),F<0&&(F=I+this.scale(20)),t.fillStyle="#0f1419f0",t.fillRect(D,F,b,A),t.strokeStyle="#374151",t.strokeRect(D+.5,F+.5,b-1,A-1),t.fillStyle="#e5e7eb";for(let P=0;P<T.length;P++)t.fillText(T[P],D+m,F+m+(P+1)*R-this.scale(4))}t.fillStyle="#9fb3c8",t.font=this.getScaledFont(this.isTouch?16:14);const x="Click a building to select ‚Ä¢ Hover for details ‚Ä¢ Press B to close",S=t.measureText(x).width;t.fillText(x,(e-S)/2,d+r+this.scale(this.isTouch?30:24)),t.restore()}wrapText(t,e){const s=this.ctx,o=t.split(" "),a=[];let h="";for(const n of o){const l=h+(h?" ":"")+n;s.measureText(l).width<=e?h=l:(h&&a.push(h),h=n)}return h&&a.push(h),a}handleBuildMenuClick(){const t=this.mouse.x*this.DPR,e=this.mouse.y*this.DPR;for(const s of this.menuRects)if(t>=s.x&&t<=s.x+s.w&&e>=s.y&&e<=s.y+s.h){this.selectedBuild=s.key,this.showBuildMenu=!1,this.toast("Selected: "+B[s.key].name);return}this.showBuildMenu=!1}drawPlacementUI(){const t=this.pendingPlacement;if(!t)return;const e=B[t.key],s=this.ctx,o=e.size.w*u,a=e.size.h*u,n=((m,b)=>({x:(m-this.camera.x)*this.camera.zoom,y:(b-this.camera.y)*this.camera.zoom}))(t.x,t.y),l=o*this.camera.zoom,r=a*this.camera.zoom,c=this.canPlace({...e,size:e.size},t.x,t.y)&&q(this.RES,e.cost);s.save(),s.globalAlpha=.6,s.fillStyle=c?E.ghost:"#ff6b6b88",s.fillRect(n.x,n.y,l,r),s.globalAlpha=1,s.strokeStyle="#4b9fff",s.setLineDash([4,3]),s.strokeRect(n.x+.5,n.y+.5,l-1,r-1),s.setLineDash([]),s.restore();const d=this.scale(10),f=this.scale(38);let y=n.x+l+d,g=n.y;const w=this.canvas.width;y+f*3>w-this.scale(6)&&(y=Math.max(this.scale(6),n.x-d-f*3));const p=(m,b,T)=>({id:m,x:b,y:T,w:f,h:f}),x=[p("up",y+f,g),p("left",y,g+f),p("right",y+f*2,g+f),p("down",y+f,g+f*2),p("cancel",y,g+f*3+this.scale(4)),p("ok",y+f*2,g+f*3+this.scale(4))];this.placeUIRects=x,s.save(),s.fillStyle="#0f172aee",s.strokeStyle="#1e293b";const S=(m,b,T=!1)=>{s.globalAlpha=T?.5:1,s.fillRect(m.x,m.y,m.w,m.h),s.strokeRect(m.x+.5,m.y+.5,m.w-1,m.h-1),s.fillStyle="#dbeafe",s.font=this.getScaledFont(18,"600"),s.textAlign="center",s.textBaseline="middle",s.fillText(b,m.x+m.w/2,m.y+m.h/2+this.scale(2)),s.fillStyle="#0f172aee",s.globalAlpha=1};for(const m of x)m.id==="up"?S(m,"‚Üë"):m.id==="down"?S(m,"‚Üì"):m.id==="left"?S(m,"‚Üê"):m.id==="right"?S(m,"‚Üí"):m.id==="ok"?S(m,"OK",!c):m.id==="cancel"&&S(m,"X");s.restore()}isInPanZone(t,e){if(!this.isTouch)return!1;const s=Math.max(32,this.scale(26)),o=document.querySelector("header"),a=o?Math.ceil(o.getBoundingClientRect().height):48,h=this.scale(this.isTouch?56:44)+a*this.DPR;return t<=s&&e>=h}}const O=document.getElementById("game"),ft=document.getElementById("btnPause"),Xt=document.getElementById("btnHelp"),Gt=document.getElementById("btnNew"),V=document.getElementById("help");V&&(V.innerHTML=`
    <h2>How to play</h2>
    <div><b>Goal:</b> Gather wood & stone, build farms for food, add houses for pop cap; survive nightly raids with turrets/walls.</div>
  <div><b>Controls:</b> 1..9 quick-build, <b>B</b> build menu, LMB place, RMB cancel/erase; WASD pan; Space pause; H toggle help; +/- zoom; F fast-forward.</div>
  `);async function qt(){const i=O.getContext("2d");i&&(i.fillStyle="#0a0e14",i.fillRect(0,0,O.width,O.height),i.fillStyle="#dbeafe",i.font="24px system-ui",i.textAlign="center",i.fillText("Loading assets...",O.width/2,O.height/2));try{await J.getInstance().loadAssets(),console.log("Assets loaded successfully"),console.log("House image loaded:",!!J.getInstance().getImage("house"))}catch(s){console.warn("Some assets failed to load:",s)}const t=new Ht(O);ft.onclick=()=>{t.paused=!t.paused,ft.textContent=t.paused?"Resume":"Pause"},Gt.onclick=()=>{t.newGame()},Xt.onclick=()=>{V&&(V.hidden=!V.hidden)},Object.assign(window,{game:t,BUILD_TYPES:B});const e="ontouchstart"in window||navigator.maxTouchPoints>0;if(e){let s=null,o=null,a=!1;O.addEventListener("touchstart",h=>{if(e){if(h.touches.length===1){const n=O.getBoundingClientRect(),l=h.touches[0].clientX-n.left,r=h.touches[0].clientY-n.top;a=t.isInPanZone(l*t.DPR,r*t.DPR),a&&(o={x:h.touches[0].clientX,y:h.touches[0].clientY})}else if(h.touches.length===2){const n=h.touches[0].clientX-h.touches[1].clientX,l=h.touches[0].clientY-h.touches[1].clientY;s=Math.hypot(n,l)}}},{passive:!1}),O.addEventListener("touchmove",h=>{if(e){if(h.touches.length===1&&o&&a){const n=h.touches[0].clientX,l=h.touches[0].clientY,r=n-o.x,c=l-o.y;o={x:n,y:l},t.camera.x-=r*(1/t.camera.zoom)*t.DPR,t.camera.y-=c*(1/t.camera.zoom)*t.DPR,h.preventDefault()}else if(h.touches.length===2){const n=h.touches[0].clientX-h.touches[1].clientX,l=h.touches[0].clientY-h.touches[1].clientY,r=Math.hypot(n,l);if(s!=null){const c=r/(s||r);t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom*c)),h.preventDefault()}s=r}}},{passive:!1}),O.addEventListener("touchend",h=>{if(e){if(h.changedTouches.length===1&&!a){const n=O.getBoundingClientRect(),l=h.changedTouches[0].clientX-n.left,r=h.changedTouches[0].clientY-n.top;t.handleTapOrClickAtScreen(l,r)}h.touches.length===0&&(o=null,s=null,a=!1),h.preventDefault()}},{passive:!1})}}qt();
