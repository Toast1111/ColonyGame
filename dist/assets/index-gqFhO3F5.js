var Ct=Object.defineProperty;var Ft=(i,t,o)=>t in i?Ct(i,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[t]=o;var k=(i,t,o)=>Ft(i,typeof t!="symbol"?t+"":t,o);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function o(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function e(n){if(n.ep)return;n.ep=!0;const l=o(n);fetch(n.href,l)}})();const W=(i,t)=>Math.random()*(t-i)+i,Dt=(i,t)=>Math.floor(W(i,t)),L=(i,t,o)=>Math.max(t,Math.min(o,i)),E=(i,t)=>{const o=i.x-t.x,e=i.y-t.y;return o*o+e*e},Ot=i=>Math.hypot(i.x,i.y),Bt=i=>{const t=Ot(i)||1;return{x:i.x/t,y:i.y/t}},At=(i,t)=>({x:i.x-t.x,y:i.y-t.y}),x=32,b={w:240*x,h:240*x},N={x:b.w/2,y:b.h/2},I={sky:"#0a0e14",ground:"#0e161f",colonist:"#c7f9cc",enemy:"#ff9aa2",tree:"#6fbf73",rock:"#9aa5b1",ghost:"#6ee7ff",wall:"#9aa5b1",bld:"#93c5fd",turret:"#93c5fd",farm:"#8bd3dd",house:"#e2b714",stock:"#c084fc",tent:"#f59e0b"},yt={start:.72,end:.07};function Wt(){const i=Math.ceil(b.w/x),t=Math.ceil(b.h/x);return{cols:i,rows:t,solid:new Uint8Array(i*t),cost:new Float32Array(i*t).fill(1)}}function Yt(i){i.solid.fill(0),i.cost.fill(1)}function Nt(i,t,o,e,n){const l=Math.floor(t/x),r=Math.floor(o/x),a=Math.ceil(e/x),s=Math.ceil(n/x);for(let h=0;h<s;h++)for(let c=0;c<a;c++){const d=l+c,f=r+h;d<0||f<0||d>=i.cols||f>=i.rows||(i.solid[f*i.cols+d]=1)}}function zt(i,t,o,e,n,l){const r=Math.floor(t/x),a=Math.floor(o/x),s=Math.ceil(e/x),h=Math.ceil(n/x);for(let c=0;c<h;c++)for(let d=0;d<s;d++){const f=r+d,y=a+c;if(f<0||y<0||f>=i.cols||y>=i.rows)continue;const g=y*i.cols+f;i.cost[g]=Math.min(i.cost[g],l)}}function gt(i,t,o,e){return Math.abs(i-o)+Math.abs(t-e)}function Lt(i,t,o,e,n){const l=i.cols,r=i.rows,a={x:Math.floor(t/x),y:Math.floor(o/x)},s={x:Math.floor(e/x),y:Math.floor(n/x)},h=(T,P)=>P*l+T;if(a.x===s.x&&a.y===s.y)return[{x:e,y:n}];const c=[],d=new Int32Array(l*r).fill(-1),f=new Int32Array(l*r).fill(1e9),y=new Int32Array(l*r).fill(1e9),g=(T,P)=>{const B=h(T,P);c.push(B)},u=()=>{let T=0,P=1e9;for(let v=0;v<c.length;v++){const C=y[c[v]];C<P&&(P=C,T=v)}return c.splice(T,1)[0]},p=(T,P)=>T>=0&&P>=0&&T<l&&P<r,m=h(a.x,a.y),w=h(s.x,s.y),S=(T,P)=>{if(!p(T,P))return!1;const B=h(T,P);return B===m||B===w?!0:i.solid[B]===0};f[m]=0,y[m]=gt(a.x,a.y,s.x,s.y),g(a.x,a.y);const M=[[1,0],[-1,0],[0,1],[0,-1]];for(;c.length;){const T=u(),P=T%l,B=T/l|0;if(P===s.x&&B===s.y){let v=[],C=T;for(;C!==-1;){const A=C%l,Y=C/l|0;v.push({x:A*x+x/2,y:Y*x+x/2}),C=d[C]}v.reverse(),v[v.length-1]={x:e,y:n};const D=[],O=(A,Y,_,j)=>{const V=_-A,tt=j-Y,st=Math.hypot(V,tt)||1,Q=Math.max(6,x*.33),ft=Math.ceil(st/Q);for(let it=1;it<ft;it++){const ut=it/ft,Et=A+V*ut,It=Y+tt*ut,ot=Math.floor(Et/x),nt=Math.floor(It/x);if(ot<0||nt<0||ot>=i.cols||nt>=i.rows||i.solid[nt*i.cols+ot])return!1}return!0};let R=0;for(;R<v.length;){D.push(v[R]);let A=R+2,Y=R+1;for(;A<v.length&&O(v[R].x,v[R].y,v[A].x,v[A].y);)Y=A,A++;R=Y}return D.length>=2&&(v=D),v}for(const[v,C]of M){const D=P+v,O=B+C;if(!S(D,O))continue;const R=h(D,O),A=i.cost[R]||1,Y=f[T]+A;Y<f[R]&&(d[R]=T,f[R]=Y,y[R]=Y+gt(D,O,s.x,s.y),c.includes(R)||c.push(R))}}return null}const F={house:{category:"Housing",name:"House",description:"Provides shelter for 2 colonists. Colonists can rest inside to recover fatigue.",key:"1",cost:{wood:20,stone:5},hp:220,size:{w:2,h:2},build:100,color:I.house,popCap:2},farm:{category:"Production",name:"Farm",description:"Grows crops that colonists can harvest for food. Takes 2 days to grow.",key:"2",cost:{wood:15},hp:120,size:{w:2,h:2},build:80,color:I.farm,growTime:1},turret:{category:"Defense",name:"Turret",description:"Automated defense structure. Shoots at enemies within range.",key:"3",cost:{wood:10,stone:20},hp:160,size:{w:1,h:1},build:120,color:I.turret,range:190,fireRate:.6,dps:30},wall:{category:"Defense",name:"Wall",description:"Blocks enemy movement. Essential for creating defensive perimeters.",key:"4",cost:{wood:5,stone:5},hp:150,size:{w:1,h:1},build:40,color:I.wall},stock:{category:"Utility",name:"Stockpile",description:"Increases resource storage capacity by 100. Colonists will store materials here.",key:"5",cost:{wood:10},hp:140,size:{w:2,h:2},build:60,color:I.stock,storageBonus:100},tent:{category:"Utility",name:"Recruit Tent",description:"Attracts new colonists every 60 seconds. Requires 15 food per recruit.",key:"6",cost:{wood:30,food:10},hp:140,size:{w:2,h:2},build:80,color:I.tent},warehouse:{category:"Utility",name:"Warehouse",description:"Large storage facility. Increases resource capacity by 300.",key:"7",cost:{wood:40,stone:20},hp:260,size:{w:3,h:2},build:160,color:I.stock,storageBonus:300},well:{category:"Production",name:"Well",description:"Provides clean water. Colonists can collect water here for food production.",key:"8",cost:{stone:25},hp:160,size:{w:1,h:1},build:80,color:I.farm},infirmary:{category:"Utility",name:"Infirmary",description:"Heals injured colonists within range. Essential for colony survival.",key:"9",cost:{wood:30,stone:20,food:10},hp:200,size:{w:2,h:2},build:140,color:I.bld,healRate:3,healRange:140,popCap:2},path:{category:"Utility",name:"Path",description:"Improves colonist movement speed by 50%. Cheap way to optimize traffic flow.",key:"0",cost:{wood:0},hp:1,size:{w:1,h:1},build:5,color:"#475569",speedBonus:1.5}};function et(i,t){if(!t)return!0;for(const o of Object.keys(t))if((i[o]||0)<(t[o]||0))return!1;return!0}function lt(i,t){if(t)for(const o of Object.keys(t))i[o]-=t[o]||0}function at(i,t,o){const e=F[i],n=Math.floor(t/x)*x,l=Math.floor(o/x)*x;return{kind:i,...e,x:n,y:l,w:e.size.w*x,h:e.size.h*x,hp:e.hp,buildLeft:e.build,done:!1,growth:0,ready:!1,cooldown:0}}function $t(i){const t={};for(const o of Object.keys(i)){const e=i[o],n=e.category||"Other";(t[n]||(t[n]=[])).push([o,e])}for(const o of Object.keys(t))t[o].sort((e,n)=>e[1].name.localeCompare(n[1].name));return t}const Qt="data:image/png;base64,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",X=class X{constructor(){k(this,"images",new Map);k(this,"loaded",!1)}static getInstance(){return X.instance||(X.instance=new X),X.instance}async loadAssets(){const o=[{name:"house",path:Qt}].map(e=>this.loadImage(e.name,e.path));try{await Promise.all(o),this.loaded=!0}catch{console.warn("Some assets failed to load, continuing with fallbacks"),this.loaded=!0}}loadImage(t,o){return new Promise((e,n)=>{const l=new Image;l.onload=()=>{this.images.set(t,l),console.log(`Loaded image: ${t}`),e()},l.onerror=()=>{console.warn(`Failed to load image: ${t} from ${o}`),n(new Error(`Failed to load ${t}`))},l.src=o})}getImage(t){return this.images.get(t)||null}isLoaded(){return this.loaded}};k(X,"instance");let Z=X;function Ht(i,t){i.setTransform(1,0,0,1,0,0),i.fillStyle=I.sky,i.fillRect(0,0,t.width,t.height)}function Ut(i,t){i.translate(-t.x*t.zoom,-t.y*t.zoom),i.scale(t.zoom,t.zoom)}function Gt(i){i.fillStyle=I.ground,i.fillRect(0,0,b.w,b.h),i.globalAlpha=.08,i.strokeStyle="#d6e4ff",i.lineWidth=1,i.beginPath();for(let t=0;t<=b.w;t+=x)i.moveTo(t,0),i.lineTo(t,b.h);for(let t=0;t<=b.h;t+=x)i.moveTo(0,t),i.lineTo(b.w,t);i.stroke(),i.globalAlpha=1}function ht(i,t,o,e,n){i.fillStyle=n,i.beginPath(),i.arc(t,o,e,0,Math.PI*2),i.fill()}function Xt(i,t,o,e,n,l,r=0){i.fillStyle=l,i.beginPath();for(let a=0;a<n;a++){const s=r+a*2*Math.PI/n,h=t+Math.cos(s)*e,c=o+Math.sin(s)*e;a===0?i.moveTo(h,c):i.lineTo(h,c)}i.closePath(),i.fill()}function xt(i,t,o,e=10,n=I.colonist){i.save(),i.translate(t,o);const l="#0b0f14",r=e*.32,a=-e*.3;i.fillStyle=n,i.beginPath(),i.arc(0,a,r,0,Math.PI*2),i.fill(),i.strokeStyle=l,i.lineWidth=1,i.beginPath(),i.arc(0,a,r+.5,0,Math.PI*2),i.stroke();const s=e*.55,h=e*.55,c=-e*.05;i.fillStyle=n,i.beginPath(),i.moveTo(-s/2,c-h/2),i.lineTo(s/2,c-h/2),i.lineTo(s/2,c+h/2),i.lineTo(-s/2,c+h/2),i.closePath(),i.fill(),i.strokeStyle=l,i.stroke();const d=e*.18,f=e*.5,y=c+h/2+f*.1;i.fillStyle=n,i.fillRect(-d-.6,y-f,d,f),i.fillRect(.6,y-f,d,f),i.strokeStyle=l,i.strokeRect(-d-.6,y-f,d,f),i.strokeRect(.6,y-f,d,f),i.restore()}function qt(i,t,o,e=12,n="#60a5fa"){i.save(),i.translate(t,o),i.fillStyle=n,i.strokeStyle="#0b0f14",i.lineWidth=1,i.beginPath();const l=e,r=e*1.2;i.moveTo(0,-r*.5),i.lineTo(l*.35,-r*.25),i.lineTo(l*.35,r*.1),i.quadraticCurveTo(0,r*.55,-l*.35,r*.1),i.lineTo(-l*.35,-r*.25),i.closePath(),i.fill(),i.stroke(),i.restore()}function jt(i,t){if(t.kind==="path"){i.fillStyle="#1f2937",i.fillRect(t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1);return}if(t.kind==="house"){const o=Z.getInstance(),e=o.getImage("house");e&&o.isLoaded()?(i.drawImage(e,t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1)):(i.fillStyle=t.color,i.fillRect(t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1))}else i.fillStyle=t.color,i.fillRect(t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1);if(!t.done){i.fillStyle="#0b1220",i.fillRect(t.x,t.y-6,t.w,4),i.fillStyle="#6ee7ff";const o=1-t.buildLeft/t.build;i.fillRect(t.x,t.y-6,o*t.w,4)}if(t.kind!=="house"){i.fillStyle="#0b0f14aa",i.font="bold 12px system-ui";const o=t.x+t.w/2,e=t.y+t.h/2;let n="B";t.kind==="hq"?n="HQ":t.kind==="farm"?n=t.ready?"F*":"F":t.kind==="turret"?n="T":t.kind==="wall"?n="W":t.kind==="stock"?n="S":t.kind==="tent"?n="R":t.kind==="warehouse"?n="WH":t.kind==="well"?n="WL":t.kind==="infirmary"&&(n="I"),i.textAlign="center",i.textBaseline="middle",i.fillText(n,o,e)}if(t.kind==="turret"&&t.range){const o=t.x+t.w/2,e=t.y+t.h/2;i.globalAlpha=.07,i.fillStyle="#e2f3ff",i.beginPath(),i.arc(o,e,t.range,0,Math.PI*2),i.fill(),i.globalAlpha=1}}function Vt(i,t){for(const o of t)i.globalAlpha=.8,i.strokeStyle="#e0f2fe",i.lineWidth=2,i.beginPath(),i.moveTo(o.x,o.y),i.lineTo(o.tx,o.ty),i.stroke(),i.globalAlpha=1}function Jt(i,t,o,e){e.uiScale;const n=e.scale(e.isTouch?14:10),l=e.scale(e.isTouch?56:44),r=t.width;i.fillStyle="#0b122088",i.fillRect(0,0,r,l),i.strokeStyle="#1e293b",i.lineWidth=1,i.strokeRect(0,.5,r,l),i.fillStyle="#dbeafe",i.font=e.getScaledFont(e.isTouch?18:16,"600");let a=n;const s=Math.max(e.scale(e.isTouch?170:130),Math.min(e.scale(e.isTouch?260:220),Math.round(t.width*.14)));if(U(i,a,e.scale(12),`Wood: ${Math.floor(o.res.wood)}`,"#b08968",e),a+=s,U(i,a,e.scale(12),`Stone: ${Math.floor(o.res.stone)}`,"#9aa5b1",e),a+=Math.max(s,e.scale(e.isTouch?220:180)),U(i,a,e.scale(12),`Food: ${Math.floor(o.res.food)}`,"#9ae6b4",e),a+=s,o.storage){const p=Math.floor(o.storage.used/o.storage.max*100),m=p>90?"#ef4444":p>70?"#eab308":"#22c55e";U(i,a,e.scale(12),`Storage: ${Math.floor(o.storage.used)}/${o.storage.max} (${p}%)`,m,e),a+=Math.max(s,e.scale(e.isTouch?260:200))}const h=`Colonists: ${o.colonists}/${o.cap}`;U(i,a,e.scale(12),h,"#93c5fd",e),a+=Math.max(s,e.scale(e.isTouch?260:210));const c=`Hiding: ${o.hiding}`;U(i,a,e.scale(12),c,"#60a5fa",e),a+=Math.max(e.scale(e.isTouch?180:140),s*.9|0);const d=`Day ${o.day} — ${o.tDay*24|0}:00 ${o.isNight?"🌙":"☀️"}`;U(i,a,e.scale(12),d,o.isNight?"#ffd166":"#6ee7ff",e);const f=t.height-e.scale(e.isTouch?86:64),y=Math.max(e.scale(e.isTouch?170:140),Math.min(e.scale(e.isTouch?260:220),(t.width-n*2)/o.hotbar.length));a=n,i.fillStyle="#0b122088",i.fillRect(0,f,t.width,e.scale(e.isTouch?86:64)),i.strokeStyle="#1e293b",i.strokeRect(0,f+.5,t.width,e.scale(e.isTouch?86:64)),i.font=e.getScaledFont(e.isTouch?17:15);for(let p=0;p<o.hotbar.length;p++){const m=o.hotbar[p],w=a+e.scale(2),S=f+e.scale(e.isTouch?14:10),M=y-e.scale(6),T=e.scale(e.isTouch?60:44);Kt(i,w,S,M,T,`${p+1}. ${m.name}`,m.cost,m.selected,e),Array.isArray(e.hotbarRects)&&(e.hotbarRects[p]={index:p,x:w,y:S,w:M,h:T}),a+=y}let g=l+e.scale(e.isTouch?12:8);const u=Math.min(e.scale(e.isTouch?520:420),t.width-n*2);for(let p=o.messages.length-1;p>=0;p--){const m=o.messages[p];Zt(i,r-u-n,g,m.text,u,e),g+=e.scale(e.isTouch?34:26)}}function U(i,t,o,e,n,l){const r=i.measureText(e).width+l.scale(l.isTouch?28:24),a=l.scale(l.isTouch?32:26);i.fillStyle="#0f172a",i.fillRect(t,o,r,a),i.strokeStyle="#1e293b",i.strokeRect(t+.5,o+.5,r-1,a-1),i.fillStyle=n,i.fillRect(t+l.scale(3),o+l.scale(3),l.scale(l.isTouch?10:8),a-l.scale(6)),i.fillStyle="#dbeafe",i.fillText(e,t+l.scale(l.isTouch?18:16),o+l.scale(l.isTouch?22:18))}function Kt(i,t,o,e,n,l,r,a,s){i.fillStyle=a?"#102034":"#0f172a",i.fillRect(t,o,e,n),i.strokeStyle=a?"#4b9fff":"#1e293b",i.strokeRect(t+.5,o+.5,e-1,n-1),i.fillStyle="#dbeafe",i.fillText(l,t+s.scale(10),o+s.scale(s.isTouch?36:28)),i.fillStyle="#9fb3c8",i.fillText(r,t+e-s.scale(s.isTouch?66:56),o+s.scale(s.isTouch?36:28))}function Zt(i,t,o,e,n,l){const r=l.scale(l.isTouch?30:24);i.fillStyle="#0f172aee",i.fillRect(t,o,n,r),i.strokeStyle="#1e293b",i.strokeRect(t+.5,o+.5,n-1,r-1),i.fillStyle="#dbeafe",i.fillText(e,t+l.scale(10),o+l.scale(l.isTouch?20:16))}function q(i,t,o,e){for(const n of i.buildings){if(n.kind==="hq"||n.kind==="path"||n.kind==="house"||!n.done)continue;const l=Math.max(n.x,Math.min(t,n.x+n.w)),r=Math.max(n.y,Math.min(o,n.y+n.h)),a=t-l,s=o-r;if(a*a+s*s<=e*e)return!0}return!1}function _t(i,t,o){const n=Math.floor(t/24)*24,l=Math.floor(o/24)*24,r=i.buildings.find(a=>a.kind==="path"&&a.done&&a.x===n&&a.y===l);return r&&r.speedBonus?r.speedBonus:1}function G(i,t,o,e,n,l=1){const r=o-t.x,a=e-t.y,s=Math.hypot(r,a);if(s<5)return!0;const h=_t(i,t.x,t.y),d=t.speed*l*h*n,f=r/s,y=a/s,g=t.x+f*d,u=t.y+y*d;if(q(i,g,u,t.r)){const p=-y,m=f,w=t.x+p*d*.5,S=t.y+m*d*.5;if(!q(i,w,S,t.r))return t.x=Math.max(0,Math.min(w,b.w)),t.y=Math.max(0,Math.min(S,b.h)),!1;const M=t.x-p*d*.5,T=t.y-m*d*.5;return q(i,M,T,t.r)||(t.x=Math.max(0,Math.min(M,b.w)),t.y=Math.max(0,Math.min(T,b.h))),!1}else return t.x=Math.max(0,Math.min(g,b.w)),t.y=Math.max(0,Math.min(u,b.h)),!1}function te(i,t){if(t.stuckTimer===void 0&&(t.stuckTimer=0),q(i,t.x,t.y,t.r)){if(t.stuckTimer+=1/60,t.stuckTimer>2){const e=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let n=!1;for(const l of[20,40,60,80]){for(const r of e){const a=t.x+Math.cos(r)*l,s=t.y+Math.sin(r)*l,h=Math.max(t.r,Math.min(a,b.w-t.r)),c=Math.max(t.r,Math.min(s,b.h-t.r));if(!q(i,h,c,t.r)){t.x=h,t.y=c,t.stuckTimer=0,n=!0,console.log(`Rescued stuck colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) using distance ${l}`);break}}if(n)break}if(!n){const l=i.buildings.find(r=>r.kind==="hq");l&&(t.x=l.x+l.w/2+(Math.random()-.5)*40,t.y=l.y-40+(Math.random()-.5)*20,t.stuckTimer=0,console.log("Emergency rescue: teleported stuck colonist to HQ area"))}return!0}}else t.stuckTimer=0;return!1}function ee(i,t,o){if(!t.alive)return;if(t.t+=o,t.state||(t.state="seekTask"),t.stateSince=(t.stateSince||0)+o,te(i,t)){t.task=null,t.target=null,i.clearPath&&i.clearPath(t),t.state="seekTask",t.stateSince=0;return}const e=t.state==="build"||t.state==="chop"||t.state==="mine"||t.state==="harvest"||t.state==="flee"||t.state==="move",n=e?1.6:t.inside?.6:1;t.hunger=Math.max(0,Math.min(100,(t.hunger||0)+o*n));const l=e?.8:.3;if(t.inside||t.state==="resting"||t.state==="sleep"?t.fatigue=Math.max(0,(t.fatigue||0)-o*8):t.fatigue=Math.min(100,(t.fatigue||0)+o*l),t.fatigueSlow=(t.fatigue||0)>66?.8:(t.fatigue||0)>33?.9:1,(t.hunger||0)>=95){const s=2*o;t.hp=Math.max(0,t.hp-s),Math.random()<.05&&console.log(`Colonist starving: hunger=${(t.hunger||0).toFixed(1)}, hp=${t.hp.toFixed(1)}, damage=${s.toFixed(2)}/frame`)}(t.hunger||0)<30&&!e&&!t.inside&&(t.hp=Math.min(100,t.hp+.8*o));const r=i.buildings.find(s=>s.kind==="infirmary"&&s.done);if(r){const s=r.healRange||140,h=r.healRate||3;(t.x-(r.x+r.w/2))**2+(t.y-(r.y+r.h/2))**2<=s*s&&(t.hp=Math.min(100,t.hp+h*o))}const a=i.enemies.find(s=>E(s,t)<140*140);switch(t.lastHp=t.lastHp??t.hp,t.hp<t.lastHp&&(t.hurt=1.5),t.lastHp=t.hp,t.hurt=Math.max(0,(t.hurt||0)-o),!t.inside&&a&&t.state!=="flee"&&(t.state="flee",t.stateSince=0),!t.inside&&!a&&i.isNight()&&t.state!=="sleep"&&t.state!=="flee"&&(t.state="sleep",t.stateSince=0),!t.inside&&(t.hp||0)<35&&t.state!=="flee"&&(t.state="heal",t.stateSince=0),!t.inside&&!a&&!i.isNight()&&(t.fatigue||0)>80&&t.state!=="flee"&&t.state!=="heal"&&t.state!=="goToSleep"&&(t.state="goToSleep",t.stateSince=0),!t.inside&&(t.hunger||0)>65&&(i.RES.food||0)>0&&t.state!=="flee"&&(t.state="eat",t.stateSince=0),t.inside&&t.state!=="resting"&&(t.state="resting",t.stateSince=0),t.state){case"resting":{t.hideTimer=Math.max(0,(t.hideTimer||0)-o),t.hp=Math.min(100,t.hp+1.2*o),!i.isNight()&&!a&&(t.hurt||0)<=0&&(t.hideTimer||0)<=0&&(i.leaveBuilding(t),t.safeTarget=null,t.safeTimer=0,t.state="seekTask",t.stateSince=0);break}case"heal":{const s=i.buildings.filter(u=>u.kind==="infirmary"&&u.done);if(!s.length){t.state="seekTask",t.stateSince=0;break}let h=s[0],c=E(t,i.centerOf(h));for(let u=1;u<s.length;u++){const p=E(t,i.centerOf(s[u]));p<c&&(c=p,h=s[u])}const d=i.centerOf(h),f=h.healRange||140,y=t.x>=h.x-8&&t.x<=h.x+h.w+8&&t.y>=h.y-8&&t.y<=h.y+h.h+8,g=Math.hypot(t.x-d.x,t.y-d.y);if(y&&i.tryEnterBuilding(t,h)){t.state="resting",t.stateSince=0;break}g<=f*.9?t.hp>=80&&(t.state="seekTask",t.stateSince=0):G(i,t,d.x,d.y,o,1);break}case"eat":{const s=(i.RES.food||0)>0;if(Math.random()<.1&&console.log(`COLONIST IN EAT STATE: food=${i.RES.food}, hunger=${t.hunger}, stateSince=${t.stateSince.toFixed(1)}, position=(${t.x.toFixed(1)}, ${t.y.toFixed(1)})`),!s){t.stateSince>1&&(t.hp=Math.max(0,t.hp-2.5*o)),console.log("NO FOOD AVAILABLE! Colonist will continue tasks or sleep."),t.state=i.isNight()?"sleep":"seekTask",t.stateSince=0;break}const h=i.buildings.filter(f=>(f.kind==="hq"||f.kind==="warehouse"||f.kind==="stock")&&f.done);if(console.log(`FOOD BUILDING SEARCH: Found ${h.length} food buildings:`,h.map(f=>`${f.kind} at (${(f.x+f.w/2).toFixed(1)}, ${(f.y+f.h/2).toFixed(1)})`)),console.log("ALL BUILDINGS:",i.buildings.filter(f=>f.done).map(f=>`${f.kind}(done=${f.done})`)),h.length===0){console.log(`No food buildings found! Available buildings: ${i.buildings.filter(f=>f.done).map(f=>f.kind).join(", ")}`),t.stateSince>1&&(i.RES.food-=1,t.hunger=Math.max(0,(t.hunger||0)-40),t.hp=Math.min(100,t.hp+2.5),t.state="seekTask",t.stateSince=0,console.log(`Colonist ate without building! Food remaining: ${i.RES.food}`));break}let c=null,d=1/0;for(const f of h){const y=i.centerOf(f),g=Math.hypot(t.x-y.x,t.y-y.y);g<d&&(d=g,c=f)}if(c){const f=i.centerOf(c),y=Math.max(c.w,c.h)/2+t.r+15;console.log(`EATING ATTEMPT: colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}), building at (${f.x.toFixed(1)}, ${f.y.toFixed(1)}), distance=${d.toFixed(1)}, reachDist=${y.toFixed(1)}, food=${i.RES.food}, stateSince=${t.stateSince.toFixed(1)}`),d<=y?(console.log("CLOSE ENOUGH TO EAT! Waiting for stateSince > 0.6..."),t.stateSince>.6&&(console.log(`EATING NOW! Before: food=${i.RES.food}, hunger=${t.hunger}`),i.RES.food-=1,t.hunger=Math.max(0,(t.hunger||0)-40),t.hp=Math.min(100,t.hp+2.5),t.state="seekTask",t.stateSince=0,console.log(`EATEN! After: food=${i.RES.food}, hunger=${t.hunger}`))):(console.log("TOO FAR FROM BUILDING, MOVING CLOSER..."),G(i,t,f.x,f.y,o,1.2))}break}case"flee":{let s=null,h=null;const c=a?i.findSafeTurret(t,a):null;if(c){const d=c.range||120,f=i.centerOf(c),y=i.buildings.find(g=>g.kind==="house"&&g.done&&i.buildingHasSpace(g)&&E(i.centerOf(g),f)<d*d);y&&(h=y,s=i.centerOf(y))}if(!s){const d=i.buildings.find(f=>f.kind==="hq"&&i.buildingHasSpace(f));d&&(h=d,s=i.centerOf(d))}if(!s&&c&&(s=i.centerOf(c)),s){const d=s.x-t.x,f=s.y-t.y,y=Math.hypot(d,f),g=h?t.x>=h.x-8&&t.x<=h.x+h.w+8&&t.y>=h.y-8&&t.y<=h.y+h.h+8:!1;if(y<=20||g)if(h&&i.tryEnterBuilding(t,h))t.hideTimer=3,t.state="resting",t.stateSince=0;else{const u=i.buildings.filter(p=>p.done&&i.buildingHasSpace(p)&&(p.kind==="house"||p.kind==="hq"));if(u.length){const p=u.sort((w,S)=>E(t,i.centerOf(w))-E(t,i.centerOf(S)))[0],m=i.centerOf(p);i.clearPath(t),h=p,s=m}}else G(i,t,s.x,s.y,o,1.8)}else{const d=Bt(At(t,a));t.x+=d.x*(t.speed+90)*o,t.y+=d.y*(t.speed+90)*o}a||(t.state="seekTask",t.stateSince=0);break}case"sleep":{const s=i.buildings.filter(p=>p.kind==="house"&&p.done&&i.isProtectedByTurret(p)&&i.buildingHasSpace(p));if(!i.isNight()||s.length===0){t.state="seekTask",t.stateSince=0;break}let h=s[0],c=E(t,i.centerOf(h));for(let p=1;p<s.length;p++){const m=E(t,i.centerOf(s[p]));m<c&&(c=m,h=s[p])}const d=i.centerOf(h),f=d.x-t.x,y=d.y-t.y,g=Math.hypot(f,y),u=t.x>=h.x-8&&t.x<=h.x+h.w+8&&t.y>=h.y-8&&t.y<=h.y+h.h+8;if(g<=20||u)if(i.tryEnterBuilding(t,h))t.hideTimer=0,t.state="resting",t.stateSince=0;else{const p=i.buildings.filter(m=>m.done&&i.buildingHasSpace(m)&&(m.kind==="house"||m.kind==="hq")).sort((m,w)=>E(t,i.centerOf(m))-E(t,i.centerOf(w)))[0];p?(i.centerOf(p),i.clearPath(t)):(t.state="seekTask",t.stateSince=0)}else G(i,t,d.x,d.y,o);break}case"goToSleep":{const s=i.buildings.filter(g=>(g.kind==="house"||g.kind==="infirmary")&&g.done&&i.buildingHasSpace(g));if(s.length===0){t.stateSince>3&&(t.state="seekTask",t.stateSince=0);break}let h=s[0],c=E(t,i.centerOf(h));for(let g=1;g<s.length;g++){const u=E(t,i.centerOf(s[g]));u<c&&(c=u,h=s[g])}const d=i.centerOf(h),f=Math.hypot(d.x-t.x,d.y-t.y),y=t.x>=h.x-8&&t.x<=h.x+h.w+8&&t.y>=h.y-8&&t.y<=h.y+h.h+8;if(f<=20||y)if(i.tryEnterBuilding(t,h))t.hideTimer=0,t.state="resting",t.stateSince=0;else{const g=s.filter(u=>u!==h&&i.buildingHasSpace(u)).sort((u,p)=>E(t,i.centerOf(u))-E(t,i.centerOf(p)))[0];g?(i.centerOf(g),i.clearPath(t)):(t.fatigue||0)<60&&(t.state="seekTask",t.stateSince=0)}else G(i,t,d.x,d.y,o,1.1);break}case"seekTask":{if(i.isNight()){t.state="sleep",t.stateSince=0;break}if(!t.task||t.task==="idle"&&Math.random()<.005){const s=t.task;i.pickTask(t),s!==t.task&&Math.random()<.1&&console.log(`Colonist assigned task: ${t.task}, target:`,t.target)}switch(t.task){case"build":t.state="build";break;case"harvestFarm":t.state="harvest";break;case"harvestWell":t.state="harvest";break;case"chop":t.state="chop";break;case"mine":t.state="mine";break;case"idle":default:t.state="idle";break}t.stateSince=0;break}case"idle":{const s=t.target;if(!s){t.state="seekTask";break}i.moveAlongPath(t,o,s,8)&&(t.task=null,t.target=null,i.clearPath(t),t.state="seekTask",t.stateSince=0);break}case"build":{const s=t.target;if(!s||s.done){i.releaseBuildReservation(t),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const h={x:s.x+s.w/2,y:s.y+s.h/2};if(i.moveAlongPath(t,o,h,12)&&(s.buildLeft-=25*o,s.buildLeft<=0)){if(s.done=!0,s.kind==="farm"&&(s.growth=0,s.ready=!1),q(i,t.x,t.y,t.r)){const c=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let d=!1;for(const f of c){const y=Math.max(s.w,s.h)/2+t.r+10,g=s.x+s.w/2+Math.cos(f)*y,u=s.y+s.h/2+Math.sin(f)*y,p=Math.max(t.r,Math.min(g,b.w-t.r)),m=Math.max(t.r,Math.min(u,b.h-t.r));if(!q(i,p,m,t.r)){t.x=p,t.y=m,d=!0,Math.random()<.1&&console.log(`Moved colonist to safety after building completion: (${t.x.toFixed(1)}, ${t.y.toFixed(1)})`);break}}if(!d){const f=i.buildings.find(y=>y.kind==="hq");f&&(t.x=f.x+f.w/2,t.y=f.y-30,console.log("Emergency teleport to HQ area after building completion"))}}i.msg(s.name?s.name+" complete":"Building complete"),i.rebuildNavGrid(),i.clearPath(t),i.releaseBuildReservation(t),t.task=null,t.target=null,t.state="seekTask"}break}case"harvest":{const s=t.target;if(!s){t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}if(s.kind==="farm"&&!s.ready){t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const h={x:s.x+s.w/2,y:s.y+s.h/2};if(i.moveAlongPath(t,o,h,12)){if(s.kind==="farm"){s.ready=!1,s.growth=0;const c=i.addResource("food",10);c>0&&i.msg(`Farm harvested (+${c} food)`,"good")}else if(s.kind==="well"){const c=i.addResource("food",5);c>0&&i.msg(`Well collected (+${c} food)`,"good")}t.task=null,t.target=null,i.clearPath(t),t.state="seekTask"}break}case"chop":{const s=t.target;if(!s||s.hp<=0){s&&i.assignedTargets.has(s)&&i.assignedTargets.delete(s),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const h=s.x-t.x,c=s.y-t.y,d=Math.hypot(h,c),f=(s.r||12)+t.r+4;if(d<=f+2.5+.1){if(s.hp-=18*o,s.hp<=0){const g=i.addResource("wood",6);i.trees.splice(i.trees.indexOf(s),1),i.assignedTargets.has(s)&&i.assignedTargets.delete(s),g>0&&i.msg(`+${g} wood`,"good"),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask"}break}else G(i,t,s.x,s.y,o);t.stateSince&&t.stateSince>15&&(i.assignedTargets.has(s)&&i.assignedTargets.delete(s),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask");break}case"mine":{const s=t.target;if(!s||s.hp<=0){s&&i.assignedTargets.has(s)&&i.assignedTargets.delete(s),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const h=s.x-t.x,c=s.y-t.y,d=Math.hypot(h,c),f=(s.r||12)+t.r+4,y=2.5;if(Math.random()<.01&&console.log(`Mining: distance=${d.toFixed(1)}, interact=${f}, colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}), rock at (${s.x.toFixed(1)}, ${s.y.toFixed(1)})`),d<=f+y+.1){if(s.hp-=16*o,s.hp<=0){const g=i.addResource("stone",5);i.rocks.splice(i.rocks.indexOf(s),1),i.assignedTargets.has(s)&&i.assignedTargets.delete(s),g>0&&i.msg(`+${g} stone`,"good"),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask"}break}else G(i,t,s.x,s.y,o),Math.random()<.01&&console.log(`Moving toward rock: target=(${s.x.toFixed(1)}, ${s.y.toFixed(1)}), distance=${d.toFixed(1)}`);t.stateSince&&t.stateSince>15&&(console.log(`Colonist stuck mining for ${t.stateSince.toFixed(1)}s, abandoning`),i.assignedTargets.has(s)&&i.assignedTargets.delete(s),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask");break}}for(const s of i.colonists){if(s===t)continue;if((t.state==="mine"||t.state==="chop")&&t.target){const y=(t.target.r||12)+t.r+4;if(Math.hypot(t.x-t.target.x,t.y-t.target.y)<=y+2.5)continue}const h=t.x-s.x,c=t.y-s.y,d=h*h+c*c,f=(t.r+2)*(t.r+2);if(d>0&&d<f*4){const y=Math.sqrt(d)||1,g=(f*2-y)*.5;t.x+=h/y*g*o*6,t.y+=c/y*g*o*6}}}function rt(i,t,o,e){for(const n of i.buildings){if(n.kind==="hq"||n.kind==="path"||n.kind==="house"||!n.done)continue;const l=Math.max(n.x,Math.min(t,n.x+n.w)),r=Math.max(n.y,Math.min(o,n.y+n.h)),a=t-l,s=o-r;if(a*a+s*s<=e*e)return!0}return!1}function se(i,t,o){const e=i.buildings.find(c=>c.kind==="hq");let n=e,l=E(t,i.centerOf(e));for(const c of i.colonists){const d=E(t,c);d<l&&(l=d,n=c)}const r=n.w?i.centerOf(n):n,a=Bt(At(r,t)),s=t.x+a.x*t.speed*o,h=t.y+a.y*t.speed*o;if(!rt(i,s,h,t.r))t.x=s,t.y=h;else{const c=-a.y,d=a.x,f=t.x+c*t.speed*o*.5,y=t.y+d*t.speed*o*.5;if(!rt(i,f,y,t.r))t.x=f,t.y=y;else{const g=t.x-c*t.speed*o*.5,u=t.y-d*t.speed*o*.5;rt(i,g,u,t.r)||(t.x=g,t.y=u)}}if(n.w){const c=n;i.pointInRect(t,c)&&(c.hp-=t.dmg*o),c.hp<=0&&(c.kind==="hq"?i.lose():(i.evictColonistsFrom(c),i.buildings.splice(i.buildings.indexOf(c),1),i.msg((c.name||c.kind)+" destroyed","warn")))}else{const c=n;Math.hypot(t.x-c.x,t.y-c.y)<t.r+8&&(c.hp-=t.dmg*o,c.hp<=0&&(c.alive=!1,i.colonists.splice(i.colonists.indexOf(c),1),i.msg("A colonist has fallen","warn")))}}class ie{constructor(t){k(this,"canvas");k(this,"ctx");k(this,"DPR",1);k(this,"camera",{x:0,y:0,zoom:1});k(this,"uiScale",1);k(this,"baseFontSize",14);k(this,"isTouch",!1);k(this,"RES",{wood:0,stone:0,food:0});k(this,"BASE_STORAGE",200);k(this,"storageFullWarned",!1);k(this,"day",1);k(this,"tDay",0);k(this,"dayLength",180);k(this,"fastForward",1);k(this,"paused",!1);k(this,"prevIsNight",!1);k(this,"colonists",[]);k(this,"enemies",[]);k(this,"trees",[]);k(this,"rocks",[]);k(this,"buildings",[]);k(this,"bullets",[]);k(this,"messages",[]);k(this,"selectedBuild","house");k(this,"hotbar",["house","farm","turret","wall","stock","tent","warehouse","well","infirmary"]);k(this,"showBuildMenu",!1);k(this,"debug",{nav:!1,paths:!0,colonists:!1});k(this,"selColonist",null);k(this,"follow",!1);k(this,"keyState",{});k(this,"once",new Set);k(this,"mouse",{x:0,y:0,wx:0,wy:0,down:!1,rdown:!1});k(this,"lastPaintCell",null);k(this,"eraseDragStart",null);k(this,"menuRects",[]);k(this,"hotbarRects",[]);k(this,"pendingPlacement",null);k(this,"placeUIRects",[]);k(this,"colonistPanelRect",null);k(this,"colonistPanelCloseRect",null);k(this,"handleResize",()=>{const t=document.querySelector("header"),o=t?Math.ceil(t.getBoundingClientRect().height):48,e=window.innerWidth,n=window.innerHeight-o;this.canvas.style.width=e+"px",this.canvas.style.height=n+"px",this.canvas.width=Math.floor(e*this.DPR),this.canvas.height=Math.floor(n*this.DPR),this.calculateUIScale()});k(this,"screenToWorld",(t,o)=>({x:t*this.DPR/this.camera.zoom+this.camera.x,y:o*this.DPR/this.camera.zoom+this.camera.y}));k(this,"respawnTimer",0);k(this,"assignedTargets",new WeakSet);k(this,"buildReservations",new Map);k(this,"insideCounts",new Map);k(this,"last",performance.now());k(this,"frame",t=>{const o=Math.min(.033,(t-this.last)/1e3);this.last=t,this.update(o),this.draw(),requestAnimationFrame(this.frame)});k(this,"grid",Wt());const o=t.getContext("2d");if(!o)throw new Error("no ctx");this.canvas=t,this.ctx=o,this.DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)),this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.bindInput(),this.newGame(),this.rebuildNavGrid(),requestAnimationFrame(this.frame)}getStorageCapacity(){let t=this.BASE_STORAGE;for(const o of this.buildings)o.done&&o.storageBonus&&(t+=o.storageBonus);return t}getPopulationCap(){return(this.buildings.find(t=>t.kind==="hq")?3:0)+this.buildings.filter(t=>t.kind==="house"&&t.done).reduce((t,o)=>t+(o.popCap||0),0)}addResource(t,o){const e=this.RES.wood+this.RES.stone+this.RES.food,n=this.getStorageCapacity(),l=Math.max(0,n-e),r=Math.min(Math.floor(o),l);return r>0&&(this.RES[t]+=r),r===0&&o>0&&!this.storageFullWarned?(this.msg(`Storage full! Cannot store more ${String(t)}`,"warn"),this.storageFullWarned=!0):r>0&&(this.storageFullWarned=!1),r}calculateUIScale(){const e=this.canvas.width/this.DPR,n=this.canvas.height/this.DPR,l=e/1920,r=n/1080;let a=Math.min(l,r);const s="ontouchstart"in window||navigator.maxTouchPoints>0;this.isTouch=s,s?e<600?a=Math.max(a*1.9,1.6):e<=900?a=Math.max(a*1.7,1.5):e<=1200?a=Math.max(a*1.5,1.35):a=Math.max(a*1.25,a):e<1200&&(a*=1.1),a=Math.max(1.1,Math.min(a,3)),this.uiScale=a,console.log(`UI Scale calculated: ${a.toFixed(2)} for ${e}x${n}`)}getScaledFont(t,o="500",e="system-ui,Segoe UI,Roboto"){return`${o} ${Math.round(t*this.uiScale)}px ${e}`}scale(t){return Math.round(t*this.uiScale)}bindInput(){const t=this.canvas;t.addEventListener("mousemove",o=>{const e=t.getBoundingClientRect();this.mouse.x=o.clientX-e.left,this.mouse.y=o.clientY-e.top;const n=this.screenToWorld(this.mouse.x,this.mouse.y);this.mouse.wx=n.x,this.mouse.wy=n.y,this.mouse.down&&(this.selectedBuild==="path"?this.paintPathAtMouse():this.selectedBuild==="wall"&&this.paintWallAtMouse())}),t.addEventListener("mousedown",o=>{if(o.preventDefault(),o.button===0){if(this.mouse.down=!0,this.selColonist){const l=this.mouse.x*this.DPR,r=this.mouse.y*this.DPR;if(this.colonistPanelCloseRect){const a=this.colonistPanelCloseRect;if(l>=a.x&&l<=a.x+a.w&&r>=a.y&&r<=a.y+a.h){this.selColonist=null,this.follow=!1;return}}if(this.colonistPanelRect){const a=this.colonistPanelRect;if(!(l>=a.x&&l<=a.x+a.w&&r>=a.y&&r<=a.y+a.h)){this.selColonist=null,this.follow=!1;return}}}if(this.pendingPlacement){const l=this.mouse.x*this.DPR,r=this.mouse.y*this.DPR;if(this.placeUIRects.length){for(const m of this.placeUIRects)if(l>=m.x&&l<=m.x+m.w&&r>=m.y&&r<=m.y+m.h){m.id==="up"?this.nudgePending(0,-1):m.id==="down"?this.nudgePending(0,1):m.id==="left"?this.nudgePending(-1,0):m.id==="right"?this.nudgePending(1,0):m.id==="ok"?this.confirmPending():m.id==="cancel"&&this.cancelPending();return}}const a=this.pendingPlacement,s=F[a.key],c=((m,w)=>({x:(m-this.camera.x)*this.camera.zoom,y:(w-this.camera.y)*this.camera.zoom}))(a.x,a.y),d=s.size.w*x*this.camera.zoom,f=s.size.h*x*this.camera.zoom;if(l>=c.x&&l<=c.x+d&&r>=c.y&&r<=c.y+f){this.confirmPending();return}const y=Math.floor(this.mouse.wx/x)*x,g=Math.floor(this.mouse.wy/x)*x,u=s.size.w*x,p=s.size.h*x;a.x=L(y,0,b.w-u),a.y=L(g,0,b.h-p);return}const e=this.mouse.x*this.DPR,n=this.mouse.y*this.DPR;for(const l of this.hotbarRects)if(e>=l.x&&e<=l.x+l.w&&n>=l.y&&n<=l.y+l.h){const r=this.hotbar[l.index];r&&(this.selectedBuild=r,this.toast("Selected: "+F[r].name));return}if(this.showBuildMenu){this.handleBuildMenuClick();return}if(this.selectedBuild==="path")this.paintPathAtMouse(!0);else if(this.selectedBuild==="wall")this.paintWallAtMouse(!0);else{const l=this.findColonistAt(this.mouse.wx,this.mouse.wy);l?(this.selColonist=l,this.follow=!0):this.placeAtMouse()}}if(o.button===2){if(this.mouse.rdown=!0,this.showBuildMenu){this.showBuildMenu=!1;return}this.eraseDragStart={x:this.mouse.wx,y:this.mouse.wy}}}),t.addEventListener("mouseup",o=>{if(o.preventDefault(),o.button===0&&(this.mouse.down=!1,this.lastPaintCell=null),o.button===2){if(this.eraseDragStart){const e=Math.min(this.eraseDragStart.x,this.mouse.wx),n=Math.min(this.eraseDragStart.y,this.mouse.wy),l=Math.max(this.eraseDragStart.x,this.mouse.wx),r=Math.max(this.eraseDragStart.y,this.mouse.wy);(l-e)*(r-n)<12*12?this.cancelOrErase():this.eraseInRect({x:e,y:n,w:l-e,h:r-n})}this.mouse.rdown=!1,this.eraseDragStart=null}}),t.addEventListener("contextmenu",o=>o.preventDefault()),t.addEventListener("wheel",o=>{o.preventDefault();const e=o.deltaY<0?1.1:.9;this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*e))}),window.addEventListener("keydown",o=>{const e=o.key.toLowerCase();this.keyState[e]=!0,this.once.has(e)||this.once.add(e),(e===" "||e==="h"||e==="b"||e==="f"||e==="g"||e==="j"||e==="escape"||/^[1-9]$/.test(e)||e==="w"||e==="a"||e==="s"||e==="d"||e==="+"||e==="="||e==="-"||e==="_")&&o.preventDefault()}),window.addEventListener("keyup",o=>{this.keyState[o.key.toLowerCase()]=!1})}handleTapOrClickAtScreen(t,o){this.canvas.getBoundingClientRect(),this.mouse.x=t,this.mouse.y=o;const n=this.screenToWorld(this.mouse.x,this.mouse.y);if(this.mouse.wx=n.x,this.mouse.wy=n.y,this.pendingPlacement){const s=this.mouse.x*this.DPR,h=this.mouse.y*this.DPR;if(this.placeUIRects.length){for(const M of this.placeUIRects)if(s>=M.x&&s<=M.x+M.w&&h>=M.y&&h<=M.y+M.h){M.id==="up"?this.nudgePending(0,-1):M.id==="down"?this.nudgePending(0,1):M.id==="left"?this.nudgePending(-1,0):M.id==="right"?this.nudgePending(1,0):M.id==="ok"?this.confirmPending():M.id==="cancel"&&this.cancelPending();return}}const c=this.pendingPlacement,d=F[c.key],y=((M,T)=>({x:(M-this.camera.x)*this.camera.zoom,y:(T-this.camera.y)*this.camera.zoom}))(c.x,c.y),g=d.size.w*x*this.camera.zoom,u=d.size.h*x*this.camera.zoom;if(s>=y.x&&s<=y.x+g&&h>=y.y&&h<=y.y+u){this.confirmPending();return}const p=Math.floor(this.mouse.wx/x)*x,m=Math.floor(this.mouse.wy/x)*x,w=d.size.w*x,S=d.size.h*x;c.x=L(p,0,b.w-w),c.y=L(m,0,b.h-S);return}if(this.selColonist){const s=this.mouse.x*this.DPR,h=this.mouse.y*this.DPR;if(this.colonistPanelCloseRect){const c=this.colonistPanelCloseRect;if(s>=c.x&&s<=c.x+c.w&&h>=c.y&&h<=c.y+c.h){this.selColonist=null,this.follow=!1;return}}if(this.isTouch&&this.colonistPanelRect){const c=this.colonistPanelRect;if(!(s>=c.x&&s<=c.x+c.w&&h>=c.y&&h<=c.y+c.h)){this.selColonist=null,this.follow=!1;return}}}const l=this.mouse.x*this.DPR,r=this.mouse.y*this.DPR;for(const s of this.hotbarRects)if(l>=s.x&&l<=s.x+s.w&&r>=s.y&&r<=s.y+s.h){const h=this.hotbar[s.index];h&&(this.selectedBuild=h,this.toast("Selected: "+F[h].name));return}if(this.showBuildMenu){this.handleBuildMenuClick();return}if(this.selectedBuild==="path"){this.paintPathAtMouse(!0);return}if(this.selectedBuild==="wall"){this.paintWallAtMouse(!0);return}if(this.isTouch&&this.selectedBuild){this.placeAtMouse();return}const a=this.findColonistAt(this.mouse.wx,this.mouse.wy);if(a){this.selColonist=a,this.follow=!0;return}this.placeAtMouse()}findColonistAt(t,o){for(let e=this.colonists.length-1;e>=0;e--){const n=this.colonists[e];if(!n.alive||n.inside)continue;if((n.x-t)*(n.x-t)+(n.y-o)*(n.y-o)<=(n.r+2)*(n.r+2))return n}return null}msg(t,o="info"){this.messages.push({text:t,t:4,kind:o}),this.toast(t,1600)}toast(t,o=1400){const e=document.getElementById("toast");e&&(e.textContent=t,e.style.opacity="1",clearTimeout(e._t),e._t=setTimeout(()=>e.style.opacity="0",o))}scatter(){for(let t=0;t<220;t++){const o={x:W(80,b.w-80),y:W(80,b.h-80)};Math.hypot(o.x-N.x,o.y-N.y)<220||this.trees.push({x:o.x,y:o.y,r:12,hp:40,type:"tree"})}for(let t=0;t<140;t++){const o={x:W(80,b.w-80),y:W(80,b.h-80)};Math.hypot(o.x-N.x,o.y-N.y)<200||this.rocks.push({x:o.x,y:o.y,r:12,hp:50,type:"rock"})}}tryRespawn(t){if(this.respawnTimer+=t*this.fastForward,this.respawnTimer>=4){this.respawnTimer=0;const o=e=>{for(let n=0;n<6;n++){const l={x:W(60,b.w-60),y:W(60,b.h-60)};if(Math.hypot(l.x-N.x,l.y-N.y)<200)continue;let r=!0;for(const a of this.buildings)if(l.x>a.x-24&&l.x<a.x+a.w+24&&l.y>a.y-24&&l.y<a.y+a.h+24){r=!1;break}if(r){e==="tree"?this.trees.push({x:l.x,y:l.y,r:12,hp:40,type:"tree"}):this.rocks.push({x:l.x,y:l.y,r:12,hp:50,type:"rock"});break}}};Math.random()<.5&&this.trees.length<260&&o("tree"),Math.random()<.35&&this.rocks.length<180&&o("rock")}}buildHQ(){const t={w:3*x,h:3*x},o={kind:"hq",name:"HQ",x:N.x-t.w/2,y:N.y-t.h/2,w:t.w,h:t.h,hp:600,done:!0,color:I.bld,size:{w:3,h:3},build:0,buildLeft:0};this.buildings.push(o),this.rebuildNavGrid()}newGame(){this.colonists.length=this.enemies.length=this.trees.length=this.rocks.length=this.buildings.length=this.bullets.length=this.messages.length=0,this.buildReservations.clear(),this.insideCounts.clear(),this.RES.wood=50,this.RES.stone=30,this.RES.food=20,this.day=1,this.tDay=0,this.fastForward=1,this.camera.zoom=1,this.camera.x=N.x-this.canvas.width/(2*this.camera.zoom),this.camera.y=N.y-this.canvas.height/(2*this.camera.zoom),this.buildHQ(),this.scatter();for(let t=0;t<3;t++){const o=W(0,Math.PI*2),e=80+W(-10,10);this.spawnColonist({x:N.x+Math.cos(o)*e,y:N.y+Math.sin(o)*e})}this.msg("Welcome! Build farms before night, then turrets.")}spawnColonist(t){const o={x:t.x,y:t.y,r:8,hp:100,speed:50,task:null,target:null,carrying:null,hunger:0,alive:!0,color:I.colonist,t:W(0,1)};return this.colonists.push(o),o}spawnEnemy(){const t=Dt(0,4);let o,e;t===0?(o=W(0,b.w),e=-80):t===1?(o=W(0,b.w),e=b.h+80):t===2?(o=-80,e=W(0,b.h)):(o=b.w+80,e=W(0,b.h));const n={x:o,y:e,r:9,hp:60+this.day*6,speed:48+this.day*2,dmg:8+this.day,target:null,color:I.enemy};return this.enemies.push(n),n}canPlace(t,o,e){const n={x:o,y:e,w:t.size.w*x,h:t.size.h*x};if(n.x<0||n.y<0||n.x+n.w>b.w||n.y+n.h>b.h)return!1;for(const r of this.buildings)if(!(n.x+n.w<=r.x||n.x>=r.x+r.w||n.y+n.h<=r.y||n.y>=r.y+r.h))return!1;const l=(r,a)=>{const s=Math.max(a.x,Math.min(r.x,a.x+a.w)),h=Math.max(a.y,Math.min(r.y,a.y+a.h)),c=r.x-s,d=r.y-h;return c*c+d*d<=r.r*r.r};for(const r of this.trees)if(l(r,n))return!1;for(const r of this.rocks)if(l(r,n))return!1;return!0}placeAtMouse(){if(this.paused)return;const t=this.selectedBuild;if(!(!t||!F[t])){if(this.isTouch){const e=Math.floor(this.mouse.wx/x)*x,n=Math.floor(this.mouse.wy/x)*x;this.pendingPlacement={key:t,x:e,y:n};return}this.tryPlaceNow(t,this.mouse.wx,this.mouse.wy)}}tryPlaceNow(t,o,e){const n=F[t];if(!n)return;const l=at(t,o,e);if(!this.canPlace(l,l.x,l.y)){this.toast("Can't place here");return}if(!et(this.RES,n.cost)){this.toast("Not enough resources");return}if(lt(this.RES,n.cost),l.kind!=="path")for(let r=this.buildings.length-1;r>=0;r--){const a=this.buildings[r];a.kind==="path"&&!(l.x+l.w<=a.x||l.x>=a.x+a.w||l.y+l.h<=a.y||l.y>=a.y+a.h)&&this.buildings.splice(r,1)}this.buildings.push(l),this.rebuildNavGrid()}nudgePending(t,o){if(!this.pendingPlacement)return;const e=F[this.pendingPlacement.key],n=this.pendingPlacement.x+t*x,l=this.pendingPlacement.y+o*x,r=e.size.w*x,a=e.size.h*x;this.pendingPlacement.x=L(n,0,b.w-r),this.pendingPlacement.y=L(l,0,b.h-a)}confirmPending(){if(!this.pendingPlacement)return;const{key:t,x:o,y:e}=this.pendingPlacement;this.pendingPlacement=null,this.tryPlaceNow(t,o+1,e+1)}cancelPending(){this.pendingPlacement=null}paintPathAtMouse(t=!1){const o=Math.floor(this.mouse.wx/x),e=Math.floor(this.mouse.wy/x);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===o&&this.lastPaintCell.gy===e)return;const n=(g,u)=>{const p=g*x+1,m=u*x+1,w=at("path",p,m);!this.buildings.some(M=>M.kind==="path"&&M.x===w.x&&M.y===w.y)&&et(this.RES,F.path.cost)&&(lt(this.RES,F.path.cost),this.buildings.push(w))};if(this.lastPaintCell==null){n(o,e),this.lastPaintCell={gx:o,gy:e},this.rebuildNavGrid();return}let l=this.lastPaintCell.gx,r=this.lastPaintCell.gy,a=o,s=e;const h=Math.abs(a-l),c=Math.abs(s-r),d=l<a?1:-1,f=r<s?1:-1;let y=h-c;for(;n(l,r),!(l===a&&r===s);){const g=2*y;g>-c&&(y-=c,l+=d),g<h&&(y+=h,r+=f)}this.lastPaintCell={gx:o,gy:e},this.rebuildNavGrid()}paintWallAtMouse(t=!1){const o=Math.floor(this.mouse.wx/x),e=Math.floor(this.mouse.wy/x);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===o&&this.lastPaintCell.gy===e)return;const n=(g,u)=>{const p=g*x+1,m=u*x+1,w=at("wall",p,m);this.buildings.some(M=>M.kind==="wall"&&M.x===w.x&&M.y===w.y)||et(this.RES,F.wall.cost)&&this.canPlace(w,w.x,w.y)&&(lt(this.RES,F.wall.cost),this.buildings.push(w))};if(this.lastPaintCell==null){n(o,e),this.lastPaintCell={gx:o,gy:e},this.rebuildNavGrid();return}let l=this.lastPaintCell.gx,r=this.lastPaintCell.gy,a=o,s=e;const h=Math.abs(a-l),c=Math.abs(s-r),d=l<a?1:-1,f=r<s?1:-1;let y=h-c;for(;n(l,r),!(l===a&&r===s);){const g=2*y;g>-c&&(y-=c,l+=d),g<h&&(y+=h,r+=f)}this.lastPaintCell={gx:o,gy:e},this.rebuildNavGrid()}eraseInRect(t){const o=this.buildings.length;for(let n=this.buildings.length-1;n>=0;n--){const l=this.buildings[n];if(l.kind==="hq")continue;!(t.x+t.w<=l.x||t.x>=l.x+l.w||t.y+t.h<=l.y||t.y>=l.y+l.h)&&(this.evictColonistsFrom(l),this.buildings.splice(n,1),this.buildReservations.delete(l),this.insideCounts.delete(l))}const e=o-this.buildings.length;e>0&&(this.msg(`Removed ${e} structure(s)`),this.rebuildNavGrid())}cancelOrErase(){const t={x:this.mouse.wx,y:this.mouse.wy};for(let o=this.buildings.length-1;o>=0;o--){const e=this.buildings[o];if(e.kind!=="hq"&&t.x>=e.x&&t.x<=e.x+e.w&&t.y>=e.y&&t.y<=e.y+e.h){this.evictColonistsFrom(e),this.buildings.splice(o,1),this.msg("Building removed"),this.rebuildNavGrid();return}}this.selectedBuild=null,this.toast("Build canceled")}evictColonistsFrom(t){const o=t.x+t.w/2,e=t.y+t.h/2;for(const n of this.colonists)if(n.inside===t){this.leaveBuilding(n),n.safeTarget=null,n.safeTimer=0;const l=Math.random()*Math.PI*2,r=(t.w/2+10)*Math.cos(l),a=(t.h/2+10)*Math.sin(l);n.x=L(o+r,0,b.w),n.y=L(e+a,0,b.h)}}buildingCapacity(t){return t.kind==="hq"?8:t.kind==="house"?3:1}buildingHasSpace(t){const o=this.buildingCapacity(t);return(this.insideCounts.get(t)||0)<o}tryEnterBuilding(t,o){return!o.done||!this.buildingHasSpace(o)?!1:(this.insideCounts.set(o,(this.insideCounts.get(o)||0)+1),t.inside=o,t.hideTimer=0,!0)}leaveBuilding(t){const o=t.inside;if(o){const e=(this.insideCounts.get(o)||1)-1;e<=0?this.insideCounts.delete(o):this.insideCounts.set(o,e)}t.inside=null,t.hideTimer=0}getMaxCrew(t){const o=t.w/x*(t.h/x);return o<=1?1:o<=4?2:3}releaseBuildReservation(t){if(!t.reservedBuildFor)return;const o=t.reservedBuildFor,e=(this.buildReservations.get(o)||1)-1;e<=0?this.buildReservations.delete(o):this.buildReservations.set(o,e),t.reservedBuildFor=null}clearPath(t){t.path=void 0,t.pathIndex=void 0,t.repath=0}setTask(t,o,e){if(t.target&&t.target.type&&this.assignedTargets.has(t.target)&&this.assignedTargets.delete(t.target),t.reservedBuildFor&&t.reservedBuildFor!==e&&this.releaseBuildReservation(t),t.task=o,t.target=e,this.clearPath(t),e&&e.type&&(e.type==="tree"||e.type==="rock")&&this.assignedTargets.add(e),o==="build"&&e&&e.w!=null&&!t.reservedBuildFor){const n=e,l=this.buildReservations.get(n)||0,r=this.getMaxCrew(n);l<r&&(this.buildReservations.set(n,l+1),t.reservedBuildFor=n)}}pickTask(t){let o=null,e=1/0;for(const a of this.buildings){if(a.done||(this.buildReservations.get(a)||0)>=this.getMaxCrew(a))continue;const h=E({x:t.x,y:t.y},this.centerOf(a));h<e&&(e=h,o=a)}if(o){this.setTask(t,"build",o);return}const n=this.buildings.find(a=>a.kind==="farm"&&a.done&&a.ready);if(n){this.setTask(t,"harvestFarm",n);return}if(Math.random()<.1){const a=this.buildings.find(s=>s.kind==="well"&&s.done);if(a){this.setTask(t,"harvestWell",a);return}}if(this.RES.food<Math.max(4,this.colonists.length*2)){const a=this.nearestCircle({x:t.x,y:t.y},this.trees.filter(s=>!this.assignedTargets.has(s)));if(a){this.setTask(t,"chop",a);return}}const l=this.trees.filter(a=>!this.assignedTargets.has(a)),r=this.rocks.filter(a=>!this.assignedTargets.has(a));if(Math.random()<.05&&console.log(`Task assignment: wood=${this.RES.wood}, stone=${this.RES.stone}, trees=${l.length}, rocks=${r.length}`),this.RES.wood<this.RES.stone){const a=this.nearestCircle({x:t.x,y:t.y},l);if(a){Math.random()<.1&&console.log("Assigning chop task"),this.setTask(t,"chop",a);return}else Math.random()<.1&&console.log("No trees available for chopping")}else{const a=this.nearestCircle({x:t.x,y:t.y},r);if(a){Math.random()<.1&&console.log("Assigning mine task to rock at:",a),this.setTask(t,"mine",a);return}else Math.random()<.1&&console.log("No rocks available for mining")}Math.random()<.1&&console.log("Assigning idle task"),this.setTask(t,"idle",{x:t.x+W(-80,80),y:t.y+W(-80,80)})}nearestCircle(t,o){let e=null,n=1e9;for(const l of o){const r=E(t,l);r<n&&(n=r,e=l)}return e}moveAlongPath(t,o,e,n=10){t.repath=(t.repath||0)-o;const l=e&&(!t.pathGoal||Math.hypot(t.pathGoal.x-e.x,t.pathGoal.y-e.y)>12);if(e&&(l||t.repath==null||t.repath<=0||!t.path||t.pathIndex==null)){const g=this.computePath(t.x,t.y,e.x,e.y);g&&g.length?(t.path=g,t.pathIndex=0,t.pathGoal={x:e.x,y:e.y}):Math.random()<.05&&console.log(`Failed to compute path from (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) to (${e.x.toFixed(1)}, ${e.y.toFixed(1)})`),t.repath=2}if(!t.path||t.pathIndex==null||t.pathIndex>=t.path.length)return e?Math.hypot(t.x-e.x,t.y-e.y)<=n:!1;const r=t.path[t.pathIndex],a=r.x-t.x,s=r.y-t.y;let h=Math.hypot(a,s);const c=10,d=4;let f=t.speed*(t.fatigueSlow||1);{const g=Math.floor(t.x/x),u=Math.floor(t.y/x);if(g>=0&&u>=0&&g<this.grid.cols&&u<this.grid.rows){const m=u*this.grid.cols+g;this.grid.cost[m]<=.7&&(f*=1.125)}}const y=f*o;if(h<=Math.max(c,y))return t.x=r.x,t.y=r.y,t.pathIndex++,t.jitterScore=0,t.jitterWindow=0,t.lastDistToNode=void 0,t.lastDistSign=void 0,t.pathIndex>=t.path.length?(t.path=void 0,t.pathIndex=void 0,e?Math.hypot(t.x-e.x,t.y-e.y)<=n:!0):!1;if(t.jitterWindow=(t.jitterWindow||0)+o,t.lastDistToNode!=null){const g=h-t.lastDistToNode,u=g===0?0:g>0?1:-1,p=t.lastDistSign??u;u!==0&&p!==0&&u!==p&&h<c+10?t.jitterScore=(t.jitterScore||0)+1:t.jitterScore=Math.max(0,(t.jitterScore||0)-1),t.lastDistSign=u}if(t.lastDistToNode=h,(t.jitterScore||0)>=6||(t.jitterWindow||0)>1.5){if(h<c+d)t.pathIndex++;else if(e){const g=this.computePath(t.x,t.y,e.x,e.y);g&&g.length&&(t.path=g,t.pathIndex=0)}if(t.jitterScore=0,t.jitterWindow=0,t.lastDistToNode=void 0,t.lastDistSign=void 0,!t.path||t.pathIndex==null||t.pathIndex>=t.path.length)return!1}return t.x+=a/(h||1)*y,t.y+=s/(h||1)*y,t.x=Math.max(0,Math.min(t.x,b.w)),t.y=Math.max(0,Math.min(t.y,b.h)),!1}findSafeTurret(t,o){let e=null,n=1/0;for(const l of this.buildings){if(l.kind!=="turret"||!l.done)continue;const r=this.centerOf(l),a=Math.hypot(t.x-r.x,t.y-r.y),s=Math.hypot(o.x-r.x,o.y-r.y),h=l.range||160,c=s<h?100:0,d=a+c;d<n&&(n=d,e=l)}return e}isProtectedByTurret(t){const o=this.centerOf(t);for(const e of this.buildings){if(e.kind!=="turret"||!e.done)continue;const n=e.range||120,l=this.centerOf(e);if(E(o,l)<n*n)return!0}return!1}centerOf(t){return{x:t.x+t.w/2,y:t.y+t.h/2}}pointInRect(t,o){return t.x>=o.x&&t.x<=o.x+o.w&&t.y>=o.y&&t.y<=o.y+o.h}updateTurret(t,o){if(!("range"in t)||!t.range)return;t.cooldown=Math.max(0,(t.cooldown||0)-o);let e=null,n=1e9;const l=this.centerOf(t);for(const r of this.enemies){const a=E(r,l);a<t.range*t.range&&a<n&&(n=a,e=r)}e&&(t.cooldown||0)<=0&&(e.hp-=t.dps||0,this.bullets.push({x:l.x,y:l.y,tx:e.x,ty:e.y,t:.12}),t.cooldown=t.fireRate||.6)}isNight(){return this.tDay>=yt.start||this.tDay<=yt.end}spawnWave(){const t=4+Math.floor(this.day*1.3);for(let o=0;o<t;o++)this.spawnEnemy();this.msg(`Night ${this.day}: Enemies incoming!`,"warn")}nextDay(){this.day++,this.waveSpawnedForDay=!1;let t=0;for(let n=0;n<this.colonists.length;n++)this.RES.food>0?this.RES.food-=1:(t++,this.colonists[n]&&(this.colonists[n].alive=!1));t>0&&(this.colonists=this.colonists.filter(n=>n.alive),this.msg(`${t} colonist(s) starved`,"bad"));for(const n of this.buildings)n.kind==="farm"&&n.done&&(n.growth=(n.growth||0)+.5,(n.growth||0)>=(n.growTime||1)&&(n.ready=!0));const o=this.buildings.find(n=>n.kind==="tent"&&n.done),e=(this.buildings.find(n=>n.kind==="hq")?3:0)+this.buildings.filter(n=>n.kind==="house"&&n.done).reduce((n,l)=>n+(l.popCap||0),0);o&&this.colonists.length<e&&this.RES.food>=15&&(this.RES.food-=15,this.spawnColonist({x:N.x+W(-20,20),y:N.y+W(-20,20)}),this.msg("A new colonist joined! (-15 food)","info")),this.day>8&&this.win()}dayTick(t){const o=this.isNight();this.tDay+=t*this.fastForward/this.dayLength,this.tDay>=1&&(this.tDay-=1,this.nextDay());const e=this.isNight();!o&&e&&this.spawnWave(),this.prevIsNight=e;for(let n=this.colonists.length-1;n>=0;n--){const l=this.colonists[n];if(!l.alive){this.colonists.splice(n,1);continue}l.hp<=0&&(l.alive=!1)}}keyPressed(t){return this.once.has(t)?(this.once.delete(t),!0):!1}update(t){if(this.keyPressed(" ")){this.paused=!this.paused;const e=document.getElementById("btnPause");e&&(e.textContent=this.paused?"Resume":"Pause")}if(this.keyPressed("h")){const e=document.getElementById("help");e&&(e.hidden=!e.hidden)}this.keyPressed("b")&&(this.showBuildMenu=!this.showBuildMenu),this.keyPressed("g")&&(this.debug.nav=!this.debug.nav,this.toast(this.debug.nav?"Debug: nav ON":"Debug: nav OFF")),this.keyPressed("j")&&(this.debug.colonists=!this.debug.colonists,this.toast(this.debug.colonists?"Debug: colonists ON":"Debug: colonists OFF")),this.keyPressed("escape")&&(this.showBuildMenu?this.showBuildMenu=!1:(this.selectedBuild=null,this.toast("Build canceled"),this.selColonist=null,this.follow=!1)),this.keyPressed("f")&&(this.fastForward=this.fastForward===1?6:1,this.toast(this.fastForward>1?"Fast-forward ON":"Fast-forward OFF"));const o=360*t/this.camera.zoom;if(this.keyState.w&&(this.camera.y-=o),this.keyState.s&&(this.camera.y+=o),this.keyState.a&&(this.camera.x-=o),this.keyState.d&&(this.camera.x+=o),(this.keyState["+"]||this.keyState["="])&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*1.02))),(this.keyState["-"]||this.keyState._)&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom/1.02))),!this.paused){for(const[e,n]of this.hotbar.entries())this.keyPressed(String(e+1))&&(this.selectedBuild=n,this.toast("Selected: "+F[n].name));if(this.follow&&this.selColonist){const e=this.selColonist,n=this.canvas.width/this.camera.zoom,l=this.canvas.height/this.camera.zoom;this.camera.x=L(e.x-n/2,0,Math.max(0,b.w-n)),this.camera.y=L(e.y-l/2,0,Math.max(0,b.h-l))}this.dayTick(t);for(const e of this.colonists)e.alive&&ee(this,e,t*this.fastForward);for(let e=this.enemies.length-1;e>=0;e--){const n=this.enemies[e];se(this,n,t*this.fastForward),n.hp<=0&&(this.enemies.splice(e,1),Math.random()<.5&&(this.RES.food+=1))}for(const e of this.buildings){if(e.kind==="turret"&&e.done&&this.updateTurret(e,t*this.fastForward),e.healRate&&e.done){const n=e.healRate,l=e.healRange||120,r=this.centerOf(e);for(const a of this.colonists){if(!a.alive)continue;(a.x-r.x)*(a.x-r.x)+(a.y-r.y)*(a.y-r.y)<l*l&&(a.hp=Math.min(100,a.hp+n*t*this.fastForward))}}if(e.kind==="tent"&&e.done&&(e.cooldown=(e.cooldown||0)-t*this.fastForward,e.cooldown<=0&&this.RES.food>=15)){const n=this.getPopulationCap();if(this.colonists.length<n){this.RES.food-=15;const l=this.centerOf(e);this.spawnColonist({x:l.x+(Math.random()-.5)*40,y:l.y+(Math.random()-.5)*40}),this.msg("Recruit tent attracted a new colonist! (-15 food)","good"),e.cooldown=60}}}this.tryRespawn(t);for(let e=this.bullets.length-1;e>=0;e--){const n=this.bullets[e];n.t-=t,n.t<=0&&this.bullets.splice(e,1)}for(let e=this.messages.length-1;e>=0;e--){const n=this.messages[e];n.t-=t,n.t<=0&&this.messages.splice(e,1)}}}draw(){var a;const{ctx:t}=this;Ht(t,this.canvas),t.save(),Ut(t,this.camera),Gt(t);for(const s of this.trees)ht(t,s.x,s.y,s.r,I.tree);for(const s of this.rocks)ht(t,s.x,s.y,s.r,I.rock);for(const s of this.buildings)if(jt(t,s),(s.kind==="house"||s.kind==="hq")&&this.buildings.some(c=>c.kind==="turret"&&c.done&&E(this.centerOf(s),this.centerOf(c))<(c.range||120)*(c.range||120))){const c=this.centerOf(s);qt(t,c.x,s.y-8,12,"#60a5fa")}{const s=new Map;for(const h of this.colonists)h.inside&&h.alive&&s.set(h.inside,(s.get(h.inside)||0)+1);t.save();for(const[h,c]of s){if(!c)continue;const d=8,f=Math.min(c,d),y=10,g=4,u=f*(y+g)-g;let p=h.x+h.w/2-u/2+y/2;const m=h.y+h.h+8,w=this.colonists.filter(S=>S.inside===h);for(let S=0;S<f;S++){const M=w[S%w.length],T=M?M.hp:100,P=T>66?"#22c55e":T>33?"#eab308":"#ef4444";xt(t,p+S*(y+g),m,10,P)}if(c>d){const S=c-d,M=p+f*(y+g)+6;t.fillStyle="#dbeafe",t.font="600 11px system-ui,Segoe UI,Roboto",t.fillText("+"+S,M,m+4)}}t.restore()}for(const s of this.colonists)!s.inside&&s.alive&&ht(t,s.x,s.y,s.r,this.selColonist===s?"#93c5fd":I.colonist);if(this.debug.nav){t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444";for(let s=0;s<this.grid.rows;s++)for(let h=0;h<this.grid.cols;h++)this.grid.solid[s*this.grid.cols+h]&&t.fillRect(h*x,s*x,x,x);t.restore(),t.save(),t.globalAlpha=.12;for(let s=0;s<this.grid.rows;s++)for(let h=0;h<this.grid.cols;h++){const c=s*this.grid.cols+h;if(!this.grid.solid[c]){const d=this.grid.cost[c];d<=.7?t.fillStyle="#22c55e":d<=1?t.fillStyle="#eab308":t.fillStyle="#f97316",t.fillRect(h*x,s*x,x,x)}}t.restore(),t.save(),t.strokeStyle="#22d3ee",t.lineWidth=2;for(const s of this.colonists)if(!(!s.alive||!s.path||!s.path.length)){t.beginPath(),t.moveTo(s.x,s.y);for(let h=s.pathIndex??0;h<s.path.length;h++){const c=s.path[h];t.lineTo(c.x,c.y)}if(t.stroke(),s.pathIndex!=null&&s.pathIndex<s.path.length){const h=s.path[s.pathIndex];t.save(),t.fillStyle="#fbbf24",t.beginPath(),t.arc(h.x,h.y,6,0,Math.PI*2),t.fill(),t.restore()}}t.restore(),t.save(),t.font="11px monospace",t.fillStyle="#ffffff",t.strokeStyle="#000000",t.lineWidth=2;for(const s of this.colonists){if(s.inside||!s.alive)continue;const h=`${s.task||s.state||"idle"}`,c=s.x-20,d=s.y-s.r-8;if(t.strokeText(h,c,d),t.fillText(h,c,d),s.target&&s.target.x!=null){const f=s.target;t.save(),t.strokeStyle="#94a3b8",t.lineWidth=1,t.setLineDash([3,3]),t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(f.x,f.y),t.stroke(),t.setLineDash([]),t.restore()}}t.restore()}if(this.debug.colonists){t.save(),t.font="10px monospace",t.lineWidth=1;for(const s of this.colonists){if(s.inside||!s.alive)continue;const h=s.x-35;let c=s.y-s.r-45;const d=12,f=[`State: ${s.state||"unknown"}`,`Task: ${s.task||"none"}`,`HP: ${Math.floor(s.hp||0)}`,`Pos: ${Math.floor(s.x)},${Math.floor(s.y)}`,`Speed: ${s.speed||0}`,`Stuck: ${s.stuckTimer?s.stuckTimer.toFixed(1)+"s":"no"}`,`Since: ${s.stateSince?s.stateSince.toFixed(1)+"s":"0s"}`,`PathIdx: ${s.pathIndex??"none"}/${((a=s.path)==null?void 0:a.length)??0}`,`Jitter: ${s.jitterScore??0}`,`Repath: ${s.repath?s.repath.toFixed(1)+"s":"none"}`];if(s.target){const u=s.target;u.x!=null&&(f.push(`Target: ${Math.floor(u.x)},${Math.floor(u.y)}`),u.type&&f.push(`Type: ${u.type}`),u.hp!=null&&f.push(`T.HP: ${Math.floor(u.hp)}`))}const y=140,g=f.length*d+4;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(h-2,c-d+2,y,g),t.strokeStyle="#444",t.strokeRect(h-2,c-d+2,y,g);for(let u=0;u<f.length;u++){const p=f[u];t.fillStyle="#ffffff",t.strokeStyle="#000000",t.lineWidth=2,t.strokeText(p,h,c+u*d),t.fillText(p,h,c+u*d)}if(t.strokeStyle="#ff6b6b",t.lineWidth=1,t.globalAlpha=.3,t.beginPath(),t.arc(s.x,s.y,s.r,0,Math.PI*2),t.stroke(),t.globalAlpha=1,s.target&&s.task&&(s.task==="chop"||s.task==="mine")){const u=s.target;if(u.x!=null&&u.r!=null){const p=u.r+s.r+4+2.5;t.strokeStyle="#22c55e",t.lineWidth=2,t.globalAlpha=.4,t.beginPath(),t.arc(u.x,u.y,p,0,Math.PI*2),t.stroke(),t.globalAlpha=1;const m=Math.hypot(s.x-u.x,s.y-u.y);t.fillStyle=m<=p?"#22c55e":"#ff6b6b",t.font="12px monospace";const w=(s.x+u.x)/2,S=(s.y+u.y)/2;t.strokeText(`${m.toFixed(1)}`,w-15,S),t.fillText(`${m.toFixed(1)}`,w-15,S)}}}t.restore()}for(const s of this.enemies)Xt(t,s.x,s.y,s.r+2,3,I.enemy,-Math.PI/2);if(Vt(t,this.bullets),this.isNight()&&(t.fillStyle="rgba(6,10,18, 0.58)",t.fillRect(0,0,b.w,b.h)),this.selectedBuild&&!this.pendingPlacement){const s=F[this.selectedBuild],h=Math.floor(this.mouse.wx/x)*x,c=Math.floor(this.mouse.wy/x)*x,d=this.canPlace({...s,size:s.size},h,c)&&et(this.RES,s.cost);t.globalAlpha=.6,t.fillStyle=d?I.ghost:"#ff6b6b88",t.fillRect(h,c,s.size.w*x,s.size.h*x),t.globalAlpha=1}if(this.mouse.rdown&&this.eraseDragStart){const s=Math.min(this.eraseDragStart.x,this.mouse.wx),h=Math.min(this.eraseDragStart.y,this.mouse.wy),c=Math.abs(this.mouse.wx-this.eraseDragStart.x),d=Math.abs(this.mouse.wy-this.eraseDragStart.y);t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444",t.fillRect(s,h,c,d),t.globalAlpha=1,t.strokeStyle="#ef4444",t.setLineDash([6,4]),t.strokeRect(s+.5,h+.5,c-1,d-1),t.setLineDash([]),t.restore()}t.restore();const o=this.getPopulationCap(),e=this.colonists.filter(s=>!!s.inside).length,n=this.RES.wood+this.RES.stone+this.RES.food,l=this.getStorageCapacity(),r=this.hotbar.map(s=>({key:String(s),name:F[s].name,cost:this.costText(F[s].cost||{}),selected:this.selectedBuild===s}));Jt(this.ctx,this.canvas,{res:this.RES,colonists:this.colonists.filter(s=>s.alive).length,cap:o,hiding:e,day:this.day,tDay:this.tDay,isNight:this.isNight(),hotbar:r,messages:this.messages,storage:{used:n,max:l}},this),this.selColonist?this.drawColonistProfile(this.selColonist):this.colonistPanelRect=this.colonistPanelCloseRect=null,this.showBuildMenu&&this.drawBuildMenu(),this.pendingPlacement&&this.drawPlacementUI()}costText(t){const o=[];return t.wood&&o.push(`${t.wood}w`),t.stone&&o.push(`${t.stone}s`),t.food&&o.push(`${t.food}f`),o.join(" ")}win(){this.paused=!0,this.msg("You survived! Day 8 reached.","good"),alert("You survived to Day 8 — victory!")}lose(){this.paused=!0,this.msg("HQ destroyed. Colony fell.","bad"),alert("Your HQ was destroyed. Game over.")}rebuildNavGrid(){Yt(this.grid);for(const t of this.buildings)t.kind!=="hq"&&t.kind!=="path"&&t.kind!=="house"&&Nt(this.grid,t.x,t.y,t.w,t.h),t.kind==="path"&&zt(this.grid,t.x,t.y,t.w,t.h,.6)}computePath(t,o,e,n){return Lt(this.grid,t,o,e,n)}cellIndexAt(t,o){const e=Math.floor(t/x),n=Math.floor(o/x);return e<0||n<0||e>=this.grid.cols||n>=this.grid.rows?-1:n*this.grid.cols+e}isBlocked(t,o){const e=this.cellIndexAt(t,o);return e<0?!0:!!this.grid.solid[e]}isBlockedByResources(t,o,e){for(const n of this.trees){if(e&&n===e)continue;const l=t-n.x,r=o-n.y;if(l*l+r*r<=n.r*n.r)return!0}for(const n of this.rocks){if(e&&n===e)continue;const l=t-n.x,r=o-n.y;if(l*l+r*r<=n.r*n.r)return!0}return!1}bestApproachToCircle(t,o,e){let n=null,l=1/0;const r=16;for(let h=0;h<r;h++){const c=h/r*Math.PI*2,d=o.x-Math.cos(c)*(e-6),f=o.y-Math.sin(c)*(e-6);if(this.isBlocked(d,f)||this.isBlockedByResources(d,f,o))continue;const y=(t.x-d)*(t.x-d)+(t.y-f)*(t.y-f);y<l&&(l=y,n={x:d,y:f})}if(n)return Math.random()<.02&&console.log(`Approach point found: (${n.x.toFixed(1)}, ${n.y.toFixed(1)}) for resource at (${o.x.toFixed(1)}, ${o.y.toFixed(1)})`),n;const a=Math.atan2(o.y-t.y,o.x-t.x),s={x:o.x-Math.cos(a)*(e-6),y:o.y-Math.sin(a)*(e-6)};return Math.random()<.02&&console.log(`Using fallback approach point: (${s.x.toFixed(1)}, ${s.y.toFixed(1)}) for resource at (${o.x.toFixed(1)}, ${o.y.toFixed(1)})`),s}drawColonistProfile(t){const o=this.ctx,e=this.canvas.width,n=this.canvas.height,l=Math.min(this.scale(320),e*.4),r=Math.min(this.scale(200),n*.35),a=this.scale(12),s=e-l-a,h=this.scale(54),c=Math.min(h,n-r-a);o.save(),o.fillStyle="#0b1220cc",o.fillRect(s,c,l,r),o.strokeStyle="#1e293b",o.strokeRect(s+.5,c+.5,l-1,r-1);const d=this.scale(26),f=this.scale(8),y=s+l-f-d,g=c+f;o.fillStyle="#0f172a",o.fillRect(y,g,d,d),o.strokeStyle="#1e293b",o.strokeRect(y+.5,g+.5,d-1,d-1),o.fillStyle="#dbeafe",o.font=this.getScaledFont(16,"700"),o.textAlign="center",o.textBaseline="middle",o.fillText("✕",y+d/2,g+d/2+this.scale(1));const u=this.scale(64),p=s+this.scale(18),m=c+this.scale(26);o.fillStyle="#0f172a",o.fillRect(p,m,u,u),o.strokeStyle="#1e293b",o.strokeRect(p+.5,m+.5,u-1,u-1),o.save(),o.translate(p+u/2,m+u/2+this.scale(4)),o.scale(this.uiScale*2,this.uiScale*2),xt(o,0,0,10,"#93c5fd"),o.restore(),o.fillStyle="#dbeafe",o.font=this.getScaledFont(14,"600"),o.fillText("Colonist",s+u+this.scale(32),c+this.scale(22)),o.font=this.getScaledFont(13);const w=t.inside?"Resting":t.task?t.task:"Idle",S=Math.max(0,Math.min(100,t.hp|0)),M=Math.max(0,Math.min(100,(t.fatigue||0)|0)),T=Math.max(0,Math.min(100,(t.hunger||0)|0)),P=s+u+this.scale(32);let B=c+this.scale(45);const v=this.scale(24);this.barRow(P,B,"Health",S,"#22c55e"),B+=v,this.barRow(P,B,"Tiredness",M,"#eab308"),B+=v,this.barRow(P,B,"Hunger",T,"#f87171"),B+=v,o.fillStyle="#9fb3c8",o.fillText(`Task: ${w}`,P,B+this.scale(12)),B+=this.scale(18),o.fillText(`Pos: ${t.x|0}, ${t.y|0}`,P,B),B+=this.scale(18),o.fillText(this.follow?"Camera: Following (Esc to stop)":"Camera: Click colonist to follow",P,Math.min(B,c+r-this.scale(8))),this.colonistPanelRect={x:s,y:c,w:l,h:r},this.colonistPanelCloseRect={x:y,y:g,w:d,h:d},o.restore()}barRow(t,o,e,n,l){const r=this.ctx;r.fillStyle="#dbeafe",r.fillText(e,t,o);const a=this.scale(140),s=this.scale(10),h=this.scale(70);r.fillStyle="#0f172a",r.fillRect(t+h,o-this.scale(8),a,s),r.strokeStyle="#1e293b",r.strokeRect(t+h+.5,o-this.scale(8)+.5,a-1,s-1),r.fillStyle=l,r.fillRect(t+h+this.scale(2),o-this.scale(6),Math.max(0,Math.min(a-this.scale(4),n/100*(a-this.scale(4)))),s-this.scale(4))}drawBuildMenu(){const t=this.ctx,o=this.canvas.width,e=this.canvas.height,n=this.isTouch?980:860,l=this.isTouch?720:620,r=this.isTouch?28:40,a=this.isTouch?60:80,s=Math.min(this.scale(n),o-this.scale(r)),h=Math.min(this.scale(l),e-this.scale(a)),c=(o-s)/2,d=(e-h)/2;t.save(),t.fillStyle="#0b1628dd",t.fillRect(c,d,s,h),t.strokeStyle="#1e293b",t.strokeRect(c+.5,d+.5,s-1,h-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(this.isTouch?22:18,"600"),t.fillText("Build Menu (B to close)",c+this.scale(14),d+this.scale(24));const f=$t(F),y=Object.keys(f),g=this.scale(this.isTouch?36:28),u=Math.floor((s-g)/Math.max(1,y.length));this.menuRects=[];let p=null;for(let S=0;S<y.length;S++){const M=c+this.scale(12)+S*u;let T=d+this.scale(50);const P=y[S];t.fillStyle="#93c5fd",t.font=this.getScaledFont(this.isTouch?18:15,"600"),t.fillText(P,M,T),T+=this.scale(this.isTouch?12:8);const B=f[P];for(const[v,C]of B){T+=this.scale(this.isTouch?12:8);const D=this.scale(this.isTouch?78:58),O=u-this.scale(18),R=M,A=T,Y=this.mouse.x*this.DPR,_=this.mouse.y*this.DPR,j=Y>=R&&Y<=R+O&&_>=A&&_<=A+D;t.fillStyle=this.selectedBuild===v?"#102034":j?"#1a1f2e":"#0f172a",t.fillRect(R,A,O,D),t.strokeStyle=this.selectedBuild===v?"#4b9fff":j?"#3b82f6":"#1e293b",t.strokeRect(R+.5,A+.5,O-1,D-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(this.isTouch?18:15,"600"),t.fillText(C.name,R+this.scale(10),A+this.scale(this.isTouch?22:18));const V=this.costText(C.cost||{});t.fillStyle="#9fb3c8",t.font=this.getScaledFont(this.isTouch?14:12);const tt=Math.min(this.scale(this.isTouch?120:100),t.measureText(V).width+this.scale(4));if(t.fillText(V,R+O-tt,A+this.scale(this.isTouch?22:18)),C.description){t.fillStyle="#94a3b8",t.font=this.getScaledFont(this.isTouch?14:12);const st=O-this.scale(18);let Q=C.description;for(;t.measureText(Q).width>st&&Q.length>10;)Q=Q.substring(0,Q.length-4)+"...";t.fillText(Q,R+this.scale(10),A+this.scale(this.isTouch?46:36))}if(j&&C.description&&(p={key:v,desc:C.description}),this.menuRects.push({key:v,x:R,y:A,w:O,h:D}),T+=D,T>d+h-this.scale(this.isTouch?90:70))break}}if(p){const S=this.scale(this.isTouch?16:14),M=this.scale(this.isTouch?420:360);t.font=this.getScaledFont(this.isTouch?16:14);const T=this.wrapText(p.desc,M-S*2),P=this.scale(this.isTouch?20:18),B=T.length*P+S*2,v=this.mouse.x*this.DPR,C=this.mouse.y*this.DPR;let D=v+this.scale(20),O=C-B-this.scale(10);D+M>o&&(D=v-M-this.scale(20)),O<0&&(O=C+this.scale(20)),t.fillStyle="#0f1419f0",t.fillRect(D,O,M,B),t.strokeStyle="#374151",t.strokeRect(D+.5,O+.5,M-1,B-1),t.fillStyle="#e5e7eb";for(let R=0;R<T.length;R++)t.fillText(T[R],D+S,O+S+(R+1)*P-this.scale(4))}t.fillStyle="#9fb3c8",t.font=this.getScaledFont(this.isTouch?16:14);const m="Click a building to select • Hover for details • Press B to close",w=t.measureText(m).width;t.fillText(m,(o-w)/2,d+h+this.scale(this.isTouch?30:24)),t.restore()}wrapText(t,o){const e=this.ctx,n=t.split(" "),l=[];let r="";for(const a of n){const s=r+(r?" ":"")+a;e.measureText(s).width<=o?r=s:(r&&l.push(r),r=a)}return r&&l.push(r),l}handleBuildMenuClick(){const t=this.mouse.x*this.DPR,o=this.mouse.y*this.DPR;for(const e of this.menuRects)if(t>=e.x&&t<=e.x+e.w&&o>=e.y&&o<=e.y+e.h){this.selectedBuild=e.key,this.showBuildMenu=!1,this.toast("Selected: "+F[e.key].name);return}this.showBuildMenu=!1}drawPlacementUI(){const t=this.pendingPlacement;if(!t)return;const o=F[t.key],e=this.ctx,n=o.size.w*x,l=o.size.h*x,a=((w,S)=>({x:(w-this.camera.x)*this.camera.zoom,y:(S-this.camera.y)*this.camera.zoom}))(t.x,t.y),s=n*this.camera.zoom,h=l*this.camera.zoom;e.save(),e.globalAlpha=.6,e.fillStyle=I.ghost,e.fillRect(a.x,a.y,s,h),e.globalAlpha=1,e.strokeStyle="#4b9fff",e.setLineDash([4,3]),e.strokeRect(a.x+.5,a.y+.5,s-1,h-1),e.setLineDash([]),e.restore();const c=this.scale(10),d=this.scale(38);let f=a.x+s+c,y=a.y;const g=this.canvas.width;f+d*3>g-this.scale(6)&&(f=Math.max(this.scale(6),a.x-c-d*3));const u=(w,S,M)=>({id:w,x:S,y:M,w:d,h:d}),p=[u("up",f+d,y),u("left",f,y+d),u("right",f+d*2,y+d),u("down",f+d,y+d*2),u("cancel",f,y+d*3+this.scale(4)),u("ok",f+d*2,y+d*3+this.scale(4))];this.placeUIRects=p,e.save(),e.fillStyle="#0f172aee",e.strokeStyle="#1e293b";const m=(w,S)=>{e.fillRect(w.x,w.y,w.w,w.h),e.strokeRect(w.x+.5,w.y+.5,w.w-1,w.h-1),e.fillStyle="#dbeafe",e.font=this.getScaledFont(18,"600"),e.textAlign="center",e.textBaseline="middle",e.fillText(S,w.x+w.w/2,w.y+w.h/2+this.scale(2)),e.fillStyle="#0f172aee"};for(const w of p)w.id==="up"?m(w,"↑"):w.id==="down"?m(w,"↓"):w.id==="left"?m(w,"←"):w.id==="right"?m(w,"→"):w.id==="ok"?m(w,"OK"):w.id==="cancel"&&m(w,"X");e.restore()}}const z=document.getElementById("game"),ct=document.getElementById("btnPause"),oe=document.getElementById("btnHelp"),J=document.getElementById("btnToggleUI"),K=document.getElementById("btnMenu"),$=document.getElementById("headerDropdown"),pt=document.getElementById("hd-new"),mt=document.getElementById("hd-help"),wt=document.getElementById("hd-build"),kt=document.getElementById("hd-toggle-mobile"),ne=document.getElementById("btnNew"),H=document.getElementById("help"),dt=document.getElementById("mobileControls"),Mt=document.getElementById("mc-build"),bt=document.getElementById("mc-cancel"),St=document.getElementById("mc-erase"),Tt=document.getElementById("mc-pause"),vt=document.getElementById("mc-ff"),Pt=document.getElementById("mc-zoom-in"),Rt=document.getElementById("mc-zoom-out");H&&(H.innerHTML=`
    <h2>How to play</h2>
    <div><b>Goal:</b> Gather wood & stone, build farms for food, add houses for pop cap; survive nightly raids with turrets/walls.</div>
  <div><b>Controls:</b> 1..9 quick-build, <b>B</b> build menu, LMB place, RMB cancel/erase; WASD pan; Space pause; H toggle help; +/- zoom; F fast-forward.</div>
  <div><b>UI Modes:</b> 📱 Mobile UI shows touch controls for tap/touch gameplay. 🖥️ Desktop UI is clean with keyboard shortcuts only.</div>
  `);async function le(){const i=z.getContext("2d");i&&(i.fillStyle="#0a0e14",i.fillRect(0,0,z.width,z.height),i.fillStyle="#dbeafe",i.font="24px system-ui",i.textAlign="center",i.fillText("Loading assets...",z.width/2,z.height/2));try{await Z.getInstance().loadAssets(),console.log("Assets loaded successfully"),console.log("House image loaded:",!!Z.getInstance().getImage("house"))}catch(s){console.warn("Some assets failed to load:",s)}const t=new ie(z);ct.onclick=()=>{t.paused=!t.paused,ct.textContent=t.paused?"Resume":"Pause"},ne.onclick=()=>{t.newGame()},oe.onclick=()=>{H&&(H.hidden=!H.hidden)},Object.assign(window,{game:t,BUILD_TYPES:F});const o="ontouchstart"in window||navigator.maxTouchPoints>0;let e=localStorage.getItem("colonyUI_mobileMode"),n=e!==null?e==="true":o;const l=s=>{n=s,window._mobileUI=s,localStorage.setItem("colonyUI_mobileMode",s.toString()),dt&&(dt.hidden=!s,dt.style.display=s?"flex":"none"),K&&(K.hidden=!s),J&&(J.textContent=s?"🖥️":"📱",J.title=s?"Switch to Desktop UI":"Switch to Mobile UI"),t.toast(s?"Mobile UI: ON":"Desktop UI: ON")};J&&(J.onclick=()=>{l(!n)}),l(n),document.addEventListener("keydown",s=>{const h=[" ","h","b","f","g","j","escape","w","a","s","d","+","=","-","_"],c=/^[1-9]$/.test(s.key);(h.includes(s.key.toLowerCase())||c)&&document.activeElement&&document.activeElement!==document.body&&document.activeElement.blur()}),K&&$&&(K.onclick=()=>{$.hidden=!$.hidden},pt&&(pt.onclick=()=>{$.hidden=!0,t.newGame()}),mt&&(mt.onclick=()=>{$.hidden=!0,H&&(H.hidden=!H.hidden)}),wt&&(wt.onclick=()=>{$.hidden=!0,t.showBuildMenu=!t.showBuildMenu}),kt&&(kt.onclick=()=>{$.hidden=!0,l(!n)}),document.addEventListener("click",s=>{if(!$)return;const h=s.target;h&&!$.contains(h)&&h!==K&&($.hidden=!0)})),Mt&&(Mt.onclick=()=>{t.showBuildMenu=!t.showBuildMenu}),bt&&(bt.onclick=()=>{t.selectedBuild=null,t.toast("Build canceled")}),St&&(St.onclick=()=>{window._eraseOnce=!0,t.toast("Erase mode: tap on a building to remove")}),Tt&&(Tt.onclick=()=>{t.paused=!t.paused,ct.textContent=t.paused?"Resume":"Pause"}),vt&&(vt.onclick=()=>{t.fastForward=t.fastForward===1?6:1,t.toast(t.fastForward>1?"Fast-forward ON":"Fast-forward OFF")}),Pt&&(Pt.onclick=()=>{t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom*1.1))}),Rt&&(Rt.onclick=()=>{t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom/1.1))});let r=null,a=null;z.addEventListener("touchstart",s=>{if(s.preventDefault(),s.touches.length===1)a={x:s.touches[0].clientX,y:s.touches[0].clientY};else if(s.touches.length===2){const h=s.touches[0].clientX-s.touches[1].clientX,c=s.touches[0].clientY-s.touches[1].clientY;r=Math.hypot(h,c)}},{passive:!1}),z.addEventListener("touchmove",s=>{if(s.preventDefault(),s.touches.length===1&&a){const h=s.touches[0].clientX,c=s.touches[0].clientY,d=h-a.x,f=c-a.y;a={x:h,y:c},t.camera.x-=d*(1/t.camera.zoom)*t.DPR,t.camera.y-=f*(1/t.camera.zoom)*t.DPR}else if(s.touches.length===2){const h=s.touches[0].clientX-s.touches[1].clientX,c=s.touches[0].clientY-s.touches[1].clientY,d=Math.hypot(h,c);if(r!=null){const f=d/(r||d);t.camera.zoom=Math.max(.6,Math.min(2.2,t.camera.zoom*f))}r=d}},{passive:!1}),z.addEventListener("touchend",s=>{s.preventDefault();const h=window._eraseOnce;if(h&&s.changedTouches.length===1){window._eraseOnce=!1;const c=z.getBoundingClientRect(),d=s.changedTouches[0].clientX-c.left,f=s.changedTouches[0].clientY-c.top,y=t.screenToWorld(d,f);for(let g=t.buildings.length-1;g>=0;g--){const u=t.buildings[g];if(u.kind!=="hq"&&y.x>=u.x&&y.x<=u.x+u.w&&y.y>=u.y&&y.y<=u.y+u.h){t.evictColonistsFrom(u),t.buildings.splice(g,1),t.msg("Building removed"),t.rebuildNavGrid();break}}}if(!h&&s.changedTouches.length===1){const c=z.getBoundingClientRect(),d=s.changedTouches[0].clientX-c.left,f=s.changedTouches[0].clientY-c.top;t.handleTapOrClickAtScreen(d,f)}s.touches.length===0&&(a=null,r=null)},{passive:!1})}le();
