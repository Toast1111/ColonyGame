var pt=Object.defineProperty;var gt=(i,t,s)=>t in i?pt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s;var p=(i,t,s)=>gt(i,typeof t!="symbol"?t+"":t,s);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const l of e)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function s(e){const l={};return e.integrity&&(l.integrity=e.integrity),e.referrerPolicy&&(l.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?l.credentials="include":e.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(e){if(e.ep)return;e.ep=!0;const l=s(e);fetch(e.href,l)}})();const I=(i,t)=>Math.random()*(t-i)+i,wt=(i,t)=>Math.floor(I(i,t)),Y=(i,t,s)=>Math.max(t,Math.min(s,i)),E=(i,t)=>{const s=i.x-t.x,o=i.y-t.y;return s*s+o*o},xt=i=>Math.hypot(i.x,i.y),ht=i=>{const t=xt(i)||1;return{x:i.x/t,y:i.y/t}},dt=(i,t)=>({x:i.x-t.x,y:i.y-t.y}),u=32,g={w:240*u,h:240*u},$={x:g.w/2,y:g.h/2},C={sky:"#0a0e14",ground:"#0e161f",colonist:"#c7f9cc",enemy:"#ff9aa2",tree:"#6fbf73",rock:"#9aa5b1",ghost:"#6ee7ff",wall:"#9aa5b1",bld:"#93c5fd",turret:"#93c5fd",farm:"#8bd3dd",house:"#e2b714",stock:"#c084fc",tent:"#f59e0b"},nt={start:.72,end:.07};function kt(){const i=Math.ceil(g.w/u),t=Math.ceil(g.h/u);return{cols:i,rows:t,solid:new Uint8Array(i*t),cost:new Float32Array(i*t).fill(1)}}function mt(i){i.solid.fill(0),i.cost.fill(1)}function bt(i,t,s,o,e){const l=Math.floor(t/u),a=Math.floor(s/u),n=Math.ceil(o/u),r=Math.ceil(e/u);for(let d=0;d<r;d++)for(let h=0;h<n;h++){const f=l+h,c=a+d;f<0||c<0||f>=i.cols||c>=i.rows||(i.solid[c*i.cols+f]=1)}}function Mt(i,t,s,o,e,l){const a=Math.floor(t/u),n=Math.floor(s/u),r=Math.ceil(o/u),d=Math.ceil(e/u);for(let h=0;h<d;h++)for(let f=0;f<r;f++){const c=a+f,y=n+h;if(c<0||y<0||c>=i.cols||y>=i.rows)continue;const x=y*i.cols+c;i.cost[x]=Math.min(i.cost[x],l)}}function lt(i,t,s,o){return Math.abs(i-s)+Math.abs(t-o)}function St(i,t,s,o,e){const l=i.cols,a=i.rows,n={x:Math.floor(t/u),y:Math.floor(s/u)},r={x:Math.floor(o/u),y:Math.floor(e/u)},d=(M,R)=>R*l+M;if(n.x===r.x&&n.y===r.y)return[{x:o,y:e}];const h=[],f=new Int32Array(l*a).fill(-1),c=new Int32Array(l*a).fill(1e9),y=new Int32Array(l*a).fill(1e9),x=(M,R)=>{const P=d(M,R);h.push(P)},S=()=>{let M=0,R=1e9;for(let b=0;b<h.length;b++){const B=y[h[b]];B<R&&(R=B,M=b)}return h.splice(M,1)[0]},k=(M,R)=>M>=0&&R>=0&&M<l&&R<a,m=d(n.x,n.y),w=d(r.x,r.y),v=(M,R)=>{if(!k(M,R))return!1;const P=d(M,R);return P===m||P===w?!0:i.solid[P]===0};c[m]=0,y[m]=lt(n.x,n.y,r.x,r.y),x(n.x,n.y);const T=[[1,0],[-1,0],[0,1],[0,-1]];for(;h.length;){const M=S(),R=M%l,P=M/l|0;if(R===r.x&&P===r.y){let b=[],B=M;for(;B!==-1;){const D=B%l,O=B/l|0;b.push({x:D*u+u/2,y:O*u+u/2}),B=f[B]}b.reverse(),b[b.length-1]={x:o,y:e};const W=[],H=(D,O,j,z)=>{const et=j-D,st=z-O,ft=Math.hypot(et,st)||1,ct=Math.max(6,u*.33),it=Math.ceil(ft/ct);for(let Q=1;Q<it;Q++){const ot=Q/it,ut=D+et*ot,yt=O+st*ot,_=Math.floor(ut/u),K=Math.floor(yt/u);if(_<0||K<0||_>=i.cols||K>=i.rows||i.solid[K*i.cols+_])return!1}return!0};let F=0;for(;F<b.length;){W.push(b[F]);let D=F+2,O=F+1;for(;D<b.length&&H(b[F].x,b[F].y,b[D].x,b[D].y);)O=D,D++;F=O}return W.length>=2&&(b=W),b}for(const[b,B]of T){const W=R+b,H=P+B;if(!v(W,H))continue;const F=d(W,H),D=i.cost[F]||1,O=c[M]+D;O<c[F]&&(f[F]=M,c[F]=O,y[F]=O+lt(W,H,r.x,r.y),h.includes(F)||h.push(F))}}return null}const A={house:{category:"Housing",name:"House",description:"Provides shelter for 2 colonists. Colonists can rest inside to recover fatigue.",key:"1",cost:{wood:20,stone:5},hp:220,size:{w:2,h:2},build:100,color:C.house,popCap:2},farm:{category:"Production",name:"Farm",description:"Grows crops that colonists can harvest for food. Takes 2 days to grow.",key:"2",cost:{wood:15},hp:120,size:{w:2,h:2},build:80,color:C.farm,growTime:1},turret:{category:"Defense",name:"Turret",description:"Automated defense structure. Shoots at enemies within range.",key:"3",cost:{wood:10,stone:20},hp:160,size:{w:1,h:1},build:120,color:C.turret,range:190,fireRate:.6,dps:30},wall:{category:"Defense",name:"Wall",description:"Blocks enemy movement. Essential for creating defensive perimeters.",key:"4",cost:{wood:5,stone:5},hp:150,size:{w:1,h:1},build:40,color:C.wall},stock:{category:"Utility",name:"Stockpile",description:"Increases resource storage capacity by 100. Colonists will store materials here.",key:"5",cost:{wood:10},hp:140,size:{w:2,h:2},build:60,color:C.stock,storageBonus:100},tent:{category:"Utility",name:"Recruit Tent",description:"Attracts new colonists every 60 seconds. Requires 15 food per recruit.",key:"6",cost:{wood:30,food:10},hp:140,size:{w:2,h:2},build:80,color:C.tent},warehouse:{category:"Utility",name:"Warehouse",description:"Large storage facility. Increases resource capacity by 300.",key:"7",cost:{wood:40,stone:20},hp:260,size:{w:3,h:2},build:160,color:C.stock,storageBonus:300},well:{category:"Production",name:"Well",description:"Provides clean water. Colonists can collect water here for food production.",key:"8",cost:{stone:25},hp:160,size:{w:1,h:1},build:80,color:C.farm},infirmary:{category:"Utility",name:"Infirmary",description:"Heals injured colonists within range. Essential for colony survival.",key:"9",cost:{wood:30,stone:20,food:10},hp:200,size:{w:2,h:2},build:140,color:C.bld,healRate:3,healRange:140},path:{category:"Utility",name:"Path",description:"Improves colonist movement speed by 50%. Cheap way to optimize traffic flow.",key:"0",cost:{wood:1},hp:1,size:{w:1,h:1},build:5,color:"#475569",speedBonus:1.5}};function X(i,t){if(!t)return!0;for(const s of Object.keys(t))if((i[s]||0)<(t[s]||0))return!1;return!0}function J(i,t){if(t)for(const s of Object.keys(t))i[s]-=t[s]||0}function V(i,t,s){const o=A[i],e=Math.floor(t/u)*u,l=Math.floor(s/u)*u;return{kind:i,...o,x:e,y:l,w:o.size.w*u,h:o.size.h*u,hp:o.hp,buildLeft:o.build,done:!1,growth:0,ready:!1,cooldown:0}}function vt(i){const t={};for(const s of Object.keys(i)){const o=i[s],e=o.category||"Other";(t[e]||(t[e]=[])).push([s,o])}for(const s of Object.keys(t))t[s].sort((o,e)=>o[1].name.localeCompare(e[1].name));return t}function Tt(i,t){i.setTransform(1,0,0,1,0,0),i.fillStyle=C.sky,i.fillRect(0,0,t.width,t.height)}function Rt(i,t){i.translate(-t.x*t.zoom,-t.y*t.zoom),i.scale(t.zoom,t.zoom)}function Pt(i){i.fillStyle=C.ground,i.fillRect(0,0,g.w,g.h),i.globalAlpha=.08,i.strokeStyle="#d6e4ff",i.lineWidth=1,i.beginPath();for(let t=0;t<=g.w;t+=u)i.moveTo(t,0),i.lineTo(t,g.h);for(let t=0;t<=g.h;t+=u)i.moveTo(0,t),i.lineTo(g.w,t);i.stroke(),i.globalAlpha=1}function Z(i,t,s,o,e){i.fillStyle=e,i.beginPath(),i.arc(t,s,o,0,Math.PI*2),i.fill()}function Ct(i,t,s,o,e,l,a=0){i.fillStyle=l,i.beginPath();for(let n=0;n<e;n++){const r=a+n*2*Math.PI/e,d=t+Math.cos(r)*o,h=s+Math.sin(r)*o;n===0?i.moveTo(d,h):i.lineTo(d,h)}i.closePath(),i.fill()}function at(i,t,s,o=10,e=C.colonist){i.save(),i.translate(t,s);const l="#0b0f14",a=o*.32,n=-o*.3;i.fillStyle=e,i.beginPath(),i.arc(0,n,a,0,Math.PI*2),i.fill(),i.strokeStyle=l,i.lineWidth=1,i.beginPath(),i.arc(0,n,a+.5,0,Math.PI*2),i.stroke();const r=o*.55,d=o*.55,h=-o*.05;i.fillStyle=e,i.beginPath(),i.moveTo(-r/2,h-d/2),i.lineTo(r/2,h-d/2),i.lineTo(r/2,h+d/2),i.lineTo(-r/2,h+d/2),i.closePath(),i.fill(),i.strokeStyle=l,i.stroke();const f=o*.18,c=o*.5,y=h+d/2+c*.1;i.fillStyle=e,i.fillRect(-f-.6,y-c,f,c),i.fillRect(.6,y-c,f,c),i.strokeStyle=l,i.strokeRect(-f-.6,y-c,f,c),i.strokeRect(.6,y-c,f,c),i.restore()}function Bt(i,t,s,o=12,e="#60a5fa"){i.save(),i.translate(t,s),i.fillStyle=e,i.strokeStyle="#0b0f14",i.lineWidth=1,i.beginPath();const l=o,a=o*1.2;i.moveTo(0,-a*.5),i.lineTo(l*.35,-a*.25),i.lineTo(l*.35,a*.1),i.quadraticCurveTo(0,a*.55,-l*.35,a*.1),i.lineTo(-l*.35,-a*.25),i.closePath(),i.fill(),i.stroke(),i.restore()}function Ft(i,t){if(t.kind==="path"){i.fillStyle="#1f2937",i.fillRect(t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1);return}if(i.fillStyle=t.color,i.fillRect(t.x,t.y,t.w,t.h),i.strokeStyle="#0b0f14cc",i.strokeRect(t.x+.5,t.y+.5,t.w-1,t.h-1),!t.done){i.fillStyle="#0b1220",i.fillRect(t.x,t.y-6,t.w,4),i.fillStyle="#6ee7ff";const l=1-t.buildLeft/t.build;i.fillRect(t.x,t.y-6,l*t.w,4)}i.fillStyle="#0b0f14aa",i.font="bold 12px system-ui";const s=t.x+t.w/2,o=t.y+t.h/2;let e="B";t.kind==="hq"?e="HQ":t.kind==="house"?e="H":t.kind==="farm"?e=t.ready?"F*":"F":t.kind==="turret"?e="T":t.kind==="wall"?e="W":t.kind==="stock"?e="S":t.kind==="tent"?e="R":t.kind==="warehouse"?e="WH":t.kind==="well"?e="WL":t.kind==="infirmary"&&(e="I"),i.textAlign="center",i.textBaseline="middle",i.fillText(e,s,o),t.kind==="turret"&&t.range&&(i.globalAlpha=.07,i.fillStyle="#e2f3ff",i.beginPath(),i.arc(s,o,t.range,0,Math.PI*2),i.fill(),i.globalAlpha=1)}function It(i,t){for(const s of t)i.globalAlpha=.8,i.strokeStyle="#e0f2fe",i.lineWidth=2,i.beginPath(),i.moveTo(s.x,s.y),i.lineTo(s.tx,s.ty),i.stroke(),i.globalAlpha=1}function Dt(i,t,s,o){o.uiScale;const e=o.scale(10),l=o.scale(34),a=t.width;i.fillStyle="#0b122088",i.fillRect(0,0,a,l),i.strokeStyle="#1e293b",i.lineWidth=1,i.strokeRect(0,.5,a,l),i.fillStyle="#dbeafe",i.font=o.getScaledFont(14,"600");let n=e;const r=o.scale(140);if(L(i,n,o.scale(8),`Wood: ${Math.floor(s.res.wood)}`,"#b08968",o),n+=r,L(i,n,o.scale(8),`Stone: ${Math.floor(s.res.stone)}`,"#9aa5b1",o),n+=Math.max(r,o.scale(150)),L(i,n,o.scale(8),`Food: ${Math.floor(s.res.food)}`,"#9ae6b4",o),n+=r,s.storage){const k=Math.floor(s.storage.used/s.storage.max*100),m=k>90?"#ef4444":k>70?"#eab308":"#22c55e";L(i,n,o.scale(8),`Storage: ${Math.floor(s.storage.used)}/${s.storage.max} (${k}%)`,m,o),n+=o.scale(180)}const d=`Colonists: ${s.colonists}/${s.cap}`;L(i,n,o.scale(8),d,"#93c5fd",o),n+=Math.max(r,o.scale(190));const h=`Hiding: ${s.hiding}`;L(i,n,o.scale(8),h,"#60a5fa",o),n+=o.scale(120);const f=`Day ${s.day} ‚Äî ${s.tDay*24|0}:00 ${s.isNight?"üåô":"‚òÄÔ∏è"}`;L(i,n,o.scale(8),f,s.isNight?"#ffd166":"#6ee7ff",o);const c=t.height-o.scale(46),y=Math.max(o.scale(120),Math.min(o.scale(180),(t.width-e*2)/s.hotbar.length));n=e,i.fillStyle="#0b122088",i.fillRect(0,c,t.width,o.scale(46)),i.strokeStyle="#1e293b",i.strokeRect(0,c+.5,t.width,o.scale(46)),i.font=o.getScaledFont(13);for(let k=0;k<s.hotbar.length;k++){const m=s.hotbar[k];Et(i,n+o.scale(2),c+o.scale(6),y-o.scale(6),o.scale(34),`${k+1}. ${m.name}`,m.cost,m.selected,o),n+=y}let x=l+o.scale(6);const S=Math.min(o.scale(360),t.width-e*2);for(let k=s.messages.length-1;k>=0;k--){const m=s.messages[k];$t(i,a-S-e,x,m.text,S,o),x+=o.scale(22)}}function L(i,t,s,o,e,l){const a=i.measureText(o).width+l.scale(18),n=l.scale(20);i.fillStyle="#0f172a",i.fillRect(t,s,a,n),i.strokeStyle="#1e293b",i.strokeRect(t+.5,s+.5,a-1,n-1),i.fillStyle=e,i.fillRect(t+l.scale(2),s+l.scale(2),l.scale(6),n-l.scale(4)),i.fillStyle="#dbeafe",i.fillText(o,t+l.scale(12),s+l.scale(14))}function Et(i,t,s,o,e,l,a,n,r){i.fillStyle=n?"#102034":"#0f172a",i.fillRect(t,s,o,e),i.strokeStyle=n?"#4b9fff":"#1e293b",i.strokeRect(t+.5,s+.5,o-1,e-1),i.fillStyle="#dbeafe",i.fillText(l,t+r.scale(8),s+r.scale(20)),i.fillStyle="#9fb3c8",i.fillText(a,t+o-r.scale(48),s+r.scale(20))}function $t(i,t,s,o,e,l){const a=l.scale(20);i.fillStyle="#0f172aee",i.fillRect(t,s,e,a),i.strokeStyle="#1e293b",i.strokeRect(t+.5,s+.5,e-1,a-1),i.fillStyle="#dbeafe",i.fillText(o,t+l.scale(8),s+l.scale(14))}function N(i,t,s,o){for(const e of i.buildings){if(e.kind==="hq"||e.kind==="path"||e.kind==="house"||!e.done)continue;const l=Math.max(e.x,Math.min(t,e.x+e.w)),a=Math.max(e.y,Math.min(s,e.y+e.h)),n=t-l,r=s-a;if(n*n+r*r<=o*o)return!0}return!1}function Ot(i,t,s){const e=Math.floor(t/24)*24,l=Math.floor(s/24)*24,a=i.buildings.find(n=>n.kind==="path"&&n.done&&n.x===e&&n.y===l);return a&&a.speedBonus?a.speedBonus:1}function U(i,t,s,o,e,l=1){const a=s-t.x,n=o-t.y,r=Math.hypot(a,n);if(r<5)return!0;const d=Ot(i,t.x,t.y),f=t.speed*l*d*e,c=a/r,y=n/r,x=t.x+c*f,S=t.y+y*f;if(N(i,x,S,t.r)){const k=-y,m=c,w=t.x+k*f*.5,v=t.y+m*f*.5;if(!N(i,w,v,t.r))return t.x=Math.max(0,Math.min(w,g.w)),t.y=Math.max(0,Math.min(v,g.h)),!1;const T=t.x-k*f*.5,M=t.y-m*f*.5;return N(i,T,M,t.r)||(t.x=Math.max(0,Math.min(T,g.w)),t.y=Math.max(0,Math.min(M,g.h))),!1}else return t.x=Math.max(0,Math.min(x,g.w)),t.y=Math.max(0,Math.min(S,g.h)),!1}function At(i,t){if(t.stuckTimer===void 0&&(t.stuckTimer=0),N(i,t.x,t.y,t.r)){if(t.stuckTimer+=1/60,t.stuckTimer>2){const o=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let e=!1;for(const l of[20,40,60,80]){for(const a of o){const n=t.x+Math.cos(a)*l,r=t.y+Math.sin(a)*l,d=Math.max(t.r,Math.min(n,g.w-t.r)),h=Math.max(t.r,Math.min(r,g.h-t.r));if(!N(i,d,h,t.r)){t.x=d,t.y=h,t.stuckTimer=0,e=!0,console.log(`Rescued stuck colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) using distance ${l}`);break}}if(e)break}if(!e){const l=i.buildings.find(a=>a.kind==="hq");l&&(t.x=l.x+l.w/2+(Math.random()-.5)*40,t.y=l.y-40+(Math.random()-.5)*20,t.stuckTimer=0,console.log("Emergency rescue: teleported stuck colonist to HQ area"))}return!0}}else t.stuckTimer=0;return!1}function Wt(i,t,s){if(!t.alive)return;if(t.t+=s,t.state||(t.state="seekTask"),t.stateSince=(t.stateSince||0)+s,At(i,t)){t.task=null,t.target=null,i.clearPath&&i.clearPath(t),t.state="seekTask",t.stateSince=0;return}t.hunger=Math.min(100,(t.hunger||0)+s*1.2),t.inside?t.fatigue=Math.max(0,(t.fatigue||0)-s*12):t.fatigue=Math.min(100,(t.fatigue||0)+s*4);const o=i.enemies.find(e=>E(e,t)<140*140);switch(t.lastHp=t.lastHp??t.hp,t.hp<t.lastHp&&(t.hurt=1.5),t.lastHp=t.hp,t.hurt=Math.max(0,(t.hurt||0)-s),!t.inside&&o&&t.state!=="flee"&&(t.state="flee",t.stateSince=0),!t.inside&&!o&&i.isNight()&&t.state!=="sleep"&&t.state!=="flee"&&(t.state="sleep",t.stateSince=0),t.inside&&t.state!=="resting"&&(t.state="resting",t.stateSince=0),t.state){case"resting":{t.hideTimer=Math.max(0,(t.hideTimer||0)-s),t.hp=Math.min(100,t.hp+4*s),!i.isNight()&&!o&&(t.hurt||0)<=0&&(t.hideTimer||0)<=0&&(i.leaveBuilding(t),t.safeTarget=null,t.safeTimer=0,t.state="seekTask",t.stateSince=0);break}case"flee":{let e=null,l=null;const a=o?i.findSafeTurret(t,o):null;if(a){const n=a.range||120,r=i.centerOf(a),d=i.buildings.find(h=>h.kind==="house"&&h.done&&i.buildingHasSpace(h)&&E(i.centerOf(h),r)<n*n);d&&(l=d,e=i.centerOf(d))}if(!e){const n=i.buildings.find(r=>r.kind==="hq"&&i.buildingHasSpace(r));n&&(l=n,e=i.centerOf(n))}if(!e&&a&&(e=i.centerOf(a)),e){const n=e.x-t.x,r=e.y-t.y,d=Math.hypot(n,r),h=l?t.x>=l.x-8&&t.x<=l.x+l.w+8&&t.y>=l.y-8&&t.y<=l.y+l.h+8:!1;if(d<=20||h)if(l&&i.tryEnterBuilding(t,l))t.hideTimer=3,t.state="resting",t.stateSince=0;else{const f=i.buildings.filter(c=>c.done&&i.buildingHasSpace(c)&&(c.kind==="house"||c.kind==="hq"));if(f.length){const c=f.sort((x,S)=>E(t,i.centerOf(x))-E(t,i.centerOf(S)))[0],y=i.centerOf(c);i.clearPath(t),l=c,e=y}}else U(i,t,e.x,e.y,s,1.8)}else{const n=ht(dt(t,o));t.x+=n.x*(t.speed+90)*s,t.y+=n.y*(t.speed+90)*s}o||(t.state="seekTask",t.stateSince=0);break}case"sleep":{const e=i.buildings.filter(c=>c.kind==="house"&&c.done&&i.isProtectedByTurret(c)&&i.buildingHasSpace(c));if(!i.isNight()||e.length===0){t.state="seekTask",t.stateSince=0;break}let l=e[0],a=E(t,i.centerOf(l));for(let c=1;c<e.length;c++){const y=E(t,i.centerOf(e[c]));y<a&&(a=y,l=e[c])}const n=i.centerOf(l),r=n.x-t.x,d=n.y-t.y,h=Math.hypot(r,d),f=t.x>=l.x-8&&t.x<=l.x+l.w+8&&t.y>=l.y-8&&t.y<=l.y+l.h+8;if(h<=20||f)if(i.tryEnterBuilding(t,l))t.hideTimer=0,t.state="resting",t.stateSince=0;else{const c=i.buildings.filter(y=>y.done&&i.buildingHasSpace(y)&&(y.kind==="house"||y.kind==="hq")).sort((y,x)=>E(t,i.centerOf(y))-E(t,i.centerOf(x)))[0];c?(i.centerOf(c),i.clearPath(t)):(t.state="seekTask",t.stateSince=0)}else U(i,t,n.x,n.y,s);break}case"seekTask":{if(i.isNight()){t.state="sleep",t.stateSince=0;break}if(!t.task||t.task==="idle"&&Math.random()<.005){const e=t.task;i.pickTask(t),e!==t.task&&Math.random()<.1&&console.log(`Colonist assigned task: ${t.task}, target:`,t.target)}switch(t.task){case"build":t.state="build";break;case"harvestFarm":t.state="harvest";break;case"harvestWell":t.state="harvest";break;case"chop":t.state="chop";break;case"mine":t.state="mine";break;case"idle":default:t.state="idle";break}t.stateSince=0;break}case"idle":{const e=t.target;if(!e){t.state="seekTask";break}i.moveAlongPath(t,s,e,8)&&(t.task=null,t.target=null,i.clearPath(t),t.state="seekTask",t.stateSince=0);break}case"build":{const e=t.target;if(!e||e.done){i.releaseBuildReservation(t),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const l={x:e.x+e.w/2,y:e.y+e.h/2};if(i.moveAlongPath(t,s,l,12)&&(e.buildLeft-=25*s,e.buildLeft<=0)){if(e.done=!0,e.kind==="farm"&&(e.growth=0,e.ready=!1),N(i,t.x,t.y,t.r)){const a=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let n=!1;for(const r of a){const d=Math.max(e.w,e.h)/2+t.r+10,h=e.x+e.w/2+Math.cos(r)*d,f=e.y+e.h/2+Math.sin(r)*d,c=Math.max(t.r,Math.min(h,g.w-t.r)),y=Math.max(t.r,Math.min(f,g.h-t.r));if(!N(i,c,y,t.r)){t.x=c,t.y=y,n=!0,Math.random()<.1&&console.log(`Moved colonist to safety after building completion: (${t.x.toFixed(1)}, ${t.y.toFixed(1)})`);break}}if(!n){const r=i.buildings.find(d=>d.kind==="hq");r&&(t.x=r.x+r.w/2,t.y=r.y-30,console.log("Emergency teleport to HQ area after building completion"))}}i.msg(e.name?e.name+" complete":"Building complete"),i.rebuildNavGrid(),i.clearPath(t),i.releaseBuildReservation(t),t.task=null,t.target=null,t.state="seekTask"}break}case"harvest":{const e=t.target;if(!e){t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}if(e.kind==="farm"&&!e.ready){t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const l={x:e.x+e.w/2,y:e.y+e.h/2};if(i.moveAlongPath(t,s,l,12)){if(e.kind==="farm"){e.ready=!1,e.growth=0;const a=i.addResource("food",10);a>0&&i.msg(`Farm harvested (+${a} food)`,"good")}else if(e.kind==="well"){const a=i.addResource("food",5);a>0&&i.msg(`Well collected (+${a} food)`,"good")}t.task=null,t.target=null,i.clearPath(t),t.state="seekTask"}break}case"chop":{const e=t.target;if(!e||e.hp<=0){e&&i.assignedTargets.has(e)&&i.assignedTargets.delete(e),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const l=e.x-t.x,a=e.y-t.y,n=Math.hypot(l,a),r=(e.r||12)+t.r+4;if(n<=r+2.5+.1){if(e.hp-=18*s,e.hp<=0){const h=i.addResource("wood",6);i.trees.splice(i.trees.indexOf(e),1),i.assignedTargets.has(e)&&i.assignedTargets.delete(e),h>0&&i.msg(`+${h} wood`,"good"),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask"}break}else U(i,t,e.x,e.y,s);t.stateSince&&t.stateSince>15&&(i.assignedTargets.has(e)&&i.assignedTargets.delete(e),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask");break}case"mine":{const e=t.target;if(!e||e.hp<=0){e&&i.assignedTargets.has(e)&&i.assignedTargets.delete(e),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask";break}const l=e.x-t.x,a=e.y-t.y,n=Math.hypot(l,a),r=(e.r||12)+t.r+4,d=2.5;if(Math.random()<.01&&console.log(`Mining: distance=${n.toFixed(1)}, interact=${r}, colonist at (${t.x.toFixed(1)}, ${t.y.toFixed(1)}), rock at (${e.x.toFixed(1)}, ${e.y.toFixed(1)})`),n<=r+d+.1){if(e.hp-=16*s,e.hp<=0){const h=i.addResource("stone",5);i.rocks.splice(i.rocks.indexOf(e),1),i.assignedTargets.has(e)&&i.assignedTargets.delete(e),h>0&&i.msg(`+${h} stone`,"good"),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask"}break}else U(i,t,e.x,e.y,s),Math.random()<.01&&console.log(`Moving toward rock: target=(${e.x.toFixed(1)}, ${e.y.toFixed(1)}), distance=${n.toFixed(1)}`);t.stateSince&&t.stateSince>15&&(console.log(`Colonist stuck mining for ${t.stateSince.toFixed(1)}s, abandoning`),i.assignedTargets.has(e)&&i.assignedTargets.delete(e),t.task=null,t.target=null,i.clearPath(t),t.state="seekTask");break}}for(const e of i.colonists){if(e===t)continue;if((t.state==="mine"||t.state==="chop")&&t.target){const d=(t.target.r||12)+t.r+4;if(Math.hypot(t.x-t.target.x,t.y-t.target.y)<=d+2.5)continue}const l=t.x-e.x,a=t.y-e.y,n=l*l+a*a,r=(t.r+2)*(t.r+2);if(n>0&&n<r*4){const d=Math.sqrt(n)||1,h=(r*2-d)*.5;t.x+=l/d*h*s*6,t.y+=a/d*h*s*6}}}function tt(i,t,s,o){for(const e of i.buildings){if(e.kind==="hq"||e.kind==="path"||e.kind==="house"||!e.done)continue;const l=Math.max(e.x,Math.min(t,e.x+e.w)),a=Math.max(e.y,Math.min(s,e.y+e.h)),n=t-l,r=s-a;if(n*n+r*r<=o*o)return!0}return!1}function Ht(i,t,s){const o=i.buildings.find(h=>h.kind==="hq");let e=o,l=E(t,i.centerOf(o));for(const h of i.colonists){const f=E(t,h);f<l&&(l=f,e=h)}const a=e.w?i.centerOf(e):e,n=ht(dt(a,t)),r=t.x+n.x*t.speed*s,d=t.y+n.y*t.speed*s;if(!tt(i,r,d,t.r))t.x=r,t.y=d;else{const h=-n.y,f=n.x,c=t.x+h*t.speed*s*.5,y=t.y+f*t.speed*s*.5;if(!tt(i,c,y,t.r))t.x=c,t.y=y;else{const x=t.x-h*t.speed*s*.5,S=t.y-f*t.speed*s*.5;tt(i,x,S,t.r)||(t.x=x,t.y=S)}}if(e.w){const h=e;i.pointInRect(t,h)&&(h.hp-=t.dmg*s),h.hp<=0&&(h.kind==="hq"?i.lose():(i.evictColonistsFrom(h),i.buildings.splice(i.buildings.indexOf(h),1),i.msg((h.name||h.kind)+" destroyed","warn")))}else{const h=e;Math.hypot(t.x-h.x,t.y-h.y)<t.r+8&&(h.hp-=t.dmg*s,h.hp<=0&&(h.alive=!1,i.colonists.splice(i.colonists.indexOf(h),1),i.msg("A colonist has fallen","warn")))}}class zt{constructor(t){p(this,"canvas");p(this,"ctx");p(this,"DPR",1);p(this,"camera",{x:0,y:0,zoom:1});p(this,"uiScale",1);p(this,"baseFontSize",14);p(this,"RES",{wood:0,stone:0,food:0});p(this,"BASE_STORAGE",200);p(this,"storageFullWarned",!1);p(this,"day",1);p(this,"tDay",0);p(this,"dayLength",180);p(this,"fastForward",1);p(this,"paused",!1);p(this,"prevIsNight",!1);p(this,"colonists",[]);p(this,"enemies",[]);p(this,"trees",[]);p(this,"rocks",[]);p(this,"buildings",[]);p(this,"bullets",[]);p(this,"messages",[]);p(this,"selectedBuild","house");p(this,"hotbar",["house","farm","turret","wall","stock","tent","warehouse","well","infirmary"]);p(this,"showBuildMenu",!1);p(this,"debug",{nav:!1,paths:!0});p(this,"selColonist",null);p(this,"follow",!1);p(this,"keyState",{});p(this,"once",new Set);p(this,"mouse",{x:0,y:0,wx:0,wy:0,down:!1,rdown:!1});p(this,"lastPaintCell",null);p(this,"eraseDragStart",null);p(this,"menuRects",[]);p(this,"handleResize",()=>{const t=window.innerWidth,s=window.innerHeight-48;this.canvas.style.width=t+"px",this.canvas.style.height=s+"px",this.canvas.width=Math.floor(t*this.DPR),this.canvas.height=Math.floor(s*this.DPR),this.calculateUIScale()});p(this,"screenToWorld",(t,s)=>({x:t*this.DPR/this.camera.zoom+this.camera.x,y:s*this.DPR/this.camera.zoom+this.camera.y}));p(this,"respawnTimer",0);p(this,"assignedTargets",new WeakSet);p(this,"buildReservations",new Map);p(this,"insideCounts",new Map);p(this,"last",performance.now());p(this,"frame",t=>{const s=Math.min(.033,(t-this.last)/1e3);this.last=t,this.update(s),this.draw(),requestAnimationFrame(this.frame)});p(this,"grid",kt());const s=t.getContext("2d");if(!s)throw new Error("no ctx");this.canvas=t,this.ctx=s,this.DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)),this.handleResize(),window.addEventListener("resize",()=>this.handleResize()),this.bindInput(),this.newGame(),this.rebuildNavGrid(),requestAnimationFrame(this.frame)}getStorageCapacity(){let t=this.BASE_STORAGE;for(const s of this.buildings)s.done&&s.storageBonus&&(t+=s.storageBonus);return t}getPopulationCap(){return(this.buildings.find(t=>t.kind==="hq")?3:0)+this.buildings.filter(t=>t.kind==="house"&&t.done).reduce((t,s)=>t+(s.popCap||0),0)}addResource(t,s){const o=this.RES.wood+this.RES.stone+this.RES.food,e=this.getStorageCapacity(),l=Math.max(0,e-o),a=Math.min(Math.floor(s),l);return a>0&&(this.RES[t]+=a),a===0&&s>0&&!this.storageFullWarned?(this.msg(`Storage full! Cannot store more ${String(t)}`,"warn"),this.storageFullWarned=!0):a>0&&(this.storageFullWarned=!1),a}calculateUIScale(){const o=this.canvas.width/this.DPR,e=this.canvas.height/this.DPR,l=o/1920,a=e/1080;let n=Math.min(l,a);n=Math.max(.7,Math.min(n,2.5)),o<768?n*=1.4:o<1200&&(n*=1.2),this.uiScale=n,console.log(`UI Scale calculated: ${n.toFixed(2)} for ${o}x${e}`)}getScaledFont(t,s="500",o="system-ui,Segoe UI,Roboto"){return`${s} ${Math.round(t*this.uiScale)}px ${o}`}scale(t){return Math.round(t*this.uiScale)}bindInput(){const t=this.canvas;t.addEventListener("mousemove",s=>{const o=t.getBoundingClientRect();this.mouse.x=s.clientX-o.left,this.mouse.y=s.clientY-o.top;const e=this.screenToWorld(this.mouse.x,this.mouse.y);this.mouse.wx=e.x,this.mouse.wy=e.y,this.mouse.down&&(this.selectedBuild==="path"?this.paintPathAtMouse():this.selectedBuild==="wall"&&this.paintWallAtMouse())}),t.addEventListener("mousedown",s=>{if(s.button===0){if(this.mouse.down=!0,this.showBuildMenu){this.handleBuildMenuClick();return}if(this.selectedBuild==="path")this.paintPathAtMouse(!0);else if(this.selectedBuild==="wall")this.paintWallAtMouse(!0);else{const o=this.findColonistAt(this.mouse.wx,this.mouse.wy);o?(this.selColonist=o,this.follow=!0):this.placeAtMouse()}}if(s.button===2){if(this.mouse.rdown=!0,this.showBuildMenu){this.showBuildMenu=!1;return}this.eraseDragStart={x:this.mouse.wx,y:this.mouse.wy}}}),t.addEventListener("mouseup",s=>{if(s.button===0&&(this.mouse.down=!1,this.lastPaintCell=null),s.button===2){if(this.eraseDragStart){const o=Math.min(this.eraseDragStart.x,this.mouse.wx),e=Math.min(this.eraseDragStart.y,this.mouse.wy),l=Math.max(this.eraseDragStart.x,this.mouse.wx),a=Math.max(this.eraseDragStart.y,this.mouse.wy);(l-o)*(a-e)<12*12?this.cancelOrErase():this.eraseInRect({x:o,y:e,w:l-o,h:a-e})}this.mouse.rdown=!1,this.eraseDragStart=null}}),t.addEventListener("contextmenu",s=>s.preventDefault()),t.addEventListener("wheel",s=>{s.preventDefault();const o=s.deltaY<0?1.1:.9;this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*o))}),window.addEventListener("keydown",s=>{const o=s.key.toLowerCase();this.keyState[o]=!0,this.once.has(o)||this.once.add(o)}),window.addEventListener("keyup",s=>{this.keyState[s.key.toLowerCase()]=!1})}findColonistAt(t,s){for(let o=this.colonists.length-1;o>=0;o--){const e=this.colonists[o];if(!e.alive||e.inside)continue;if((e.x-t)*(e.x-t)+(e.y-s)*(e.y-s)<=(e.r+2)*(e.r+2))return e}return null}msg(t,s="info"){this.messages.push({text:t,t:4,kind:s}),this.toast(t,1600)}toast(t,s=1400){const o=document.getElementById("toast");o&&(o.textContent=t,o.style.opacity="1",clearTimeout(o._t),o._t=setTimeout(()=>o.style.opacity="0",s))}scatter(){for(let t=0;t<220;t++){const s={x:I(80,g.w-80),y:I(80,g.h-80)};Math.hypot(s.x-$.x,s.y-$.y)<220||this.trees.push({x:s.x,y:s.y,r:12,hp:40,type:"tree"})}for(let t=0;t<140;t++){const s={x:I(80,g.w-80),y:I(80,g.h-80)};Math.hypot(s.x-$.x,s.y-$.y)<200||this.rocks.push({x:s.x,y:s.y,r:12,hp:50,type:"rock"})}}tryRespawn(t){if(this.respawnTimer+=t*this.fastForward,this.respawnTimer>=4){this.respawnTimer=0;const s=o=>{for(let e=0;e<6;e++){const l={x:I(60,g.w-60),y:I(60,g.h-60)};if(Math.hypot(l.x-$.x,l.y-$.y)<200)continue;let a=!0;for(const n of this.buildings)if(l.x>n.x-24&&l.x<n.x+n.w+24&&l.y>n.y-24&&l.y<n.y+n.h+24){a=!1;break}if(a){o==="tree"?this.trees.push({x:l.x,y:l.y,r:12,hp:40,type:"tree"}):this.rocks.push({x:l.x,y:l.y,r:12,hp:50,type:"rock"});break}}};Math.random()<.5&&this.trees.length<260&&s("tree"),Math.random()<.35&&this.rocks.length<180&&s("rock")}}buildHQ(){const t={w:3*u,h:3*u},s={kind:"hq",name:"HQ",x:$.x-t.w/2,y:$.y-t.h/2,w:t.w,h:t.h,hp:600,done:!0,color:C.bld,size:{w:3,h:3},build:0,buildLeft:0};this.buildings.push(s),this.rebuildNavGrid()}newGame(){this.colonists.length=this.enemies.length=this.trees.length=this.rocks.length=this.buildings.length=this.bullets.length=this.messages.length=0,this.buildReservations.clear(),this.insideCounts.clear(),this.RES.wood=50,this.RES.stone=30,this.RES.food=20,this.day=1,this.tDay=0,this.fastForward=1,this.camera.zoom=1,this.camera.x=$.x-this.canvas.width/(2*this.camera.zoom),this.camera.y=$.y-this.canvas.height/(2*this.camera.zoom),this.buildHQ(),this.scatter();for(let t=0;t<3;t++){const s=I(0,Math.PI*2),o=80+I(-10,10);this.spawnColonist({x:$.x+Math.cos(s)*o,y:$.y+Math.sin(s)*o})}this.msg("Welcome! Build farms before night, then turrets.")}spawnColonist(t){const s={x:t.x,y:t.y,r:8,hp:100,speed:50,task:null,target:null,carrying:null,hunger:0,alive:!0,color:C.colonist,t:I(0,1)};return this.colonists.push(s),s}spawnEnemy(){const t=wt(0,4);let s,o;t===0?(s=I(0,g.w),o=-80):t===1?(s=I(0,g.w),o=g.h+80):t===2?(s=-80,o=I(0,g.h)):(s=g.w+80,o=I(0,g.h));const e={x:s,y:o,r:9,hp:60+this.day*6,speed:48+this.day*2,dmg:8+this.day,target:null,color:C.enemy};return this.enemies.push(e),e}canPlace(t,s,o){const e={x:s,y:o,w:t.size.w*u,h:t.size.h*u};if(e.x<0||e.y<0||e.x+e.w>g.w||e.y+e.h>g.h)return!1;for(const a of this.buildings)if(!(e.x+e.w<=a.x||e.x>=a.x+a.w||e.y+e.h<=a.y||e.y>=a.y+a.h))return!1;const l=(a,n)=>{const r=Math.max(n.x,Math.min(a.x,n.x+n.w)),d=Math.max(n.y,Math.min(a.y,n.y+n.h)),h=a.x-r,f=a.y-d;return h*h+f*f<=a.r*a.r};for(const a of this.trees)if(l(a,e))return!1;for(const a of this.rocks)if(l(a,e))return!1;return!0}placeAtMouse(){if(this.paused)return;const t=this.selectedBuild;if(!t)return;const s=A[t];if(!s)return;const o=V(t,this.mouse.wx,this.mouse.wy);if(!this.canPlace(o,o.x,o.y)){this.toast("Can't place here");return}if(!X(this.RES,s.cost)){this.toast("Not enough resources");return}if(J(this.RES,s.cost),o.kind!=="path")for(let e=this.buildings.length-1;e>=0;e--){const l=this.buildings[e];l.kind==="path"&&!(o.x+o.w<=l.x||o.x>=l.x+l.w||o.y+o.h<=l.y||o.y>=l.y+l.h)&&this.buildings.splice(e,1)}this.buildings.push(o),this.rebuildNavGrid()}paintPathAtMouse(t=!1){const s=Math.floor(this.mouse.wx/u),o=Math.floor(this.mouse.wy/u);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===s&&this.lastPaintCell.gy===o)return;const e=(x,S)=>{const k=x*u+1,m=S*u+1,w=V("path",k,m);!this.buildings.some(T=>T.kind==="path"&&T.x===w.x&&T.y===w.y)&&X(this.RES,A.path.cost)&&(J(this.RES,A.path.cost),this.buildings.push(w))};if(this.lastPaintCell==null){e(s,o),this.lastPaintCell={gx:s,gy:o},this.rebuildNavGrid();return}let l=this.lastPaintCell.gx,a=this.lastPaintCell.gy,n=s,r=o;const d=Math.abs(n-l),h=Math.abs(r-a),f=l<n?1:-1,c=a<r?1:-1;let y=d-h;for(;e(l,a),!(l===n&&a===r);){const x=2*y;x>-h&&(y-=h,l+=f),x<d&&(y+=d,a+=c)}this.lastPaintCell={gx:s,gy:o},this.rebuildNavGrid()}paintWallAtMouse(t=!1){const s=Math.floor(this.mouse.wx/u),o=Math.floor(this.mouse.wy/u);if(!t&&this.lastPaintCell&&this.lastPaintCell.gx===s&&this.lastPaintCell.gy===o)return;const e=(x,S)=>{const k=x*u+1,m=S*u+1,w=V("wall",k,m);this.buildings.some(T=>T.kind==="wall"&&T.x===w.x&&T.y===w.y)||X(this.RES,A.wall.cost)&&this.canPlace(w,w.x,w.y)&&(J(this.RES,A.wall.cost),this.buildings.push(w))};if(this.lastPaintCell==null){e(s,o),this.lastPaintCell={gx:s,gy:o},this.rebuildNavGrid();return}let l=this.lastPaintCell.gx,a=this.lastPaintCell.gy,n=s,r=o;const d=Math.abs(n-l),h=Math.abs(r-a),f=l<n?1:-1,c=a<r?1:-1;let y=d-h;for(;e(l,a),!(l===n&&a===r);){const x=2*y;x>-h&&(y-=h,l+=f),x<d&&(y+=d,a+=c)}this.lastPaintCell={gx:s,gy:o},this.rebuildNavGrid()}eraseInRect(t){const s=this.buildings.length;for(let e=this.buildings.length-1;e>=0;e--){const l=this.buildings[e];if(l.kind==="hq")continue;!(t.x+t.w<=l.x||t.x>=l.x+l.w||t.y+t.h<=l.y||t.y>=l.y+l.h)&&(this.evictColonistsFrom(l),this.buildings.splice(e,1),this.buildReservations.delete(l),this.insideCounts.delete(l))}const o=s-this.buildings.length;o>0&&(this.msg(`Removed ${o} structure(s)`),this.rebuildNavGrid())}cancelOrErase(){const t={x:this.mouse.wx,y:this.mouse.wy};for(let s=this.buildings.length-1;s>=0;s--){const o=this.buildings[s];if(o.kind!=="hq"&&t.x>=o.x&&t.x<=o.x+o.w&&t.y>=o.y&&t.y<=o.y+o.h){this.evictColonistsFrom(o),this.buildings.splice(s,1),this.msg("Building removed"),this.rebuildNavGrid();return}}this.selectedBuild=null,this.toast("Build canceled")}evictColonistsFrom(t){const s=t.x+t.w/2,o=t.y+t.h/2;for(const e of this.colonists)if(e.inside===t){this.leaveBuilding(e),e.safeTarget=null,e.safeTimer=0;const l=Math.random()*Math.PI*2,a=(t.w/2+10)*Math.cos(l),n=(t.h/2+10)*Math.sin(l);e.x=Y(s+a,0,g.w),e.y=Y(o+n,0,g.h)}}buildingCapacity(t){return t.kind==="hq"?8:t.kind==="house"?3:1}buildingHasSpace(t){const s=this.buildingCapacity(t);return(this.insideCounts.get(t)||0)<s}tryEnterBuilding(t,s){return!s.done||!this.buildingHasSpace(s)?!1:(this.insideCounts.set(s,(this.insideCounts.get(s)||0)+1),t.inside=s,t.hideTimer=0,!0)}leaveBuilding(t){const s=t.inside;if(s){const o=(this.insideCounts.get(s)||1)-1;o<=0?this.insideCounts.delete(s):this.insideCounts.set(s,o)}t.inside=null,t.hideTimer=0}getMaxCrew(t){const s=t.w/u*(t.h/u);return s<=1?1:s<=4?2:3}releaseBuildReservation(t){if(!t.reservedBuildFor)return;const s=t.reservedBuildFor,o=(this.buildReservations.get(s)||1)-1;o<=0?this.buildReservations.delete(s):this.buildReservations.set(s,o),t.reservedBuildFor=null}clearPath(t){t.path=void 0,t.pathIndex=void 0,t.repath=0}setTask(t,s,o){if(t.target&&t.target.type&&this.assignedTargets.has(t.target)&&this.assignedTargets.delete(t.target),t.reservedBuildFor&&t.reservedBuildFor!==o&&this.releaseBuildReservation(t),t.task=s,t.target=o,this.clearPath(t),o&&o.type&&(o.type==="tree"||o.type==="rock")&&this.assignedTargets.add(o),s==="build"&&o&&o.w!=null&&!t.reservedBuildFor){const e=o,l=this.buildReservations.get(e)||0,a=this.getMaxCrew(e);l<a&&(this.buildReservations.set(e,l+1),t.reservedBuildFor=e)}}pickTask(t){let s=null,o=1/0;for(const n of this.buildings){if(n.done||(this.buildReservations.get(n)||0)>=this.getMaxCrew(n))continue;const d=E({x:t.x,y:t.y},this.centerOf(n));d<o&&(o=d,s=n)}if(s){this.setTask(t,"build",s);return}const e=this.buildings.find(n=>n.kind==="farm"&&n.done&&n.ready);if(e){this.setTask(t,"harvestFarm",e);return}if(Math.random()<.1){const n=this.buildings.find(r=>r.kind==="well"&&r.done);if(n){this.setTask(t,"harvestWell",n);return}}if(this.RES.food<Math.max(4,this.colonists.length*2)){const n=this.nearestCircle({x:t.x,y:t.y},this.trees.filter(r=>!this.assignedTargets.has(r)));if(n){this.setTask(t,"chop",n);return}}const l=this.trees.filter(n=>!this.assignedTargets.has(n)),a=this.rocks.filter(n=>!this.assignedTargets.has(n));if(Math.random()<.05&&console.log(`Task assignment: wood=${this.RES.wood}, stone=${this.RES.stone}, trees=${l.length}, rocks=${a.length}`),this.RES.wood<this.RES.stone){const n=this.nearestCircle({x:t.x,y:t.y},l);if(n){Math.random()<.1&&console.log("Assigning chop task"),this.setTask(t,"chop",n);return}else Math.random()<.1&&console.log("No trees available for chopping")}else{const n=this.nearestCircle({x:t.x,y:t.y},a);if(n){Math.random()<.1&&console.log("Assigning mine task to rock at:",n),this.setTask(t,"mine",n);return}else Math.random()<.1&&console.log("No rocks available for mining")}Math.random()<.1&&console.log("Assigning idle task"),this.setTask(t,"idle",{x:t.x+I(-80,80),y:t.y+I(-80,80)})}nearestCircle(t,s){let o=null,e=1e9;for(const l of s){const a=E(t,l);a<e&&(e=a,o=l)}return o}moveAlongPath(t,s,o,e=10){t.repath=(t.repath||0)-s;const l=o&&(!t.pathGoal||Math.hypot(t.pathGoal.x-o.x,t.pathGoal.y-o.y)>12);if(o&&(l||t.repath==null||t.repath<=0||!t.path||t.pathIndex==null)){const f=this.computePath(t.x,t.y,o.x,o.y);f&&f.length?(t.path=f,t.pathIndex=0,t.pathGoal={x:o.x,y:o.y}):Math.random()<.05&&console.log(`Failed to compute path from (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) to (${o.x.toFixed(1)}, ${o.y.toFixed(1)})`),t.repath=2}if(!t.path||t.pathIndex==null||t.pathIndex>=t.path.length)return o?Math.hypot(t.x-o.x,t.y-o.y)<=e:!1;const a=t.path[t.pathIndex],n=a.x-t.x,r=a.y-t.y,d=Math.hypot(n,r);if(d<10)return t.pathIndex++,t.pathIndex>=t.path.length?(t.path=void 0,t.pathIndex=void 0,o?Math.hypot(t.x-o.x,t.y-o.y)<=e:!0):!1;let h=t.speed;{const f=Math.floor(t.x/u),c=Math.floor(t.y/u);if(f>=0&&c>=0&&f<this.grid.cols&&c<this.grid.rows){const x=c*this.grid.cols+f;this.grid.cost[x]<=.7&&(h*=1.125)}}return t.x+=n/(d||1)*h*s,t.y+=r/(d||1)*h*s,t.x=Math.max(0,Math.min(t.x,g.w)),t.y=Math.max(0,Math.min(t.y,g.h)),!1}findSafeTurret(t,s){let o=null,e=1/0;for(const l of this.buildings){if(l.kind!=="turret"||!l.done)continue;const a=this.centerOf(l),n=Math.hypot(t.x-a.x,t.y-a.y),r=Math.hypot(s.x-a.x,s.y-a.y),d=l.range||160,h=r<d?100:0,f=n+h;f<e&&(e=f,o=l)}return o}isProtectedByTurret(t){const s=this.centerOf(t);for(const o of this.buildings){if(o.kind!=="turret"||!o.done)continue;const e=o.range||120,l=this.centerOf(o);if(E(s,l)<e*e)return!0}return!1}centerOf(t){return{x:t.x+t.w/2,y:t.y+t.h/2}}pointInRect(t,s){return t.x>=s.x&&t.x<=s.x+s.w&&t.y>=s.y&&t.y<=s.y+s.h}updateTurret(t,s){if(!("range"in t)||!t.range)return;t.cooldown=Math.max(0,(t.cooldown||0)-s);let o=null,e=1e9;const l=this.centerOf(t);for(const a of this.enemies){const n=E(a,l);n<t.range*t.range&&n<e&&(e=n,o=a)}o&&(t.cooldown||0)<=0&&(o.hp-=t.dps||0,this.bullets.push({x:l.x,y:l.y,tx:o.x,ty:o.y,t:.12}),t.cooldown=t.fireRate||.6)}isNight(){return this.tDay>=nt.start||this.tDay<=nt.end}spawnWave(){const t=4+Math.floor(this.day*1.3);for(let s=0;s<t;s++)this.spawnEnemy();this.msg(`Night ${this.day}: Enemies incoming!`,"warn")}nextDay(){this.day++,this.waveSpawnedForDay=!1;let t=0;for(let e=0;e<this.colonists.length;e++)this.RES.food>0?this.RES.food-=1:(t++,this.colonists[e]&&(this.colonists[e].alive=!1));t>0&&(this.colonists=this.colonists.filter(e=>e.alive),this.msg(`${t} colonist(s) starved`,"bad"));for(const e of this.buildings)e.kind==="farm"&&e.done&&(e.growth=(e.growth||0)+.5,(e.growth||0)>=(e.growTime||1)&&(e.ready=!0));const s=this.buildings.find(e=>e.kind==="tent"&&e.done),o=(this.buildings.find(e=>e.kind==="hq")?3:0)+this.buildings.filter(e=>e.kind==="house"&&e.done).reduce((e,l)=>e+(l.popCap||0),0);s&&this.colonists.length<o&&this.RES.food>=15&&(this.RES.food-=15,this.spawnColonist({x:$.x+I(-20,20),y:$.y+I(-20,20)}),this.msg("A new colonist joined! (-15 food)","info")),this.day>8&&this.win()}dayTick(t){const s=this.isNight();this.tDay+=t*this.fastForward/this.dayLength,this.tDay>=1&&(this.tDay-=1,this.nextDay());const o=this.isNight();!s&&o&&this.spawnWave(),this.prevIsNight=o}keyPressed(t){return this.once.has(t)?(this.once.delete(t),!0):!1}update(t){if(this.keyPressed(" ")){this.paused=!this.paused;const o=document.getElementById("btnPause");o&&(o.textContent=this.paused?"Resume":"Pause")}if(this.keyPressed("h")){const o=document.getElementById("help");o&&(o.hidden=!o.hidden)}this.keyPressed("b")&&(this.showBuildMenu=!this.showBuildMenu),this.keyPressed("g")&&(this.debug.nav=!this.debug.nav,this.toast(this.debug.nav?"Debug: nav ON":"Debug: nav OFF")),this.keyPressed("escape")&&(this.showBuildMenu?this.showBuildMenu=!1:(this.selectedBuild=null,this.toast("Build canceled"),this.selColonist=null,this.follow=!1)),this.keyPressed("f")&&(this.fastForward=this.fastForward===1?6:1,this.toast(this.fastForward>1?"Fast-forward ON":"Fast-forward OFF"));const s=360*t/this.camera.zoom;if(this.keyState.w&&(this.camera.y-=s),this.keyState.s&&(this.camera.y+=s),this.keyState.a&&(this.camera.x-=s),this.keyState.d&&(this.camera.x+=s),(this.keyState["+"]||this.keyState["="])&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*1.02))),(this.keyState["-"]||this.keyState._)&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom/1.02))),!this.paused){for(const[o,e]of this.hotbar.entries())this.keyPressed(String(o+1))&&(this.selectedBuild=e,this.toast("Selected: "+A[e].name));if(this.follow&&this.selColonist){const o=this.selColonist,e=this.canvas.width/this.camera.zoom,l=this.canvas.height/this.camera.zoom;this.camera.x=Y(o.x-e/2,0,Math.max(0,g.w-e)),this.camera.y=Y(o.y-l/2,0,Math.max(0,g.h-l))}this.dayTick(t);for(const o of this.colonists)Wt(this,o,t*this.fastForward);for(let o=this.enemies.length-1;o>=0;o--){const e=this.enemies[o];Ht(this,e,t*this.fastForward),e.hp<=0&&(this.enemies.splice(o,1),Math.random()<.5&&(this.RES.food+=1))}for(const o of this.buildings){if(o.kind==="turret"&&o.done&&this.updateTurret(o,t*this.fastForward),o.healRate&&o.done){const e=o.healRate,l=o.healRange||120,a=this.centerOf(o);for(const n of this.colonists)(n.x-a.x)*(n.x-a.x)+(n.y-a.y)*(n.y-a.y)<l*l&&(n.hp=Math.min(100,n.hp+e*t*this.fastForward))}if(o.kind==="tent"&&o.done&&(o.cooldown=(o.cooldown||0)-t*this.fastForward,o.cooldown<=0&&this.RES.food>=15)){const e=this.getPopulationCap();if(this.colonists.length<e){this.RES.food-=15;const l=this.centerOf(o);this.spawnColonist({x:l.x+(Math.random()-.5)*40,y:l.y+(Math.random()-.5)*40}),this.msg("Recruit tent attracted a new colonist! (-15 food)","good"),o.cooldown=60}}}this.tryRespawn(t);for(let o=this.bullets.length-1;o>=0;o--){const e=this.bullets[o];e.t-=t,e.t<=0&&this.bullets.splice(o,1)}for(let o=this.messages.length-1;o>=0;o--){const e=this.messages[o];e.t-=t,e.t<=0&&this.messages.splice(o,1)}}}draw(){const{ctx:t}=this;Tt(t,this.canvas),t.save(),Rt(t,this.camera),Pt(t);for(const n of this.trees)Z(t,n.x,n.y,n.r,C.tree);for(const n of this.rocks)Z(t,n.x,n.y,n.r,C.rock);for(const n of this.buildings)if(Ft(t,n),(n.kind==="house"||n.kind==="hq")&&this.buildings.some(d=>d.kind==="turret"&&d.done&&E(this.centerOf(n),this.centerOf(d))<(d.range||120)*(d.range||120))){const d=this.centerOf(n);Bt(t,d.x,n.y-8,12,"#60a5fa")}{const n=new Map;for(const r of this.colonists)r.inside&&n.set(r.inside,(n.get(r.inside)||0)+1);t.save();for(const[r,d]of n){if(!d)continue;const h=8,f=Math.min(d,h),c=10,y=4,x=f*(c+y)-y;let S=r.x+r.w/2-x/2+c/2;const k=r.y+r.h+8,m=this.colonists.filter(w=>w.inside===r);for(let w=0;w<f;w++){const v=m[w%m.length],T=v?v.hp:100,M=T>66?"#22c55e":T>33?"#eab308":"#ef4444";at(t,S+w*(c+y),k,10,M)}if(d>h){const w=d-h,v=S+f*(c+y)+6;t.fillStyle="#dbeafe",t.font="600 11px system-ui,Segoe UI,Roboto",t.fillText("+"+w,v,k+4)}}t.restore()}for(const n of this.colonists)n.inside||Z(t,n.x,n.y,n.r,this.selColonist===n?"#93c5fd":C.colonist);if(this.debug.nav){t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444";for(let n=0;n<this.grid.rows;n++)for(let r=0;r<this.grid.cols;r++)this.grid.solid[n*this.grid.cols+r]&&t.fillRect(r*u,n*u,u,u);t.restore(),t.save(),t.globalAlpha=.12;for(let n=0;n<this.grid.rows;n++)for(let r=0;r<this.grid.cols;r++){const d=n*this.grid.cols+r;if(!this.grid.solid[d]){const h=this.grid.cost[d];h<=.7?t.fillStyle="#22c55e":h<=1?t.fillStyle="#eab308":t.fillStyle="#f97316",t.fillRect(r*u,n*u,u,u)}}t.restore(),t.save(),t.strokeStyle="#22d3ee",t.lineWidth=2;for(const n of this.colonists)if(!(!n.path||!n.path.length)){t.beginPath(),t.moveTo(n.x,n.y);for(let r=n.pathIndex??0;r<n.path.length;r++){const d=n.path[r];t.lineTo(d.x,d.y)}if(t.stroke(),n.pathIndex!=null&&n.pathIndex<n.path.length){const r=n.path[n.pathIndex];t.save(),t.fillStyle="#fbbf24",t.beginPath(),t.arc(r.x,r.y,6,0,Math.PI*2),t.fill(),t.restore()}}t.restore(),t.save(),t.font="11px monospace",t.fillStyle="#ffffff",t.strokeStyle="#000000",t.lineWidth=2;for(const n of this.colonists){if(n.inside)continue;const r=`${n.task||n.state||"idle"}`,d=n.x-20,h=n.y-n.r-8;if(t.strokeText(r,d,h),t.fillText(r,d,h),n.target&&n.target.x!=null){const f=n.target;t.save(),t.strokeStyle="#94a3b8",t.lineWidth=1,t.setLineDash([3,3]),t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(f.x,f.y),t.stroke(),t.setLineDash([]),t.restore()}}t.restore()}for(const n of this.enemies)Ct(t,n.x,n.y,n.r+2,3,C.enemy,-Math.PI/2);if(It(t,this.bullets),this.isNight()&&(t.fillStyle="rgba(6,10,18, 0.58)",t.fillRect(0,0,g.w,g.h)),this.selectedBuild){const n=A[this.selectedBuild],r=Math.floor(this.mouse.wx/u)*u,d=Math.floor(this.mouse.wy/u)*u,h=this.canPlace({...n,size:n.size},r,d)&&X(this.RES,n.cost);t.globalAlpha=.6,t.fillStyle=h?C.ghost:"#ff6b6b88",t.fillRect(r,d,n.size.w*u,n.size.h*u),t.globalAlpha=1}if(this.mouse.rdown&&this.eraseDragStart){const n=Math.min(this.eraseDragStart.x,this.mouse.wx),r=Math.min(this.eraseDragStart.y,this.mouse.wy),d=Math.abs(this.mouse.wx-this.eraseDragStart.x),h=Math.abs(this.mouse.wy-this.eraseDragStart.y);t.save(),t.globalAlpha=.18,t.fillStyle="#ef4444",t.fillRect(n,r,d,h),t.globalAlpha=1,t.strokeStyle="#ef4444",t.setLineDash([6,4]),t.strokeRect(n+.5,r+.5,d-1,h-1),t.setLineDash([]),t.restore()}t.restore();const s=this.getPopulationCap(),o=this.colonists.filter(n=>!!n.inside).length,e=this.RES.wood+this.RES.stone+this.RES.food,l=this.getStorageCapacity(),a=this.hotbar.map(n=>({key:String(n),name:A[n].name,cost:this.costText(A[n].cost||{}),selected:this.selectedBuild===n}));Dt(this.ctx,this.canvas,{res:this.RES,colonists:this.colonists.length,cap:s,hiding:o,day:this.day,tDay:this.tDay,isNight:this.isNight(),hotbar:a,messages:this.messages,storage:{used:e,max:l}},this),this.selColonist&&this.drawColonistProfile(this.selColonist),this.showBuildMenu&&this.drawBuildMenu()}costText(t){const s=[];return t.wood&&s.push(`${t.wood}w`),t.stone&&s.push(`${t.stone}s`),t.food&&s.push(`${t.food}f`),s.join(" ")}win(){this.paused=!0,this.msg("You survived! Day 8 reached.","good"),alert("You survived to Day 8 ‚Äî victory!")}lose(){this.paused=!0,this.msg("HQ destroyed. Colony fell.","bad"),alert("Your HQ was destroyed. Game over.")}rebuildNavGrid(){mt(this.grid);for(const t of this.buildings)t.kind!=="hq"&&t.kind!=="path"&&t.kind!=="house"&&bt(this.grid,t.x,t.y,t.w,t.h),t.kind==="path"&&Mt(this.grid,t.x,t.y,t.w,t.h,.6)}computePath(t,s,o,e){return St(this.grid,t,s,o,e)}cellIndexAt(t,s){const o=Math.floor(t/u),e=Math.floor(s/u);return o<0||e<0||o>=this.grid.cols||e>=this.grid.rows?-1:e*this.grid.cols+o}isBlocked(t,s){const o=this.cellIndexAt(t,s);return o<0?!0:!!this.grid.solid[o]}isBlockedByResources(t,s,o){for(const e of this.trees){if(o&&e===o)continue;const l=t-e.x,a=s-e.y;if(l*l+a*a<=e.r*e.r)return!0}for(const e of this.rocks){if(o&&e===o)continue;const l=t-e.x,a=s-e.y;if(l*l+a*a<=e.r*e.r)return!0}return!1}bestApproachToCircle(t,s,o){let e=null,l=1/0;const a=16;for(let d=0;d<a;d++){const h=d/a*Math.PI*2,f=s.x-Math.cos(h)*(o-6),c=s.y-Math.sin(h)*(o-6);if(this.isBlocked(f,c)||this.isBlockedByResources(f,c,s))continue;const y=(t.x-f)*(t.x-f)+(t.y-c)*(t.y-c);y<l&&(l=y,e={x:f,y:c})}if(e)return Math.random()<.02&&console.log(`Approach point found: (${e.x.toFixed(1)}, ${e.y.toFixed(1)}) for resource at (${s.x.toFixed(1)}, ${s.y.toFixed(1)})`),e;const n=Math.atan2(s.y-t.y,s.x-t.x),r={x:s.x-Math.cos(n)*(o-6),y:s.y-Math.sin(n)*(o-6)};return Math.random()<.02&&console.log(`Using fallback approach point: (${r.x.toFixed(1)}, ${r.y.toFixed(1)}) for resource at (${s.x.toFixed(1)}, ${s.y.toFixed(1)})`),r}drawColonistProfile(t){const s=this.ctx,o=this.canvas.width,e=this.canvas.height,l=Math.min(this.scale(320),o*.4),a=Math.min(this.scale(200),e*.35),n=this.scale(12),r=o-l-n,d=this.scale(54),h=Math.min(d,e-a-n);s.save(),s.fillStyle="#0b1220cc",s.fillRect(r,h,l,a),s.strokeStyle="#1e293b",s.strokeRect(r+.5,h+.5,l-1,a-1);const f=this.scale(64),c=r+this.scale(18),y=h+this.scale(26);s.fillStyle="#0f172a",s.fillRect(c,y,f,f),s.strokeStyle="#1e293b",s.strokeRect(c+.5,y+.5,f-1,f-1),s.save(),s.translate(c+f/2,y+f/2+this.scale(4)),s.scale(this.uiScale*2,this.uiScale*2),at(s,0,0,10,"#93c5fd"),s.restore(),s.fillStyle="#dbeafe",s.font=this.getScaledFont(14,"600"),s.fillText("Colonist",r+f+this.scale(32),h+this.scale(22)),s.font=this.getScaledFont(13);const x=t.inside?"Resting":t.task?t.task:"Idle",S=Math.max(0,Math.min(100,t.hp|0)),k=Math.max(0,Math.min(100,(t.fatigue||0)|0)),m=Math.max(0,Math.min(100,(t.hunger||0)|0)),w=r+f+this.scale(32);let v=h+this.scale(45);const T=this.scale(24);this.barRow(w,v,"Health",S,"#22c55e"),v+=T,this.barRow(w,v,"Tiredness",k,"#eab308"),v+=T,this.barRow(w,v,"Hunger",m,"#f87171"),v+=T,s.fillStyle="#9fb3c8",s.fillText(`Task: ${x}`,w,v+this.scale(12)),v+=this.scale(18),s.fillText(`Pos: ${t.x|0}, ${t.y|0}`,w,v),v+=this.scale(18),s.fillText(this.follow?"Camera: Following (Esc to stop)":"Camera: Click colonist to follow",w,Math.min(v,h+a-this.scale(8))),s.restore()}barRow(t,s,o,e,l){const a=this.ctx;a.fillStyle="#dbeafe",a.fillText(o,t,s);const n=this.scale(140),r=this.scale(10),d=this.scale(70);a.fillStyle="#0f172a",a.fillRect(t+d,s-this.scale(8),n,r),a.strokeStyle="#1e293b",a.strokeRect(t+d+.5,s-this.scale(8)+.5,n-1,r-1),a.fillStyle=l,a.fillRect(t+d+this.scale(2),s-this.scale(6),Math.max(0,Math.min(n-this.scale(4),e/100*(n-this.scale(4)))),r-this.scale(4))}drawBuildMenu(){const t=this.ctx,s=this.canvas.width,o=this.canvas.height,e=Math.min(this.scale(760),s-this.scale(40)),l=Math.min(this.scale(520),o-this.scale(80)),a=(s-e)/2,n=(o-l)/2;t.save(),t.fillStyle="#0b1628dd",t.fillRect(a,n,e,l),t.strokeStyle="#1e293b",t.strokeRect(a+.5,n+.5,e-1,l-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(16,"600"),t.fillText("Build Menu (B to close)",a+this.scale(14),n+this.scale(24));const r=vt(A),d=Object.keys(r),h=this.scale(24),f=Math.floor((e-h)/Math.max(1,d.length));this.menuRects=[];let c=null;for(let S=0;S<d.length;S++){const k=a+this.scale(12)+S*f;let m=n+this.scale(44);const w=d[S];t.fillStyle="#93c5fd",t.font=this.getScaledFont(13,"600"),t.fillText(w,k,m),m+=this.scale(8);const v=r[w];for(const[T,M]of v){m+=this.scale(8);const R=this.scale(48),P=f-this.scale(18),b=k,B=m,W=this.mouse.x*this.DPR,H=this.mouse.y*this.DPR,F=W>=b&&W<=b+P&&H>=B&&H<=B+R;t.fillStyle=this.selectedBuild===T?"#102034":F?"#1a1f2e":"#0f172a",t.fillRect(b,B,P,R),t.strokeStyle=this.selectedBuild===T?"#4b9fff":F?"#3b82f6":"#1e293b",t.strokeRect(b+.5,B+.5,P-1,R-1),t.fillStyle="#dbeafe",t.font=this.getScaledFont(13,"600"),t.fillText(M.name,b+this.scale(8),B+this.scale(16));const D=this.costText(M.cost||{});t.fillStyle="#9fb3c8",t.font=this.getScaledFont(11);const O=Math.min(this.scale(80),t.measureText(D).width+this.scale(2));if(t.fillText(D,b+P-O,B+this.scale(16)),M.description){t.fillStyle="#94a3b8",t.font=this.getScaledFont(10);const j=P-this.scale(16);let z=M.description;for(;t.measureText(z).width>j&&z.length>10;)z=z.substring(0,z.length-4)+"...";t.fillText(z,b+this.scale(8),B+this.scale(32))}if(F&&M.description&&(c={key:T,desc:M.description}),this.menuRects.push({key:T,x:b,y:B,w:P,h:R}),m+=R,m>n+l-this.scale(60))break}}if(c){const S=this.scale(12),k=this.scale(300);t.font=this.getScaledFont(12);const m=this.wrapText(c.desc,k-S*2),w=this.scale(16),v=m.length*w+S*2,T=this.mouse.x*this.DPR,M=this.mouse.y*this.DPR;let R=T+this.scale(20),P=M-v-this.scale(10);R+k>s&&(R=T-k-this.scale(20)),P<0&&(P=M+this.scale(20)),t.fillStyle="#0f1419f0",t.fillRect(R,P,k,v),t.strokeStyle="#374151",t.strokeRect(R+.5,P+.5,k-1,v-1),t.fillStyle="#e5e7eb";for(let b=0;b<m.length;b++)t.fillText(m[b],R+S,P+S+(b+1)*w-this.scale(4))}t.fillStyle="#9fb3c8",t.font=this.getScaledFont(12);const y="Click a building to select ‚Ä¢ Hover for details ‚Ä¢ Press B to close",x=t.measureText(y).width;t.fillText(y,(s-x)/2,n+l+this.scale(20)),t.restore()}wrapText(t,s){const o=this.ctx,e=t.split(" "),l=[];let a="";for(const n of e){const r=a+(a?" ":"")+n;o.measureText(r).width<=s?a=r:(a&&l.push(a),a=n)}return a&&l.push(a),l}handleBuildMenuClick(){const t=this.mouse.x*this.DPR,s=this.mouse.y*this.DPR;for(const o of this.menuRects)if(t>=o.x&&t<=o.x+o.w&&s>=o.y&&s<=o.y+o.h){this.selectedBuild=o.key,this.showBuildMenu=!1,this.toast("Selected: "+A[o.key].name);return}this.showBuildMenu=!1}}const Lt=document.getElementById("game"),rt=document.getElementById("btnPause"),Nt=document.getElementById("btnHelp"),Gt=document.getElementById("btnNew"),G=document.getElementById("help");G&&(G.innerHTML=`
    <h2>How to play</h2>
    <div><b>Goal:</b> Gather wood & stone, build farms for food, add houses for pop cap; survive nightly raids with turrets/walls.</div>
  <div><b>Controls:</b> 1..9 quick-build, <b>B</b> build menu, LMB place, RMB cancel/erase; WASD pan; Space pause; H toggle help; +/- zoom; F fast-forward.</div>
  `);const q=new zt(Lt);rt.onclick=()=>{q.paused=!q.paused,rt.textContent=q.paused?"Resume":"Pause"};Gt.onclick=()=>{q.newGame()};Nt.onclick=()=>{G&&(G.hidden=!G.hidden)};Object.assign(window,{game:q,BUILD_TYPES:A});
