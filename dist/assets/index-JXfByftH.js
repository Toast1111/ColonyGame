var Ki=Object.defineProperty;var $i=(i,e,t)=>e in i?Ki(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var v=(i,e,t)=>$i(i,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();const ee=(i,e)=>Math.random()*(e-i)+i,_i=(i,e)=>Math.floor(ee(i,e)),te=(i,e,t)=>Math.max(e,Math.min(t,i)),re=(i,e)=>{const t=i.x-e.x,s=i.y-e.y;return t*t+s*s},es=i=>Math.hypot(i.x,i.y),ts=i=>{const e=es(i)||1;return{x:i.x/e,y:i.y/e}},is=(i,e)=>({x:i.x-e.x,y:i.y-e.y}),m=32,G={w:240*m,h:240*m},ne={x:G.w/2,y:G.h/2},Z={sky:"#0a0e14",ground:"#0e161f",colonist:"#c7f9cc",enemy:"#ff9aa2",tree:"#6fbf73",rock:"#9aa5b1",ghost:"#6ee7ff",wall:"#9aa5b1",bld:"#93c5fd",turret:"#93c5fd",farm:"#8bd3dd",house:"#e2b714",stock:"#c084fc",tent:"#f59e0b",bed:"#f8fafc"};var It=(i=>(i.GRASS="grass",i.DIRT="dirt",i.STONE="stone",i.SAND="sand",i.MUD="mud",i.SOFT_DIRT="soft_dirt",i.SHALLOW_WATER="shallow_water",i.DEEP_WATER="deep_water",i.ROCK="rock",i.SNOW="snow",i.ICE="ice",i.MARSH="marsh",i.GRAVEL="gravel",i))(It||{}),$=(i=>(i.NONE="none",i.BASIC_PATH="basic_path",i.STONE_ROAD="stone_road",i.WOODEN_FLOOR="wooden_floor",i.CONCRETE="concrete",i.METAL_FLOOR="metal_floor",i.CARPET="carpet",i))($||{});const Ri={grass:1,dirt:1,stone:1.1,sand:1.2,mud:2.5,soft_dirt:1.4,shallow_water:1.8,deep_water:999,rock:999,snow:1.3,ice:.9,marsh:2,gravel:1.05},ss={none:1,basic_path:.6,stone_road:.5,wooden_floor:.7,concrete:.55,metal_floor:.65,carpet:.85},Bt={none:{color:"transparent",renderLayer:1},basic_path:{color:"#9ca3af",pattern:"solid",renderLayer:1},stone_road:{color:"#6b7280",secondaryColor:"#5b6270",pattern:"noise",renderLayer:1},wooden_floor:{color:"#92400e",secondaryColor:"#a2500e",pattern:"stripes",renderLayer:1},concrete:{color:"#9ca3af",pattern:"solid",renderLayer:1},metal_floor:{color:"#71717a",secondaryColor:"#81818a",pattern:"stripes",renderLayer:1},carpet:{color:"#991b1b",pattern:"solid",renderLayer:1}};function ns(i,e){const t=i*e;return{cols:i,rows:e,terrain:new Uint8Array(t).fill(os("grass")),floors:new Uint8Array(t).fill(as("none"))}}function os(i){return Object.values(It).indexOf(i)}function Ti(i){return Object.values(It)[i]}function as(i){return Object.values($).indexOf(i)}function qe(i){return Object.values($)[i]}function Pi(i,e,t){const s=t*i.cols+e,n=Ti(i.terrain[s]),r=qe(i.floors[s]),o=Ri[n]||1,a=ss[r]||1;return o*a}function Ii(i,e,t){const s=t*i.cols+e,n=Ti(i.terrain[s]);return Ri[n]<100}function st(i,e,t,s){return Math.abs(i-t)+Math.abs(e-s)}function rs(){const i=Math.ceil(7680/m),e=Math.ceil(7680/m),t=i*e,s=32,n=Math.ceil(i/s),r=Math.ceil(e/s),o=n*r;return{cols:i,rows:e,solid:new Uint8Array(t),cost:new Float32Array(t).fill(1),minCost:1,sectionSize:s,sectionCols:n,sectionRows:r,dirtyFlags:new Uint8Array(o)}}function ls(i){i.solid.fill(0),i.cost.fill(1),i.minCost=1,i.dirtyFlags.fill(1)}function cs(i,e,t,s,n){if(i.terrainGrid)ds(i,e,t,s,n);else{const r=Math.min(i.cols,e+s),o=Math.min(i.rows,t+n);for(let c=t;c<o;c++)for(let f=e;f<r;f++){const u=c*i.cols+f;i.solid[u]=0,i.cost[u]=1}const a=Math.floor(e/i.sectionSize),l=Math.floor(t/i.sectionSize),d=Math.min(i.sectionCols-1,Math.floor((r-1)/i.sectionSize)),h=Math.min(i.sectionRows-1,Math.floor((o-1)/i.sectionSize));for(let c=l;c<=h;c++)for(let f=a;f<=d;f++){const u=c*i.sectionCols+f;i.dirtyFlags[u]=1}}}function Bi(i){if(!i.terrainGrid)return;const{cols:e,rows:t,terrainGrid:s}=i;let n=1/0;for(let r=0;r<t;r++)for(let o=0;o<e;o++){const a=r*e+o,l=Pi(s,o,r);i.cost[a]=l,l<n&&l>0&&(n=l),Ii(s,o,r)?i.solid[a]=0:i.solid[a]=1}i.minCost=n,i.dirtyFlags.fill(1)}function ds(i,e,t,s,n){if(!i.terrainGrid)return;const{cols:r,rows:o,terrainGrid:a}=i,l=Math.min(r,e+s),d=Math.min(o,t+n);for(let A=t;A<d;A++)for(let g=e;g<l;g++){const p=A*r+g,w=Pi(a,g,A);i.cost[p]=w,Ii(a,g,A)?i.solid[p]=0:i.solid[p]=1}const h=Math.floor(e/i.sectionSize),c=Math.floor(t/i.sectionSize),f=Math.min(i.sectionCols-1,Math.floor((l-1)/i.sectionSize)),u=Math.min(i.sectionRows-1,Math.floor((d-1)/i.sectionSize));for(let A=c;A<=u;A++)for(let g=h;g<=f;g++){const p=A*i.sectionCols+g;i.dirtyFlags[p]=1}}function Dt(i,e,t,s,n){const r=Math.floor(Math.floor(e/m)/i.sectionSize),o=Math.floor(Math.floor(t/m)/i.sectionSize),a=Math.floor(Math.floor((e+s-1)/m)/i.sectionSize),l=Math.floor(Math.floor((t+n-1)/m)/i.sectionSize);for(let d=Math.max(0,o);d<=Math.min(i.sectionRows-1,l);d++)for(let h=Math.max(0,r);h<=Math.min(i.sectionCols-1,a);h++){const c=d*i.sectionCols+h;i.dirtyFlags[c]=1}}function Di(i,e,t,s,n){const r=Math.floor(e/m),o=Math.floor(t/m),a=Math.floor((e+s-1)/m),l=Math.floor((t+n-1)/m);for(let d=o;d<=l;d++)for(let h=r;h<=a;h++)if(h>=0&&d>=0&&h<i.cols&&d<i.rows){const c=d*i.cols+h;i.solid[c]=1}Dt(i,e,t,s,n)}function nt(i,e,t,s){const n=Math.floor((e-s)/m),r=Math.floor((t-s)/m),o=Math.floor((e+s)/m),a=Math.floor((t+s)/m);for(let l=r;l<=a;l++)for(let d=n;d<=o;d++)if(d>=0&&l>=0&&d<i.cols&&l<i.rows){const h=d*m+m/2,c=l*m+m/2,f=h-e,u=c-t;if(f*f+u*u<=s*s){const A=l*i.cols+d;i.solid[A]=1}}Dt(i,e-s,t-s,s*2,s*2)}function hs(i,e,t,s,n,r){const o=Math.floor(e/m),a=Math.floor(t/m),l=Math.floor((e+s-1)/m),d=Math.floor((t+n-1)/m);for(let h=a;h<=d;h++)for(let c=o;c<=l;c++)if(c>=0&&h>=0&&c<i.cols&&h<i.rows){const f=h*i.cols+c;i.cost[f]=r,r<i.minCost&&(i.minCost=r)}Dt(i,e,t,s,n)}const Ei=.7,fs={BASIC_PATH:.6,FAST_ROAD:.5,SLOW_PATH:.7,GRASS:1,ROUGH_TERRAIN:1.5};function Ve(i,e){return i.cost[e]<=Ei}function Yt(i,e,t){const s=Math.floor(e/m),n=Math.floor(t/m);return s<0||n<0||s>=i.cols||n>=i.rows?!1:Ve(i,n*i.cols+s)}function Ge(i,e,t,s,n,r="BASIC_PATH"){const o=fs[r],a=Math.max(.5,Math.min(.7,o));hs(i,e,t,s,n,a)}function ut(i,e){return{gx:Math.floor(i/m),gy:Math.floor(e/m)}}function us(i,e){for(let t=0;t<e.length;t++){const s=Math.floor(e[t].x/m),n=Math.floor(e[t].y/m);if(s>=0&&n>=0&&s<i.cols&&n<i.rows){const r=n*i.cols+s;Ve(i,r)&&(e[t].x=s*m+m/2,e[t].y=n*m+m/2)}}}function gs(i,e,t,s){const n=ut(e.x,e.y),r=ut(t.x,t.y),o=ut(s.x,s.y),a=Math.sign(r.gx-n.gx),l=Math.sign(r.gy-n.gy),d=Math.sign(o.gx-r.gx),h=Math.sign(o.gy-r.gy),c=a!==0&&h!==0||l!==0&&d!==0,f=r.gy*i.cols+r.gx;return c&&f>=0&&f<i.cost.length&&Ve(i,f)}function Fi(i,e,t,s,n){const r=i.cols,o=i.rows,a={x:Math.floor(e/m),y:Math.floor(t/m)},l={x:Math.floor(s/m),y:Math.floor(n/m)},d=(S,T)=>T*r+S;if(a.x===l.x&&a.y===l.y)return[{x:s,y:n}];const h=d(a.x,a.y),c=d(l.x,l.y),f=(S,T)=>S>=0&&T>=0&&S<r&&T<o,u=(S,T)=>{if(!f(S,T))return!1;const D=d(S,T);return D===h||D===c?!0:i.solid[D]===0},A=new Int32Array(r*o).fill(-1),g=new Float32Array(r*o).fill(1/0),p=new Float32Array(r*o).fill(1/0),w=new Uint8Array(r*o),k=[],M=S=>{k.push(S)},x=()=>{let S=-1,T=1/0;for(let I=0;I<k.length;I++){const O=k[I];if(w[O])continue;const z=p[O];z<T&&(T=z,S=I)}return S===-1?-1:k.splice(S,1)[0]},C=Math.max(1e-4,i.minCost);g[h]=0,p[h]=st(a.x,a.y,l.x,l.y)*C,M(h);const b=[[1,0],[-1,0],[0,1],[0,-1]];for(;k.length;){const S=x();if(S===-1)break;if(w[S])continue;w[S]=1;const T=S%r,D=S/r|0;if(S===c){let I=[],O=S;for(;O!==-1;){const X=O%r,U=O/r|0;I.push({x:X*m+m/2,y:U*m+m/2}),O=A[O]}I.reverse(),I[I.length-1]={x:s,y:n};const z=[];for(let X=0;X<I.length-1;X++){const U=I[X],K=I[X+1];z.push(U);const ie=Math.floor(U.x/m),se=Math.floor(U.y/m),oe=Math.floor(K.x/m),ae=Math.floor(K.y/m),ue=se*r+ie,me=ae*r+oe,he=Ve(i,ue)&&Ve(i,me);if(!(he&&(se===ae||ie===oe)))if(he){const F=K.x-U.x,P=K.y-U.y,B=Math.hypot(F,P),E=Math.floor(B/18);for(let W=1;W<=E;W++){const L=W/(E+1);z.push({x:U.x+F*L,y:U.y+P*L})}}else{const F=K.x-U.x,P=K.y-U.y,B=Math.hypot(F,P),E=Math.floor(B/24);for(let W=1;W<=E;W++){const L=W/(E+1);z.push({x:U.x+F*L,y:U.y+P*L})}}}z.push(I[I.length-1]),I=z;const H=(X,U,K,ie)=>{const se=K-X,oe=ie-U,ae=Math.hypot(se,oe)||1,ue=Math.max(6,m*.33),me=Math.ceil(ae/ue);let he=0,y=0;for(let P=1;P<me;P++){const B=P/me,E=X+se*B,W=U+oe*B,L=Math.floor(E/m),V=Math.floor(W/m);if(L<0||V<0||L>=i.cols||V>=i.rows)return!1;const N=V*i.cols+L;if(i.solid[N])return!1;i.cost[N]<=Ei&&he++,y++}const R=Yt(i,X,U),F=Yt(i,K,ie);return R&&F&&y>0?he/y>=.6:!0},j=[];let Y=0;for(;Y<I.length;){j.push(I[Y]);let X=Y+2,U=Y+1;for(;X<I.length&&!gs(i,I[Y],I[Y+1],I[X]);)if(H(I[Y].x,I[Y].y,I[X].x,I[X].y))U=X,X++;else break;Y=U}return I=j.length>=2?j:I,us(i,I),I}for(const[I,O]of b){const z=T+I,H=D+O;if(!u(z,H))continue;const j=H*r+z,Y=i.cost[j]||1,X=g[S]+Y;if(X<g[j]){A[j]=S,g[j]=X;const U=st(z,H,l.x,l.y)*Math.max(1e-4,i.minCost)*.9999;p[j]=X+U,M(j)}}}return null}function As(i,e,t,s,n,r){const{cols:o,rows:a}=i,l={x:Math.floor(e/m),y:Math.floor(t/m)},d={x:Math.floor(s/m),y:Math.floor(n/m)};if(l.x<0||l.y<0||l.x>=o||l.y>=a||d.x<0||d.y<0||d.x>=o||d.y>=a)return null;const h=l.y*o+l.x,c=d.y*o+d.x;if(h===c||i.solid[h]||i.solid[c]||r&&r.isEnabled&&r.isEnabled()&&!r.isReachable(e,t,s,n))return null;const f=new Float32Array(o*a).fill(1/0),u=new Float32Array(o*a).fill(1/0),A=new Int32Array(o*a).fill(-1),g=new Uint8Array(o*a),p=[];f[h]=0,u[h]=st(l.x,l.y,d.x,d.y),p.push(h);const w=C=>{p.push(C);let b=p.length-1;for(;b>0;){const S=b-1>>1;if(u[p[S]]<=u[p[b]])break;const T=p[S];p[S]=p[b],p[b]=T,b=S}},k=()=>{if(!p.length)return-1;const C=p[0],b=p.pop();if(p.length>0){p[0]=b;let S=0;for(;;){const T=(S<<1)+1,D=(S<<1)+2;let I=S;if(T<p.length&&u[p[T]]<u[p[I]]&&(I=T),D<p.length&&u[p[D]]<u[p[I]]&&(I=D),I===S)break;const O=p[S];p[S]=p[I],p[I]=O,S=I}}return C},M=(C,b)=>C<0||b<0||C>=o||b>=a?!1:!i.solid[b*o+C],x=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]];for(;p.length;){const C=k();if(C===-1)break;if(g[C])continue;g[C]=1;const b=C%o,S=C/o|0;if(C===c){const T=[];let D=C;for(;D!==-1;){const I=D%o,O=D/o|0;T.push({x:I*m+m/2,y:O*m+m/2}),D=A[D]}return T.reverse(),T.length>1&&Math.hypot(T[0].x-e,T[0].y-t)<m*.3&&T.shift(),T.length>0?T:null}for(const[T,D]of x){const I=b+T,O=S+D;if(!M(I,O)||T!==0&&D!==0&&!M(b+T,S)&&!M(b,S+D))continue;const z=O*o+I,Y=(T!==0&&D!==0?1.414:1)*(i.cost[z]||1),X=f[C]+Y;if(X<f[z]){A[z]=C,f[z]=X;const U=st(I,O,d.x,d.y)*Math.max(1e-4,i.minCost)*.9999;u[z]=X+U,w(z)}}}return null}function qt(i){let e=0;return i.edge===0||i.edge===2?e=i.x*1e5+i.span*10+(i.edge===0?0:2):e=i.y*1e5+i.span*10+(i.edge===1?1:3),e}function de(i,e,t){return e*t+i}function Ae(i,e,t,s){return i>=0&&e>=0&&i<t&&e<s}function gt(i,e,t,s){return i===0||e===0||i===t-1||e===s-1}function $e(i,e){return[{x:i,y:e-1,edge:0},{x:i+1,y:e,edge:1},{x:i,y:e+1,edge:2},{x:i-1,y:e,edge:3}]}function At(i){return{id:i,cells:new Set,neighbors:new Set,links:[],roomId:null,touchesMapEdge:!1,objects:{buildings:new Set,trees:new Set,rocks:new Set},valid:!0,isExternal:!1}}function ps(i){return{id:i,regions:new Set,isPrison:!1,isOutdoors:!0,touchesMapEdge:!1}}class ms{constructor(e,t){v(this,"regionIds");v(this,"cols");v(this,"rows");this.cols=e,this.rows=t,this.regionIds=new Int32Array(e*t).fill(-1)}get(e,t){return Ae(e,t,this.cols,this.rows)?this.regionIds[de(e,t,this.cols)]:-1}set(e,t,s){Ae(e,t,this.cols,this.rows)&&(this.regionIds[de(e,t,this.cols)]=s)}clear(){this.regionIds.fill(-1)}}class ys{constructor(e){v(this,"navGrid");v(this,"regionGrid");v(this,"regions");v(this,"rooms");v(this,"nextRegionId");v(this,"nextRoomId");v(this,"linkHashIndex");v(this,"doorPositions");this.navGrid=e,this.regionGrid=new ms(e.cols,e.rows),this.regions=new Map,this.rooms=new Map,this.nextRegionId=0,this.nextRoomId=0,this.linkHashIndex=new Map,this.doorPositions=new Set}buildAll(e){console.log("[RegionBuilder] Building all regions...");const t=performance.now();if(this.clear(),e)for(const n of e){const r=Math.floor(n.x/m),o=Math.floor(n.y/m),a=de(r,o,this.navGrid.cols);this.doorPositions.add(a)}for(const n of this.doorPositions){const r=n%this.navGrid.cols,o=Math.floor(n/this.navGrid.cols);if(this.navGrid.solid[n]===1)continue;const a=this.nextRegionId++,l=At(a);l.cells.add(n),this.regionGrid.set(r,o,a),gt(r,o,this.navGrid.cols,this.navGrid.rows)&&(l.touchesMapEdge=!0),this.regions.set(a,l)}for(let n=0;n<this.navGrid.rows;n++)for(let r=0;r<this.navGrid.cols;r++){const o=de(r,n,this.navGrid.cols);this.regionGrid.regionIds[o]===-1&&this.navGrid.solid[o]!==1&&(this.doorPositions.has(o)||this.floodFillRegion(r,n))}this.detectAllLinks(),this.buildRooms();const s=performance.now()-t;console.log(`[RegionBuilder] Built ${this.regions.size} regions and ${this.rooms.size} rooms in ${s.toFixed(2)}ms`)}rebuildArea(e,t,s,n,r){if(console.log(`[RegionBuilder] Rebuilding area (${e},${t}) to (${s},${n})`),this.doorPositions.clear(),r)for(const a of r){const l=Math.floor(a.x/m),d=Math.floor(a.y/m),h=de(l,d,this.navGrid.cols);this.doorPositions.add(h)}const o=new Set;for(let a=t;a<=n;a++)for(let l=e;l<=s;l++){if(!Ae(l,a,this.navGrid.cols,this.navGrid.rows))continue;const d=this.regionGrid.get(l,a);d>=0&&o.add(d)}for(const a of o)this.deleteRegion(a);for(let a=t;a<=n;a++)for(let l=e;l<=s;l++){if(!Ae(l,a,this.navGrid.cols,this.navGrid.rows))continue;const d=de(l,a,this.navGrid.cols);if(!this.doorPositions.has(d)||this.regionGrid.regionIds[d]!==-1||this.navGrid.solid[d]===1)continue;const h=this.nextRegionId++,c=At(h);c.cells.add(d),this.regionGrid.set(l,a,h),gt(l,a,this.navGrid.cols,this.navGrid.rows)&&(c.touchesMapEdge=!0),this.regions.set(h,c)}for(let a=t;a<=n;a++)for(let l=e;l<=s;l++){if(!Ae(l,a,this.navGrid.cols,this.navGrid.rows))continue;const d=de(l,a,this.navGrid.cols);this.regionGrid.regionIds[d]===-1&&this.navGrid.solid[d]!==1&&(this.doorPositions.has(d)||this.floodFillRegion(l,a))}this.detectLinksInArea(e-1,t-1,s+1,n+1),this.buildRooms()}floodFillRegion(e,t){const s=this.nextRegionId++,n=At(s),r=[{x:e,y:t}],o=new Set;for(;r.length>0;){const{x:a,y:l}=r.shift(),d=de(a,l,this.navGrid.cols);if(!o.has(d)&&(o.add(d),!!Ae(a,l,this.navGrid.cols,this.navGrid.rows)&&this.navGrid.solid[d]!==1&&!(this.regionGrid.regionIds[d]>=0)&&!this.doorPositions.has(d))){n.cells.add(d),this.regionGrid.set(a,l,s),gt(a,l,this.navGrid.cols,this.navGrid.rows)&&(n.touchesMapEdge=!0);for(const{x:h,y:c}of $e(a,l)){const f=de(h,c,this.navGrid.cols);o.has(f)||r.push({x:h,y:c})}}}n.cells.size>0&&this.regions.set(s,n)}detectAllLinks(){this.linkHashIndex.clear();for(const e of this.regions.values())this.detectLinksForRegion(e)}detectLinksForRegion(e){e.links=[],e.neighbors.clear();const t=this.findEdgeCells(e),s=this.extractLinks(t,e.id);for(const n of s){e.links.push(n);const r=qt(n),o=this.linkHashIndex.get(r);if(o&&o.regionId!==e.id){e.neighbors.add(o.regionId);const a=this.regions.get(o.regionId);a&&a.neighbors.add(e.id)}this.linkHashIndex.set(r,{...n,regionId:e.id})}}findEdgeCells(e){const t=new Set;for(const s of e.cells){const n=s%this.navGrid.cols,r=Math.floor(s/this.navGrid.cols);for(const{x:o,y:a}of $e(n,r)){if(!Ae(o,a,this.navGrid.cols,this.navGrid.rows)){t.add(s);break}const l=de(o,a,this.navGrid.cols);if(this.regionGrid.regionIds[l]!==e.id){t.add(s);break}}}return t}extractLinks(e,t){const s=[],n=new Set;for(const r of e){if(n.has(r))continue;const o=r%this.navGrid.cols,a=Math.floor(r/this.navGrid.cols);for(const{x:l,y:d,edge:h}of $e(o,a)){if(!Ae(l,d,this.navGrid.cols,this.navGrid.rows))continue;const c=de(l,d,this.navGrid.cols);if(this.regionGrid.regionIds[c]===t||this.navGrid.solid[c]===1)continue;const u=this.traceLink(o,a,h,e,n);u&&s.push(u)}}return s}traceLink(e,t,s,n,r){const o={span:0,edge:s,x:e,y:t};let a=0,l=0;s===0||s===2?a=1:l=1;let d=e,h=t;for(;;){const c=de(d,h,this.navGrid.cols);if(!n.has(c))break;const u=$e(d,h).find(g=>g.edge===s);if(!u)break;const A=de(u.x,u.y,this.navGrid.cols);if(!Ae(u.x,u.y,this.navGrid.cols,this.navGrid.rows)||this.navGrid.solid[A]===1||(o.span++,r.add(c),d+=a,h+=l,!Ae(d,h,this.navGrid.cols,this.navGrid.rows)))break}return o.span>0?o:null}detectLinksInArea(e,t,s,n){const r=new Set;for(let o=Math.max(0,t);o<=Math.min(this.navGrid.rows-1,n);o++)for(let a=Math.max(0,e);a<=Math.min(this.navGrid.cols-1,s);a++){const l=this.regionGrid.get(a,o);l>=0&&r.add(l)}for(const o of r){const a=this.regions.get(o);a&&this.detectLinksForRegion(a)}}buildRooms(){this.rooms.clear(),this.nextRoomId=0;for(const t of this.regions.values())t.roomId=null;const e=new Set;for(const t of this.regions.values()){if(e.has(t.id))continue;const s=this.nextRoomId++,n=ps(s),r=[t.id];for(;r.length>0;){const o=r.shift();if(e.has(o))continue;e.add(o);const a=this.regions.get(o);if(a){a.roomId=s,n.regions.add(o),a.touchesMapEdge&&(n.touchesMapEdge=!0);for(const l of a.neighbors)e.has(l)||r.push(l)}}this.rooms.set(s,n)}}deleteRegion(e){const t=this.regions.get(e);if(t){for(const s of t.cells)this.regionGrid.regionIds[s]=-1;for(const s of t.neighbors){const n=this.regions.get(s);n&&n.neighbors.delete(e)}for(const s of t.links){const n=qt(s);this.linkHashIndex.delete(n)}t.valid=!1,this.regions.delete(e)}}clear(){this.regions.clear(),this.rooms.clear(),this.regionGrid.clear(),this.linkHashIndex.clear(),this.doorPositions.clear(),this.nextRegionId=0,this.nextRoomId=0}getRegions(){return this.regions}getRooms(){return this.rooms}getRegionGrid(){return this.regionGrid}getRegionAt(e,t){const s=this.regionGrid.get(e,t);return s>=0&&this.regions.get(s)||null}}class bs{constructor(e,t){v(this,"regions");v(this,"rooms");this.regions=e,this.rooms=t}findNearestBuilding(e,t,s,n,r=10){const o=new Set,a=[{regionId:e,depth:0}];let l=null,d=1/0;for(;a.length>0;){const{regionId:h,depth:c}=a.shift();if(o.has(h)||c>r)continue;o.add(h);const f=this.regions.get(h);if(!(!f||!f.valid)){for(const u of f.objects.buildings){if(!n(u))continue;const A=u.x+u.w/2,g=u.y+u.h/2,p=Math.hypot(t-A,s-g);p<d&&(d=p,l={object:u,distance:p,region:f})}if(l&&c>0&&d<this.estimateMinDistToNextRegion(f))break;for(const u of f.neighbors)o.has(u)||a.push({regionId:u,depth:c+1})}}return l}findBuildingsInRange(e,t,s,n,r,o=10){const a=[],l=new Set,d=[{regionId:e,depth:0}];for(;d.length>0;){const{regionId:h,depth:c}=d.shift();if(l.has(h)||c>o)continue;l.add(h);const f=this.regions.get(h);if(!(!f||!f.valid)){for(const u of f.objects.buildings){if(!r(u))continue;const A=u.x+u.w/2,g=u.y+u.h/2,p=Math.hypot(t-A,s-g);p<=n&&a.push({object:u,distance:p,region:f})}for(const u of f.neighbors)l.has(u)||d.push({regionId:u,depth:c+1})}}return a.sort((h,c)=>h.distance-c.distance)}findNearestTree(e,t,s,n,r=10){const o=new Set,a=[{regionId:e,depth:0}];let l=null,d=1/0;for(;a.length>0;){const{regionId:h,depth:c}=a.shift();if(o.has(h)||c>r)continue;o.add(h);const f=this.regions.get(h);if(!(!f||!f.valid)){for(const u of f.objects.trees){const A=n[u];if(!A||A.hp<=0)continue;const g=Math.hypot(t-A.x,s-A.y);g<d&&(d=g,l={object:A,distance:g,region:f})}if(l&&c>0&&d<this.estimateMinDistToNextRegion(f))break;for(const u of f.neighbors)o.has(u)||a.push({regionId:u,depth:c+1})}}return l}findNearestRock(e,t,s,n,r=10){const o=new Set,a=[{regionId:e,depth:0}];let l=null,d=1/0;for(;a.length>0;){const{regionId:h,depth:c}=a.shift();if(o.has(h)||c>r)continue;o.add(h);const f=this.regions.get(h);if(!(!f||!f.valid)){for(const u of f.objects.rocks){const A=n[u];if(!A||A.hp<=0)continue;const g=Math.hypot(t-A.x,s-A.y);g<d&&(d=g,l={object:A,distance:g,region:f})}if(l&&c>0&&d<this.estimateMinDistToNextRegion(f))break;for(const u of f.neighbors)o.has(u)||a.push({regionId:u,depth:c+1})}}return l}inSameRoom(e,t){const s=this.regions.get(e),n=this.regions.get(t);return!s||!n||s.roomId===null||n.roomId===null?!1:s.roomId===n.roomId}isReachable(e,t,s=50){if(e===t)return!0;const n=new Set,r=[{regionId:e,depth:0}];for(;r.length>0;){const{regionId:o,depth:a}=r.shift();if(o===t)return!0;if(n.has(o)||a>s)continue;n.add(o);const l=this.regions.get(o);if(!(!l||!l.valid))for(const d of l.neighbors)n.has(d)||r.push({regionId:d,depth:a+1})}return!1}estimateMinDistToNextRegion(e){return Math.sqrt(e.cells.size)*m*.5}getRoomForRegion(e){const t=this.regions.get(e);return!t||t.roomId===null?null:this.rooms.get(t.roomId)||null}}class ws{constructor(e){v(this,"builder");v(this,"objectFinder");v(this,"navGrid");v(this,"enabled");this.navGrid=e,this.builder=new ys(e),this.objectFinder=new bs(this.builder.getRegions(),this.builder.getRooms()),this.enabled=!1}initialize(e){console.log("[RegionManager] Initializing region system...");const t=e?e.filter(s=>s.kind==="door"&&s.done):[];this.builder.buildAll(t),this.enabled=!0}onBuildingsChanged(e){if(!this.enabled)return;console.log("[RegionManager] Buildings changed, rebuilding regions...");const t=e.filter(s=>s.kind==="door"&&s.done);this.builder.buildAll(t),this.updateObjectCaches(e,[],[])}updateArea(e,t,s,n,r){if(!this.enabled)return;const o=Math.floor(e/m),a=Math.floor(t/m),l=Math.floor((e+s)/m),d=Math.floor((t+n)/m),h=r?r.filter(c=>c.kind==="door"&&c.done):[];this.builder.rebuildArea(o,a,l,d,h)}rebuildArea(e,t,s,n,r){if(!this.enabled)return;const o=r?r.filter(a=>a.kind==="door"&&a.done):[];this.builder.rebuildArea(e,t,s,n,o)}updateObjectCaches(e,t,s){if(!this.enabled)return;const n=this.builder.getRegions(),r=this.builder.getRegionGrid();for(const o of n.values())o.objects.buildings.clear(),o.objects.trees.clear(),o.objects.rocks.clear();for(const o of e){const a=new Set,l=Math.floor(o.x/m),d=Math.floor(o.y/m),h=Math.floor((o.x+o.w)/m),c=Math.floor((o.y+o.h)/m);for(let f=d;f<=c;f++)for(let u=l;u<=h;u++){const A=r.get(u,f);A>=0&&a.add(A)}for(const f of a){const u=n.get(f);u&&u.objects.buildings.add(o)}}for(let o=0;o<t.length;o++){const a=t[o];if(a.hp<=0)continue;const l=Math.floor(a.x/m),d=Math.floor(a.y/m),h=r.get(l,d);if(h>=0){const c=n.get(h);c&&c.objects.trees.add(o)}}for(let o=0;o<s.length;o++){const a=s[o];if(a.hp<=0)continue;const l=Math.floor(a.x/m),d=Math.floor(a.y/m),h=r.get(l,d);if(h>=0){const c=n.get(h);c&&c.objects.rocks.add(o)}}}getRegionIdAt(e,t){const s=Math.floor(e/m),n=Math.floor(t/m);return this.builder.getRegionGrid().get(s,n)}getRegionAt(e,t){const s=Math.floor(e/m),n=Math.floor(t/m);return this.builder.getRegionAt(s,n)}findNearestBuilding(e,t,s){const n=this.getRegionIdAt(e,t);if(n<0)return null;const r=this.objectFinder.findNearestBuilding(n,e,t,s);return r?r.object:null}findNearestTree(e,t,s){const n=this.getRegionIdAt(e,t);if(n<0)return null;const r=this.objectFinder.findNearestTree(n,e,t,s);return r?r.object:null}findNearestRock(e,t,s){const n=this.getRegionIdAt(e,t);if(n<0)return null;const r=this.objectFinder.findNearestRock(n,e,t,s);return r?r.object:null}isReachable(e,t,s,n){const r=this.getRegionIdAt(e,t),o=this.getRegionIdAt(s,n);return r<0||o<0?!1:this.objectFinder.isReachable(r,o)}inSameRoom(e,t,s,n){const r=this.getRegionIdAt(e,t),o=this.getRegionIdAt(s,n);return r<0||o<0?!1:this.objectFinder.inSameRoom(r,o)}getRegions(){return this.builder.getRegions()}getRooms(){return this.builder.getRooms()}getStats(){const e=this.builder.getRegions(),t=this.builder.getRooms();let s=0;for(const r of e.values())s+=r.cells.size;let n=0;for(const r of t.values())n+=r.regions.size;return{regionCount:e.size,roomCount:t.size,avgRegionSize:e.size>0?s/e.size:0,avgRoomSize:t.size>0?n/t.size:0}}isEnabled(){return this.enabled}setEnabled(e){this.enabled=e,e&&this.builder.getRegions().size===0&&this.initialize()}}function Li(i,e){i.inventory||(i.inventory={items:[],capacity:e})}function Wi(i){switch(i){case"pantry":return 10;case"farm":return 5;case"warehouse":return 20;case"stock":return 15;case"hq":return 30;case"stove":return 3;default:return 0}}function vs(i){return["pantry","farm","warehouse","stock","hq","stove"].includes(i)}function Ue(i,e,t){if(!i.inventory){const r=Wi(i.kind);if(r===0)return 0;Li(i,r)}const s=i.inventory;let n=s.items.find(r=>r.type===e);if(n){const r=n.maxStack||Ut(e),o=Math.min(t,r-n.quantity);return n.quantity+=o,o}else{if(s.items.length>=s.capacity)return 0;const r=Ut(e),o=Math.min(t,r);return s.items.push({type:e,quantity:o,maxStack:r}),o}}function pt(i,e,t){if(!i.inventory)return 0;const s=i.inventory,n=s.items.findIndex(a=>a.type===e);if(n===-1)return 0;const r=s.items[n],o=Math.min(t,r.quantity);return r.quantity-=o,r.quantity<=0&&s.items.splice(n,1),o}function Oe(i,e){if(!i.inventory)return 0;const t=i.inventory.items.find(s=>s.type===e);return t?t.quantity:0}function Ms(i){return i.inventory?i.inventory.items.reduce((e,t)=>e+t.quantity,0):0}function Ut(i){switch(i){case"wood":return 75;case"stone":return 75;case"food":return 50;case"wheat":return 100;case"bread":return 50;case"medicine":return 20;case"herbal":return 30;default:return 50}}function ks(i){return{wood:"Wood",stone:"Stone",food:"Food",wheat:"Wheat",bread:"Bread",medicine:"Medicine",herbal:"Herbal Medicine"}[i]||i}function xs(i){return{wood:"🪵",stone:"🪨",food:"🍎",wheat:"🌾",bread:"🍞",medicine:"💊",herbal:"🌿"}[i]||"📦"}const J={house:{category:"Housing",name:"House",description:"Provides shelter for 2 colonists. Colonists can rest inside to recover fatigue.",key:"1",cost:{wood:20,stone:5},hp:220,size:{w:2,h:2},build:100,color:Z.house,popCap:2},farm:{category:"Production",name:"Farm",description:"Grows crops that colonists can harvest for food. Takes 2 days to grow.",key:"2",cost:{wood:15},hp:120,size:{w:2,h:2},build:80,color:Z.farm,growTime:1},turret:{category:"Defense",name:"Turret",description:"Automated defense structure. Shoots at enemies within range.",key:"3",cost:{wood:5,stone:20},hp:160,size:{w:1,h:1},build:120,color:Z.turret,range:190,fireRate:.6,dps:30},wall:{category:"Defense",name:"Wall",description:"Blocks enemy movement. Essential for creating defensive perimeters.",key:"4",cost:{wood:0,stone:1},hp:150,size:{w:1,h:1},build:40,color:Z.wall},stock:{category:"Utility",name:"Stockpile",description:"Increases resource storage capacity by 100. Colonists will store materials here.",key:"5",cost:{wood:10},hp:140,size:{w:2,h:2},build:60,color:Z.stock,storageBonus:100},tent:{category:"Utility",name:"Recruit Tent",description:"Attracts new colonists every 60 seconds. Requires 15 food per recruit.",key:"6",cost:{wood:30,food:10},hp:140,size:{w:2,h:2},build:80,color:Z.tent},warehouse:{category:"Utility",name:"Warehouse",description:"Large storage facility. Increases resource capacity by 300.",key:"7",cost:{wood:40,stone:20},hp:260,size:{w:3,h:2},build:160,color:Z.stock,storageBonus:300},well:{category:"Production",name:"Well",description:"Provides clean water. Colonists can collect water here for food production.",key:"8",cost:{stone:25},hp:160,size:{w:1,h:1},build:80,color:Z.farm},infirmary:{category:"Utility",name:"Infirmary",description:"Heals injured colonists within range. Essential for colony survival.",key:"9",cost:{wood:30,stone:20,food:10},hp:200,size:{w:2,h:2},build:140,color:Z.bld,healRate:3,healRange:140,popCap:2},floor_path:{category:"Flooring",name:"Dirt Path",description:"Basic path that speeds up movement. Costs nothing but provides modest speed boost.",key:"0",cost:{wood:0},hp:1,size:{w:1,h:1},build:3,color:"#9ca3af",isFloor:!0,floorType:"BASIC_PATH"},floor_stone_road:{category:"Flooring",name:"Stone Road",description:"Premium paved road. Fast movement speed, very durable. Great for high-traffic areas.",key:"9",cost:{stone:2},hp:1,size:{w:1,h:1},build:8,color:"#6b7280",isFloor:!0,floorType:"STONE_ROAD"},floor_wooden:{category:"Flooring",name:"Wooden Floor",description:"Interior flooring. Comfortable and attractive, provides minor speed bonus.",key:"8",cost:{wood:3},hp:1,size:{w:1,h:1},build:5,color:"#92400e",isFloor:!0,floorType:"WOODEN_FLOOR"},bed:{category:"Furniture",name:"Bed",description:"Gives a colonist a comfortable spot to sleep. Restores fatigue faster than the ground.",key:"B",cost:{wood:12},hp:80,size:{w:1,h:2},build:40,color:Z.bed,popCap:1},door:{category:"Defense",name:"Door",description:"Allows colonists to pass while blocking enemies. Must be opened before passing through.",key:"D",cost:{wood:5},hp:100,size:{w:1,h:1},build:30,color:"#8b4513"},stove:{category:"Furniture",name:"Stove",description:"Used for cooking wheat into bread. Colonists bring wheat here and cook it over time.",key:"S",cost:{wood:20,stone:10},hp:150,size:{w:2,h:1},build:60,color:"#cd5c5c"},pantry:{category:"Furniture",name:"Pantry",description:"Stores prepared food (bread). Colonists can retrieve meals when hungry.",key:"P",cost:{wood:10,stone:10},hp:120,size:{w:2,h:2},build:50,color:"#daa520"}};function Fe(i,e){if(!e)return!0;for(const t of Object.keys(e))if((i[t]||0)<(e[t]||0))return!1;return!0}function ot(i,e){if(e)for(const t of Object.keys(e))i[t]-=e[t]||0}function Ye(i,e,t){const s=J[i],n=Math.floor(e/m)*m,r=Math.floor(t/m)*m,o={kind:i,...s,x:n,y:r,w:s.size.w*m,h:s.size.h*m,hp:s.hp,buildLeft:s.build,done:!1,growth:0,ready:!1,cooldown:0,...i==="bed"?{isMedicalBed:!1}:{}};if(vs(i)){const a=Wi(i);Li(o,a)}return o}function Ss(i){const e={};for(const t of Object.keys(i)){const s=i[t],n=s.category||"Other";(e[n]||(e[n]=[])).push([t,s])}for(const t of Object.keys(e))e[t].sort((s,n)=>s[1].name.localeCompare(n[1].name));return e}const Cs=(()=>{const i=[];for(let e=1;e<=20;e++){const t=100+Math.pow(e,1.6)*40;i[e]=Math.round(t)}return i})();function Rs(){const i=["Medicine","Construction","Shooting","Melee","Plants","Mining","Crafting","Social","Cooking","Research"],e={};for(const t of i)e[t]={name:t,level:0,xp:0,passion:"none"};return{byName:e,xpMultiplier:1}}function Ts(i){for(const e of Object.values(i.byName)){const t=Math.random();t>.95?e.level=8+Math.floor(Math.random()*4):t>.75?e.level=4+Math.floor(Math.random()*3):e.level=Math.floor(Math.random()*3);const s=Math.random();s>.9?e.passion="burning":s>.65?e.passion="interested":e.passion="none"}}function Ps(i,e){return i.skills?i.skills.byName[e]:null}function fe(i,e,t,s){if(!i.skills)return;const n=i.skills.byName[e];if(!n)return;let r=t;if(n.passion==="interested"?r*=1.5:n.passion==="burning"&&(r*=2),i.skills.xpMultiplier&&(r*=i.skills.xpMultiplier),n.xp+=r,n.lastUsed=s,n.xpDeltas||(n.xpDeltas=[]),s!=null){n.xpDeltas.push({t:s,amount:r});const o=s-5;o>0&&(n.xpDeltas=n.xpDeltas.filter(a=>a.t>=o)),n.xpDeltas.length>64&&n.xpDeltas.splice(0,n.xpDeltas.length-64)}for(;n.level<20;){const o=Cs[n.level+1];if(n.xp>=o)n.xp-=o,n.level++;else break}}function we(i,e){var t;return((t=Ps(i,e))==null?void 0:t.level)??0}function _e(i){return .6+Math.pow(i,.9)*.06}const Is=[{type:"head",label:"Head",maxHp:40,currentHp:40,coverage:.08,vital:!0,efficiency:1},{type:"torso",label:"Torso",maxHp:80,currentHp:80,coverage:.4,vital:!0,efficiency:1},{type:"left_arm",label:"Left Arm",maxHp:30,currentHp:30,coverage:.12,vital:!1,efficiency:1},{type:"right_arm",label:"Right Arm",maxHp:30,currentHp:30,coverage:.12,vital:!1,efficiency:1},{type:"left_leg",label:"Left Leg",maxHp:35,currentHp:35,coverage:.14,vital:!1,efficiency:1},{type:"right_leg",label:"Right Leg",maxHp:35,currentHp:35,coverage:.14,vital:!1,efficiency:1}];function He(i){i.health||(i.health={bodyParts:Is.map(e=>({...e})),injuries:[],totalPain:0,bloodLevel:1,consciousness:1,mobility:1,manipulation:1,immunity:1,lastBleedCalcTime:0,lastInfectionTick:0})}function Et(i){if(i.bodyParts.length===0)return 0;const e=i.bodyParts.reduce((s,n)=>s+n.maxHp,0),t=i.bodyParts.reduce((s,n)=>s+n.currentHp,0);return Math.max(0,Math.min(100,t/e*100))}function ht(i){i.totalPain=Math.min(1,i.injuries.reduce((d,h)=>d+h.pain,0)),i.injuries.reduce((d,h)=>d+(h.bandaged?h.bleeding*.15:h.bleeding),0);const e=i.bodyParts.find(d=>d.type==="head"),t=e?e.efficiency:1;i.consciousness=Math.max(.1,t*(1-i.totalPain*.5)*Math.sqrt(i.bloodLevel));const s=i.bodyParts.find(d=>d.type==="left_leg"),n=i.bodyParts.find(d=>d.type==="right_leg"),r=(((s==null?void 0:s.efficiency)||0)+((n==null?void 0:n.efficiency)||0))/2;i.mobility=Math.max(.1,r*(1-i.totalPain*.3)*i.consciousness);const o=i.bodyParts.find(d=>d.type==="left_arm"),a=i.bodyParts.find(d=>d.type==="right_arm"),l=(((o==null?void 0:o.efficiency)||0)+((a==null?void 0:a.efficiency)||0))/2;i.manipulation=Math.max(.1,l*(1-i.totalPain*.2)*i.consciousness);for(const d of i.bodyParts){const h=d.currentHp/d.maxHp;d.efficiency=Math.max(0,Math.min(1,h))}}function Bs(i){const e=i.bodyParts.reduce((s,n)=>s+n.coverage,0);let t=Math.random()*e;for(const s of i.bodyParts)if(t-=s.coverage,t<=0)return s;return i.bodyParts.find(s=>s.type==="torso")||i.bodyParts[0]}function Ds(i,e,t,s){const n=`${i}_${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;let r=0,o=0,a=1,l=0,d="";switch(i){case"cut":r=.2,o=.1,a=2,l=.1,d=`Cut on ${e.replace("_"," ")}`;break;case"bruise":r=.1,o=0,a=3,l=0,d=`Bruise on ${e.replace("_"," ")}`;break;case"burn":r=.4,o=.05,a=.5,l=.2,d=`Burn on ${e.replace("_"," ")}`;break;case"gunshot":r=.6,o=.3,a=1,l=.15,d=`Gunshot wound on ${e.replace("_"," ")}`;break;case"fracture":r=.5,o=0,a=.2,l=0,d=`Fractured ${e.replace("_"," ")}`;break;default:d=`${i} on ${e.replace("_"," ")}`}return{id:n,type:i,bodyPart:e,severity:Math.max(0,Math.min(1,t)),pain:r*t,bleeding:o*t,healRate:a,permanent:t>.8&&(i==="burn"||i==="fracture"),timeCreated:s,description:d,infected:!1,infectionChance:l*t,bandaged:!1,infectionProgress:0}}function Es(i,e,t,s="cut",n){const r=i.bodyParts.find(a=>a.type===e);if(!r)return!1;r.currentHp=Math.max(0,r.currentHp-t);const o=Math.min(1,t/r.maxHp);if(o>.1){const a=Ds(s,e,o,n);i.injuries.push(a)}return ht(i),!!(r.vital&&r.currentHp<=0)}function Qt(i,e,t,s="cut",n={}){if(!e.alive)return{died:!1,bodyPart:"torso",fatal:!1};if(e.godmode)return{died:!1,bodyPart:"torso",fatal:!1};He(e);const r=e.health,o=n.bodyPart?r.bodyParts.find(d=>d.type===n.bodyPart):Bs(r),a=Math.max(0,t*(n.damageMultiplier??1));return Es(r,o.type,a,s,performance.now())?(jt(i,e,`Destroyed vital ${o.label}`),{died:!0,bodyPart:o.type,fatal:!0,cause:"vital_part"}):(e.hp=Et(r),r.bloodLevel<=.01?(jt(i,e,"Blood loss"),{died:!0,bodyPart:o.type,fatal:!0,cause:"blood_loss"}):(r.consciousness<=.05,{died:!1,bodyPart:o.type,fatal:!1}))}function jt(i,e,t){var s;e.alive=!1,e.task=null,e.state="idle",i&&typeof i.msg=="function"&&i.msg(`${((s=e.profile)==null?void 0:s.name)||"Colonist"} died (${t})`,"bad")}function Fs(i,e){const t=i.injuries.reduce((n,r)=>n+(r.bandaged?r.bleeding*.15:r.bleeding),0);if(t<=0)return;const s=t*(e/300);i.bloodLevel=Math.max(0,i.bloodLevel-s)}function Ls(i,e){for(const t of i.injuries)if(t.infected){const s=i.immunity;t.infectionProgress=Math.min(1,(t.infectionProgress||0)+e/600*(1-s*.8)),(t.infectionProgress||0)>.7&&(i.bloodLevel=Math.max(0,i.bloodLevel-5e-4*e),t.pain=Math.min(1,t.pain+.05*(e/60)))}else if(t.infectionChance>0&&t.severity>.2&&!t.bandaged){const s=t.infectionChance*(e/400);Math.random()<s&&(t.infected=!0,t.infectionProgress=.05)}}function Ws(i,e){i.lastBleedCalcTime=(i.lastBleedCalcTime||0)+e,i.lastInfectionTick=(i.lastInfectionTick||0)+e,i.lastBleedCalcTime>=1&&(Fs(i,i.lastBleedCalcTime),i.lastBleedCalcTime=0),i.lastInfectionTick>=4&&(Ls(i,i.lastInfectionTick),i.lastInfectionTick=0)}function zs(i,e){for(let t=i.injuries.length-1;t>=0;t--){const s=i.injuries[t],n=s.healRate*e/86400;s.severity=Math.max(0,s.severity-n),s.pain=s.pain*(s.severity/(s.severity+.1)),s.bleeding=s.bleeding*s.severity,s.severity<=.05&&i.injuries.splice(t,1)}for(const t of i.bodyParts)if(t.currentHp<t.maxHp&&t.currentHp>0){const s=.1*e/86400;t.currentHp=Math.min(t.maxHp,t.currentHp+s)}i.bloodLevel<1&&(i.bloodLevel=Math.min(1,i.bloodLevel+.01*e/86400)),ht(i)}function Ns(i){if(!i.injuries.length)return"No injuries";const e=i.injuries.filter(n=>n.bleeding>0&&!n.bandaged).length,t=i.injuries.filter(n=>n.infected).length,s=i.injuries.filter(n=>n.severity>.6).length;return[`${i.injuries.length} wound${i.injuries.length!==1?"s":""}`,e?`${e} bleeding`:null,s?`${s} severe`:null,t?`${t} infected`:null].filter(Boolean).join(", ")}function Os(i){let e=0,t=0;for(const s of i.injuries)if(s.bleeding>0&&!s.bandaged&&(s.bandaged=!0,s.bleeding*=.35,s.infectionChance*=.7,e++),s.pain>.4){const n=s.pain;s.pain*=.85,t+=n-s.pain}return ht(i),{bandaged:e,painReduced:Number(t.toFixed(2))}}const et=[{id:"bandage_wound",name:"Bandage Wound",description:"Apply bandages to stop bleeding and reduce infection risk.",requiredMedicine:["Bandages"],skillRequired:0,baseSuccessRate:.85,duration:30,painReduction:.2,healingBonus:1.2,canTreatInjuryTypes:["cut","gunshot"],canTreatBodyParts:["head","torso","left_arm","right_arm","left_leg","right_leg"],surgeryRequired:!1,riskOfInfection:.05,priority:1},{id:"treat_burn",name:"Treat Burn",description:"Apply medicine to burns to prevent infection and reduce scarring.",requiredMedicine:["MedicineKit"],skillRequired:2,baseSuccessRate:.75,duration:45,painReduction:.4,healingBonus:1.5,canTreatInjuryTypes:["burn"],canTreatBodyParts:["head","torso","left_arm","right_arm","left_leg","right_leg"],surgeryRequired:!1,riskOfInfection:.1,priority:2},{id:"set_fracture",name:"Set Fracture",description:"Set and splint broken bones. Requires medical skill.",requiredMedicine:["MedicineKit"],skillRequired:5,baseSuccessRate:.7,duration:120,painReduction:.3,healingBonus:2,canTreatInjuryTypes:["fracture"],canTreatBodyParts:["left_arm","right_arm","left_leg","right_leg"],surgeryRequired:!1,riskOfInfection:.05,priority:2},{id:"remove_bullet",name:"Remove Bullet",description:"Surgical removal of bullets and foreign objects.",requiredMedicine:["MedicineKit"],skillRequired:8,baseSuccessRate:.6,duration:180,painReduction:.5,healingBonus:2.5,canTreatInjuryTypes:["gunshot"],canTreatBodyParts:["head","torso","left_arm","right_arm","left_leg","right_leg"],surgeryRequired:!0,riskOfInfection:.15,priority:1},{id:"treat_infection",name:"Treat Infection",description:"Use medicine to fight infection and prevent sepsis.",requiredMedicine:["MedicineKit"],skillRequired:4,baseSuccessRate:.8,duration:60,painReduction:.1,healingBonus:1.3,canTreatInjuryTypes:["infection"],canTreatBodyParts:["head","torso","left_arm","right_arm","left_leg","right_leg"],surgeryRequired:!1,riskOfInfection:0,priority:1},{id:"pain_management",name:"Pain Management",description:"Administer pain relief without treating the underlying injury.",requiredMedicine:["MedicineKit"],skillRequired:1,baseSuccessRate:.95,duration:15,painReduction:.6,healingBonus:1,canTreatInjuryTypes:["cut","bruise","burn","gunshot","fracture"],canTreatBodyParts:["head","torso","left_arm","right_arm","left_leg","right_leg"],surgeryRequired:!1,riskOfInfection:0,priority:3}];class Gs{performTreatment(e,t,s,n){if(!s||!n)return!1;const r=this.getDoctorSkill(e),o=Math.max(0,(r-s.skillRequired)*.05),a=Math.min(.95,s.baseSuccessRate+o);if(Math.random()<a){if(this.applySuccessfulTreatment(t,n,s),e.skills){const d=20+s.skillRequired*4;fe(e,"Medicine",d,e.t||0)}return!0}else{if(this.applyFailedTreatment(t,n,s),e.skills){const d=8+Math.max(0,s.skillRequired-r)*2;fe(e,"Medicine",d,e.t||0)}return!1}}applySuccessfulTreatment(e,t,s){e.health&&(t.pain=Math.max(0,t.pain-s.painReduction),t.healRate*=s.healingBonus,s.id==="bandage_wound"&&(t.bleeding=Math.max(0,t.bleeding*.2),t.bandaged=!0,t.infectionChance=Math.max(0,t.infectionChance*.5)),s.id==="treat_burn"&&(t.bandaged=!0,t.infectionChance=Math.max(0,t.infectionChance*.6)),s.id==="set_fracture"&&(t.bandaged=!0),s.id==="treat_infection"&&(t.infected=!1,t.infectionChance=0),t.treatedBy=s.id,console.log(`Successfully treated ${t.description} with ${s.name}`))}applyFailedTreatment(e,t,s){e.health&&(Math.random()<s.riskOfInfection&&!t.infected&&(t.infected=!0,t.infectionChance=.1,console.log(`Treatment failed and caused infection: ${t.description}`)),t.pain=Math.min(1,t.pain+.1),!t.infected&&t.infectionChance>0&&(t.infectionChance=Math.min(1,t.infectionChance+.05)),console.log(`Failed to treat ${t.description} with ${s.name}`))}hasRequiredItems(e,t){if(!e.inventory||t.length===0)return!0;for(const s of t)if(!e.inventory.items.some(r=>r.defName===s&&r.quantity>0))return!1;return!0}consumeItems(e,t){if(e.inventory)for(const s of t){const n=e.inventory.items.find(r=>r.defName===s&&r.quantity>0);if(n&&(n.quantity-=1,n.quantity<=0)){const r=e.inventory.items.indexOf(n);e.inventory.items.splice(r,1)}}}getDoctorSkill(e){return e.skills?we(e,"Medicine"):0}}const Hs=new Gs;class Ys{constructor(){v(this,"jobs",new Map);v(this,"jobCounter",0);v(this,"lastScanTime",0);v(this,"scanInterval",.5)}scanForMedicalWork(e,t,s){if(s-this.lastScanTime<this.scanInterval)return this.getReservedJob(e);this.lastScanTime=s,this.cleanupJobs(t,s);const n=this.findPlayerForcedJob(e);if(n)return n;const r=this.scanEmergencyMedical(e,t);if(r)return r;const o=this.scanNormalMedical(e,t);return o||null}scanEmergencyMedical(e,t){this.getColonistId(e);const s=this.getDoctorSkill(e),n=t.filter(r=>{if(!r.alive||r===e||!r.health||!r.health.injuries.length)return!1;const o=r.state==="downed",a=r.health.injuries.some(h=>h.bleeding>.3&&!h.bandaged),l=r.health.injuries.some(h=>h.severity>.85),d=r.health.bloodLevel<.4;return o||a||l||d});if(!n.length)return null;n.sort((r,o)=>{const a=this.calculatePatientUrgency(r);return this.calculatePatientUrgency(o)-a});for(const r of n){const o=this.createMedicalJobForPatient(e,r,s,!0);if(o&&!o.reservedBy)return o}return null}scanNormalMedical(e,t){this.getColonistId(e);const s=this.getDoctorSkill(e),n=t.filter(r=>{if(!r.alive||r===e||!r.health||!r.health.injuries.length)return!1;const o=this.getColonistId(r);return this.isPatientReserved(o)?!1:r.health.injuries.some(a=>!a.bandaged||a.infected||a.pain>.3)});if(!n.length)return null;n.sort((r,o)=>{const a=this.calculatePatientPriority(r),l=this.calculatePatientPriority(o);return a-l});for(const r of n){const o=this.createMedicalJobForPatient(e,r,s,!1);if(o&&!o.reservedBy)return o}return null}createMedicalJobForPatient(e,t,s,n){if(!t.health)return null;const r=this.getColonistId(t),o=Array.from(this.jobs.values()).find(h=>h.patientId===r&&!h.reservedBy);if(o)return o;const a=this.findBestTreatment(t,s);if(!a)return null;const l=this.findTargetInjury(t,a);if(!l)return null;const d={id:`medical_${this.jobCounter++}`,type:"doctor",patientId:r,patient:t,treatment:a,targetInjury:l,priority:n?1:this.calculateTreatmentPriority(l,a),playerForced:!1,createdAt:Date.now(),expiresAt:Date.now()+3e4};return this.jobs.set(d.id,d),d}findBestTreatment(e,t){if(!e.health)return null;const s=e.health.injuries.find(o=>o.bleeding>.2&&!o.bandaged);if(s){const o=et.find(a=>a.id==="bandage_wound"&&a.canTreatInjuryTypes.includes(s.type)&&a.skillRequired<=t);if(o)return o}if(e.health.injuries.find(o=>o.infected)){const o=et.find(a=>a.id==="treat_infection"&&a.skillRequired<=t);if(o)return o}const r=[...e.health.injuries].sort((o,a)=>a.severity-o.severity);for(const o of r){const a=et.filter(l=>l.canTreatInjuryTypes.includes(o.type)&&l.canTreatBodyParts.includes(o.bodyPart)&&l.skillRequired<=t);if(a.length)return a.sort((d,h)=>h.healingBonus-d.healingBonus)[0]}return null}findTargetInjury(e,t){return e.health&&e.health.injuries.find(s=>t.canTreatInjuryTypes.includes(s.type)&&t.canTreatBodyParts.includes(s.bodyPart))||null}calculatePatientUrgency(e){if(!e.health)return 0;let t=0;e.state==="downed"&&(t+=100),t+=(1-e.health.bloodLevel)*80;const s=Math.max(...e.health.injuries.map(r=>r.bleeding),0);t+=s*60;const n=Math.max(...e.health.injuries.map(r=>r.severity),0);return t+=n*40,t+=(1-e.health.consciousness)*50,t}calculatePatientPriority(e){if(!e.health)return 10;let t=5;e.health.injuries.some(n=>n.infected)&&(t-=2),t+=e.health.totalPain*3;const s=Math.max(...e.health.injuries.map(n=>n.severity),0);return t-=s*2,Math.max(1,Math.min(10,Math.round(t)))}calculateTreatmentPriority(e,t){let s=t.priority*2;const n=e.bandaged?e.bleeding*.15:e.bleeding;return s-=e.severity*3,s-=n*5,e.infected?s-=3:e.infectionChance>.2&&!e.bandaged&&(s-=2),s-=e.pain*1,e.bodyPart==="head"&&(s-=1),Math.max(1,Math.min(10,Math.round(s)))}getReservedJob(e){const t=this.getColonistId(e);return Array.from(this.jobs.values()).find(s=>s.reservedBy===t)||null}findPlayerForcedJob(e){return Array.from(this.jobs.values()).find(t=>t.playerForced&&!t.reservedBy)||null}reserveJob(e,t){if(e.reservedBy)return!1;const s=this.getColonistId(t);return e.reservedBy=s,e.patient.isBeingTreated=!0,e.patient.doctorId=s,!0}releaseJob(e,t){const s=this.getColonistId(t);e.reservedBy===s&&(e.reservedBy=void 0,e.patient.isBeingTreated=!1,e.patient.doctorId=void 0)}completeJob(e){const t=this.jobs.get(e);t&&(t.patient.isBeingTreated=!1,t.patient.doctorId=void 0,this.jobs.delete(e))}isPatientReserved(e){return Array.from(this.jobs.values()).some(t=>t.patientId===e&&t.reservedBy)}cleanupJobs(e,t){const s=[];for(const[n,r]of this.jobs.entries()){if(r.expiresAt&&t>r.expiresAt){s.push(n);continue}const o=e.find(a=>this.getColonistId(a)===r.patientId);if(!o||!o.alive||!o.health||!o.health.injuries.length){s.push(n);continue}if(r.reservedBy){const a=e.find(l=>this.getColonistId(l)===r.reservedBy);if(!a||!a.alive){s.push(n);continue}}}for(const n of s)this.completeJob(n)}createForcedJob(e,t,s){if(!t.health)return null;const n=this.getColonistId(e),r=this.getColonistId(t),o=this.getDoctorSkill(e);let a=null,l=null;if(s?(a=et.find(h=>h.id===s)||null,a&&(l=this.findTargetInjury(t,a))):(a=this.findBestTreatment(t,o),a&&(l=this.findTargetInjury(t,a))),!a||!l)return null;const d={id:`forced_${this.jobCounter++}`,type:"doctor",patientId:r,patient:t,treatment:a,targetInjury:l,priority:0,playerForced:!0,reservedBy:n,createdAt:Date.now()};return this.jobs.set(d.id,d),t.isBeingTreated=!0,t.doctorId=n,d}getDoctorSkill(e){return e.skills?we(e,"Medicine"):0}getColonistId(e){return e.id||(e.id=`colonist_${Date.now()}_${Math.random().toString(36).substr(2,9)}`),e.id}getActiveJobs(){return Array.from(this.jobs.values())}}const ve=new Ys,Xt=2,xt=1,qs=2;function zi(i){i.kind==="door"&&(i.doorState="closed",i.doorProgress=0,i.doorOpenTime=0,i.doorCloseDelay=0,i.doorQueue=[])}function Us(i){return i.kind!=="door"||!i.done?!1:i.doorState==="open"&&(i.doorProgress??0)>=1}function Ft(i){return i.kind!=="door"||!i.done?!1:i.doorState==="closed"||i.doorState==="closing"}function Qs(i,e){if(e.kind!=="door")return!1;const t=e.x+e.w/2,s=e.y+e.h/2;return Math.hypot(i.x-t,i.y-s)<96}function Vt(i,e){i.kind!=="door"||!i.doorQueue||(i.doorQueue=i.doorQueue.filter(t=>t.id!==e),i.doorQueue.length===0&&i.doorState==="open"&&(i.doorCloseDelay=xt))}function js(i,e,t){if(!(i.kind!=="door"||!i.done))switch(i.doorState===void 0&&zi(i),i.doorState){case"closed":i.doorProgress=0;break;case"opening":i.doorOpenTime+=e,i.doorProgress=Math.min(1,i.doorOpenTime/Xt),i.doorProgress>=1&&(i.doorState="open",i.doorCloseDelay=xt);break;case"open":i.doorProgress=1,i.doorQueue&&i.doorQueue.length===0?(i.doorCloseDelay=Math.max(0,(i.doorCloseDelay||0)-e),i.doorCloseDelay<=0&&(i.doorState="closing",i.doorOpenTime=0)):i.doorCloseDelay=xt;break;case"closing":i.doorOpenTime+=e,i.doorProgress=Math.max(0,1-i.doorOpenTime/qs),i.doorQueue&&i.doorQueue.length>0?(i.doorState="opening",i.doorOpenTime=(1-i.doorProgress)*Xt):i.doorProgress<=0&&(i.doorState="closed");break}}function Xs(i){return i.kind!=="door"?0:i.doorProgress||0}function Vs(i,e,t){if(i.kind!=="door"||!i.done)return!1;if(i.hp-=e,i.hp<=0){const s=t.buildings.indexOf(i);return s!==-1&&(t.buildings.splice(s,1),t.msg("A door has been destroyed!","bad"),t.rebuildNavGrid&&t.rebuildNavGrid()),!0}return!1}const Te=class Te{constructor(){v(this,"itemDefs",new Map);v(this,"loaded",!1)}static getInstance(){return Te.instance||(Te.instance=new Te),Te.instance}async loadItems(){if(!this.loaded)try{const e=[{defName:"Hoe",label:"hoe",description:"A simple farming tool for tilling soil and planting crops.",category:"Tool",equipSlot:"tool",maxDurability:100,stackable:!1,value:25,weight:2,workSpeedBonus:.2,workTypes:["Farming","Construction"]},{defName:"Axe",label:"axe",description:"A sturdy axe for chopping wood and basic construction work.",category:"Tool",equipSlot:"tool",maxDurability:120,stackable:!1,value:40,weight:3.5,workSpeedBonus:.3,workTypes:["Woodcutting","Construction"]},{defName:"Pickaxe",label:"pickaxe",description:"Heavy mining tool for extracting stone and ore.",category:"Tool",equipSlot:"tool",maxDurability:150,stackable:!1,value:60,weight:4,workSpeedBonus:.4,workTypes:["Mining","Construction"]},{defName:"Hammer",label:"hammer",description:"Essential construction tool for building and repairs.",category:"Tool",equipSlot:"tool",maxDurability:200,stackable:!1,value:35,weight:2.5,workSpeedBonus:.25,workTypes:["Construction","Crafting"]},{defName:"Pistol",label:"pistol",description:"A reliable sidearm for personal protection.",category:"Weapon",equipSlot:"weapon",maxDurability:80,stackable:!1,value:150,weight:1.2,damage:25,range:15,accuracy:.7,ammoType:"Bullets"},{defName:"Rifle",label:"assault rifle",description:"Military-grade automatic rifle with high damage output.",category:"Weapon",equipSlot:"weapon",maxDurability:100,stackable:!1,value:400,weight:3.8,damage:40,range:25,accuracy:.8,ammoType:"Bullets"},{defName:"Knife",label:"combat knife",description:"Sharp blade suitable for close combat and utility work.",category:"Weapon",equipSlot:"weapon",maxDurability:60,stackable:!1,value:30,weight:.5,damage:15,range:1,accuracy:.9},{defName:"FlakVest",label:"flak vest",description:"Basic body armor that provides protection against projectiles.",category:"Armor",equipSlot:"armor",maxDurability:150,stackable:!1,value:200,weight:5,armorRating:.3,movementPenalty:.05},{defName:"TacticalArmor",label:"tactical armor",description:"Advanced military armor offering superior protection.",category:"Armor",equipSlot:"armor",maxDurability:200,stackable:!1,value:500,weight:8,armorRating:.5,movementPenalty:.1},{defName:"WorkClothes",label:"work clothes",description:"Durable clothing designed for manual labor.",category:"Clothing",equipSlot:"armor",maxDurability:80,stackable:!1,value:50,weight:1.5,armorRating:.05,workSpeedBonus:.1},{defName:"SimpleHelmet",label:"simple helmet",description:"Basic head protection for dangerous work environments.",category:"Helmet",equipSlot:"helmet",maxDurability:100,stackable:!1,value:75,weight:1,armorRating:.2},{defName:"TacticalHelmet",label:"tactical helmet",description:"Military-grade helmet with enhanced protection.",category:"Helmet",equipSlot:"helmet",maxDurability:150,stackable:!1,value:180,weight:2,armorRating:.35},{defName:"MedicineKit",label:"medicine kit",description:"Basic medical supplies for treating injuries and illnesses.",category:"Medical",equipSlot:"none",maxDurability:50,stackable:!0,maxStack:10,value:40,weight:.5,healAmount:25},{defName:"Bandages",label:"bandages",description:"Clean cloth bandages for wound treatment.",category:"Medical",equipSlot:"none",stackable:!0,maxStack:25,value:5,weight:.1,healAmount:10},{defName:"Wood",label:"wood",description:"Raw lumber for construction and crafting.",category:"Resource",equipSlot:"none",stackable:!0,maxStack:75,value:2,weight:1},{defName:"Stone",label:"stone blocks",description:"Cut stone blocks for sturdy construction.",category:"Resource",equipSlot:"none",stackable:!0,maxStack:75,value:3,weight:2},{defName:"Steel",label:"steel",description:"Refined metal suitable for advanced construction and weapons.",category:"Resource",equipSlot:"none",stackable:!0,maxStack:75,value:5,weight:1.5},{defName:"Bread",label:"bread",description:"Fresh baked bread that provides sustenance.",category:"Food",equipSlot:"none",stackable:!0,maxStack:10,value:8,weight:.3,nutrition:12,spoilage:7},{defName:"MealRation",label:"meal ration",description:"Preserved military ration with long shelf life.",category:"Food",equipSlot:"none",stackable:!0,maxStack:20,value:15,weight:.4,nutrition:20,spoilage:60},{defName:"WheatSeeds",label:"wheat seeds",description:"Seeds for growing wheat crops.",category:"Seeds",equipSlot:"none",stackable:!0,maxStack:50,value:3,weight:.1,cropType:"Wheat",growthTime:15},{defName:"CornSeeds",label:"corn seeds",description:"Seeds for growing corn crops.",category:"Seeds",equipSlot:"none",stackable:!0,maxStack:50,value:4,weight:.1,cropType:"Corn",growthTime:20},{defName:"ComponentElectronic",label:"electronic component",description:"Advanced electronic component for complex devices.",category:"Component",equipSlot:"none",stackable:!0,maxStack:25,value:25,weight:.2},{defName:"ComponentMechanical",label:"mechanical component",description:"Precision mechanical parts for machinery.",category:"Component",equipSlot:"none",stackable:!0,maxStack:25,value:20,weight:.5},{defName:"Gold",label:"gold",description:"Precious metal valuable for trade.",category:"Valuable",equipSlot:"none",stackable:!0,maxStack:25,value:50,weight:.8},{defName:"Silver",label:"silver",description:"Valuable metal used in electronics and trade.",category:"Valuable",equipSlot:"none",stackable:!0,maxStack:25,value:20,weight:.6}];for(const t of e)this.itemDefs.set(t.defName,t);this.loaded=!0,console.log(`Loaded ${this.itemDefs.size} item definitions`)}catch(e){console.error("Failed to load item definitions:",e)}}getItemDef(e){return this.itemDefs.get(e)}getAllItemDefs(){return Array.from(this.itemDefs.values())}getItemDefsByCategory(e){return Array.from(this.itemDefs.values()).filter(t=>t.category===e)}createItem(e,t=1,s){const n=this.getItemDef(e);return n?{name:n.label,quantity:Math.min(t,n.maxStack||t),description:n.description,quality:s||"normal",durability:n.maxDurability,maxDurability:n.maxDurability,stackable:n.stackable,category:n.category,value:n.value,weight:n.weight,defName:e}:(console.warn(`Item definition not found: ${e}`),null)}getWorkSpeedBonus(e){const t=this.getItemDef(e.defName||"");return(t==null?void 0:t.workSpeedBonus)||0}getArmorRating(e){const t=this.getItemDef(e.defName||"");return(t==null?void 0:t.armorRating)||0}getDamage(e){const t=this.getItemDef(e.defName||"");return(t==null?void 0:t.damage)||0}getHealAmount(e){const t=this.getItemDef(e.defName||"");return(t==null?void 0:t.healAmount)||0}getNutrition(e){const t=this.getItemDef(e.defName||"");return(t==null?void 0:t.nutrition)||0}getRandomItemsByCategory(e,t=1){const s=this.getItemDefsByCategory(e),n=[];for(let r=0;r<t&&s.length>0;r++){const o=Math.floor(Math.random()*s.length);n.push(s[o].defName)}return n}getItemsForBackground(e){const t=[];switch(e.toLowerCase()){case"farmer":t.push("Hoe","WheatSeeds","WorkClothes");break;case"soldier":t.push("Rifle","TacticalArmor","TacticalHelmet","MedicineKit");break;case"doctor":t.push("MedicineKit","Bandages");break;case"engineer":t.push("Hammer","ComponentElectronic","ComponentMechanical");break;case"miner":t.push("Pickaxe","SimpleHelmet","WorkClothes");break;case"trader":t.push("Gold","Silver");break;default:t.push("Knife","Bread");break}return t}};v(Te,"instance");let St=Te;const _=St.getInstance();function at(i,e,t,s){for(const n of i.buildings){if(n.kind==="hq"||n.kind==="path"||n.kind==="house"||n.kind==="farm"||n.kind==="bed"||!n.done||n.kind==="door"&&!Ft(n))continue;const r=Math.max(n.x,Math.min(e,n.x+n.w)),o=Math.max(n.y,Math.min(t,n.y+n.h)),a=e-r,l=t-o;if(a*a+l*l<=s*s)return!0}return!1}function Js(i,e){e.stuckTimer===void 0&&(e.stuckTimer=0),e.lastPos||(e.lastPos={x:e.x,y:e.y}),e.lastMoveCheck||(e.lastMoveCheck=0);const t=at(i,e.x,e.y,e.r);e.lastMoveCheck+=1/60;let s=!1;if(e.lastMoveCheck>1&&(Math.hypot(e.x-e.lastPos.x,e.y-e.lastPos.y)<5&&(e.state==="chop"||e.state==="mine"||e.state==="build"||e.state==="harvest")&&(s=!0),e.lastPos={x:e.x,y:e.y},e.lastMoveCheck=0),t||s){if(e.stuckTimer+=1/60,e.stuckTimer>3){const r=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let o=!1;for(const a of[20,40,60,80]){for(const l of r){const d=e.x+Math.cos(l)*a,h=e.y+Math.sin(l)*a,c=Math.max(e.r,Math.min(d,G.w-e.r)),f=Math.max(e.r,Math.min(h,G.h-e.r));if(!at(i,c,f,e.r)){e.x=c,e.y=f,e.stuckTimer=0,o=!0,console.log(`Rescued stuck colonist at (${e.x.toFixed(1)}, ${e.y.toFixed(1)}) using distance ${a}`);break}}if(o)break}if(!o){const a=i.buildings.find(l=>l.kind==="hq");a&&(e.x=a.x+a.w/2+(Math.random()-.5)*40,e.y=a.y-40+(Math.random()-.5)*20,e.stuckTimer=0,console.log("Emergency rescue: teleported stuck colonist to HQ area"))}return!0}}else e.stuckTimer=0;return!1}function Zs(i,e,t){var M,x,C,b,S,T,D,I,O,z,H,j,Y,X,U,K,ie,se,oe,ae,ue,me,he;if(e.health||He(e),(M=e.playerCommand)!=null&&M.issued&&e.playerCommand.expires&&(e.t||0)>=e.playerCommand.expires&&(e.playerCommand=void 0),e.health){Ws(e.health,t),zs(e.health,t),ht(e.health);const y=Et(e.health);if(e.hp=y,e.hp=y,e.alive&&e.health.injuries.some(P=>P.bleeding>.25&&!P.bandaged||P.severity>.7||P.infected)?["doctoring","beingTreated","resting","sleep"].includes(e.state||"")||(e.needsMedical=!0):e.needsMedical=!1,e.alive){const P=e.health.consciousness<.25||e.health.bloodLevel<.25||e.health.injuries.some(B=>B.severity>.85);P&&e.state!=="downed"?(e.prevState=e.state,e.state="downed",e.task=null,e.target=null,i.msg&&i.msg(`${((x=e.profile)==null?void 0:x.name)||"Colonist"} is downed`,"warn")):!P&&e.state==="downed"&&(i.msg&&i.msg(`${((C=e.profile)==null?void 0:C.name)||"Colonist"} has recovered from downed state`,"good"),e.state="seekTask")}const R=e.health.totalPain;1-e.health.consciousness;const F=(e.fatigue||0)>66?.8:(e.fatigue||0)>33?.9:1;e.fatigueSlow=F*e.health.mobility*(1-R*.3),e.manipulationMultiplier=e.health.manipulation*(1-R*.2),e.consciousnessMultiplier=e.health.consciousness}else e.fatigueSlow=(e.fatigue||0)>66?.8:(e.fatigue||0)>33?.9:1,e.manipulationMultiplier=1,e.consciousnessMultiplier=1;if(!e.alive||(e.t+=t,e.state==="downed"))return;if(e.state||f("seekTask","initial state"),e.stateSince=(e.stateSince||0)+t,Js(i,e)){e.task=null,e.target=null,i.clearPath&&i.clearPath(e),f("seekTask","rescued from stuck");return}const s=e.state==="build"||e.state==="chop"||e.state==="mine"||e.state==="harvest"||e.state==="flee"||e.state==="move",n=((b=e.profile)==null?void 0:b.stats.hungerRate)||1,r=((S=e.profile)==null?void 0:S.stats.fatigueRate)||1;if(e.godmode)e.hunger=0,e.fatigue=0;else{const y=(s?.25:e.inside?.1:.15)*n;e.hunger=Math.max(0,Math.min(100,(e.hunger||0)+t*y));const R=(s?.8:.3)*r;e.inside||e.state==="resting"?e.fatigue=Math.max(0,(e.fatigue||0)-t*8):e.fatigue=Math.min(100,(e.fatigue||0)+t*R)}if((e.hunger||0)>=95){const y=2*t;e.hp=Math.max(0,e.hp-y),Math.random()<.05&&console.log(`Colonist starving: hunger=${(e.hunger||0).toFixed(1)}, hp=${e.hp.toFixed(1)}, damage=${y.toFixed(2)}/frame`)}(e.hunger||0)<30&&!s&&!e.inside&&(e.hp=Math.min(100,e.hp+.8*t));const o=i.buildings.find(y=>y.kind==="infirmary"&&y.done);if(o){const y=o.healRange||140,R=o.healRate||3;(e.x-(o.x+o.w/2))**2+(e.y-(o.y+o.h/2))**2<=y*y&&(e.hp=Math.min(100,e.hp+R*t))}const a=140*140,l=180*180,d=i.enemies.find(y=>re(y,e)<a),h=e.state==="flee"&&e.lastDanger&&re(e.lastDanger,e)<l,c=d||(h?e.lastDanger:null);d?e.lastDanger=d:h||(e.lastDanger=null),e.lastHp=e.lastHp??e.hp,e.hp<e.lastHp&&(e.hurt=1.5),e.lastHp=e.hp,e.hurt=Math.max(0,(e.hurt||0)-t);function f(y,R){if(!(!(P=>P==="flee"||P==="heal"||P==="sleep"&&i.isNight())(y)&&e.softLockUntil!=null&&e.t<(e.softLockUntil||0))&&e.state!==y){if((e.state==="sleep"||e.state==="goToSleep")&&y!=="sleep"&&y!=="goToSleep"&&(i.releaseSleepReservation&&i.releaseSleepReservation(e),e.sleepTarget=void 0,e.sleepTargetLockUntil=0),y==="sleep"||y==="flee"||y==="heal"||y==="goToSleep"||y==="eat"||y==="resting"||y==="beingTreated"||y==="doctoring"){const E=e.task;E&&(E==="chop"||E==="mine"||E==="build"||E==="harvestFarm"||E==="harvestWell")&&(e.task==="build"&&e.target&&i.releaseBuildReservation&&i.releaseBuildReservation(e),e.target&&i.assignedTargets&&i.assignedTargets.has(e.target)&&i.assignedTargets.delete(e.target),e.task=null,e.target=null,i.clearPath&&i.clearPath(e),R&&Math.random()<.2&&console.log(`Cleared work task (${E}) when changing to ${y}: ${R}`))}const B=e.state;e.prevState=B,e.state=y,e.stateSince=0,e.lastStateChangeReason=R||"",y==="eat"?e.softLockUntil=e.t+1.5:y==="goToSleep"||y==="sleep"?e.softLockUntil=e.t+2:y==="resting"?e.softLockUntil=e.t+1:e.softLockUntil=void 0,R&&Math.random()<.1&&console.log(`Colonist state change: ${B} → ${y} (${R})`)}}const u=1;e.state==="chop"||e.state==="mine"||e.state==="build"||e.state;const A=e.stateSince>u||e.state==="idle"||e.state==="seekTask"||c,g=60,p=20,w=((T=e.playerCommand)==null?void 0:T.issued)&&e.playerCommand.expires&&(e.t||0)<e.playerCommand.expires;function k(){let y=null;const R=(F,P,B)=>{(!y||P>y.prio)&&(y={state:F,prio:P,reason:B})};if(e.isDrafted&&!e.inside)return R("drafted",99,"drafted by player"),y;if(!e.inside&&c&&R("flee",100,"danger detected"),!e.inside&&!c&&e.health&&e.health.totalPain<.6){const F=ve.scanForMedicalWork(e,i.colonists,e.t);F&&!F.reservedBy&&ve.reserveJob(F,e)&&(e.medicalJob=F,R("doctoring",95,"medical work available"))}if(!e.inside&&e.health&&e.needsMedical){const F=e.health.bloodLevel<.4?98:e.health.injuries.some(P=>P.bleeding>.4)?95:90;R("beingTreated",F,"needs medical treatment")}if(!e.inside&&!c&&(e.hp||0)<35&&R("heal",85-Math.max(0,e.hp)*.1,"low health"),!e.inside&&!c&&(e.fatigue||0)>=g){const F=i.isNight(),P=Math.min(40,((e.fatigue||0)-g)*1),B=F?10:0;let E=55+P+B;w&&(e.fatigue||0)<90&&(E=Math.min(E,35)),R("goToSleep",E,F?"tired + night preference":"high fatigue")}return!e.inside&&(e.hunger||0)>75&&(i.RES.food||0)>0&&R("eat",60+Math.min(25,(e.hunger||0)-75),"hunger"),R("seekTask",10,"default"),y}if(e.inside&&e.state!=="resting")f("resting","entered building");else{const y=F=>{switch(F){case"flee":return 100;case"drafted":return 99;case"waitingAtDoor":return 98;case"beingTreated":return 96;case"doctoring":return 95;case"heal":return 90;case"sleep":return 80;case"goToSleep":return 55;case"eat":return 65;case"storingBread":return 45;case"haulBread":return 43;case"cooking":return 42;case"build":case"chop":case"mine":case"harvest":return 40;case"resting":return 35;case"move":return 25;case"idle":return 15;case"seekTask":return 10;default:return 0}};e.state!=="waitingAtDoor"&&e.waitingForDoor&&f("waitingAtDoor","encountered closed door");const R=k();if(R&&R.state!==e.state){const F=R.state==="flee"||R.state==="heal"||R.state==="beingTreated"||R.state==="doctoring"||R.state==="sleep"&&i.isNight(),P=y(e.state);(F||R.prio>P&&A)&&f(R.state,R.reason)}}switch(e.state){case"resting":{if(e.hideTimer=Math.max(0,(e.hideTimer||0)-t),e.inside&&e.inside.kind==="bed"){const P=e.inside,B=P.x+P.w/2,E=P.y+P.h/2;e.x=B,e.y=E,e.sleepFacing!=null&&(e.direction=e.sleepFacing)}e.hp=Math.min(100,e.hp+1.2*t);const R=(e.fatigue||0)<=p&&e.stateSince>=1;!i.isNight()&&!c&&(e.hurt||0)<=0&&(e.hideTimer||0)<=0&&R&&(i.leaveBuilding(e),e.safeTarget=null,e.safeTimer=0,f("seekTask","finished resting"));break}case"heal":{const y=i.buildings.filter(L=>L.kind==="infirmary"&&L.done);if(!y.length){f("seekTask","no infirmary");break}let R=y[0],F=re(e,i.centerOf(R));for(let L=1;L<y.length;L++){const V=re(e,i.centerOf(y[L]));V<F&&(F=V,R=y[L])}const P=i.centerOf(R),B=R.healRange||140,E=e.x>=R.x-8&&e.x<=R.x+R.w+8&&e.y>=R.y-8&&e.y<=R.y+R.h+8,W=Math.hypot(e.x-P.x,e.y-P.y);if(E&&i.tryEnterBuilding(e,R)){f("resting","entered infirmary");break}W<=B*.9?e.hp>=80&&f("seekTask","healed enough"):i.moveAlongPath(e,t,P,B*.9);break}case"doctoring":{const y=e.medicalJob;if(!y){f("seekTask","no medical job assigned");break}const R=y.patient;if(!R||!R.alive||!R.health||!R.health.injuries.length){ve.releaseJob(y,e),e.medicalJob=null,f("seekTask","patient no longer needs treatment");break}const F=Math.hypot(e.x-R.x,e.y-R.y),P=40;if(F>P)i.moveAlongPath(e,t,{x:R.x,y:R.y},P);else{const B=(((D=y.treatment)==null?void 0:D.duration)||30)/1e3;if(e.stateSince>=B){if(!y.treatment||!y.targetInjury){i.msg&&i.msg(`${((I=e.profile)==null?void 0:I.name)||"Doctor"} could not perform treatment - invalid job`,"bad"),ve.completeJob(y.id),e.medicalJob=null,f("seekTask","invalid medical job");return}const E=Hs.performTreatment(e,R,y.treatment,y.targetInjury),W=y.treatment.name;E?i.msg&&i.msg(`${((O=e.profile)==null?void 0:O.name)||"Doctor"} successfully applied ${W} to ${((z=R.profile)==null?void 0:z.name)||"patient"}`,"good"):i.msg&&i.msg(`${((H=e.profile)==null?void 0:H.name)||"Doctor"} failed to apply ${W} to ${((j=R.profile)==null?void 0:j.name)||"patient"}`,"warn"),ve.completeJob(y.id),e.medicalJob=null,f("seekTask","treatment completed")}}break}case"beingTreated":{const y=e.isBeingTreated,R=e.doctorId;if(y&&R){const B=i.colonists.find(E=>E.id===R);if(B){const E=B.x-e.x,W=B.y-e.y;(Math.abs(E)>1||Math.abs(W)>1)&&(e.direction=Math.atan2(W,E))}break}const F=e.health&&(e.health.injuries.some(B=>B.severity>.6)||e.health.bloodLevel<.5),P=i.buildings.filter(B=>(B.kind==="bed"||B.kind==="house")&&B.done&&(!F||B.kind==="bed"&&B.isMedicalBed)&&i.buildingHasSpace&&i.buildingHasSpace(B,e));if(P.length>0){let B=P[0],E=re(e,i.centerOf(B));for(const V of P.slice(1)){const N=re(e,i.centerOf(V));N<E&&(E=N,B=V)}const W=i.centerOf(B);Math.hypot(e.x-W.x,e.y-W.y)<=20?i.tryEnterBuilding&&i.tryEnterBuilding(e,B)&&f("resting","entered medical bed"):i.moveAlongPath&&i.moveAlongPath(e,t,W,20)}else e.health&&(e.hp=Math.min(100,e.hp+.3*t)),e.health&&!e.needsMedical&&f("seekTask","minor injuries, resuming work");e.stateSince>30&&f("seekTask","medical bed search timeout");break}case"eat":{const y=(i.RES.bread||0)>0,R=(i.RES.food||0)>0,F=y||R;if(Math.random()<.01&&console.log(`Colonist eating: bread=${i.RES.bread}, food=${i.RES.food}, hunger=${e.hunger}, stateSince=${e.stateSince.toFixed(1)}`),!F){e.stateSince>1&&(e.hp=Math.max(0,e.hp-2.5*t)),console.log("NO FOOD AVAILABLE! Colonist will continue tasks or sleep."),f(i.isNight()?"sleep":"seekTask","no food available");break}if((e.hunger||0)>40&&(i.tryConsumeInventoryFood?i.tryConsumeInventoryFood(e):!1)){f("seekTask","ate from inventory");break}const P=i.buildings.filter(L=>L.kind==="pantry"&&L.done&&(L.breadStored||0)>0),B=P.length>0?P:i.buildings.filter(L=>(L.kind==="hq"||L.kind==="warehouse"||L.kind==="stock")&&L.done);if(Math.random()<.01&&console.log(`Food buildings found: ${B.length}, pantries: ${P.length}, buildings: ${B.map(L=>L.kind).join(", ")}`),B.length===0&&F){console.log(`No food buildings found! Available buildings: ${i.buildings.filter(L=>L.done).map(L=>L.kind).join(", ")}`),e.stateSince>1&&(y?(i.RES.bread=(i.RES.bread||0)-1,e.hunger=Math.max(0,(e.hunger||0)-80),e.hp=Math.min(100,e.hp+5),f("seekTask","ate bread without building"),console.log(`Colonist ate bread without building! Bread remaining: ${i.RES.bread}`)):(i.RES.food-=1,e.hunger=Math.max(0,(e.hunger||0)-60),e.hp=Math.min(100,e.hp+2.5),f("seekTask","ate food without building"),console.log(`Colonist ate food without building! Food remaining: ${i.RES.food}`)));break}let E=null,W=1/0;for(const L of B){const V=i.centerOf(L),N=Math.hypot(e.x-V.x,e.y-V.y);N<W&&(W=N,E=L)}if(E){const L=i.centerOf(E),V=Math.max(E.w,E.h)/2+e.r+15;Math.random()<.01&&console.log(`Eating: distance=${W.toFixed(1)}, reachDist=${V.toFixed(1)}, stateSince=${e.stateSince.toFixed(1)}`),W<=V?e.stateSince>.6&&(E.kind==="pantry"&&(i.RES.bread||0)>0?(console.log("Colonist successfully ate bread from pantry"),i.RES.bread=(i.RES.bread||0)-1,E.breadStored=Math.max(0,(E.breadStored||0)-1),e.hunger=Math.max(0,(e.hunger||0)-80),e.hp=Math.min(100,e.hp+5)):(console.log("Colonist successfully ate food from storage"),i.RES.food=Math.max(0,i.RES.food-1),e.hunger=Math.max(0,(e.hunger||0)-60),e.hp=Math.min(100,e.hp+2.5)),f("seekTask","finished eating")):i.moveAlongPath(e,t,L,V)}break}case"flee":{let y=null,R=null;const F=c?i.findSafeTurret(e,c):null;if(F){const P=F.range||120,B=i.centerOf(F),E=i.buildings.find(W=>W.kind==="house"&&W.done&&i.buildingHasSpace(W,e)&&re(i.centerOf(W),B)<P*P);E&&(R=E,y=i.centerOf(E))}if(!y){const P=i.buildings.find(B=>B.kind==="hq"&&i.buildingHasSpace(B,e));P&&(R=P,y=i.centerOf(P))}if(!y&&F&&(y=i.centerOf(F)),y){const P=y.x-e.x,B=y.y-e.y,E=Math.hypot(P,B),W=R?e.x>=R.x-8&&e.x<=R.x+R.w+8&&e.y>=R.y-8&&e.y<=R.y+R.h+8:!1;if(E<=20||W)if(R&&i.tryEnterBuilding(e,R))e.hideTimer=3,f("resting","hid from danger");else{const L=i.buildings.filter(V=>V.done&&i.buildingHasSpace(V,e)&&(V.kind==="house"||V.kind==="hq"));if(L.length){const V=L.sort((q,Q)=>re(e,i.centerOf(q))-re(e,i.centerOf(Q)))[0],N=i.centerOf(V);R=V,y=N}}else i.moveAlongPath(e,t,y,20)}else if(c){const P=ts(is(e,c));e.direction=Math.atan2(P.y,P.x),e.x+=P.x*(e.speed+90)*t,e.y+=P.y*(e.speed+90)*t}c||f("seekTask","no more danger");break}case"sleep":{const y=i.colonistNeedsMedicalBed(e),R=N=>{if(!N.length)return null;const q=e.t||0;if(e.reservedSleepFor&&N.includes(e.reservedSleepFor))return e.sleepTarget=e.reservedSleepFor,e.sleepTargetLockUntil=q+5,e.reservedSleepFor;let Q=e.sleepTarget;const Ce=e.sleepTargetLockUntil||0;if(Q&&!N.includes(Q)&&(e.reservedSleepFor===Q&&i.releaseSleepReservation(e),Q=void 0,e.sleepTarget=void 0,e.sleepTargetLockUntil=0),Q&&q<Ce){if(i.reserveSleepSpot(e,Q))return Q;e.reservedSleepFor===Q&&i.releaseSleepReservation(e),Q=void 0,e.sleepTarget=void 0,e.sleepTargetLockUntil=0}const Re=N.map(ce=>{const ft=Math.sqrt(re(e,i.centerOf(ce))),Vi=i.buildingCapacity(ce),Ji=i.insideCounts.get(ce)||0,Zi=Math.max(0,Vi-Ji)*100-ft;return{house:ce,score:Zi}}).sort((ce,ft)=>ft.score-ce.score);for(const{house:ce}of Re)if(i.reserveSleepSpot(e,ce))return e.sleepTarget=ce,e.sleepTargetLockUntil=q+5,ce;return null},F=i.buildings.filter(N=>(N.kind==="house"||N.kind==="bed"||N.kind==="tent")&&N.done&&!(N.kind==="bed"&&N.isMedicalBed&&!y)&&i.isProtectedByTurret(N)&&i.buildingHasSpace(N,e));if(F.length===0){const N=i.buildings.filter(q=>(q.kind==="house"||q.kind==="bed"||q.kind==="tent"||q.kind==="hq")&&q.done&&!(q.kind==="bed"&&q.isMedicalBed&&!y)&&i.buildingHasSpace(q,e));if(N.length>0){const q=R(N);if(!q){f("seekTask","no bed available");break}const Q=i.centerOf(q);Math.hypot(Q.x-e.x,Q.y-e.y)<=20?i.tryEnterBuilding(e,q)?(e.hideTimer=0,e.sleepTarget=void 0,e.sleepTargetLockUntil=0,f("resting","sleeping in unprotected shelter")):(e.sleepTarget=void 0,e.sleepTargetLockUntil=0,i.releaseSleepReservation(e),f("resting","sleeping outside shelter")):i.moveAlongPath(e,t,Q,20)}else{const q=i.buildings.find(Q=>Q.kind==="hq");if(q){const Q=i.centerOf(q);Math.hypot(Q.x-e.x,Q.y-e.y)>50?i.moveAlongPath(e,t,Q,40):f("resting","sleeping near HQ")}else f("resting","sleeping in place")}e.stateSince>15&&f("resting","sleep timeout - resting in place");break}if(!i.isNight()){f("seekTask","daybreak");break}let P=R(F);if(!P){f("seekTask","no bed available");break}let B=i.centerOf(P);const E=B.x-e.x,W=B.y-e.y,L=Math.hypot(E,W),V=e.x>=P.x-8&&e.x<=P.x+P.w+8&&e.y>=P.y-8&&e.y<=P.y+P.h+8;if(L<=20||V)if(i.tryEnterBuilding(e,P))e.hideTimer=0,e.sleepTarget=void 0,e.sleepTargetLockUntil=0,f("resting","fell asleep");else{e.sleepTarget=void 0,e.sleepTargetLockUntil=0,i.releaseSleepReservation(e);const N=i.buildings.filter(Q=>Q.done&&i.buildingHasSpace(Q,e)&&(Q.kind==="house"||Q.kind==="bed"||Q.kind==="tent"||Q.kind==="hq")&&!(Q.kind==="bed"&&Q.isMedicalBed&&!y)),q=R(N);q?(P=q,B=i.centerOf(q)):f("seekTask","no bed available")}else i.moveAlongPath(e,t,B,20),e.stateSince>15&&f("seekTask","sleep timeout");break}case"goToSleep":{const y=i.colonistNeedsMedicalBed(e),R=i.buildings.filter(N=>(N.kind==="house"||N.kind==="bed"||N.kind==="infirmary"||N.kind==="tent"||N.kind==="hq")&&N.done&&!(N.kind==="bed"&&N.isMedicalBed&&!y)&&i.buildingHasSpace(N,e)),P=(e.fatigue||0)<=p&&e.stateSince>=2;if(R.length===0){i.releaseSleepReservation(e),e.stateSince>3&&(P?f("seekTask","no rest buildings, fatigue recovered"):e.fatigue=Math.max(0,(e.fatigue||0)-t*2));break}const B=()=>{if(e.reservedSleepFor&&R.includes(e.reservedSleepFor))return e.sleepTarget=e.reservedSleepFor,e.sleepTargetLockUntil=(e.t||0)+5,e.reservedSleepFor;const N=R.map(q=>({b:q,d:re(e,i.centerOf(q)),priority:y&&q.kind==="bed"&&q.isMedicalBed?0:q.kind==="bed"?1:2})).sort((q,Q)=>q.priority-Q.priority||q.d-Q.d);for(const{b:q}of N)if(i.reserveSleepSpot(e,q))return e.sleepTarget=q,e.sleepTargetLockUntil=(e.t||0)+5,q;return null},E=B();if(!E){P&&f("seekTask","no available rest buildings, fatigue recovered");break}const W=i.centerOf(E),L=Math.hypot(W.x-e.x,W.y-e.y),V=e.x>=E.x-8&&e.x<=E.x+E.w+8&&e.y>=E.y-8&&e.y<=E.y+E.h+8;if(L<=20||V)if(i.tryEnterBuilding(e,E))e.hideTimer=0,f("resting","entered rest building");else{i.releaseSleepReservation(e);const N=B();N?N!==E&&i.clearPath(e):P&&f("seekTask","no available rest buildings, fatigue recovered")}else i.moveAlongPath(e,t,W,20),P&&f("seekTask","fatigue recovered while searching for rest");break}case"seekTask":{if(i.isNight()){f("sleep","night time");break}if(!e.task||e.task==="idle"&&Math.random()<.05){const y=e.task;i.pickTask(e),y!==e.task&&Math.random()<.1&&console.log(`Colonist assigned task: ${e.task}, target:`,e.target)}switch(e.task){case"build":f("build","assigned build task");break;case"harvestFarm":f("harvest","assigned farm task");break;case"harvestWell":f("harvest","assigned well task");break;case"chop":f("chop","assigned chop task");break;case"mine":f("mine","assigned mine task");break;case"cookWheat":f("cooking","assigned cooking task");break;case"storeBread":f("storingBread","assigned bread storage task");break;case"idle":default:e.target||(e.target={x:e.x+(Math.random()-.5)*160,y:e.y+(Math.random()-.5)*160}),f("idle","no tasks available");break}break}case"idle":{if(i.isNight()){Math.random()<.1&&console.log("Colonist was idle during night time, forcing sleep transition"),f("sleep","night time while idle");break}const y=e.target;if(!y){f("seekTask","no target");break}i.moveAlongPath(e,t,y,8)&&(e.task=null,e.target=null,i.clearPath(e),f("seekTask","reached target"));break}case"build":{const y=e.target;if(!y||y.done){e.stateSince>=.5&&(i.releaseBuildReservation(e),e.task=null,e.target=null,i.clearPath(e),f("seekTask","building complete"));break}const R={x:y.x+y.w/2,y:y.y+y.h/2};if(e.stateSince>15){console.log(`Build task timeout after ${e.stateSince.toFixed(1)}s, abandoning building`),i.releaseBuildReservation(e),e.task=null,e.target=null,i.clearPath(e),f("seekTask","build timeout");break}const F=Math.hypot(e.x-R.x,e.y-R.y);if(e.lastDistToNode||(e.lastDistToNode=F),e.lastDistToNode=F,i.moveAlongPath(e,t,R,12)){const P=i.getWorkSpeedMultiplier?i.getWorkSpeedMultiplier(e,"Construction"):1,B=e.skills?we(e,"Construction"):0,E=_e(B),W=P*E;if(y.buildLeft-=25*t*W,e.skills&&fe(e,"Construction",6*t,e.t||0),y.buildLeft<=0){if(y.done=!0,y.kind==="farm"&&(y.growth=0,y.ready=!1),y.kind==="door"&&zi(y),y.isFloorConstruction&&y.floorType){const L=y.floorType,N={BASIC_PATH:1,STONE_ROAD:2,WOODEN_FLOOR:3,CONCRETE:4,METAL_FLOOR:5,CARPET:6}[L]||1,q=Math.floor(y.x/32),Q=Math.floor(y.y/32);if(i.terrainGrid&&q>=0&&Q>=0&&q<i.grid.cols&&Q<i.grid.rows){const Ce=Q*i.grid.cols+q;i.terrainGrid.floors[Ce]=N,(Y=i.syncTerrainToGrid)==null||Y.call(i);const Re=i.buildings.indexOf(y);Re!==-1&&i.buildings.splice(Re,1),i.msg("Floor construction complete","good")}}if(at(i,e.x,e.y,e.r)){const L=[0,Math.PI/2,Math.PI,3*Math.PI/2,Math.PI/4,3*Math.PI/4,5*Math.PI/4,7*Math.PI/4];let V=!1;for(const N of L){const q=Math.max(y.w,y.h)/2+e.r+10,Q=y.x+y.w/2+Math.cos(N)*q,Ce=y.y+y.h/2+Math.sin(N)*q,Re=Math.max(e.r,Math.min(Q,G.w-e.r)),ce=Math.max(e.r,Math.min(Ce,G.h-e.r));if(!at(i,Re,ce,e.r)){e.x=Re,e.y=ce,V=!0,Math.random()<.1&&console.log(`Moved colonist to safety after building completion: (${e.x.toFixed(1)}, ${e.y.toFixed(1)})`);break}}if(!V){const N=i.buildings.find(q=>q.kind==="hq");N&&(e.x=N.x+N.w/2,e.y=N.y-30,console.log("Emergency teleport to HQ area after building completion"))}}i.msg(y.name?y.name+" complete":"Building complete"),i.rebuildNavGrid(),i.clearPath(e),i.releaseBuildReservation(e),e.task=null,e.target=null,f("seekTask","building complete")}}break}case"harvest":{const y=e.target;if(!y){e.stateSince>=.5&&(e.task=null,e.target=null,i.clearPath(e),f("seekTask","no harvest target"));break}if(y.kind==="farm"&&!y.ready){e.stateSince>=.5&&(e.task=null,e.target=null,i.clearPath(e),f("seekTask","farm not ready"));break}const R={x:y.x+y.w/2,y:y.y+y.h/2};if(i.moveAlongPath(e,t,R,12)){const F=e.skills?we(e,"Plants"):0,P=1+Math.min(.5,F*.02);if(y.kind==="farm"){y.ready=!1,y.growth=0;const B=Math.round(10*P);if(y.inventory){const E=Ue(y,"wheat",B);if(E>0&&i.msg(`Farm harvested (+${E} wheat stored in farm)`,"good"),E<B){const W=B-E,L=i.addResource("wheat",W);L>0&&i.msg(`Farm full! +${L} wheat to storage`,"info")}}else{const E=i.addResource("wheat",B);E>0&&i.msg(`Farm harvested (+${E} wheat)`,"good")}e.skills&&fe(e,"Plants",20,e.t||0)}else if(y.kind==="well"){const B=i.addResource("food",Math.round(5*P*.6));B>0&&i.msg(`Well collected (+${B} food)`,"good")}e.stateSince>=.5&&(e.task=null,e.target=null,i.clearPath(e),f("seekTask","harvest complete"))}break}case"chop":{const y=e.target;if(!y||y.hp<=0){e.stateSince>=.5&&(y&&i.assignedTargets.has(y)&&i.assignedTargets.delete(y),e.task=null,e.target=null,i.clearPath(e),f("seekTask","tree gone"));break}const R=y.x-e.x,F=y.y-e.y,P=Math.hypot(R,F),B=(y.r||12)+e.r+4,E=2.5;if(P<=B+E+.1){const W=i.getWorkSpeedMultiplier?i.getWorkSpeedMultiplier(e,"Woodcutting"):1,L=e.skills?we(e,"Plants"):0,V=_e(L),N=W*V;if(y.hp-=18*t*N,e.skills&&fe(e,"Plants",4*t,e.t||0),y.hp<=0){const q=1+Math.min(.5,L*.02),Q=i.addResource("wood",Math.round(6*q));i.trees.splice(i.trees.indexOf(y),1),i.assignedTargets.has(y)&&i.assignedTargets.delete(y),Q>0&&i.msg(`+${Q} wood`,"good"),e.stateSince>=.5&&(e.task=null,e.target=null,i.clearPath(e),f("seekTask","chopped tree"))}break}else i.moveAlongPath(e,t,y,B+E),e.lastDistToNode||(e.lastDistToNode=P),e.lastDistToNode=P;e.stateSince&&e.stateSince>20&&(console.log(`Chop task timeout after ${e.stateSince.toFixed(1)}s, abandoning tree`),i.assignedTargets.has(y)&&i.assignedTargets.delete(y),e.task=null,e.target=null,i.clearPath(e),f("seekTask","chop timeout"));break}case"mine":{const y=e.target;if(!y||y.hp<=0){e.stateSince>=.5&&(y&&i.assignedTargets.has(y)&&i.assignedTargets.delete(y),e.task=null,e.target=null,i.clearPath(e),f("seekTask","rock gone"));break}const R=y.x-e.x,F=y.y-e.y,P=Math.hypot(R,F),B=(y.r||12)+e.r+4,E=2.5;if(Math.random()<.01&&console.log(`Mining: distance=${P.toFixed(1)}, interact=${B}, colonist at (${e.x.toFixed(1)}, ${e.y.toFixed(1)}), rock at (${y.x.toFixed(1)}, ${y.y.toFixed(1)})`),P<=B+E+.1){const W=i.getWorkSpeedMultiplier?i.getWorkSpeedMultiplier(e,"Mining"):1,L=e.skills?we(e,"Mining"):0,V=_e(L),N=W*V;if(y.hp-=16*t*N,e.skills&&fe(e,"Mining",4*t,e.t||0),y.hp<=0){const q=1+Math.min(.5,L*.02),Q=i.addResource("stone",Math.round(5*q));i.rocks.splice(i.rocks.indexOf(y),1),i.assignedTargets.has(y)&&i.assignedTargets.delete(y),Q>0&&i.msg(`+${Q} stone`,"good"),e.stateSince>=.5&&(e.task=null,e.target=null,i.clearPath(e),f("seekTask","mined rock"))}break}else i.moveAlongPath(e,t,y,B+E),Math.random()<.01&&console.log(`Moving toward rock: target=(${y.x.toFixed(1)}, ${y.y.toFixed(1)}), distance=${P.toFixed(1)}`);e.stateSince&&e.stateSince>15&&(console.log(`Colonist stuck mining for ${e.stateSince.toFixed(1)}s, abandoning`),i.assignedTargets.has(y)&&i.assignedTargets.delete(y),e.task=null,e.target=null,i.clearPath(e),f("seekTask","mine timeout"));break}case"waitingAtDoor":{const y=e.waitingForDoor;if(!y||y.kind!=="door"||!y.done){e.waitingForDoor=null,e.doorWaitStart=void 0,f("seekTask","door no longer exists");break}if(Us(y))e.id&&Vt(y,e.id),e.waitingForDoor=null,e.doorWaitStart=void 0,e.task==="build"?f("build","door opened, resuming build"):e.task==="chop"?f("chop","door opened, resuming chop"):e.task==="mine"?f("mine","door opened, resuming mine"):e.task==="harvestFarm"||e.task==="harvestWell"?f("harvest","door opened, resuming harvest"):f("move","door opened, resuming movement");else{const R=e.doorWaitStart?e.t-e.doorWaitStart:0;R>10&&(console.log(`Colonist gave up waiting at door after ${R.toFixed(1)}s`),e.id&&Vt(y,e.id),e.waitingForDoor=null,e.doorWaitStart=void 0,e.task=null,e.target=null,i.clearPath&&i.clearPath(e),f("seekTask","door wait timeout"))}break}case"cooking":{const y=e.target;if(!y||y.kind!=="stove"||!y.done){e.task=null,e.target=null,e.carryingWheat=0,i.clearPath(e),f("seekTask","stove no longer available");break}if(e.cookingSubState||(e.cookingSubState="goingToFarm",e.cookingSourceFarm=null),e.cookingSubState==="goingToFarm"){if(!e.cookingSourceFarm){const E=i.buildings.filter(W=>W.kind==="farm"&&W.done&&W.inventory&&Oe(W,"wheat")>=5);if(E.length===0){e.task=null,e.target=null,e.cookingSubState=null,e.cookingSourceFarm=null,f("seekTask","no wheat available in farms");break}e.cookingSourceFarm=E.reduce((W,L)=>{const V=Math.hypot(e.x-(L.x+L.w/2),e.y-(L.y+L.h/2)),N=Math.hypot(e.x-(W.x+W.w/2),e.y-(W.y+W.h/2));return V<N?L:W})}const R=e.cookingSourceFarm;if(!R){e.task=null,e.target=null,e.cookingSubState=null,f("seekTask","no farm found");break}const F={x:R.x+R.w/2,y:R.y+R.h/2};if(Math.hypot(e.x-F.x,e.y-F.y)>20){i.moveAlongPath(e,t,F,20);break}if(Oe(R,"wheat")>=5){const E=pt(R,"wheat",5);e.carryingWheat=E,i.msg(`${((X=e.profile)==null?void 0:X.name)||"Colonist"} picked up ${E} wheat from farm`,"info"),e.cookingSubState="goingToStove",i.clearPath(e)}else e.cookingSourceFarm=null;break}if(e.cookingSubState==="goingToStove"){const R={x:y.x+y.w/2,y:y.y+y.h/2};if(Math.hypot(e.x-R.x,e.y-R.y)>20){i.moveAlongPath(e,t,R,20);break}e.carryingWheat&&e.carryingWheat>0?(Ue(y,"wheat",e.carryingWheat),e.carryingWheat=0,y.cookingProgress=0,y.cookingColonist=e.id,e.cookingSubState="cooking",i.msg(`${((U=e.profile)==null?void 0:U.name)||"Colonist"} started cooking at stove`,"info")):(e.task=null,e.target=null,e.cookingSubState=null,e.cookingSourceFarm=null,f("seekTask","lost wheat"));break}if(e.cookingSubState==="cooking"){const R={x:y.x+y.w/2,y:y.y+y.h/2};if(Math.hypot(e.x-R.x,e.y-R.y)>25&&i.moveAlongPath(e,t,R,20),Oe(y,"wheat")>=5){const B=e.skills?we(e,"Cooking"):0,W=.1*_e(B);if(y.cookingProgress=(y.cookingProgress||0)+W*t,e.skills&&fe(e,"Cooking",3*t,e.t||0),y.cookingProgress>=1){const L=pt(y,"wheat",5),V=Math.floor(L/5)*3;Ue(y,"bread",V),y.cookingProgress=0,y.cookingColonist=void 0,i.msg(`${((K=e.profile)==null?void 0:K.name)||"Colonist"} cooked ${V} bread!`,"good"),e.skills&&fe(e,"Cooking",30,e.t||0),e.task=null,e.target=null,e.cookingSubState=null,e.cookingSourceFarm=null,f("seekTask","finished cooking")}}else y.cookingProgress=0,y.cookingColonist=void 0,e.task=null,e.target=null,e.cookingSubState=null,e.cookingSourceFarm=null,f("seekTask","wheat disappeared from stove")}e.stateSince>60&&(console.log(`Cooking task timeout after ${e.stateSince.toFixed(1)}s, abandoning`),y.cookingColonist=void 0,e.task=null,e.target=null,e.carryingWheat=0,e.cookingSubState=null,e.cookingSourceFarm=null,f("seekTask","cooking timeout"));break}case"haulBread":{const y=e.target;if(!y||y.kind!=="stove"||!y.done){e.task=null,e.target=null,e.carryingBread=0,i.clearPath(e),f("seekTask","stove no longer available");break}const R=(ie=e.task)==null?void 0:ie.extraData;if(!R||R.kind!=="pantry"||!R.done){e.task=null,e.target=null,e.carryingBread=0,f("seekTask","pantry no longer available");break}if(e.cookingSubState||(e.cookingSubState="goingToStove"),e.cookingSubState==="goingToStove"){const F={x:y.x+y.w/2,y:y.y+y.h/2};if(Math.hypot(e.x-F.x,e.y-F.y)>20){i.moveAlongPath(e,t,F,20);break}const B=Oe(y,"bread");if(B>0){const E=Math.min(B,10),W=pt(y,"bread",E);e.carryingBread=(e.carryingBread||0)+W,i.msg(`${((se=e.profile)==null?void 0:se.name)||"Colonist"} picked up ${W} bread from stove`,"info"),e.cookingSubState="goingToFarm",i.clearPath(e)}else e.task=null,e.target=null,e.cookingSubState=null,f("seekTask","no bread in stove");break}if(e.cookingSubState==="goingToFarm"){const F={x:R.x+R.w/2,y:R.y+R.h/2};if(Math.hypot(e.x-F.x,e.y-F.y)>20){i.moveAlongPath(e,t,F,20);break}if(e.carryingBread&&e.carryingBread>0){const B=Ue(R,"bread",e.carryingBread);if(B>0&&(i.msg(`${((oe=e.profile)==null?void 0:oe.name)||"Colonist"} stored ${B} bread in pantry`,"good"),R.breadStored=(R.breadStored||0)+B,i.addResource("bread",B)),B<e.carryingBread){const E=e.carryingBread-B;i.addResource("bread",E),i.msg(`Pantry full! +${E} bread to general storage`,"info")}e.carryingBread=0,e.task=null,e.target=null,e.cookingSubState=null,f("seekTask","bread hauled to pantry")}else e.task=null,e.target=null,e.cookingSubState=null,f("seekTask","lost bread during hauling")}e.stateSince>45&&(console.log(`Haul bread task timeout after ${e.stateSince.toFixed(1)}s, abandoning`),e.task=null,e.target=null,e.carryingBread=0,e.cookingSubState=null,f("seekTask","haul bread timeout"));break}case"storingBread":{const y=e.target;if(!y||y.kind!=="pantry"||!y.done){e.carryingBread&&e.carryingBread>0&&(i.addResource("bread",e.carryingBread),e.carryingBread=0),e.task=null,e.target=null,f("seekTask","pantry no longer available");break}const R={x:y.x+y.w/2,y:y.y+y.h/2};if(Math.hypot(e.x-R.x,e.y-R.y)>20){i.moveAlongPath(e,t,R,20);break}if(e.carryingBread&&e.carryingBread>0){if(y.inventory){const P=Ue(y,"bread",e.carryingBread);if(P>0&&(i.msg(`${((ae=e.profile)==null?void 0:ae.name)||"Colonist"} stored ${P} bread in pantry`,"good"),y.breadStored=(y.breadStored||0)+P),i.addResource("bread",P),P<e.carryingBread){const B=e.carryingBread-P;i.addResource("bread",B),i.msg(`Pantry full! +${B} bread to general storage`,"info")}}else y.breadStored=(y.breadStored||0)+e.carryingBread,i.addResource("bread",e.carryingBread),i.msg(`${((ue=e.profile)==null?void 0:ue.name)||"Colonist"} stored ${e.carryingBread} bread`,"good");e.carryingBread=0,e.task=null,e.target=null,f("seekTask","bread stored")}else e.task=null,e.target=null,f("seekTask","no bread to store");break}case"drafted":{if(!e.isDrafted){f("seekTask","undrafted by player");break}if(e.draftedPosition){Math.hypot(e.x-e.draftedPosition.x,e.y-e.draftedPosition.y)>10&&i.moveAlongPath(e,t,e.draftedPosition,10);break}if(e.draftedTarget&&e.draftedTarget.alive!==!1&&e.draftedTarget.hp>0){const y=e.draftedTarget,R=Math.hypot(e.x-y.x,e.y-y.y),F=(he=(me=e.inventory)==null?void 0:me.equipment)==null?void 0:he.weapon;let P=40;if(F&&F.defName){const B=_.getItemDef(F.defName);B&&B.range>2&&(P=B.range*32*.6)}R>P*1.2&&i.moveAlongPath(e,t,{x:y.x,y:y.y},P);break}break}}e.overlapTimers||(e.overlapTimers=new Map);for(const y of i.colonists){if(y===e||!y.alive)continue;if((e.state==="mine"||e.state==="chop")&&e.target){const V=(e.target.r||12)+e.r+4;if(Math.hypot(e.x-e.target.x,e.y-e.target.y)<=V+2.5)continue}if(e.inside||y.inside)continue;const R=e.x-y.x,F=e.y-y.y,P=R*R+F*F,B=e.r+y.r+8,E=B*B,W=y.id||y,L=e.overlapTimers;if(P>0&&P<E){if(L.has(W)||L.set(W,0),L.set(W,L.get(W)+t),L.get(W)>=1){const N=Math.sqrt(P)||1,Q=(B-N)/B*.3;e.x+=R/N*Q*t*3,e.y+=F/N*Q*t*3}}else L.delete(W)}}function mt(i,e,t,s){for(const n of i.buildings){if(n.kind==="hq"||n.kind==="path"||n.kind==="house"||n.kind==="farm"||n.kind==="bed"||!n.done||n.kind==="door"&&!Ft(n))continue;const r=Math.max(n.x,Math.min(e,n.x+n.w)),o=Math.max(n.y,Math.min(t,n.y+n.h)),a=e-r,l=t-o;if(a*a+l*l<=s*s)return!0}return!1}const Ks=48,$s=4,_s=25,en=.75;function tn(i,e,t,s){const n=e;if(Math.hypot(t.x-e.x,t.y-e.y)<=e.r+4)return n.path=void 0,n.pathIndex=void 0,!1;n.repath=Math.max(0,(n.repath??0)-s);const o=n.pathGoal,a=!o||Math.hypot(o.x-t.x,o.y-t.y)>Ks,l=!n.path||n.pathIndex==null||n.pathIndex>=n.path.length;if(a||l||(n.repath??0)<=0){if(!i.grid)return!1;const d=As(i.grid,e.x,e.y,t.x,t.y,i.regionManager);if(d&&d.length){for(;d.length&&Math.hypot(d[0].x-e.x,d[0].y-e.y)<m*.25;)d.shift();return d.length?(n.path=d,n.pathIndex=0,n.pathGoal={x:t.x,y:t.y},n.repath=1.5+Math.random()*1,!0):(n.path=void 0,n.pathIndex=void 0,!1)}return n.path=void 0,n.pathIndex=void 0,n.repath=.5+Math.random()*.5,!1}return!0}function sn(i,e,t){const s=e,n=s.path,r=s.pathIndex??0;if(!n||r>=n.length)return s.path=void 0,s.pathIndex=void 0,0;const o=n[r];if(!o)return s.path=void 0,s.pathIndex=void 0,0;const a=e.x,l=e.y,d=o.x-e.x,h=o.y-e.y,c=Math.hypot(d,h);let f=e.speed;if(i.grid){const g=Math.floor(e.x/m),p=Math.floor(e.y/m);if(g>=0&&p>=0&&g<i.grid.cols&&p<i.grid.rows){const w=p*i.grid.cols+g;i.grid.cost[w]<=.7&&(f+=_s)}}const u=f*t;if(c<=$s)e.x=o.x,e.y=o.y,s.pathIndex=r+1,s.pathIndex>=n.length&&(s.path=void 0,s.pathIndex=void 0);else if(c>0){const g=1/c,p=d*g*u,w=h*g*u;Math.hypot(p,w)>=c?(e.x=o.x,e.y=o.y,s.pathIndex=r+1,s.pathIndex>=n.length&&(s.path=void 0,s.pathIndex=void 0)):(e.x+=p,e.y+=w)}return Math.hypot(e.x-a,e.y-l)}function nn(i,e,t,s){const n=t.x-e.x,r=t.y-e.y,o=Math.hypot(n,r);if(o<.001)return!1;const a=e.speed*s,l=n/o,d=r/o,h=e.x+l*a,c=e.y+d*a;if(!mt(i,h,c,e.r))return e.x=h,e.y=c,!0;const f=-d,u=l,A=e.x+f*a*.5,g=e.y+u*a*.5;if(!mt(i,A,g,e.r))return e.x=A,e.y=g,!0;const p=e.x-f*a*.5,w=e.y-u*a*.5;return mt(i,p,w,e.r)?!1:(e.x=p,e.y=w,!0)}function on(i,e,t){var A;const s=e._lastPos||{x:e.x,y:e.y},n=Math.hypot(e.x-s.x,e.y-s.y);e._lastPos={x:e.x,y:e.y};const r=n>.5;e.meleeCd=Math.max(0,(e.meleeCd||0)-t);const o=i.buildings.find(g=>g.kind==="hq");let a=o,l=re(e,i.centerOf(o));for(const g of i.colonists){const p=re(e,g);p<l&&(l=p,a=g)}const d=a.w?i.centerOf(a):{x:a.x,y:a.y};e.target=a;let h=Math.hypot(d.x-e.x,d.y-e.y),c=!1,f=0;h>e.r+4?(c=tn(i,e,d,t),c&&(f=sn(i,e,t),h=Math.hypot(d.x-e.x,d.y-e.y))):(e.path=void 0,e.pathIndex=void 0);let u=!1;if(h>e.r+4&&(f<.5||!c)){const g=i.buildings.find(p=>p.kind==="door"&&p.done&&Ft(p)&&Qs(e,p));if(g){if(e.waitingForDoor=g,e.doorWaitStart||(e.doorWaitStart=i.time||0),!r&&e.meleeCd<=0){const p=Vs(g,e.dmg,i);e.meleeCd=1,p&&(e.waitingForDoor=null,e.doorWaitStart=void 0)}}else e.waitingForDoor=null,e.doorWaitStart=void 0,u=nn(i,e,d,t);!u&&c&&e.path?(e.stuckTimer=(e.stuckTimer||0)+t,e.stuckTimer>en&&(e.path=void 0,e.pathIndex=void 0,e.repath=0,e.stuckTimer=0)):c&&(e.stuckTimer=0)}else c&&(e.stuckTimer=0);if(c||(e.stuckTimer=0),a.w){const g=a;i.pointInRect(e,g)&&(!r&&e.meleeCd<=0&&(g.hp-=e.dmg,e.meleeCd=1),g.hp<=0&&(g.kind==="hq"?i.lose():(i.evictColonistsFrom(g),i.buildings.splice(i.buildings.indexOf(g),1),i.msg((g.name||g.kind)+" destroyed","warn"))))}else{const g=a;if(Math.hypot(e.x-g.x,e.y-g.y)<e.r+8&&!r&&e.meleeCd<=0){let w="bruise";const k=((A=e.color)==null?void 0:A.toLowerCase())||"";k.includes("red")||k.includes("orange")?w="burn":k.includes("green")||k.includes("brown")?w="bite":e.dmg>15&&(w="cut"),typeof i.applyDamageToColonist=="function"?i.applyDamageToColonist(g,e.dmg,w):g.hp-=e.dmg,e.meleeCd=1,g.hp<=0&&(g.alive=!1,i.colonists.splice(i.colonists.indexOf(g),1),i.msg("A colonist has fallen","warn"))}}}function an(i){const e=i.ctx,t=i.canvas.width,s=i.canvas.height,n=i.isTouch,r=Math.min(i.scale(n?980:860),t-i.scale(n?28:40)),o=Math.min(i.scale(n?720:620),s-i.scale(n?60:80)),a=(t-r)/2,l=(s-o)/2;e.save(),e.fillStyle="#0b1628dd",e.fillRect(a,l,r,o),e.strokeStyle="#1e293b",e.strokeRect(a+.5,l+.5,r-1,o-1),e.fillStyle="#dbeafe",e.font=i.getScaledFont(n?22:18,"600"),e.fillText("Build Menu (B to close)",a+i.scale(14),l+i.scale(24));const d=Ss(J),h=Object.keys(d),c=i.scale(n?36:28),f=Math.floor((r-c)/Math.max(1,h.length));i.menuRects=[];let u=null;for(let p=0;p<h.length;p++){const w=a+i.scale(12)+p*f;let k=l+i.scale(50);const M=h[p];e.fillStyle="#93c5fd",e.font=i.getScaledFont(n?18:15,"600"),e.fillText(M,w,k),k+=i.scale(n?12:8);const x=d[M];for(const[C,b]of x){k+=i.scale(n?12:8);const S=i.scale(n?78:58),T=f-i.scale(18),D=w,I=k,O=i.mouse.x*i.DPR,z=i.mouse.y*i.DPR,H=O>=D&&O<=D+T&&z>=I&&z<=I+S;e.fillStyle=i.selectedBuild===C?"#102034":H?"#1a1f2e":"#0f172a",e.fillRect(D,I,T,S),e.strokeStyle=i.selectedBuild===C?"#4b9fff":H?"#3b82f6":"#1e293b",e.strokeRect(D+.5,I+.5,T-1,S-1),e.fillStyle="#dbeafe",e.font=i.getScaledFont(n?18:15,"600"),e.fillText(b.name,D+i.scale(10),I+i.scale(n?22:18));const j=i.costText(b.cost||{});e.fillStyle="#9fb3c8",e.font=i.getScaledFont(n?14:12);const Y=Math.min(i.scale(n?120:100),e.measureText(j).width+i.scale(4));if(e.fillText(j,D+T-Y,I+i.scale(n?22:18)),b.description){e.fillStyle="#94a3b8",e.font=i.getScaledFont(n?14:12);const X=T-i.scale(18);let U=b.description;for(;e.measureText(U).width>X&&U.length>10;)U=U.substring(0,U.length-4)+"...";e.fillText(U,D+i.scale(10),I+i.scale(n?46:36))}if(H&&b.description&&(u={key:C,desc:b.description}),i.menuRects.push({key:C,x:D,y:I,w:T,h:S}),k+=S,k>l+o-i.scale(n?90:70))break}}if(u){const p=i.scale(n?16:14),w=i.scale(n?420:360);e.font=i.getScaledFont(n?16:14);const k=rn(i,u.desc,w-p*2),M=i.scale(n?20:18),x=k.length*M+p*2,C=i.mouse.x*i.DPR,b=i.mouse.y*i.DPR;let S=C+i.scale(20),T=b-x-i.scale(10);S+w>t&&(S=C-w-i.scale(20)),T<0&&(T=b+i.scale(20)),e.fillStyle="#0f1419f0",e.fillRect(S,T,w,x),e.strokeStyle="#374151",e.strokeRect(S+.5,T+.5,w-1,x-1),e.fillStyle="#e5e7eb";for(let D=0;D<k.length;D++)e.fillText(k[D],S+p,T+p+(D+1)*M-i.scale(4))}e.fillStyle="#9fb3c8",e.font=i.getScaledFont(n?16:14);const A="Click an item to select • Hover for details • Press B to close",g=e.measureText(A).width;e.fillText(A,(t-g)/2,l+o+i.scale(n?30:24)),e.restore()}function Jt(i){const e=i.mouse.x*i.DPR,t=i.mouse.y*i.DPR;for(const s of i.menuRects)if(e>=s.x&&e<=s.x+s.w&&t>=s.y&&t<=s.y+s.h){i.selectedBuild=s.key,i.showBuildMenu=!1,i.toast("Selected: "+J[s.key].name);return}i.showBuildMenu=!1}function rn(i,e,t){const s=i.ctx,n=e.split(" "),r=[];let o="";for(const a of n){const l=o+(o?" ":"")+a;s.measureText(l).width<=t?o=l:(o&&r.push(o),o=a)}return o&&r.push(o),r}function Ni(i,e){if(!e.items||e.items.length===0){ze(i);return}const t={...e,visible:!0,x:e.screenX,y:e.screenY,openSubmenu:e.openSubmenuId};i.contextMenu=t,i.contextMenuRects=[]}function ze(i){i.contextMenu=null,i.contextMenuRects=[]}function ln(i){const e=i.contextMenu;if(!e||!e.visible)return;const t=i.ctx;t.save();const s=i.scale(32),n=i.scale(220),r=i.scale(8),o=i.scale(24),a=e.items??[],l=a.length*s+r*2;let d=e.x,h=e.y;d+n>i.canvas.width&&(d=i.canvas.width-n-i.scale(10)),h+l>i.canvas.height&&(h=i.canvas.height-l-i.scale(10)),t.fillStyle="rgba(0, 0, 0, 0.4)",t.fillRect(d+3,h+3,n,l),t.fillStyle="#1e293b",t.fillRect(d,h,n,l),t.strokeStyle="#374151",t.lineWidth=1,t.strokeRect(d+.5,h+.5,n-1,l-1),i.contextMenuRects=[];let c=h+r;for(let f=0;f<a.length;f++){const u=a[f],A=c+f*s,g={item:u,x:d,y:A,w:n,h:s},p=u.enabled!==!1,w=Oi(i.mouse.x*i.DPR,i.mouse.y*i.DPR,g);i.contextMenuRects.push(g),w&&p&&(t.fillStyle="#374151",t.fillRect(d+1,A,n-2,s));const k=u.submenu&&e.openSubmenu===u.id;k&&(t.fillStyle="#475569",t.fillRect(d+1,A,n-2,s));const M=u.icon??"";if(t.fillStyle=p?"#f1f5f9":"#6b7280",t.font=i.getScaledFont(16,"400"),t.textAlign="left",t.textBaseline="middle",M&&t.fillText(M,d+r,A+s/2),t.fillStyle=p?"#f1f5f9":"#6b7280",t.font=i.getScaledFont(14,"400"),t.fillText(u.label,d+r+(M?o:0),A+s/2),u.submenu&&u.submenu.length>0){t.fillStyle=p?"#9ca3af":"#4b5563";const x=k?"▼":"▶";t.fillText(x,d+n-r-i.scale(16),A+s/2),k&&cn(i,u,d+n+i.scale(5),A)}}t.restore()}function cn(i,e,t,s){const n=e.submenu??[];if(n.length===0)return;const r=i.ctx,o=i.scale(30),a=i.scale(200),l=i.scale(8),d=i.scale(22),h=n.length*o+l*2;let c=t,f=s;c+a>i.canvas.width&&(c=t-a-i.scale(225)),f+h>i.canvas.height&&(f=i.canvas.height-h-i.scale(10)),r.fillStyle="rgba(0, 0, 0, 0.4)",r.fillRect(c+3,f+3,a,h),r.fillStyle="#1e293b",r.fillRect(c,f,a,h),r.strokeStyle="#374151",r.strokeRect(c+.5,f+.5,a-1,h-1);for(let u=0;u<n.length;u++){const A=n[u],g=f+l+u*o,p=A.enabled!==!1,w={item:A,x:c,y:g,w:a,h:o,isSubmenu:!0,parentId:e.id},k=Oi(i.mouse.x*i.DPR,i.mouse.y*i.DPR,w);i.contextMenuRects.push(w),k&&p&&(r.fillStyle="#374151",r.fillRect(c+1,g,a-2,o));const M=A.icon??"";r.fillStyle=p?"#f1f5f9":"#6b7280",r.font=i.getScaledFont(14,"400"),r.textAlign="left",r.textBaseline="middle",M&&r.fillText(M,c+l,g+o/2),r.fillStyle=p?"#f1f5f9":"#6b7280",r.font=i.getScaledFont(13,"400"),r.fillText(A.label,c+l+(M?d:0),g+o/2)}}function Oi(i,e,t){return i>=t.x&&i<=t.x+t.w&&e>=t.y&&e<=t.y+t.h}function Zt(i,e,t,s){const n=dn(i,e,t,s);Ni(i,n)}function dn(i,e,t,s){var w,k;const n=!e.task||e.task==="idle",r=e.hp<50,o=(e.hunger||0)>60,a=(e.fatigue||0)>60,l=((w=e.health)==null?void 0:w.injuries)??[],d=l.length>0,h=l.some(M=>M.bleeding>0),c=l.some(M=>M.infected),f=(((k=e.health)==null?void 0:k.totalPain)||0)>.3,u=l.some(M=>M.type==="gunshot"||M.type==="fracture"&&M.severity>.6),A=e.state==="downed",g=[];A&&g.push({id:"medical_rescue",label:"Rescue (Carry to Bed)",icon:"🚑",enabled:!0}),h&&(g.push({id:"medical_bandage",label:"Bandage Wounds",icon:"🩹",enabled:!0}),g.push({id:"medical_bandage_all_bleeding",label:"Bandage All Bleeding",icon:"🩸",enabled:!0})),c&&g.push({id:"medical_treat_infection",label:"Treat Infection",icon:"💊",enabled:!0}),u&&g.push({id:"medical_surgery",label:"Surgery",icon:"⚕️",enabled:!0}),f&&g.push({id:"medical_pain_relief",label:"Pain Relief",icon:"💉",enabled:!0}),d&&(g.push({id:"medical_treat_all",label:"Treat All Injuries",icon:"🏥",enabled:!0}),g.push({id:"medical_rest",label:"Bed Rest",icon:"🛌",enabled:!0}),g.push({id:"medical_injury_summary",label:"Injury Summary",icon:"📋",enabled:!0})),g.length===0&&r&&g.push({id:"medical_treat",label:"Basic Treatment",icon:"🩹",enabled:!0});const p=[{id:"draft",label:e.isDrafted?"Undraft":"Draft",icon:e.isDrafted?"⚔️":"🎯",enabled:!0},{id:"prioritize",label:"Prioritize",icon:"⚡",enabled:!0,submenu:[{id:"prioritize_medical",label:"Medical Work",icon:"🏥",enabled:!0},{id:"prioritize_work",label:"Work Tasks",icon:"🔨",enabled:!0},{id:"prioritize_build",label:"Construction",icon:"🏗️",enabled:!0},{id:"prioritize_haul",label:"Hauling",icon:"📦",enabled:!0},{id:"prioritize_research",label:"Research",icon:"🔬",enabled:!0},...i.selColonist&&i.selColonist!==e&&(d||r)?(()=>{var C,b;const M=i.selColonist,x=M.assignedMedicalPatientId&&M.assignedMedicalPatientId===e.id;return[{id:x?"clear_prioritize_treat":"prioritize_treat_patient",label:x?`Clear Treat ${((C=e.profile)==null?void 0:C.name)||"Patient"}`:`Treat ${((b=e.profile)==null?void 0:b.name)||"Patient"} First`,icon:"🩺",enabled:!0}]})():[]]},{id:"force",label:"Force",icon:"❗",enabled:!0,submenu:[{id:"force_rest",label:"Rest Now",icon:"😴",enabled:a},{id:"force_eat",label:"Eat Now",icon:"🍽️",enabled:o},{id:"force_work",label:"Work",icon:"⚒️",enabled:n},{id:"force_guard",label:"Guard Area",icon:"🛡️",enabled:!0}]},{id:"goto",label:"Go To",icon:"🎯",enabled:!0,submenu:[{id:"goto_hq",label:"HQ",icon:"🏠",enabled:!0},{id:"goto_safety",label:"Safe Room",icon:"🛡️",enabled:!0},{id:"goto_bed",label:"Nearest Bed",icon:"🛏️",enabled:!0},{id:"goto_food",label:"Food Storage",icon:"🥘",enabled:!0}]},{id:"medical",label:"Medical",icon:"🏥",enabled:d||r,submenu:g},{id:"cancel",label:"Cancel Current Task",icon:"❌",enabled:!!e.target},{id:"follow",label:i.follow&&i.selColonist===e?"Stop Following":"Follow",icon:"👁️",enabled:!0}];return{target:e,screenX:t,screenY:s,items:p,onSelect:({item:M})=>{i.handleContextMenuAction(M.id,e)}}}class hn{constructor(){v(this,"providers",new Map)}register(e,t){const s=e,n=this.providers.get(s)??[];n.push(t),this.providers.set(s,n)}collectItems(e,t){const s=[],n=this.providers.get(t.kind)??[],r=this.providers.get("*")??[];for(const o of[...r,...n]){const a=o({game:e,building:t});Array.isArray(a)&&a.length&&s.push(...a)}return s}}const Lt=new hn;function yt(i,e,t,s){const n=Lt.collectItems(i,e);return n.length?(Ni(i,{target:e,screenX:t,screenY:s,items:n}),!0):!1}Lt.register("bed",({game:i,building:e})=>{if(e.kind!=="bed")return null;const t=!!e.isMedicalBed;return[{id:"bed_medical_info",label:t?"Medical bed (patients only)":"Standard bed (rest only)",icon:"ℹ️",enabled:!1},{id:t?"bed_unset_medical":"bed_set_medical",label:t?"Unset Medical Bed":"Set as Medical Bed",icon:t?"🛌":"⚕️",enabled:!0,action:({game:r,target:o})=>{o.isMedicalBed=!o.isMedicalBed;const a=!!o.isMedicalBed;r.msg(a?"Bed designated as a medical bed":"Bed returned to standard use",a?"good":"info")}}]});let Ee=null,Ze=!1;function fn(i){i.inventory&&(Ee=i,Ze=!0)}function Kt(){Ee=null,Ze=!1}function $t(){return Ze}function un(i,e,t){if(!Ze||!Ee||!Ee.inventory)return;i.save(),i.setTransform(1,0,0,1,0,0);const s=Ee.inventory,n=Ee,r=Math.min(500,e*.85),o=Math.min(600,t*.75),a=(e-r)/2,l=(t-o)/2,d=16;i.fillStyle="rgba(0, 0, 0, 0.7)",i.fillRect(0,0,e,t),i.fillStyle="#1a2332",i.fillRect(a,l,r,o),i.strokeStyle="#3b4a5a",i.lineWidth=2,i.strokeRect(a,l,r,o);const h=60;i.fillStyle="#2d3e50",i.fillRect(a,l,r,h),i.fillStyle="#ffffff",i.font="bold 24px Arial, sans-serif",i.textAlign="left";const c=n.name||"Building";i.fillText(`${c} Inventory`,a+d,l+38);const f=40,u=a+r-f-d,A=l+(h-f)/2;i.fillStyle="#d32f2f",i.beginPath(),i.roundRect(u,A,f,f,6),i.fill(),i.strokeStyle="#fff",i.lineWidth=3,i.beginPath(),i.moveTo(u+12,A+12),i.lineTo(u+f-12,A+f-12),i.moveTo(u+f-12,A+12),i.lineTo(u+12,A+f-12),i.stroke();const g=l+h+d;i.fillStyle="#ffffff",i.font="16px Arial, sans-serif",i.textAlign="left";const p=s.items.length,w=s.capacity,k=Ms(n);i.fillText(`Slots: ${p}/${w}`,a+d,g),i.fillText(`Total Items: ${k}`,a+r-150,g);const M=g+30,x=60;if(s.items.length===0)i.fillStyle="#888888",i.font="italic 18px Arial, sans-serif",i.textAlign="center",i.fillText("No items stored",a+r/2,M+100);else{let b=M;for(const S of s.items){if(b+x>l+o-80)break;i.fillStyle="#2a3a4a",i.fillRect(a+d,b,r-d*2,x-8),i.strokeStyle="#3b4a5a",i.lineWidth=1,i.strokeRect(a+d,b,r-d*2,x-8);const T=xs(S.type);i.font="32px Arial, sans-serif",i.textAlign="left",i.fillText(T,a+d*2,b+40);const D=ks(S.type);i.fillStyle="#ffffff",i.font="bold 18px Arial, sans-serif",i.fillText(D,a+d*4+32,b+25),i.fillStyle="#90caf9",i.font="16px Arial, sans-serif";const I=S.maxStack||100;i.fillText(`Quantity: ${S.quantity}/${I}`,a+d*4+32,b+45);const O=a+r-120,z=b+20,H=80,j=20;i.fillStyle="#1a1a1a",i.fillRect(O,z,H,j);const Y=S.quantity/I,X=H*Y;let U="#4caf50";Y>.9&&(U="#ff9800"),Y>=1&&(U="#f44336"),i.fillStyle=U,i.fillRect(O,z,X,j),i.strokeStyle="#666",i.lineWidth=1,i.strokeRect(O,z,H,j),b+=x}}const C=l+o-50;i.fillStyle="#2d3e50",i.fillRect(a,C,r,50),i.fillStyle="#aaaaaa",i.font="14px Arial, sans-serif",i.textAlign="center",i.fillText("Click outside or press X to close",a+r/2,C+30),i.restore()}function _t(i,e,t,s){if(!Ze||!Ee)return!1;const n=Math.min(500,t*.85),r=Math.min(600,s*.75),o=(t-n)/2,a=(s-r)/2,l=16,d=60,h=40,c=o+n-h-l,f=a+(d-h)/2;return(i>=c&&i<=c+h&&e>=f&&e<=f+h||!(i>=o&&i<=o+n&&e>=a&&e<=a+r))&&Kt(),!0}Lt.register("*",({game:i,building:e})=>{if(!e.inventory||!e.done)return null;const t=[],s=e.inventory.items.reduce((o,a)=>o+a.quantity,0),n=e.inventory.items.length,r=e.inventory.capacity;return t.push({id:"view_inventory",label:`View Inventory (${s} items, ${n}/${r} slots)`,icon:"📦",enabled:!0,action:({target:o})=>{fn(o)}}),t});function Ke(i,e,t,s){const n=e.w??e.size.w*m,r=e.h??e.size.h*m,o={x:t,y:s,w:n,h:r};if(o.x<0||o.y<0||o.x+o.w>G.w||o.y+o.h>G.h)return!1;for(const l of i.buildings)if(!(o.x+o.w<=l.x||o.x>=l.x+l.w||o.y+o.h<=l.y||o.y>=l.y+l.h))return!1;const a=(l,d)=>{const h=Math.max(d.x,Math.min(l.x,d.x+d.w)),c=Math.max(d.y,Math.min(l.y,d.y+d.h)),f=l.x-h,u=l.y-c;return f*f+u*u<=l.r*l.r};for(const l of i.trees)if(a(l,o))return!1;for(const l of i.rocks)if(a(l,o))return!1;return!0}function Wt(i,e,t,s,n){const r=J[e];if(!r)return;if(r.isFloor&&r.floorType){const a=Math.floor(t/m),l=Math.floor(s/m);if(a<0||l<0||a>=i.grid.cols||l>=i.grid.rows){i.toast("Can't place here");return}const d=l*i.grid.cols+a;if(qe(i.terrainGrid.floors[d])!==$.NONE){i.toast("Floor already exists here");return}const c=a*m,f=l*m;if(i.buildings.some(g=>!(c+m<=g.x||c>=g.x+g.w||f+m<=g.y||f>=g.y+g.h))){i.toast("Can't place floor under building");return}if(!Fe(i.RES,r.cost)){i.toast("Not enough resources");return}ot(i.RES,r.cost);const A=Ye(e,c+1,f+1);A.isFloorConstruction=!0,A.floorType=r.floorType,i.buildings.push(A),i.rebuildNavGrid(),i.toast(`Placed ${r.name} blueprint`);return}const o=Ye(e,t,s);if(n&&(o.rot=n,n===90||n===270)){const a=o.w;o.w=o.h,o.h=a}if(!Ke(i,o,o.x,o.y)){i.toast("Can't place here");return}if(!Fe(i.RES,r.cost)){i.toast("Not enough resources");return}if(ot(i.RES,r.cost),o.kind!=="path")for(let a=i.buildings.length-1;a>=0;a--){const l=i.buildings[a];l.kind==="path"&&!(o.x+o.w<=l.x||o.x>=l.x+l.w||o.y+o.h<=l.y||o.y>=l.y+l.h)&&i.buildings.splice(a,1)}i.buildings.push(o),i.rebuildNavGrid()}function gn(i){const e=i.selectedBuild;if(!(!e||!J[e])){if(!i.debug.forceDesktopMode&&i.isActuallyTouchDevice&&i.lastInputWasTouch){const s=Math.floor(i.mouse.wx/m)*m,n=Math.floor(i.mouse.wy/m)*m;i.pendingPlacement={key:e,x:s,y:n,rot:0};return}Wt(i,e,i.mouse.wx,i.mouse.wy)}}function An(i,e,t){if(!i.pendingPlacement)return;const s=J[i.pendingPlacement.key],n=i.pendingPlacement.x+e*m,r=i.pendingPlacement.y+t*m,o=i.pendingPlacement.rot||0,a=o===90||o===270,l=(a?s.size.h:s.size.w)*m,d=(a?s.size.w:s.size.h)*m;i.pendingPlacement.x=te(n,0,G.w-l),i.pendingPlacement.y=te(r,0,G.h-d)}function pn(i,e){if(!i.pendingPlacement)return;const t=J[i.pendingPlacement.key],s=((i.pendingPlacement.rot||0)+e+360)%360;i.pendingPlacement.rot=s;const n=s===90||s===270,r=(n?t.size.h:t.size.w)*m,o=(n?t.size.w:t.size.h)*m;i.pendingPlacement.x=te(i.pendingPlacement.x,0,G.w-r),i.pendingPlacement.y=te(i.pendingPlacement.y,0,G.h-o)}function mn(i){if(!i.pendingPlacement)return;const{key:e,x:t,y:s,rot:n}=i.pendingPlacement,r=J[e],o=Ye(e,t+1,s+1);if(n&&(o.rot=n,n===90||n===270)){const l=o.w;o.w=o.h,o.h=l}if(!(Ke(i,o,o.x,o.y)&&Fe(i.RES,r.cost))){i.toast("Can't place here");return}i.pendingPlacement=null,Wt(i,e,t+1,s+1,n)}function yn(i){i.pendingPlacement=null}function bn(i,e=!1){const t=Math.floor(i.mouse.wx/m),s=Math.floor(i.mouse.wy/m);if(!e&&i.lastPaintCell&&i.lastPaintCell.gx===t&&i.lastPaintCell.gy===s)return;const n=i.selectedBuild?J[i.selectedBuild]:null;$.BASIC_PATH;let r=i.selectedBuild||"floor_path";n!=null&&n.isFloor&&n.floorType&&({BASIC_PATH:$.BASIC_PATH,STONE_ROAD:$.STONE_ROAD,WOODEN_FLOOR:$.WOODEN_FLOOR,CONCRETE:$.CONCRETE,METAL_FLOOR:$.METAL_FLOOR,CARPET:$.CARPET}[n.floorType]||$.BASIC_PATH);const o=(p,w)=>{if(p<0||w<0||p>=i.grid.cols||w>=i.grid.rows)return;const k=w*i.grid.cols+p;if(qe(i.terrainGrid.floors[k])!==$.NONE)return;const x=p*m,C=w*m;if(i.buildings.some(D=>!(x+m<=D.x||x>=D.x+D.w||C+m<=D.y||C>=D.y+D.h)))return;const S=(n==null?void 0:n.cost)||{wood:0};if(!Fe(i.RES,S))return;ot(i.RES,S);const T=Ye(r,x+1,C+1);T.isFloorConstruction=!0,T.floorType=(n==null?void 0:n.floorType)||"BASIC_PATH",i.buildings.push(T)};if(i.lastPaintCell==null){o(t,s),i.lastPaintCell={gx:t,gy:s},i.rebuildNavGrid();return}let a=i.lastPaintCell.gx,l=i.lastPaintCell.gy,d=t,h=s;const c=Math.abs(d-a),f=Math.abs(h-l),u=a<d?1:-1,A=l<h?1:-1;let g=c-f;for(;o(a,l),!(a===d&&l===h);){const p=2*g;p>-f&&(g-=f,a+=u),p<c&&(g+=c,l+=A)}i.lastPaintCell={gx:t,gy:s},i.rebuildNavGrid()}function wn(i,e=!1){const t=Math.floor(i.mouse.wx/m),s=Math.floor(i.mouse.wy/m);if(!e&&i.lastPaintCell&&i.lastPaintCell.gx===t&&i.lastPaintCell.gy===s)return;const n=(A,g)=>{const p=A*m+1,w=g*m+1,k=Ye("wall",p,w);i.buildings.some(x=>x.kind==="wall"&&x.x===k.x&&x.y===k.y)||Fe(i.RES,J.wall.cost)&&Ke(i,k,k.x,k.y)&&(ot(i.RES,J.wall.cost),i.buildings.push(k))};if(i.lastPaintCell==null){n(t,s),i.lastPaintCell={gx:t,gy:s},i.rebuildNavGrid();return}let r=i.lastPaintCell.gx,o=i.lastPaintCell.gy,a=t,l=s;const d=Math.abs(a-r),h=Math.abs(l-o),c=r<a?1:-1,f=o<l?1:-1;let u=d-h;for(;n(r,o),!(r===a&&o===l);){const A=2*u;A>-h&&(u-=h,r+=c),A<d&&(u+=d,o+=f)}i.lastPaintCell={gx:t,gy:s},i.rebuildNavGrid()}function vn(i,e){const t=i.buildings.length;for(let n=i.buildings.length-1;n>=0;n--){const r=i.buildings[n];if(r.kind==="hq")continue;!(e.x+e.w<=r.x||e.x>=r.x+r.w||e.y+e.h<=r.y||e.y>=r.y+r.h)&&(zt(i,r),i.buildings.splice(n,1),i.buildReservations.delete(r),i.insideCounts.delete(r))}const s=t-i.buildings.length;s>0&&(i.msg(`Removed ${s} structure(s)`),i.rebuildNavGrid())}function Mn(i){const e={x:i.mouse.wx,y:i.mouse.wy};for(let t=i.buildings.length-1;t>=0;t--){const s=i.buildings[t];if(s.kind!=="hq"&&e.x>=s.x&&e.x<=s.x+s.w&&e.y>=s.y&&e.y<=s.y+s.h){zt(i,s),i.buildings.splice(t,1),i.msg("Building removed"),i.rebuildNavGrid();return}}i.selectedBuild=null,i.toast("Build canceled")}function zt(i,e){const t=e.x+e.w/2,s=e.y+e.h/2;for(const n of i.colonists){if(n.inside===e){i.leaveBuilding(n),n.safeTarget=null,n.safeTimer=0;const r=Math.random()*Math.PI*2,o=(e.w/2+10)*Math.cos(r),a=(e.h/2+10)*Math.sin(r);n.x=te(t+o,0,G.w),n.y=te(s+a,0,G.h)}n.reservedSleepFor===e&&(i.releaseSleepReservation(n),n.sleepTarget=void 0,n.sleepTargetLockUntil=0)}}const kn="data:image/png;base64,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",xn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAwCAYAAABwrHhvAAAAAXNSR0IArs4c6QAAAX5JREFUWIXtlT1ug0AQhcdpkj51hBuLLnfwFbjD0CIfgIoDuKOI78AVcpUg105ad6TJQ+Nhf1hix1I0n4QE7O57s38zRIZhGIZhGIYRoWrz4Zb6D/pH0WSjYdXmw/F0niUkx/0aiElRbbDdrSff6IO2xUEVTQYxDhm4xsm2OWMmW0BE1NV9KT6ZiPh9/7FSQqyGMRHR6+bROQbvKbB4sJz8E8CFOdqqNh/ku+qvAw6bV20+4AaoLZkIoR2m+IdvMX5CaFm4aLK3l+cnOp7O2JaDrzMMxPYd5C3q6t7p5TwDEOjqvhTX0GuujMcJCPOSErdgRN+GCHKLOLRtf8VdzW9DKDuClPoROoTRIL4+V5NAUurHLBOIilmxTrmyf0r9iAaAZOKqC+TIhkvqRwjWonIVfP3JkcK3u/XgCjqKFhSrIdsvgtDm5KkfcxnFMPtAfk+qH1H0IYQYhD0Zkn3nZhG6tOKJiAerXwr6EErD4MyuMnsZxLXEFgdxT3Pj//MNvPQlpMCKHrIAAAAASUVORK5CYII=",Sn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAwCAYAAABwrHhvAAAAAXNSR0IArs4c6QAAA/VJREFUWIXtVjFrG0kU/jYEZLa5tQWb5JCRmxCSQpw6FUfATcpA5OJKFWY3xk3wD5AL6wcIN0FZ4cJlCqlImUZNCnc24rjD5OAkEL6cCnmdQhDwsVdE3+TN7KwiX1Ideo3Q7Lz3vve9N98MsLSlLW1p/ydrdSrJTX1ufU8A43h6Y5+FALQ6lWSR6nzPxcFR6UYsLARgZ+vEAWANLoGN4yl8z7XGyCpg4RZkBR/HU7Q6laTaKCb7230r0FankmS1JwUgC2lWcN9zMY6n6NaHTrVRTEyg3E//rwKYB8LGAttDn/3tviOrJcAsSwEw+11tFBUY33PV93KtkDCxyULv149aTFv1BHzLXLDRSBCv330Ak58ejxz21mRBGn3M5GRFAeAwAcDZxRXIQrc+VBX/8vNdtYdBzOq69aGzuvYZx+behgJERk0/BYALP/34A4DPrZAsPHu8BgB49WaE0+ORYyY3e0/Wes2BU64VEsYy2dVmgB+fPLqHaqOYkL4///hHG6ZWp5KQJWlcu5x8IYXtoq+coxQAViErYQAA4HBx4ACdZlqvOdDacnBUUgyYM5E6BWcXV/A9V7VCDhv/s9LNvY2k1xw4L14+0EAQVDy5xunxyLEdRZ6i1Cno1ocOW1G6nwOAYMZOGE+uv3rjMTkZovmeq5LyVwMgJZUV5nM5AMDb3/4CADx/WlCVsHr6SxbICltH89Zuq/bwmwJAmtbzKwqQ77l48fJBBAAHR6WITIiYAQAc7p5bZRZAwPa9ejOCWb0GgJP58M4qmGiepPaaAwWk1akkD++sYj2/AmrAjJXIJt+SGW0IZZJqoxhZJDUEgG59qCU3wQMIDnfPw3wuB99z8frdB5wejzTmUlIsWXjy6J5aO9w9D4FMSY0IeGfrJBzHU82XlceTa1l9KP0y3wNSUqWwcBYYRKhh23bcxvFUVd9rDkIxS/oQ0iySGtG5XCtEs6raGVdzOHuWRVwzFdMEaWUgQ1KjeZI6034JrA1o89K2sDb/SbaopLY6lYRvARl8BrZNMED6baAB+BZJNd8TwJe7g99tL6NMBrIkdX+775iSurN14vAErOdXYB5fmu0GTQGYJ6mswCapkp3S/Zz2lCvXCknWDaoBmCepAIKziyvrhUIWfM9VMQRzgazevEOsLbBJKqCfClk9Wfv970tUG8Wk//6TWivXCpG3dlsWolkKgMFCQCWkHpiSKkAm9JX3hLTNvY3I/GZjILBVC6Ql1QJaAeq//8TTE/aag9CIp/bZALRZtbTLiaNJKvcKECFbtbm3YWPLykzmMZSbbYBkclh6ayYz/rexgAUicGD8z9w/O37m3kz/rGP3X00mWKjKpS3tX9TH+YSAxDb2AAAAAElFTkSuQmCC",Cn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAwCAYAAABwrHhvAAAAAXNSR0IArs4c6QAAA+pJREFUWIXtVrFqG0sUPasujbE3gd3OpFAcgjAYF8GBly6FCz+cIriUEbugL1iBPsCg/QLBChOXIUUMLlykS2GRIizoiYDiwiiVBI4wacxrvK+wzvjO7Kwiv5fqodsIzc6999xz75wZYGELW9jC/k+WdqvZfX1KvxPAaDy5t89cANJuNZunOt9zcXq8cy8W5gKwsXXkALAGl8BG4wl8z7XGKCpg7hYUBR+NJ0i71azdqmTbuydWoGm3mhW1JwegCGlRcN9zMRpPUG/0nXarkplAuZ/+vwQwC4SNBbaHPtu7J46slgCLLAfA7He7VVFgfM9V35u1csbEJgt/nQ21mLbqCbhkLthoJIiPH1Iw+cHhucPemixIo4+ZnKwoABwmABgOLkAW6o2+qvjV6w21h0HM6uqNvrP08AYAEEfrChAZNf0UAC6srj0GcNsKycIffz4FALxPznBweO6Yyc3ek7Uo7jnNWjljLJNdbQb48fnLTbRblYz0fR/8rQ1T2q1mZEka137+uAvLdtFXzlEOAKuQlTAAAHC4OHCATjMtintaW06PdxQD5kzkTsFwcAHfc1Ur5LDxPyuNo/UsinvOu7cVDQRBXV1e4+Dw3LEdRZ6i3CmoN/oOW7H67AYAgik74dXl9S9vPCYnQzTfc1VS/moApKSywqXlWxY+f/oCAHgTvlCVsHr6SxbICltHW370QLWH3xQA0rTi3QHyPRfv3lYSADg93knIhIgZAMDeft8qswACtu99cgazeg0AJ/PJ2iaYaJakRnFPAUm71ezJ2iZWPIAaMGUlscm3ZEYbQpmk3aokFkkNAaDe6GvJTfAAgr39fri0/Bi+5+LjhxQHh+caczkpliw8f6kCYW//NlmBpCYEvLF1FI7GE82XlV9dXsvqQ+lX+B6QkiqFhbPAIEINO7bjNhpPVPVR3AvFLOlDSLNIakLnZq2cTKvqFFzN4fRZlnDNVEwTpJWBAklNZknqVPslsA6gzUvHwtrsJ9m8kpp2qxnfAjL4FGyHYID820AD8F8k1XxPAHd3B7/bXkaFDBRJ6vbuiWNK6sbWkcMTsOLpiaXZbtAcgFmSygpskirZWX12oz3lmrVyVnSDagBmSSqAYDi4sF4oZMH3XBVDMBfI6s07xNoCm6QC+qmQ1ZO1b4MvaLcq2fBrSa01a+Vk+dEDWYhmOQAGCwGVkHpgSqoAmdFX3hPS4mg9Mb/ZGAhs1QJ5SbWAVoCGX0s8PWEU90IjntpnA9Bh1dJ+/ihpksq9AkTIVsXRuo0tKzOFx1ButgGSyWHprZnM+N/BHBaIwIHxv3D/9PiZewv9i47dvzWZYK4qF7awfwAJR/sa22/msgAAAABJRU5ErkJggg==",Rn=""+new URL("Male_Average_Normal_east-Dp-W028J.png",import.meta.url).href,Tn=""+new URL("Male_Average_Normal_north-jjTiChVU.png",import.meta.url).href,Pn=""+new URL("Male_Average_Normal_south-ChBeJhbM.png",import.meta.url).href,In="data:image/png;base64,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",Bn=""+new URL("Naked_Male_north-B44-odFG.png",import.meta.url).href,Dn=""+new URL("Naked_Male_south-BtPFzGMg.png",import.meta.url).href,En="data:image/png;base64,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",Fn="data:image/png;base64,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",Ln="data:image/png;base64,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",Wn="data:image/png;base64,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",zn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAEbAAABGwGN907lAAAHIklEQVR4nO2csU8bWRDGB9tEoBDJVYJCgU+4Z6Ncrj1TJdcdTaoo4poUqe6IFKWIdOQfCHfFpeWuyHUEUqYCCqoU2H0QKFIk0wCnREps73pP83izvF12weDFfgvfD0a7ttfr5zffzLzdt14CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICVDFxAtzhEVCGicb1O+rGwra1KRGtEtEpE+/1rLkiDEhHNE9EWEflnsCUi+vkyeiLrGYAd/zsRzaS0P84M/+jswYIo6udX9XJNZ44LkzWyLIAZHfXFuBcrlQo5jkPFYpHGx8epVCqp59fW1mh7e5uq1aqyLlgmordE9HdPvzVQLMSl+ZmZGX9pacnvlK2tLX9+ft4vlUpnKRtie0Q0lyREkD5HnM+OZ2d2w8rKil+pVGIFNTc3p9ZPEAoL4Vf4+3wJOb9YLJ4q4juBhWA6emFhIfSuDrLGErLB+TAXdf7GxkaqzjfhqE8SgRCXNbRtQATpUuml8wX+DIn04zINv8Ztiohg5SI5oJ8Uo8f3vXC+sLe3p6L8JNHxdo7jREUwd3ndlh7zZqdy/e0HPAg8owicXnXURaRkdiZHYj/hsQA7mB2dBAsEpSA9QqP+bg/10oAdzEI8TgTmAFJb6aI4pJeEov/58+e+53l9F4CvDwW5JCSJYHd3NyqA+cvjtvQI1f6PHz/6X79+tUYE7Pw4AbTbbb/ZbPoPHjwwBbBlayfnLGhDEsEEz/3792l4eJiazaYyz/P63jieY2Az8X2fWq0WNRoNunvvrvlSydYyULCgDXE45omU6elpajQbqoPFBgcHqVCwp/ntdls5X4m01aQ739+JblLSs41WYWsGCObmr127Rrdu3aJmo6lEwNH1rfFNLbmzueP7CYvRdd1Qu9iGhoZobGzMbFmlrw1NwNYMMCkrt2/fVo5v+21lfttXTm97bVUKOBOw5fN5Ghjo7ew2fz47nyPfNM4ArWaLbt68SZ8+feppm06LrQII0v/ExISKKHY6RxsvvbZ3aN6BcTlgO28hSBvY8WLK+W5YBCyA0dFR862TyXvtHzaPARRDw0OBACTyxZTzCx65nkuFfCEkArZcLpeKGGTcIWLjz/Nc71AA2vluyz3MAK0WXb9x3dyNlZNDmcgAUuvFJPILXkEJoOBqxxfySggiABGBZIWB3ACpv2NEwY6WpSo7nv5MzwuZcr4XzgJKAEYmYJHYjq0COAJ3csgRhQMBuAX3IPLzyQLI5XOUG8gFGcE0IeR4o9wEoosKwMwCnhaAMR7gbT5//mxPByZgqwC25bi5Vq3R5ORB+WRHyHkAdvygNxik/ljn53OUz2kRaOfzkq+EVCKIXBJpHmbKgJOzTTDo5MzjGgLwvNBYQEzE9GHzg7n7tR72X8dYL4A4uONlIGbW/cTo1wLgLHAk+kUDPv8fCiA42vAPnR+IwDsQgpQAEYI4PkvYLABFtValh/TwyAbmoIxTrhIACyEXiX6d/rn+yzKIfjMBaAHwv4p+KQVxWcA7HAdIuYhj88Nm7HeyCVsFUJOVSCfGInWaHSLRHmQAw+Lqv5QBcX6oBMSMA8zHx1Gv1+nLly/mFhDAKQgu2OdOZBFMlCdOfHfoUM11A0cH9V8ygI5+MwuYg8BABMZgUJ7rlFqtFt1yteM39xBbBSC/vFGHg+/evaPH5cen2oHpMHPyKIj8mENB08Hd1nMevBp09QuU88Tm2cBlWVlfX09tp2Z0R82M/m7grMWiNbAy+slyAbyVFa6naYrgvHmz+Cb6CX/a2lbbM0AwcFpcXOxvazqEoz/S1lVbB4BkuQCYF7LCNTULWeDVX6+io/8XyVv3H9sFEMoCMZ1rFXy0Eqn9yzbXfyZvQRuO4xsR/ScXiLDzeZr1zg9HrraxgmfPntHe7p7ZlJ9sv4+A7RmA9O/vgyji+hpzjN13uF2Rk1YvbK79QlZuEOHoH1wqRkZG6PW/r9XSBtjxjx49MlvCjv/OisadgO0lQKjrUnCPH/OM4Pv372lqaoquXLnS14ZxWXoy+yQ6NpnOQvRTBm8RE7qZ06QzSS9fvozdkM8d7OzsHCzrO8Fz9Z164s7LE+Ugq1wduUrlcplGro4knoZmp8/OzkZT/x9E9NsZv1/PyZoAivq3dsElYyyCp0+f0ubmpjpU5Dn4yGnYVGARjN4YVaLgz+QrlWKcz2OVqR71xaWlqMcD3dzX5zwskzeFyOpdwo5kgmPYNyZj9s2p5hh+NJ5yTuHQqo78zN06Lsu3iYsTgdzDr6YHYWmchHH01UmOvrS7EhEGn+z5Jav3DbwIt4qVX9xs93DkLdlh3+apXgAAAAAAAAAAAAAAAACXHgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAjRPQ/NSExxwDWb8cAAAAASUVORK5CYII=",Nn="data:image/png;base64,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",On=""+new URL("Bowlcut_east-BqNLAYRr.png",import.meta.url).href,Gn=""+new URL("Bowlcut_north-CedmSNiQ.png",import.meta.url).href,Hn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAAG0OVFdAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFHGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOCAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA5LTI4VDEzOjI5OjE4KzAxOjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wOS0yOFQxMzozMTozOCswMTowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAxOS0wOS0yOFQxMzozMTozOCswMTowMCIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiIHBob3Rvc2hvcDpJQ0NQcm9maWxlPSJzUkdCIElFQzYxOTY2LTIuMSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDphNGY4M2QzMi1kMTA0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",Yn="data:image/png;base64,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",qn="data:image/png;base64,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",Un="data:image/png;base64,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",Qn=""+new URL("Bravo_east-CJd2Z9hg.png",import.meta.url).href,jn=""+new URL("Bravo_north-D1RfI44O.png",import.meta.url).href,Xn=""+new URL("Bravo_south-BjW4bVxW.png",import.meta.url).href,Vn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAEbAAABGwGN907lAAAGB0lEQVR4nO3cPUwjRxQH8GeDgQKJLSmNjiIdW4IocCpacvSHaS9FTHOUWFTkChASoqDhQ7pIkbgzlyoUF0NBWpsCQYEUQGBxQgguIAUEYqI3zO6tl10WA/aOzf+HRl7wgpd9bz68O2MCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAjUVeUHAMIkoQUQ8RmaoYHvutENEOEa2r7XwIxwrPhAOcJKIcEYlHln+IaIKI4ghK9eDAp4no5AmB9yoZ1YrUjFrsAkwVKM8a29HRQYlEguLxOJmmWfTczs4O7e7u0srKiiz3WCKiIdVVgEZMr1rf3d0tpqenxUHhQFxdXYmHymQyIplM3tcipBH8cHC/PhvUt3d1dYmPnz6K4+NjcXZ2Ji4vL8XNzc2DE8BycnIi0um0MAzD63VyGB9UTp8alAX2152dnWJ/f18cHR2Jb/9+ExcXF48KvjsRUqmU1+udqGODMjFUjS9p0NbS0iKGh4dFoVAQ19fXTwq+UzabFaZper1mstoSoBoGgRz8rOrfba2trdTb20uv2l+R0WJQrCFGsViMLv67oO3tbSoUCnRwcEBra2tkGAbNzs5SX9/zVdLT01MaGhqiubk591ODRHTnh7rSPQHuBL+5uZne/vxWBp9FIhFqbGwsKk2NTUXfb25u0urqKiWTSZkMz4kTYHBw0P0XqyYJdE+ArPN9N9f20dFRWfstdXV1twFv8g4+F24ZysknCX5UVxK1Vq/xwaXdwR8fH5ctgBMnQLQuKh/9Srlxy8JcScDXItq4t6joWStR+c/O48TVCZS4xk9NTd0JfjQapfr6empoaJC1vCHWIMcC8jF2Oybg5yuBLypx97K8vGy9WhMR/UBEv2t6jiVdE6DoSh7XfGezb+EEsIJdFHxHEvA+ldLZ2Unr6+u0tbVlvSInwKrOVwwrd3YeLuFs+vv7+2Xz74WD6yx10bqix0oG38LvNlwDzZGKH0QJdEyAAWuDm/w3A288d+LRvzsB3IX3qTQO/shIUcwTOt9A0i0BDOfFFH6r5+73naKRKEWi3xPBuc0Dw7CkUil5s8nhl9AOJoBuCVBUU173v/bdkWu3DHgkWrRt1XzeDpP1zkDp85l8EjrdEqDH2uBBn9fAzyKDroqdBNb3ITX/TgMDA+4fadkN6JYA9hU/vm9/H2fAvUrYPOYb9IR+UB60TQC/kb/FDnLktuiYBDzxxMEM2j8MOg4Cpfb29sCd7WCrLysZdOFqxdAFlJudCJpwvRPQUk0lAJSuphJAqC94OG0T4PDwMHgnQSSE+B54a16OJniWse50SwD7/vnXw6/37mgF3gq6/N5VwsQzhiYnJz3/N53olgD2vfP8+v0rstzB3tjYoLW/12hsbEzO/gmr9uXzeTkvoK2tTW47fA7lgALoNiMopZZhyXsAn//wP2d8tW9vb48WFxdpJbtCZ2dnd/bh9+F8d67co3FOtqWlJVnjfRIvr2YIaTc5RLcEMNU8e2lmZsbzghCPDxYWFmj5z+U7z7nx3blsNntnFdBTWUGfn59313Q3bvp/0nVmkI5zAk+sC0I8F4AngDrxLN/3v76n8/Nzv9/Pu6+6cfBzuZzf/oE42FbhCR+8bCwg6KdqUuik7svHdEyAWeuWsLsb4OlWHHwX62TPO5ZyG6orsW/JZTIZe1o4T+LkmuuHB3ABAfazpPr6qpkWrqOEc7HFu+F34stfX+Sjz2rd+26z2quIeI2fUy6XC1r3V8qK4aSut3urlR241tZW8eG3D6K5ufkxq3DS1v68ksdvlU+JAc+q1kXbe/y1IOk86Y8MPqkg2b/nhVcAe6z4TTumcmk9pauW+a38nSjhf04EJYBrsefjR4rw7EyfVbilNLuBCeBa5DmLMOoloQZZWRWcUq/oFCVRPB4XExMTst8X3s1/1a3uhWAP/YCoUlsXqBLmA5MAH/dS45KqO/Gq+S82+C/pgyKd4qqc4oMgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAoOyI6H+0/9ACLISCdAAAAABJRU5ErkJggg==",Jn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAEbAAABGwGN907lAAAG4UlEQVR4nO2cv08cRxTH3/1yRXGdsZGtk3BFw6azRKTQUYLlKo1DWqdB/gdCylQ4RSw5De7iBhOXrkjjylK4a4iJjY6IAqqcjVzd7e1Gb3beMjvs4fsBt7Pn70ce7YHvbufmfef73swtSwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABcpTDhkakRkaebME9EDePnP4noUDcwASwS0SYRNYkoHKA19etWIIJ8sjJE0Hu1FhGtE1F10gdtElJATc/cxV5P8DyPqtUolrVajQ4PI7fnozzuwQciuqfTBHCQNT1bEzO5Wq2Ga2tr4c7OTtgP/Dx+fq1W6+UIqwi+W/B03k4L/ObmZl9B7wWLYXFxMU0EttCkZvDyNHCTAFv+rh0gnsGtVmuk4JtsbGwMUjNsfwn1ggt49kzkWd+v1Q8Ku8mAhSPc4Ao5F3zP8y511qexvr6eOB+LTWoGFh/qhfFQtZd4q6urVxp4Ew68uI0Ji29lZQVOMAZ2sgo+s7u7G587jZR6oYWa4PJYMweXZ1wWsOXz+VkMaZipwigMwYjUzLzP6/Srzvm9aDabqg8XFZwp6QDbyiOyaQ7oVVX7/fK51MPitArDJlLB8FSzzPtp9LPJlLJ0XM9rALImkfvZgvOCtZPY/LLDODxx5c8Dmie2t7dRC4xIwv5H3d/PAuuLpU1XB7roQB/SSGykLCwsONOxflleXjaf2fOr6qxxVQDxgN2+fZtuztykbrebbY8GIAgCW7Q1V/vqqgBibt26RX7Hp06nowbWdcIwJN/3aW5uzu6pky5QdqAPaXwjv5uZmVHBLxaLVCgU6Nq1a+roKn43EuuNGzec7aOJqwKIYfvnAS0UCyrw3CqVipMi4JnfaXdUf7lZOLkh5HwKCLoBtTttNbDq2OmogWardQmuUbh/qrWjft69e9fsoZPfEDrvADywHHyZ/QV9HWtIIVXKbjgBC1JEKkLlloeaxX0BBNHMsoOvHCAkKpfLqj7IAin4eLbzrE+IoN12zqXScFUAH+TB27/fqsFMCz4feZZxTVAqlcbaQT5vPPM7xsxvn7XT09Ox9mkYXBVAQ7ZPP55+VINJEnxKBl8aO8E43IDPq9ISB93vxEtUs04REezv75svrV9px4bEeQd498+7WAAKDn4QUhAGUdMC4KBwYxGwG1y2ECTwKvgSeEMAsQh0Otjb2+v5mVzCVQHEs+XTp090dHSkNoTimW8GvxuoOqHSrcQBYgFIk/2DYeBzmYHnxrYvzRaAKYI3b97YZ3Tyr4tcFUBisOr1Ok1PT58FP0jO/EoQBb/sl2MHsEUgQpDGyFHSChlBl/c23UUJoOtT19cuwEIQAfidhBB2/9rt+XlcwuVVQF3Wzo16g5aWltTAKvu3BKBcoNwlv+wrESSCXypSqXjmBLyhVCxE6SEWgK7WzeAroXWDcwLo6QJaAPy74+Njev36tflZXmYwfn3hsgBeigDMweQZmLD/is793bIKPosgFkAxEoA4AAfedgFBVhcsMLvAVIEPtAD8yAVMEYgA5AurF1sv7M/ybDxDNjguC+APIvqRdB3w6tUr5QKkl2BcaCn759wvs5/t3y+lC4CDr2e/Cr76l0wBsQOEQew0HHipM2IXSBGBuIj01eCZqwUg5SAFxGlga2srFoAgOZqDcW7269yvjgVdAxjfJxQiBUSEZyJQwbcc4JwAdBqQ85s8+fWJEoHBT+Mfuv5xfSfwF7ma5uD9gUoF9sUhshvHwSj6xfMCKJaimW+lgFQHMNJAothMEUDaLl+j0Uib/U7feiYPN4hoygUVvBJ4+ttTmpqauvAFcc63mpn/Ew4ghaCxzEy4gBaApIg0eNY/evRICVXDtv+V6wIY7/7pcHyUXUEe5NZ/LVr4+uJLxMxlnG3ZZg5XR6nk9TFe3uk9fj7ye31uX//xxmN77f+zrmOcJg8CqOuraZQLHBwcKCe4c+dO329gr+1T1/dGTu8n4CZcnzz//bnd52+H+bDjJi/3CJKbQsQXVdy/f58e/vAwsw6dnJyomoSXfPzYIBfWL+TpJlGL+m8FYtgJHnz3QBWGn6sLRoVz+/uD92pTios9K+gm9/Jg/ULe7hLGN1/YSLu8at6bJ2/eo+vT15UwmNnZ2b6EwbUFpxaBg8zUG/Xo/84Ku4vgGf897ih29Xhp9wjKsG3jL3+yYTUjIexoF5qIoE/KjSJX9D2Aa5d0/X1dF3Ns6//qnw9dvahjFCb9ZtGDiAG5GwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMBYIKL/AYYfZG8WNNkZAAAAAElFTkSuQmCC",Zn="data:image/png;base64,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",Kn=""+new URL("Cleopatra_east-B3qqZTHk.png",import.meta.url).href,$n=""+new URL("Cleopatra_north-DFb2lqEL.png",import.meta.url).href,_n=""+new URL("Cleopatra_south-DYRggimK.png",import.meta.url).href,eo="data:image/png;base64,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",to="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAEbAAABGwGN907lAAAKdElEQVR4nO2dT2wTSRaHn/9oVmIC8pwSzUooK8JlFhGPxImwg7lM5jArJsMBaUcCz4XRisNmstLsabNZiQsIgffAXDiEjMTcELBw4ZQgbU4cknBERDGTlYKEWDsoSMR2d69euapcVW7HjknSrz3vEy3bdNsp9/vVe69elbuBYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGiQMJtpJmUG4uc9E3bffoZQFkAOAradRh+foxAJSlURflvn/I4zJbfFZRvuc+ANzbw+/AdAEadRoAgjbbSgfHhG34vjwbhiZomFKXht3uttAiZMSKXgoBednzLbLZrNiQYrEIc3N2SM9kMpDP5+H06dOQy+WsfXj84uIiPH78GO7duydeO2A4OSXDCRMhebf35vP5YGVlJQhjeno6yOVyQTabDRYWFkKPCePu3bvB4OCg6ylKModgIqLJ+GjgTmglkK0olUpCXCHhgkUQAVk35ndq/PdlfHw8zBNkf3UWiJCMm8nvlfEV+PdYBNGxYJ587JFREOIJVtrUFJj3JOOO8zGhi5KQnGCWjbw75F23j5k8JmZRgyJ0RDDViwaIAuzx42GVu0wm01UmvxugCEOGiDl6pzNejLeq7FHp+SZYUwjJB5guyMg42mR47GV7ne1vh6mpKbfNPG+wTTJuhq8SPcqGN0HvxF6gO5qMjz1+dnaWjnU7AEvGXCXsDmt4d/To0eD169fkDR6GkxA2TVIxzXxlGv/IkSPB6n9Xg2q1Ss+6HeAUiEps7/boYd6BAweCZ8+eBevr60GlUiFv7DBCRgQkh4RJAm0AWT/XiysmJydh//794Ac++L4fbcu6BNcg4FoDAxbAFlhnamxsTBg/8AMhgCAIiDRzezgLTE5SbCMVAVisr69r48fZC5w8admc5CwhFQGUzReXLl2CcrlcF4AX7zBgkOmFNYS7iVX5++T3nwRrL9eCcrkcvHv3LvB9n16m1wYsVTuJ4DRXBlsz6Nb9C4WCqAO8ffs28DyPtLFbETJBpFYUk4BSDoBLbj+Vj4KbN2+C53vgefUtjpw7dy6s1VkqniBFoA0mmAusq9Lpq1evYOKvE5BKpSCVTInHRCI+K9kDCOD48ePw8W8/hlKpBKurq+buJQo/O6M4CrDW2L948UJ7gLh5AUxgsc1nz54Vm0O53fv3AvIC+OXFL+DVPKh5NXEy41QT0MKteXD16lVzF4a5W9G1rAHJOoCJzgFQBLVabLyAMj62+enTp677/549QGuswfPAwIA4iegB4uIFsH3K+PiI8d+BzC+MKQrAqp8O9A/UDV+re4FqrSpOLGXQawnRyg1fU4WiAP6inuRO5eo9v1YThlfGx41qdRBL17VqzWrrh/s+dA8jUxamJoCcWS797A+fWT1JbFUpiGqVXCjA9qj2mSI4fPiweygLoAW692Ps/3z085bGV/9HSQQq7pvtU57r2LFj5qFk5gTSBNqgGDTXzo2OjooTKIpAqhCUTEEylYREMgHJZFIUhXBLp6P/Gmh8NLzYVLiqNsSLgjYgMzVMSQBW8vf1ma9FnBciQMMnkw3jJ5JiE1VBWRiMUgSW8at1wyshKBH09/dH1r6toOYBBMPZYejr66vH1FpNG188GsZXAkhIFUQhAmX8SqXSUgT4uG/fvtDvGjWUBBCK8gJhxjfnBbDujoJBEezVfIGK92qrVMNFQHnUQloAy8+XYWZmBk6cOAFf/vHLetxPJqzer5ETrUoEeOxuoTyTMm6oCJw84OXLl2Zrmi42FBWUBKBPytLiEmxsbMDlK5eFCJaWlmD0i9FGzwfb+Kr34ybWEgaBTh530hvg38EJHnNkYiV+laolBvX/a2tr8OjRo9DvGjWUBGBNAuHKYDQ+gmJAo+IJ1QZ1er8lAL8uAPQE+KhGDN0iPtf3rfq+JYBatWUoePPmjfgu+B0MZvbonLaFmgCKKkFCL+CCRsCTCtBI/AAaxlcCwOPSqbQoweIjCsAUQidi0J/n+5bxmwRQMxI+x/h4rClkyS1Kl5+llgPMyEu3tsScDTRdv2l8sZA07UPKS4GX8urGTyX1cNJMIq1EMnA+Txnf9/TcvprgaRKA4wVwH7p9R8iLciaQDNQEUJBFki1/RGFNCTvuXxgt5eve7xpfCyBZzyXckQT+079JCBqrkkXv973G2oSaLQKd9RuTVSFx/xSVaWAFNQGoK29mpQiutzpQTQubiZ/qsSiAlN/o/WYhSQwl3VCQkKMIaM4lXA8ger+coBLPq7YXMMXp9P5/UjM+EB4GLppl4UNDh6ydOCoYHh6u5wSVqu2y0VBpD9JeWo8ELPcvK4lNAgDbm1iCkiJw8wDlBVSvx+NwuOeUfRVkMn8T8iuCEKwKmsz/Zx6uXL4iMmvsqaoSZ26blU29VTYrsLm5KTb9vFJ/7e7X7zOfy2P05282/oaqAKpCz483foz2ZG0T8pXAMLBUPPn3SXi+/ByuXbsmBKJ6ILr9tJ+2JpF0GVlWE3UxCRql5EDGANcDYBgQIcAZCSgvYFb4MOZvvN3o/IsQgLIHsApDJiMjI8LoOLyamJjQY2w1TNS92ejpTT3f7P2GFxC9Wz2vNPZZHsDp9SBrFT/N/BTBaXo/KAvAKgxh3Dc5c+aMeKVEYKKE4IYE8egY2RVK6GaEBTW+d9choOsX8b8/NP6ThboAtBdQMV+B08Uq2UIR4H4XUwhNxq40G155A0ssTo93DY9twr+thnxYslZtciA3AgCCvwxywfz8C5An+uGDh1D6Xwk++M0HYqVt/0A/PHnyRLxleXkZhoaG4ODBg6Ef1JTVe+FxXSw+lc9dg6NRC9cL8ODhA5GI4lLvQqGgvRPmJufPnxfPZ2dnddskf96rk7Yd4vA7q9lOr66BecHtn283jRp2AhTgN3/6xq3pa3CoqhJSPOa7C9+ZM4C4DHxsxxu1A8RhGDjW6Tr63UzE5ufnWxofQ9HFixeFF8JQgDmJM/17f1catQPE6Z5BObloNOusqCnLTf8feoEWxZiOuXPnjk40ETSqMRopygs+dHJZ+DlZ3SRJLApBkjnpDX4nhau2j9wTjL31fcCebhZ0MMaHlHU7mdRZpOr6FXESwFYUzTDhTMJosBd3EiKUgFRyd+PGDXN3Wf6tW0Z4cjN8NPy38noHJLN/Ra8IAMw4GzIEq68sWlwSS8wuXLjgxmiN2/tRMM7n/cswqkruPnK80qdUfv3bjl4SgLXIwi0cYUxXoEGdLF2DxlfJHg71UDAGxV67EUQvCaDlbBuKwQ0LaGRcrWOCIjGPM0UjIR3Pu6GXBBCKqtSFgZ5AGRx7fpuZvG/5DqG0sW4gefvn28H9f98PDg0dcq/Qdd28LvHIyEgwnB1ud99gvv9PDNDXGezr6wt++NsP4rHF3bymtjB2Se5XG9/3JyaE3mLGuTafKtzkWhyzwjd+jC9b9eq7IVU7957D1/mGj/Em7EZTCx1ckDH3azZ8nOYCOiUrDVqkuhCTYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRiGYRimKwDg/xtxOpbo1Rz+AAAAAElFTkSuQmCC",io="data:image/png;base64,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",so=""+new URL("Cute_east-DYRGxF50.png",import.meta.url).href,no=""+new URL("Cute_north-Dyfz5Iyy.png",import.meta.url).href,oo=""+new URL("Cute_south-CSpoY84q.png",import.meta.url).href,ao=""+new URL("Decent_east-DDtNv2Dw.png",import.meta.url).href,ro=""+new URL("Decent_north-DK7xoZDS.png",import.meta.url).href,lo=""+new URL("Decent_south-DVJAzXst.png",import.meta.url).href,co=""+new URL("Elder_east-CcqrTIrj.png",import.meta.url).href,ho=""+new URL("Elder_north-IBsD-VXD.png",import.meta.url).href,fo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAAG0OVFdAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFHGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOCAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA5LTI4VDEzOjU4OjMxKzAxOjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wOS0zMFQyMDoyMDoxMyswMTowMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAxOS0wOS0zMFQyMDoyMDoxMyswMTowMCIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiIHBob3Rvc2hvcDpJQ0NQcm9maWxlPSJzUkdCIElFQzYxOTY2LTIuMSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo0YzM4NTlhZS03YjM0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",uo=""+new URL("Fancybun_east-_VNdpRKg.png",import.meta.url).href,go=""+new URL("Fancybun_north-jN5WcBOL.png",import.meta.url).href,Ao=""+new URL("Fancybun_south-DplcV99p.png",import.meta.url).href,po="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAEbAAABGwGN907lAAAEWUlEQVR4nO3bv08bZxjA8cdxaRYj2MqELMHQIJA9sNWobJaY3H8gYWwVEJBK6WqUDmUiiAGJAcMW5EollRgJRsJKJZAwaga2ABNMZmBCwm/1vr077g6bGpSi8+vvJzm9vjtz3PE873M//FoAAAAAAAAAAAAAAAAAAAAAAAAAAABaVFpERp1d7xaRaRHZFpE/fMutE2uDbNXBHBeRlIgcisiqiFz41uvgFkQk6cwfO20ytJ1Zp72osw1ElO7VVRFRvunASQptPLSu2alaJ0EQMfWC7075ZoKfTCbvWl8g4NH22R+wzs5Of/Cq4eSYn58PBHh8fFxpdyTBdrv/gaMs7w/W2NiYWlpaatibV1ZWTLBzuZyZ162rUCiYZel0Wk1PT5MALcLr/f39/Wp3d1ft7e2p4eHhW8GfmJhQ19fXJty6CnR3d6tqteolgH6tE0K3+XyeBIi4bicwXqDe/PpGlctltb+/r4q/F28lwNHRkarVaibYBwcHXumvZ3R01LprgCcR2IcvaTt8z57JZMzNbiwWk2ffPpPJyUlv3cjIiCSTNxfz6XRapqammt2dk6gd/EPYlAB558rf09ffZ17q4JsnHjExAR4YGDDLdQK4yeHSSdBIpVLxr7HiOYAtCaBLv9d1e3p6TJtIJLw3xJx/+n+xWJSuri4ZGhoyS5t1cRGIeaXpH4wwWxIg53u4I69/ee0lgTjBdyuApoO/sbEhvb29Tf+CUqkUXnRc/52txZYE+N59oct+KpWS5y+e36yt08kHBwdNBWhWnfJPAkSIdyWX+S5j2mw2Kz3fOFXAvW4Xd1bde893dnb8s1aUf7HwLiBAnwrECbgJuu8m7r5JEDoF7DR+Z2uxLgEuLy9vL1RuowLJoJTyprusrq6GLwA3HuVgHoEtCeCV5HK5HFhhAiwqGOx7BF9bW1vzzx5zCogerySfnZ2Zyc8f7EZTI7Ozs+Hyv2DJ38ywJQECJfn8/Nx7XS/gNVW7tSxMl/yZmRnJ5/P+Nbr3v32sg3oMX1l0LBX3SeBh5dDcCrpMkGsq0NZqtcAUj8fNrZ6e9BW/fk4QOu9rPzz+Yf2/bEoAL1rhU4AJtqoF2tPTU9na2pKPf32UT39/kpOTOx/t623P2HTud9mUADvuB0H6QlDfDbiPgsM9fuHtgiwuLja73ZKtwdfiEdiHL0X30h/1tq6uruTp108llb45DegSH38Sl1c/v5L19fX/+pU62O9E5CcRmdNFJfqH/zC2jQoOfBy8vLzsfSLY0dEhc7/NyebmZvhnSk71KDlJZGVPbxdp/2CPvv4+9f7P92rrw5Z6OfEyPBhEjxpq/NkvWlZgPGA2mzVJkEgkwoNC235Yt80O/EmQSqfCvd/ab/rgX8k7vhPAYM42kWuQAPT+NpLzDRH/7HwbCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAeSkT+AUPibJk5WdyzAAAAAElFTkSuQmCC",mo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAEbAAABGwGN907lAAAE50lEQVR4nO3bPU8bSRjA8Qd8bZCTlsbXHSjSbYMo0rgkTeLLBwgOSm/zDeATEEoqA31EIkVKCW1eFLiCJkjYlwRxSARM7AtnjHdOM/aYycbGdg47rP3/SaNd74tnvc+zM+P1WgAAAAAAAAAAAAAAAAAAAAAAAAAAAACERCTkgYqJSEJE4iLyt4jke1hvUkR+E5GciPzbo3rhmBMRFSjJHpygZIN65whMb603CIIuxyIS7eKRRGt1NKo7cx1PVD9aaBIAW+Jd/MzxFnUvDG5YeiPmnvBoNKo2Nzd/WgLouvUxBOqPXacT1m8ywQBoPysBtAYJSFfQRfX+N5lMKitwFbYaCCZqTbUeRxzXynptWaLFvkm39bH0sQTGIegCr9HVr8Xj8Vb9cLQ2Um82gAsGcK7JYLI+/tB1Wg1aAY8EuHqJYPNrpdPpYADdflhftdk2Ah8s2UBr4rkJpOt0BfZt1ZLgB9S/93ue983JX19fb3YVNw28brYXFhZMCTThjRLhu9ZD1+nSx8R9ge6qJ4Db/DbphxsWvZ8dL+jAW3re9uuB7qRp8gQF9iMBuuDSBLgsCWKxmFpbWzPbJBIJs0xPreCyTCZj9mk3+A3GIaFJgF+uwTFcmUwmI9PT07K4uCj5fF6i0ajcv39fksmLrtzzPHn27JlZb9l5vU7T2+uyvLwsz58/r79XKpWSeLyb3zJ7r68SQNMBuixIbuBbrbOJ0M+G+/rTBegA66tanKvdndfrLkuQfjRQCeA2/bo5t+y8Xqe3GSShTIDq1+7Ozc/P1/dZWVlpOO9uMwhCmwDlcrmjRNja2jJTPZjTNjY26uvsvF1nt+3keH40KX+2UCfA2dmZVCqVtk6+7uez2Wz99e3bt6VUKpmi5y29jTs+aMX3/Y6T8ToJZQLok66Df1Y+M1MdgHYSwR3kPZp5JMViUYr/FGVmZsYscweJ7RyDTUI91a/RXd88inVwcKAOPx+qfD6vCoWC+vr1qyqVSqpcLqtKpaJ85X93s8be3JmcnFTZXFbl/spVSy5nltmbRs34vq/Oz89NPaenp6pYLKqTkxN1dHQUvGEUmu+OYboPkHNfHH4+lFs3b4kf8SUSiZgyPDxcn7plaGjI3BzK5apvoe8TLC0tyds3b83riYkJs+zVq1dmmydPnkg6na737broK9wW3drYqS7Hx9/9ApwLLriuhsJyoM7zeIYO4NTU1EXwI8MSGb6Ybm9vy5cvX0x58eKFrK6udlTZw4cP5d69ezIyMmKKHidU/Grg/Ypfna9Uk+Dly5fy+PFjd/ebPXxCeaBs2mZ2bGxM7ezsqN3dXdOMf/z0UT19+lTdvXu305992y537twxvyns7++rT3uf1IcPH1Q2m1Xj4+Pue2wOepC6Ke0GK/FHQr1+81q933mvUqnUjwR1rVY62m92dtYk3rt379SDBw+C69NhOqFh6gKsrPvAx40bN0wTvbe312q/jVqz/Gdt/uJGQFW8Vn6vdTeX/uozOjoqhULBdDEO3ff/+r8+HVry2ni0a+6KH8vymvwRJfgQCo+C9YjX5M8hm10OgtfkKaP1sAY/jF2Ay6s11dEmzXq32O4iX6uzs3vHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACDER+Q9xEDTIkulSxgAAAABJRU5ErkJggg==",yo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAEbAAABGwGN907lAAAFOElEQVR4nO3aT2sTaRzA8adbxYuSHHrx0saTnmzegDaCFqGX4NVL34CQgEfpZl9BoG8g116koXhy0SgIVnCJXZAuLvYPdu220k1TbbfVJr/lN2ZmnzzOWKlJ7Oj3Aw+dZJ6Z5+nzb57nyRgAAAAAAAAAAAAAAAAAAAAAAAAAAAAA6LpxY0zVGCPGmGljTLqHRZ5upSmtPIxT3b1VaBW+HWrGmGQPcpFspeWmXzhKBfQ9Gw8pfD/0oid+6/Q76qeY5TdljCn6H5LJpEmlUu75XuTh40Eq5eXBUuxRHjombg2gaA/zxWLRbQBDPchDkIamrXmwJO0Gis7K2MNtLpcTVSgU7CG42oMy9yeeXtpK8+I8Cno5If1hlPwCTiaTUqvVvMKfnp52C7+bQ3DKTkvTVpoXzZN1rvSjV1Y31Nze7xe+0wByIWmnW0Nzxe7BIaHailOM6MU5+xq/EYaMArX4Fe/R1jb8V6tVsWWzWbvwF63/JNWq0KgKPyhUnBFl0Y+vado0T869Mj96pXVS0PN0qHWVSqWwUSBsr+CwoeD2fk3T5TwGwkaiI6cvJg1AK+BnPchkMqZSqXwS4cyZM2ZpaSnyBrpcy2az3sx9eHjYXb6Zzc1NMzc3592jXC57n6PoPRYXFz85e+nSJfPgwQP/4y9x2ByKyzIwcVCEUil63pXL5cyTJ0/M1atXzYkTJ7wGoA3JDvqdntM4GlevOUxa6I5i1LPX5i7HUqmU92y+d++ed50GPY7ixtNr9R5hy88wmUwmdlvDcRkB6v7B54Zm3ZQpFP4vdx3O8/m8efjwYfDd8+fPI6+3z+k1eq39WNF7Oxs/6JFgQnfx4kXZ39+P7IWqUqlIOp1u67kDAwMyOjoaOQr4vX9sbExOnz7ddq3eS+95kDiOAHERNIALFy7Izr878uHDB2k2m5+tEp2p20P48ePHveuvX78uk5OT8u7dOy/osX6n5zSO/QgJm+2HaTQbMjIyQgPokmAJlkgkpF6vy/b2tuzt7R04GvgNwV6i3blzR2ZnZ2VmZsYLeqzf2UvNYrH4RRWvjVDzsLu7G8tlYFy0bQS9efPG24V7+/at7OzsyPv376XRaHy2onRC51eQ9myN7wetQH+k0DjuRlMUvU4boeZha2srlhtBx45AHr5E28zv2bNn5vz586bZbJr+Y/0f//b3B6Gvr89b0+uavF6ve/F18qhrf/2rE7u7v979WE1aWyLBZE/j6ORP/6bTaZNIJLxloh77cTW9RqPRFjQNR/RsFYcS9K6pqSl5tfJKVldXZX19XTb+2fAeCyt/rcitW7dkaGioUzuAbfOBiYkJWVtb83q8jj6bm5uysbEha+trcvv2bfcadFiwD3/jxg15ufBSlpeXZWVlRVb/XpVyuSyDg4NuJdRa+/mH+T3Av67t9a/BoUFvvqAVr43v9eprrzHm8m17EJ9uE+KrBZWoy7X5P+blxZ8vZGFhQfL5vFt5pYhf877kp+KwOGn752gNN2/e9Cp+aXnJa4zXrl1zGw86LFgKnj17VuZ+n5PHs4/l8uXLbs/r5ssYGXskujJ6RZ7+9lTm5+fl3LlzLAG7rO1lzPuV+15DsL6b7uFbwcFopBX/6NEjdwTiNfEuSNuFfPLkSbvAv8X+bPD7xKlTp9wGwCthXRL2Pv637G1hr4jzNlAXuS95HIWhNmutGIq8CdR9462GEKv37wEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8F4wx/wE9mUF5CNZnBwAAAABJRU5ErkJggg==",bo="data:image/png;base64,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",wo=""+new URL("Flowy_north-CjN0OhUN.png",import.meta.url).href,vo=""+new URL("Flowy_south-CP20N1Hd.png",import.meta.url).href,Mo=""+new URL("Fringe_east-D4I7-ug9.png",import.meta.url).href,ko=""+new URL("Fringe_north-BaR1__6m.png",import.meta.url).href,xo=""+new URL("Fringe_south-DYZWOYbC.png",import.meta.url).href,So="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAH/0lEQVR4nO3dT2gTWRwH8O9M/nSJsS2mHqoNnb2kJ7Wai61CZ702pR4XESoqEaGHFg+Cl+YoYtkqeEkRuxdFe9guCHpQOvUiRWurUDABMXtR8NJZFdoqmj0k6b68vkxmJmmTl/4+MJiZzkxe/H3nzUxnMgUIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhNSYUusGbIE+ABqAkwBa8681G8tl8sMSADP/79/Vbx7ZCi0AxgCsAMhWeRhDLlSkDrUA+APVLzo/3NmuD7TdZN4FHAJgINfNW4pEIti9e3fJnyuKAkVR8OLFC9GPTeR2If+6amWd89a6AS6VLH57ezt0XYeu6wgGg+jq6rJckaqq8Pl8RUMqlcL169cxOzuLb9++jaBBiw/IGYBOCIofDAZx6tQpxGIx7Nu3z/bKVFWFx+MpGpqbm9HV1YXOzs6JZDL5Z3WbX19kDEACXPH7+vqQSCQsu3kRRVHg8XigqupGED59+oR79+4tra6ujkxOTs5Vsd11SbZjgE7kTtU2xGIxJBIJVyvzer3w+Xzw+/3w+Xz48eMHbty4Ya6trWnJZLJhu32WWusGODTCjrS3t+PSpUuuV1bY6gs9wJs3b7C2tja1U4oPyBeAk+xIPB533O0XsIUvBOHt27fIZrMzVWmpJGQKQCeY3+gFg0Houu56ZXzxVVWm/4rqkelTa+xINBp1vfUrirKp+1dVFXv27IGiKFq55RuJTAHoZkfKnd9bYYvO9gL79+8H7F03aBgyBaDo1C8ajbpekSgAqqriwIEDyGazeqUNlYlMAaiKQvfP7/9VVcXevXsRiUT0eDzeUut2bpcdFwB+q+cD0dPTA3Cnm41sRweAL76qqjh27Bii0ejIhQsXDtW6rdthxwWgcOVPVPzCqeDp06dbA4HA1E7YFcgUgKVKV1Dq4I8PQCAQwOjoaPeuXbuMc+fOdVbc8jomUwBMdmRhYcHxCsoVX1H+vzQSDocxOjra3dzcPNPIuwOZAlDUA6yvr5ulZiyF7f5FAy8cDuPKlSvdbW1tM+fPnx+soO11y1PrBjiwjtylYACA1+v9ZWBgwNEKClf/vF6vcBCFIBAI4OjRo61+v//3YDCoHzlyxDx8+PDa4uKi1QWjPgD/OGpcjch2P4ABQAeAdDptwsbtYAVsN1/qQLCUQCCAgYEB9PT06A8fPtSfP3+eAfArAMTj8b+y2Wzr5ORkoW16fjEpLrVL0UjGHQBnCiNPnz7NtLS0aHYW9Hg88Pv98Pv9aGpq2nhdGHw+n+1GjI+PI5VK6YqiaKFQaKq/v988fvw4G8YM8gGpdzIdAwC5HmDDs2fPNLsLslu8qBdwoqOjA8hdm0jEYjF8//6d74kyjlZYQ7IFIMOOpNNp2wuKii86+rcjfyEqEQqFtN7eXszPz/MHpJnNS9Un2QJQdI+e0wDwxbc6A7DS0dEBRVFaY7EYAODly5f8LBX/zmK7yBYAgNm67P4uoFTX7zYAbW1tCIVC6O3tBQA8efKEn4UCsIUy7MiHDx/KLuD0/N+OixcvAgAWFhZM0zTZYwATXE9Vz2QMgMGO2NkNFIpczQCEw2EAwIMHDyzbV+9kDEARuwGodg9QkEwm+UlS3VQqYwAMdsTJLoB9XY0APHr0KMN1/wAFYHt9/PjR1nyiolcagJGREf70bwqSfY9QxgAUHWDZOROwKrzbACwvLxvpdLqbmzzhamU1JGMAHCtV+Eq2/sHBQY2bZAB47XqFNSJrAIrOs1OpVMkZ+S29Glv/9PS08e7dO42bnHC1shqTNQBF+96vX79aziwqeAVbvxmPx/mu34BE5/4sWQNgm1Xx3YTg2rVroiP/M27bV2sNEQCrXQBQveIDyFy+fJkvfgKS3PwhImsAio4Byu0CCird99+8eRMo/uqYCQmP/FmyBsD2/YBWRXcYBHNsbIzf+icg2Xk/T9YAuOZ2608mkxBc9JF66wd2YADcunr1Kj9pBpJv/QAFwJb5+fnM+/fvRQd/0pM1ANp2vtnt27f54huQ+Mif1RABiEQithfMZrOO32x6epqfNOV4JXVK1gAUsfOoGFHh7YRhZmZGdPDXMA+PlDUAGjsSDAYdLeykFzAMg58k1fX+choiAFbPC2KLXeq1FUEANk2QmYwBKHp2v51nBVUSgtevN13hpR6gxjR2pFwACkXOZrPC11YEW/8SGuDcnyVjAE6Wn6UYv9WzQbCSyWT4SYbT9653MgbA9jeCAXEPwI5bhUAQAGm+8GGXjAEo8uXLl7LziLp/O7uB1dVVab/zZ5f0AbBzU6hV8a1CIPjKl5R3/ViRMQBFW2U6nbYdAlHxSwVgZWXFfPXqlaPdjYxkDMCm07Dx8XHA4h4Bvvh2dgPDw8MN3/0D8gYgw05Ip9MYGhoyP3/+LAyB0wDcunXLuHv3rsZNNqrT/PoiYwD+heAmzOXlZe3EiRO4f/9+BlxAREX/+fPnxsCEYOns2bNLw8PDuuB9p6r5IeqFbM8IYg0hd0eOaD9tRqPRpf7+/taDBw9C0zSzqakJPp8Pon8fP37cOjExYc7NzXWXWJ8B4Lct/CzEpU4As9javxr6Pv8+pI4NAVhE9Yu/iNwfqSSSOITc3xKupFdYyS8/tM1trwmZjwHKaUHuUW56flwvOWfOUn5oiJs9CSGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQsgO8h+8bug09B+LWAAAAABJRU5ErkJggg==",Co=""+new URL("ShirtBasic_Male_north-D0Q-ZKK7.png",import.meta.url).href,Ro=""+new URL("ShirtBasic_Male_south-CIlSPWtc.png",import.meta.url).href,Pe=class Pe{constructor(){v(this,"images",new Map);v(this,"loaded",!1)}static getInstance(){return Pe.instance||(Pe.instance=new Pe),Pe.instance}async loadAssets(){const e=[{name:"house",path:kn},{name:"wheat_stage_1",path:xn},{name:"wheat_stage_2",path:Sn},{name:"wheat_stage_3",path:Cn}],t=[{name:"head_male_average_normal_east",path:Rn},{name:"head_male_average_normal_north",path:Tn},{name:"head_male_average_normal_south",path:Pn},{name:"body_naked_male_east",path:In},{name:"body_naked_male_north",path:Bn},{name:"body_naked_male_south",path:Dn},{name:"hair_afro_east",path:En},{name:"hair_afro_north",path:Fn},{name:"hair_afro_south",path:Ln},{name:"hair_bob_east",path:Wn},{name:"hair_bob_north",path:zn},{name:"hair_bob_south",path:Nn},{name:"hair_bowlcut_east",path:On},{name:"hair_bowlcut_north",path:Gn},{name:"hair_bowlcut_south",path:Hn},{name:"hair_braidbun_east",path:Yn},{name:"hair_braidbun_north",path:qn},{name:"hair_braidbun_south",path:Un},{name:"hair_bravo_east",path:Qn},{name:"hair_bravo_north",path:jn},{name:"hair_bravo_south",path:Xn},{name:"hair_burgundy_east",path:Vn},{name:"hair_burgundy_north",path:Jn},{name:"hair_burgundy_south",path:Zn},{name:"hair_cleopatra_east",path:Kn},{name:"hair_cleopatra_north",path:$n},{name:"hair_cleopatra_south",path:_n},{name:"hair_curly_east",path:eo},{name:"hair_curly_north",path:to},{name:"hair_curly_south",path:io},{name:"hair_cute_east",path:so},{name:"hair_cute_north",path:no},{name:"hair_cute_south",path:oo},{name:"hair_decent_east",path:ao},{name:"hair_decent_north",path:ro},{name:"hair_decent_south",path:lo},{name:"hair_elder_east",path:co},{name:"hair_elder_north",path:ho},{name:"hair_elder_south",path:fo},{name:"hair_fancybun_east",path:uo},{name:"hair_fancybun_north",path:go},{name:"hair_fancybun_south",path:Ao},{name:"hair_firestarter_east",path:po},{name:"hair_firestarter_north",path:mo},{name:"hair_firestarter_south",path:yo},{name:"hair_flowy_east",path:bo},{name:"hair_flowy_north",path:wo},{name:"hair_flowy_south",path:vo},{name:"hair_fringe_east",path:Mo},{name:"hair_fringe_north",path:ko},{name:"hair_fringe_south",path:xo},{name:"apparel_shirt_basic_male_east",path:So},{name:"apparel_shirt_basic_male_north",path:Co},{name:"apparel_shirt_basic_male_south",path:Ro}],n=[...e,...t].map(r=>this.loadImage(r.name,r.path));try{await Promise.all(n),this.loaded=!0}catch{console.warn("Some assets failed to load, continuing with fallbacks"),this.loaded=!0}}loadImage(e,t){return new Promise((s,n)=>{const r=new Image;r.onload=()=>{this.images.set(e,r),console.log(`Loaded image: ${e}`),s()},r.onerror=()=>{console.warn(`Failed to load image: ${e} from ${t}`),n(new Error(`Failed to load ${e}`))},r.src=t})}getImage(e){return this.images.get(e)||null}getColonistSprite(e,t,s){const n=`${e}_${t}_${s}`;return this.images.get(n)||null}getAvailableHairStyles(){return["afro","bob","bowlcut","braidbun","bravo","burgundy","cleopatra","curly","cute","decent","elder","fancybun","firestarter","flowy","fringe"]}getAvailableHeadTypes(){return["male_average_normal"]}getAvailableBodyTypes(){return["naked_male"]}getAvailableApparelTypes(){return["shirt_basic_male"]}isLoaded(){return this.loaded}};v(Pe,"instance");let pe=Pe;const Ne=[{id:"farmer",name:"Farmer",description:"Spent years working the fields, knows the land well.",skillModifiers:{farming:3,construction:1,strength:2},startingItems:["seeds","hoe"],rarity:"common"},{id:"laborer",name:"Laborer",description:"Hard physical work has made them strong and resilient.",skillModifiers:{construction:3,strength:3,endurance:2},startingItems:["hammer","nails"],rarity:"common"},{id:"merchant",name:"Merchant",description:"Skilled in trade and negotiation, knows the value of goods.",skillModifiers:{social:3,intelligence:2,trade:3},startingItems:["coin_purse","ledger"],rarity:"common"},{id:"hunter",name:"Hunter",description:"Experienced in tracking and survival in the wilderness.",skillModifiers:{shooting:3,animals:2,survival:3},startingItems:["bow","arrows"],rarity:"common"},{id:"soldier",name:"Soldier",description:"Military training has prepared them for combat and discipline.",skillModifiers:{shooting:4,melee:3,discipline:3,strength:2},startingItems:["rifle","armor"],rarity:"uncommon"},{id:"scholar",name:"Scholar",description:"Years of study have made them knowledgeable but physically weak.",skillModifiers:{research:4,intelligence:4,medicine:2,strength:-2},startingItems:["books","research_notes"],rarity:"uncommon"},{id:"engineer",name:"Engineer",description:"Technical expertise in building and maintaining complex systems.",skillModifiers:{construction:4,crafting:3,intelligence:3,repair:4},startingItems:["toolbox","blueprints"],rarity:"uncommon"},{id:"medic",name:"Medic",description:"Trained in healing and medical procedures.",skillModifiers:{medicine:4,intelligence:2,social:2,dexterity:2},startingItems:["medical_kit","bandages"],rarity:"uncommon"},{id:"noble",name:"Noble",description:"Born into privilege, skilled in leadership but lacks practical experience.",skillModifiers:{social:4,leadership:4,intelligence:2,construction:-2,farming:-2},startingItems:["fine_clothes","signet_ring"],rarity:"rare"},{id:"assassin",name:"Assassin",description:"Trained in stealth and precision, deadly but antisocial.",skillModifiers:{melee:4,stealth:5,dexterity:3,social:-3},startingItems:["poison","throwing_knives"],rarity:"rare"},{id:"witch",name:"Witch",description:"Practitioner of ancient arts, mysterious and powerful.",skillModifiers:{medicine:3,research:3,intelligence:3,social:-2},startingItems:["herbs","ritual_components"],rarity:"rare"},{id:"hero",name:"Hero",description:"A legendary figure with exceptional abilities in all areas.",skillModifiers:{shooting:3,melee:3,leadership:4,strength:3,intelligence:2},startingItems:["legendary_weapon","hero_medal"],rarity:"legendary"},{id:"mastermind",name:"Mastermind",description:"Brilliant strategist and inventor, capable of incredible feats.",skillModifiers:{intelligence:5,research:5,leadership:3,crafting:4},startingItems:["advanced_tools","invention_plans"],rarity:"legendary"}],ei=["Was a respected member of their community before the collapse.","Survived alone in the wilderness for months before joining the colony.","Lost their family in the great disaster and seeks a new beginning.","Was part of a failed expedition to establish another settlement.","Escaped from raiders who destroyed their previous home.","Voluntarily left their old life behind to join the colony.","Was rescued by the colony after being found injured and alone.","Brings tales of distant lands and strange discoveries.","Seeks redemption for past mistakes in their former life.","Dreams of rebuilding civilization better than it was before."];function To(i){let e=Ne;{const t=Math.random();t<.6?e=Ne.filter(s=>s.rarity==="common"):t<.85?e=Ne.filter(s=>s.rarity==="uncommon"):t<.98?e=Ne.filter(s=>s.rarity==="rare"):e=Ne.filter(s=>s.rarity==="legendary")}return e[Math.floor(Math.random()*e.length)]}function Po(){return ei[Math.floor(Math.random()*ei.length)]}const Nt=[{name:"Brown",hex:"#8B4513",rgb:[139,69,19],rarity:"common"},{name:"Black",hex:"#000000",rgb:[0,0,0],rarity:"common"},{name:"Blonde",hex:"#FFD700",rgb:[255,215,0],rarity:"common"},{name:"Dark Brown",hex:"#654321",rgb:[101,67,33],rarity:"common"},{name:"Auburn",hex:"#A0522D",rgb:[160,82,45],rarity:"uncommon"},{name:"Ginger",hex:"#FF6347",rgb:[255,99,71],rarity:"uncommon"},{name:"Strawberry Blonde",hex:"#FF8C69",rgb:[255,140,105],rarity:"uncommon"},{name:"Gray",hex:"#808080",rgb:[128,128,128],rarity:"uncommon"},{name:"White",hex:"#FFFFFF",rgb:[255,255,255],rarity:"rare"},{name:"Silver",hex:"#C0C0C0",rgb:[192,192,192],rarity:"rare"},{name:"Platinum Blonde",hex:"#F5F5DC",rgb:[245,245,220],rarity:"rare"}],Ot=[{name:"Fair",hex:"#FDBCB4",rgb:[253,188,180],rarity:"common"},{name:"Light",hex:"#F1C27D",rgb:[241,194,125],rarity:"common"},{name:"Medium",hex:"#E0AC69",rgb:[224,172,105],rarity:"common"},{name:"Olive",hex:"#C68642",rgb:[198,134,66],rarity:"common"},{name:"Tan",hex:"#8D5524",rgb:[141,85,36],rarity:"common"},{name:"Dark",hex:"#5C4033",rgb:[92,64,51],rarity:"common"},{name:"Deep",hex:"#3C2415",rgb:[60,36,21],rarity:"common"}],Gt=[{name:"Brown",hex:"#8B4513",rgb:[139,69,19],rarity:"common"},{name:"Blue",hex:"#4169E1",rgb:[65,105,225],rarity:"common"},{name:"Green",hex:"#228B22",rgb:[34,139,34],rarity:"common"},{name:"Hazel",hex:"#8FBC8F",rgb:[143,188,143],rarity:"common"},{name:"Gray",hex:"#808080",rgb:[128,128,128],rarity:"uncommon"},{name:"Amber",hex:"#FFBF00",rgb:[255,191,0],rarity:"uncommon"},{name:"Violet",hex:"#8A2BE2",rgb:[138,43,226],rarity:"rare"},{name:"Heterochromia",hex:"#FF1493",rgb:[255,20,147],rarity:"rare"}],ti=["afro","bob","bowlcut","braidbun","bravo","burgundy","cleopatra","curly","cute","decent","elder","fancybun","firestarter","flowy","fringe"],ii=["naked_male"],Io=[{name:"White",hex:"#FFFFFF",rgb:[255,255,255],rarity:"common"},{name:"Black",hex:"#000000",rgb:[0,0,0],rarity:"common"},{name:"Gray",hex:"#808080",rgb:[128,128,128],rarity:"common"},{name:"Brown",hex:"#8B4513",rgb:[139,69,19],rarity:"common"},{name:"Blue",hex:"#4169E1",rgb:[65,105,225],rarity:"common"},{name:"Red",hex:"#DC143C",rgb:[220,20,60],rarity:"common"},{name:"Green",hex:"#228B22",rgb:[34,139,34],rarity:"common"},{name:"Purple",hex:"#800080",rgb:[128,0,128],rarity:"uncommon"},{name:"Orange",hex:"#FF8C00",rgb:[255,140,0],rarity:"uncommon"},{name:"Yellow",hex:"#FFD700",rgb:[255,215,0],rarity:"uncommon"},{name:"Gold",hex:"#FFD700",rgb:[255,215,0],rarity:"rare"},{name:"Silver",hex:"#C0C0C0",rgb:[192,192,192],rarity:"rare"}];function it(i,e=!0){if(!e)return i[Math.floor(Math.random()*i.length)];const t=Math.random();let s;return t<.7?s=i.filter(n=>n.rarity==="common"):t<.9?s=i.filter(n=>n.rarity==="uncommon"):s=i.filter(n=>n.rarity==="rare"),s.length===0&&(s=i),s[Math.floor(Math.random()*s.length)]}function Bo(){return ti[Math.floor(Math.random()*ti.length)]}function Do(){return ii[Math.floor(Math.random()*ii.length)]}function Eo(){return{hairColor:it(Nt),hairStyle:Bo(),skinTone:it(Ot),eyeColor:it(Gt),bodyType:Do(),height:["short","average","tall"][Math.floor(Math.random()*3)],build:["slim","average","stocky","muscular"][Math.floor(Math.random()*4)]}}const Fo=[{id:"fleet_footed",name:"Fleet-Footed",description:"Moves faster than average due to natural agility.",type:"positive",category:"physical",effects:[{stat:"movementSpeed",modifier:1.25,type:"multiplicative",description:"+25% movement speed"}],rarity:"uncommon",conflictsWith:["sluggish"]},{id:"sluggish",name:"Sluggish",description:"Naturally slow-moving, but often more careful and precise.",type:"negative",category:"physical",effects:[{stat:"movementSpeed",modifier:.8,type:"multiplicative",description:"-20% movement speed"},{stat:"accuracy",modifier:1,type:"additive",description:"+1 accuracy due to carefulness"}],rarity:"common",conflictsWith:["fleet_footed","nimble"]},{id:"strong_back",name:"Strong Back",description:"Can carry more items and work longer without fatigue.",type:"positive",category:"physical",effects:[{stat:"carryCapacity",modifier:1.5,type:"multiplicative",description:"+50% carry capacity"},{stat:"construction",modifier:2,type:"additive",description:"+2 construction skill"}],rarity:"uncommon",conflictsWith:["frail"]},{id:"frail",name:"Frail",description:"Physically weak but often compensates with intelligence.",type:"negative",category:"physical",effects:[{stat:"health",modifier:.75,type:"multiplicative",description:"-25% max health"},{stat:"intelligence",modifier:2,type:"additive",description:"+2 intelligence"}],rarity:"common",conflictsWith:["strong_back","tough"]},{id:"tough",name:"Tough",description:"Naturally resilient and hard to hurt.",type:"positive",category:"physical",effects:[{stat:"health",modifier:1.3,type:"multiplicative",description:"+30% max health"},{stat:"painTolerance",modifier:3,type:"additive",description:"+3 pain tolerance"}],rarity:"uncommon",conflictsWith:["frail"]},{id:"nimble",name:"Nimble",description:"Quick reflexes and excellent hand-eye coordination.",type:"positive",category:"physical",effects:[{stat:"dexterity",modifier:3,type:"additive",description:"+3 dexterity"},{stat:"accuracy",modifier:2,type:"additive",description:"+2 accuracy"}],rarity:"uncommon",conflictsWith:["clumsy"]},{id:"clumsy",name:"Clumsy",description:"Prone to accidents but oddly endearing to others.",type:"negative",category:"physical",effects:[{stat:"dexterity",modifier:-2,type:"additive",description:"-2 dexterity"},{stat:"social",modifier:1,type:"additive",description:"+1 social (endearing clumsiness)"}],rarity:"common",conflictsWith:["nimble"]}],Lo=[{id:"quick_learner",name:"Quick Learner",description:"Gains experience and skills faster than others.",type:"positive",category:"mental",effects:[{stat:"experienceGain",modifier:1.5,type:"multiplicative",description:"+50% experience gain"}],rarity:"rare"},{id:"slow_learner",name:"Slow Learner",description:"Takes longer to learn new skills but retains them better.",type:"negative",category:"mental",effects:[{stat:"experienceGain",modifier:.7,type:"multiplicative",description:"-30% experience gain"},{stat:"skillRetention",modifier:1.2,type:"multiplicative",description:"+20% skill retention"}],rarity:"common"},{id:"photographic_memory",name:"Photographic Memory",description:"Never forgets anything and excels at research.",type:"positive",category:"mental",effects:[{stat:"research",modifier:4,type:"additive",description:"+4 research skill"},{stat:"intelligence",modifier:3,type:"additive",description:"+3 intelligence"}],rarity:"legendary"},{id:"absent_minded",name:"Absent-Minded",description:"Often forgets things but has moments of brilliant insight.",type:"negative",category:"mental",effects:[{stat:"taskCompletion",modifier:.85,type:"multiplicative",description:"-15% task completion rate"},{stat:"creativity",modifier:3,type:"additive",description:"+3 creativity bonus"}],rarity:"common"},{id:"perfectionist",name:"Perfectionist",description:"Works slower but produces higher quality results.",type:"neutral",category:"mental",effects:[{stat:"workSpeed",modifier:.8,type:"multiplicative",description:"-20% work speed"},{stat:"quality",modifier:1.4,type:"multiplicative",description:"+40% work quality"}],rarity:"uncommon"},{id:"focused",name:"Focused",description:"Excellent concentration allows for efficient work.",type:"positive",category:"mental",effects:[{stat:"workSpeed",modifier:1.2,type:"multiplicative",description:"+20% work speed"},{stat:"accuracy",modifier:2,type:"additive",description:"+2 accuracy"}],rarity:"uncommon"}],Wo=[{id:"charismatic",name:"Charismatic",description:"Natural leader who inspires others.",type:"positive",category:"social",effects:[{stat:"social",modifier:4,type:"additive",description:"+4 social skill"},{stat:"leadership",modifier:3,type:"additive",description:"+3 leadership"}],rarity:"rare"},{id:"antisocial",name:"Antisocial",description:"Prefers solitude but works well independently.",type:"negative",category:"social",effects:[{stat:"social",modifier:-3,type:"additive",description:"-3 social skill"},{stat:"independentWork",modifier:1.3,type:"multiplicative",description:"+30% efficiency when working alone"}],rarity:"common"},{id:"empathetic",name:"Empathetic",description:"Deeply understands others emotions and needs.",type:"positive",category:"social",effects:[{stat:"medicine",modifier:2,type:"additive",description:"+2 medicine (bedside manner)"},{stat:"social",modifier:2,type:"additive",description:"+2 social skill"},{stat:"moodImpact",modifier:1.2,type:"multiplicative",description:"+20% positive mood impact on others"}],rarity:"uncommon"},{id:"intimidating",name:"Intimidating",description:"Natural presence that can be useful in conflict.",type:"neutral",category:"social",effects:[{stat:"melee",modifier:2,type:"additive",description:"+2 melee (intimidation factor)"},{stat:"social",modifier:-1,type:"additive",description:"-1 social (can be off-putting)"},{stat:"conflictResolution",modifier:1.5,type:"multiplicative",description:"+50% conflict resolution through intimidation"}],rarity:"uncommon"}],zo=[{id:"green_thumb",name:"Green Thumb",description:"Plants seem to grow better under their care.",type:"positive",category:"special",effects:[{stat:"farming",modifier:4,type:"additive",description:"+4 farming skill"},{stat:"cropYield",modifier:1.25,type:"multiplicative",description:"+25% crop yield"},{stat:"plantGrowthSpeed",modifier:1.15,type:"multiplicative",description:"+15% plant growth speed"}],rarity:"rare"},{id:"animal_whisperer",name:"Animal Whisperer",description:"Has an uncanny ability to understand and work with animals.",type:"positive",category:"special",effects:[{stat:"animals",modifier:5,type:"additive",description:"+5 animal skill"},{stat:"animalProductivity",modifier:1.3,type:"multiplicative",description:"+30% animal productivity"},{stat:"tamingSpeed",modifier:2,type:"multiplicative",description:"100% faster animal taming"}],rarity:"rare"},{id:"night_owl",name:"Night Owl",description:"More productive during night hours.",type:"neutral",category:"special",effects:[{stat:"nightWorkBonus",modifier:1.5,type:"multiplicative",description:"+50% work efficiency at night"},{stat:"dayWorkPenalty",modifier:.9,type:"multiplicative",description:"-10% work efficiency during day"}],rarity:"uncommon"},{id:"early_bird",name:"Early Bird",description:"Most productive in the early morning hours.",type:"neutral",category:"special",effects:[{stat:"morningWorkBonus",modifier:1.4,type:"multiplicative",description:"+40% work efficiency in morning"},{stat:"eveningWorkPenalty",modifier:.9,type:"multiplicative",description:"-10% work efficiency in evening"}],rarity:"uncommon"},{id:"lucky",name:"Lucky",description:"Good things just seem to happen around them.",type:"positive",category:"special",effects:[{stat:"criticalSuccess",modifier:2,type:"multiplicative",description:"100% higher chance of critical success"},{stat:"resourceFind",modifier:1.2,type:"multiplicative",description:"+20% chance to find extra resources"}],rarity:"legendary"},{id:"jinxed",name:"Jinxed",description:"Prone to unfortunate accidents and bad luck.",type:"negative",category:"special",effects:[{stat:"criticalFailure",modifier:1.5,type:"multiplicative",description:"+50% chance of critical failure"},{stat:"equipmentBreakage",modifier:1.3,type:"multiplicative",description:"+30% equipment breakage rate"}],rarity:"uncommon"}],rt=[...Fo,...Lo,...Wo,...zo];function No(i,e){let t=rt;if(i&&(t=t.filter(s=>s.category===i)),e)t=t.filter(s=>s.rarity===e);else{const s=Math.random();s<.5?t=t.filter(n=>n.rarity==="common"):s<.8?t=t.filter(n=>n.rarity==="uncommon"):s<.95?t=t.filter(n=>n.rarity==="rare"):t=t.filter(n=>n.rarity==="legendary")}return t.length===0&&(t=rt),t[Math.floor(Math.random()*t.length)]}function Oo(i=2){const e=[],t=new Set;for(let s=0;s<i;s++){let n=0,r;do r=No(),n++;while((t.has(r.id)||r.conflictsWith&&r.conflictsWith.some(o=>t.has(o)))&&n<50);n<50&&(e.push(r),t.add(r.id))}return e}function Go(){return{background:To(),appearance:Eo(),passiveTraits:Oo(Math.floor(Math.random()*3)+1),originStory:Po()}}rt.map(i=>i.name);rt.map(i=>({name:i.name,description:i.description,effects:i.effects.reduce((e,t)=>(e[t.stat]=t.modifier,e),{}),rarity:i.rarity}));Nt.map(i=>i.name);Ot.map(i=>i.name);Gt.map(i=>i.name);Ne.map(i=>({name:i.name,description:i.description,effects:Object.entries(i.skillModifiers).reduce((e,[t,s])=>(e[t]=s,e),{}),startingSkills:i.startingItems||[]}));Ot.map(i=>i.hex),Nt.map(i=>i.hex),Gt.map(i=>i.hex);const ge={FIRST:["Alex","Jordan","Taylor","Casey","Morgan","Riley","Jamie","Avery","Quinn","Sage","River","Rowan","Phoenix","Dakota","Skyler","Emery","Emma","Liam","Olivia","Noah","Ava","Ethan","Sophia","Mason","Isabella","William","Mia","James","Charlotte","Benjamin","Amelia","Lucas"],LAST:["Smith","Johnson","Williams","Brown","Jones","Garcia","Miller","Davis","Rodriguez","Martinez","Hernandez","Lopez","Gonzalez","Wilson","Anderson","Thomas"]},Ho=["Fresh Bread","Roasted Vegetables","Berry Pie","Hearty Stew","Honey Cakes","Grilled Fish","Wild Mushrooms","Apple Cider","Cheese & Crackers","Herbal Tea"];function Qe(i){return i[Math.floor(Math.random()*i.length)]}const Yo=["Millhaven","Riverside","Oakwood","Stonecrest","Greenfield","Ashford","Fairview","Brookside","Clearwater","Redwood","Silverdale","Goldcrest","Ironport","Copper Hills","Crystal Lake","Shadowvale","Brightwater","Darkwood"],qo=[{event:"Lost a parent at a young age",impact:"negative"},{event:"Won a local competition",impact:"positive"},{event:"Survived a natural disaster",impact:"neutral"},{event:"Fell in love and got heartbroken",impact:"negative"},{event:"Started their own small business",impact:"positive"},{event:"Served in the local militia",impact:"neutral"},{event:"Lost everything in a fire",impact:"negative"},{event:"Saved someone's life",impact:"positive"},{event:"Was betrayed by a close friend",impact:"negative"},{event:"Discovered a hidden talent",impact:"positive"},{event:"Moved frequently as a child",impact:"neutral"},{event:"Inherited property from a relative",impact:"positive"}],Uo=["Cooking","Carpentry","Gardening","Mechanics","First Aid","Hunting","Fishing","Sewing","Music","Art","Writing","Leadership","Animal Care"],Qo=["heights","darkness","water","crowds","spiders","failure","abandonment","confined spaces","loud noises","authority figures"],jo=["once stole food to feed a starving family","has a photographic memory but hides it","is secretly afraid of butterflies","wrote anonymous love letters for years","saved someone's life and never told anyone","knows the location of hidden treasure","can't read but has never admitted it","has recurring dreams about flying"];class Xo{constructor(e){v(this,"seed");this.seed=e}next(){return this.seed=(this.seed*9301+49297)%233280,this.seed/233280}choice(e){return e[Math.floor(this.next()*e.length)]}choices(e,t){return[...e].sort(()=>this.next()-.5).slice(0,t)}range(e,t){return e+Math.floor(this.next()*(t-e+1))}}function Vo(i){let e=0;for(let t=0;t<i.length;t++){const s=i.charCodeAt(t);e=(e<<5)-e+s,e=e&e}return Math.abs(e)}function Jo(){const i=()=>.9+Math.random()*.2;return{workSpeed:Math.round(i()*100)/100,socialBonus:Math.round(i()*100)/100,hungerRate:Math.round(i()*100)/100,fatigueRate:Math.round(i()*100)/100}}function Zo(i,e,t){const s=i.choice(Yo),n=i.next()>.1,r=[];n&&(i.next()>.2&&r.push(`${i.choice(ge.FIRST)} ${t.split(" ")[1]} (Father)`),i.next()>.1&&r.push(`${i.choice(ge.FIRST)} ${i.choice(ge.LAST)} (Mother)`));const o=i.next()>.6?i.range(1,3):0,a=[];for(let M=0;M<o;M++){const x=i.choice(ge.FIRST),C=i.choice(["Brother","Sister"]);a.push(`${x} ${t.split(" ")[1]} (${C})`)}const l=e>25&&i.next()>.6?`${i.choice(ge.FIRST)} ${i.choice(ge.LAST)}`:void 0,d=l&&i.next()>.7?i.range(1,2):0,h=[];for(let M=0;M<d;M++){const x=i.choice(ge.FIRST),C=i.choice(["Son","Daughter"]);h.push(`${x} (${C})`)}const c=Math.min(i.range(2,5),Math.floor(e/8)),f=[];for(let M=0;M<c;M++){const x=i.choice(qo),C=i.range(8,e-2);f.push({age:C,...x})}f.sort((M,x)=>M.age-x.age);const u=i.choices(Uo,i.range(2,4)),A=i.choices(Qo,i.range(1,2)),g=i.next()>.7?[i.choice(jo)]:[],p=Math.min(i.range(1,3),Math.floor(e/12)),w=[],k=["Childhood Friend","Former Colleague","Neighbor","Mentor","Rival"];for(let M=0;M<p;M++){const x=`${i.choice(ge.FIRST)} ${i.choice(ge.LAST)}`,C=i.choice(k),b=i.choice(["good","bad","neutral"]);w.push({name:x,type:C,status:b})}return{birthplace:s,family:{parents:r,siblings:a,spouse:l,children:h},lifeEvents:f,skills:u,fears:A,secrets:g,relationships:w}}function Ko(i){const{name:e,age:t,detailedInfo:s,background:n}=i;if(!s)return"A mysterious person with an unknown past.";let r=`${e} is ${t} years old and was born in ${s.birthplace}. `;if(s.family.parents.length>0?r+=`Raised by ${s.family.parents.join(" and ")}, `:r+="Growing up without parents, ",s.family.siblings.length>0?r+=`they have ${s.family.siblings.length} sibling${s.family.siblings.length>1?"s":""}. `:r+="they were an only child. ",s.lifeEvents.length>0){const o=s.lifeEvents.filter(a=>a.impact!=="neutral").slice(0,2);o.length>0&&(r+="Key moments in their life include: ",r+=o.map(a=>`at age ${a.age}, ${a.event.toLowerCase()}`).join("; ")+". ")}return s.family.spouse&&(r+=`They are married to ${s.family.spouse}`,s.family.children.length>0&&(r+=` and have ${s.family.children.length} child${s.family.children.length>1?"ren":""}: ${s.family.children.join(", ")}`),r+=". "),s.skills.length>0&&(r+=`They are skilled in ${s.skills.slice(0,2).join(" and ")}. `),s.fears.length>0&&(r+=`Despite their strengths, they have a deep fear of ${s.fears[0]}. `),s.secrets.length>0&&(r+=`What few know is that they ${s.secrets[0]}.`),r}function $o(i,e,t){var h,c;const s={items:[],equipment:{},carryCapacity:50,currentWeight:0};_.loadItems();const n=_.getItemsForBackground(e);for(const f of n){const u=_.createItem(f,1,si(i));if(u)if(u.category==="Tool"||u.category==="Weapon"||u.category==="Armor"||u.category==="Helmet"){const A=_o(u.category);A&&!s.equipment[A]?s.equipment[A]=u:s.items.push(u)}else s.items.push(u)}if(t.includes("Cooking")){const f=_.createItem("Knife",1);f&&s.items.push(f)}if(t.includes("First Aid")){const f=_.createItem("MedicineKit",1);f&&s.items.push(f)}const r=["Bread","Bandages"];for(const f of r){const u=_.createItem(f,i.range(1,3));u&&s.items.push(u)}if(!s.equipment.armor){const f=_.createItem("WorkClothes",1);f&&(s.equipment.armor=f)}const o=e.toLowerCase();if(!(!!s.equipment.weapon&&(((h=s.equipment.weapon)==null?void 0:h.defName)==="Pistol"||((c=s.equipment.weapon)==null?void 0:c.defName)==="Rifle"))&&o!=="soldier"&&i.next()<.35){const f=_.createItem("Pistol",1,si(i));f&&(s.equipment.weapon=f)}let d=0;for(const f of s.items)d+=(f.weight||0)*f.quantity;for(const f of Object.values(s.equipment))f&&(d+=f.weight||0);return s.currentWeight=d,s}function _o(i){switch(i){case"Tool":return"tool";case"Weapon":return"weapon";case"Armor":return"armor";case"Helmet":return"helmet";default:return null}}function si(i){const e=i.range(0,1);return e<.05?"poor":e<.15?"awful":e<.6?"normal":e<.85?"good":e<.95?"excellent":e<.99?"masterwork":"legendary"}function ni(){console.log("DEBUG: Generating new colonist profile...");const i=Qe(ge.FIRST),e=Qe(ge.LAST),t=`${i} ${e}`,s=Vo(t),n=new Xo(s),r=n.range(20,55),o=Go();console.log("DEBUG: Generated traits:",o);const a=Zo(n,r,t),l=Qe(Ho),d={skinTone:o.appearance.skinTone.hex,hairColor:o.appearance.hairColor.hex,eyeColor:o.appearance.eyeColor.hex,clothing:it(Io).hex,sprites:{headType:Qe(pe.getInstance().getAvailableHeadTypes()),bodyType:o.appearance.bodyType,hairStyle:o.appearance.hairStyle,apparelType:Qe(pe.getInstance().getAvailableApparelTypes())}},h=Jo(),c={name:t,age:r,seed:s,background:o.background.name,personality:o.passiveTraits.map(u=>u.name),favoriteFood:l,backstory:"",detailedInfo:a,avatar:d,stats:h,startingInventory:$o(n,o.background.name,a.skills)};c.backstory=Ko(c);const f=Rs();return Ts(f),c.initialSkills=f,c}function ea(i){return`${i.name}, a ${i.personality.join(" and ").toLowerCase()} ${i.background.toLowerCase()}`}function oi(i){var o,a;const e=i.hp||0,t=i.hunger||0,s=i.fatigue||0,n=((o=i.health)==null?void 0:o.totalPain)||0,r=((a=i.health)==null?void 0:a.consciousness)||1;return n>.6?"Agonizing pain":n>.4?"In pain":r<.5?"Barely conscious":e<30?"Injured":t>80?"Starving":s>80?"Exhausted":i.inside?"Resting":i.state==="flee"?"Terrified":n<.1&&e>80&&t<30&&s<30?"Happy":n<.2&&e>60&&t<50&&s<50?"Content":n>.2?"Uncomfortable":"Okay"}function Gi(i,e,t){const s=[],n=12+Math.floor(Math.random()*6);for(let r=0;r<n;r++){const a=t+(Math.random()-.5)*1.2,l=100+Math.random()*80,d=["#ffeb3b","#ffc107","#ff9800","#ff5722","#fff59d"],h=d[Math.floor(Math.random()*d.length)];s.push({x:i+(Math.random()-.5)*6,y:e+(Math.random()-.5)*6,vx:Math.cos(a)*l,vy:Math.sin(a)*l,life:.12+Math.random()*.08,maxLife:.12+Math.random()*.08,size:1.8+Math.random()*2,color:h,alpha:.95})}return s}function Hi(i){const e=[],t=i.tx-i.x,s=i.ty-i.y,n=Math.sqrt(t*t+s*s),r=Math.atan2(s,t),o=Math.floor(n/8)+2;for(let a=0;a<o;a++){const l=a/(o-1),d=i.x+t*l,h=i.y+s*l,c=["#c0c0c0","#a8a8a8","#909090","#787878","#606060"],f=c[Math.floor(Math.random()*c.length)],u=r+Math.PI/2,A=(Math.random()-.5)*1.5;e.push({x:d+Math.cos(u)*A,y:h+Math.sin(u)*A,vx:Math.cos(r)*5+(Math.random()-.5)*8,vy:Math.sin(r)*5+(Math.random()-.5)*8,life:.15+Math.random()*.1,maxLife:.15+Math.random()*.1,size:.8+Math.random()*.4,color:f,alpha:.7})}return e}function bt(i,e){const t=[],s=8+Math.floor(Math.random()*8);for(let n=0;n<s;n++){const r=Math.PI*2*n/s+(Math.random()-.5)*.8,o=50+Math.random()*60,a=["#ff5722","#ff7043","#ffab40","#ffa726","#ff8a65"],l=a[Math.floor(Math.random()*a.length)];t.push({x:i+(Math.random()-.5)*8,y:e+(Math.random()-.5)*8,vx:Math.cos(r)*o,vy:Math.sin(r)*o,life:.25+Math.random()*.2,maxLife:.25+Math.random()*.2,size:1.2+Math.random()*1.2,color:l,alpha:.9})}return t}function ai(i,e){return i.filter(t=>(t.x+=t.vx*e,t.y+=t.vy*e,t.vy+=30*e,t.vx*=.98,t.vy*=.98,t.life-=e,t.alpha=Math.max(0,t.life/t.maxLife*.8),t.size*=.995,t.life>0))}class ta{constructor(){v(this,"canvas",null);v(this,"dirty",!0)}getCanvas(e,t){return(!this.canvas||this.dirty)&&(this.render(e,t),this.dirty=!1),this.canvas}markDirty(){this.dirty=!0}render(e,t){this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=G.w,this.canvas.height=G.h);const s=this.canvas.getContext("2d");s.fillStyle=Z.ground,s.fillRect(0,0,G.w,G.h),s.strokeStyle="rgba(30, 41, 59, 0.5)",s.lineWidth=.75,s.beginPath();for(let n=0;n<=G.w;n+=m)s.moveTo(n,0),s.lineTo(n,G.h);for(let n=0;n<=G.h;n+=m)s.moveTo(0,n),s.lineTo(G.w,n);if(s.stroke(),t)for(let n=0;n<t.rows;n++)for(let r=0;r<t.cols;r++){const o=n*t.cols+r,a=t.floors[o];if(a===0)continue;const l=qe(a);if(l===$.NONE)continue;const d=Bt[l];if(!d)continue;const h=r*m,c=n*m;s.fillStyle=d.color,s.fillRect(h,c,m,m),d.pattern==="stripes"&&d.secondaryColor?(s.fillStyle=d.secondaryColor,s.fillRect(h,c,m,m/4),s.fillRect(h,c+m/2,m,m/4)):d.pattern==="dots"&&d.secondaryColor&&(s.fillStyle=d.secondaryColor,s.fillRect(h+m/4,c+m/4,m/2,m/2))}}}class ia{constructor(){v(this,"cache",new Map);v(this,"spriteWidth",32);v(this,"spriteHeight",48)}getCacheKey(e,t){const s=e.profile;if(!s)return"";const n=s.avatar.sprites;return`${n.bodyType}-${s.avatar.skinTone}-${n.apparelType}-${s.avatar.clothing}-${n.headType}-${n.hairStyle}-${s.avatar.hairColor}-${t}`}getComposedSprite(e,t,s,n){const r=this.getCacheKey(e,t);if(!r)return null;let o=this.cache.get(r);if(o)return o;const a=document.createElement("canvas");a.width=this.spriteWidth,a.height=this.spriteHeight;const l=a.getContext("2d"),d=e.profile;if(!d)return null;const h=d.avatar.sprites,c=s.getColonistSprite("body",h.bodyType,t);if(c){const g=n(c,d.avatar.skinTone);l.drawImage(g,0,0)}else Math.random()<.05&&console.warn(`[Cache] Body sprite not found: body_${h.bodyType}_${t}`);const f=s.getColonistSprite("apparel",h.apparelType,t);if(f){const g=n(f,d.avatar.clothing);l.drawImage(g,0,0)}else Math.random()<.05&&console.warn(`[Cache] Apparel sprite not found: apparel_${h.apparelType}_${t}`);const u=s.getColonistSprite("head",h.headType,t);if(u){const g=n(u,d.avatar.skinTone);l.drawImage(g,0,0)}const A=s.getColonistSprite("hair",h.hairStyle,t);if(A){const g=n(A,d.avatar.hairColor);l.drawImage(g,0,0)}return Math.random()<.01&&console.log(`[Cache] Composed sprite: body=${h.bodyType}, apparel=${h.apparelType}, head=${h.headType}, hair=${h.hairStyle}, dir=${t}`),this.cache.set(r,a),a}clear(){this.cache.clear()}size(){return this.cache.size}}class sa{constructor(){v(this,"canvas",null)}getCanvas(){if(!this.canvas){this.canvas=document.createElement("canvas"),this.canvas.width=G.w,this.canvas.height=G.h;const e=this.canvas.getContext("2d");e.fillStyle="rgba(6, 10, 18, 0.58)",e.fillRect(0,0,G.w,G.h)}return this.canvas}clear(){this.canvas=null}}class na{constructor(){v(this,"cache",new Map)}getCacheKey(e,t,s="circle"){return`${s}-${e}-${t}`}getSprite(e,t,s=1){const n=this.getCacheKey(e,Math.ceil(t));let r=this.cache.get(n);if(!r){const o=document.createElement("canvas"),a=Math.ceil(t)*3;o.width=a,o.height=a;const l=o.getContext("2d"),d=a/2,c=(f=>{const u=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(f);return u?{r:parseInt(u[1],16),g:parseInt(u[2],16),b:parseInt(u[3],16)}:{r:255,g:255,b:255}})(e);l.fillStyle=`rgba(${c.r}, ${c.g}, ${c.b}, 0.25)`,l.beginPath(),l.arc(d,d,t*2.5,0,Math.PI*2),l.fill(),l.fillStyle=`rgba(${c.r}, ${c.g}, ${c.b}, 1)`,l.beginPath(),l.arc(d,d,t,0,Math.PI*2),l.fill(),l.fillStyle="rgba(255, 255, 255, 0.8)",l.beginPath(),l.arc(d,d,t*.4,0,Math.PI*2),l.fill(),this.cache.set(n,o),r=o}return r}clear(){this.cache.clear()}}const ri=new ta,Je=new ia,oa=new sa,aa=new na;let Yi=!0;function ra(i){Yi=i}function qi(i,e){if(i.save(),Yi)for(const t of e){const s=aa.getSprite(t.color,t.size,t.alpha),n=s.width/2;t.alpha<1&&(i.globalAlpha=t.alpha),i.drawImage(s,t.x-n,t.y-n),t.alpha<1&&(i.globalAlpha=1)}else for(const t of e){const n=(r=>{const o=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(r);return o?{r:parseInt(o[1],16),g:parseInt(o[2],16),b:parseInt(o[3],16)}:{r:255,g:255,b:255}})(t.color);i.fillStyle=`rgba(${n.r}, ${n.g}, ${n.b}, ${t.alpha})`,i.beginPath(),i.arc(t.x,t.y,t.size,0,Math.PI*2),i.fill(),t.alpha>.2&&(i.fillStyle=`rgba(${n.r}, ${n.g}, ${n.b}, ${t.alpha*.25})`,i.beginPath(),i.arc(t.x,t.y,t.size*2.5,0,Math.PI*2),i.fill()),t.life/t.maxLife>.7&&(i.fillStyle=`rgba(255, 255, 255, ${t.alpha*.8})`,i.beginPath(),i.arc(t.x,t.y,t.size*.4,0,Math.PI*2),i.fill())}i.restore()}function Ui(i,e,t,s,n){const r=n.x,o=n.x+n.w,a=n.y,l=n.y+n.h,d=Math.min(i,t),h=Math.max(i,t),c=Math.min(e,s),f=Math.max(e,s);if(h<r||d>o||f<a||c>l)return!1;const u=(A,g,p,w,k,M,x,C)=>{const b=(A-p)*(M-C)-(g-w)*(k-x);if(b===0)return!1;const S=((A-k)*(M-C)-(g-M)*(k-x))/b,T=((A-k)*(g-w)-(g-M)*(A-p))/b;return S>=0&&S<=1&&T>=0&&T<=1};return!!(u(i,e,t,s,r,a,o,a)||u(i,e,t,s,o,a,o,l)||u(i,e,t,s,o,l,r,l)||u(i,e,t,s,r,l,r,a))}function Qi(i,e,t){for(const s of i.buildings)if(!(s.kind==="hq"||s.kind==="path"||s.kind==="house"||s.kind==="farm"||s.kind==="bed"||!s.done||e.x>=s.x&&e.x<=s.x+s.w&&e.y>=s.y&&e.y<=s.y+s.h)&&Ui(e.x,e.y,t.x,t.y,s))return!1;return!0}function la(i,e,t){let s=null,n=1/0;for(const r of i.enemies){const o=Math.hypot(r.x-e.x,r.y-e.y);o<=t&&o<n&&Qi(i,e,r)&&(s=r,n=o)}return s}function ca(i,e,t){if(!("range"in e)||!e.range)return;e.cooldown=Math.max(0,(e.cooldown||0)-t),"flashTimer"in e&&(e.flashTimer=Math.max(0,(e.flashTimer||0)-t));const s=i.centerOf(e),n=e.range||160,r=e.fireRate||.6,o=e.dps||12;let a=e.target||null;if((!a||a.hp<=0||Math.hypot(a.x-s.x,a.y-s.y)>n||!Qi(i,s,a))&&(a=la(i,s,n),e.target=a||null),!!a&&(e.cooldown||0)<=0){const l=Math.hypot(a.x-s.x,a.y-s.y),d=Math.max(.35,Math.min(.95,.85-l/n*.3)),h=Math.atan2(a.y-s.y,a.x-s.x),f=(1-d)*18*Math.PI/180,u=(Math.random()-.5)*f,A=h+u,g=l,p=s.x+Math.cos(A)*g,w=s.y+Math.sin(A)*g,k={x:s.x,y:s.y,tx:p,ty:w,t:.12,speed:700,dmg:o,life:0,maxLife:Math.max(.12,l/700+.1),owner:"turret"},M=p-s.x,x=w-s.y,C=Math.hypot(M,x)||1;k.vx=M/C*k.speed,k.vy=x/C*k.speed,k.particles=Hi(k),i.bullets.push(k);const b=Gi(s.x,s.y,h);i.particles.push(...b),e.flashTimer=.08,e.cooldown=r}}function da(i,e){for(let t=i.bullets.length-1;t>=0;t--){const s=i.bullets[t];if(s.vx!=null&&s.vy!=null){const n=s.x,r=s.y;s.x+=s.vx*e,s.y+=s.vy*e,s.life=(s.life||0)+e;let o=!1;for(const l of i.buildings)if(!(l.kind==="hq"||l.kind==="path"||l.kind==="house"||l.kind==="farm"||!l.done||n>=l.x&&n<=l.x+l.w&&r>=l.y&&r<=l.y+l.h)&&Ui(n,r,s.x,s.y,l)){o=!0;break}let a=null;if(!o)for(const l of i.enemies){const d=s.x-n,h=s.y-r,c=n-l.x,f=r-l.y,u=d*d+h*h,A=2*(c*d+f*h),g=c*c+f*f-l.r*l.r;let p=A*A-4*u*g;if(p>=0){p=Math.sqrt(p);const w=(-A-p)/(2*u),k=(-A+p)/(2*u);if(w>=0&&w<=1||k>=0&&k<=1){a=l;break}}}if(a){const l=Math.max(1,Math.round(s.dmg||10));if(i.colonists.includes(a)?i.applyDamageToColonist(a,l,"gunshot"):a.hp-=l,s.owner==="colonist"&&s.shooterId){const c=i.colonists.find(f=>f.id===s.shooterId);c&&c.skills&&(fe(c,"Shooting",8,c.t||0),a.hp<=0&&fe(c,"Shooting",20,c.t||0))}const h=bt(a.x,a.y);i.particles.push(...h),i.bullets.splice(t,1);continue}if(o||s.maxLife!=null&&s.life>=s.maxLife){const l=bt(s.x,s.y);i.particles.push(...l),i.bullets.splice(t,1);continue}}else if(s.t-=e,s.t<=0){const n=bt(s.tx,s.ty);i.particles.push(...n),i.bullets.splice(t,1);continue}s.particles&&(s.particles=ai(s.particles,e),s.particles&&s.particles.length===0&&delete s.particles)}i.particles=ai(i.particles,e)}function ha(i,e,t,s,n){const r=n.x,o=n.x+n.w,a=n.y,l=n.y+n.h,d=Math.min(i,t),h=Math.max(i,t),c=Math.min(e,s),f=Math.max(e,s);if(h<r||d>o||f<a||c>l)return!1;const u=(A,g,p,w,k,M,x,C)=>{const b=(A-p)*(M-C)-(g-w)*(k-x);if(b===0)return!1;const S=((A-k)*(M-C)-(g-M)*(k-x))/b,T=((A-k)*(g-w)-(g-M)*(A-p))/b;return S>=0&&S<=1&&T>=0&&T<=1};return!!(u(i,e,t,s,r,a,o,a)||u(i,e,t,s,o,a,o,l)||u(i,e,t,s,o,l,r,l)||u(i,e,t,s,r,l,r,a))}function fa(i,e,t){for(const s of i.buildings)if(!(s.kind==="hq"||s.kind==="path"||s.kind==="house"||s.kind==="farm"||s.kind==="bed"||!s.done||e.x>=s.x&&e.x<=s.x+s.w&&e.y>=s.y&&e.y<=s.y+s.h)&&ha(e.x,e.y,t.x,t.y,s))return!1;return!0}function ua(i,e,t,s,n,r,o){const a=t-i,l=s-e,d=i-n,h=e-r,c=a*a+l*l,f=2*(d*a+h*l),u=d*d+h*h-o*o;let A=f*f-4*c*u;if(A<0)return!1;A=Math.sqrt(A);const g=(-f-A)/(2*c),p=(-f+A)/(2*c);return g>=0&&g<=1||p>=0&&p<=1}function ga(i,e,t,s){for(const n of i.colonists){if(n===s||!n.alive||n.inside)continue;const r=(n.r||8)+6;if(ua(e.x,e.y,t.x,t.y,n.x,n.y,r))return!0}return!1}function wt(i){const e=Math.abs(i);return e<15?1:e<27?.8:e<40?.6:e<52?.4:e<65?.2:0}function vt(i){return i<32*.5?.3333:i<32*1.5?.3333+(i-16)/32*(.6666-.3333):i<32*2.5?.6666+(i-48)/32*(1-.6666):1}function Aa(i,e,t){const s=[],n=t.x-e.x,r=t.y-e.y,o=Math.atan2(r,n),a=Math.hypot(n,r)||1;for(const h of i.buildings){if(!h.done||h.kind!=="wall")continue;const c=h.x+h.w/2,f=h.y+h.h/2,u=c-e.x,A=f-e.y,g=Math.max(0,Math.min(1,(u*n+A*r)/(a*a))),p=e.x+g*n,w=e.y+g*r,k=Math.hypot(p-c,w-f);if(g>.75&&k<Math.max(12,Math.min(h.w,h.h)*.6)){const x=h.h>h.w?0:Math.PI/2;let C=Math.abs((o-x)*180/Math.PI);for(;C>90;)C=Math.abs(C-180);C>90&&(C=180-C);const b=wt(C),S=Math.hypot(e.x-c,e.y-f),T=vt(S),D=.75*b*T;D>0&&s.push({value:.75,isHighCover:!0,angle:C,distanceToShooter:S,effectiveValue:D})}}for(const h of i.rocks){const c=h.x,f=h.y,u=c-e.x,A=f-e.y,g=Math.max(0,Math.min(1,(u*n+A*r)/(a*a))),p=e.x+g*n,w=e.y+g*r,k=Math.hypot(p-c,w-f);if(g>.75&&k<h.r+8){const M=Math.atan2(f-t.y,c-t.x);let x=Math.abs((o-M)*180/Math.PI);x>180&&(x=360-x),x>90&&(x=180-x);const C=wt(x),b=Math.hypot(e.x-c,e.y-f),S=vt(b),T=.5*C*S;T>0&&s.push({value:.5,isHighCover:!1,angle:x,distanceToShooter:b,effectiveValue:T})}}for(const h of i.trees){const c=h.x,f=h.y,u=c-e.x,A=f-e.y,g=Math.max(0,Math.min(1,(u*n+A*r)/(a*a))),p=e.x+g*n,w=e.y+g*r,k=Math.hypot(p-c,w-f);if(g>.75&&k<h.r+6){const M=Math.atan2(f-t.y,c-t.x);let x=Math.abs((o-M)*180/Math.PI);x>180&&(x=360-x),x>90&&(x=180-x);const C=wt(x),b=Math.hypot(e.x-c,e.y-f),S=vt(b),T=.3*C*S;T>0&&s.push({value:.3,isHighCover:!1,angle:x,distanceToShooter:b,effectiveValue:T})}}if(s.length===0)return 0;const l=s.find(h=>h.isHighCover);if(l)return l.effectiveValue;s.sort((h,c)=>c.effectiveValue-h.effectiveValue);let d=s[0].effectiveValue;for(let h=1;h<Math.min(3,s.length);h++)d+=s[h].effectiveValue*.2;return Math.min(.9,d)}function pa(i){var g;const t=(((g=i.inventory)==null?void 0:g.equipment)||{}).weapon;if(!t||!t.defName)return null;const s=_.getItemDef(t.defName);if(!s)return null;const n=32,r=(s.range||10)*n,o=s.damage||12,a=s.accuracy??.7,l=s.defName==="Rifle"?3:1,d=s.defName==="Rifle"?.6:.4,h=.1,c=s.defName==="Rifle"?.7:.5,f=680,u=1.25*n,A=(s.range||0)<=2;return{rangePx:r,damage:o,accuracy:a,burst:l,warmup:d,betweenShots:h,cooldown:c,speed:f,minRangePx:u,isMelee:A}}function ma(i,e,t){let s=null,n=1/0;for(const r of i.enemies){const o=Math.hypot(r.x-e.x,r.y-e.y);o<=t&&o<n&&fa(i,e,r)&&(s=r,n=o)}return s}function ya(i,e,t){if(!e.alive||e.inside||!(e.isDrafted||e.inCombat))return;const n=pa(e),o=(()=>{const T=e._lastPos||{x:e.x,y:e.y},D=Math.hypot(e.x-T.x,e.y-T.y);return e._lastPos={x:e.x,y:e.y},D})()>.5;if(!n||n.isMelee){const D=41.6+e.r;let I=null,O=1/0;if(e.isDrafted&&e.draftedTarget){const z=e.draftedTarget;if(z.hp>0&&z.alive!==!1){const H=Math.hypot(z.x-e.x,z.y-e.y);H<=D&&(I=z,O=H)}}if(!I)for(const z of i.enemies){const H=Math.hypot(z.x-e.x,z.y-e.y);H<O&&(O=H,I=z)}if(I&&O<=D){if(o)return;if(e.meleeCd=Math.max(0,(e.meleeCd||0)-t),(e.meleeCd||0)<=0){const z=e.skills?we(e,"Melee"):0,H=Math.round(((n==null?void 0:n.damage)||10)*(1+z*.03));if(i.colonists.includes(I)){const Y=n!=null&&n.isMelee?"cut":"bruise";i.applyDamageToColonist(I,H,Y)}else I.hp-=H;e.skills&&fe(e,"Melee",18,e.t||0),e.meleeCd=.8}}return}e.fireCooldown=Math.max(0,(e.fireCooldown||0)-t),e.betweenShots=Math.max(0,(e.betweenShots||0)-t),e.warmup=Math.max(0,(e.warmup||0)-t);let a=e.combatTarget||null;if(e.isDrafted&&e.draftedTarget){const T=e.draftedTarget;T.hp>0&&T.alive!==!1?(a=T,e.combatTarget=a,a&&a!==e.combatTarget&&(e.warmup=n.warmup)):(e.draftedTarget=null,a=null)}if((!a||a.hp<=0)&&(a=ma(i,e,n.rangePx),e.combatTarget=a,a&&(e.warmup=n.warmup)),!a)return;const l=Math.hypot(a.x-e.x,a.y-e.y);if(l>n.rangePx*1.1){e.combatTarget=null;return}if(l<=n.minRangePx){if(e.meleeCd=Math.max(0,(e.meleeCd||0)-t),(e.meleeCd||0)<=0){const T=Math.max(8,Math.round(n.damage*.6));i.colonists.includes(a)?i.applyDamageToColonist(a,T,"bruise"):a.hp-=T,e.meleeCd=.9,e.fireCooldown=Math.max(e.fireCooldown||0,.3)}return}if(o){e.burstLeft=0,e.warmup=Math.max(e.warmup||0,n.warmup*.6);return}if((e.warmup||0)>0)return;if(e.burstLeft==null||e.burstLeft<=0){if((e.fireCooldown||0)>0)return;e.burstLeft=n.burst}if((e.betweenShots||0)>0)return;const d=e.skills?we(e,"Shooting"):0,h=Math.min(.98,n.accuracy*(1+d*.02)),c=Math.max(.5,1-l/n.rangePx*.5),f=Aa(i,e,a),u=Math.max(.1,h*c*(1-f)),A=Math.atan2(a.y-e.y,a.x-e.x),g=(1-u)*20*(Math.PI/180),p=A+(Math.random()-.5)*g,w=e.x+Math.cos(p)*l,k=e.y+Math.sin(p)*l;if(ga(i,e,{x:w,y:k},e)){e.betweenShots=Math.max(e.betweenShots||0,.15);return}const M={x:e.x,y:e.y,tx:w,ty:k,t:.12,speed:n.speed,dmg:Math.round(n.damage*(1+d*.02)),life:0,maxLife:Math.max(.12,l/n.speed+.12),owner:"colonist",shooterId:e.id||(e.id=`colonist_${Date.now()}_${Math.random().toString(36).substr(2,9)}`)},x=w-e.x,C=k-e.y,b=Math.hypot(x,C)||1;M.vx=x/b*n.speed,M.vy=C/b*n.speed,M.particles=Hi(M),i.bullets.push(M);const S=Gi(e.x,e.y,A);i.particles.push(...S),e.burstLeft-=1,e.betweenShots=n.betweenShots,e.burstLeft<=0&&(e.fireCooldown=n.cooldown,e.combatTarget=null),e.skills&&fe(e,"Shooting",2.5,e.t||0)}const ba={Firefighting:1,PatientEmergency:1,Doctor:3,PatientBedRest:2,Flicker:2,Warden:3,Handling:3,Cooking:3,Hunting:3,Construction:2,Growing:2,Mining:2,PlantCutting:2,Smithing:3,Tailoring:3,Art:4,Crafting:3,Hauling:3,Cleaning:4,Research:3},Ct={Firefighting:{name:"Firefighting",label:"Firefight",description:"Put out fires (emergency)",emergencyWork:!0,requiresCapability:"movement"},PatientEmergency:{name:"PatientEmergency",label:"Patient",description:"Being treated for injuries",emergencyWork:!0},Doctor:{name:"Doctor",label:"Doctor",description:"Treat injuries and illnesses",relatedSkill:"Medicine",requiresCapability:"manipulation"},PatientBedRest:{name:"PatientBedRest",label:"Bed rest",description:"Rest in bed when injured"},Flicker:{name:"Flicker",label:"Flick",description:"Operate switches and power controls",requiresCapability:"manipulation"},Warden:{name:"Warden",label:"Warden",description:"Manage prisoners",relatedSkill:"Social",requiresCapability:"movement"},Handling:{name:"Handling",label:"Handle",description:"Tame and train animals",relatedSkill:"Social",requiresCapability:"manipulation"},Cooking:{name:"Cooking",label:"Cook",description:"Prepare meals",relatedSkill:"Cooking",requiresCapability:"manipulation"},Hunting:{name:"Hunting",label:"Hunt",description:"Hunt animals for food",relatedSkill:"Shooting",requiresCapability:"movement"},Construction:{name:"Construction",label:"Construct",description:"Build structures",relatedSkill:"Construction",requiresCapability:"manipulation"},Growing:{name:"Growing",label:"Grow",description:"Sow and harvest crops",relatedSkill:"Plants",requiresCapability:"manipulation"},Mining:{name:"Mining",label:"Mine",description:"Extract stone and minerals",relatedSkill:"Mining",requiresCapability:"manipulation"},PlantCutting:{name:"PlantCutting",label:"Plant cut",description:"Chop trees for wood",relatedSkill:"Plants",requiresCapability:"manipulation"},Smithing:{name:"Smithing",label:"Smith",description:"Craft weapons and armor",relatedSkill:"Crafting",requiresCapability:"manipulation"},Tailoring:{name:"Tailoring",label:"Tailor",description:"Craft clothing",relatedSkill:"Crafting",requiresCapability:"manipulation"},Art:{name:"Art",label:"Art",description:"Create artistic works",relatedSkill:"Crafting",requiresCapability:"manipulation"},Crafting:{name:"Crafting",label:"Craft",description:"General crafting",relatedSkill:"Crafting",requiresCapability:"manipulation"},Hauling:{name:"Hauling",label:"Haul",description:"Move items and resources",requiresCapability:"movement"},Cleaning:{name:"Cleaning",label:"Clean",description:"Clean up filth",requiresCapability:"movement"},Research:{name:"Research",label:"Research",description:"Conduct research",relatedSkill:"Research",requiresCapability:"manipulation"}},Le=["Firefighting","PatientEmergency","Doctor","PatientBedRest","Flicker","Warden","Handling","Cooking","Hunting","Construction","Growing","Mining","PlantCutting","Smithing","Tailoring","Art","Crafting","Hauling","Cleaning","Research"];function Rt(i){if(i.workPriorities)return;const e={...ba};if(i.skills){const t=i.skills;for(const[s,n]of Object.entries(t.byName))if(n.level>=8||n.passion==="burning"){for(const[r,o]of Object.entries(Ct))if(o.relatedSkill===s){const a=e[r];a>1&&(e[r]=Math.max(1,a-1))}}}i.workPriorities=e}function wa(i,e){i.workPriorities||Rt(i);const t=i.workPriorities[e];let s;t===1?s=2:t===2?s=3:t===3?s=4:t===4?s=0:s=1,i.workPriorities[e]=s}const tt={0:{targetHz:20,minInterval:1/30,maxInterval:1/15,jitterRange:.005},1:{targetHz:15,minInterval:1/20,maxInterval:1/10,jitterRange:.01},2:{targetHz:5,minInterval:1/10,maxInterval:1/3,jitterRange:.02},3:{targetHz:1,minInterval:1/2,maxInterval:2,jitterRange:.05}};class va{constructor(){v(this,"entityStates",new Map);v(this,"frameTime",0);v(this,"totalEntities",0);v(this,"updatedThisFrame",0);v(this,"skippedThisFrame",0)}beginFrame(e){this.frameTime=e,this.totalEntities=0,this.updatedThisFrame=0,this.skippedThisFrame=0}calculateImportance(e){const{entityX:t,entityY:s,cameraX:n,cameraY:r,cameraWidth:o,cameraHeight:a,cameraZoom:l,isInCombat:d=!1,isSleeping:h=!1,isStasis:c=!1,task:f,health:u,maxHealth:A}=e;if(d)return 0;if(c||h)return 3;const g=o/l,p=a/l,w=n+g/2,k=r+p/2,M=t-w,x=s-k,C=Math.sqrt(M*M+x*x),b=t>=n-100&&t<=n+g+100&&s>=r-100&&s<=r+p+100,S=Math.min(g,p)*.4;if(b&&C<S||u!==void 0&&A!==void 0&&u/A<.3)return 0;if(b||f&&["fight","flee","rescue","extinguish","doctor"].includes(f))return 1;const D=Math.min(g,p)*2;return C<D?2:3}shouldUpdate(e,t){this.totalEntities++;let s=this.entityStates.get(e);if(!s){const n=tt[t],r=(Math.random()-.5)*n.jitterRange*2;return s={lastUpdate:this.frameTime,nextUpdate:this.frameTime+1/n.targetHz+r,importance:t,skippedUpdates:0},this.entityStates.set(e,s),this.updatedThisFrame++,!0}if(s.importance!==t){if(t<s.importance){s.importance=t,s.lastUpdate=this.frameTime;const n=tt[t],r=(Math.random()-.5)*n.jitterRange*2;return s.nextUpdate=this.frameTime+1/n.targetHz+r,this.updatedThisFrame++,!0}s.importance=t}if(this.frameTime>=s.nextUpdate){const n=tt[t],r=1/n.targetHz,o=(Math.random()-.5)*n.jitterRange*2;return s.lastUpdate=this.frameTime,s.nextUpdate=this.frameTime+r+o,s.skippedUpdates=0,this.updatedThisFrame++,!0}return s.skippedUpdates++,this.skippedThisFrame++,!1}forceUpdate(e,t){const s=tt[t],n=(Math.random()-.5)*s.jitterRange*2;this.entityStates.set(e,{lastUpdate:this.frameTime,nextUpdate:this.frameTime+1/s.targetHz+n,importance:t,skippedUpdates:0})}removeEntity(e){this.entityStates.delete(e)}getStats(){const e={0:0,1:0,2:0,3:0};for(const t of this.entityStates.values())e[t.importance]++;return{totalEntities:this.totalEntities,trackedEntities:this.entityStates.size,updatedThisFrame:this.updatedThisFrame,skippedThisFrame:this.skippedThisFrame,updatePercentage:this.totalEntities>0?(this.updatedThisFrame/this.totalEntities*100).toFixed(1)+"%":"0%",byImportance:e}}cleanup(e,t=60){const s=e-t;for(const[n,r]of this.entityStates.entries())r.lastUpdate<s&&this.entityStates.delete(n)}}class Ma{constructor(){v(this,"regionVersions",new Map);v(this,"globalVersion",0);v(this,"lastModified",new Map);v(this,"dirtyRegions",new Set)}getRegionVersion(e){return this.regionVersions.get(e)||0}getGlobalVersion(){return this.globalVersion}getAllVersions(){return new Map(this.regionVersions)}markRegionChanged(e,t=Date.now()){const s=this.regionVersions.get(e)||0;this.regionVersions.set(e,s+1),this.lastModified.set(e,t),this.globalVersion++,this.dirtyRegions.add(e)}markRegionsChanged(e,t=Date.now()){for(const s of e)this.markRegionChanged(s,t)}recordStructuralChange(e,t){const s=Date.now();this.markRegionsChanged(t,s)}hasRegionChanged(e,t){return this.getRegionVersion(e)>t}haveRegionsChanged(e){for(const[t,s]of e)if(this.hasRegionChanged(t,s))return!0;return!1}getDirtyRegionsAndClear(){const e=new Set(this.dirtyRegions);return this.dirtyRegions.clear(),e}getDirtyRegions(){return new Set(this.dirtyRegions)}clearDirtyFlags(){this.dirtyRegions.clear()}getLastModified(e){return this.lastModified.get(e)||0}createSnapshot(e){const t=new Map;for(const s of e)t.set(s,this.getRegionVersion(s));return t}validateSnapshot(e){return!this.haveRegionsChanged(e)}reset(){this.regionVersions.clear(),this.lastModified.clear(),this.dirtyRegions.clear(),this.globalVersion=0}getStats(){return{trackedRegions:this.regionVersions.size,globalVersion:this.globalVersion,dirtyRegions:this.dirtyRegions.size,averageVersion:this.regionVersions.size>0?Array.from(this.regionVersions.values()).reduce((e,t)=>e+t,0)/this.regionVersions.size:0}}}class ka{constructor(e){v(this,"queue",[]);v(this,"activeRequests",new Map);v(this,"cache",new Map);v(this,"regionVersionManager");v(this,"stats",{totalRequests:0,cancelledRequests:0,cacheHits:0,cacheMisses:0,queuedRequests:0,processedRequests:0});this.regionVersionManager=e}requestPath(e,t,s,n,r,o=50,a){const l=this.getEntityId(e),d=this.getCacheKey(t,s,n,r),h=this.cache.get(d);if(h&&this.regionVersionManager.validateSnapshot(h.regionVersions))return this.stats.cacheHits++,h.hitCount++,a&&a(h.path),null;this.stats.cacheMisses++,this.cancelRequest(l);const c={id:`${l}_${Date.now()}`,entityId:l,entity:e,startX:t,startY:s,targetX:n,targetY:r,priority:o,timestamp:Date.now(),callback:a};return this.stats.totalRequests++,this.stats.queuedRequests++,this.queue.push(c),this.activeRequests.set(l,c),this.sortQueue(),c.id}cancelRequest(e){const t=this.activeRequests.get(e);if(!t)return!1;const s=this.queue.findIndex(n=>n.id===t.id);return s>=0&&(this.queue.splice(s,1),this.stats.queuedRequests--),this.activeRequests.delete(e),this.stats.cancelledRequests++,!0}getNextRequest(){if(this.queue.length===0)return null;const e=this.queue.shift();return this.stats.queuedRequests--,this.stats.processedRequests++,this.activeRequests.delete(e.entityId),e}completeRequest(e,t,s){const n=this.getCacheKey(e.startX,e.startY,e.targetX,e.targetY),r=this.regionVersionManager.createSnapshot(s);this.cache.set(n,{path:t,regionVersions:r,timestamp:Date.now(),hitCount:0}),e.callback&&e.callback(t)}hasActiveRequest(e){return this.activeRequests.has(e)}getActiveRequest(e){return this.activeRequests.get(e)}getQueueDepth(){return this.queue.length}getActiveCount(){return this.activeRequests.size}clearEntity(e){this.cancelRequest(e)}invalidateCacheForRegions(e){let t=0;for(const[s,n]of this.cache.entries())for(const r of e)if(n.regionVersions.has(r)&&this.regionVersionManager.hasRegionChanged(r,n.regionVersions.get(r))){this.cache.delete(s),t++;break}return t}checkCache(e,t,s,n){const r=this.getCacheKey(e,t,s,n),o=this.cache.get(r);return o&&this.regionVersionManager.validateSnapshot(o.regionVersions)?(this.stats.cacheHits++,o.hitCount++,o.path):(o&&this.cache.delete(r),this.stats.cacheMisses++,null)}storePath(e,t,s,n,r,o){const a=this.getCacheKey(e,t,s,n);this.cache.set(a,{path:r,regionVersions:o,timestamp:Date.now(),hitCount:0})}cleanCache(e=300){const s=Date.now()-e*1e3;let n=0;for(const[r,o]of this.cache.entries())o.timestamp<s&&(this.cache.delete(r),n++);return n}getCacheStats(){const t=Array.from(this.cache.values()).reduce((s,n)=>s+n.hitCount,0);return{cacheSize:this.cache.size,totalHits:t,averageHitsPerEntry:this.cache.size>0?t/this.cache.size:0,cacheHitRate:this.stats.totalRequests>0?(this.stats.cacheHits/this.stats.totalRequests*100).toFixed(1)+"%":"0%"}}getStats(){const e=this.getCacheStats();return{...this.stats,queueDepth:this.queue.length,activeRequests:this.activeRequests.size,...e}}resetStats(){this.stats={totalRequests:0,cancelledRequests:0,cacheHits:0,cacheMisses:0,queuedRequests:this.queue.length,processedRequests:0}}clear(){this.queue=[],this.activeRequests.clear(),this.cache.clear(),this.resetStats()}getEntityId(e){return"profile"in e&&e.profile?`colonist_${e.profile.name}`:`enemy_${Math.round(e.x)}_${Math.round(e.y)}`}getCacheKey(e,t,s,n){const r=Math.round(e/32),o=Math.round(t/32),a=Math.round(s/32),l=Math.round(n/32);return`${r},${o}:${a},${l}`}sortQueue(){this.queue.sort((e,t)=>e.priority!==t.priority?t.priority-e.priority:e.timestamp-t.timestamp)}}let Me=!1,le=0,Xe=null,Tt=0,Pt=0;function Ht(i,e,t){const s=i*.9,n=e*.85,r=(i-s)/2,o=(e-n)/2,a=s*.02,l=n*.08,d=n*.06,h=s*.15,c=s-h-a*2,f=Le.length,u=c/f,A=n-l-d-a*2,g=t+1,p=Math.max(A/g,n*.04),w=Math.max(10,s*.012),k=Math.max(12,s*.015);return{panelX:r,panelY:o,panelWidth:s,panelHeight:n,cellWidth:u,cellHeight:p,headerHeight:l,nameColumnWidth:h,padding:a,fontSize:w,headerFontSize:k,footerHeight:d}}function Mt(){Me=!Me,le=0;const i=document.getElementById("mobileControls");i&&(i.style.display=Me?"none":"")}function We(){return Me}function li(){Me=!1;const i=document.getElementById("mobileControls");i&&(i.style.display="")}function xa(i){switch(i){case 1:return"#4CAF50";case 2:return"#8BC34A";case 3:return"#FFC107";case 4:return"#FF9800";case 0:return"#424242";default:return"#666666"}}function Sa(i){return i===0?"—":i.toString()}function Ca(i,e,t,s){var j;if(!Me)return;i.save(),i.setTransform(1,0,0,1,0,0);const n=e.filter(Y=>Y.alive),r=Ht(t,s,n.length),{panelX:o,panelY:a,panelWidth:l,panelHeight:d,cellWidth:h,cellHeight:c,headerHeight:f,nameColumnWidth:u,padding:A,fontSize:g,headerFontSize:p,footerHeight:w}=r;i.fillStyle="rgba(0, 0, 0, 0.75)",i.fillRect(0,0,t,s);const k=i.createLinearGradient(o,a,o,a+d);k.addColorStop(0,"#2a2a2a"),k.addColorStop(1,"#1a1a1a"),i.fillStyle=k,i.fillRect(o,a,l,d),i.strokeStyle="rgba(100, 150, 200, 0.5)",i.lineWidth=3,i.strokeRect(o,a,l,d),i.strokeStyle="#4a6fa5",i.lineWidth=2,i.strokeRect(o,a,l,d),i.fillStyle="#1e3a5f",i.fillRect(o,a,l,f),i.fillStyle="#FFFFFF",i.font=`bold ${Math.round(p*1.3)}px Arial, sans-serif`,i.textAlign="center",i.fillText("Work Priorities",o+l/2,a+f*.6);const M=f*.6,x=o+l-M-A,C=a+(f-M)/2;i.fillStyle="#d32f2f",i.beginPath(),i.roundRect(x,C,M,M,M*.15),i.fill(),i.strokeStyle="#fff",i.lineWidth=2,i.stroke(),i.strokeStyle="#fff",i.lineWidth=Math.max(2,M*.08),i.beginPath(),i.moveTo(x+M*.25,C+M*.25),i.lineTo(x+M*.75,C+M*.75),i.moveTo(x+M*.75,C+M*.25),i.lineTo(x+M*.25,C+M*.75),i.stroke();const b=o+A,S=a+f+A,T=l-A*2,D=d-f-A*2-w;let I=b+u;i.fillStyle="#2a4a6a",i.fillRect(b,S-le,T,c),i.fillStyle="#fff",i.font=`bold ${Math.round(p)}px Arial, sans-serif`,i.textAlign="left",i.fillText("Colonist",b+A*.5,S-le+c*.65),i.font=`bold ${Math.round(g)}px Arial, sans-serif`,i.textAlign="center";for(const Y of Le){const X=Ct[Y];i.fillStyle="#2a4a6a",i.fillRect(I,S-le,h,c),i.strokeStyle="#1a2a3a",i.lineWidth=1,i.strokeRect(I,S-le,h,c),i.fillStyle="#e0e0e0",i.font=`bold ${Math.round(g*.95)}px Arial, sans-serif`,i.textAlign="center";const U=X.label.substring(0,Math.min(4,Math.max(3,Math.floor(h/(g*.6)))));i.fillText(U,I+h/2,S-le+c*.65),I+=h}i.save(),i.beginPath(),i.rect(b,S+c-le,T,D-c),i.clip();let O=S+c-le;for(const Y of n){const X=n.indexOf(Y);i.fillStyle=X%2===0?"#252525":"#2a2a2a",i.fillRect(b,O,T,c),i.fillStyle="#353535",i.fillRect(b,O,u,c),i.strokeStyle="#1a1a1a",i.lineWidth=1,i.strokeRect(b,O,u,c),i.fillStyle="#fff",i.font=`${Math.round(g)}px Arial, sans-serif`,i.textAlign="left";const U=((j=Y.profile)==null?void 0:j.name)||"Unknown",K=Math.floor(u/(g*.6)),ie=U.length>K?U.substring(0,K-2)+"..":U;i.fillText(ie,b+A*.5,O+c*.65);const se=Y.hp/100,oe=se>.66?"#4caf50":se>.33?"#ffc107":"#f44336",ae=Math.max(3,c*.15);i.fillStyle=oe,i.beginPath(),i.arc(b+u-ae*2,O+c/2,ae,0,Math.PI*2),i.fill();let ue=b+u;for(const me of Le){const he=Y.workPriorities,y=(he==null?void 0:he[me])??3;i.fillStyle=xa(y),i.fillRect(ue,O,h,c),i.strokeStyle="#1a1a1a",i.lineWidth=1,i.strokeRect(ue,O,h,c),i.fillStyle=y===0?"#666":"#fff",i.font=`bold ${Math.round(g*1.1)}px Arial, sans-serif`,i.textAlign="center",i.fillText(Sa(y),ue+h/2,O+c*.65),ue+=h}O+=c}i.restore();const z=Math.max(0,(n.length+1)*c-D);if(z>0){const Y=Math.max(6,l*.008),X=o+l-A-Y,U=S,K=D;i.fillStyle="rgba(255, 255, 255, 0.1)",i.fillRect(X,U,Y,K);const ie=Math.max(30,D/((n.length+1)*c)*K),se=U+le/z*(K-ie);i.fillStyle="rgba(100, 150, 200, 0.6)",i.fillRect(X,se,Y,ie)}const H=a+d-w;if(i.fillStyle="#1a1a1a",i.fillRect(o,H,l,w),i.fillStyle="#aaa",i.font=`${Math.round(g*.9)}px Arial, sans-serif`,i.textAlign="center",i.fillText("Click a cell to cycle priority: 1 (highest) → 2 → 3 → 4 (lowest) → disabled → 1",o+l/2,H+w*.35),i.fillText("Press P to close • Scroll with mouse wheel • Hover over column headers for full names",o+l/2,H+w*.75),Xe){const Y=Ct[Xe];if(Y){i.font=`${Math.round(g*1.1)}px Arial, sans-serif`;const X=Y.label,U=i.measureText(X).width,K=A*1.5,ie=U+K*2,se=c*1.2;let oe=Tt+10,ae=Pt-se-5;oe+ie>o+l&&(oe=Tt-ie-10),ae<a&&(ae=Pt+20),i.fillStyle="rgba(40, 40, 40, 0.95)",i.strokeStyle="#4a6fa5",i.lineWidth=2,i.beginPath(),i.roundRect(oe,ae,ie,se,5),i.fill(),i.stroke(),i.fillStyle="#ffffff",i.font=`bold ${Math.round(g*1.1)}px Arial, sans-serif`,i.textAlign="left",i.fillText(X,oe+K,ae+se*.65)}}i.restore()}function ci(i,e,t,s,n){var O,z;if(!Me)return!1;const r=t.filter(H=>H.alive),o=Ht(s,n,r.length),{panelX:a,panelY:l,panelWidth:d,panelHeight:h,cellWidth:c,cellHeight:f,headerHeight:u,nameColumnWidth:A,padding:g}=o,p=u*.6,w=a+d-p-g,k=l+(u-p)/2;if(i>=w&&i<=w+p&&e>=k&&e<=k+p||i<a||i>a+d||e<l||e>l+h)return li(),!0;const M=a+g,x=l+u+g,C=i-M-A,b=e-x-f+le;if(C<0||b<0)return!0;const S=Math.floor(C/c),T=Math.floor(b/f);if(S<0||S>=Le.length||T<0||T>=r.length)return!0;const D=r[T],I=Le[S];if(D&&I){wa(D,I);const H=((O=D.workPriorities)==null?void 0:O[I])??3;console.log(`${((z=D.profile)==null?void 0:z.name)||"Colonist"} ${I} priority → ${H}`)}return!0}function Ra(i){Me&&(le+=i*.5,le=Math.max(0,le))}function Ta(i,e,t,s,n){if(!Me){Xe=null;return}const r=t.filter(g=>g.alive),o=Ht(s,n,r.length),{panelX:a,panelY:l,cellWidth:d,headerHeight:h,nameColumnWidth:c,padding:f}=o,u=a+f,A=l+h+f;if(e>=A-le&&e<=A-le+o.cellHeight){const g=i-u-c;if(g>=0){const p=Math.floor(g/d);if(p>=0&&p<Le.length){Xe=Le[p],Tt=i,Pt=e;return}}}Xe=null}function Pa(i){i.debugConsole={open:!1,input:"",history:[],historyIndex:-1,output:[],commands:new Map};const e=(t,s,n)=>{i.debugConsole.commands.set(t,s),n&&(s.help=n)};e("help",(t,s)=>{const n=t.debugConsole;if(s.length){const r=n.commands.get(s[0]);return r&&r.help?r.help:`No help for '${s[0]}'`}return"commands: help, toggle, spawn, speed, pause, give, select, clear, injure, health, resources, kill, heal, godmode"},"help [cmd] — show commands or help for cmd"),e("toggle",(t,s)=>{const n=(s[0]||"").toLowerCase();if(!n)return"usage: toggle <nav|colonists|combat|enemies>";if(n==="nav")t.debug.nav=!t.debug.nav;else if(n==="colonists")t.debug.colonists=!t.debug.colonists;else if(n==="combat")t.debug.combat=!t.debug.combat;else return n==="enemies"?(t.disableEnemySpawns=!t.disableEnemySpawns,`enemy spawns ${t.disableEnemySpawns?"disabled":"enabled"}`):`unknown toggle '${n}'`;return`${n} = ${n==="combat"?t.debug.combat:t.debug[n]}`},"toggle nav|colonists|combat|enemies — flip debug flags or disable enemy spawning"),e("spawn",(t,s)=>{const n=(s[0]||"enemy").toLowerCase(),r=Math.max(1,Math.min(20,parseInt(s[1]||"1",10)||1));if(n==="enemy"){for(let o=0;o<r;o++)t.spawnEnemy();return`spawned ${r} enemy`}if(n==="colonist"){for(let o=0;o<r;o++)t.spawnColonist({x:t.camera.x+100+o*8,y:t.camera.y+100});return`spawned ${r} colonist`}return`unknown spawn '${n}'`},"spawn enemy [n] | spawn colonist [n]"),e("speed",(t,s)=>{const n=parseFloat(s[0]||"");return!isFinite(n)||n<=0?"usage: speed <number> e.g. 1 or 6":(t.fastForward=n,`speed = ${t.fastForward}`)},"speed <n> — set game speed multiplier"),e("pause",t=>(t.paused=!t.paused,`paused = ${t.paused}`),"pause — toggle pause"),e("give",(t,s)=>{const n=(s[0]||"").toLowerCase(),r=(s[1]||"selected").toLowerCase();let o=[];if(r==="all")o=t.colonists.filter(a=>a.alive);else if(r==="selected")o=t.selColonist?[t.selColonist]:[];else{const a=t.colonists.find(l=>{var d,h;return l.alive&&((h=(d=l.profile)==null?void 0:d.name)==null?void 0:h.toLowerCase().includes(r))});a&&(o=[a])}if(!o.length)return r==="selected"?"no colonist selected (use 'select next')":`no colonist found matching '${r}'`;for(const a of o)a.inventory||(a.inventory={items:[],equipment:{},carryCapacity:50,currentWeight:0}),a.inventory.equipment||(a.inventory.equipment={});if(n==="pistol"||n==="weapon"){for(const a of o){const l=_.createItem("Pistol",1,"normal");a.inventory.equipment.weapon=l,t.recalcInventoryWeight(a)}return`gave pistol to ${o.length} colonist(s)`}else if(n==="medicine"||n==="medicinekit"){for(const a of o){const l=_.createItem("MedicineKit",5,"normal");a.inventory.items.push(l),t.recalcInventoryWeight(a)}return`gave 5 medicine kits to ${o.length} colonist(s)`}else if(n==="bandage"||n==="bandages"){for(const a of o){const l=_.createItem("Bandage",10,"normal");a.inventory.items.push(l),t.recalcInventoryWeight(a)}return`gave 10 bandages to ${o.length} colonist(s)`}else if(n==="food"||n==="bread"){for(const a of o){const l=_.createItem("Bread",10,"normal");a.inventory.items.push(l),t.recalcInventoryWeight(a)}return`gave 10 bread to ${o.length} colonist(s)`}else return"usage: give <pistol|medicine|bandage|food> [selected|all|name]"},"give <item> [target] — give items to colonist(s). Items: pistol,medicine,bandage,food. Target: selected,all,name"),e("select",(t,s)=>{var l;if((s[0]||"").toLowerCase()!=="next")return"usage: select next";const r=t.colonists.filter(d=>d.alive);if(!r.length)return"no colonists";const o=Math.max(0,r.indexOf(t.selColonist||r[0])),a=r[(o+1)%r.length];return t.selColonist=a,t.follow=!0,`selected ${((l=a.profile)==null?void 0:l.name)||"colonist"}`},"select next — select next colonist"),e("clear",(t,s)=>{const n=(s[0]||"messages").toLowerCase();return n==="messages"?(t.messages.length=0,"cleared messages"):n==="bullets"?(t.bullets.length=0,"cleared bullets"):"usage: clear messages|bullets"},"clear messages|bullets — clear logs or bullets"),e("injure",(t,s)=>{const n=(s[0]||"bruise").toLowerCase(),r={cut:8,bruise:6,burn:12,bite:10,gunshot:25,fracture:20},o=Math.max(1,Math.min(50,parseInt(s[1]||r[n].toString(),10)||r[n])),a=(s[2]||"selected").toLowerCase(),l=["cut","bruise","burn","bite","gunshot","fracture"];if(!l.includes(n))return`invalid damage type '${n}'. Use: ${l.join(", ")}`;let d=[];if(a==="all")d=t.colonists.filter(h=>h.alive);else if(a==="selected")d=t.selColonist?[t.selColonist]:[];else{const h=t.colonists.find(c=>{var f,u;return c.alive&&((u=(f=c.profile)==null?void 0:f.name)==null?void 0:u.toLowerCase().includes(a))});h&&(d=[h])}if(!d.length)return a==="selected"?"no colonist selected (use 'select next')":`no colonist found matching '${a}'`;for(const h of d)if(typeof t.applyDamageToColonist=="function")t.applyDamageToColonist(h,o,n);else return"damage system not available";return`applied ${o} ${n} damage to ${d.length} colonist(s)`},"injure [type] [damage] [target] — injure colonist(s). Types: cut,bruise,burn,bite,gunshot,fracture. Target: selected,all,name"),e("health",(t,s)=>{var a,l;const n=(s[0]||"check").toLowerCase(),r=(s[1]||"selected").toLowerCase();let o=[];if(r==="all")o=t.colonists.filter(d=>d.alive);else if(r==="selected")o=t.selColonist?[t.selColonist]:[];else{const d=t.colonists.find(h=>{var c,f;return h.alive&&((f=(c=h.profile)==null?void 0:c.name)==null?void 0:f.toLowerCase().includes(r))});d&&(o=[d])}if(!o.length)return r==="selected"?"no colonist selected (use 'select next')":`no colonist found matching '${r}'`;if(n==="check"){const d=o[0],h=((a=d.profile)==null?void 0:a.name)||"Unknown";if(!d.health)return`${h}: No health system initialized. Use 'health init' to initialize.`;const c=Math.round((d.health.totalPain||0)*100),f=((l=d.health.injuries)==null?void 0:l.length)||0,u=Math.round((d.health.consciousness||1)*100),A=Math.round((d.health.mobility||1)*100),g=Math.round((d.health.manipulation||1)*100);let p=`${h}: Pain=${c}%, Injuries=${f}, Consciousness=${u}%, Mobility=${A}%, Manipulation=${g}%`;if(f>0){const w=d.health.injuries.slice(0,3).map(k=>`${k.type}(${Math.round(k.severity*100)}%)`).join(", ");p+=` | Injuries: ${w}${f>3?"...":""}`}return p}else if(n==="init"){let d=0;for(const h of o)h.health||(He(h),d++);return`initialized health system for ${d} colonist(s)`}else return"usage: health check|init [target]. Target: selected,all,name"},"health check|init [target] — check health status or initialize health system"),e("resources",(t,s)=>{const n=(s[0]||"").toLowerCase();if(n==="unlimited"||n==="god"||n==="infinite")return t.resourceSystem.setResource("wood",999999),t.resourceSystem.setResource("stone",999999),t.resourceSystem.setResource("food",999999),t.resourceSystem.setResource("medicine",999999),t.resourceSystem.setResource("herbal",999999),t.resourceSystem.setResource("wheat",999999),t.resourceSystem.setResource("bread",999999),"resources set to unlimited (999999 each)";if(n==="add"){const r=(s[1]||"").toLowerCase(),o=Math.max(1,parseInt(s[2]||"100",10)||100),a=["wood","stone","food","medicine","herbal","wheat","bread"];return a.includes(r)?(t.resourceSystem.setResource(r,t.resourceSystem.getResource(r)+o),`added ${o} ${r}`):`invalid resource type '${r}'. Use: ${a.join(", ")}`}else if(n==="set"){const r=(s[1]||"").toLowerCase(),o=Math.max(0,parseInt(s[2]||"0",10)||0),a=["wood","stone","food","medicine","herbal","wheat","bread"];return a.includes(r)?(t.resourceSystem.setResource(r,o),`set ${r} to ${o}`):`invalid resource type '${r}'. Use: ${a.join(", ")}`}else if(n==="show"||n==="list"||n===""){const r=t.resourceSystem.getResourcesRef();return`Wood:${r.wood} Stone:${r.stone} Food:${r.food} Medicine:${r.medicine} Herbal:${r.herbal} Wheat:${r.wheat} Bread:${r.bread}`}else return"usage: resources [unlimited|add|set|show] [type] [amount]"},"resources [action] — manage resources. Actions: unlimited, add <type> <amt>, set <type> <amt>, show"),e("kill",(t,s)=>{var r,o;const n=(s[0]||"enemies").toLowerCase();if(n==="enemies"||n==="enemy"){const a=t.enemies.length;return t.enemies.length=0,`killed ${a} enemies`}else{if(n==="selected")return t.selColonist?(t.selColonist.alive=!1,t.selColonist.hp=0,`killed ${((r=t.selColonist.profile)==null?void 0:r.name)||"selected colonist"}`):"no colonist selected";if(n==="all"){const a=t.colonists.filter(l=>l.alive).length;for(const l of t.colonists)l.alive=!1,l.hp=0;return`killed ${a} colonists`}else{const a=t.colonists.find(l=>{var d,h;return l.alive&&((h=(d=l.profile)==null?void 0:d.name)==null?void 0:h.toLowerCase().includes(n))});return a?(a.alive=!1,a.hp=0,`killed ${((o=a.profile)==null?void 0:o.name)||n}`):`no colonist found matching '${n}'`}}},"kill [target] — kill entities. Target: enemies,selected,all,name"),e("heal",(t,s)=>{const n=(s[0]||"selected").toLowerCase();let r=[];if(n==="all")r=t.colonists.filter(o=>o.alive);else if(n==="selected")r=t.selColonist?[t.selColonist]:[];else{const o=t.colonists.find(a=>{var l,d;return a.alive&&((d=(l=a.profile)==null?void 0:l.name)==null?void 0:d.toLowerCase().includes(n))});o&&(r=[o])}if(!r.length)return n==="selected"?"no colonist selected (use 'select next')":`no colonist found matching '${n}'`;for(const o of r)o.hp=100,o.health&&o.health.injuries&&(o.health.injuries=[],o.health.totalPain=0,o.health.bleeding=0,o.health.consciousness=1,o.health.mobility=1,o.health.manipulation=1),o.hunger=0,o.fatigue=0;return`fully healed ${r.length} colonist(s)`},"heal [target] — fully heal colonist(s). Target: selected,all,name"),e("godmode",(t,s)=>{const n=(s[0]||"selected").toLowerCase();let r=[];if(n==="all")r=t.colonists.filter(a=>a.alive);else if(n==="selected")r=t.selColonist?[t.selColonist]:[];else{const a=t.colonists.find(l=>{var d,h;return l.alive&&((h=(d=l.profile)==null?void 0:d.name)==null?void 0:h.toLowerCase().includes(n))});a&&(r=[a])}if(!r.length)return n==="selected"?"no colonist selected (use 'select next')":`no colonist found matching '${n}'`;for(const a of r)a.godmode=!a.godmode,a.godmode&&(a.hp=100,a.hunger=0,a.fatigue=0);return`godmode ${r[0].godmode?"enabled":"disabled"} for ${r.length} colonist(s)`},"godmode [target] — toggle godmode (no damage/hunger/fatigue). Target: selected,all,name")}function Ia(i){const e=i.debugConsole;e&&(e.open=!e.open)}function Ba(i,e){const t=i.debugConsole;if(!t||!t.open)return!1;if(e.key==="Escape")return t.open=!1,!0;if(e.key==="Enter"){const s=t.input.trim();return s.length&&(t.history.unshift(s),t.historyIndex=-1,Da(i,s),t.input=""),!0}return e.key==="Backspace"?(t.input=t.input.slice(0,-1),!0):e.key==="ArrowUp"?(t.history.length&&(t.historyIndex=Math.min(t.historyIndex+1,t.history.length-1),t.input=t.history[t.historyIndex]),!0):e.key==="ArrowDown"?(t.historyIndex>0?(t.historyIndex-=1,t.input=t.history[t.historyIndex]):(t.historyIndex=-1,t.input=""),!0):e.key.length===1&&!e.ctrlKey&&!e.metaKey?(t.input+=e.key,!0):!1}function Da(i,e){const t=i.debugConsole,[s,...n]=e.split(/\s+/),r=t.commands.get(s.toLowerCase());if(!r){t.output.push(`unknown command: ${s}`),di(t);return}try{const o=r(i,n);o&&t.output.push(o)}catch(o){t.output.push(`error: ${(o==null?void 0:o.message)||o}`)}di(t)}function di(i){i.output.length>10&&i.output.splice(0,i.output.length-10)}function Ea(i){const e=i.debugConsole;if(!e||!e.open)return;const t=i.ctx,s=10,n=i.canvas.width,r=i.canvas.height,a=i.scale(i.isTouch?86:64)+8,l=Math.min(220,Math.max(140,Math.round(r*.25)));t.save(),t.resetTransform(),t.globalAlpha=.92,t.fillStyle="#0b1220cc";const d=r-a-l;t.fillRect(0,d,n,l),t.globalAlpha=1,t.strokeStyle="#ffffffff",t.lineWidth=1,t.strokeRect(.5,d+.5,n-1,l-1),t.globalAlpha=1,t.fillStyle="#c7d2fe";const h=i.isTouch?17:15;t.font=`${h}px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace`,t.textAlign="left",t.textBaseline="alphabetic";let c=d+s+4;for(const g of e.output)t.fillText(g,s,c),c+=h+5;const f=`> ${e.input}`;t.fillStyle="#e5e7eb";const u=r-a-s;if(t.fillText(f,s,u),performance.now()%1e3<600){const g=t.measureText(f),p=g.width,w=g.actualBoundingBoxAscent||h*.9,k=g.actualBoundingBoxDescent||h*.2,M=s+p+2;t.strokeStyle="#e5e7eb",t.lineWidth=1,t.beginPath(),t.moveTo(M,u-w),t.lineTo(M,u+k),t.stroke()}t.restore()}class Fa{constructor(){v(this,"colonists",[]);v(this,"enemies",[]);v(this,"buildings",[]);v(this,"trees",[]);v(this,"rocks",[]);v(this,"bullets",[]);v(this,"particles",[]);v(this,"resources",{wood:0,stone:0,food:0,medicine:5,herbal:3});v(this,"BASE_STORAGE",200);v(this,"storageFullWarned",!1);v(this,"day",1);v(this,"tDay",0);v(this,"dayLength",180);v(this,"fastForward",1);v(this,"paused",!1);v(this,"prevIsNight",!1);v(this,"messages",[]);v(this,"selectedBuild","house");v(this,"selColonist",null);v(this,"hotbar",["house","farm","turret","wall","stock","tent","warehouse","well","infirmary"]);v(this,"respawnTimer",0);v(this,"assignedTargets",new WeakSet);v(this,"buildReservations",new Map);v(this,"insideCounts",new Map);v(this,"sleepReservations",new Map)}isNight(){return this.tDay>.5}reset(){this.colonists=[],this.enemies=[],this.buildings=[],this.trees=[],this.rocks=[],this.bullets=[],this.particles=[],this.resources={wood:50,stone:30,food:20,medicine:5,herbal:3},this.storageFullWarned=!1,this.day=1,this.tDay=0,this.fastForward=1,this.paused=!1,this.prevIsNight=!1,this.messages=[],this.selectedBuild="house",this.selColonist=null,this.respawnTimer=0,this.assignedTargets=new WeakSet,this.buildReservations=new Map,this.insideCounts=new Map,this.sleepReservations=new Map}}class La{constructor(){v(this,"day",1);v(this,"tDay",0);v(this,"dayLength",1440);v(this,"fastForward",1);v(this,"paused",!1);v(this,"prevIsNight",!1)}update(e){if(this.paused)return;const t=e*this.fastForward;this.tDay+=t/this.dayLength,this.tDay>=1&&(this.tDay-=1,this.day++)}isNight(){return this.tDay>.5}didNightJustStart(){const e=this.isNight(),t=e&&!this.prevIsNight;return this.prevIsNight=e,t}toggleFastForward(){this.fastForward=this.fastForward===1?6:1}togglePause(){this.paused=!this.paused}setPaused(e){this.paused=e}getEffectiveDt(e){return this.paused?0:e*this.fastForward}getDay(){return this.day}getTimeOfDay(){return this.tDay}getHour(){return Math.floor(this.tDay*24)}getDayLength(){return this.dayLength}getFastForward(){return this.fastForward}isPaused(){return this.paused}setDay(e){this.day=e}setTimeOfDay(e){this.tDay=e}setFastForward(e){this.fastForward=e}reset(){this.day=1,this.tDay=0,this.fastForward=1,this.paused=!1,this.prevIsNight=!1}getCurrentHour(){return Math.floor(this.tDay*24)}}class Wa{constructor(){v(this,"camera",{x:0,y:0,zoom:1});v(this,"canvasWidth",0);v(this,"canvasHeight",0);v(this,"DPR",1);v(this,"minZoom",.5);v(this,"maxZoom",2.5);v(this,"panSpeed",500)}setCanvasDimensions(e,t,s){this.canvasWidth=e,this.canvasHeight=t,this.DPR=s}pan(e,t){this.camera.x+=e*this.DPR/this.camera.zoom,this.camera.y+=t*this.DPR/this.camera.zoom}panWithSpeed(e,t,s){const n=this.panSpeed*s/this.camera.zoom;this.camera.x+=e*n,this.camera.y+=t*n}setPosition(e,t){this.camera.x=e,this.camera.y=t}centerOn(e,t){const s=this.canvasWidth/this.DPR/this.camera.zoom,n=this.canvasHeight/this.DPR/this.camera.zoom;this.camera.x=e-s/2,this.camera.y=t-n/2}zoom(e){const t=this.camera.zoom;if(this.camera.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.camera.zoom+e)),t!==this.camera.zoom){const s=this.camera.x+this.canvasWidth/this.DPR/(2*t),n=this.camera.y+this.canvasHeight/this.DPR/(2*t);this.camera.x=s-this.canvasWidth/this.DPR/(2*this.camera.zoom),this.camera.y=n-this.canvasHeight/this.DPR/(2*this.camera.zoom)}}setZoom(e){this.camera.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,e))}screenToWorld(e,t){return{x:e*this.DPR/this.camera.zoom+this.camera.x,y:t*this.DPR/this.camera.zoom+this.camera.y}}worldToScreen(e,t){return{x:(e-this.camera.x)*this.camera.zoom/this.DPR,y:(t-this.camera.y)*this.camera.zoom/this.DPR}}isVisible(e,t,s,n){const r=this.canvasWidth/this.DPR/this.camera.zoom,o=this.canvasHeight/this.DPR/this.camera.zoom;return!(e+s<this.camera.x||e>this.camera.x+r||t+n<this.camera.y||t>this.camera.y+o)}getCamera(){return{...this.camera}}getX(){return this.camera.x}getY(){return this.camera.y}getZoom(){return this.camera.zoom}getCameraRef(){return this.camera}reset(){this.camera.x=0,this.camera.y=0,this.camera.zoom=1}}class za{constructor(){v(this,"resources",{wood:0,stone:0,food:0,medicine:5,herbal:3,wheat:0,bread:0});v(this,"baseStorage",200);v(this,"storageFullWarned",!1)}getStorageCapacity(e=0,t=0){return this.baseStorage+e*500+t*100}getTotalStored(){return this.resources.wood+this.resources.stone+this.resources.food}isStorageFull(e){return this.getTotalStored()>=e}addResource(e,t,s){if(e==="medicine"||e==="herbal"||e==="wheat"||e==="bread")return this.resources[e]+=t,t;const n=this.getTotalStored(),r=Math.max(0,s-n),o=Math.min(t,r);return o>0&&(this.resources[e]+=o),o<t&&!this.storageFullWarned?(this.storageFullWarned=!0,o):(o===t&&(this.storageFullWarned=!1),o)}subtractResource(e,t){return this.resources[e]>=t?(this.resources[e]-=t,!0):!1}hasCost(e){return!(e.wood&&this.resources.wood<e.wood||e.stone&&this.resources.stone<e.stone||e.food&&this.resources.food<e.food||e.medicine&&this.resources.medicine<e.medicine||e.herbal&&this.resources.herbal<e.herbal||e.wheat&&this.resources.wheat<e.wheat||e.bread&&this.resources.bread<e.bread)}payCost(e){return this.hasCost(e)?(e.wood&&(this.resources.wood-=e.wood),e.stone&&(this.resources.stone-=e.stone),e.food&&(this.resources.food-=e.food),e.medicine&&(this.resources.medicine-=e.medicine),e.herbal&&(this.resources.herbal-=e.herbal),e.wheat&&(this.resources.wheat-=e.wheat),e.bread&&(this.resources.bread-=e.bread),!0):!1}getResource(e){return this.resources[e]}getAllResources(){return{...this.resources}}getResourcesRef(){return this.resources}setResource(e,t){this.resources[e]=Math.max(0,t)}reset(){this.resources={wood:50,stone:30,food:20,medicine:5,herbal:3,wheat:0,bread:0},this.storageFullWarned=!1}formatCost(e){const t=[];return e.wood&&t.push(`${e.wood}w`),e.stone&&t.push(`${e.stone}s`),e.food&&t.push(`${e.food}f`),e.medicine&&t.push(`${e.medicine}m`),e.herbal&&t.push(`${e.herbal}h`),e.wheat&&t.push(`${e.wheat}wh`),e.bread&&t.push(`${e.bread}br`),t.join(" ")}}class Na{constructor(){v(this,"mouse",{x:0,y:0,wx:0,wy:0,down:!1,rdown:!1});v(this,"keyState",{});v(this,"once",new Set);v(this,"touchLastPan",null);v(this,"touchLastDist",null);v(this,"lastInputWasTouch",!1);v(this,"inputFilter")}bindKeyboardEvents(e){this.inputFilter=e,window.addEventListener("keydown",t=>{if(this.inputFilter&&this.inputFilter())return;const s=t.key.toLowerCase();this.setKeyState(s,!0),(s===" "||s==="h"||s==="b"||s==="f"||s==="g"||s==="j"||s==="k"||s==="p"||s==="r"||s==="t"||s==="escape"||/^[1-9]$/.test(s)||s==="w"||s==="a"||s==="s"||s==="d"||s==="+"||s==="="||s==="-"||s==="_")&&t.preventDefault()}),window.addEventListener("keyup",t=>{if(this.inputFilter&&this.inputFilter())return;const s=t.key.toLowerCase();this.setKeyState(s,!1)})}updateMouseWorldCoords(e){const t=e(this.mouse.x,this.mouse.y);this.mouse.wx=t.x,this.mouse.wy=t.y}setMousePosition(e,t){this.mouse.x=e,this.mouse.y=t}setMouseDown(e){this.mouse.down=e}setMouseRightDown(e){this.mouse.rdown=e}getMouse(){return this.mouse}getMouseRef(){return this.mouse}setKeyState(e,t){this.keyState[e]=t,t||this.once.delete(e)}isKeyPressed(e){return!!this.keyState[e]}keyPressed(e){return this.keyState[e]&&!this.once.has(e)?(this.once.add(e),!0):!1}getKeyStateRef(){return this.keyState}setTouchPan(e){this.touchLastPan=e}getTouchPan(){return this.touchLastPan}setTouchDist(e){this.touchLastDist=e}getTouchDist(){return this.touchLastDist}setLastInputWasTouch(e){this.lastInputWasTouch=e}wasLastInputTouch(){return this.lastInputWasTouch}reset(){this.mouse={x:0,y:0,wx:0,wy:0,down:!1,rdown:!1},this.keyState={},this.once=new Set,this.touchLastPan=null,this.touchLastDist=null,this.lastInputWasTouch=!1}}class Oa{constructor(){v(this,"selectedBuild","house");v(this,"hotbar",["house","farm","turret","wall","stock","tent","warehouse","well","infirmary"]);v(this,"showBuildMenu",!1);v(this,"selColonist",null);v(this,"follow",!1);v(this,"pendingPlacement",null);v(this,"pendingDragging",!1);v(this,"menuRects",[]);v(this,"hotbarRects",[]);v(this,"placeUIRects",[]);v(this,"colonistPanelRect",null);v(this,"colonistPanelCloseRect",null);v(this,"colonistProfileTab","bio");v(this,"colonistTabRects",[]);v(this,"contextMenu",null);v(this,"contextMenuRects",[]);v(this,"longPressTimer",null);v(this,"longPressStartPos",null);v(this,"longPressStartTime",null);v(this,"longPressTarget",null);v(this,"longPressTargetType",null);v(this,"lastPaintCell",null);v(this,"eraseDragStart",null)}selectBuilding(e){this.selectedBuild=e}toggleBuildMenu(){this.showBuildMenu=!this.showBuildMenu}openBuildMenu(){this.showBuildMenu=!0}closeBuildMenu(){this.showBuildMenu=!1}selectColonist(e){this.selColonist=e}deselectColonist(){this.selColonist=null,this.follow=!1}toggleFollow(){this.selColonist&&(this.follow=!this.follow)}setPendingPlacement(e){this.pendingPlacement=e,this.pendingDragging=!1}cancelPendingPlacement(){this.pendingPlacement=null,this.pendingDragging=!1}startLongPress(e,t,s,n){this.longPressStartPos={x:e,y:t},this.longPressStartTime=Date.now(),this.longPressTarget=s,this.longPressTargetType=n,this.longPressTimer=window.setTimeout(()=>{},500)}cancelLongPress(){this.longPressTimer!==null&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.longPressStartPos=null,this.longPressStartTime=null,this.longPressTarget=null,this.longPressTargetType=null}isLongPressing(){return this.longPressTimer!==null}hideContextMenu(){this.contextMenu=null,this.contextMenuRects=[]}showContextMenu(e,t,s){this.contextMenu={...e,visible:!0,x:t,y:s}}reset(){this.selectedBuild="house",this.showBuildMenu=!1,this.selColonist=null,this.follow=!1,this.pendingPlacement=null,this.pendingDragging=!1,this.menuRects=[],this.hotbarRects=[],this.placeUIRects=[],this.colonistPanelRect=null,this.colonistPanelCloseRect=null,this.colonistProfileTab="bio",this.colonistTabRects=[],this.contextMenu=null,this.contextMenuRects=[],this.cancelLongPress(),this.lastPaintCell=null,this.eraseDragStart=null}}function Ga(i,e,t){i.setTransform(1,0,0,1,0,0),i.fillStyle=Z.sky,t?(t.optimize(),t.clearDirty(i,Z.sky)):i.fillRect(0,0,e.width,e.height)}function Ha(i,e){i.translate(-e.x*e.zoom,-e.y*e.zoom),i.scale(e.zoom,e.zoom)}function Ya(i,e){i.save(),i.fillStyle=Z.ground,i.fillRect(0,0,G.w,G.h);const t=i.getTransform?i.getTransform():null,s=t?Math.max(.001,t.a):1;i.lineWidth=Math.max(1/s,.75/s);let n=0,r=G.w,o=0,a=G.h;if(e){const l=i.canvas.width/s,d=i.canvas.height/s;n=Math.max(0,Math.floor(e.x/m)*m),r=Math.min(G.w,Math.ceil((e.x+l)/m)*m),o=Math.max(0,Math.floor(e.y/m)*m),a=Math.min(G.h,Math.ceil((e.y+d)/m)*m)}i.strokeStyle="rgba(30, 41, 59, 0.5)",i.beginPath();for(let l=n;l<=r;l+=m)i.moveTo(l,o),i.lineTo(l,a);for(let l=o;l<=a;l+=m)i.moveTo(n,l),i.lineTo(r,l);i.stroke(),i.restore()}function qa(i,e,t){if(!e)return;i.save();const s=Math.max(0,Math.floor(t.x/m)),n=Math.max(0,Math.floor(t.y/m)),r=Math.min(e.cols,Math.ceil((t.x+i.canvas.width/t.zoom)/m)+1),o=Math.min(e.rows,Math.ceil((t.y+i.canvas.height/t.zoom)/m)+1);for(let a=n;a<o;a++)for(let l=s;l<r;l++){const d=a*e.cols+l,h=qe(e.floors[d]);if(h===$.NONE)continue;const c=Bt[h];if(!c)continue;const f=l*m,u=a*m;i.fillStyle=c.color,i.fillRect(f,u,m,m),c.pattern==="stripes"&&c.secondaryColor?(i.fillStyle=c.secondaryColor,i.fillRect(f,u,m,m/4),i.fillRect(f,u+m/2,m,m/4)):c.pattern==="noise"&&c.secondaryColor&&(i.fillStyle=c.secondaryColor,(l+a)%2===0&&i.fillRect(f+m/4,u+m/4,m/2,m/2)),i.strokeStyle="rgba(0, 0, 0, 0.1)",i.lineWidth=1,i.strokeRect(f,u,m,m)}i.restore()}function hi(i,e,t,s,n){i.fillStyle=n,i.beginPath(),i.arc(e,t,s,0,Math.PI*2),i.fill()}function Ua(i,e,t,s,n,r,o=0){i.fillStyle=r,i.beginPath();for(let a=0;a<n;a++){const l=o+a*2*Math.PI/n,d=e+Math.cos(l)*s,h=t+Math.sin(l)*s;a===0?i.moveTo(d,h):i.lineTo(d,h)}i.closePath(),i.fill()}function fi(i,e,t,s=10,n=Z.colonist){i.save(),i.translate(e,t);const r="#0b0f14",o=s*.32,a=-s*.3;i.fillStyle=n,i.beginPath(),i.arc(0,a,o,0,Math.PI*2),i.fill(),i.strokeStyle=r,i.lineWidth=1,i.beginPath(),i.arc(0,a,o+.5,0,Math.PI*2),i.stroke();const l=s*.55,d=s*.55,h=-s*.05;i.fillStyle=n,i.beginPath(),i.moveTo(-l/2,h-d/2),i.lineTo(l/2,h-d/2),i.lineTo(l/2,h+d/2),i.lineTo(-l/2,h+d/2),i.closePath(),i.fill(),i.strokeStyle=r,i.stroke();const c=s*.18,f=s*.5,u=h+d/2+f*.1;i.fillStyle=n,i.fillRect(-c-.6,u-f,c,f),i.fillRect(.6,u-f,c,f),i.strokeStyle=r,i.strokeRect(-c-.6,u-f,c,f),i.strokeRect(.6,u-f,c,f),i.restore()}function ji(i,e,t,s,n=8,r=!1){var k;const o=s.profile;if(!o){i.fillStyle=r?"#93c5fd":Z.colonist,i.beginPath(),i.arc(e,t,n,0,Math.PI*2),i.fill();return}i.save(),i.translate(e,t);let a="south";if(s.direction!==void 0){const x=(s.direction*180/Math.PI+360)%360;x>=315||x<45?a="east":x>=45&&x<135?a="south":x>=135&&x<225?a="east":a="north"}const l=s.direction!==void 0&&(s.direction*180/Math.PI+360)%360>=135&&(s.direction*180/Math.PI+360)%360<225;l&&i.scale(-1,1);const d=32,h=48;r&&(i.fillStyle="rgba(147, 197, 253, 0.3)",i.beginPath(),i.arc(0,0,n+2,0,Math.PI*2),i.fill());const c=pe.getInstance();if(!c||!c.isLoaded()){console.log("Assets not loaded, using fallback circles for colonist:",(o==null?void 0:o.name)||"unknown"),i.fillStyle=o.avatar.clothing,i.beginPath(),i.arc(0,0,n,0,Math.PI*2),i.fill(),i.restore();return}const f=o.avatar.sprites,u=(M,x)=>{const C=document.createElement("canvas");C.width=d,C.height=h;const b=C.getContext("2d");b.drawImage(M,0,0,d,h);const S=b.getImageData(0,0,d,h),T=S.data,D=x.replace("#",""),I=parseInt(D.substr(0,2),16),O=parseInt(D.substr(2,2),16),z=parseInt(D.substr(4,2),16);for(let H=0;H<T.length;H+=4)if(T[H+3]>0){const j=(T[H]+T[H+1]+T[H+2])/765;T[H]=I*j,T[H+1]=O*j,T[H+2]=z*j}return b.putImageData(S,0,0),C},A=Je.getComposedSprite(s,a,c,u);if(A)i.drawImage(A,-d/2,-28.799999999999997);else{const M=c.getColonistSprite("body",f.bodyType,a);if(M){const S=u(M,o.avatar.skinTone);i.drawImage(S,-d/2,-28.799999999999997)}else Math.random()<.01&&console.warn(`Body sprite not found: body_${f.bodyType}_${a}`);const x=c.getColonistSprite("apparel",f.apparelType,a);if(x){const S=u(x,o.avatar.clothing);i.drawImage(S,-d/2,-28.799999999999997)}else Math.random()<.01&&console.warn(`Apparel sprite not found: apparel_${f.apparelType}_${a}`);const C=c.getColonistSprite("head",f.headType,a);if(C){const S=u(C,o.avatar.skinTone);i.drawImage(S,-d/2,-28.799999999999997)}const b=c.getColonistSprite("hair",f.hairStyle,a);if(b){const S=u(b,o.avatar.hairColor);i.drawImage(S,-d/2,-28.799999999999997)}}i.save(),l&&i.scale(-1,1);const g=oi&&oi(s)||"Okay";let p="#22c55e";switch(g){case"Happy":p="#22c55e";break;case"Content":p="#84cc16";break;case"Okay":p="#eab308";break;case"Injured":p="#ef4444";break;case"Starving":p="#dc2626";break;case"Exhausted":p="#6b7280";break;case"Terrified":p="#7c2d12";break;case"Resting":p="#3b82f6";break;default:p="#eab308";break}i.fillStyle=p,i.beginPath(),i.arc(0,-28.799999999999997+h*.1,3,0,Math.PI*2),i.fill(),i.strokeStyle="#000000",i.lineWidth=.5,i.stroke(),((k=s.playerCommand)==null?void 0:k.issued)&&s.playerCommand.expires&&(s.t||0)<s.playerCommand.expires&&(i.font="bold 14px system-ui",i.fillStyle="#fbbf24",i.strokeStyle="#000000",i.lineWidth=2,i.strokeText("❗",12,-28.799999999999997+h*.15),i.fillText("❗",12,-28.799999999999997+h*.15)),s.carryingWheat&&s.carryingWheat>0?(i.font="bold 12px system-ui",i.fillText("🌾",0,-28.799999999999997-5)):s.carryingBread&&s.carryingBread>0&&(i.font="bold 12px system-ui",i.fillText("🍞",0,-28.799999999999997-5)),i.restore(),i.restore()}function Qa(i,e){if(e.kind==="path"){i.fillStyle="#1f2937",i.fillRect(e.x,e.y,e.w,e.h),i.strokeStyle="#0b0f14cc",i.strokeRect(e.x+.5,e.y+.5,e.w-1,e.h-1);return}if(e.kind==="door"){const t=Xs(e);if(i.save(),i.translate(e.x+e.w/2,e.y+e.h/2),i.fillStyle="#4a3520",i.fillRect(-e.w/2,-e.h/2,e.w,3),i.fillRect(-e.w/2,e.h/2-3,e.w,3),i.fillRect(-e.w/2,-e.h/2,3,e.h),i.fillRect(e.w/2-3,-e.h/2,3,e.h),t<1){const s=-t*(e.w/2-4),n=t*(e.w/2-4);i.fillStyle=e.color,i.fillRect(-e.w/2+3+s,-e.h/2+3,e.w/2-6,e.h-6),i.strokeStyle="#2a1a10",i.strokeRect(-e.w/2+3+s,-e.h/2+3,e.w/2-6,e.h-6),i.fillStyle=e.color,i.fillRect(3-n,-e.h/2+3,e.w/2-6,e.h-6),i.strokeStyle="#2a1a10",i.strokeRect(3-n,-e.h/2+3,e.w/2-6,e.h-6),i.strokeStyle="#3a2510",i.lineWidth=1;for(let r=1;r<3;r++){const o=-e.w/2+3+s+(e.w/2-6)*r/3,a=3-n+(e.w/2-6)*r/3;i.beginPath(),i.moveTo(o,-e.h/2+6),i.lineTo(o,e.h/2-6),i.stroke(),i.beginPath(),i.moveTo(a,-e.h/2+6),i.lineTo(a,e.h/2-6),i.stroke()}}if(i.restore(),!e.done){i.fillStyle="#0b1220",i.fillRect(e.x,e.y-6,e.w,4),i.fillStyle="#6ee7ff";const s=1-e.buildLeft/e.build;i.fillRect(e.x,e.y-6,s*e.w,4)}if(e.done&&e.hp<100){const n=e.hp/100;i.fillStyle="#0b1220",i.fillRect(e.x,e.y+e.h+2,e.w,3),i.fillStyle=n>.5?"#4ade80":n>.25?"#fbbf24":"#ef4444",i.fillRect(e.x,e.y+e.h+2,e.w*n,3)}return}if(e.kind==="house"){const t=pe.getInstance(),s=t.getImage("house");s&&t.isLoaded()?(i.drawImage(s,e.x,e.y,e.w,e.h),i.strokeStyle="#0b0f14cc",i.strokeRect(e.x+.5,e.y+.5,e.w-1,e.h-1)):(i.fillStyle=e.color,i.fillRect(e.x,e.y,e.w,e.h),i.strokeStyle="#0b0f14cc",i.strokeRect(e.x+.5,e.y+.5,e.w-1,e.h-1))}else if(e.kind==="farm"&&e.done){const t=pe.getInstance(),s=e.growth||0;let n="wheat_stage_1";s>=.67?n="wheat_stage_3":s>=.33&&(n="wheat_stage_2");const r=t.getImage(n);r&&t.isLoaded()?(i.drawImage(r,e.x,e.y,e.w,e.h),i.strokeStyle="#0b0f14cc",i.strokeRect(e.x+.5,e.y+.5,e.w-1,e.h-1)):(i.fillStyle=e.color,i.fillRect(e.x,e.y,e.w,e.h),i.strokeStyle="#0b0f14cc",i.strokeRect(e.x+.5,e.y+.5,e.w-1,e.h-1),s>0&&(i.fillStyle="#4ade80",i.fillRect(e.x+2,e.y+e.h-4,(e.w-4)*Math.min(s,1),2)))}else i.fillStyle=e.color,i.fillRect(e.x,e.y,e.w,e.h),i.strokeStyle="#0b0f14cc",i.strokeRect(e.x+.5,e.y+.5,e.w-1,e.h-1),e.kind==="turret"&&e.flashTimer>0&&(i.fillStyle="#ffffff88",i.fillRect(e.x,e.y,e.w,e.h));if(!e.done){i.fillStyle="#0b1220",i.fillRect(e.x,e.y-6,e.w,4),i.fillStyle="#6ee7ff";const t=1-e.buildLeft/e.build;i.fillRect(e.x,e.y-6,t*e.w,4)}if(e.kind!=="house"&&!(e.kind==="farm"&&e.done)){i.fillStyle="#0b0f14aa",i.font="bold 12px system-ui";const t=e.x+e.w/2,s=e.y+e.h/2;let n="B";e.kind==="hq"?n="HQ":e.kind==="farm"?n="F":e.kind==="turret"?n="T":e.kind==="wall"?n="W":e.kind==="stock"?n="S":e.kind==="tent"?n="R":e.kind==="warehouse"?n="WH":e.kind==="well"?n="WL":e.kind==="infirmary"?n="I":e.kind==="bed"?n=e.isMedicalBed?"⚕️":"🛏":e.kind==="stove"?n="🔥":e.kind==="pantry"&&(n="🍞"),i.textAlign="center",i.textBaseline="middle",i.fillText(n,t,s)}if(e.kind==="stove"&&e.done&&e.cookingProgress!==void 0&&e.cookingProgress>0&&(i.fillStyle="#0b1220",i.fillRect(e.x,e.y+e.h+2,e.w,4),i.fillStyle="#ff6347",i.fillRect(e.x,e.y+e.h+2,e.w*e.cookingProgress,4)),e.kind==="turret"&&e.range){const t=e.x+e.w/2,s=e.y+e.h/2;i.fillStyle="rgba(226, 243, 255, 0.07)",i.beginPath(),i.arc(t,s,e.range,0,Math.PI*2),i.fill()}}function ja(i,e){for(const t of e)t.particles&&t.particles.length>0&&qi(i,t.particles),i.strokeStyle="rgba(224, 242, 254, 0.15)",i.lineWidth=1,i.beginPath(),i.moveTo(t.x,t.y),i.lineTo(t.tx,t.ty),i.stroke()}function Xa(i,e,t,s){s.uiScale;const n=s.scale(s.isTouch?14:10),r=s.scale(s.isTouch?56:44),o=e.width;i.fillStyle="#0b122088",i.fillRect(0,0,o,r),i.strokeStyle="#1e293b",i.lineWidth=1,i.strokeRect(0,.5,o,r),i.fillStyle="#dbeafe",i.font=s.getScaledFont(s.isTouch?18:16,"600");let a=n;const l=Math.max(s.scale(s.isTouch?170:130),Math.min(s.scale(s.isTouch?260:220),Math.round(e.width*.14)));if(ye(i,a,s.scale(12),`Wood: ${Math.floor(t.res.wood)}`,"#b08968",s),a+=l,ye(i,a,s.scale(12),`Stone: ${Math.floor(t.res.stone)}`,"#9aa5b1",s),a+=l,ye(i,a,s.scale(12),`Food: ${Math.floor(t.res.food)}`,"#9ae6b4",s),a+=l,(t.res.wheat||0)>0&&(ye(i,a,s.scale(12),`Wheat: ${Math.floor(t.res.wheat||0)}`,"#f4d03f",s),a+=l),(t.res.bread||0)>0&&(ye(i,a,s.scale(12),`Bread: ${Math.floor(t.res.bread||0)}`,"#d2691e",s),a+=l),t.storage){const k=Math.floor(t.storage.used/t.storage.max*100),M=k>90?"#ef4444":k>70?"#eab308":"#22c55e";ye(i,a,s.scale(12),`Storage: ${Math.floor(t.storage.used)}/${t.storage.max} (${k}%)`,M,s),a+=Math.max(l,s.scale(s.isTouch?260:200))}const d=`Colonists: ${t.colonists}/${t.cap}`;ye(i,a,s.scale(12),d,"#93c5fd",s),a+=Math.max(l,s.scale(s.isTouch?260:210));const h=`Hiding: ${t.hiding}`;ye(i,a,s.scale(12),h,"#60a5fa",s),a+=Math.max(s.scale(s.isTouch?180:140),l*.9|0);const c=Math.floor(t.tDay*24),f=Math.floor((t.tDay*24-c)*60),u=`Day ${t.day} — ${c.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")} ${t.isNight?"🌙":"☀️"}`;ye(i,a,s.scale(12),u,t.isNight?"#ffd166":"#6ee7ff",s);const A=e.height-s.scale(s.isTouch?86:64),g=Math.max(s.scale(s.isTouch?170:140),Math.min(s.scale(s.isTouch?260:220),(e.width-n*2)/t.hotbar.length));a=n,i.fillStyle="#0b122088",i.fillRect(0,A,e.width,s.scale(s.isTouch?86:64)),i.strokeStyle="#1e293b",i.strokeRect(0,A+.5,e.width,s.scale(s.isTouch?86:64)),i.font=s.getScaledFont(s.isTouch?17:15);for(let k=0;k<t.hotbar.length;k++){const M=t.hotbar[k],x=a+s.scale(2),C=A+s.scale(s.isTouch?14:10),b=g-s.scale(6),S=s.scale(s.isTouch?60:44);Va(i,x,C,b,S,`${k+1}. ${M.name}`,M.cost,M.selected,s),Array.isArray(s.hotbarRects)&&(s.hotbarRects[k]={index:k,x,y:C,w:b,h:S}),a+=g}let p=r+s.scale(s.isTouch?12:8);const w=Math.min(s.scale(s.isTouch?520:420),e.width-n*2);for(let k=t.messages.length-1;k>=0;k--){const M=t.messages[k];Ja(i,o-w-n,p,M.text,w,s),p+=s.scale(s.isTouch?34:26)}}function ye(i,e,t,s,n,r){const o=i.measureText(s).width+r.scale(r.isTouch?28:24),a=r.scale(r.isTouch?32:26);i.fillStyle="#0f172a",i.fillRect(e,t,o,a),i.strokeStyle="#1e293b",i.strokeRect(e+.5,t+.5,o-1,a-1),i.fillStyle=n,i.fillRect(e+r.scale(3),t+r.scale(3),r.scale(r.isTouch?10:8),a-r.scale(6)),i.fillStyle="#dbeafe",i.fillText(s,e+r.scale(r.isTouch?18:16),t+r.scale(r.isTouch?22:18))}function Va(i,e,t,s,n,r,o,a,l){i.fillStyle=a?"#102034":"#0f172a",i.fillRect(e,t,s,n),i.strokeStyle=a?"#4b9fff":"#1e293b",i.strokeRect(e+.5,t+.5,s-1,n-1),i.fillStyle="#dbeafe",i.fillText(r,e+l.scale(10),t+l.scale(l.isTouch?36:28)),i.fillStyle="#9fb3c8",i.fillText(o,e+s-l.scale(l.isTouch?66:56),t+l.scale(l.isTouch?36:28))}function Ja(i,e,t,s,n,r){const o=r.scale(r.isTouch?30:24);i.fillStyle="#0f172aee",i.fillRect(e,t,n,o),i.strokeStyle="#1e293b",i.strokeRect(e+.5,t+.5,n-1,o-1),i.fillStyle="#dbeafe",i.fillText(s,e+r.scale(10),t+r.scale(r.isTouch?20:16))}function Za(i){if(!i.regionManager.isEnabled()){i.ctx.fillStyle="rgba(255, 0, 0, 0.8)",i.ctx.font="20px monospace",i.ctx.fillText("Regions Disabled",20,100);return}const e=i.ctx,t=i.regionManager.getRegions();i.regionManager.getRooms();const s=i.regionManager.builder.getRegionGrid();e.globalAlpha=.2;for(const r of t.values()){const o=r.id*137%360;e.fillStyle=`hsl(${o}, 70%, 50%)`;for(const a of r.cells){const l=a%s.cols*m,d=Math.floor(a/s.cols)*m;e.fillRect(l,d,m,m)}}e.globalAlpha=1,e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=1;for(const r of t.values())for(const o of r.cells){const a=o%s.cols,l=Math.floor(o/s.cols),d=a*m,h=l*m,c=[{dx:0,dy:-1},{dx:1,dy:0},{dx:0,dy:1},{dx:-1,dy:0}];for(const{dx:f,dy:u}of c){const A=a+f,g=l+u;if(A<0||g<0||A>=s.cols||g>=s.rows){e.strokeRect(d,h,m,m);continue}if(s.get(A,g)!==r.id){if(e.beginPath(),f===0){const w=h+(u>0?m:0);e.moveTo(d,w),e.lineTo(d+m,w)}else{const w=d+(f>0?m:0);e.moveTo(w,h),e.lineTo(w,h+m)}e.stroke()}}}e.strokeStyle="rgba(0, 255, 0, 0.8)",e.lineWidth=2;for(const r of t.values())for(const o of r.links){const a=o.x*m,l=o.y*m;e.beginPath(),o.edge===0?(e.moveTo(a,l),e.lineTo(a+o.span*m,l)):o.edge===1?(e.moveTo(a+m,l),e.lineTo(a+m,l+o.span*m)):o.edge===2?(e.moveTo(a,l+m),e.lineTo(a+o.span*m,l+m)):(e.moveTo(a,l),e.lineTo(a,l+o.span*m)),e.stroke()}e.fillStyle="white",e.font="10px monospace",e.textAlign="center",e.textBaseline="middle";for(const r of t.values()){let o=0,a=0;for(const h of r.cells){const c=h%s.cols,f=Math.floor(h/s.cols);o+=c*m+m/2,a+=f*m+m/2}const l=o/r.cells.size,d=a/r.cells.size;e.fillText(`R${r.id}`,l,d-6),r.roomId!==null&&e.fillText(`Room${r.roomId}`,l,d+6)}e.textAlign="left",e.textBaseline="top",e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(10,10,300,100),e.fillStyle="white",e.font="14px monospace";const n=i.regionManager.getStats();e.fillText(`Regions: ${n.regionCount}`,20,20),e.fillText(`Rooms: ${n.roomCount}`,20,40),e.fillText(`Avg Region Size: ${n.avgRegionSize.toFixed(1)} cells`,20,60),e.fillText(`Avg Room Size: ${n.avgRoomSize.toFixed(1)} regions`,20,80)}function Ka(i){const{ctx:e,camera:t,terrainGrid:s}=i;e.save();const n=Math.max(0,Math.floor(t.x/m)),r=Math.max(0,Math.floor(t.y/m)),o=Math.min(s.cols,Math.ceil((t.x+e.canvas.width/t.zoom)/m)),a=Math.min(s.rows,Math.ceil((t.y+e.canvas.height/t.zoom)/m));for(let l=r;l<a;l++)for(let d=n;d<o;d++){const h=l*s.cols+d,c=qe(s.floors[h]);if(c===$.NONE)continue;const f=Bt[c];if(!f)continue;const A=(p=>{const w=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(p);return w?{r:parseInt(w[1],16),g:parseInt(w[2],16),b:parseInt(w[3],16)}:{r:255,g:255,b:255}})(f.color);e.fillStyle=`rgba(${A.r}, ${A.g}, ${A.b}, 0.6)`,e.fillRect(d*m,l*m,m,m),e.strokeStyle="rgba(255, 255, 255, 0.4)",e.lineWidth=1,e.strokeRect(d*m,l*m,m,m),e.fillStyle="rgba(255, 255, 255, 0.8)",e.font="8px monospace",e.textAlign="center",e.textBaseline="middle";const g=c===$.BASIC_PATH?"P":c===$.STONE_ROAD?"R":c===$.WOODEN_FLOOR?"W":c===$.CONCRETE?"C":c===$.METAL_FLOOR?"M":c===$.CARPET?"Cp":"?";e.fillText(g,d*m+m/2,l*m+m/2)}e.restore()}function $a(i,e){const t=i.ctx,s=i.canvas.width,n=i.canvas.height,r=550,o=450,a=320,l=280,d=Math.max(.5,Math.min(.85,s/800)),h=Math.max(.5,Math.min(.85,n/600)),c=Math.min(d,h),f=Math.max(a,Math.min(i.scale(r*c),s*.9)),u=Math.max(l,Math.min(i.scale(o*c),n*.85)),A=i.scale(8),g=Math.max(A,(s-f)/2),p=i.scale(54),w=Math.max(A,Math.min(p,n-u-A));t.save(),t.fillStyle="#0b1220cc",t.fillRect(g,w,f,u),t.strokeStyle="#1e293b",t.strokeRect(g+.5,w+.5,f-1,u-1);let k,M,x,C;const b=i.scale(32),S=w+i.scale(12),T=[{id:"bio",label:"Bio",icon:"👤"},{id:"health",label:"Health",icon:"❤️"},{id:"gear",label:"Gear",icon:"🎒"},{id:"social",label:"Social",icon:"👥"},{id:"skills",label:"Skills",icon:"🛠️"},{id:"log",label:"Log",icon:"📜"}];i.colonistTabRects=[];const D=(f-i.scale(32))/T.length;for(let z=0;z<T.length;z++){const H=T[z],j=g+i.scale(16)+z*D,Y=i.colonistProfileTab===H.id;t.fillStyle=Y?"#1e293b":"#0f172a",t.fillRect(j,S,D,b),t.strokeStyle=Y?"#3b82f6":"#1e293b",t.strokeRect(j+.5,S+.5,D-1,b-1),t.fillStyle=Y?"#60a5fa":"#9ca3af",t.font=i.getScaledFont(10,"600"),t.textAlign="center",t.textBaseline="middle";const X=S+b/2;t.fillText(`${H.icon} ${H.label}`,j+D/2,X),i.colonistTabRects.push({tab:H.id,x:j,y:S,w:D,h:b})}const I=S+b+i.scale(8),O=u-(I-w)-i.scale(16);switch(t.save(),t.beginPath(),t.rect(g+i.scale(8),I,f-i.scale(16),O),t.clip(),i.colonistProfileTab){case"bio":_a(i,e,g+i.scale(16),I,f-i.scale(32),O);break;case"health":er(i,e,g+i.scale(16),I,f-i.scale(32),O);break;case"gear":ir(i,e,g+i.scale(16),I,f-i.scale(32),O);break;case"social":sr(i,e,g+i.scale(16),I,f-i.scale(32));break;case"skills":tr(i,e,g+i.scale(16),I,f-i.scale(32),O);break;case"log":nr(i,e,g+i.scale(16),I,f-i.scale(32),O);break}t.restore(),k=i.scale(26),M=i.scale(8),x=g+f-M-k,C=w+u-M-k,t.fillStyle="#0f172a",t.fillRect(x,C,k,k),t.strokeStyle="#1e293b",t.strokeRect(x+.5,C+.5,k-1,k-1),t.fillStyle="#dbeafe",t.font=i.getScaledFont(16,"700"),t.textAlign="center",t.textBaseline="middle",t.fillText("✕",x+k/2,C+k/2+i.scale(1)),t.fillStyle="#4b5563",t.font=i.getScaledFont(9),t.textAlign="left",t.fillText(i.follow?"Following (Esc to stop)":"Click to follow",g+i.scale(16),w+u-i.scale(8)),i.colonistPanelRect={x:g,y:w,w:f,h:u},i.colonistPanelCloseRect={x,y:C,w:k,h:k},t.restore()}function _a(i,e,t,s,n,r){var g;const o=i.ctx;let a=s+i.scale(8);const l=i.scale(64),d=t+i.scale(8),h=a;o.fillStyle="#0f172a",o.fillRect(d,h,l,l),o.strokeStyle="#1e293b",o.strokeRect(d+.5,h+.5,l-1,l-1),o.save(),o.translate(d+l/2,h+l/2),o.scale(i.uiScale*2,i.uiScale*2),ji(o,0,0,e,16,!0),o.restore();const c=e.profile,f=d+l+i.scale(16);let u=h+i.scale(8);if(o.fillStyle="#dbeafe",o.font=i.getScaledFont(18,"700"),o.textAlign="left",c){o.fillText(c.name,f,u),u+=i.scale(22),o.font=i.getScaledFont(13,"400"),o.fillStyle="#94a3b8",o.fillText(c.background,f,u),u+=i.scale(16),o.fillStyle="#60a5fa";const p=c.age||Math.floor(Math.random()*30)+20;o.fillText(`Age: ${p}`,f,u),u+=i.scale(14),(g=c.detailedInfo)!=null&&g.birthplace&&(o.fillStyle="#a78bfa",o.fillText(`From: ${c.detailedInfo.birthplace}`,f,u),u+=i.scale(14)),o.fillStyle="#fbbf24",o.fillText(`Favorite Food: ${c.favoriteFood}`,f,u)}else o.fillText("Unnamed Colonist",f,u),u+=i.scale(22),o.font=i.getScaledFont(13,"400"),o.fillStyle="#94a3b8",o.fillText("No background available",f,u);a=h+l+i.scale(20);const A=c==null?void 0:c.detailedInfo;if(c&&c.personality.length>0){o.fillStyle="#f1f5f9",o.font=i.getScaledFont(14,"600"),o.fillText("Personality Traits",t,a),a+=i.scale(18);for(const p of c.personality)o.fillStyle="#60a5fa",o.font=i.getScaledFont(12,"400"),o.fillText(`• ${p}`,t+i.scale(8),a),a+=i.scale(16);a+=i.scale(8)}if(A&&A.family&&(o.fillStyle="#f1f5f9",o.font=i.getScaledFont(14,"600"),o.fillText("Family",t,a),a+=i.scale(18),o.fillStyle="#10b981",o.font=i.getScaledFont(11,"400"),A.family.parents.length>0&&(o.fillText(`Parents: ${A.family.parents.join(", ")}`,t+i.scale(8),a),a+=i.scale(14)),A.family.siblings.length>0&&(o.fillText(`Siblings: ${A.family.siblings.join(", ")}`,t+i.scale(8),a),a+=i.scale(14)),A.family.spouse&&(o.fillText(`Spouse: ${A.family.spouse}`,t+i.scale(8),a),a+=i.scale(14)),A.family.children.length>0&&(o.fillText(`Children: ${A.family.children.join(", ")}`,t+i.scale(8),a),a+=i.scale(14)),a+=i.scale(8)),A&&A.skills&&A.skills.length>0&&(o.fillStyle="#f1f5f9",o.font=i.getScaledFont(14,"600"),o.fillText("Skills",t,a),a+=i.scale(18),o.fillStyle="#f59e0b",o.font=i.getScaledFont(11,"400"),o.fillText(`• ${A.skills.join(", ")}`,t+i.scale(8),a),a+=i.scale(16)),c&&c.backstory){o.fillStyle="#f1f5f9",o.font=i.getScaledFont(14,"600"),o.fillText("Backstory",t,a),a+=i.scale(18),o.fillStyle="#94a3b8",o.font=i.getScaledFont(11,"400");const p=c.backstory.split(" "),w=n-i.scale(16);let k="";for(let M of p){const x=k+M+" ";if(o.measureText(x).width>w&&k!==""){if(o.fillText(k.trim(),t+i.scale(8),a),a+=i.scale(14),k=M+" ",a>s+r-i.scale(20))break}else k=x}k.trim()&&a<=s+r-i.scale(20)&&o.fillText(k.trim(),t+i.scale(8),a)}}function er(i,e,t,s,n,r){const o=i.ctx;let a=s+i.scale(8);const l=Math.max(.7,Math.min(1,n/400)),d=Math.round(16*l),h=Math.round(12*l),c=Math.round(10*l),f=Math.max(0,Math.min(100,e.hp|0)),u=Math.max(0,Math.min(100,(e.fatigue||0)|0)),A=Math.max(0,Math.min(100,(e.hunger||0)|0)),g=i.getColonistMood?i.getColonistMood(e):"OK";o.fillStyle="#f1f5f9",o.font=i.getScaledFont(d,"600"),o.textAlign="left",o.fillText("Overall Condition",t,a),a+=i.scale(Math.round(24*l));const p=i.scale(Math.round(22*l));if(i.barRow(t,a,"Health",f,"#22c55e"),a+=p,i.barRow(t,a,"Energy",100-u,"#eab308"),a+=p,i.barRow(t,a,"Fullness",100-A,"#f87171"),a+=p,e.health){a+=i.scale(Math.round(16*l)),o.fillStyle="#f1f5f9",o.font=i.getScaledFont(d,"600"),o.fillText("Detailed Health",t,a),a+=i.scale(Math.round(20*l));const w=Math.round((e.health.totalPain||0)*100),k=Math.round((e.health.consciousness||1)*100),M=Math.round((e.health.mobility||1)*100),x=Math.round((e.health.manipulation||1)*100);o.fillStyle="#94a3b8",o.font=i.getScaledFont(h,"500"),o.fillText(`Pain Level: ${w}%`,t,a),o.fillStyle=w>30?"#ef4444":w>15?"#f59e0b":"#22c55e";const C=w>50?" (Severe)":w>30?" (Moderate)":w>15?" (Mild)":" (None)",b=Math.min(t+i.scale(Math.round(80*l)),t+n-i.scale(60));if(o.fillText(C,b,a),a+=i.scale(Math.round(16*l)),i.barRow(t,a,"Consciousness",k,k>80?"#22c55e":k>60?"#f59e0b":"#ef4444"),a+=p,i.barRow(t,a,"Mobility",M,M>80?"#22c55e":M>60?"#f59e0b":"#ef4444"),a+=p,i.barRow(t,a,"Manipulation",x,x>80?"#22c55e":x>60?"#f59e0b":"#ef4444"),a+=p,e.health.bodyParts&&e.health.bodyParts.length>0){a+=i.scale(Math.round(16*l)),o.fillStyle="#f1f5f9",o.font=i.getScaledFont(Math.round(14*l),"600"),o.fillText("Body Parts",t,a),a+=i.scale(Math.round(18*l));for(const S of e.health.bodyParts){const T=Math.round(S.currentHp/S.maxHp*100),D=Math.round(S.efficiency*100);o.fillStyle="#cbd5e1",o.font=i.getScaledFont(Math.round(11*l),"500"),o.fillText(S.label,t,a);const I=Math.min(i.scale(80),n*.3),O=i.scale(8),z=t+Math.min(i.scale(80),n*.25);o.fillStyle="#374151",o.fillRect(z,a-i.scale(6),I,O);const H=T>80?"#22c55e":T>50?"#f59e0b":"#ef4444";if(o.fillStyle=H,o.fillRect(z,a-i.scale(6),I*(T/100),O),o.fillStyle="#9ca3af",o.font=i.getScaledFont(c,"400"),o.fillText(`${T}%`,z+I+i.scale(8),a),D<100&&n>300){o.fillStyle="#f59e0b";const j=Math.min(z+I+i.scale(40),t+n-i.scale(60));o.fillText(`(${D}%)`,j,a)}a+=i.scale(Math.round(14*l))}}if(e.health.injuries&&e.health.injuries.length>0){a+=i.scale(Math.round(12*l)),o.fillStyle="#f1f5f9",o.font=i.getScaledFont(Math.round(14*l),"600"),o.fillText("Active Injuries",t,a),a+=i.scale(Math.round(18*l));const S=n<350?4:6;for(const T of e.health.injuries.slice(0,S)){const D=Math.round(T.severity*100),I=Math.round(T.pain*100),z={cut:"🔪",bruise:"🟣",burn:"🔥",bite:"🦷",gunshot:"🔫",fracture:"🦴"}[T.type]||"⚕️";o.fillStyle="#f87171",o.font=i.getScaledFont(h,"500");const H=n<350?T.description.substring(0,25)+"...":T.description;o.fillText(`${z} ${H}`,t,a),o.fillStyle="#94a3b8",o.font=i.getScaledFont(c,"400");const j=`Severity: ${D}%, Pain: ${I}%`;if(o.fillText(j,t+i.scale(8),a+i.scale(12)),T.bleeding>0&&n>300){o.fillStyle="#dc2626";const Y=Math.min(t+i.scale(150),t+n-i.scale(80));o.fillText(`Bleeding: ${Math.round(T.bleeding*100)}%`,Y,a+i.scale(12))}if(T.infected&&n>250){o.fillStyle="#7c2d12";const Y=Math.min(t+i.scale(220),t+n-i.scale(60));o.fillText("INFECTED",Y,a+i.scale(12))}if(a+=i.scale(Math.round(26*l)),a>s+r-i.scale(40))break}e.health.injuries.length>6&&(o.fillStyle="#6b7280",o.font=i.getScaledFont(10,"400"),o.fillText(`...and ${e.health.injuries.length-6} more injuries`,t,a))}else e.health.bodyParts&&(a+=i.scale(12),o.fillStyle="#22c55e",o.font=i.getScaledFont(12,"500"),o.fillText("✓ No active injuries",t,a))}else a+=i.scale(16),o.fillStyle="#6b7280",o.font=i.getScaledFont(12,"400"),o.fillText("Enhanced health system not initialized",t,a);a+=i.scale(16),o.fillStyle="#f1f5f9",o.font=i.getScaledFont(14,"600"),o.fillText("Mental State",t,a),a+=i.scale(18),o.fillStyle="#9fb3c8",o.font=i.getScaledFont(12,"400"),o.fillText(`Current Mood: ${g}`,t+i.scale(8),a)}function tr(i,e,t,s,n,r){const o=i.ctx;o.save();let a=s+i.scale(4);if(o.fillStyle="#f1f5f9",o.font=i.getScaledFont(16,"600"),o.textAlign="left",o.fillText("Skills",t,a),a+=i.scale(22),!e.skills){o.fillStyle="#94a3b8",o.font=i.getScaledFont(12,"400"),o.fillText("No skills data",t,a),o.restore();return}const l=Object.values(e.skills.byName);l.sort((A,g)=>g.level-A.level);const d=i.scale(14),h=n-i.scale(180);o.font=i.getScaledFont(11,"400");const c=[];for(const A of l){if(a+d>s+r-i.scale(8))break;o.fillStyle="#e2e8f0",o.fillText(A.name,t,a+d*.8),o.fillStyle="#60a5fa",o.fillText(String(A.level).padStart(2," "),t+i.scale(110),a+d*.8);let g="#475569",p="";A.passion==="interested"?(g="#fbbf24",p="★"):A.passion==="burning"&&(g="#f97316",p="★★"),p&&(o.fillStyle=g,o.fillText(p,t+i.scale(140),a+d*.8));const w=t+i.scale(170),k=a+i.scale(2);o.fillStyle="#1e293b",o.fillRect(w,k,h,d-i.scale(4)),o.fillStyle="#0f172a",o.fillRect(w+1,k+1,h-2,d-i.scale(6));const M=100+Math.pow(A.level+1,1.6)*40,x=Math.max(0,Math.min(1,A.xp/M)),C=Math.round((h-4)*x);o.fillStyle="#3b82f6",o.fillRect(w+2,k+2,C,d-i.scale(8)),o.fillStyle="#cbd5e1",o.font=i.getScaledFont(9,"400"),o.textAlign="center",o.fillText(`${Math.round(x*100)}%`,w+h/2,k+(d-i.scale(8))/2+i.scale(2)),o.textAlign="left",c.push({x:w,y:k,w:h,h:d-i.scale(4),skill:A,needed:M}),a+=d+i.scale(6)}const f=i.mouse.x*i.DPR,u=i.mouse.y*i.DPR;for(const A of c)if(f>=A.x&&f<=A.x+A.w&&u>=A.y&&u<=A.y+A.h){const g=A.skill,p=A.needed,w=Math.max(0,Math.round(p-g.xp)),k=i.t||0,M=3;let x=0;if(g.xpDeltas&&g.xpDeltas.length)for(let j=g.xpDeltas.length-1;j>=0;j--){const Y=g.xpDeltas[j];if(Y.t>=k-M)x+=Y.amount;else break}const C=g.passion==="burning"?"x200%":g.passion==="interested"?"x150%":"x100%",b=[`${g.name} (Level ${g.level})`,`XP: ${Math.round(g.xp)}/${Math.round(p)}`,`To next: ${w}`,...x>0?[`Recent gain: +${x.toFixed(1)} XP (last ${M}s)`]:[],`Passion: ${g.passion||"none"} (${C})`,`Work Speed: ${((.6+Math.pow(g.level,.9)*.06)*100).toFixed(0)}%`],S=i.scale(6);o.font=i.getScaledFont(11,"400");let T=0;for(const j of b){const Y=o.measureText(j).width;Y>T&&(T=Y)}const D=T+S*2,I=b.length*i.scale(14)+S*2;let O=A.x+i.scale(10),z=A.y-I-i.scale(4);z<s&&(z=A.y+i.scale(18)),O+D>t+n&&(O=t+n-D),o.fillStyle="rgba(15,23,42,0.92)",o.fillRect(O,z,D,I),o.strokeStyle="#334155",o.strokeRect(O+.5,z+.5,D-1,I-1);let H=z+S;for(const j of b)o.fillStyle="#e2e8f0",o.fillText(j,O+S,H+i.scale(11)),H+=i.scale(14);break}o.restore()}function ir(i,e,t,s,n,r){const o=i.ctx;let a=s+i.scale(8);if(o.fillStyle="#f1f5f9",o.font=i.getScaledFont(16,"600"),o.textAlign="left",o.fillText("Equipment & Inventory",t,a),a+=i.scale(24),!e.inventory){o.fillStyle="#6b7280",o.font=i.getScaledFont(12,"400"),o.fillText("No inventory data available",t,a);return}o.fillStyle="#f1f5f9",o.font=i.getScaledFont(14,"600"),o.fillText("Equipment",t,a),a+=i.scale(18);const l=["helmet","armor","weapon","tool","shield","accessory"];for(const d of l){const h=e.inventory.equipment[d];o.fillStyle="#94a3b8",o.font=i.getScaledFont(12,"500");const c=d.charAt(0).toUpperCase()+d.slice(1);o.fillText(`${c}:`,t,a),h?(o.fillStyle=ui(i,h.quality||"normal"),o.font=i.getScaledFont(12,"400"),o.fillText(h.name,t+i.scale(80),a),o.fillStyle="#6b7280",o.font=i.getScaledFont(10,"400"),o.fillText(`(${h.quality||"normal"})`,t+i.scale(180),a)):(o.fillStyle="#6b7280",o.font=i.getScaledFont(12,"400"),o.fillText("None",t+i.scale(80),a)),a+=i.scale(16)}if(a+=i.scale(12),o.fillStyle="#f1f5f9",o.font=i.getScaledFont(14,"600"),o.fillText("Inventory Items",t,a),a+=i.scale(18),e.inventory.items.length===0)o.fillStyle="#6b7280",o.font=i.getScaledFont(12,"400"),o.fillText("No items in inventory",t+i.scale(8),a);else for(const d of e.inventory.items){o.fillStyle=ui(i,d.quality||"normal"),o.font=i.getScaledFont(12,"400");const h=`${d.name} (${d.quantity})`;if(o.fillText(h,t+i.scale(8),a),o.fillStyle="#6b7280",o.font=i.getScaledFont(10,"400"),o.fillText(`${d.quality||"normal"}`,t+i.scale(150),a),d.durability!==void 0&&o.fillText(`${Math.round(d.durability)}%`,t+i.scale(200),a),a+=i.scale(16),a>s+r-i.scale(20)){o.fillStyle="#6b7280",o.font=i.getScaledFont(10,"400"),o.fillText("...more items",t+i.scale(8),a);break}}e.carrying&&(a+=i.scale(12),o.fillStyle="#f1f5f9",o.font=i.getScaledFont(14,"600"),o.fillText("Currently Carrying",t,a),a+=i.scale(18),o.fillStyle="#22c55e",o.font=i.getScaledFont(12,"400"),o.fillText(`${e.carrying.type||"Item"}`,t+i.scale(8),a))}function sr(i,e,t,s,n,r){var d;const o=i.ctx;let a=s+i.scale(8);o.fillStyle="#f1f5f9",o.font=i.getScaledFont(16,"600"),o.textAlign="left",o.fillText("Social Relationships",t,a),a+=i.scale(24),o.fillStyle="#94a3b8",o.font=i.getScaledFont(12,"400"),o.fillText("Social skill: Novice",t,a),a+=i.scale(16),a+=i.scale(16),o.fillStyle="#f1f5f9",o.font=i.getScaledFont(14,"600"),o.fillText("Colony Relationships",t,a),a+=i.scale(18);const l=i.colonists.filter(h=>h!==e&&h.alive);if(l.length>0)for(let h=0;h<Math.min(l.length,3);h++){const c=l[h],f=["Neutral","Friend","Good friend","Rival"][Math.floor(Math.random()*4)],u=f==="Friend"||f==="Good friend"?"#22c55e":f==="Rival"?"#ef4444":"#94a3b8";o.fillStyle="#dbeafe",o.font=i.getScaledFont(11,"500"),o.fillText(((d=c.profile)==null?void 0:d.name)||"Colonist",t+i.scale(8),a),o.fillStyle=u,o.font=i.getScaledFont(11,"400"),o.fillText(f,t+i.scale(120),a),a+=i.scale(16)}else o.fillStyle="#6b7280",o.font=i.getScaledFont(11,"400"),o.fillText("No other colonists in colony",t+i.scale(8),a)}function nr(i,e,t,s,n,r){const o=i.ctx;let a=s+i.scale(8);o.fillStyle="#f1f5f9",o.font=i.getScaledFont(16,"600"),o.textAlign="left",o.fillText("Activity Log",t,a),a+=i.scale(24);const l=[{time:`Day ${i.day} 08:30`,action:"Started construction work",type:"work"},{time:`Day ${i.day} 07:45`,action:"Finished eating breakfast",type:"need"},{time:`Day ${i.day} 07:00`,action:"Woke up",type:"rest"},{time:`Day ${i.day-1} 22:30`,action:"Went to sleep",type:"rest"},{time:`Day ${i.day-1} 19:15`,action:"Had dinner",type:"need"}];for(const d of l){const h=d.type==="work"?"#60a5fa":d.type==="need"?"#22c55e":d.type==="rest"?"#a78bfa":"#94a3b8";if(o.fillStyle="#6b7280",o.font=i.getScaledFont(10,"400"),o.fillText(d.time,t,a),o.fillStyle=h,o.font=i.getScaledFont(11,"400"),o.fillText(d.action,t+i.scale(100),a),a+=i.scale(16),a>s+r-i.scale(20))break}}function ui(i,e){switch(e.toLowerCase()){case"legendary":return"#a855f7";case"masterwork":return"#f59e0b";case"excellent":return"#10b981";case"good":return"#3b82f6";case"normal":return"#6b7280";case"poor":return"#ef4444";case"awful":return"#991b1b";default:return"#6b7280"}}function or(i){const e=i.pendingPlacement;if(!e)return;const t=J[e.key],s=i.ctx,n=t.size.w*m,r=t.size.h*m,a=((b,S)=>({x:(b-i.camera.x)*i.camera.zoom,y:(S-i.camera.y)*i.camera.zoom}))(e.x,e.y);let l=n*i.camera.zoom,d=r*i.camera.zoom;const h=e.rot||0;if(h===90||h===270){const b=l;l=d,d=b}s.save();const f=Ye(e.key,e.x+1,e.y+1),u=Ke(i,f,f.x,f.y)&&Fe(i.RES,t.cost);s.fillStyle=u?"rgba(75, 159, 255, 0.6)":"rgba(255, 107, 107, 0.6)",s.fillRect(a.x,a.y,l,d),s.strokeStyle="#4b9fff",s.setLineDash([4,3]),s.strokeRect(a.x+.5,a.y+.5,l-1,d-1),s.setLineDash([]),s.restore();const A=i.scale(10),g=i.scale(42);let p=a.x+l+A,w=a.y;const k=i.canvas.width;p+g*3>k-i.scale(6)&&(p=Math.max(i.scale(6),a.x-A-g*3));const M=(b,S,T)=>({id:b,x:S,y:T,w:g,h:g}),x=[M("up",p+g,w),M("left",p,w+g),M("right",p+g*2,w+g),M("down",p+g,w+g*2),M("rotL",p,w+g*3+i.scale(6)),M("rotR",p+g*2,w+g*3+i.scale(6)),M("cancel",p,w+g*4+i.scale(6)),M("ok",p+g*2,w+g*4+i.scale(6))];i.placeUIRects=x,s.save(),s.fillStyle="#0f172aee",s.strokeStyle="#1e293b";const C=(b,S,T=!1)=>{s.save(),T&&(s.fillStyle="rgba(15, 23, 42, 0.5)"),s.fillRect(b.x,b.y,b.w,b.h),s.strokeRect(b.x+.5,b.y+.5,b.w-1,b.h-1),s.fillStyle=T?"rgba(219, 234, 254, 0.5)":"#dbeafe",s.font=i.getScaledFont(18,"600"),s.textAlign="center",s.textBaseline="middle",s.fillText(S,b.x+b.w/2,b.y+b.h/2+i.scale(2)),s.restore(),s.fillStyle="#0f172aee"};for(const b of x)b.id==="up"?C(b,"↑"):b.id==="down"?C(b,"↓"):b.id==="left"?C(b,"←"):b.id==="right"?C(b,"→"):b.id==="rotL"?C(b,"⟲"):b.id==="rotR"?C(b,"⟳"):b.id==="ok"?C(b,"OK",!u):b.id==="cancel"&&C(b,"X");s.fillStyle="#dbeafe",s.font=i.getScaledFont(14,"500"),s.textAlign="left",s.textBaseline="top",s.fillText("Drag to move • Tap OK to place",Math.max(i.scale(6),a.x),Math.max(i.scale(6),a.y-i.scale(26))),s.restore()}const Ie=class Ie{constructor(){v(this,"currentFrame",{pathfindingMs:0,lightingMs:0,aiMs:0,renderMs:0,otherMs:0,totalFrameMs:0});v(this,"HISTORY_SIZE",60);v(this,"history",[]);v(this,"longTasks",[]);v(this,"MAX_LONG_TASKS",100);v(this,"BUDGET_MS",2);v(this,"frameCount",0);v(this,"droppedFrames",0);v(this,"timingStack",[]);v(this,"lastLogTime",performance.now())}static getInstance(){return Ie.instance||(Ie.instance=new Ie),Ie.instance}startTiming(e){this.timingStack.push({subsystem:e,start:performance.now()})}endTiming(e){if(this.timingStack.length===0){console.warn("PerformanceMetrics: endTiming called without matching startTiming");return}const{subsystem:t,start:s}=this.timingStack.pop(),n=performance.now()-s;switch(t){case"pathfinding":this.currentFrame.pathfindingMs+=n;break;case"lighting":this.currentFrame.lightingMs+=n;break;case"ai":this.currentFrame.aiMs+=n;break;case"render":this.currentFrame.renderMs+=n;break;case"other":this.currentFrame.otherMs+=n;break}n>this.BUDGET_MS&&this.recordLongTask(t,n,e)}recordLongTask(e,t,s){this.longTasks.push({subsystem:e,duration:t,timestamp:performance.now(),details:s}),this.longTasks.length>this.MAX_LONG_TASKS&&this.longTasks.shift()}endFrame(e){this.currentFrame.totalFrameMs=e,e>16.67&&this.droppedFrames++,this.history.push({...this.currentFrame}),this.history.length>this.HISTORY_SIZE&&this.history.shift(),this.frameCount++,this.currentFrame={pathfindingMs:0,lightingMs:0,aiMs:0,renderMs:0,otherMs:0,totalFrameMs:0}}getAverageMetrics(){if(this.history.length===0)return{...this.currentFrame};const e={pathfindingMs:0,lightingMs:0,aiMs:0,renderMs:0,otherMs:0,totalFrameMs:0};for(const s of this.history)e.pathfindingMs+=s.pathfindingMs,e.lightingMs+=s.lightingMs,e.aiMs+=s.aiMs,e.renderMs+=s.renderMs,e.otherMs+=s.otherMs,e.totalFrameMs+=s.totalFrameMs;const t=this.history.length;return{pathfindingMs:e.pathfindingMs/t,lightingMs:e.lightingMs/t,aiMs:e.aiMs/t,renderMs:e.renderMs/t,otherMs:e.otherMs/t,totalFrameMs:e.totalFrameMs/t}}getTopOffenders(e=5){return[...this.longTasks].sort((s,n)=>n.duration-s.duration).slice(0,e)}getBudgetUtilization(){const e=this.getAverageMetrics();return{pathfinding:e.pathfindingMs/this.BUDGET_MS*100,lighting:e.lightingMs/this.BUDGET_MS*100,ai:e.aiMs/this.BUDGET_MS*100,render:e.renderMs/this.BUDGET_MS*100,other:e.otherMs/this.BUDGET_MS*100}}getSummary(){const e=this.getAverageMetrics(),t=this.history.length>0?1e3/e.totalFrameMs:0,s=this.frameCount>0?this.droppedFrames/this.frameCount*100:0,n=["=== Performance Summary ===",`FPS: ${t.toFixed(1)} | Frame: ${e.totalFrameMs.toFixed(2)}ms | Dropped: ${s.toFixed(1)}%`,"Subsystems (avg):",`  Pathfinding: ${e.pathfindingMs.toFixed(2)}ms (${(e.pathfindingMs/this.BUDGET_MS*100).toFixed(0)}% budget)`,`  Lighting:    ${e.lightingMs.toFixed(2)}ms (${(e.lightingMs/this.BUDGET_MS*100).toFixed(0)}% budget)`,`  AI:          ${e.aiMs.toFixed(2)}ms (${(e.aiMs/this.BUDGET_MS*100).toFixed(0)}% budget)`,`  Render:      ${e.renderMs.toFixed(2)}ms (${(e.renderMs/this.BUDGET_MS*100).toFixed(0)}% budget)`,`  Other:       ${e.otherMs.toFixed(2)}ms (${(e.otherMs/this.BUDGET_MS*100).toFixed(0)}% budget)`],r=this.getTopOffenders(3);if(r.length>0){n.push("Top Offenders (last 100 tasks):");for(const o of r){const a=o.details?` (${o.details})`:"";n.push(`  ${o.subsystem}: ${o.duration.toFixed(2)}ms${a}`)}}return n.push("========================"),n.join(`
`)}reset(){this.currentFrame={pathfindingMs:0,lightingMs:0,aiMs:0,renderMs:0,otherMs:0,totalFrameMs:0},this.history=[],this.longTasks=[],this.frameCount=0,this.droppedFrames=0,this.lastLogTime=performance.now()}};v(Ie,"instance");let lt=Ie;const Be=class Be{constructor(e){v(this,"config");v(this,"lastFrameTime",performance.now());v(this,"accumulator",0);v(this,"fixedDeltaTime");v(this,"fixedDeltaTimeMs");v(this,"alpha",0);v(this,"simulationSteps",0);v(this,"renderFrames",0);v(this,"lastSimulationTime",0);this.config={simulationHz:(e==null?void 0:e.simulationHz)??30,maxFrameTime:(e==null?void 0:e.maxFrameTime)??.25},this.fixedDeltaTime=1/this.config.simulationHz,this.fixedDeltaTimeMs=this.fixedDeltaTime*1e3}static getInstance(e){return Be.instance||(Be.instance=new Be(e)),Be.instance}tick(e){const t=Math.min((e-this.lastFrameTime)/1e3,this.config.maxFrameTime);this.lastFrameTime=e,this.accumulator+=t;let s=0;for(;this.accumulator>=this.fixedDeltaTime;)this.accumulator-=this.fixedDeltaTime,s++;return this.alpha=this.accumulator/this.fixedDeltaTime,s}runSimulationStep(e){const t=performance.now();e(this.fixedDeltaTime),this.lastSimulationTime=performance.now()-t,this.simulationSteps++}getAlpha(){return this.alpha}getFixedDeltaTime(){return this.fixedDeltaTime}getFixedDeltaTimeMs(){return this.fixedDeltaTimeMs}getSimulationHz(){return this.config.simulationHz}setSimulationHz(e){this.config.simulationHz=e,this.fixedDeltaTime=1/e,this.fixedDeltaTimeMs=this.fixedDeltaTime*1e3}recordRenderFrame(){this.renderFrames++}getStats(){return{simulationHz:this.config.simulationHz,actualSimRate:this.config.simulationHz,actualRenderRate:60,alpha:this.alpha,lastSimMs:this.lastSimulationTime}}reset(){this.lastFrameTime=performance.now(),this.accumulator=0,this.alpha=0}};v(Be,"instance");let ct=Be;class ar{constructor(e){v(this,"queue",[]);v(this,"config");v(this,"carryover",0);v(this,"tasksExecuted",0);v(this,"tasksCompleted",0);v(this,"totalExecutionTime",0);v(this,"budgetExceeded",0);this.config={budgetMs:e.budgetMs,allowCarryover:e.allowCarryover??!0,maxCarryoverMs:e.maxCarryoverMs??e.budgetMs*.5}}enqueue(e){this.queue.push(e),this.queue.sort((t,s)=>(s.priority??0)-(t.priority??0))}remove(e){const t=this.queue.findIndex(s=>s.id===e);return t!==-1?(this.queue.splice(t,1),!0):!1}execute(){const e=performance.now(),t=this.config.budgetMs+(this.config.allowCarryover?this.carryover:0);let s=0;for(this.carryover=0;this.queue.length>0;){if(performance.now()-e>=t){this.budgetExceeded++;break}const r=this.queue[0],o=performance.now();let a=!1;try{a=r.execute()}catch(d){console.error(`BudgetedExecution: Task ${r.id} failed:`,d),a=!0}const l=performance.now()-o;if(this.totalExecutionTime+=l,this.tasksExecuted++,s++,a)this.queue.shift(),this.tasksCompleted++;else if(performance.now()-e>=t){this.budgetExceeded++;break}}if(this.config.allowCarryover){const n=performance.now()-e;n<this.config.budgetMs&&(this.carryover=Math.min(this.config.budgetMs-n,this.config.maxCarryoverMs))}return s}size(){return this.queue.length}clear(){this.queue=[]}getStats(){return{queueSize:this.queue.length,tasksExecuted:this.tasksExecuted,tasksCompleted:this.tasksCompleted,avgExecutionTime:this.tasksExecuted>0?this.totalExecutionTime/this.tasksExecuted:0,budgetExceeded:this.budgetExceeded,carryover:this.carryover}}resetStats(){this.tasksExecuted=0,this.tasksCompleted=0,this.totalExecutionTime=0,this.budgetExceeded=0}}const De=class De{constructor(){v(this,"queues",new Map)}static getInstance(){return De.instance||(De.instance=new De),De.instance}getQueue(e,t){if(!this.queues.has(e)){const s={budgetMs:2,allowCarryover:!0,maxCarryoverMs:1};this.queues.set(e,new ar(t??s))}return this.queues.get(e)}executeAll(){for(const[e,t]of this.queues)t.execute()}getAllStats(){const e=new Map;for(const[t,s]of this.queues)e.set(t,s.getStats());return e}resetAllStats(){for(const e of this.queues.values())e.resetStats()}};v(De,"instance");let dt=De;class rr{constructor(e){v(this,"config",{visible:!1,position:"top-right",opacity:.85,showDetails:!0,showQueues:!0,updateHz:3});v(this,"metrics",lt.getInstance());v(this,"simClock",ct.getInstance());v(this,"budgetManager",dt.getInstance());v(this,"offscreenCanvas",null);v(this,"offscreenCtx",null);v(this,"cachedWidth",0);v(this,"cachedHeight",0);v(this,"lastUpdateTime",0);v(this,"updateInterval",1e3/3);v(this,"isDirty",!0);e&&(this.config={...this.config,...e}),this.updateInterval=1e3/this.config.updateHz}toggle(){this.config.visible=!this.config.visible,this.config.visible&&(this.isDirty=!0)}setVisible(e){this.config.visible=e,e&&(this.isDirty=!0)}configure(e){this.config={...this.config,...e},e.updateHz&&(this.updateInterval=1e3/e.updateHz),this.isDirty=!0}draw(e){if(!this.config.visible)return;const t=performance.now();(t-this.lastUpdateTime>=this.updateInterval||this.isDirty)&&(this.updateOffscreenCanvas(e),this.lastUpdateTime=t,this.isDirty=!1),this.offscreenCanvas&&this.offscreenCtx&&this.blitToScreen(e)}updateOffscreenCanvas(e){const t=d=>d*e.DPR*e.uiScale;t(10);const s=t(320),n=t(16),r=this.buildHUDContent(e),o=r.length*n+t(20);(!this.offscreenCanvas||this.cachedWidth!==s||this.cachedHeight!==o)&&(this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=s,this.offscreenCanvas.height=o,this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.cachedWidth=s,this.cachedHeight=o);const a=this.offscreenCtx;a.clearRect(0,0,s,o),a.save(),a.fillStyle=`rgba(0, 0, 0, ${this.config.opacity})`,a.fillRect(0,0,s,o),a.strokeStyle="rgba(100, 200, 255, 0.5)",a.lineWidth=t(2),a.strokeRect(0,0,s,o),a.fillStyle="rgba(100, 200, 255, 0.3)",a.fillRect(0,0,s,n+t(4)),a.fillStyle="#ffffff",a.font=`${t(12)}px monospace`,a.textBaseline="top";let l=t(4);for(let d=0;d<r.length;d++){const h=r[d];h.startsWith("⚠")||h.includes("WARN")?a.fillStyle="#fbbf24":h.startsWith("✓")||h.includes("OK")?a.fillStyle="#4ade80":h.includes("OVER")?a.fillStyle="#f87171":d===0?a.fillStyle="#60a5fa":a.fillStyle="#e5e7eb",a.fillText(h,t(6),l),l+=n}a.restore()}blitToScreen(e){if(!this.offscreenCanvas)return;const t=e.ctx,n=(a=>a*e.DPR*e.uiScale)(10);let r=n,o=n;this.config.position==="top-right"?r=e.canvas.width-this.cachedWidth-n:this.config.position==="bottom-left"?o=e.canvas.height-this.cachedHeight-n:this.config.position==="bottom-right"&&(r=e.canvas.width-this.cachedWidth-n,o=e.canvas.height-this.cachedHeight-n),t.drawImage(this.offscreenCanvas,r,o)}buildHUDContent(e){const t=[],s=this.metrics.getAverageMetrics(),n=s.totalFrameMs>0?1e3/s.totalFrameMs:0,r=this.simClock.getStats();this.metrics.getBudgetUtilization(),t.push("📊 PERFORMANCE MONITOR");const o=n>=55?"✓":n>=30?"⚠":"✗";if(t.push(`${o} FPS: ${n.toFixed(1)} | Frame: ${s.totalFrameMs.toFixed(1)}ms`),t.push(`⏱ Sim: ${r.simulationHz}Hz | α: ${r.alpha.toFixed(2)}`),e&&e.adaptiveTickRate){const l=e.adaptiveTickRate.getStats();if(t.push(`🤖 AI: ${l.updatePercentage} updated (${l.updatedThisFrame}/${l.totalEntities})`),this.config.showDetails&&l.byImportance){const d=["CRIT","NORM","LOW","MIN"],h=Object.values(l.byImportance),c=h.map((f,u)=>`${d[u]}:${f}`).filter((f,u)=>h[u]>0).join(" ");c&&t.push(`  └─ ${c}`)}}if(e&&e.pathRequestQueue){const l=e.pathRequestQueue.getStats(),d=l.totalRequests>0?(l.cacheHits/l.totalRequests*100).toFixed(1):"0.0",h=l.queuedRequests>0?` ⚠️${l.queuedRequests}`:"";if(t.push(`📦 Cache: ${d}% hits (${l.cacheSize} entries${h})`),this.config.showDetails){const c=l.processedRequests,f=l.cancelledRequests;t.push(`  └─ ${l.cacheHits} hits / ${l.cacheMisses} miss / ${c} proc / ${f} cancel`)}}if(e&&e.renderManager){const l=e.renderManager.getPerformanceStats(),d=l.worldCacheEnabled&&l.colonistCacheEnabled&&l.particleSpritesEnabled?"✓":"⚠";t.push(`${d} Render: W:${l.worldCacheEnabled?"ON":"OFF"} C:${l.colonistCacheEnabled?"ON":"OFF"} P:${l.particleSpritesEnabled?"ON":"OFF"}`),this.config.showDetails&&l.colonistCacheSize>0&&t.push(`  └─ ${l.colonistCacheSize} colonist sprites cached`)}if(this.config.showDetails){t.push(""),t.push("SUBSYSTEMS:");const l=(h,c,f)=>{const u=c/f*100,A=this.createBar(Math.min(u,100),15);return`  ${h.padEnd(12)} ${c.toFixed(2)}ms ${A} ${u.toFixed(0)}%`},d=this.metrics.BUDGET_MS;t.push(l("Pathfinding",s.pathfindingMs,d)),t.push(l("Lighting",s.lightingMs,d)),t.push(l("AI",s.aiMs,d)),t.push(l("Render",s.renderMs,d)),t.push(l("Other",s.otherMs,d))}if(this.config.showQueues){const l=this.budgetManager.getAllStats();if(l.size>0){t.push(""),t.push("QUEUES:");for(const[d,h]of l)h.queueSize>0&&t.push(`  ${d}: ${h.queueSize} tasks`)}}const a=this.metrics.getTopOffenders(3);if(a.length>0){t.push(""),t.push("TOP OFFENDERS:");for(const l of a){const d=l.details?` (${l.details})`:"";t.push(`  ${l.subsystem}: ${l.duration.toFixed(1)}ms${d}`)}}return t}createBar(e,t){const s=Math.round(e/100*t),n=t-s;return"["+"█".repeat(s)+"░".repeat(n)+"]"}getConfig(){return{...this.config}}}let Se=null;function lr(i){return Se?i&&Se.configure(i):Se=new rr(i),Se}function cr(){Se&&Se.toggle()}function dr(i){Se&&Se.draw(i)}class hr{constructor(e){v(this,"useWorldCache",!0);v(this,"useColonistCache",!0);v(this,"useNightCache",!0);v(this,"useParticleSprites",!0);this.game=e}toggleWorldCache(e){this.useWorldCache=e,e||ri.markDirty()}toggleColonistCache(e){this.useColonistCache=e,e||Je.clear()}toggleParticleCache(e){this.useParticleSprites=e,ra(e)}getPerformanceStats(){return{worldCacheEnabled:this.useWorldCache,colonistCacheEnabled:this.useColonistCache,colonistCacheSize:Je.size(),particleSpritesEnabled:this.useParticleSprites}}render(){const{game:e}=this,{ctx:t,canvas:s}=e;Ga(t,s,e.dirtyRectTracker),e.clampCameraToWorld(),t.save(),Ha(t,e.camera),this.renderWorld(),this.renderEntities(),this.renderDebug(),t.restore(),this.renderUI(),e.dirtyRectTracker.reset()}renderWorld(){const{game:e}=this,{ctx:t}=e;if(this.useWorldCache){const s=ri.getCanvas(t,e.terrainGrid);t.drawImage(s,0,0)}else Ya(t,e.camera),qa(t,e.terrainGrid,e.camera)}renderEntities(){const{game:e}=this,{ctx:t}=e,s=e.camera,n=100,r=s.x-n,o=s.y-n,a=s.x+e.canvas.width/s.zoom+n,l=s.y+e.canvas.height/s.zoom+n,d=(c,f,u=0)=>c+u>=r&&c-u<=a&&f+u>=o&&f-u<=l;for(const c of e.trees)d(c.x,c.y,c.r)&&hi(t,c.x,c.y,c.r,Z.tree);for(const c of e.rocks)d(c.x,c.y,c.r)&&hi(t,c.x,c.y,c.r,Z.rock);for(const c of e.buildings)d(c.x+c.w/2,c.y+c.h/2,Math.max(c.w,c.h)/2)&&Qa(t,c);for(const c of e.buildings){if(!c.done||!d(c.x+c.w/2,c.y+c.h/2,Math.max(c.w,c.h)/2))continue;const f=e.insideCounts.get(c)||0;if(f>0&&(c.kind==="hq"||c.kind==="house")){const g=c.x+c.w-6,p=c.y+6;if(f<=4)for(let w=0;w<f;w++){const k=g-w%2*12,M=p+Math.floor(w/2)*12;fi(t,k,M,10,"#93c5fd")}else{fi(t,g,p,10,"#93c5fd"),t.save(),t.fillStyle="#1e293b",t.strokeStyle="#93c5fd",t.lineWidth=1.5;const w=g-12,k=p,M=8;t.beginPath(),t.arc(w,k,M,0,Math.PI*2),t.fill(),t.stroke(),t.fillStyle="#ffffff",t.font="bold 10px system-ui",t.textAlign="center",t.textBaseline="middle",t.fillText(String(f),w,k),t.restore()}}}for(const c of e.colonists){if(!c.alive||c.inside&&c.inside.kind!=="bed"||!d(c.x,c.y,30))continue;const u=e.selColonist===c;if(ji(t,c.x,c.y,c,c.r,u),c.isDrafted){t.save(),t.strokeStyle="#10b981",t.fillStyle="rgba(16, 185, 129, 0.3)",t.lineWidth=2;const A=c.x,g=c.y-c.r-12,p=8;t.beginPath(),t.moveTo(A,g-p),t.lineTo(A+p,g),t.lineTo(A+p*.6,g+p),t.lineTo(A-p*.6,g+p),t.lineTo(A-p,g),t.closePath(),t.fill(),t.stroke(),t.restore()}if(c.isDrafted&&c.draftedPosition){t.save(),t.strokeStyle="#10b981",t.fillStyle="rgba(16, 185, 129, 0.2)",t.lineWidth=2;const A=12;t.beginPath(),t.moveTo(c.draftedPosition.x-A,c.draftedPosition.y-A),t.lineTo(c.draftedPosition.x+A,c.draftedPosition.y+A),t.moveTo(c.draftedPosition.x+A,c.draftedPosition.y-A),t.lineTo(c.draftedPosition.x-A,c.draftedPosition.y+A),t.stroke(),t.beginPath(),t.arc(c.draftedPosition.x,c.draftedPosition.y,A,0,Math.PI*2),t.stroke(),t.restore()}if(c.isDrafted&&c.draftedTarget){const A=c.draftedTarget;if(A.hp>0&&A.alive!==!1){t.save(),t.strokeStyle="#ef4444",t.lineWidth=2,t.setLineDash([5,5]),t.beginPath(),t.moveTo(c.x,c.y),t.lineTo(A.x,A.y),t.stroke(),t.setLineDash([]);const g=14;t.beginPath(),t.arc(A.x,A.y,g,0,Math.PI*2),t.stroke(),t.beginPath(),t.moveTo(A.x-g,A.y),t.lineTo(A.x+g,A.y),t.moveTo(A.x,A.y-g),t.lineTo(A.x,A.y+g),t.stroke(),t.restore()}}}if(e.debug.combat)for(const c of e.buildings){if(!c.alive||!c.done||!d(c.x+c.w/2,c.y+c.h/2,Math.max(c.w,c.h)/2))continue;const f=J[c.kind];if(!f.isTurret)continue;const u=f.range||0;if(u>0){const A=c.x+c.w/2,g=c.y+c.h/2;t.strokeStyle="rgba(255,0,0,0.3)",t.lineWidth=2,t.beginPath(),t.arc(A,g,u,0,Math.PI*2),t.stroke()}}e.drawLongPressProgress();for(const c of e.enemies)d(c.x,c.y,c.r+5)&&Ua(t,c.x,c.y,c.r+2,3,Z.enemy,-Math.PI/2);ja(t,e.bullets.filter(c=>d(c.x,c.y,20)));const h=e.particles.filter(c=>d(c.x,c.y,c.size||10));if(qi(t,h),e.isNight())if(this.useNightCache){const c=oa.getCanvas();t.drawImage(c,0,0)}else t.fillStyle="rgba(6,10,18, 0.58)",t.fillRect(0,0,G.w,G.h);if(e.selectedBuild&&!e.pendingPlacement){const c=J[e.selectedBuild],f=Math.floor(e.mouse.wx/m)*m,u=Math.floor(e.mouse.wy/m)*m,A=Ke(e,{...c,size:c.size},f,u)&&Fe(e.RES,c.cost);t.fillStyle=A?Z.ghost.includes("rgba")?Z.ghost:"rgba(100, 200, 100, 0.6)":"rgba(255, 107, 107, 0.53)",t.fillRect(f,u,c.size.w*m,c.size.h*m)}if(e.mouse.rdown&&e.eraseDragStart){const c=Math.min(e.eraseDragStart.x,e.mouse.wx),f=Math.min(e.eraseDragStart.y,e.mouse.wy),u=Math.abs(e.mouse.wx-e.eraseDragStart.x),A=Math.abs(e.mouse.wy-e.eraseDragStart.y);t.save(),t.fillStyle="rgba(239, 68, 68, 0.18)",t.fillRect(c,f,u,A),t.strokeStyle="#ef4444",t.setLineDash([6,4]),t.strokeRect(c+.5,f+.5,u-1,A-1),t.setLineDash([]),t.restore()}}renderDebug(){const{game:e}=this,{ctx:t}=e;e.debug.regions&&Za(e),e.debug.terrain&&Ka(e),e.debug.nav&&this.renderNavDebug(),e.debug.colonists&&(this.renderColonistDebug(),this.renderEnemyDebug()),Ea(e)}renderNavDebug(){const{game:e}=this,{ctx:t,grid:s,camera:n}=e;t.save(),t.globalAlpha=.4;const r=Math.max(0,Math.floor((n.x-100)/m)),o=Math.min(s.cols,Math.ceil((n.x+t.canvas.width/n.zoom+100)/m)),a=Math.max(0,Math.floor((n.y-100)/m)),l=Math.min(s.rows,Math.ceil((n.y+t.canvas.height/n.zoom+100)/m));for(let g=a;g<l;g++)for(let p=r;p<o;p++){const w=g*s.cols+p;if(!s.solid[w])continue;const k=p*m,M=g*m;t.fillStyle="#ff000088",t.fillRect(k,M,m,m)}t.font="8px monospace";for(let g=a;g<l;g++)for(let p=r;p<o;p++){const w=g*s.cols+p;if(s.solid[w])continue;const k=s.cost[w];if(k===1)continue;const M=p*m,x=g*m,C=Math.min(1,(k-1)*.3);t.fillStyle=`rgba(255, 200, 0, ${C})`,t.fillRect(M,x,m,m),t.fillStyle="#000000",t.fillText(k.toFixed(1),M+2,x+10)}t.restore();const d=100,h=n.x-d,c=n.y-d,f=n.x+t.canvas.width/n.zoom+d,u=n.y+t.canvas.height/n.zoom+d,A=(g,p)=>g>=h&&g<=f&&p>=c&&p<=u;for(const g of e.colonists)if(!(!g.alive||!g.path||g.path.length===0)&&A(g.x,g.y)){t.strokeStyle="#00ffff",t.lineWidth=2,t.setLineDash([4,4]),t.beginPath(),t.moveTo(g.x,g.y);for(const p of g.path)t.lineTo(p.x,p.y);if(t.stroke(),t.setLineDash([]),g.pathIndex!==void 0&&g.path[g.pathIndex]){const p=g.path[g.pathIndex];t.fillStyle="#00ffff",t.beginPath(),t.arc(p.x,p.y,4,0,Math.PI*2),t.fill()}if(g.target&&g.target.x!=null){const p=g.target;t.strokeStyle="#ffff00",t.lineWidth=1,t.setLineDash([2,2]),t.beginPath(),t.moveTo(g.x,g.y),t.lineTo(p.x,p.y),t.stroke(),t.setLineDash([])}}for(const g of e.enemies){if(!A(g.x,g.y))continue;const p=g,w=p.path;if(!(!w||w.length===0)){t.strokeStyle="#ff4444",t.lineWidth=2,t.setLineDash([4,4]),t.beginPath(),t.moveTo(g.x,g.y);for(const k of w)t.lineTo(k.x,k.y);t.stroke(),t.setLineDash([]);for(let k=0;k<w.length;k++){const M=w[k];t.fillStyle=k===p.pathIndex?"#ff0000":"#ff8888",t.fillRect(M.x-2,M.y-2,4,4)}}}}renderColonistDebug(){var h;const{game:e}=this,{ctx:t}=e,s=e.camera,n=100,r=s.x-n,o=s.y-n,a=s.x+e.canvas.width/s.zoom+n,l=s.y+e.canvas.height/s.zoom+n,d=(c,f)=>c>=r&&c<=a&&f>=o&&f<=l;t.save(),t.font="10px monospace",t.lineWidth=1;for(const c of e.colonists){if(!c.alive||c.inside&&c.inside.kind!=="bed"||!d(c.x,c.y))continue;const u=c.x-35;let A=c.y-c.r-45;const g=12,p=[`State: ${c.state||"unknown"}`,`Task: ${c.task||"none"}`,`HP: ${Math.floor(c.hp||0)}`,`Pos: ${Math.floor(c.x)},${Math.floor(c.y)}`,`Speed: ${this.calculateColonistSpeed(c).toFixed(1)}`,`Stuck: ${c.stuckTimer?c.stuckTimer.toFixed(1)+"s":"no"}`,`Since: ${c.stateSince?c.stateSince.toFixed(1)+"s":"0s"}`,`PathIdx: ${c.pathIndex??"none"}/${((h=c.path)==null?void 0:h.length)??0}`,`Jitter: ${c.jitterScore??0}`,`Repath: ${c.repath?c.repath.toFixed(1)+"s":"none"}`];if(c.target){const M=c.target;M.x!=null&&(p.push(`Target: ${Math.floor(M.x)},${Math.floor(M.y)}`),M.type&&p.push(`Type: ${M.type}`),M.hp!=null&&p.push(`T.HP: ${Math.floor(M.hp)}`))}const w=140,k=p.length*g+4;t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(u-2,A-g+2,w,k),t.strokeStyle="#444",t.strokeRect(u-2,A-g+2,w,k);for(let M=0;M<p.length;M++){const x=p[M];t.fillStyle="#ffffff",t.strokeStyle="#000000",t.lineWidth=2,t.strokeText(x,u,A+M*g),t.fillText(x,u,A+M*g)}if(t.strokeStyle="rgba(255, 107, 107, 0.3)",t.lineWidth=1,t.beginPath(),t.arc(c.x,c.y,c.r,0,Math.PI*2),t.stroke(),c.target&&c.task&&(c.task==="chop"||c.task==="mine")){const M=c.target;if(M.x!=null&&M.r!=null){const x=M.r+c.r+4+2.5;t.strokeStyle="rgba(34, 197, 94, 0.4)",t.lineWidth=2,t.beginPath(),t.arc(M.x,M.y,x,0,Math.PI*2),t.stroke();const C=Math.hypot(c.x-M.x,c.y-M.y);t.fillStyle=C<=x?"#22c55e":"#ff6b6b",t.font="12px monospace";const b=(c.x+M.x)/2,S=(c.y+M.y)/2;t.strokeText(`${C.toFixed(1)}`,b-15,S),t.fillText(`${C.toFixed(1)}`,b-15,S)}}}t.restore()}renderEnemyDebug(){const{game:e}=this,{ctx:t}=e,s=e.camera,n=100,r=s.x-n,o=s.y-n,a=s.x+e.canvas.width/s.zoom+n,l=s.y+e.canvas.height/s.zoom+n,d=(h,c)=>h>=r&&h<=a&&c>=o&&c<=l;t.save(),t.font="9px monospace";for(const h of e.enemies){if(!d(h.x,h.y))continue;const c=h,f=c.path,u=h.x-40;let A=h.y-h.r-35;const g=11,p=[`HP: ${Math.floor(h.hp)}`,`Pos: ${Math.floor(h.x)},${Math.floor(h.y)}`,`Target: ${h.target?h.target.kind||"colonist":"none"}`,`PathIdx: ${c.pathIndex??"none"}/${(f==null?void 0:f.length)??0}`,`Repath: ${c.repath?c.repath.toFixed(1)+"s":"none"}`,`Stuck: ${c.stuckTimer?c.stuckTimer.toFixed(1)+"s":"no"}`],w=120,k=p.length*g+4;t.fillStyle="rgba(0, 0, 0, 0.75)",t.fillRect(u-2,A-2,w,k),t.fillStyle="#ff4444";for(let M=0;M<p.length;M++)t.fillText(p[M],u,A+M*g+10)}t.restore()}renderUI(){const{game:e}=this,{ctx:t,canvas:s}=e,n=e.getPopulationCap(),r=e.colonists.filter(d=>d.inside&&d.inside.kind!=="bed").length,o=e.RES.wood+e.RES.stone+e.RES.food,a=e.getStorageCapacity(),l=e.hotbar.map(d=>({key:String(d),name:J[d].name,cost:e.costText(J[d].cost||{}),selected:e.selectedBuild===d}));Xa(t,s,{res:e.RES,colonists:e.colonists.filter(d=>d.alive).length,cap:n,hiding:r,day:e.day,tDay:e.tDay,isNight:e.isNight(),hotbar:l,messages:e.messages,storage:{used:o,max:a}},e),e.selColonist?$a(e,e.selColonist):e.colonistPanelRect=e.colonistPanelCloseRect=null,e.showBuildMenu&&an(e),e.pendingPlacement&&or(e),e.contextMenu&&ln(e),Ca(t,e.colonists,s.width,s.height),un(t,s.width,s.height),dr(e)}calculateColonistSpeed(e){const{game:t}=this;let s=e.speed||0;e.fatigueSlow&&(s*=e.fatigueSlow),s*=t.getMoveSpeedMultiplier(e);let n=s;const r=Math.floor(e.x/m),o=Math.floor(e.y/m);if(r>=0&&o>=0&&r<t.grid.cols&&o<t.grid.rows){const a=o*t.grid.cols+r,l=t.grid.cost[a];l>0&&(n=s/l)}return n}}function fr(i,e,t,s){const n=Math.floor(e/m),r=Math.floor(t/m),o=Math.ceil(s/m)+2,a=Math.max(0,n-o),l=Math.min(i.grid.cols-1,n+o),d=Math.max(0,r-o),h=Math.min(i.grid.rows-1,r+o);cs(i.grid,a,d,l-a+1,h-d+1);for(const c of i.buildings){const f=Math.floor(c.x/m),u=Math.floor((c.x+c.w-1)/m),A=Math.floor(c.y/m),g=Math.floor((c.y+c.h-1)/m);if(!(u<a||f>l||g<d||A>h)&&(c.kind!=="hq"&&c.kind!=="path"&&c.kind!=="house"&&c.kind!=="farm"&&c.kind!=="bed"&&c.kind!=="door"&&Di(i.grid,c.x,c.y,c.w,c.h),c.kind==="path"&&Ge(i.grid,c.x,c.y,c.w,c.h,"BASIC_PATH"),c.kind==="door"&&c.done&&Ge(i.grid,c.x,c.y,c.w,c.h,"BASIC_PATH"),c.kind==="house"&&c.done)){const p=c.x+c.w/2-m/2,w=c.y+c.h;Ge(i.grid,p,w,m,m,"FAST_ROAD")}}for(const c of i.trees){const f=Math.floor(c.x/m),u=Math.floor(c.y/m);f>=a&&f<=l&&u>=d&&u<=h&&nt(i.grid,c.x,c.y,c.r)}for(const c of i.rocks){const f=Math.floor(c.x/m),u=Math.floor(c.y/m);f>=a&&f<=l&&u>=d&&u<=h&&nt(i.grid,c.x,c.y,c.r)}i.regionManager.isEnabled()&&(i.regionManager.rebuildArea(a,d,l,h,i.buildings),i.regionManager.updateObjectCaches(i.buildings,i.trees,i.rocks))}function ur(i){ls(i.grid),i.grid.terrainGrid&&Bi(i.grid);for(const e of i.buildings)if(e.kind!=="hq"&&e.kind!=="path"&&e.kind!=="house"&&e.kind!=="farm"&&e.kind!=="bed"&&e.kind!=="door"&&Di(i.grid,e.x,e.y,e.w,e.h),e.kind==="path"&&Ge(i.grid,e.x,e.y,e.w,e.h,"BASIC_PATH"),e.kind==="door"&&e.done&&Ge(i.grid,e.x,e.y,e.w,e.h,"BASIC_PATH"),e.kind==="house"&&e.done){const t=e.x+e.w/2-m/2,s=e.y+e.h;Ge(i.grid,t,s,m,m,"FAST_ROAD")}for(const e of i.trees)nt(i.grid,e.x,e.y,e.r);for(const e of i.rocks)nt(i.grid,e.x,e.y,e.r);i.regionManager.isEnabled()&&(i.regionManager.onBuildingsChanged(i.buildings),i.regionManager.updateObjectCaches(i.buildings,i.trees,i.rocks))}function gr(i,e,t,s,n){return Fi(i.grid,e,t,s,n)}function Ar(i,e,t,s,n,r){return Fi(i.grid,t,s,n,r)}function Xi(i,e,t){const s=Math.floor(e/m),n=Math.floor(t/m);return s<0||n<0||s>=i.grid.cols||n>=i.grid.rows?-1:n*i.grid.cols+s}function pr(i,e,t){const s=Xi(i,e,t);return s<0?!0:!!i.grid.solid[s]}class mr{constructor(e){this.game=e}rebuildNavGrid(){ur(this.game)}rebuildNavGridPartial(e,t,s){fr(this.game,e,t,s)}syncTerrainToGrid(){Bi(this.game.grid)}computePath(e,t,s,n){return gr(this.game,e,t,s,n)}computePathWithDangerAvoidance(e,t,s,n,r){return Ar(this.game,e,t,s,n,r)}cellIndexAt(e,t){return Xi(this.game,e,t)}isBlocked(e,t){return pr(this.game,e,t)}findNearestBuildingByRegion(e,t,s){const{game:n}=this;if(!n.regionManager.isEnabled()){let r=null,o=1/0;for(const a of n.buildings){if(!s(a))continue;const l=a.x+a.w/2,d=a.y+a.h/2,h=Math.hypot(e-l,t-d);h<o&&(o=h,r=a)}return r}return n.regionManager.findNearestBuilding(e,t,s)}findNearestTreeByRegion(e,t){const{game:s}=this;if(!s.regionManager.isEnabled()){let r=null,o=1/0;for(const a of s.trees){if(a.hp<=0)continue;const l=Math.hypot(e-a.x,t-a.y);l<o&&(o=l,r=a)}return r}return s.regionManager.findNearestTree(e,t,s.trees)}findNearestRockByRegion(e,t){const{game:s}=this;if(!s.regionManager.isEnabled()){let r=null,o=1/0;for(const a of s.rocks){if(a.hp<=0)continue;const l=Math.hypot(e-a.x,t-a.y);l<o&&(o=l,r=a)}return r}return s.regionManager.findNearestRock(e,t,s.rocks)}isReachable(e,t,s,n){return this.game.regionManager.isEnabled()?this.game.regionManager.isReachable(e,t,s,n):!0}isWithinInteractionRange(e,t,s,n){const r=e-s.x,o=t-s.y;return Math.hypot(r,o)<=s.r+n}bestApproachToCircle(e,t,s){const{game:n}=this,r=16,o=new Set,a=[],l=Math.max(6,t.r+s-2),d=Math.atan2(t.y-e.y,t.x-e.x),h=[];for(let p=0;p<r;p++){const w=(p%2?1:-1)*Math.ceil(p/2);h.push(w/r*Math.PI*2+d)}for(const p of h){const w=t.x+Math.cos(p)*l,k=t.y+Math.sin(p)*l,M=Math.floor(w/m),x=Math.floor(k/m);if(M<0||x<0||M>=n.grid.cols||x>=n.grid.rows)continue;const C=M*m+m/2,b=x*m+m/2,S=`${M},${x}`;o.has(S)||(o.add(S),!this.isBlocked(C,b)&&a.push({x:C,y:b,gx:M,gy:x}))}if(a.length===0){const p=Math.atan2(e.y-t.y,e.x-t.x),w=t.r+s,k=Math.max(4,m*.33);for(let M=w;M>=Math.max(t.r+2,w-6*m);M-=k){const x=t.x+Math.cos(p)*M,C=t.y+Math.sin(p)*M,b=Math.floor(x/m),S=Math.floor(C/m);if(b<0||S<0||b>=n.grid.cols||S>=n.grid.rows)continue;const T=b*m+m/2,D=S*m+m/2;if(this.isBlocked(T,D))continue;if(this.computePathWithDangerAvoidance(e,e.x,e.y,T,D))return{x:T,y:D}}return{x:t.x+Math.cos(p)*w,y:t.y+Math.sin(p)*w}}let c=null,f=1/0,u=1/0,A=0;const g=8;for(const p of a){if(A>=g)break;const w=this.computePathWithDangerAvoidance(e,e.x,e.y,p.x,p.y);if(!w||w.length===0)continue;A++;let k=0;for(const x of w){const C=this.cellIndexAt(x.x,x.y);if(C<0){k=1/0;break}k+=n.grid.cost[C]||1}if(k===1/0)continue;const M=this.cellIndexAt(p.x,p.y);if(M>=0&&n.grid.cost[M]<=.7&&(k-=.05),w.length<=3&&k<=2)return Math.random()<.02&&console.log(`Early-out: great path found with length ${w.length} and cost ${k.toFixed(3)}`),p;(k<u||k===u&&w.length<f)&&(u=k,f=w.length,c=p)}return c?(Math.random()<.02&&console.log(`Best approach: (${c.x.toFixed(1)}, ${c.y.toFixed(1)}) with path cost ${u.toFixed(3)} and length ${f} (evaluated ${A} candidates)`),c):a[0]}}class yr{constructor(e,t){v(this,"dirtyRects",[]);v(this,"fullRedraw",!0);v(this,"canvasWidth",0);v(this,"canvasHeight",0);v(this,"FULL_REDRAW_THRESHOLD",.6);v(this,"MERGE_DISTANCE",32);this.canvasWidth=e,this.canvasHeight=t}markFullRedraw(){this.fullRedraw=!0,this.dirtyRects=[]}markDirty(e,t,s,n){if(this.fullRedraw)return;const r=this.clampRect(e,t,s,n);r.width<=0||r.height<=0||this.dirtyRects.push(r)}markCircleDirty(e,t,s){this.markDirty(e-s,t-s,s*2,s*2)}optimize(){if(this.fullRedraw||this.dirtyRects.length===0)return;const e=this.dirtyRects.reduce((s,n)=>s+n.width*n.height,0),t=this.canvasWidth*this.canvasHeight;if(e/t>this.FULL_REDRAW_THRESHOLD){this.markFullRedraw();return}this.mergeRects()}mergeRects(){let e=!0;for(;e&&this.dirtyRects.length>1;){e=!1;for(let t=0;t<this.dirtyRects.length;t++){for(let s=t+1;s<this.dirtyRects.length;s++){const n=this.dirtyRects[t],r=this.dirtyRects[s];if(this.shouldMerge(n,r)){const o=Math.min(n.x,r.x),a=Math.min(n.y,r.y),l=Math.max(n.x+n.width,r.x+r.width),d=Math.max(n.y+n.height,r.y+r.height);n.x=o,n.y=a,n.width=l-o,n.height=d-a,this.dirtyRects.splice(s,1),e=!0;break}}if(e)break}}}shouldMerge(e,t){const s={x:e.x-this.MERGE_DISTANCE,y:e.y-this.MERGE_DISTANCE,width:e.width+this.MERGE_DISTANCE*2,height:e.height+this.MERGE_DISTANCE*2};return!(s.x>t.x+t.width||s.x+s.width<t.x||s.y>t.y+t.height||s.y+s.height<t.y)}clampRect(e,t,s,n){const r=Math.max(0,e),o=Math.max(0,t),a=Math.min(this.canvasWidth,e+s),l=Math.min(this.canvasHeight,t+n);return{x:r,y:o,width:a-r,height:l-o}}clearDirty(e,t){if(this.fullRedraw){e.fillStyle=t,e.fillRect(0,0,this.canvasWidth,this.canvasHeight);return}e.fillStyle=t;for(const s of this.dirtyRects)e.clearRect(s.x,s.y,s.width,s.height),e.fillRect(s.x,s.y,s.width,s.height)}getDirtyRects(){return this.fullRedraw?[{x:0,y:0,width:this.canvasWidth,height:this.canvasHeight}]:this.dirtyRects}isDirty(e,t,s,n){if(this.fullRedraw)return!0;for(const r of this.dirtyRects)if(!(e>r.x+r.width||e+s<r.x||t>r.y+r.height||t+n<r.y))return!0;return!1}reset(){this.dirtyRects=[],this.fullRedraw=!1}resize(e,t){this.canvasWidth=e,this.canvasHeight=t,this.markFullRedraw()}getStats(){if(this.fullRedraw)return{dirtyRectCount:1,fullRedraw:!0,dirtyAreaPercent:100};const e=this.dirtyRects.reduce((s,n)=>s+n.width*n.height,0),t=this.canvasWidth*this.canvasHeight;return{dirtyRectCount:this.dirtyRects.length,fullRedraw:!1,dirtyAreaPercent:t>0?e/t*100:0}}}class br{constructor(e){v(this,"canvas");v(this,"ctx");v(this,"DPR",1);v(this,"dirtyRectTracker");v(this,"state",new Fa);v(this,"timeSystem",new La);v(this,"cameraSystem",new Wa);v(this,"resourceSystem",new za);v(this,"inputManager",new Na);v(this,"uiManager",new Oa);v(this,"renderManager",new hr(this));v(this,"navigationManager",new mr(this));v(this,"performanceMetrics",lt.getInstance());v(this,"simulationClock",ct.getInstance({simulationHz:30}));v(this,"budgetManager",dt.getInstance());v(this,"adaptiveTickRate",new va);v(this,"regionVersionManager",new Ma);v(this,"pathRequestQueue",new ka(this.regionVersionManager));v(this,"deferredRebuildSystem",new class{constructor(t){v(this,"game");v(this,"rebuildQueued",!1);v(this,"fullRebuildQueued",!1);v(this,"affectedRegions",new Set);this.game=t}requestFullRebuild(){this.fullRebuildQueued=!0,this.rebuildQueued=!0}processQueue(){if(this.rebuildQueued){if(this.fullRebuildQueued){const t=this.game.regionManager.isEnabled()?Array.from(this.game.regionManager.getRegions().keys()):[];this.game.navigationManager.rebuildNavGrid();for(const s of t)this.game.regionVersionManager.markRegionChanged(s),this.affectedRegions.add(s);this.affectedRegions.size>0&&(this.game.pathRequestQueue.invalidateCacheForRegions(Array.from(this.affectedRegions)),this.affectedRegions.clear()),this.fullRebuildQueued=!1}this.rebuildQueued=!1}}hasQueuedRebuilds(){return this.rebuildQueued}}(this));v(this,"uiScale",1);v(this,"baseFontSize",14);v(this,"isTouch",!1);v(this,"isActuallyTouchDevice",!1);v(this,"debug",{nav:!1,paths:!0,colonists:!1,forceDesktopMode:!1,regions:!1,terrain:!1,performanceHUD:!1});v(this,"handleResize",()=>{const e=document.querySelector("header"),t=e?Math.ceil(e.getBoundingClientRect().height):48,s=window.innerWidth,n=window.innerHeight-t;this.canvas.style.width=s+"px",this.canvas.style.height=n+"px",this.canvas.width=Math.floor(s*this.DPR),this.canvas.height=Math.floor(n*this.DPR),this.cameraSystem.setCanvasDimensions(this.canvas.width,this.canvas.height,this.DPR),this.dirtyRectTracker&&this.dirtyRectTracker.resize(this.canvas.width,this.canvas.height),this.calculateUIScale(),this.clampCameraToWorld()});v(this,"screenToWorld",(e,t)=>this.cameraSystem.screenToWorld(e,t));v(this,"respawnTimer",0);v(this,"assignedTargets",new WeakSet);v(this,"buildReservations",new Map);v(this,"insideCounts",new Map);v(this,"sleepReservations",new Map);v(this,"lastCameraX");v(this,"lastCameraY");v(this,"lastCameraZoom");v(this,"lastPerfLog",0);v(this,"PERF_LOG_INTERVAL",5e3);v(this,"last",performance.now());v(this,"frame",e=>{const t=performance.now(),s=this.simulationClock.tick(e);for(let r=0;r<s;r++)this.performanceMetrics.startTiming("other"),this.simulationClock.runSimulationStep(o=>{this.update(o)}),this.performanceMetrics.endTiming();this.performanceMetrics.startTiming("render"),this.draw(),this.performanceMetrics.endTiming();const n=performance.now()-t;this.performanceMetrics.endFrame(n),this.simulationClock.recordRenderFrame(),e-this.lastPerfLog>=this.PERF_LOG_INTERVAL&&(console.log(this.performanceMetrics.getSummary()),this.lastPerfLog=e),requestAnimationFrame(this.frame)});v(this,"grid",rs());v(this,"terrainGrid",ns(this.grid.cols,this.grid.rows));v(this,"regionManager",new ws(this.grid));const t=e.getContext("2d");if(!t)throw new Error("no ctx");this.canvas=e,this.ctx=t,this.DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)),this.handleResize(),this.dirtyRectTracker=new yr(e.width,e.height),window.addEventListener("resize",()=>this.handleResize()),this.bindInput(),this.newGame(),this.grid.terrainGrid=this.terrainGrid,this.syncTerrainToGrid(),this.rebuildNavGridImmediate(),this.regionManager.initialize(this.buildings),this.regionManager.updateObjectCaches(this.buildings,this.trees,this.rocks),this.resourceSystem.reset(),this.timeSystem.reset(),this.cameraSystem.setCanvasDimensions(this.canvas.width,this.canvas.height,this.DPR),this.cameraSystem.setZoom(1),this.cameraSystem.centerOn(ne.x,ne.y),this.clampCameraToWorld(),_.loadItems(),Pa(this),lr({visible:!1,position:"top-right"}),this.applyDamageToColonist=(s,n,r="cut")=>{Qt(this,s,n,r)},requestAnimationFrame(this.frame)}get camera(){return this.cameraSystem.getCameraRef()}getStorageCapacity(){const e=this.state.buildings.filter(s=>s.done&&s.kind==="warehouse").length,t=this.state.buildings.filter(s=>s.done&&s.kind==="tent").length;return this.resourceSystem.getStorageCapacity(e,t)}getPopulationCap(){const e=this.buildings.find(s=>s.kind==="hq")?3:0,t=this.buildings.filter(s=>s.done&&typeof s.popCap=="number").reduce((s,n)=>s+(n.popCap||0),0);return e+t}addResource(e,t){const s=this.getStorageCapacity(),n=this.resourceSystem.addResource(e,t,s);return n===0&&t>0&&this.msg(`Storage full! Cannot store more ${String(e)}`,"warn"),n}get colonists(){return this.state.colonists}set colonists(e){this.state.colonists=e}get enemies(){return this.state.enemies}set enemies(e){this.state.enemies=e}get buildings(){return this.state.buildings}set buildings(e){this.state.buildings=e}get trees(){return this.state.trees}set trees(e){this.state.trees=e}get rocks(){return this.state.rocks}set rocks(e){this.state.rocks=e}get bullets(){return this.state.bullets}set bullets(e){this.state.bullets=e}get particles(){return this.state.particles}set particles(e){this.state.particles=e}get messages(){return this.state.messages}set messages(e){this.state.messages=e}get RES(){return this.resourceSystem.getResourcesRef()}get day(){return this.timeSystem.getDay()}set day(e){this.timeSystem.setDay(e)}get tDay(){return this.timeSystem.getTimeOfDay()}set tDay(e){this.timeSystem.setTimeOfDay(e)}get dayLength(){return this.timeSystem.getDayLength()}get fastForward(){return this.timeSystem.getFastForward()}set fastForward(e){this.timeSystem.setFastForward(e)}get paused(){return this.timeSystem.isPaused()}set paused(e){this.timeSystem.setPaused(e)}get selectedBuild(){return this.uiManager.selectedBuild}set selectedBuild(e){this.uiManager.selectedBuild=e}get hotbar(){return this.uiManager.hotbar}set hotbar(e){this.uiManager.hotbar=e}get showBuildMenu(){return this.uiManager.showBuildMenu}set showBuildMenu(e){this.uiManager.showBuildMenu=e}get selColonist(){return this.uiManager.selColonist}set selColonist(e){this.uiManager.selColonist=e}get follow(){return this.uiManager.follow}set follow(e){this.uiManager.follow=e}get pendingPlacement(){return this.uiManager.pendingPlacement}set pendingPlacement(e){this.uiManager.pendingPlacement=e}get menuRects(){return this.uiManager.menuRects}set menuRects(e){this.uiManager.menuRects=e}get hotbarRects(){return this.uiManager.hotbarRects}set hotbarRects(e){this.uiManager.hotbarRects=e}get placeUIRects(){return this.uiManager.placeUIRects}set placeUIRects(e){this.uiManager.placeUIRects=e}get colonistPanelRect(){return this.uiManager.colonistPanelRect}set colonistPanelRect(e){this.uiManager.colonistPanelRect=e}get colonistPanelCloseRect(){return this.uiManager.colonistPanelCloseRect}set colonistPanelCloseRect(e){this.uiManager.colonistPanelCloseRect=e}get colonistProfileTab(){return this.uiManager.colonistProfileTab}set colonistProfileTab(e){this.uiManager.colonistProfileTab=e}get colonistTabRects(){return this.uiManager.colonistTabRects}set colonistTabRects(e){this.uiManager.colonistTabRects=e}get contextMenu(){return this.uiManager.contextMenu}set contextMenu(e){this.uiManager.contextMenu=e}get contextMenuRects(){return this.uiManager.contextMenuRects}set contextMenuRects(e){this.uiManager.contextMenuRects=e}get longPressTimer(){return this.uiManager.longPressTimer}set longPressTimer(e){this.uiManager.longPressTimer=e}get longPressStartPos(){return this.uiManager.longPressStartPos}set longPressStartPos(e){this.uiManager.longPressStartPos=e}get longPressStartTime(){return this.uiManager.longPressStartTime}set longPressStartTime(e){this.uiManager.longPressStartTime=e}get longPressTarget(){return this.uiManager.longPressTarget}set longPressTarget(e){this.uiManager.longPressTarget=e}get longPressTargetType(){return this.uiManager.longPressTargetType}set longPressTargetType(e){this.uiManager.longPressTargetType=e}get lastPaintCell(){return this.uiManager.lastPaintCell}set lastPaintCell(e){this.uiManager.lastPaintCell=e}get eraseDragStart(){return this.uiManager.eraseDragStart}set eraseDragStart(e){this.uiManager.eraseDragStart=e}get pendingDragging(){return this.uiManager.pendingDragging}set pendingDragging(e){this.uiManager.pendingDragging=e}get mouse(){return this.inputManager.getMouseRef()}get keyState(){return this.inputManager.getKeyStateRef()}get once(){return new Set}get touchLastPan(){return this.inputManager.getTouchPan()}set touchLastPan(e){this.inputManager.setTouchPan(e)}get touchLastDist(){return this.inputManager.getTouchDist()}set touchLastDist(e){this.inputManager.setTouchDist(e)}get lastInputWasTouch(){return this.inputManager.wasLastInputTouch()}set lastInputWasTouch(e){this.inputManager.setLastInputWasTouch(e)}getEquippedItems(e){var s;const t=((s=e.inventory)==null?void 0:s.equipment)||{};return[t.helmet,t.armor,t.weapon,t.tool,t.accessory].filter(Boolean)}getMoveSpeedMultiplier(e){let t=0;for(const n of this.getEquippedItems(e)){if(!(n!=null&&n.defName))continue;const r=_.getItemDef(n.defName);r!=null&&r.movementPenalty&&(t+=r.movementPenalty)}t=Math.min(.4,Math.max(0,t));const s=1-t;return Math.max(.6,s)}getWorkSpeedMultiplier(e,t){let s=0;for(const o of this.getEquippedItems(e)){if(!(o!=null&&o.defName))continue;const a=_.getItemDef(o.defName);a!=null&&a.workSpeedBonus&&(!a.workTypes||a.workTypes.includes(t))&&(s+=a.workSpeedBonus)}s=Math.min(.8,Math.max(0,s));const n=e.manipulationMultiplier||1,r=e.consciousnessMultiplier||1;return(1+s)*n*r}getArmorReduction(e){var r;let t=0;const s=((r=e.inventory)==null?void 0:r.equipment)||{},n=[s.helmet,s.armor];for(const o of n){if(!(o!=null&&o.defName))continue;const a=_.getItemDef(o.defName);a!=null&&a.armorRating&&(t+=a.armorRating)}return Math.min(.8,Math.max(0,t))}applyDamageToColonist(e,t,s="bruise"){var a,l;e.health||He(e);const n=this.getArmorReduction(e),r=t*(1-n),o=Qt(this,e,r,s,{damageMultiplier:1});if(o.died)this.msg(`${((a=e.profile)==null?void 0:a.name)||"Colonist"} died from ${o.cause||"injuries"}!`,"bad");else if(o.bodyPart){const d=o.fatal?"critically":"severely";this.msg(`${((l=e.profile)==null?void 0:l.name)||"Colonist"} ${d} injured in ${o.bodyPart} (${s})`,"warn")}}calculatePainFromDamage(e,t){return Math.min(1,({cut:.3,bruise:.1,burn:.4,bite:.35,gunshot:.5,fracture:.6}[e]||.2)*t)}calculateBleedingFromDamage(e,t){return Math.min(1,({cut:.4,bruise:0,burn:.1,bite:.3,gunshot:.5,fracture:.2}[e]||.1)*t)}calculateHealRate(e,t){return({cut:.8,bruise:1.2,burn:.6,bite:.7,gunshot:.4,fracture:.3}[e]||.8)*(1-t*.5)}calculateInfectionChance(e,t){return Math.min(.8,({cut:.15,bruise:0,burn:.25,bite:.4,gunshot:.3,fracture:.1}[e]||.1)*t)}generateInjuryDescription(e,t,s){const n=s<.2?"minor":s<.5?"moderate":s<.8?"severe":"critical";return{cut:`${n} laceration on ${t}`,bruise:`${n} bruising on ${t}`,burn:`${n} burn on ${t}`,bite:`${n} bite wound on ${t}`,gunshot:`${n} gunshot wound in ${t}`,fracture:`${n} fracture in ${t}`}[e]||`${n} injury to ${t}`}recalculateColonistHealth(e){if(!e.health)return;let t=0,s=0;for(const l of e.health.injuries)t+=l.pain,s+=l.bleeding;e.health.totalPain=Math.min(1,t),e.health.bloodLevel=Math.max(0,1-s),e.health.consciousness=Math.max(.1,1-t*.3-(1-e.health.bloodLevel)*.5);const n=e.health.injuries.filter(l=>l.bodyPart==="left_leg"||l.bodyPart==="right_leg");let r=0;for(const l of n)r+=l.severity*.3;e.health.mobility=Math.max(.2,1-r-t*.2);const o=e.health.injuries.filter(l=>l.bodyPart==="left_arm"||l.bodyPart==="right_arm");let a=0;for(const l of o)a+=l.severity*.4;e.health.manipulation=Math.max(.1,1-a-t*.3)}tryConsumeInventoryFood(e){var s,n,r;if(!e.inventory)return!1;const t=e.inventory.items;for(let o=0;o<t.length;o++){const a=t[o];if(!(a.category==="Food"||!!a.defName&&((s=_.getItemDef(a.defName))==null?void 0:s.category)==="Food")||a.quantity<=0)continue;const d=a.defName&&((n=_.getItemDef(a.defName))==null?void 0:n.nutrition)||10,h=Math.max(20,Math.min(70,Math.round(d*3)));return e.hunger=Math.max(0,(e.hunger||0)-h),e.hp=Math.min(100,e.hp+1.5),this.msg(`${((r=e.profile)==null?void 0:r.name)||"Colonist"} ate ${a.name}`,"good"),a.quantity-=1,a.quantity<=0&&t.splice(o,1),this.recalcInventoryWeight(e),!0}return!1}recalcInventoryWeight(e){if(!e.inventory)return;let t=0;for(const n of e.inventory.items)t+=(n.weight||0)*(n.quantity||1);const s=e.inventory.equipment||{};for(const n of["helmet","armor","weapon","tool","accessory"]){const r=s[n];r&&(t+=r.weight||0)}e.inventory.currentWeight=Math.round(t*100)/100}clampCameraToWorld(){const e=this.canvas.width/this.DPR/this.camera.zoom,t=this.canvas.height/this.DPR/this.camera.zoom,s=Math.max(0,G.w-e),n=Math.max(0,G.h-t);Number.isFinite(this.camera.x)||(this.camera.x=0),Number.isFinite(this.camera.y)||(this.camera.y=0),this.camera.x=te(this.camera.x,0,s),this.camera.y=te(this.camera.y,0,n)}calculateUIScale(){const s=this.canvas.width/this.DPR,n=this.canvas.height/this.DPR,r=s/1920,o=n/1080;let a=Math.min(r,o);const l="ontouchstart"in window||navigator.maxTouchPoints>0;this.isTouch=l,this.isActuallyTouchDevice=l&&s<900,l?s<600?a=Math.max(a*1.9,1.6):s<=900?a=Math.max(a*1.7,1.5):s<=1200?a=Math.max(a*1.5,1.35):a=Math.max(a*1.25,a):s<1200&&(a*=1.1),a=Math.max(1.1,Math.min(a,3)),this.uiScale=a,console.log(`UI Scale calculated: ${a.toFixed(2)} for ${s}x${n}`)}getScaledFont(e,t="500",s="system-ui,Segoe UI,Roboto"){return`${t} ${Math.round(e*this.uiScale)}px ${s}`}scale(e){return Math.round(e*this.uiScale)}bindInput(){const e=this.canvas;e.addEventListener("mousemove",t=>{const s=e.getBoundingClientRect();this.mouse.x=t.clientX-s.left,this.mouse.y=t.clientY-s.top;const n=this.screenToWorld(this.mouse.x,this.mouse.y);if(this.mouse.wx=n.x,this.mouse.wy=n.y,We()){Ta(this.mouse.x*this.DPR,this.mouse.y*this.DPR,this.colonists,this.canvas.width,this.canvas.height);return}if(this.pendingPlacement&&this.mouse.down){const r=J[this.pendingPlacement.key],o=this.pendingPlacement.rot||0,a=o===90||o===270,l=Math.floor(this.mouse.wx/m)*m,d=Math.floor(this.mouse.wy/m)*m,h=(a?r.size.h:r.size.w)*m,c=(a?r.size.w:r.size.h)*m;this.pendingPlacement.x=te(l,0,G.w-h),this.pendingPlacement.y=te(d,0,G.h-c);return}if(this.mouse.down){const r=this.selectedBuild?J[this.selectedBuild]:null;r!=null&&r.isFloor?this.paintPathAtMouse():this.selectedBuild==="wall"&&this.paintWallAtMouse()}}),e.addEventListener("mousedown",t=>{var s,n;if(t.preventDefault(),this.lastInputWasTouch=!1,We())return ci(t.offsetX*this.DPR,t.offsetY*this.DPR,this.colonists,this.canvas.width,this.canvas.height),void 0;if($t())return _t(t.offsetX*this.DPR,t.offsetY*this.DPR,this.canvas.width,this.canvas.height),void 0;if(t.button===0){if(this.mouse.down=!0,this.selColonist){const l=this.mouse.x*this.DPR,d=this.mouse.y*this.DPR;if(this.colonistPanelCloseRect){const h=this.colonistPanelCloseRect;if(l>=h.x&&l<=h.x+h.w&&d>=h.y&&d<=h.y+h.h){this.selColonist=null,this.follow=!1;return}}if(this.colonistTabRects){for(const h of this.colonistTabRects)if(l>=h.x&&l<=h.x+h.w&&d>=h.y&&d<=h.y+h.h){this.colonistProfileTab=h.tab;return}}if(this.colonistPanelRect){const h=this.colonistPanelRect;if(!(l>=h.x&&l<=h.x+h.w&&d>=h.y&&d<=h.y+h.h)){this.selColonist=null,this.follow=!1;return}}}if(this.pendingPlacement){const l=this.mouse.x*this.DPR,d=this.mouse.y*this.DPR;if(this.placeUIRects.length){for(const b of this.placeUIRects)if(l>=b.x&&l<=b.x+b.w&&d>=b.y&&d<=b.y+b.h){b.id==="up"?this.nudgePending(0,-1):b.id==="down"?this.nudgePending(0,1):b.id==="left"?this.nudgePending(-1,0):b.id==="right"?this.nudgePending(1,0):b.id==="ok"?this.confirmPending():b.id==="cancel"?this.cancelPending():b.id==="rotL"?this.rotatePending(-90):b.id==="rotR"&&this.rotatePending(90);return}}const h=this.pendingPlacement,c=J[h.key],u=((b,S)=>({x:(b-this.camera.x)*this.camera.zoom,y:(S-this.camera.y)*this.camera.zoom}))(h.x,h.y),A=c.size.w*m*this.camera.zoom,g=c.size.h*m*this.camera.zoom;if(l>=u.x&&l<=u.x+A&&d>=u.y&&d<=u.y+g){this.pendingDragging=!0;return}const p=h.rot||0,w=p===90||p===270,k=Math.floor(this.mouse.wx/m)*m,M=Math.floor(this.mouse.wy/m)*m,x=(w?c.size.h:c.size.w)*m,C=(w?c.size.w:c.size.h)*m;h.x=te(k,0,G.w-x),h.y=te(M,0,G.h-C);return}const r=this.mouse.x*this.DPR,o=this.mouse.y*this.DPR;for(const l of this.hotbarRects)if(r>=l.x&&r<=l.x+l.w&&o>=l.y&&o<=l.y+l.h){const d=this.hotbar[l.index];d&&(this.selectedBuild=d,this.toast("Selected: "+J[d].name));return}if(this.contextMenu){const l=this.mouse.x*this.DPR,d=this.mouse.y*this.DPR;let h=!1;const c=this.contextMenu;for(const f of this.contextMenuRects)if(l>=f.x&&l<=f.x+f.w&&d>=f.y&&d<=f.y+f.h){const u=f.item;if(!u)continue;const A=u.enabled!==!1;if(!f.isSubmenu&&u.submenu&&u.submenu.length){A&&(c.openSubmenu=c.openSubmenu===u.id?void 0:u.id),h=!0;return}A&&(u.action?u.action({game:this,target:c.target,item:u}):c.onSelect&&c.onSelect({game:this,target:c.target,item:u})),ze(this),h=!0;return}h||ze(this)}if(this.showBuildMenu){Jt(this);return}if(window._eraseOnce){window._eraseOnce=!1,this.cancelOrErase();return}const a=this.selectedBuild?J[this.selectedBuild]:null;if(a!=null&&a.isFloor)this.paintPathAtMouse(!0);else if(this.selectedBuild==="wall")this.paintWallAtMouse(!0);else{const l=this.findColonistAt(this.mouse.wx,this.mouse.wy);l?(this.selColonist=l,this.follow=!0):this.placeAtMouse()}}if(t.button===2){if(this.mouse.rdown=!0,this.showBuildMenu){this.showBuildMenu=!1;return}if(this.selColonist&&this.selColonist.isDrafted){const a=this.findEnemyAt(this.mouse.wx,this.mouse.wy);if(a){this.selColonist.draftedTarget=a,this.selColonist.draftedPosition=null,this.msg(`${((s=this.selColonist.profile)==null?void 0:s.name)||"Colonist"} targeting enemy`,"info");return}this.selColonist.draftedPosition={x:this.mouse.wx,y:this.mouse.wy},this.selColonist.draftedTarget=null,this.msg(`${((n=this.selColonist.profile)==null?void 0:n.name)||"Colonist"} moving to position`,"info");return}const r=this.findColonistAt(this.mouse.wx,this.mouse.wy);if(r){Zt(this,r,this.mouse.x,this.mouse.y);return}const o=this.findBuildingAt(this.mouse.wx,this.mouse.wy);if(o&&yt(this,o,this.mouse.x,this.mouse.y))return;this.eraseDragStart={x:this.mouse.wx,y:this.mouse.wy}}}),e.addEventListener("mouseup",t=>{if(t.preventDefault(),t.button===0&&(this.mouse.down=!1,this.lastPaintCell=null,this.pendingDragging=!1),t.button===2){if(this.eraseDragStart){const s=Math.min(this.eraseDragStart.x,this.mouse.wx),n=Math.min(this.eraseDragStart.y,this.mouse.wy),r=Math.max(this.eraseDragStart.x,this.mouse.wx),o=Math.max(this.eraseDragStart.y,this.mouse.wy);(r-s)*(o-n)<12*12?this.cancelOrErase():this.eraseInRect({x:s,y:n,w:r-s,h:o-n})}this.mouse.rdown=!1,this.eraseDragStart=null}}),e.addEventListener("contextmenu",t=>t.preventDefault()),e.addEventListener("wheel",t=>{if(t.preventDefault(),We()){Ra(t.deltaY);return}const s=t.deltaY<0?1.1:.9,n=e.getBoundingClientRect(),r=t.clientX-n.left,o=t.clientY-n.top,a=this.screenToWorld(r,o),l=Math.max(.6,Math.min(2.2,this.camera.zoom*s));this.camera.zoom=l;const d=this.screenToWorld(r,o);this.camera.x+=a.x-d.x,this.camera.y+=a.y-d.y,this.clampCameraToWorld()}),this.inputManager.bindKeyboardEvents(()=>{const t=this.debugConsole;return t&&t.open}),window.addEventListener("keydown",t=>{const s=t;if(s.key==="`"||s.code==="Backquote"){t.preventDefault(),Ia(this);return}Ba(this,t)&&(t.preventDefault(),t.stopPropagation())}),e.addEventListener("touchstart",t=>{if(t.preventDefault(),this.lastInputWasTouch=!0,this.isActuallyTouchDevice=!0,t.touches.length===1){this.touchLastPan={x:t.touches[0].clientX,y:t.touches[0].clientY};const s=e.getBoundingClientRect(),n=t.touches[0].clientX-s.left,r=t.touches[0].clientY-s.top,o=this.screenToWorld(n,r),a=this.findColonistAt(o.x,o.y);if(a)this.longPressStartPos={x:n,y:r},this.longPressStartTime=performance.now(),this.longPressTarget=a,this.longPressTargetType="colonist",this.longPressTimer=window.setTimeout(()=>{Zt(this,a,n,r),navigator.vibrate&&navigator.vibrate(50),this.longPressStartTime=null,this.longPressTarget=null,this.longPressTargetType=null},500);else{const l=this.findBuildingAt(o.x,o.y);l&&(this.longPressStartPos={x:n,y:r},this.longPressStartTime=performance.now(),this.longPressTarget=l,this.longPressTargetType="building",this.longPressTimer=window.setTimeout(()=>{yt(this,l,n,r),navigator.vibrate&&navigator.vibrate(50),this.longPressStartTime=null,this.longPressTarget=null,this.longPressTargetType=null},500))}}else if(t.touches.length===2){this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.longPressStartTime=null,this.longPressTarget=null,this.longPressTargetType=null;const s=t.touches[0].clientX-t.touches[1].clientX,n=t.touches[0].clientY-t.touches[1].clientY;this.touchLastDist=Math.hypot(s,n)}},{passive:!1}),e.addEventListener("touchmove",t=>{if(t.preventDefault(),this.lastInputWasTouch=!0,this.longPressTimer&&this.longPressStartPos&&t.touches.length===1){const s=e.getBoundingClientRect(),n=t.touches[0].clientX-s.left,r=t.touches[0].clientY-s.top;Math.hypot(n-this.longPressStartPos.x,r-this.longPressStartPos.y)>20&&(clearTimeout(this.longPressTimer),this.longPressTimer=null,this.longPressStartTime=null,this.longPressTarget=null,this.longPressTargetType=null)}if(t.touches.length===1&&this.touchLastPan){if(this.pendingPlacement){const a=e.getBoundingClientRect(),l=t.touches[0].clientX-a.left,d=t.touches[0].clientY-a.top,h=this.screenToWorld(l,d);this.mouse.x=l,this.mouse.y=d,this.mouse.wx=h.x,this.mouse.wy=h.y;const c=J[this.pendingPlacement.key],f=this.pendingPlacement.rot||0,u=f===90||f===270,A=Math.floor(this.mouse.wx/m)*m,g=Math.floor(this.mouse.wy/m)*m,p=(u?c.size.h:c.size.w)*m,w=(u?c.size.w:c.size.h)*m;this.pendingPlacement.x=te(A,0,G.w-p),this.pendingPlacement.y=te(g,0,G.h-w);return}const s=t.touches[0].clientX,n=t.touches[0].clientY,r=s-this.touchLastPan.x,o=n-this.touchLastPan.y;this.touchLastPan={x:s,y:n},this.camera.x-=r/this.camera.zoom,this.camera.y-=o/this.camera.zoom,this.clampCameraToWorld()}else if(t.touches.length===2){const s=t.touches[0].clientX-t.touches[1].clientX,n=t.touches[0].clientY-t.touches[1].clientY,r=Math.hypot(s,n);if(this.touchLastDist!=null&&this.touchLastDist>0){const o=r/this.touchLastDist,a=e.getBoundingClientRect(),l=(t.touches[0].clientX+t.touches[1].clientX)/2-a.left,d=(t.touches[0].clientY+t.touches[1].clientY)/2-a.top,h=this.screenToWorld(l,d),c=Math.max(.6,Math.min(2.2,this.camera.zoom*o));this.camera.zoom=c;const f=this.screenToWorld(l,d);this.camera.x+=h.x-f.x,this.camera.y+=h.y-f.y,this.clampCameraToWorld()}this.touchLastDist=r}},{passive:!1}),e.addEventListener("touchend",t=>{if(t.preventDefault(),this.lastInputWasTouch=!0,this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null),this.longPressStartPos=null,this.longPressStartTime=null,this.longPressTarget=null,this.longPressTargetType=null,t.changedTouches.length===1&&t.touches.length===0){const s=e.getBoundingClientRect(),n=t.changedTouches[0].clientX-s.left,r=t.changedTouches[0].clientY-s.top;this.handleTapOrClickAtScreen(n,r)}t.touches.length===0&&(this.touchLastPan=null,this.touchLastDist=null)},{passive:!1})}handleTapOrClickAtScreen(e,t){this.canvas.getBoundingClientRect(),this.mouse.x=e,this.mouse.y=t;const n=this.screenToWorld(this.mouse.x,this.mouse.y);if(this.mouse.wx=n.x,this.mouse.wy=n.y,We())return ci(e*this.DPR,t*this.DPR,this.colonists,this.canvas.width,this.canvas.height),void 0;if($t())return _t(e*this.DPR,t*this.DPR,this.canvas.width,this.canvas.height),void 0;if(this.pendingPlacement){const h=this.mouse.x*this.DPR,c=this.mouse.y*this.DPR;if(this.placeUIRects.length){for(const b of this.placeUIRects)if(h>=b.x&&h<=b.x+b.w&&c>=b.y&&c<=b.y+b.h){b.id==="up"?this.nudgePending(0,-1):b.id==="down"?this.nudgePending(0,1):b.id==="left"?this.nudgePending(-1,0):b.id==="right"?this.nudgePending(1,0):b.id==="ok"?this.confirmPending():b.id==="cancel"?this.cancelPending():b.id==="rotL"?this.rotatePending(-90):b.id==="rotR"&&this.rotatePending(90);return}}const f=this.pendingPlacement,u=J[f.key],g=((b,S)=>({x:(b-this.camera.x)*this.camera.zoom,y:(S-this.camera.y)*this.camera.zoom}))(f.x,f.y),p=u.size.w*m*this.camera.zoom,w=u.size.h*m*this.camera.zoom;if(h>=g.x&&h<=g.x+p&&c>=g.y&&c<=g.y+w){this.confirmPending();return}const k=Math.floor(this.mouse.wx/m)*m,M=Math.floor(this.mouse.wy/m)*m,x=u.size.w*m,C=u.size.h*m;f.x=te(k,0,G.w-x),f.y=te(M,0,G.h-C);return}if(this.selColonist){const h=this.mouse.x*this.DPR,c=this.mouse.y*this.DPR;if(this.colonistPanelCloseRect){const f=this.colonistPanelCloseRect;if(h>=f.x&&h<=f.x+f.w&&c>=f.y&&c<=f.y+f.h){this.selColonist=null,this.follow=!1;return}}if(this.colonistTabRects){for(const f of this.colonistTabRects)if(h>=f.x&&h<=f.x+f.w&&c>=f.y&&c<=f.y+f.h){this.colonistProfileTab=f.tab;return}}if(this.isTouch&&this.colonistPanelRect){const f=this.colonistPanelRect;if(!(h>=f.x&&h<=f.x+f.w&&c>=f.y&&c<=f.y+f.h)){this.selColonist=null,this.follow=!1;return}}}const r=this.mouse.x*this.DPR,o=this.mouse.y*this.DPR;for(const h of this.hotbarRects)if(r>=h.x&&r<=h.x+h.w&&o>=h.y&&o<=h.y+h.h){const c=this.hotbar[h.index];c&&(this.selectedBuild=c,this.toast("Selected: "+J[c].name));return}if(this.contextMenu){const h=this.mouse.x*this.DPR,c=this.mouse.y*this.DPR;let f=!1;const u=this.contextMenu;for(const A of this.contextMenuRects)if(h>=A.x&&h<=A.x+A.w&&c>=A.y&&c<=A.y+A.h){const g=A.item;if(!g)continue;const p=g.enabled!==!1;if(!A.isSubmenu&&g.submenu&&g.submenu.length){p&&(u.openSubmenu=u.openSubmenu===g.id?void 0:g.id),f=!0;return}p&&(g.action?g.action({game:this,target:u.target,item:g}):u.onSelect&&u.onSelect({game:this,target:u.target,item:g})),ze(this),f=!0;return}f||ze(this)}if(this.showBuildMenu){Jt(this);return}if(window._eraseOnce){window._eraseOnce=!1,this.cancelOrErase();return}const a=this.selectedBuild?J[this.selectedBuild]:null;if(a!=null&&a.isFloor){this.paintPathAtMouse(!0);return}if(this.selectedBuild==="wall"){this.paintWallAtMouse(!0);return}if(!this.debug.forceDesktopMode&&this.isActuallyTouchDevice&&this.lastInputWasTouch&&this.selectedBuild){this.placeAtMouse();return}const l=this.findColonistAt(this.mouse.wx,this.mouse.wy);if(l){this.selColonist=l,this.follow=!0;return}const d=this.findBuildingAt(this.mouse.wx,this.mouse.wy);d&&yt(this,d,this.mouse.x,this.mouse.y)||this.placeAtMouse()}findColonistAt(e,t){for(let s=this.colonists.length-1;s>=0;s--){const n=this.colonists[s],r=n.inside&&n.inside.kind!=="bed";if(!n.alive||r)continue;if((n.x-e)*(n.x-e)+(n.y-t)*(n.y-t)<=(n.r+2)*(n.r+2))return n}return null}findEnemyAt(e,t){for(let s=this.enemies.length-1;s>=0;s--){const n=this.enemies[s];if(n.hp<=0)continue;if((n.x-e)*(n.x-e)+(n.y-t)*(n.y-t)<=(n.r+4)*(n.r+4))return n}return null}findBuildingAt(e,t,s){const n=(s==null?void 0:s.includeUnderConstruction)??!1;for(let r=this.buildings.length-1;r>=0;r--){const o=this.buildings[r];if(!(!n&&!o.done)&&e>=o.x&&e<=o.x+o.w&&t>=o.y&&t<=o.y+o.h)return o}return null}msg(e,t="info"){this.messages.push({text:e,t:4,kind:t}),this.toast(e,1600)}toast(e,t=1400){const s=document.getElementById("toast");s&&(s.textContent=e,s.style.opacity="1",clearTimeout(s._t),s._t=setTimeout(()=>s.style.opacity="0",t))}scatter(){for(let e=0;e<220;e++){const t={x:ee(80,G.w-80),y:ee(80,G.h-80)};Math.hypot(t.x-ne.x,t.y-ne.y)<220||this.trees.push({x:t.x,y:t.y,r:12,hp:40,type:"tree"})}for(let e=0;e<140;e++){const t={x:ee(80,G.w-80),y:ee(80,G.h-80)};Math.hypot(t.x-ne.x,t.y-ne.y)<200||this.rocks.push({x:t.x,y:t.y,r:12,hp:50,type:"rock"})}this.rebuildNavGridImmediate()}tryRespawn(e){if(this.respawnTimer+=e*this.fastForward,this.respawnTimer>=4){this.respawnTimer=0;const t=s=>{for(let n=0;n<6;n++){const r={x:ee(60,G.w-60),y:ee(60,G.h-60)};if(Math.hypot(r.x-ne.x,r.y-ne.y)<200)continue;let o=!0;for(const a of this.buildings)if(r.x>a.x-24&&r.x<a.x+a.w+24&&r.y>a.y-24&&r.y<a.y+a.h+24){o=!1;break}if(o){s==="tree"?this.trees.push({x:r.x,y:r.y,r:12,hp:40,type:"tree"}):this.rocks.push({x:r.x,y:r.y,r:12,hp:50,type:"rock"}),this.navigationManager.rebuildNavGridPartial(r.x,r.y,44);break}}};Math.random()<.5&&this.trees.length<260&&t("tree"),Math.random()<.35&&this.rocks.length<180&&t("rock")}}buildHQ(){const e={w:3*m,h:3*m},t={kind:"hq",name:"HQ",x:ne.x-e.w/2,y:ne.y-e.h/2,w:e.w,h:e.h,hp:600,done:!0,color:Z.bld,size:{w:3,h:3},build:0,buildLeft:0};this.buildings.push(t),this.rebuildNavGridImmediate()}newGame(){var s,n,r,o;this.colonists.length=this.enemies.length=this.trees.length=this.rocks.length=this.buildings.length=this.bullets.length=this.messages.length=0,this.buildReservations.clear(),this.insideCounts.clear(),this.sleepReservations.clear(),Je.clear(),this.RES.wood=50,this.RES.stone=30,this.RES.food=20,this.day=1,this.tDay=0,this.fastForward=1,this.camera.zoom=1,this.camera.x=ne.x-this.canvas.width/this.DPR/(2*this.camera.zoom),this.camera.y=ne.y-this.canvas.height/this.DPR/(2*this.camera.zoom),this.buildHQ(),this.scatter();for(let a=0;a<3;a++){const l=ee(0,Math.PI*2),d=80+ee(-10,10);this.spawnColonist({x:ne.x+Math.cos(l)*d,y:ne.y+Math.sin(l)*d})}let e=0;for(const a of this.colonists)((r=(n=(s=a.profile)==null?void 0:s.avatar)==null?void 0:n.sprites)==null?void 0:r.bodyType)==="Male_Average_Normal"&&(a.profile.avatar.sprites.bodyType="naked_male",e++);if(e>0&&(console.log(`Migrated ${e} colonist(s) to new body type, clearing sprite cache`),Je.clear()),!this.colonists.some(a=>{var l,d;return((d=(l=a.inventory)==null?void 0:l.equipment)==null?void 0:d.weapon)&&(a.inventory.equipment.weapon.defName==="Pistol"||a.inventory.equipment.weapon.defName==="Rifle")})&&this.colonists.length){const a=this.colonists[0],l=_.createItem("Pistol",1,"normal");l&&(a.inventory||(a.inventory={items:[],equipment:{},carryCapacity:50,currentWeight:0}),a.inventory.equipment.weapon=l,this.recalcInventoryWeight(a),this.msg(`${((o=a.profile)==null?void 0:o.name)||"Colonist"} starts with a pistol for defense.`,"info"))}this.msg("Welcome! Build farms before night, then turrets.")}spawnColonist(e){const t=ni(),s={x:e.x,y:e.y,r:8,hp:100,speed:50*t.stats.workSpeed,task:null,target:null,carrying:null,hunger:0,alive:!0,color:t.avatar.clothing,t:ee(0,1),direction:0,profile:t,inventory:JSON.parse(JSON.stringify(t.startingInventory))};return t.initialSkills&&(s.skills=t.initialSkills),He(s),Rt(s),s.useAsyncPathfinding=!0,this.colonists.push(s),this.msg(`${ea(t)} has joined the colony!`,"good"),s}spawnEnemy(){const e=_i(0,4);let t,s;e===0?(t=ee(0,G.w),s=-80):e===1?(t=ee(0,G.w),s=G.h+80):e===2?(t=-80,s=ee(0,G.h)):(t=G.w+80,s=ee(0,G.h));const n={x:t,y:s,r:9,hp:60+this.day*6,speed:48+this.day*2,dmg:8+this.day,target:null,color:Z.enemy};return this.enemies.push(n),n}placeAtMouse(){gn(this)}tryPlaceNow(e,t,s,n){Wt(this,e,t,s,n)}nudgePending(e,t){An(this,e,t)}rotatePending(e){pn(this,e)}confirmPending(){mn(this)}cancelPending(){yn(this)}paintPathAtMouse(e=!1){bn(this,e)}paintWallAtMouse(e=!1){wn(this,e)}eraseInRect(e){vn(this,e)}cancelOrErase(){Mn(this)}evictColonistsFrom(e){zt(this,e)}buildingCapacity(e){return e.kind==="hq"?8:e.kind==="house"?3:typeof e.popCap=="number"?e.popCap:1}getReservedSleepCount(e,t){const s=this.sleepReservations.get(e);return!s||s.size===0?0:t&&s.has(t)?Math.max(0,s.size-1):s.size}buildingHasSpace(e,t){const s=this.buildingCapacity(e),n=this.insideCounts.get(e)||0,r=this.getReservedSleepCount(e,t);return n+r<s}reserveSleepSpot(e,t){if(!t.done)return!1;if(e.reservedSleepFor===t)return!0;e.reservedSleepFor&&e.reservedSleepFor!==t&&this.releaseSleepReservation(e);const s=this.buildingCapacity(t),n=this.insideCounts.get(t)||0,r=this.sleepReservations.get(t)||new Set;return n+r.size>=s?!1:(r.add(e),this.sleepReservations.set(t,r),e.reservedSleepFor=t,!0)}releaseSleepReservation(e){const t=e.reservedSleepFor;if(!t)return;const s=this.sleepReservations.get(t);s&&(s.delete(e),s.size===0&&this.sleepReservations.delete(t)),e.reservedSleepFor=null}tryEnterBuilding(e,t){if(!t.done||!this.buildingHasSpace(t,e))return!1;if(this.insideCounts.set(t,(this.insideCounts.get(t)||0)+1),this.releaseSleepReservation(e),e.inside=t,e.hideTimer=0,t.kind==="bed"){const s=this.centerOf(t);e.x=s.x,e.y=s.y,e.restingOn=t,e.sleepFacing=Math.PI/2}else e.restingOn=null;return!0}leaveBuilding(e){const t=e.inside;if(t){const s=(this.insideCounts.get(t)||1)-1;s<=0?this.insideCounts.delete(t):this.insideCounts.set(t,s)}t&&t.kind==="bed"&&(e.restingOn=null,e.sleepFacing=void 0),e.inside=null,e.hideTimer=0}getMaxCrew(e){const t=e.w/m*(e.h/m);return t<=1?1:t<=4?2:3}releaseBuildReservation(e){if(!e.reservedBuildFor)return;const t=e.reservedBuildFor,s=(this.buildReservations.get(t)||1)-1;s<=0?this.buildReservations.delete(t):this.buildReservations.set(t,s),e.reservedBuildFor=null}clearPath(e){e.path=void 0,e.pathIndex=void 0}setTask(e,t,s,n=!1){if(e.target&&e.target.type&&this.assignedTargets.has(e.target)&&this.assignedTargets.delete(e.target),e.reservedBuildFor&&e.reservedBuildFor!==s&&this.releaseBuildReservation(e),e.task=t,e.target=s,this.clearPath(e),n&&(e.playerCommand={issued:!0,timestamp:e.t||0,task:t,expires:(e.t||0)+300}),s&&s.type&&(s.type==="tree"||s.type==="rock")&&this.assignedTargets.add(s),t==="build"&&s&&s.w!=null&&!e.reservedBuildFor){const r=s,o=this.buildReservations.get(r)||0,a=this.getMaxCrew(r);o<a&&(this.buildReservations.set(r,o+1),e.reservedBuildFor=r)}}pickTask(e){var r,o;if(e.workPriorities||Rt(e),this.isNight()){this.setTask(e,"idle",{x:e.x,y:e.y});return}const t=[],s=a=>{const l=e.workPriorities;if(!l||!l[a])return 3;const d=l[a];return d===0?999:d},n=a=>{const l=e.workPriorities;return l?l[a]!==0:!0};if(n("Construction"))for(const a of this.buildings){if(a.done||(this.buildReservations.get(a)||0)>=this.getMaxCrew(a))continue;const d=Math.hypot(e.x-(a.x+a.w/2),e.y-(a.y+a.h/2));t.push({workType:"Construction",task:"build",target:a,distance:d,priority:s("Construction")})}if(n("Growing")){const a=this.buildings.find(l=>l.kind==="farm"&&l.done&&l.ready);if(a){const l=Math.hypot(e.x-(a.x+a.w/2),e.y-(a.y+a.h/2));t.push({workType:"Growing",task:"harvestFarm",target:a,distance:l,priority:s("Growing")})}if(Math.random()<.1){const l=this.buildings.find(d=>d.kind==="well"&&d.done);if(l){const d=Math.hypot(e.x-(l.x+l.w/2),e.y-(l.y+l.h/2));t.push({workType:"Growing",task:"harvestWell",target:l,distance:d,priority:s("Growing")})}}}if(n("PlantCutting")&&(this.RES.food<Math.max(4,this.colonists.length*2)||this.RES.wood<this.RES.stone)){const l=this.trees.filter(h=>!this.assignedTargets.has(h)),d=this.nearestSafeCircle(e,{x:e.x,y:e.y},l);if(d){const h=Math.hypot(e.x-d.x,e.y-d.y);t.push({workType:"PlantCutting",task:"chop",target:d,distance:h,priority:s("PlantCutting")})}}if(n("Mining")&&(this.RES.stone<this.RES.wood||this.RES.stone<20)){const a=this.rocks.filter(d=>!this.assignedTargets.has(d)),l=this.nearestSafeCircle(e,{x:e.x,y:e.y},a);if(l){const d=Math.hypot(e.x-l.x,e.y-l.y);t.push({workType:"Mining",task:"mine",target:l,distance:d,priority:s("Mining")})}}if(n("Cooking")){const a=this.buildings.filter(h=>h.kind==="stove"&&h.done),l=this.buildings.filter(h=>h.kind==="farm"&&h.done);let d=this.RES.wheat||0;for(const h of l)h.inventory&&(d+=Oe(h,"wheat"));if(a.length>0&&d>=5){const h=a.find(c=>!c.cookingColonist||c.cookingColonist===e.id);if(h){const c=Math.hypot(e.x-(h.x+h.w/2),e.y-(h.y+h.h/2));t.push({workType:"Cooking",task:"cookWheat",target:h,distance:c,priority:s("Cooking")})}}if(e.carryingBread&&e.carryingBread>0){const h=this.buildings.filter(c=>c.kind==="pantry"&&c.done);if(h.length>0){const c=h.reduce((u,A)=>{const g=Math.hypot(e.x-(A.x+A.w/2),e.y-(A.y+A.h/2)),p=Math.hypot(e.x-(u.x+u.w/2),e.y-(u.y+u.h/2));return g<p?A:u}),f=Math.hypot(e.x-(c.x+c.w/2),e.y-(c.y+c.h/2));t.push({workType:"Cooking",task:"storeBread",target:c,distance:f,priority:s("Cooking")-1})}}}if(n("Hauling")){const a=this.buildings.filter(d=>d.kind==="stove"&&d.done&&d.inventory),l=this.buildings.filter(d=>d.kind==="pantry"&&d.done);if(l.length>0){for(const d of a)if(Oe(d,"bread")>0){const c=l.reduce((u,A)=>{const g=Math.hypot(e.x-(A.x+A.w/2),e.y-(A.y+A.h/2)),p=Math.hypot(e.x-(u.x+u.w/2),e.y-(u.y+u.h/2));return g<p?A:u}),f=Math.hypot(e.x-(d.x+d.w/2),e.y-(d.y+d.h/2));t.push({workType:"Hauling",task:"haulBread",target:d,extraData:c,distance:f,priority:s("Hauling")})}}}if(t.sort((a,l)=>a.priority!==l.priority?a.priority-l.priority:a.distance-l.distance),t.length>0){const a=t[0];this.setTask(e,a.task,a.target),Math.random()<.1&&console.log(`Colonist ${((r=e.profile)==null?void 0:r.name)||"Unknown"} assigned ${a.workType} (priority ${a.priority}): ${a.task}`)}else this.setTask(e,"idle",{x:e.x+ee(-80,80),y:e.y+ee(-80,80)}),Math.random()<.05&&console.log(`Colonist ${((o=e.profile)==null?void 0:o.name)||"Unknown"} has no available work (idling)`)}nearestCircle(e,t){let s=null,n=1e9;for(const r of t){const o=re(e,r);o<n&&(n=o,s=r)}return s}nearestSafeCircle(e,t,s){return this.nearestCircle(t,s)}moveAlongPath(e,t,s,n=10){const r=e.useAsyncPathfinding===!0,o=s&&(!e.pathGoal||Math.hypot(e.pathGoal.x-s.x,e.pathGoal.y-s.y)>24);if(s&&(o||!e.path||e.pathIndex==null))if(r){if(e.pendingPath=!0,this.requestColonistPath(e,s.x,s.y,w=>{w&&w.length>0&&(e.path=w,e.pathIndex=0,e.pathGoal={x:s.x,y:s.y},e.pendingPath=!1)}),!e.path)return!1}else{const w=this.computePathWithDangerAvoidance(e,e.x,e.y,s.x,s.y);if(w&&w.length){if(e.path=w,e.pathIndex=0,e.pathGoal={x:s.x,y:s.y},Math.random()<.1){let k=0;for(const M of w){const x=Math.floor(M.x/m),C=Math.floor(M.y/m);if(x>=0&&C>=0&&x<this.grid.cols&&C<this.grid.rows){const b=C*this.grid.cols+x;this.grid.cost[b]<=.7&&k++}}k>0&&console.log(`Computed path with ${k}/${w.length} low-cost tiles`)}}else Math.random()<.05&&console.log(`Failed to compute path from (${e.x.toFixed(1)}, ${e.y.toFixed(1)}) to (${s.x.toFixed(1)}, ${s.y.toFixed(1)})`)}if(!e.path||e.pathIndex==null||e.pathIndex>=e.path.length)return s?Math.hypot(e.x-s.x,e.y-s.y)<=n:!1;const a=e.path[e.pathIndex];if(!a||a.x==null||a.y==null)return console.log(`Invalid path node at index ${e.pathIndex}, clearing path`),this.clearPath(e),s?Math.hypot(e.x-s.x,e.y-s.y)<=n:!1;const l=a.x-e.x,d=a.y-e.y;let h=Math.hypot(l,d);const c=15,f=6;let u=e.speed*(e.fatigueSlow||1)*this.getMoveSpeedMultiplier(e),A=u,g=!1;{const w=Math.floor(e.x/m),k=Math.floor(e.y/m);if(w>=0&&k>=0&&w<this.grid.cols&&k<this.grid.rows){const x=k*this.grid.cols+w,C=this.grid.cost[x];C>0&&C<1?(A=u/C,g=!0):C>1&&(A=u/C),g&&Math.random()<.01&&console.log(`Colonist at (${e.x.toFixed(1)}, ${e.y.toFixed(1)}) on floor - cost: ${C.toFixed(2)}, speed: ${A.toFixed(1)} (base: ${u.toFixed(1)})`)}}const p=A*t;if(h<=Math.max(c,p))return e.x=a.x,e.y=a.y,e.pathIndex++,e.jitterScore=0,e.jitterWindow=0,e.lastDistToNode=void 0,e.lastDistSign=void 0,e.pathIndex>=e.path.length?(e.path=void 0,e.pathIndex=void 0,s?Math.hypot(e.x-s.x,e.y-s.y)<=n:!0):!1;if(e.jitterWindow=(e.jitterWindow||0)+t,e.lastDistToNode!=null){const w=h-e.lastDistToNode,k=w===0?0:w>0?1:-1,M=e.lastDistSign??k;k!==0&&M!==0&&k!==M&&h<c+15?e.jitterScore=(e.jitterScore||0)+1:e.jitterScore=Math.max(0,(e.jitterScore||0)-1),e.lastDistSign=k}if(e.lastDistToNode=h,(e.jitterScore||0)>=8||(e.jitterWindow||0)>3){if(h<c+f){if(e.pathIndex++,e.pathIndex>=e.path.length)return this.clearPath(e),s?Math.hypot(e.x-s.x,e.y-s.y)<=n:!1}else if(s){const w=this.computePath(e.x,e.y,s.x,s.y);w&&w.length&&(e.path=w,e.pathIndex=0)}if(e.jitterScore=0,e.jitterWindow=0,e.lastDistToNode=void 0,e.lastDistSign=void 0,!e.path||e.pathIndex==null||e.pathIndex>=e.path.length)return!1}return h>1&&(e.direction=Math.atan2(d,l)),e.x=Math.max(0,Math.min(e.x+l/(h||1)*p,G.w)),e.y=Math.max(0,Math.min(e.y+d/(h||1)*p,G.h)),!1}findSafeTurret(e,t){let s=null,n=1/0;for(const r of this.buildings){if(r.kind!=="turret"||!r.done)continue;const o=this.centerOf(r),a=Math.hypot(e.x-o.x,e.y-o.y),l=Math.hypot(t.x-o.x,t.y-o.y),d=r.range||160,h=l<d?100:0,c=a+h;c<n&&(n=c,s=r)}return s}isProtectedByTurret(e){const t=this.centerOf(e);for(const s of this.buildings){if(s.kind!=="turret"||!s.done)continue;const n=s.range||120,r=this.centerOf(s);if(re(t,r)<n*n)return!0}return!1}centerOf(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}pointInRect(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}updateTurret(e,t){ca(this,e,t)}isNight(){return this.timeSystem.isNight()}spawnWave(){const e=4+Math.floor(this.day*1.3);for(let t=0;t<e;t++)this.spawnEnemy();this.msg(`Night ${this.day}: Enemies incoming!`,"warn")}nextDay(){this.waveSpawnedForDay=!1;let e=0;for(let n=0;n<this.colonists.length;n++)this.RES.food>0?this.RES.food-=1:(e++,this.colonists[n]&&(this.colonists[n].alive=!1));e>0&&(this.colonists=this.colonists.filter(n=>n.alive),this.msg(`${e} colonist(s) starved`,"bad"));for(const n of this.buildings)n.kind==="farm"&&n.done&&(n.growth=(n.growth||0)+.5,(n.growth||0)>=(n.growTime||1)&&(n.ready=!0));const t=this.buildings.find(n=>n.kind==="tent"&&n.done),s=this.getPopulationCap();t&&this.colonists.length<s&&this.RES.food>=15&&(this.RES.food-=15,this.spawnColonist({x:ne.x+ee(-20,20),y:ne.y+ee(-20,20)}),this.msg("A new colonist joined! (-15 food)","info")),this.day>20&&this.win()}dayTick(e){const t=this.timeSystem.getDay();this.timeSystem.update(e),this.timeSystem.getDay()>t&&this.nextDay(),this.timeSystem.didNightJustStart()&&(this.disableEnemySpawns||this.spawnWave());for(let n=this.colonists.length-1;n>=0;n--){const r=this.colonists[n];if(!r.alive){this.releaseSleepReservation(r),r.inside&&this.leaveBuilding(r),this.colonists.splice(n,1);continue}r.profile||(r.profile=ni(),r.color=r.profile.avatar.clothing,r.speed=50*r.profile.stats.workSpeed),r.hp<=0&&(r.alive=!1)}}keyPressed(e){return this.inputManager.keyPressed(e)}update(e){var o;const t=this.debugConsole,s=!!(t&&t.open);if(We()){!s&&this.keyPressed("p")&&(Mt(),this.toast("Work Priorities Panel closed")),!s&&this.keyPressed("escape")&&(Mt(),this.toast("Work Priorities Panel closed"));return}if(!s&&this.keyPressed(" ")){this.paused=!this.paused;const a=document.getElementById("btnPause");a&&(a.textContent=this.paused?"Resume":"Pause")}if(!s&&this.keyPressed("h")){const a=document.getElementById("help");a&&(a.hidden=!a.hidden)}!s&&this.keyPressed("b")&&(this.showBuildMenu=!this.showBuildMenu),!s&&this.keyPressed("p")&&(Mt(),this.toast(We()?"Work Priorities Panel opened":"Work Priorities Panel closed")),!s&&this.keyPressed("g")&&(this.debug.nav=!this.debug.nav,this.toast(this.debug.nav?"Debug: nav ON":"Debug: nav OFF")),!s&&this.keyPressed("j")&&(this.debug.colonists=!this.debug.colonists,this.toast(this.debug.colonists?"Debug: colonists ON":"Debug: colonists OFF")),!s&&this.keyPressed("r")&&(this.debug.regions=!this.debug.regions,this.toast(this.debug.regions?"Debug: regions ON":"Debug: regions OFF")),!s&&this.keyPressed("t")&&(this.debug.terrain=!this.debug.terrain,this.toast(this.debug.terrain?"Debug: terrain ON":"Debug: terrain OFF")),!s&&this.keyPressed("k")&&(this.debug.forceDesktopMode=!this.debug.forceDesktopMode,this.toast(this.debug.forceDesktopMode?"Debug: Force Desktop Mode ON":"Debug: Force Desktop Mode OFF")),!s&&this.keyPressed("m")&&(this.debug.performanceHUD=!this.debug.performanceHUD,cr(),this.toast(this.debug.performanceHUD?"Performance HUD ON":"Performance HUD OFF")),!s&&this.keyPressed("1")&&(this.renderManager.toggleWorldCache(!this.renderManager.useWorldCache),this.toast(this.renderManager.useWorldCache?"World Cache: ON (optimized)":"World Cache: OFF (legacy)")),!s&&this.keyPressed("2")&&(this.renderManager.toggleColonistCache(!this.renderManager.useColonistCache),this.toast(this.renderManager.useColonistCache?"Colonist Cache: ON (optimized)":"Colonist Cache: OFF (legacy)")),!s&&this.keyPressed("3")&&(this.renderManager.toggleParticleCache(!this.renderManager.useParticleSprites),this.toast(this.renderManager.useParticleSprites?"Particle Sprites: ON (optimized)":"Particle Sprites: OFF (legacy)")),!s&&this.keyPressed("escape")&&(this.showBuildMenu?this.showBuildMenu=!1:(this.selectedBuild=null,this.toast("Build canceled"),this.selColonist=null,this.follow=!1)),!s&&this.keyPressed("f")&&(this.fastForward=this.fastForward===1?6:1,this.toast(this.fastForward>1?"Fast-forward ON":"Fast-forward OFF"));const r=360*e/this.camera.zoom;if(this.keyState.w&&(this.camera.y-=r),this.keyState.s&&(this.camera.y+=r),this.keyState.a&&(this.camera.x-=r),this.keyState.d&&(this.camera.x+=r),(this.keyState["+"]||this.keyState["="])&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom*1.02))),(this.keyState["-"]||this.keyState._)&&(this.camera.zoom=Math.max(.6,Math.min(2.2,this.camera.zoom/1.02))),!this.paused){for(const[a,l]of this.hotbar.entries())this.keyPressed(String(a+1))&&(this.selectedBuild=l,this.toast("Selected: "+J[l].name));if(this.follow&&this.selColonist){const a=this.selColonist,l=this.canvas.width/this.camera.zoom,d=this.canvas.height/this.camera.zoom;this.camera.x=te(a.x-l/2,0,Math.max(0,G.w-l)),this.camera.y=te(a.y-d/2,0,Math.max(0,G.h-d))}this.dayTick(e),this.performanceMetrics.startTiming("ai"),this.adaptiveTickRate.beginFrame(performance.now()/1e3);for(const a of this.colonists)if(a.alive){a.health||He(a);const l=this.adaptiveTickRate.calculateImportance({entityX:a.x,entityY:a.y,cameraX:this.camera.x,cameraY:this.camera.y,cameraWidth:this.canvas.width/this.DPR,cameraHeight:this.canvas.height/this.DPR,cameraZoom:this.camera.zoom,isInCombat:a.inCombat||a.state==="fight",isSleeping:a.state==="sleep",isStasis:!1,task:a.task||void 0,health:a.hp,maxHealth:100}),d=`colonist_${((o=a.profile)==null?void 0:o.name)||"unknown"}_${this.colonists.indexOf(a)}`;ya(this,a,e*this.fastForward),this.adaptiveTickRate.shouldUpdate(d,l)?Zs(this,a,e*this.fastForward):(a.t||(a.t=0),a.t+=e*this.fastForward,a.path&&a.path.length>0&&this.moveAlongPath(a,e*this.fastForward))}for(let a=this.enemies.length-1;a>=0;a--){const l=this.enemies[a],d=this.adaptiveTickRate.calculateImportance({entityX:l.x,entityY:l.y,cameraX:this.camera.x,cameraY:this.camera.y,cameraWidth:this.canvas.width/this.DPR,cameraHeight:this.canvas.height/this.DPR,cameraZoom:this.camera.zoom,isInCombat:!0,isSleeping:!1,isStasis:!1,health:l.hp,maxHealth:100}),h=`enemy_${a}`;this.adaptiveTickRate.shouldUpdate(h,d)&&on(this,l,e*this.fastForward),l.hp<=0&&(this.enemies.splice(a,1),Math.random()<.5&&(this.RES.food+=1),this.adaptiveTickRate.removeEntity(h))}this.performanceMetrics.endTiming("colonist & enemy AI");for(const a of this.buildings){if(a.kind==="turret"&&a.done&&this.updateTurret(a,e*this.fastForward),a.kind==="door"&&a.done&&js(a,e*this.fastForward,this.tDay),a.healRate&&a.done){const l=a.healRate,d=a.healRange||120,h=this.centerOf(a);for(const c of this.colonists){if(!c.alive)continue;(c.x-h.x)*(c.x-h.x)+(c.y-h.y)*(c.y-h.y)<d*d&&(c.hp=Math.min(100,c.hp+l*e*this.fastForward))}}if(a.kind==="tent"&&a.done&&(a.cooldown=(a.cooldown||0)-e*this.fastForward,a.cooldown<=0&&this.RES.food>=15)){const l=this.getPopulationCap(),d=this.colonists.filter(u=>u.alive).length,f=Math.max(25,d*8)+15;if(this.colonists.length<l&&this.RES.food>=f){this.RES.food-=15;const u=this.centerOf(a);this.spawnColonist({x:u.x+(Math.random()-.5)*40,y:u.y+(Math.random()-.5)*40}),this.msg("Recruit tent attracted a new colonist! (-15 food)","good"),a.cooldown=60}else this.RES.food<f&&this.RES.food>=15}}this.tryRespawn(e),da(this,e);for(let a=this.messages.length-1;a>=0;a--){const l=this.messages[a];l.t-=e,l.t<=0&&this.messages.splice(a,1)}this.deferredRebuildSystem.processQueue(),this.processPathQueue(2)}}draw(){this.markDirtyRegions(),this.renderManager.render()}markDirtyRegions(){const{dirtyRectTracker:e,camera:t}=this,s=t.zoom,n=(r,o)=>({sx:(r-t.x)*s,sy:(o-t.y)*s});for(const r of this.colonists){if(!r.alive)continue;const{sx:o,sy:a}=n(r.x,r.y),l=60;e.markDirty(o-l,a-l,l*2,l*2)}for(const r of this.enemies){const{sx:o,sy:a}=n(r.x,r.y),l=40;e.markDirty(o-l,a-l,l*2,l*2)}for(const r of this.bullets){const{sx:o,sy:a}=n(r.x,r.y);e.markDirty(o-10,a-10,20,20)}for(const r of this.particles){const{sx:o,sy:a}=n(r.x,r.y),l=r.size||5;e.markDirty(o-l,a-l,l*2,l*2)}for(const r of this.buildings)if(!r.done||r.hp<100){const{sx:o,sy:a}=n(r.x,r.y),l=r.w*s,d=r.h*s;e.markDirty(o-5,a-10,l+10,d+20)}(!this.lastCameraX||!this.lastCameraY||!this.lastCameraZoom||Math.abs(t.x-this.lastCameraX)>5||Math.abs(t.y-this.lastCameraY)>5||Math.abs(t.zoom-this.lastCameraZoom)>.01)&&e.markFullRedraw(),this.lastCameraX=t.x,this.lastCameraY=t.y,this.lastCameraZoom=t.zoom}costText(e){const t=[];return e.wood&&t.push(`${e.wood}w`),e.stone&&t.push(`${e.stone}s`),e.food&&t.push(`${e.food}f`),t.join(" ")}win(){this.paused=!0,this.msg("You survived! Day 20 reached.","good"),alert("You survived to Day 20 — victory!")}lose(){this.paused=!0,this.msg("HQ destroyed. Colony fell.","bad"),alert("Your HQ was destroyed. Game over.")}rebuildNavGrid(){this.deferredRebuildSystem.requestFullRebuild()}rebuildNavGridImmediate(){this.navigationManager.rebuildNavGrid()}syncTerrainToGrid(){this.navigationManager.syncTerrainToGrid()}computePath(e,t,s,n){this.performanceMetrics.startTiming("pathfinding");const r=this.pathRequestQueue.checkCache(e,t,s,n);if(r)return this.performanceMetrics.endTiming("path (cached)"),r;const o=this.navigationManager.computePath(e,t,s,n);if(o&&o.length>0){const a=this.getRegionsAlongPath(o),l=this.regionVersionManager.createSnapshot(a);this.pathRequestQueue.storePath(e,t,s,n,o,l)}return this.performanceMetrics.endTiming(`path (${e},${t})->(${s},${n})`),o}computePathWithDangerAvoidance(e,t,s,n,r){this.performanceMetrics.startTiming("pathfinding");const o=this.navigationManager.computePathWithDangerAvoidance(e,t,s,n,r);return this.performanceMetrics.endTiming("danger-avoid path"),o}getRegionsAlongPath(e){if(!this.regionManager.isEnabled()||e.length===0)return[];const t=new Set;for(const s of e){const n=this.regionManager.getRegionIdAt(s.x,s.y);n>=0&&t.add(n)}return Array.from(t)}requestPathAsync(e,t,s,n,r,o=50,a){return this.pathRequestQueue.requestPath(e,t,s,n,r,o,a)}requestColonistPath(e,t,s,n){let r=50;return e.inCombat||e.state==="flee"?r=90:e.state==="doctoring"||e.state==="beingTreated"||e.state==="downed"?r=80:e.state==="eat"||e.state==="sleep"||e.state==="goToSleep"?r=70:e.state==="haulBread"||e.state==="haulingWheat"||e.state==="build"||e.state==="cooking"||e.state==="storingBread"?r=50:e.state==="harvest"||e.state==="chop"||e.state==="mine"?r=40:(e.state==="idle"||e.state==="seekTask"||e.state==="move")&&(r=20),this.requestPathAsync(e,e.x,e.y,t,s,r,n)}processPathQueue(e){const t=performance.now();let s=0;for(;performance.now()-t<e;){const n=this.pathRequestQueue.getNextRequest();if(!n)break;const r=this.navigationManager.computePath(n.startX,n.startY,n.targetX,n.targetY),o=r&&r.length>0?this.getRegionsAlongPath(r):[];this.pathRequestQueue.completeRequest(n,r,o),s++}if(s>0&&Math.random()<.01){const n=performance.now()-t;console.log(`Processed ${s} path requests in ${n.toFixed(2)}ms`)}}cellIndexAt(e,t){return this.navigationManager.cellIndexAt(e,t)}isBlocked(e,t){return this.navigationManager.isBlocked(e,t)}findNearestBuildingByRegion(e,t,s){return this.navigationManager.findNearestBuildingByRegion(e,t,s)}findNearestTreeByRegion(e,t){return this.navigationManager.findNearestTreeByRegion(e,t)}isReachable(e,t,s,n){return this.navigationManager.isReachable(e,t,s,n)}isWithinInteractionRange(e,t,s,n){return this.navigationManager.isWithinInteractionRange(e,t,s,n)}bestApproachToCircle(e,t,s){return this.navigationManager.bestApproachToCircle(e,t,s)}handleContextMenuAction(e,t){var s,n,r,o,a,l,d,h,c,f,u,A,g,p,w,k,M,x;switch(console.log(`Context menu action: ${e} for colonist:`,(s=t.profile)==null?void 0:s.name),e){case"draft":t.isDrafted?(t.isDrafted=!1,t.draftedTarget=null,t.draftedPosition=null,this.msg(`${((n=t.profile)==null?void 0:n.name)||"Colonist"} undrafted`,"info")):(t.isDrafted=!0,t.draftedTarget=null,t.draftedPosition=null,this.msg(`${((r=t.profile)==null?void 0:r.name)||"Colonist"} drafted for combat`,"info"));break;case"prioritize_medical":this.setColonistMedicalPriority(t,!0),this.msg(`${((o=t.profile)==null?void 0:o.name)||"Colonist"} prioritizing medical work`,"info");break;case"prioritize_work":this.setTask(t,"work",this.findNearestWorkTarget(t),!0),this.msg(`${((a=t.profile)==null?void 0:a.name)||"Colonist"} prioritizing work tasks`,"info");break;case"prioritize_build":this.setTask(t,"build",this.findNearestBuildTarget(t),!0),this.msg(`${((l=t.profile)==null?void 0:l.name)||"Colonist"} prioritizing construction`,"info");break;case"prioritize_haul":this.msg(`${((d=t.profile)==null?void 0:d.name)||"Colonist"} prioritizing hauling`,"info");break;case"prioritize_research":this.msg(`${((h=t.profile)==null?void 0:h.name)||"Colonist"} prioritizing research`,"info");break;case"force_rest":this.forceColonistToRest(t,!0);break;case"force_eat":this.forceColonistToEat(t,!0);break;case"force_work":this.setTask(t,"work",this.findNearestWorkTarget(t),!0),this.msg(`${((c=t.profile)==null?void 0:c.name)||"Colonist"} forced to work`,"info");break;case"force_guard":this.setTask(t,"guard",{x:t.x,y:t.y},!0),this.msg(`${((f=t.profile)==null?void 0:f.name)||"Colonist"} guarding area`,"info");break;case"goto_hq":this.sendColonistToHQ(t);break;case"goto_safety":this.sendColonistToSafety(t);break;case"goto_bed":this.sendColonistToBed(t);break;case"goto_food":this.sendColonistToFood(t);break;case"medical_bandage":this.assignMedicalTreatment(t,"bandage_wound");break;case"medical_treat_infection":this.assignMedicalTreatment(t,"treat_infection");break;case"medical_surgery":this.assignMedicalTreatment(t,"remove_bullet");break;case"medical_pain_relief":this.assignMedicalTreatment(t,"pain_management");break;case"medical_treat_all":this.assignComprehensiveMedicalCare(t);break;case"medical_treat":this.treatColonist(t);break;case"medical_rest":this.forceColonistToRest(t),this.msg(`${((u=t.profile)==null?void 0:u.name)||"Colonist"} ordered to bed rest`,"info");break;case"medical_injury_summary":if(t.health){const b=Ns(t.health);this.msg(`${((A=t.profile)==null?void 0:A.name)||"Colonist"}: ${b}`,"info")}else this.msg("No health data","warn");break;case"medical_bandage_all_bleeding":if(t.health){let b=0;for(const S of t.health.injuries)S.bleeding>0&&!S.bandaged&&(S.bandaged=!0,S.bleeding*=.2,S.infectionChance*=.5,b++);this.msg(b?`Applied bandages to ${b} wound${b>1?"s":""}`:"No bleeding wounds",b?"good":"info")}break;case"prioritize_treat_patient":{const b=this.selColonist;b&&b!==t&&(b.assignedMedicalPatientId=t.id||(t.id=`colonist_${Date.now()}_${Math.random().toString(36).slice(2,9)}`),b.medicalPriorityUntil=b.t+60,this.msg(`${((g=b.profile)==null?void 0:g.name)||"Doctor"} will prioritize treating ${((p=t.profile)==null?void 0:p.name)||"Patient"}`,"info"));break}case"clear_prioritize_treat":{const b=this.selColonist;b&&b.assignedMedicalPatientId&&(b.assignedMedicalPatientId=void 0,b.medicalPriorityUntil=void 0,this.msg(`${((w=b.profile)==null?void 0:w.name)||"Doctor"} cleared treatment priority`,"info"));break}case"medical_bandage":this.assignMedicalTreatment(t,"bandage_wound");break;case"medical_rescue":if(this.findBestDoctor(t)||this.colonists.find(b=>b!==t&&b.alive&&b.state!=="downed")){const b=this.findBestRestBuilding(t,{preferMedical:!0,allowShelterFallback:!0});if(b){t.x=b.x+b.w/2,t.y=b.y+b.h/2;const S=b.kind==="bed"?b.isMedicalBed?"medical bed":"bed":b.name||"shelter";this.msg(`${((k=t.profile)==null?void 0:k.name)||"Colonist"} rescued to ${S}`,b.isMedicalBed?"good":"info")}else this.msg("No bed available for rescue","warn")}else this.msg("No rescuer available","warn");break;case"cancel":this.setTask(t,"idle",{x:t.x,y:t.y}),this.msg(`${((M=t.profile)==null?void 0:M.name)||"Colonist"} task cancelled`,"info");break;case"follow":this.follow&&this.selColonist===t?(this.follow=!1,this.selColonist=null,this.msg("Stopped following","info")):(this.selColonist=t,this.follow=!0,this.msg(`Following ${((x=t.profile)==null?void 0:x.name)||"colonist"}`,"info"));break}ze(this)}findNearestWorkTarget(e){let t=null,s=1/0;for(const n of this.buildings)if(!n.done){const r=Math.hypot(e.x-(n.x+n.w/2),e.y-(n.y+n.h/2));r<s&&(s=r,t=n)}return t||{x:e.x+ee(-50,50),y:e.y+ee(-50,50)}}findNearestBuildTarget(e){return this.findNearestWorkTarget(e)}colonistNeedsMedicalBed(e){var s;return e.state==="downed"||e.hp<60?!0:(((s=e.health)==null?void 0:s.injuries)??[]).some(n=>n.bleeding>0||n.severity>.25||n.infected)}findBestRestBuilding(e,t){const{requireMedical:s=!1,preferMedical:n=!1,allowShelterFallback:r=!0}=t||{},o=this.buildings.filter(u=>u.kind==="bed"&&u.done&&this.buildingHasSpace(u,e)),a=o.filter(u=>u.isMedicalBed),l=o.filter(u=>!u.isMedicalBed),d=[];s?d.push(...a):n&&a.length>0?d.push(...a,...l):d.push(...l,...a);const h=u=>{let A=null,g=1/0;for(const p of u){const w=this.centerOf(p),k=Math.hypot(w.x-e.x,w.y-e.y);k<g&&(g=k,A=p)}return A},c=h(d);if(c)return c;if(!r)return null;const f=this.buildings.filter(u=>(u.kind==="house"||u.kind==="tent"||u.kind==="hq"||u.kind==="infirmary")&&u.done&&this.buildingHasSpace(u,e));return h(f)}forceColonistToRest(e,t=!1){var r;const s=this.colonistNeedsMedicalBed(e),n=this.findBestRestBuilding(e,{preferMedical:s,allowShelterFallback:!0});if(n){this.setTask(e,"rest",n,t);const o=n.kind==="bed"?n.isMedicalBed?"medical bed":"bed":n.name||n.kind;this.msg(`${((r=e.profile)==null?void 0:r.name)||"Colonist"} going to ${o}`,"info")}else this.msg("No available sleeping quarters","warn")}forceColonistToEat(e,t=!1){var s;this.RES.food>0?(t&&(e.playerCommand={issued:!0,timestamp:e.t||0,task:"eat",expires:(e.t||0)+60}),e.hunger=Math.max(0,(e.hunger||0)-30),this.RES.food=Math.max(0,this.RES.food-1),this.msg(`${((s=e.profile)==null?void 0:s.name)||"Colonist"} eating food`,"good")):this.msg("No food available","warn")}sendColonistToHQ(e){var s;const t=this.buildings.find(n=>n.kind==="hq");if(t){const n={x:t.x+t.w/2,y:t.y+t.h/2};this.setTask(e,"goto",n),this.msg(`${((s=e.profile)==null?void 0:s.name)||"Colonist"} going to HQ`,"info")}}sendColonistToSafety(e){var t;for(const s of this.buildings)if(s.done&&this.isProtectedByTurret(s)&&this.buildingHasSpace(s)){this.setTask(e,"goto",s),this.msg(`${((t=e.profile)==null?void 0:t.name)||"Colonist"} going to safety`,"info");return}this.sendColonistToHQ(e)}sendColonistToBed(e){var n;const t=this.colonistNeedsMedicalBed(e),s=this.findBestRestBuilding(e,{preferMedical:t,allowShelterFallback:!0});if(s){this.setTask(e,"rest",s);const r=s.kind==="bed"?s.isMedicalBed?"medical bed":"bed":"shelter";this.msg(`${((n=e.profile)==null?void 0:n.name)||"Colonist"} going to ${r}`,"info")}else this.msg("No available beds","warn")}sendColonistToFood(e){var s;const t=this.buildings.find(n=>(n.kind==="warehouse"||n.kind==="hq")&&n.done);if(t){const n={x:t.x+t.w/2,y:t.y+t.h/2};this.setTask(e,"goto",n),this.msg(`${((s=e.profile)==null?void 0:s.name)||"Colonist"} going to food storage`,"info")}else this.sendColonistToHQ(e)}treatColonist(e){var s,n,r;const t=this.buildings.find(o=>o.kind==="infirmary"&&o.done);if(t)this.setTask(e,"medical",t),this.msg(`${((s=e.profile)==null?void 0:s.name)||"Colonist"} going for medical treatment`,"info");else if(e.health){const o=Os(e.health);e.hp=Math.min(100,Et(e.health)),this.msg(`${((n=e.profile)==null?void 0:n.name)||"Colonist"} field-treated (${o.bandaged} bandaged, pain -${o.painReduced.toFixed(2)})`,"good")}else e.hp=Math.min(100,e.hp+10),this.msg(`${((r=e.profile)==null?void 0:r.name)||"Colonist"} received crude aid`,"info")}setColonistMedicalPriority(e,t){e.medicalPriority=t,t&&this.setTask(e,"seekMedical",null)}assignMedicalTreatment(e,t){var r,o,a;const s=this.findBestDoctor(e);if(!s){this.msg("No available doctor for treatment","warn");return}const n=ve.createForcedJob(s,e,t);n?(ve.reserveJob(n,s),s.medicalJob=n,s.task=null,s.target=null,this.clearPath(s),this.msg(`${((r=s.profile)==null?void 0:r.name)||"Doctor"} treating ${((o=e.profile)==null?void 0:o.name)||"patient"} with ${((a=n.treatment)==null?void 0:a.name)||"treatment"}`,"info")):this.msg(`Cannot apply ${t} treatment`,"warn")}assignComprehensiveMedicalCare(e){var a,l,d,h,c;if(!((l=(a=e.health)==null?void 0:a.injuries)!=null&&l.length)){this.msg(`${((d=e.profile)==null?void 0:d.name)||"Colonist"} has no injuries to treat`,"info");return}const t=this.findBestDoctor(e);if(!t){this.msg("No available doctor for comprehensive care","warn");return}const n=[...e.health.injuries].sort((f,u)=>{const A=(f.bleeding||0)*2+(f.severity||0);return(u.bleeding||0)*2+(u.severity||0)-A})[0];let r="bandage_wound";n.infected?r="treat_infection":n.type==="gunshot"?r="surgical_repair":n.bleeding>0?r="bandage_wound":n.severity>.6&&(r="advanced_treatment");const o=ve.createForcedJob(t,e,r);o?(ve.reserveJob(o,t),t.medicalJob=o,t.task=null,t.target=null,this.clearPath(t),this.msg(`${((h=t.profile)==null?void 0:h.name)||"Doctor"} providing comprehensive care to ${((c=e.profile)==null?void 0:c.name)||"patient"}`,"info")):this.msg("Failed to create medical job","warn")}findBestDoctor(e){const t=this.colonists.filter(s=>!(s===e||!s.alive||s.task&&s.task!=="idle"&&s.task!=="seekTask"));return t.length===0?null:(t.sort((s,n)=>{const r=this.getColonistMedicalSkill(s);return this.getColonistMedicalSkill(n)-r}),t[0])}getColonistMedicalSkill(e){var r,o;const t=(r=e.profile)==null?void 0:r.detailedInfo.skills.includes("First Aid"),s=((o=e.profile)==null?void 0:o.background)==="Medic";let n=0;return t&&(n+=3),s&&(n+=5),n}drawLongPressProgress(){if(!this.longPressStartTime||!this.longPressTarget||!this.longPressStartPos)return;const e=this.ctx,s=performance.now()-this.longPressStartTime,n=Math.min(s/500,1);if(n>=1)return;const r=this.longPressTarget,a=this.longPressTargetType==="building"&&r?this.centerOf(r):{x:r.x,y:r.y},l=(a.x-this.camera.x)*this.camera.zoom,d=(a.y-this.camera.y)*this.camera.zoom;e.save();const h=this.scale(20),c=l,f=d;e.strokeStyle="rgba(255, 255, 255, 0.3)",e.lineWidth=this.scale(3),e.beginPath(),e.arc(c,f,h,0,Math.PI*2),e.stroke(),e.strokeStyle="#60a5fa",e.lineWidth=this.scale(3),e.lineCap="round",e.beginPath();const u=-Math.PI/2,A=u+n*Math.PI*2;if(e.arc(c,f,h,u,A),e.stroke(),n>.3){const g=Math.sin(s/100*Math.PI)*.3+.1;e.fillStyle=`rgba(96, 165, 250, ${g})`,e.beginPath(),e.arc(c,f,h*.6,0,Math.PI*2),e.fill()}n>.5&&(e.fillStyle="#ffffff",e.font=this.getScaledFont(12,"600"),e.textAlign="center",e.textBaseline="middle",e.fillText("⚙️",c,f)),e.restore()}barRow(e,t,s,n,r){const o=this.ctx;o.fillStyle="#dbeafe",o.fillText(s,e,t);const a=this.scale(140),l=this.scale(10),d=o.measureText(s).width,h=Math.max(this.scale(86),d+this.scale(14));o.fillStyle="#0f172a",o.fillRect(e+h,t-this.scale(8),a,l),o.strokeStyle="#1e293b",o.strokeRect(e+h+.5,t-this.scale(8)+.5,a-1,l-1),o.fillStyle=r,o.fillRect(e+h+this.scale(2),t-this.scale(6),Math.max(0,Math.min(a-this.scale(4),n/100*(a-this.scale(4)))),l-this.scale(4))}}function wr(){if(document.getElementById("error-overlay"))return;const e=document.createElement("div");e.id="error-overlay",e.style.cssText=["position:fixed","inset:0 auto auto 0","max-width:100%","z-index:99999","background:rgba(8,8,10,0.82)","color:#fee2e2",'font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',"padding:10px","overflow:auto","display:none","white-space:pre-wrap","pointer-events:auto"].join(";");const t=document.createElement("div");t.style.cssText="display:flex;align-items:center;gap:8px;margin-bottom:8px;";const s=document.createElement("strong");s.textContent="Errors";const n=document.createElement("button");n.textContent="Dismiss",n.style.cssText="margin-left:auto;background:#ef4444;color:white;border:none;border-radius:4px;padding:4px 8px;",n.onclick=()=>{e.style.display="none",e.innerHTML="",e.appendChild(t),t.appendChild(s),t.appendChild(n)},t.appendChild(s),t.appendChild(n),e.appendChild(t),document.body.appendChild(e);const r=o=>{e.style.display="block";const a=document.createElement("div");a.textContent=o,e.appendChild(a)};window.__showErrorOverlay=r,window.addEventListener("error",o=>{var l;const a=((l=o==null?void 0:o.error)==null?void 0:l.stack)||(o==null?void 0:o.message)||String(o);r(`[error] ${a}`)}),window.addEventListener("unhandledrejection",o=>{const a=o.reason,l=a&&(a.stack||a.message)||String(a);r(`[unhandledrejection] ${l}`)})}wr();(()=>{const i=window.__showErrorOverlay;if(!i)return;const e=console.error.bind(console),t=console.warn.bind(console);console.error=(...s)=>{try{i(`[console.error] ${s.map(n=>n&&(n.stack||n.message)?n.stack||n.message:String(n)).join(" ")}`)}catch{}e(...s)},console.warn=(...s)=>{try{i(`[console.warn] ${s.map(n=>n&&(n.stack||n.message)?n.stack||n.message:String(n)).join(" ")}`)}catch{}t(...s)}})();let ke=document.getElementById("game");const je=document.getElementById("btnPause"),gi=document.getElementById("btnHelp");document.getElementById("btnToggleUI");const kt=document.getElementById("btnMenu"),be=document.getElementById("headerDropdown"),Ai=document.getElementById("hd-new"),pi=document.getElementById("hd-help"),mi=document.getElementById("hd-build");document.getElementById("hd-toggle-mobile");const yi=document.getElementById("btnNew"),xe=document.getElementById("help"),bi=document.getElementById("mobileControls"),wi=document.getElementById("mc-build"),vi=document.getElementById("mc-cancel"),Mi=document.getElementById("mc-erase"),ki=document.getElementById("mc-pause"),xi=document.getElementById("mc-ff"),Si=document.getElementById("mc-zoom-in"),Ci=document.getElementById("mc-zoom-out");xe&&(xe.innerHTML=`
    <h2>How to play</h2>
    <div><b>Goal:</b> Gather wood & stone, build farms for food, add houses for pop cap; survive nightly raids with turrets/walls.</div>
  <div><b>Controls:</b> 1..9 quick-build, <b>B</b> build menu, <b>P</b> work priorities, LMB place, RMB cancel/erase; WASD pan; Space pause; H toggle help; +/- zoom; F fast-forward.</div>
  <div><b>Debug:</b> <b>M</b> performance HUD, <b>G</b> nav grid, <b>J</b> colonist info, <b>R</b> regions, <b>T</b> terrain. <b>1/2/3</b> toggle render optimizations (world/colonist/particle cache).</div>
  <div><b>UI Modes:</b> 📱 Mobile UI shows touch controls for tap/touch gameplay. 🖥️ Desktop UI is clean with keyboard shortcuts only.</div>
  `);async function vr(){if(ke=document.getElementById("game"),!ke){const n=window.__showErrorOverlay,r='Fatal: Canvas element with id "game" not found in DOM.';throw n==null||n(r),new Error(r)}const i=ke.getContext("2d");i&&(i.fillStyle="#0a0e14",i.fillRect(0,0,ke.width,ke.height),i.fillStyle="#dbeafe",i.font="24px system-ui",i.textAlign="center",i.fillText("Loading assets...",ke.width/2,ke.height/2));try{await pe.getInstance().loadAssets(),console.log("Assets loaded successfully"),console.log("House image loaded:",!!pe.getInstance().getImage("house"))}catch(n){console.warn("Some assets failed to load:",n);const r=window.__showErrorOverlay;r==null||r("Warning: some assets failed to load. See console for details.")}const e=new br(ke);je&&(je.onclick=()=>{e.paused=!e.paused,je.textContent=e.paused?"Resume":"Pause"}),yi&&(yi.onclick=()=>{e.newGame()}),gi&&(gi.onclick=()=>{xe&&(xe.hidden=!xe.hidden)});const t=document.getElementById("btnFSM"),s=document.getElementById("btnBlueprint");t&&(t.onclick=()=>{window.open("./fsm-editor.html","_blank")}),s&&(s.onclick=()=>{window.open("./blueprint-fsm-editor.html","_blank")}),Object.assign(window,{game:e,BUILD_TYPES:J,imageAssets:pe.getInstance()}),bi&&(bi.hidden=!1),document.addEventListener("keydown",n=>{const r=[" ","h","b","f","g","j","escape","w","a","s","d","+","=","-","_"],o=/^[1-9]$/.test(n.key);(r.includes(n.key.toLowerCase())||o)&&document.activeElement&&document.activeElement!==document.body&&document.activeElement.blur()}),kt&&be&&(kt.onclick=()=>{be.hidden=!be.hidden},Ai&&(Ai.onclick=()=>{be.hidden=!0,e.newGame()}),pi&&(pi.onclick=()=>{be.hidden=!0,xe&&(xe.hidden=!xe.hidden)}),mi&&(mi.onclick=()=>{be.hidden=!0,e.showBuildMenu=!e.showBuildMenu}),document.addEventListener("click",n=>{if(!be)return;const r=n.target;r&&!be.contains(r)&&r!==kt&&(be.hidden=!0)})),wi&&(wi.onclick=()=>{e.showBuildMenu=!e.showBuildMenu}),vi&&(vi.onclick=()=>{e.selectedBuild=null,e.pendingPlacement=null,e.toast("Build canceled")}),Mi&&(Mi.onclick=()=>{window._eraseOnce=!0,e.toast("Erase mode: tap on a building to remove")}),ki&&(ki.onclick=()=>{e.paused=!e.paused,je&&(je.textContent=e.paused?"Resume":"Pause")}),xi&&(xi.onclick=()=>{e.fastForward=e.fastForward===1?6:1,e.toast(e.fastForward>1?"Fast-forward ON":"Fast-forward OFF")}),Si&&(Si.onclick=()=>{e.camera.zoom=Math.max(.6,Math.min(2.2,e.camera.zoom*1.1))}),Ci&&(Ci.onclick=()=>{e.camera.zoom=Math.max(.6,Math.min(2.2,e.camera.zoom/1.1))})}try{const i=vr();i&&typeof i.catch=="function"&&i.catch(e=>{const t=window.__showErrorOverlay,s=e&&(e.stack||e.message)?e.stack||e.message:String(e);t==null||t(`[init] ${s}`),console.error(e)})}catch(i){const e=window.__showErrorOverlay,t=i&&(i.stack||i.message)?i.stack||i.message:String(i);e==null||e(`[init-sync] ${t}`),console.error(i)}
